<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( HYBRID_COORD==1 ) <a name='2'>
#  define mu(...) (c1h(k)*XXPCXX(__VA_ARGS__))<a name='3'>
#  define XXPCXX(...) mu(__VA_ARGS__)<a name='4'>
<a name='5'>
#  define mub(...) (c1h(k)*XXPCBXX(__VA_ARGS__)+c2h(k))<a name='6'>
#  define XXPCBXX(...) mub(__VA_ARGS__)<a name='7'>
#endif<a name='8'>
<a name='9'>
<A NAME='MODULE_STOCH'><A href='../../html_code/dyn_em/module_stoch.F.html#MODULE_STOCH' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='10'>
<font color=#993300>module </font><font color=#cc0000>module_stoch</font> <A href='../../call_to/MODULE_STOCH.html' TARGET='index'>2</A><a name='11'>
<font color=#447700>!***********************************************************************<a name='12'></font>
<font color=#447700>!<a name='13'></font>
<font color=#447700>! Purpose: Stochastic Perturbation Schemes<a name='14'></font>
<font color=#447700>! Author : Judith Berner, NCAR  (berner@ucar.edu)<a name='15'></font>
<font color=#447700>! Date   : Apr 2014<a name='16'></font>
<font color=#447700>!<a name='17'></font>
<font color=#447700>!***********************************************************************<a name='18'></font>
<font color=#447700>!<a name='19'></font>
<font color=#447700>! The scheme introduces stochastic perturbations to the rotational wind <a name='20'></font>
<font color=#447700>! components and to the potential temperature field. The stochastic <a name='21'></font>
<font color=#447700>! perturbations are generated by independent autoregressive processes for <a name='22'></font>
<font color=#447700>! each wavenumber and results in smooth spatially and temporally correlated patterns.<a name='23'></font>
<font color=#447700>! Details of the scheme and its performance in a meso-scale WRF-ensemble <a name='24'></font>
<font color=#447700>! system are available in:<a name='25'></font>
<font color=#447700>!<a name='26'></font>
<font color=#447700>! Berner, J.,  S.-Y. Ha, J. P. Hacker, A. Fournier and C. Snyder 2011:<a name='27'></font>
<font color=#447700>! "Model uncertainty in a mesoscale ensemble prediction system: Stochastic <a name='28'></font>
<font color=#447700>! versus multi-physics representations",  2011, Mon. Wea. Rev., 139, 1972-1995<a name='29'></font>
<font color=#447700>! http://journals.ametsoc.org/doi/abs/10.1175/2010MWR3595.1<a name='30'></font>
<font color=#447700>!<a name='31'></font>
<font color=#447700>! Features: <a name='32'></font>
<font color=#447700>!     Dissipation: Dissipation rates are assumed constant in space and time<a name='33'></font>
<font color=#447700>!     Vertical structure: Supports two options for vertical structure: <a name='34'></font>
<font color=#447700>!                         0) constant<a name='35'></font>
<font color=#447700>!                         1) random phase<a name='36'></font>
<font color=#447700>!<a name='37'></font>
<font color=#447700>! Optional namelist parameters:<a name='38'></font>
<font color=#447700>!   stoch_force_opt		=	0, 0, 0: No stochastic parameterization<a name='39'></font>
<font color=#447700>!   			=	1, 1, 1: Use SKEB scheme<a name='40'></font>
<font color=#447700>!   skebs_vertstruc	=	0, 0, 0: Constant vertical structure of random pattern generator<a name='41'></font>
<font color=#447700>!   			= 	1, 1, 1: Random phase vertical structure random pattern generator<a name='42'></font>
<font color=#447700>!   tot_backscat_psi	:	Total backscattered dissipation rate for streamfunction; Controls <a name='43'></font>
<font color=#447700>!                                   amplitude of rotational wind perturbations Default value is 1.0E-5 m2/s3.<a name='44'></font>
<font color=#447700>!   tot_backscat_t		:	Total backscattered dissipation rate for potential temperature; <a name='45'></font>
<font color=#447700>!   				Controls amplitude of potential temperature perturbations. Default value is 1.0E-6 m2/s3.<a name='46'></font>
<font color=#447700>!   nens			:	Random seed for random number stream. This parameter needs to be different <a name='47'></font>
<font color=#447700>!                                   for each member in ensemble forecasts. Is a function of initial start time <a name='48'></font>
<font color=#447700>!   				to ensure different random number streams for different forecasts.<a name='49'></font>
<font color=#447700>!   ztau_psi		:	Decorrelation time (in s) for streamfunction perturbations.<a name='50'></font>
<font color=#447700>!   				Default is 10800s.  Recommended value is 216000s.<a name='51'></font>
<font color=#447700>!   ztau_t			:	Decorrelation time (in s) for potential temperature perturbations. <a name='52'></font>
<font color=#447700>!   				Default 10800s. Recommended value is 216000s.<a name='53'></font>
<font color=#447700>!   rexponent_psi		:	Spectral slope for streamfunction perturbations. Default is -1.83 <a name='54'></font>
<font color=#447700>!                                   for a kinetic-energy forcing spectrum with slope -5/3.<a name='55'></font>
<font color=#447700>!   rexponent_t 		:	Spectral slope of potential temperature perturbations. Default is -1.83 <a name='56'></font>
<font color=#447700>!   				for a potential energy forcing spectrum with slope -1.832.<a name='57'></font>
<font color=#447700>!   kminforc		:	Minimal forcing wavenumber in longitude for streamfunction perturbations. Default is 1.<a name='58'></font>
<font color=#447700>!   lminforc		:	Minimal forcing wavenumber in latitude for streamfunction perturbations. Default is 1.<a name='59'></font>
<font color=#447700>!   kminforc		: 	Minimal forcing wavenumber in longitude for potential temperature perturbations. Default is 1.<a name='60'></font>
<font color=#447700>!   lminforct		:	Minimal forcing wavenumber in latitude for potential temperature perturbations. Default is 1.<a name='61'></font>
<font color=#447700>!   kmaxforc		:	Maximal forcing wavenumber in longitude for streamfunction perturbations. <a name='62'></font>
<font color=#447700>!   				Default is maximal possible wavenumbers determined by number of gridpoints.<a name='63'></font>
<font color=#447700>!   lmaxforc		:	Maximal forcing wavenumber in latitude for streamfunction perturbations. <a name='64'></font>
<font color=#447700>!   				Default is maximal possible wavenumbers determined by number of gridpoints.<a name='65'></font>
<font color=#447700>!   kmaxforct		:	Maximal forcing wavenumber in longitude for potential temperature perturbations. <a name='66'></font>
<font color=#447700>!   				Default is maximal possible wavenumbers determined by number of gridpoints.<a name='67'></font>
<font color=#447700>!   lmaxforct		:	Maximal forcing wavenumber in latitude for potential temperature perturbations. <a name='68'></font>
<font color=#447700>!   				Default is maximal possible wavenumbers determined by number of gridpoints.<a name='69'></font>
<font color=#447700>!   zsigma2_eps		:	Noise variance in autoregressive process defining streamfunction perturbations.<a name='70'></font>
<font color=#447700>!   zsigma2_eta		:	Noise variance in autoregressive process defining in potential temperature perturbations.<a name='71'></font>
<a name='72'>
<font color=#447700>!***********************************************************************<a name='73'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='74'></font>
<font color=#447700>!************** DECLARE FIELDS AND VARIABLES FOR STOCHASTIC BACKSCATTER<a name='75'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='76'></font>
      implicit none<a name='77'>
      public ::  SETUP_RAND_PERTURB, UPDATE_STOCH,&amp; <a name='78'>
                         do_fftback_along_x,do_fftback_along_y,&amp; <a name='79'>
                         rand_pert_update<a name='80'>
<a name='81'>
      INTEGER :: LMINFORC, LMAXFORC, KMINFORC, KMAXFORC, &amp; <a name='82'>
      &amp;          LMINFORCT, LMAXFORCT, KMINFORCT, KMAXFORCT<a name='83'>
      REAL    :: ALPH, ALPH_PSI, ALPH_T, TOT_BACKSCAT_PSI, TOT_BACKSCAT_T,  REXPONENT_PSI,REXPONENT_T<a name='84'>
<a name='85'>
<font color=#447700>!     ----------Fields for spectral transform -----------<a name='86'></font>
<a name='87'>
      INTEGER :: LENSAV<a name='88'>
      INTEGER,ALLOCATABLE:: wavenumber_k(:), wavenumber_l(:)<a name='89'>
      REAL, ALLOCATABLE :: WSAVE1(:),WSAVE2(:)<a name='90'>
<a name='91'>
<font color=#447700>!     --------- Others -------------------------------------------------<a name='92'></font>
      REAL, PARAMETER:: RPI= 3.141592653589793 <font color=#447700>!4.0*atan(1.0) <a name='93'></font>
      REAL, PARAMETER:: CP= 1006.0 <font color=#447700>! specific heat of dry air in J/(Kg*K)= m^2/(K* s^2)<a name='94'></font>
      REAL, PARAMETER:: T0= 300.0 <font color=#447700>! Reference temperature in K <a name='95'></font>
<a name='96'>
      save<a name='97'>
<a name='98'>
<a name='99'>
<font color=#447700>!=======================================================================<a name='100'></font>
contains<a name='101'>
<font color=#447700>!=======================================================================<a name='102'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='103'></font>
<font color=#447700>!!************** INITIALIZE STOCHASTIC ROUTINES *****************************<a name='104'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='105'></font>
<font color=#447700>! This subroutine drives the initialization of the stochastic schemes  <a name='106'></font>
<a name='107'>
<A NAME='INITIALIZE_STOCH'><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='108'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>INITIALIZE_STOCH</font>  (grid, config_flags,                       &amp; <A href='../../call_to/INITIALIZE_STOCH.html' TARGET='index'>1</A>,<A href='../../call_from/INITIALIZE_STOCH.html' TARGET='index'>17</A><a name='109'>
                          first_trip_for_this_domain,                         &amp; <a name='110'>
                          ips, ipe, jps, jpe, kps, kpe,                       &amp;<a name='111'>
                          ids, ide, jds, jde, kds, kde,                       &amp;<a name='112'>
                          ims, ime, jms, jme, kms, kme,                       &amp;<a name='113'>
                          its, ite, jts, jte, kts, kte,                       &amp; <a name='114'>
                          imsx, imex, jmsx, jmex, kmsx, kmex,  &amp;<a name='115'>
                          ipsx, ipex, jpsx, jpex, kpsx, kpex,  &amp;<a name='116'>
                          imsy, imey, jmsy, jmey, kmsy, kmey,  &amp;<a name='117'>
                          ipsy, ipey, jpsy, jpey, kpsy, kpey )<a name='118'>
<a name='119'>
<a name='120'>
    USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_14"><a name='121'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_15">, ONLY : domain<a name='122'>
#ifdef DM_PARALLEL<a name='123'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_12">, ONLY : local_communicator, mytask, ntasks, ntasks_x, ntasks_y, local_communicator_periodic, &amp;<a name='124'>
                          wrf_dm_maxval, wrf_err_message, local_communicator_x, local_communicator_y, data_order_xzy<a name='125'>
#endif<a name='126'>
<a name='127'>
      IMPLICIT NONE<a name='128'>
<a name='129'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='130'>
      TYPE ( domain ), INTENT(INOUT)         :: grid<a name='131'>
<a name='132'>
      INTEGER , INTENT(IN)     ::               ids, ide, jds, jde, kds, kde,   &amp;<a name='133'>
                                                ims, ime, jms, jme, kms, kme,   &amp;<a name='134'>
                                                ips, ipe, jps, jpe, kps, kpe,   &amp; <a name='135'>
                                                its, ite, jts, jte, kts, kte<a name='136'>
      INTEGER , INTENT(IN)     ::               imsx,imex,jmsx,jmex,kmsx,kmex, &amp;<a name='137'>
                                                ipsx,ipex,jpsx,jpex,kpsx,kpex, &amp;<a name='138'>
                                                imsy,imey,jmsy,jmey,kmsy,kmey, &amp;<a name='139'>
                                                ipsy,ipey,jpsy,jpey,kpsy,kpey<a name='140'>
<a name='141'>
      LOGICAL                  ::               first_trip_for_this_domain<a name='142'>
      INTEGER                  ::               K <a name='143'>
<a name='144'>
<a name='145'>
   IF ( first_trip_for_this_domain ) THEN<a name='146'>
     grid%did_stoch = .FALSE.<a name='147'>
   END IF<a name='148'>
<a name='149'>
   IF ((( grid%id == 1) .AND. (.NOT. grid%did_stoch)) .AND. &amp;<a name='150'>
       (( grid%skebs_on== 1) .OR.( grid%sppt_on== 1) .OR. ( grid%rand_perturb_on== 1) .OR. &amp;<a name='151'>
         ( grid%spp_conv== 1) .OR. ( grid%spp_pbl== 1) .OR. ( grid%spp_lsm== 1)) ) THEN<a name='152'>
<a name='153'>
     grid%did_stoch = .TRUE.<a name='154'>
<a name='155'>
     IF (grid%skebs_on==1) then<a name='156'>
<a name='157'>
<font color=#447700>! Initialize SKEBS<a name='158'></font>
<font color=#447700>!    Initialize streamfunction (1)<a name='159'></font>
     if ((.not.config_flags%restart) .or. (.not.config_flags%hrrr_cycling)) then <a name='160'>
         call <A href='../../html_code/dyn_em/module_stoch.F.html#RAND_SEED'>rand_seed</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAND_SEED_1"> (config_flags, grid%ISEED_SKEBS, grid%iseedarr_skebs , kms, kme)<a name='161'>
     endif<a name='162'>
     call <A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB'>SETUP_RAND_PERTURB</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_RAND_PERTURB_1">('W',                                         &amp;<a name='163'>
                       grid%skebs_vertstruc,config_flags%restart,         &amp;<a name='164'>
                       grid%SPSTREAM_AMP,                                 &amp;<a name='165'>
                       grid%SPSTREAMFORCS,grid%SPSTREAMFORCC,grid%ALPH_PSI,&amp;<a name='166'>
                       grid%VERTSTRUCC,grid%VERTSTRUCS,grid%VERTAMPUV,     &amp;<a name='167'>
                       grid%KMINFORCT,grid%KMAXFORCT,                     &amp;<a name='168'>
                       grid%LMINFORCT,grid%LMAXFORCT,                     &amp;<a name='169'>
                       grid%KMAXFORCTH,grid%LMAXFORCTH,                   &amp;<a name='170'>
                       grid%time_step,grid%DX,grid%DY,                    &amp;<a name='171'>
                       grid%gridpt_stddev_sppt,                           &amp;<a name='172'>
                       grid%lengthscale_sppt,                             &amp;<a name='173'>
                       grid%timescale_sppt,                               &amp;<a name='174'>
                       grid%TOT_BACKSCAT_PSI,grid%ZTAU_PSI,               &amp;<a name='175'>
                       grid%REXPONENT_PSI,                                &amp;<a name='176'>
                       ids, ide, jds, jde, kds, kde,                      &amp;<a name='177'>
                       ims, ime, jms, jme, kms, kme,                      &amp;<a name='178'>
                       its, ite, jts, jte, kts, kte                       )<a name='179'>
<font color=#447700>!    Initialize potential temperature (2)<a name='180'></font>
     call <A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB'>SETUP_RAND_PERTURB</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_RAND_PERTURB_2">('T',                                         &amp;<a name='181'>
                       grid%skebs_vertstruc,config_flags%restart,     &amp;<a name='182'>
                       grid%SPT_AMP,                                      &amp;<a name='183'>
                       grid%SPTFORCS,grid%SPTFORCC,grid%ALPH_T,           &amp;<a name='184'>
                       grid%VERTSTRUCC,grid%VERTSTRUCS,grid%VERTAMPT,     &amp;<a name='185'>
                       grid%KMINFORCT,grid%KMAXFORCT,                     &amp;<a name='186'>
                       grid%LMINFORCT,grid%LMAXFORCT,                     &amp;<a name='187'>
                       grid%KMAXFORCTH,grid%LMAXFORCTH,                   &amp;<a name='188'>
                       grid%time_step,grid%DX,grid%DY,                    &amp;<a name='189'>
                       grid%gridpt_stddev_sppt,                           &amp;<a name='190'>
                       grid%lengthscale_sppt,                             &amp;<a name='191'>
                       grid%timescale_sppt,                               &amp;<a name='192'>
                       grid%TOT_BACKSCAT_T,grid%ZTAU_T,                   &amp;<a name='193'>
                       grid%REXPONENT_T,                                  &amp;<a name='194'>
                       ids, ide, jds, jde, kds, kde,                      &amp;<a name='195'>
                       ims, ime, jms, jme, kms, kme,                      &amp;<a name='196'>
                       its, ite, jts, jte, kts, kte                       )<a name='197'>
     ENDIF<a name='198'>
<a name='199'>
IF (grid%sppt_on==1) then<a name='200'>
<font color=#447700>! Initialize SPPT (3)<a name='201'></font>
     if ((.not.config_flags%restart) .or. (.not.config_flags%hrrr_cycling)) then <a name='202'>
         call <A href='../../html_code/dyn_em/module_stoch.F.html#RAND_SEED'>rand_seed</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAND_SEED_2"> (config_flags, grid%ISEED_SPPT, grid%iseedarr_sppt  , kms, kme)<a name='203'>
     endif<a name='204'>
     call <A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB'>SETUP_RAND_PERTURB</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_RAND_PERTURB_3">('P',                                         &amp;<a name='205'>
                       grid%sppt_vertstruc,config_flags%restart,          &amp;<a name='206'>
                       grid%SPPT_AMP,                                     &amp;<a name='207'>
                       grid%SPPTFORCC,grid%SPPTFORCS,grid%ALPH_SPPT,      &amp;<a name='208'>
                       grid%VERTSTRUCC,grid%VERTSTRUCS,grid%VERTAMPT,     &amp;<a name='209'>
                       grid%KMINFORCT,grid%KMAXFORCT,                     &amp;<a name='210'>
                       grid%LMINFORCT,grid%LMAXFORCT,                     &amp;<a name='211'>
                       grid%KMAXFORCTH,grid%LMAXFORCTH,                   &amp;<a name='212'>
                       grid%time_step,grid%DX,grid%DY,                    &amp;<a name='213'>
                       grid%gridpt_stddev_sppt,                           &amp;<a name='214'>
                       grid%lengthscale_sppt,                             &amp;<a name='215'>
                       grid%timescale_sppt,                               &amp;<a name='216'>
                       grid%TOT_BACKSCAT_PSI,grid%ZTAU_PSI,               &amp;<a name='217'>
                       grid%REXPONENT_PSI,                                &amp;<a name='218'>
                       ids, ide, jds, jde, kds, kde,                      &amp;<a name='219'>
                       ims, ime, jms, jme, kms, kme,                      &amp;<a name='220'>
                       its, ite, jts, jte, kts, kte                       )<a name='221'>
     ENDIF<a name='222'>
<a name='223'>
<font color=#447700>! Initialize RAND_PERTURB (4)<a name='224'></font>
     IF (grid%rand_perturb_on==1) then<a name='225'>
     if ((.not.config_flags%restart) .or. (.not.config_flags%hrrr_cycling)) then <a name='226'>
         call <A href='../../html_code/dyn_em/module_stoch.F.html#RAND_SEED'>rand_seed</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAND_SEED_3"> (config_flags, grid%ISEED_RAND_PERT, grid%iseedarr_rand_pert  , kms, kme)<a name='227'>
     endif<a name='228'>
     call <A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB'>SETUP_RAND_PERTURB</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_RAND_PERTURB_4">('R',                                         &amp;<a name='229'>
                       grid%rand_pert_vertstruc,config_flags%restart,     &amp;<a name='230'>
                       grid%SP_AMP,                                       &amp;<a name='231'>
                       grid%SPFORCC,grid%SPFORCS,grid%ALPH_RAND,          &amp;<a name='232'>
                       grid%VERTSTRUCC,grid%VERTSTRUCS,grid%VERTAMPT,     &amp;<a name='233'>
                       grid%KMINFORCT,grid%KMAXFORCT,                     &amp;<a name='234'>
                       grid%LMINFORCT,grid%LMAXFORCT,                     &amp;<a name='235'>
                       grid%KMAXFORCTH,grid%LMAXFORCTH,                   &amp;<a name='236'>
                       grid%time_step,grid%DX,grid%DY,                    &amp;<a name='237'>
                       grid%gridpt_stddev_rand_pert,                      &amp;<a name='238'>
                       grid%lengthscale_rand_pert,                        &amp;<a name='239'>
                       grid%timescale_rand_pert,                          &amp;<a name='240'>
                       grid%TOT_BACKSCAT_PSI,grid%ZTAU_PSI,               &amp;<a name='241'>
                       grid%REXPONENT_PSI,                                &amp;<a name='242'>
                       ids, ide, jds, jde, kds, kde,                      &amp;<a name='243'>
                       ims, ime, jms, jme, kms, kme,                      &amp;<a name='244'>
                       its, ite, jts, jte, kts, kte                       )<a name='245'>
<a name='246'>
     if (.not.config_flags%restart) then <font color=#447700>! spin up <a name='247'></font>
        do k = 1,10<a name='248'>
           CALL <A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE'>RAND_PERT_UPDATE</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAND_PERT_UPDATE_9">(grid,'R',                                     &amp;<a name='249'>
                           grid%SPFORCS,grid%SPFORCC,                          &amp;<a name='250'>
                           grid%SP_AMP,grid%ALPH_RAND,                         &amp;<a name='251'>
                           ips, ipe, jps, jpe, kps, kpe,                       &amp;<a name='252'>
                           ids, ide, jds, jde, kds, kde,                       &amp;<a name='253'>
                           ims, ime, jms, jme, kms, kme,                       &amp;<a name='254'>
                           kts, kte,                                           &amp;<a name='255'>
                           imsx,imex,jmsx,jmex,kmsx,kmex,                      &amp;<a name='256'>
                           ipsx,ipex,jpsx,jpex,kpsx,kpex,                      &amp;<a name='257'>
                           imsy,imey,jmsy,jmey,kmsy,kmey,                      &amp;<a name='258'>
                           ipsy,ipey,jpsy,jpey,kpsy,kpey,                      &amp;<a name='259'>
                           grid%num_stoch_levels,grid%num_stoch_levels,        &amp;<a name='260'>
                           grid%num_stoch_levels,grid%num_stoch_levels,        &amp;<a name='261'>
                           config_flags%restart, grid%iseedarr_rand_pert,      &amp;<a name='262'>
                           grid%DX,grid%DY,grid%rand_pert_vertstruc,           &amp;<a name='263'>
                           grid%RAND_PERT,                                     &amp;<a name='264'>
                           grid%gridpt_stddev_rand_pert,                      &amp;<a name='265'>
                           grid%lengthscale_rand_pert,                        &amp;<a name='266'>
                           grid%VERTSTRUCC,grid%VERTSTRUCS,grid%VERTAMPT       )<a name='267'>
         enddo<a name='268'>
       ENDIF <font color=#447700>!rand_perturb_on<a name='269'></font>
     ENDIF<a name='270'>
<a name='271'>
<font color=#447700>! Initialize Stochastic Parameter Perturbations to convection scheme<a name='272'></font>
     IF (grid%spp_conv==1) then<a name='273'>
     if (.not.config_flags%restart) then <font color=#447700>! set random number seed (else  iseedarray is read in from restart files)<a name='274'></font>
         call <A href='../../html_code/dyn_em/module_stoch.F.html#RAND_SEED'>rand_seed</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAND_SEED_4"> (config_flags, grid%iseed_spp_conv, grid%iseedarr_spp_conv , kms, kme)<a name='275'>
     endif<a name='276'>
     call <A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB'>SETUP_RAND_PERTURB</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_RAND_PERTURB_5">('S',                                        &amp;<a name='277'>
                       grid%vertstruc_spp_conv,config_flags%restart,    &amp;<a name='278'>
                       grid%SP_AMP2,                                      &amp;<a name='279'>
                       grid%SPFORCC2,grid%SPFORCS2,grid%ALPH_RAND2,       &amp;<a name='280'>
                       grid%VERTSTRUCC,grid%VERTSTRUCS,grid%VERTAMPT,     &amp;<a name='281'>
                       grid%KMINFORCT,grid%KMAXFORCT,                     &amp;<a name='282'>
                       grid%LMINFORCT,grid%LMAXFORCT,                     &amp;<a name='283'>
                       grid%KMAXFORCTH,grid%LMAXFORCTH,                   &amp;<a name='284'>
                       grid%time_step,grid%DX,grid%DY,                    &amp;<a name='285'>
                       grid%gridpt_stddev_spp_conv,                     &amp;<a name='286'>
                       grid%lengthscale_spp_conv,                       &amp;<a name='287'>
                       grid%timescale_spp_conv,                         &amp;<a name='288'>
                       grid%TOT_BACKSCAT_PSI,grid%ZTAU_PSI,               &amp;<a name='289'>
                       grid%REXPONENT_PSI,                                &amp;<a name='290'>
                       ids, ide, jds, jde, kds, kde,                      &amp;<a name='291'>
                       ims, ime, jms, jme, kms, kme,                      &amp;<a name='292'>
                       its, ite, jts, jte, kts, kte                       )<a name='293'>
     ENDIF<a name='294'>
<font color=#447700>! Initialize Stochastic Parameter Peturbations (SPP) to PBL scheme<a name='295'></font>
     IF (grid%spp_pbl==1) then<a name='296'>
     if (.not.config_flags%restart) then <font color=#447700>! set random number seed (else  iseedarray is read in from restart files)<a name='297'></font>
         call <A href='../../html_code/dyn_em/module_stoch.F.html#RAND_SEED'>rand_seed</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAND_SEED_5"> (config_flags, grid%iseed_spp_pbl, grid%iseedarr_spp_pbl , kms, kme)<a name='298'>
     endif<a name='299'>
     call <A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB'>SETUP_RAND_PERTURB</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_RAND_PERTURB_6">('Q',                                        &amp;<a name='300'>
                       grid%vertstruc_spp_pbl,config_flags%restart,    &amp;<a name='301'>
                       grid%SP_AMP3,                                      &amp;<a name='302'>
                       grid%SPFORCC3,grid%SPFORCS3,grid%ALPH_RAND3,       &amp;<a name='303'>
                       grid%VERTSTRUCC,grid%VERTSTRUCS,grid%VERTAMPT,     &amp;<a name='304'>
                       grid%KMINFORCT,grid%KMAXFORCT,                     &amp;<a name='305'>
                       grid%LMINFORCT,grid%LMAXFORCT,                     &amp;<a name='306'>
                       grid%KMAXFORCTH,grid%LMAXFORCTH,                   &amp;<a name='307'>
                       grid%time_step,grid%DX,grid%DY,                    &amp;<a name='308'>
                       grid%gridpt_stddev_spp_pbl,                     &amp;<a name='309'>
                       grid%lengthscale_spp_pbl,                       &amp;<a name='310'>
                       grid%timescale_spp_pbl,                         &amp;<a name='311'>
                       grid%TOT_BACKSCAT_PSI,grid%ZTAU_PSI,               &amp;<a name='312'>
                       grid%REXPONENT_PSI,                                &amp;<a name='313'>
                       ids, ide, jds, jde, kds, kde,                      &amp;<a name='314'>
                       ims, ime, jms, jme, kms, kme,                      &amp;<a name='315'>
                       its, ite, jts, jte, kts, kte                       )<a name='316'>
     ENDIF<a name='317'>
<font color=#447700>! Initialize Stochastic Parameter Peturbations (SPP) to LSM scheme<a name='318'></font>
     IF (grid%spp_lsm==1) then<a name='319'>
     if (.not.config_flags%restart) then <font color=#447700>! set random number seed (else  iseedarray is read in from restart files)<a name='320'></font>
         call <A href='../../html_code/dyn_em/module_stoch.F.html#RAND_SEED'>rand_seed</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAND_SEED_6"> (config_flags, grid%iseed_spp_lsm, grid%iseedarr_spp_lsm , kms, kme)<a name='321'>
     endif<a name='322'>
     call <A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB'>SETUP_RAND_PERTURB</A><A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_RAND_PERTURB_7">('O',                                        &amp;<a name='323'>
                       grid%vertstruc_spp_lsm,config_flags%restart,    &amp;<a name='324'>
                       grid%SP_AMP4,                                      &amp;<a name='325'>
                       grid%SPFORCC4,grid%SPFORCS4,grid%ALPH_RAND4,       &amp;<a name='326'>
                       grid%VERTSTRUCC,grid%VERTSTRUCS,grid%VERTAMPT,     &amp;<a name='327'>
                       grid%KMINFORCT,grid%KMAXFORCT,                     &amp;<a name='328'>
                       grid%LMINFORCT,grid%LMAXFORCT,                     &amp;<a name='329'>
                       grid%KMAXFORCTH,grid%LMAXFORCTH,                   &amp;<a name='330'>
                       grid%time_step,grid%DX,grid%DY,                    &amp;<a name='331'>
                       grid%gridpt_stddev_spp_lsm,                     &amp;<a name='332'>
                       grid%lengthscale_spp_lsm,                       &amp;<a name='333'>
                       grid%timescale_spp_lsm,                         &amp;<a name='334'>
                       grid%TOT_BACKSCAT_PSI,grid%ZTAU_PSI,               &amp;<a name='335'>
                       grid%REXPONENT_PSI,                                &amp;<a name='336'>
                       ids, ide, jds, jde, kds, kde,                      &amp;<a name='337'>
                       ims, ime, jms, jme, kms, kme,                      &amp;<a name='338'>
                       its, ite, jts, jte, kts, kte                       )<a name='339'>
     ENDIF<a name='340'>
<a name='341'>
     ENDIF <font color=#447700>! skebs or sppt or rand_perturb or spp<a name='342'></font>
 <a name='343'>
      END SUBROUTINE INITIALIZE_STOCH       <a name='344'>
<a name='345'>
      <font color=#447700>!   --- END SETUP STOCHASTIC PERTURBATION SCHEMES ----------<a name='346'></font>
<a name='347'>
<a name='348'>
<A NAME='SETUP_RAND_PERTURB'><A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='349'>
      <font color=#993300>subroutine </font><font color=#cc0000>SETUP_RAND_PERTURB</font>( variable_in,&amp;  <A href='../../call_to/SETUP_RAND_PERTURB.html' TARGET='index'>7</A>,<A href='../../call_from/SETUP_RAND_PERTURB.html' TARGET='index'>1</A><a name='350'>
                       skebs_vertstruc,restart,                  &amp; <a name='351'>
                       SP_AMP,SPFORCC,SPFORCS,ALPH,                  &amp; <a name='352'>
                       VERTSTRUCC,VERTSTRUCS,VERTAMP,                &amp;<a name='353'>
                       KMINFORCT,KMAXFORCTH,LMINFORCT,LMAXFORCTH,    &amp; <a name='354'>
                       KMAXFORCT,LMAXFORCT,                          &amp;<a name='355'>
                       itime_step,DX,DY,                             &amp;<a name='356'>
                       gridpt_stddev_rand_perturb, l_rand_perturb,   &amp; <a name='357'>
                       tau_rand_perturb,                             &amp;<a name='358'>
                       TOT_BACKSCAT,ZTAU,REXPONENT,                  &amp; <a name='359'>
                       ids, ide, jds, jde, kds, kde,                 &amp;<a name='360'>
                       ims, ime, jms, jme, kms, kme,                 &amp;<a name='361'>
                       its, ite, jts, jte, kts, kte                  )<a name='362'>
<a name='363'>
<a name='364'>
<a name='365'>
      IMPLICIT NONE<a name='366'>
<a name='367'>
<font color=#447700>! General control <a name='368'></font>
      LOGICAL                                   :: restart<a name='369'>
      REAL, PARAMETER                           :: RPI= 3.141592653589793 <font color=#447700>!4.0*atan(1.0) <a name='370'></font>
      CHARACTER, INTENT(IN)                     :: variable_in <font color=#447700>! W=SKEBS_PSI, T=SKEBS_T, P=SPPT, R=RAND_PERTURB<a name='371'></font>
      CHARACTER                                 :: variable<a name='372'>
<a name='373'>
<font color=#447700>! Common to all schemes<a name='374'></font>
      INTEGER , INTENT(IN)                      :: ids, ide, jds, jde, kds, kde,   &amp;<a name='375'>
                                                   ims, ime, jms, jme, kms, kme,   &amp;<a name='376'>
                                                   its, ite, jts, jte, kts, kte<a name='377'>
      INTEGER                                   :: IER,IK,IL,I,J,itime_step,skebs_vertstruc, &amp; <a name='378'>
                                                   KMINFORCT,LMINFORCT,KMAXFORCT,LMAXFORCT,KMAXFORCTH,LMAXFORCTH, &amp; <a name='379'>
                                                   KMAX,LMAX,LENSAV,ILEV<a name='380'>
      REAL                                      :: DX,DY,RY,RX,ALPH,RHOKLMAX,ZREF,RHOKL,EPS<a name='381'>
      REAL, DIMENSION (ims:ime,jms:jme)         :: SPFORCS,SPFORCC,SP_AMP<a name='382'>
      REAL, DIMENSION (ims:ime,kms:kme,jms:jme) :: VERTSTRUCC,VERTSTRUCS<a name='383'>
      REAL, DIMENSION (kms:kme)                 :: VERTAMP<a name='384'>
      REAL, DIMENSION (ids:ide,jds:jde)         :: ZCHI<a name='385'>
<a name='386'>
<font color=#447700>! SPPT and perturb_rand specific <a name='387'></font>
      REAL                                      :: gridpt_stddev_rand_perturb,kappat,tau_rand_perturb,l_rand_perturb<a name='388'>
      REAL, DIMENSION (ims:ime,jms:jme)         :: var_sigma1<a name='389'>
<a name='390'>
<a name='391'>
<font color=#447700>! SKEBS specific<a name='392'></font>
      REAL                                      :: z,phi,ZGAMMAN,ZCONSTF0,TOT_BACKSCAT,ZTAU,REXPONENT,ZSIGMA2<a name='393'>
      LOGICAL                                   :: is_print = .true.<a name='394'>
<a name='395'>
<a name='396'>
      variable = variable_in<a name='397'>
<font color=#447700>!     --------- SETUP PARAMETERS ---------------------------------------<a name='398'></font>
      KMAX=(jde-jds)+1 <font color=#447700>!NLAT<a name='399'></font>
      LMAX=(ide-ids)+1 <font color=#447700>!NLON<a name='400'></font>
      RY=  KMAX*DY<a name='401'>
      RX=  LMAX*DX<a name='402'>
      LENSAV= 4*(KMAX+LMAX)+INT(LOG(REAL(KMAX))) + INT(LOG(REAL(LMAX))) + 8<a name='403'>
<a name='404'>
<font color=#447700>!     --------- ALLOCATE FIELDS FOR FFTPACK----------------------------<a name='405'></font>
<font color=#447700>!     --------- ALLOCATE FIELDS FOR FFTPACK----------------------------<a name='406'></font>
      IF ( ALLOCATED(WSAVE1)      ) DEALLOCATE(WSAVE1)<a name='407'>
      IF ( ALLOCATED(WSAVE2)      ) DEALLOCATE(WSAVE2)<a name='408'>
      ALLOCATE(WSAVE1(LENSAV),WSAVE2(LENSAV))<a name='409'>
<a name='410'>
      IF ( ALLOCATED(WAVENUMBER_K)) DEALLOCATE(WAVENUMBER_K)<a name='411'>
      IF ( ALLOCATED(WAVENUMBER_L)) DEALLOCATE(WAVENUMBER_L)<a name='412'>
      ALLOCATE (wavenumber_k(jds:jde),wavenumber_l(ids:ide))<a name='413'>
<a name='414'>
<font color=#447700>!     -------- INITIALIZE FFTPACK ROUTINES -----------------------------<a name='415'></font>
      call CFFT1I (LMAX, WSAVE1, LENSAV, IER)<a name='416'>
      if(ier.ne. 0) write(*,95) ier<a name='417'>
<a name='418'>
      call CFFT1I (KMAX, WSAVE2, LENSAV, IER)<a name='419'>
      if(ier.ne. 0) write(*,95) ier<a name='420'>
<a name='421'>
      95 format('error in cFFT2I=  ',i5)<a name='422'>
<a name='423'>
      call <A href='../../html_code/phys/module_cu_kfcup.F.html#FINDINDEX'>findindex</A><A href='../../html_code/dyn_em/module_stoch.F.html#SETUP_RAND_PERTURB' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDINDEX_1">( wavenumber_k, wavenumber_l,             &amp;<a name='424'>
                      ids, ide, jds, jde, kds, kde,                &amp;<a name='425'>
                      ims, ime, jms, jme, kms, kme,                &amp;<a name='426'>
                      its, ite, jts, jte, kts, kte                 )<a name='427'>
<a name='428'>
<font color=#447700>!    set maximal perturbed wavenumber based on gridpoints in domain<a name='429'></font>
     KMAXFORCT=min0(((ide-ids)+1)/2,((jde-jds)+1 )/2)-5<a name='430'>
     LMAXFORCT=KMAXFORCT<a name='431'>
     if (KMAXFORCT &gt; KMAXFORCTH) then<a name='432'>
        KMAXFORCT=KMAXFORCTH<a name='433'>
     endif<a name='434'>
     if (LMAXFORCT &gt; LMAXFORCTH) then<a name='435'>
        LMAXFORCT=LMAXFORCTH<a name='436'>
     endif<a name='437'>
<a name='438'>
<a name='439'>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='440'></font>
<font color=#447700>!     ---------- INITIALIZE STOCHASTIC KINETIC-ENERGY BACKSCATTER SCHEME  (SKEBS) ----------<a name='441'></font>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='442'></font>
      ALPH   =  float(itime_step)/ZTAU <font color=#447700>! approximation of 1.-exp(-itime_step/ZTAU_PSI)<a name='443'></font>
      ZSIGMA2=1./(12.0*ALPH)<a name='444'>
<a name='445'>
      if (is_print) then<a name='446'>
      IF (variable == 'W') then<a name='447'>
      WRITE(*,'(''                                               '')')<a name='448'>
      WRITE(*,'('' =============================================='')')<a name='449'>
      WRITE(*,'('' &gt;&gt; Initializing STREAMFUNCTION forcing pattern of  &lt;&lt; '')')<a name='450'>
      WRITE(*,'('' &gt;&gt; stochastic kinetic-energy backscatter scheme &lt;&lt; '')')<a name='451'>
      WRITE(*,'('' Total backscattered energy, TOT_BACKSCAT_PSI '',E12.5)') TOT_BACKSCAT<a name='452'>
      WRITE(*,'('' Exponent for energy spectra, REXPONENT_PSI ='',E12.5)') REXPONENT<a name='453'>
      WRITE(*,'('' Minimal wavenumber of streamfunction forcing, LMINFORC ='',I10)') LMINFORCT<a name='454'>
      WRITE(*,'('' Maximal wavenumber of streamfunction forcing, LMAXFORC ='',I10)') LMAXFORCT<a name='455'>
      WRITE(*,'('' Minimal wavenumber of streamfunction forcing, KMINFORC ='',I10)') KMINFORCT<a name='456'>
      WRITE(*,'('' Maximal wavenumber of streamfunction forcing, KMAXFORC ='',I10)') KMAXFORCT<a name='457'>
      WRITE(*,'('' skebs_vertstruc                             '',I10)') skebs_vertstruc<a name='458'>
      WRITE(*,'('' Time step: itime_step='',I10)') itime_step<a name='459'>
      WRITE(*,'('' Decorrelation time of noise, ZTAU_PSI ='',E12.5)') ZTAU<a name='460'>
      WRITE(*,'('' Variance of noise, ZSIGMA2_EPS  ='',E12.5)') ZSIGMA2<a name='461'>
      WRITE(*,'('' Autoregressive parameter 1-ALPH_PSI ='',E12.5)') 1.-ALPH<a name='462'>
      WRITE(*,'('' =============================================='')')<a name='463'>
<a name='464'>
<font color=#447700>!     Unit of SPSTREAM_AMP: sqrt(m^2/s^3 1/s m**2(p+1)) m**-2(p/2) = m^/s^2 * m**[(p+1)-p] = m^2/s^2 m<a name='465'></font>
      ELSEIF (variable == 'T') then<a name='466'>
      WRITE(*,'(''                                               '')')<a name='467'>
      WRITE(*,'('' =============================================='')')<a name='468'>
      WRITE(*,'('' &gt;&gt; Initializing TEMPERATURE forcing pattern of  &lt;&lt; '')')<a name='469'>
      WRITE(*,'('' &gt;&gt; stochastic kinetic-energy backscatter scheme &lt;&lt; '')')<a name='470'>
      WRITE(*,'('' Total backscattered energy, TOT_BACKSCAT_T   '',E12.5)') TOT_BACKSCAT<a name='471'>
      WRITE(*,'('' Exponent for energy spectra, REXPONENT_T   ='',E12.5)') REXPONENT<a name='472'>
      WRITE(*,'('' Minimal wavenumber of tempearature forcing, LMINFORC ='',I10)') LMINFORCT<a name='473'>
      WRITE(*,'('' Maximal wavenumber of tempearature forcing, LMAXFORC ='',I10)') LMAXFORCT<a name='474'>
      WRITE(*,'('' Minimal wavenumber of tempearature forcing, KMINFORC ='',I10)') KMINFORCT<a name='475'>
      WRITE(*,'('' Maximal wavenumber of tempearature forcing, KMAXFORC ='',I10)') KMAXFORCT<a name='476'>
      WRITE(*,'('' skebs_vertstruc                             '',I10)') skebs_vertstruc<a name='477'>
      WRITE(*,'('' Decorrelation time of noise, ZTAU_T ='',E12.5)') ZTAU<a name='478'>
      WRITE(*,'('' Variance of noise, ZSIGMA2_ETA  ='',E12.5)') ZSIGMA2<a name='479'>
      WRITE(*,'('' Autoregressive parameter 1-ALPH_T ='',E12.5)') 1.-ALPH<a name='480'>
      WRITE(*,'('' =============================================='')')<a name='481'>
      endif<a name='482'>
<a name='483'>
     IF ((variable == 'P') .or. (variable == 'R') .or. (variable == 'S') .or. (variable == 'Q') .or. (variable == 'O')) then<a name='484'>
      kappat= L_rand_perturb**2 <font color=#447700>! L^2= kappa*T,  where L is a length scale in m; set to for L=100km <a name='485'></font>
      phi = exp (-float(itime_step)/tau_rand_perturb)<a name='486'>
      alph = 1.-phi<a name='487'>
     endif <a name='488'>
<a name='489'>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='490'></font>
<font color=#447700>!     ---------- INITIALIZE STOCHASTICALLY PERTURBED PHYSICAL TENDENCY SCHEME --------------<a name='491'></font>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='492'></font>
     if (variable == 'P') then<a name='493'>
      WRITE(*,'(''                                               '')')<a name='494'>
      WRITE(*,'('' =============================================='')')<a name='495'>
      WRITE(*,'('' &gt;&gt; Initializing Stochastically Perturbed Physics Tendency scheme &lt;&lt; '')')<a name='496'>
      WRITE(*,'('' sppt_vertstruc                             '',I10)') skebs_vertstruc<a name='497'>
      WRITE(*,'('' Decorrelation time of noise, Tau ='',E12.5)') tau_rand_perturb<a name='498'>
      WRITE(*,'('' Autoregressive parameter Phi ='',E12.5)') phi<a name='499'>
      WRITE(*,'('' Length Scale L'',E12.5)') l_rand_perturb<a name='500'>
      WRITE(*,'('' Variance in gridpoint space'',E12.5)') gridpt_stddev_rand_perturb<a name='501'>
      WRITE(*,'('' =============================================='')')<a name='502'>
      endif <font color=#447700>! variable <a name='503'></font>
<a name='504'>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='505'></font>
<font color=#447700>!     --------------------  INITIALIZE  RANDOM PERTUBATIONS  -------------------------------<a name='506'></font>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='507'></font>
     if (variable == 'R') then<a name='508'>
      WRITE(*,'(''                                               '')')<a name='509'>
      WRITE(*,'('' =============================================='')')<a name='510'>
      WRITE(*,'('' &gt;&gt; Initializing random perturbations &lt;&lt; '')')<a name='511'>
      WRITE(*,'('' rand_pert_vertstruc                             '',I10)') skebs_vertstruc<a name='512'>
      WRITE(*,'('' Decorrelation time of noise, Tau ='',E12.5)') tau_rand_perturb<a name='513'>
      WRITE(*,'('' Autoregressive parameter Phi ='',E12.5)') phi<a name='514'>
      WRITE(*,'('' Length Scale L'',E12.5)') l_rand_perturb<a name='515'>
      WRITE(*,'('' Variance in gridpoint space'',E12.5)') gridpt_stddev_rand_perturb<a name='516'>
      WRITE(*,'('' =============================================='')')<a name='517'>
     endif <font color=#447700>! variable <a name='518'></font>
<a name='519'>
     if (variable == 'S') then<a name='520'>
      WRITE(*,'(''                                               '')')<a name='521'>
      WRITE(*,'('' =============================================='')')<a name='522'>
      WRITE(*,'('' &gt;&gt; Initializing stochastic parameter perturbations for convection&lt;&lt; '')')<a name='523'>
      WRITE(*,'('' rand_pert_vertstruc2                            '',I10)') skebs_vertstruc<a name='524'>
      WRITE(*,'('' Decorrelation time of noise, Tau ='',E12.5)') tau_rand_perturb<a name='525'>
      WRITE(*,'('' Autoregressive parameter Phi ='',E12.5)') phi<a name='526'>
      WRITE(*,'('' Length Scale L'',E12.5)') l_rand_perturb<a name='527'>
      WRITE(*,'('' Variance in gridpoint space'',E12.5)') gridpt_stddev_rand_perturb<a name='528'>
      WRITE(*,'('' =============================================='')')<a name='529'>
     endif <font color=#447700>! variable <a name='530'></font>
<a name='531'>
     if (variable == 'Q') then<a name='532'>
      WRITE(*,'(''                                               '')')<a name='533'>
      WRITE(*,'('' =============================================='')')<a name='534'>
      WRITE(*,'('' &gt;&gt; Initializing stochastic parameter perturbations for PBL&lt;&lt; '')')<a name='535'>
      WRITE(*,'('' rand_pert_vertstruc3                            '',I10)') skebs_vertstruc<a name='536'>
      WRITE(*,'('' Decorrelation time of noise, Tau ='',E12.5)') tau_rand_perturb<a name='537'>
      WRITE(*,'('' Autoregressive parameter Phi ='',E12.5)') phi<a name='538'>
      WRITE(*,'('' Length Scale L'',E12.5)') l_rand_perturb<a name='539'>
      WRITE(*,'('' Variance in gridpoint space'',E12.5)') gridpt_stddev_rand_perturb<a name='540'>
      WRITE(*,'('' =============================================='')')<a name='541'>
     endif <font color=#447700>! variable <a name='542'></font>
<a name='543'>
     if (variable == 'O') then<a name='544'>
      WRITE(*,'(''                                               '')')<a name='545'>
      WRITE(*,'('' =============================================='')')<a name='546'>
      WRITE(*,'('' &gt;&gt; Initializing stochastic parameter perturbations for LSM&lt;&lt; '')')<a name='547'>
      WRITE(*,'('' rand_pert_vertstruc4                            '',I10)') skebs_vertstruc<a name='548'>
      WRITE(*,'('' Decorrelation time of noise, Tau ='',E12.5)') tau_rand_perturb<a name='549'>
      WRITE(*,'('' Autoregressive parameter Phi ='',E12.5)') phi<a name='550'>
      WRITE(*,'('' Length Scale L'',E12.5)') l_rand_perturb<a name='551'>
      WRITE(*,'('' Variance in gridpoint space'',E12.5)') gridpt_stddev_rand_perturb<a name='552'>
      WRITE(*,'('' =============================================='')')<a name='553'>
     endif <font color=#447700>! variable <a name='554'></font>
<a name='555'>
     endif <font color=#447700>!is print<a name='556'></font>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='557'></font>
<font color=#447700>!     Compute Normalization constants       <a name='558'></font>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='559'></font>
<a name='560'>
     ZCHI    =  0.0<a name='561'>
     ZGAMMAN  =  0.0<a name='562'>
      <font color=#447700>! Fill lower left quadrant of ZCHI. For this range the indeces IK,IL<a name='563'></font>
      DO IK=jds-1,jde   <font color=#447700>! These are now wavenumbers<a name='564'></font>
      DO IL=ids-1,ide<a name='565'>
      if (((sqrt((IK/RY*IK/RY)+(IL/RX*IL/RX)).lt.((KMAXFORCT+0.5)/RX)).and.&amp;<a name='566'>
           (sqrt((IK/RY*IK/RY)+(IL/RX*IL/RX)).ge.((KMINFORCT-0.5)/RX))) .or. &amp;<a name='567'>
          ((sqrt((IK/RY*IK/RY)+(IL/RX*IL/RX)).lt.((LMAXFORCT+0.5)/RY)).and.&amp;<a name='568'>
           (sqrt((IK/RY*IK/RY)+(IL/RX*IL/RX)).ge.((LMINFORCT-0.5)/RY))))then<a name='569'>
        if ((IK&gt;0).or.(IL&gt;0)) then<a name='570'>
          if (variable == 'W') then<a name='571'>
            ZCHI(IL+1,IK+1)=((IK/RY*IK/RY)+(IL/RX*IL/RX))**(REXPONENT/2.)  <font color=#447700>! SKEBS :U <a name='572'></font>
            ZGAMMAN= ZGAMMAN + ((IK/RY*IK/RY)+(IL/RX*IL/RX))**(REXPONENT+1)        <a name='573'>
          else if (variable == 'T') then<a name='574'>
            ZCHI(IL+1,IK+1)=((IK/RY*IK/RY)+(IL/RX*IL/RX))**(REXPONENT/2.)  <font color=#447700>! SKEBS :T<a name='575'></font>
            ZGAMMAN= ZGAMMAN + ((IK/RY*IK/RY)+(IL/RX*IL/RX))**(REXPONENT)          <a name='576'>
          else if ((variable == 'P') .or. (variable == 'R') .or.  (variable == 'S') .or. (variable == 'O') .or.  (variable == 'Q     ')) then<a name='577'>
            ZCHI(IL+1,IK+1)=exp(  -2*RPI**2*kappat*((IK/RY*IK/RY)+(IL/RX*IL/RX)) ) <font color=#447700>!SPPT<a name='578'></font>
            ZGAMMAN= ZGAMMAN + exp(  -4*RPI**2*kappat*((IK/RY*IK/RY)+(IL/RX*IL/RX)) ) <font color=#447700>!SPPT<a name='579'></font>
          endif<a name='580'>
        endif<a name='581'>
      endif<a name='582'>
      enddo<a name='583'>
      enddo<a name='584'>
      ZGAMMAN=4.0*ZGAMMAN <font color=#447700>!account for all quadrants, although only one is Filled<a name='585'></font>
      if (variable == 'W') then<a name='586'>
         ZCONSTF0=SQRT(ALPH*TOT_BACKSCAT/(float(itime_step)*ZSIGMA2*ZGAMMAN))/(2*RPI)<a name='587'>
      elseif  (variable == 'T') then     <a name='588'>
         ZCONSTF0=SQRT(T0*ALPH*TOT_BACKSCAT/(float(itime_step)*cp*ZSIGMA2*ZGAMMAN))<a name='589'>
      elseif ((variable == 'P') .or. (variable == 'R') .or.  (variable == 'S') .or. (variable == 'O') .or.  (variable == 'Q     ')) then<a name='590'>
         ZCONSTF0= gridpt_stddev_rand_perturb*sqrt((1.-phi**2)/(2.*ZGAMMAN))<a name='591'>
      endif<a name='592'>
  <a name='593'>
<a name='594'>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='595'></font>
<font color=#447700>!     Now the wavenumber-dependent amplitudes<a name='596'></font>
<font color=#447700>!     --------------------------------------------------------------------------------------<a name='597'></font>
<font color=#447700>!     Note: There are symmetries and anti-symmetries to ensure real-valued back transforms<a name='598'></font>
<font color=#447700>!     Fill lower left quadrant of matrix of noise amplitudes for wavenumbers K=0,KMAX/2<a name='599'></font>
      SP_AMP=0.0<a name='600'>
      DO IK=jts,jte<a name='601'>
      DO IL=its,ite<a name='602'>
      if ((IL .le. (LMAX/2+1)) .and. (IK .le. (KMAX/2+1)) ) then<a name='603'>
        SP_AMP(IL,IK)      = ZCONSTF0*ZCHI(IL,IK)<a name='604'>
      endif<a name='605'>
      ENDDO<a name='606'>
      ENDDO<a name='607'>
<a name='608'>
      <font color=#447700>! Fill other quadrants:<a name='609'></font>
      <font color=#447700>! Upper left quadrant<a name='610'></font>
      DO IK=jts,jte<a name='611'>
      DO IL=its,ite<a name='612'>
      if ( (IL .gt. (LMAX/2+1)) .and. (IK .le. (KMAX/2+1)) ) then<a name='613'>
        SP_AMP(IL,IK)      =  ZCONSTF0*ZCHI(LMAX-IL+2,IK)<a name='614'>
      endif<a name='615'>
      ENDDO<a name='616'>
      ENDDO<a name='617'>
<a name='618'>
<font color=#447700>!     Lower right quadrant<a name='619'></font>
      DO IK=jts,jte<a name='620'>
      DO IL=its,ite<a name='621'>
      if ((IK .gt. (KMAX/2+1)) .and. (IL.le.LMAX/2) ) then<a name='622'>
        SP_AMP(IL,IK)      = ZCONSTF0*ZCHI(IL,KMAX-IK+2)<a name='623'>
      endif<a name='624'>
      ENDDO<a name='625'>
      ENDDO<a name='626'>
<a name='627'>
<font color=#447700>!     Upper right quadrant<a name='628'></font>
      DO IK=jts,jte<a name='629'>
      DO IL=its,ite<a name='630'>
      if ((IK .gt. (KMAX/2+1)) .and. (IL.gt.LMAX/2) ) then<a name='631'>
        SP_AMP(IL,IK)      = ZCONSTF0*ZCHI(LMAX-IL+2,KMAX-IK+2)<a name='632'>
      endif<a name='633'>
      ENDDO<a name='634'>
      ENDDO<a name='635'>
<a name='636'>
<font color=#447700>!     -----------------------------------------<a name='637'></font>
<font color=#447700>!     Array for vertical structure if desired<a name='638'></font>
      VERTAMP=1.0 <font color=#447700>! Define vertical amplitude here.<a name='639'></font>
<a name='640'>
      IF (skebs_vertstruc==1) then<a name='641'>
        VERTSTRUCC=0.0<a name='642'>
        VERTSTRUCS=0.0<a name='643'>
        RHOKLMAX= sqrt(KMAX**2/DY**2 + LMAX**2/DX**2)<a name='644'>
        ZREF=32.0<a name='645'>
        DO ILEV=kts,kte<a name='646'>
          DO IK=jts,jte<a name='647'>
            DO IL=its,ite<a name='648'>
            if (IL.le.(LMAX/2)) then<a name='649'>
              RHOKL   = sqrt((IK+1)**2/DY**2 + (IL+1)**2/DX**2)<a name='650'>
              EPS     = ((RHOKLMAX - RHOKL)/ RHOKLMAX)  * (ILEV/ZREF) * RPI<a name='651'>
              VERTSTRUCC(IL,ILEV,IK) =  cos ( eps* (IL+1) )<a name='652'>
              VERTSTRUCS(IL,ILEV,IK) =  sin ( eps* (IL+1) )<a name='653'>
             else<a name='654'>
              RHOKL   = sqrt((IK+1)**2/DY**2 + (LMAX-IL+2)**2/DX**2)<a name='655'>
              EPS     = ((RHOKLMAX - RHOKL)/ RHOKLMAX)  * (ILEV/ZREF) * RPI<a name='656'>
              VERTSTRUCC (IL,ILEV,IK) =   cos ( eps* (LMAX-IL+2) )<a name='657'>
              VERTSTRUCS (IL,ILEV,IK) = - sin ( eps* (LMAX-IL+2) )<a name='658'>
            endif<a name='659'>
            ENDDO<a name='660'>
          ENDDO<a name='661'>
        ENDDO<a name='662'>
      ENDIF<a name='663'>
<a name='664'>
     END subroutine SETUP_RAND_PERTURB<a name='665'>
<a name='666'>
<font color=#447700>!     ------------------------------------------------------------------<a name='667'></font>
<font color=#447700>!************** UPDATE STOCHASTIC PATTERN IN WAVENUMBER SPACE**********<a name='668'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='669'></font>
<a name='670'>
<A NAME='UPDATE_STOCH'><A href='../../html_code/dyn_em/module_stoch.F.html#UPDATE_STOCH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='671'>
     <font color=#993300>subroutine </font><font color=#cc0000>UPDATE_STOCH</font>(                                         &amp;  <A href='../../call_to/UPDATE_STOCH.html' TARGET='index'>1</A>,<A href='../../call_from/UPDATE_STOCH.html' TARGET='index'>2</A><a name='672'>
                      SPFORCS,SPFORCC,SP_AMP,ALPH,                    &amp;<a name='673'>
                      restart,iseedarr,                             &amp;<a name='674'>
                      ids, ide, jds, jde, kds, kde,                   &amp;<a name='675'>
                      ims, ime, jms, jme, kms, kme,                   &amp;<a name='676'>
                      its, ite, jts, jte, kts, kte                    )<a name='677'>
     IMPLICIT NONE<a name='678'>
<a name='679'>
     REAL, DIMENSION( ids:ide,jds:jde)      :: ZRANDNOSS,ZRANDNOSC<a name='680'>
     REAL, DIMENSION (ims:ime,jms:jme)      :: SPFORCS,SPFORCC,SP_AMP<a name='681'>
     INTEGER , INTENT(IN)     ::               ids, ide, jds, jde, kds, kde,   &amp;<a name='682'>
                                               ims, ime, jms, jme, kms, kme,   &amp;<a name='683'>
                                               its, ite, jts, jte, kts, kte<a name='684'>
   <a name='685'>
     INTEGER, DIMENSION (kms:kme),             INTENT(INOUT) :: iseedarr<a name='686'>
     INTEGER , ALLOCATABLE , DIMENSION(:) :: iseed<a name='687'>
     REAL :: Z,ALPH<a name='688'>
     REAL, PARAMETER :: thresh = 3.0<a name='689'>
     INTEGER ::IL, IK,LMAX,KMAX<a name='690'>
     INTEGER :: how_many<a name='691'>
     LOGICAL :: LGAUSS,RESTART<a name='692'>
<a name='693'>
     KMAX=(jde-jds)+1 <font color=#447700>!NLAT<a name='694'></font>
     LMAX=(ide-ids)+1 <font color=#447700>!NATX<a name='695'></font>
<a name='696'>
           CALL random_seed(size=how_many)<a name='697'>
           IF ( ALLOCATED(iseed)) DEALLOCATE(iseed)<a name='698'>
           ALLOCATE(iseed(how_many))<a name='699'>
           iseed=iseedarr(1:how_many)<a name='700'>
           call random_seed(put=iseed(1:how_many))<a name='701'>
<a name='702'>
<font color=#447700>!     Pick the distribution of the noise<a name='703'></font>
<font color=#447700>!     Random noise uses global indexes to ensure necessary symmetries and anti-symmetries<a name='704'></font>
<font color=#447700>!     of random forcing when run on multiple processors<a name='705'></font>
     LGAUSS=.true.<a name='706'>
     IF (LGAUSS) then<a name='707'>
       DO IK=jds,jde<a name='708'>
         DO IL=ids,ide<a name='709'>
          do<a name='710'>
           call <A href='../../html_code/dyn_em/module_stoch.F.html#GAUSS_NOISE'>gauss_noise</A><A href='../../html_code/dyn_em/module_stoch.F.html#UPDATE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAUSS_NOISE_1">(z)<a name='711'>
           if (abs(z)&lt;thresh) exit<a name='712'>
          ENDDO<a name='713'>
          ZRANDNOSS(IL,IK)=z<a name='714'>
          do<a name='715'>
           call <A href='../../html_code/dyn_em/module_stoch.F.html#GAUSS_NOISE'>gauss_noise</A><A href='../../html_code/dyn_em/module_stoch.F.html#UPDATE_STOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAUSS_NOISE_2">(z)<a name='716'>
           if (abs(z)&lt;thresh) exit<a name='717'>
          ENDDO<a name='718'>
          ZRANDNOSC(IL,IK)=z<a name='719'>
         ENDDO<a name='720'>
       ENDDO<a name='721'>
     ELSE<a name='722'>
       DO IK=jds,jde<a name='723'>
         DO IL=ids,ide<a name='724'>
           CALL RANDOM_NUMBER(z)<a name='725'>
           ZRANDNOSS(IL,IK)=z-0.5<a name='726'>
           CALL RANDOM_NUMBER(z)<a name='727'>
           ZRANDNOSC(IL,IK)=z-0.5<a name='728'>
          ENDDO<a name='729'>
        ENDDO<a name='730'>
      ENDIF<a name='731'>
<a name='732'>
<font color=#447700>!     Note: There are symmetries and anti-symmetries to ensure real-valued back transforms<a name='733'></font>
<font color=#447700>! for symmetric part: left and right half axis symmetric<a name='734'></font>
<a name='735'>
      DO IK=jts,jte<a name='736'>
      if ((IK.le.(KMAX/2+1)) .and. (IK&gt;1)) then <font color=#447700>! Upper half<a name='737'></font>
        DO IL=its,ite<a name='738'>
          SPFORCC(IL,IK)       = (1.-ALPH)*SPFORCC(IL,IK)      + SP_AMP(IL,IK)     * ZRANDNOSC(IL,IK)  <a name='739'>
          SPFORCS(IL,IK)       = (1.-ALPH)*SPFORCS(IL,IK)      + SP_AMP(IL,IK)     * ZRANDNOSS(IL,IK)  <a name='740'>
        ENDDO<a name='741'>
      ELSEIF (IK==1) then<a name='742'>
        DO IL=its,ite<a name='743'>
        if ((IL.le.(LMAX/2+1))) then<a name='744'>
          SPFORCC(IL,IK)       = (1.-ALPH)*SPFORCC(IL,IK)      + SP_AMP(IL,IK)     * ZRANDNOSC(IL,IK)  <a name='745'>
          SPFORCS(IL,IK)       = (1.-ALPH)*SPFORCS(IL,IK)      + SP_AMP(IL,IK)     * ZRANDNOSS(IL,IK)  <a name='746'>
        elseif ((IL.gt.(LMAX/2+1))) then<a name='747'>
          SPFORCC(IL,IK)       = (1.-ALPH)*SPFORCC(IL,IK)      + SP_AMP(IL,IK)     * ZRANDNOSC(LMAX-IL+2,IK)  <a name='748'>
          SPFORCS(IL,IK)       = (1.-ALPH)*SPFORCS(IL,IK)      - SP_AMP(IL,IK)     * ZRANDNOSS(LMAX-IL+2,IK)  <a name='749'>
        endif<a name='750'>
        ENDDO<a name='751'>
      ENDIF<a name='752'>
      ENDDO<a name='753'>
<a name='754'>
      DO IK=jts,jte<a name='755'>
      if (IK.gt.(KMAX/2+1)) then <font color=#447700>! Lower half<a name='756'></font>
        DO IL=its,ite<a name='757'>
          if (IL.le.(LMAX/2+1).and.(IL.gt.1)) then <font color=#447700>!lower left <a name='758'></font>
           SPFORCC(IL,IK)      = (1.-ALPH)* SPFORCC(IL,IK)      + SP_AMP(IL,IK)      * ZRANDNOSC(LMAX-IL+2,KMAX-IK+2)<a name='759'>
           SPFORCS(IL,IK)      = (1.-ALPH)* SPFORCS(IL,IK)      - SP_AMP(IL,IK)      * ZRANDNOSS(LMAX-IL+2,KMAX-IK+2)<a name='760'>
          elseif (IL.eq.1) then <font color=#447700>!don't exceed index<a name='761'></font>
           SPFORCC(IL,IK)      = (1.-ALPH)* SPFORCC(IL,IK)      + SP_AMP(IL,IK)      * ZRANDNOSC(        1,KMAX-IK+2)<a name='762'>
           SPFORCS(IL,IK)      = (1.-ALPH)* SPFORCS(IL,IK)      - SP_AMP(IL,IK)      * ZRANDNOSS(        1,KMAX-IK+2)<a name='763'>
          elseif (IL.gt.(LMAX/2+1)) then <font color=#447700>!lower right<a name='764'></font>
           SPFORCC(IL,IK)      = (1.-ALPH)* SPFORCC(IL,IK)      + SP_AMP(IL,IK)      * ZRANDNOSC(LMAX-IL+2,KMAX-IK+2)<a name='765'>
           SPFORCS(IL,IK)      = (1.-ALPH)* SPFORCS(IL,IK)      - SP_AMP(IL,IK)      * ZRANDNOSS(LMAX-IL+2,KMAX-IK+2)<a name='766'>
          endif<a name='767'>
        ENDDO<a name='768'>
      endif<a name='769'>
      ENDDO<a name='770'>
<a name='771'>
      call random_seed(get=iseed(1:how_many))<a name='772'>
      iseedarr=0.0<a name='773'>
      iseedarr(1:how_many)=iseed<a name='774'>
<a name='775'>
     END subroutine UPDATE_STOCH<a name='776'>
<font color=#447700>!     ------------------------------------------------------------------<a name='777'></font>
<A NAME='UPDATE_STOCH_TEN'><A href='../../html_code/dyn_em/module_stoch.F.html#UPDATE_STOCH_TEN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='778'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>UPDATE_STOCH_TEN</font>(ru_tendf,rv_tendf,t_tendf, &amp; <A href='../../call_to/UPDATE_STOCH_TEN.html' TARGET='index'>1</A><a name='779'>
                       ru_tendf_stoch,rv_tendf_stoch,rt_tendf_stoch,&amp; <a name='780'>
                       mu,mub,c1h,c2h,                              &amp; <a name='781'>
                       ids, ide, jds, jde, kds, kde,                &amp;<a name='782'>
                       ims, ime, jms, jme, kms, kme,                &amp;<a name='783'>
                       its, ite, jts, jte, kts, kte,                &amp;<a name='784'>
                       kte_stoch,kme_stoch                          )<a name='785'>
<a name='786'>
       IMPLICIT NONE<a name='787'>
       INTEGER , INTENT(IN)        ::  ids, ide, jds, jde, kds, kde,   &amp;<a name='788'>
                                       ims, ime, jms, jme, kms, kme,   &amp;<a name='789'>
                                       its, ite, jts, jte, kts, kte,   &amp; <a name='790'>
                                       kte_stoch,kme_stoch<a name='791'>
<a name='792'>
       REAL , DIMENSION(ims:ime , kms:kme, jms:jme),INTENT(INOUT) :: &amp;<a name='793'>
                                       ru_tendf, rv_tendf, t_tendf<a name='794'>
<a name='795'>
       REAL , DIMENSION(ims:ime , kms:kme_stoch, jms:jme)           :: &amp;<a name='796'>
                      ru_tendf_stoch,rv_tendf_stoch,rt_tendf_stoch <a name='797'>
<a name='798'>
       REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: mu,mub<a name='799'>
       REAL , DIMENSION(kms:kme) , INTENT(IN) :: c1h,c2h<a name='800'>
<a name='801'>
       INTEGER :: I,J,K,kh<a name='802'>
       REAL  :: dt,xm<a name='803'>
<a name='804'>
   <a name='805'>
       DO j = jts,MIN(jde-1,jte)<a name='806'>
         DO k = kts,kte-1<a name='807'>
           kh=min(k,kte_stoch)<a name='808'>
           DO i = its,ite <a name='809'>
             ru_tendf(i,k,j) = ru_tendf(i,k,j) +  ru_tendf_stoch(i,kh,j)  * (mu(i,j)+mub(i,j)) <a name='810'>
           ENDDO<a name='811'>
         ENDDO<a name='812'>
       ENDDO<a name='813'>
<a name='814'>
       DO j = jts,jte<a name='815'>
         DO k = kts,kte-1<a name='816'>
           kh=min(k,kte_stoch)<a name='817'>
           DO i = its,MIN(ide-1,ite)<a name='818'>
             rv_tendf(i,k,j) = rv_tendf(i,k,j) +  rv_tendf_stoch(i,kh,j) *  (mu(i,j)+mub(i,j)) <a name='819'>
           ENDDO<a name='820'>
         ENDDO<a name='821'>
       ENDDO<a name='822'>
<a name='823'>
       DO j = jts,MIN(jde-1,jte)<a name='824'>
         DO k = kts,kte-1<a name='825'>
           kh=min(k,kte_stoch)<a name='826'>
           DO i = its,MIN(ide-1,ite)<a name='827'>
             t_tendf(i,k,j) = t_tendf(i,k,j) + rt_tendf_stoch(i,kh,j) * (mu(i,j)+mub(i,j))<a name='828'>
           ENDDO<a name='829'>
         ENDDO<a name='830'>
       ENDDO<a name='831'>
<a name='832'>
       END SUBROUTINE UPDATE_STOCH_TEN<a name='833'>
<font color=#447700>!     ------------------------------------------------------------------<a name='834'></font>
<font color=#447700>!!************** PERTURB PHYSICS TENDENCIES (except T) FOR SPPT *******************<a name='835'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='836'></font>
<A NAME='PERTURB_PHYSICS_TEND'><A href='../../html_code/dyn_em/module_stoch.F.html#PERTURB_PHYSICS_TEND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='837'>
      <font color=#993300>subroutine </font><font color=#cc0000>perturb_physics_tend</font>(gridpt_stddev_sppt,               &amp;  <A href='../../call_to/PERTURB_PHYSICS_TEND.html' TARGET='index'>1</A><a name='838'>
                       sppt_thresh_fact,rstoch,                         &amp; <a name='839'>
                       ru_tendf,rv_tendf,t_tendf,moist_tend,            &amp;<a name='840'>
                       ids, ide, jds, jde, kds, kde,                    &amp;<a name='841'>
                       ims, ime, jms, jme, kms, kme,                    &amp;<a name='842'>
                       its, ite, jts, jte, kts, kte,                    &amp; <a name='843'>
                       kte_stoch,kme_stoch                               )<a name='844'>
<a name='845'>
<font color=#447700>!      This subroutine add stochastic perturbations of the form <a name='846'></font>
<font color=#447700>!<a name='847'></font>
<font color=#447700>!                  rx_tendf(i,k,j)      = rx_tendf(i,k,j)*(1.0 + rstoch(i,k,j))<a name='848'></font>
<font color=#447700>!<a name='849'></font>
<font color=#447700>!       to the tendencies of  U, V, and Q. <a name='850'></font>
<font color=#447700>!       Since the temperature perturbations do not include the micro-physics<a name='851'></font>
<font color=#447700>!       tendencies at this point, the stochastic tendency perturbations to <a name='852'></font>
<font color=#447700>!       temperature are added in subroutine rk_addtend_dry of module module_em.F<a name='853'></font>
<a name='854'>
       IMPLICIT NONE<a name='855'>
       INTEGER , INTENT(IN)        ::  ids, ide, jds, jde, kds, kde,   &amp;<a name='856'>
                                       ims, ime, jms, jme, kms, kme,   &amp;<a name='857'>
                                       its, ite, jts, jte, kts, kte,   &amp; <a name='858'>
                                       kte_stoch,kme_stoch<a name='859'>
<a name='860'>
       REAL , DIMENSION(ims:ime , kms:kme, jms:jme),INTENT(INOUT) ::   &amp;<a name='861'>
                                        ru_tendf, rv_tendf, t_tendf,moist_tend<a name='862'>
       REAL , DIMENSION(ims:ime,kms:kme_stoch, jms:jme),INTENT(INOUT) :: rstoch<a name='863'>
       REAL :: gridpt_stddev_sppt ,thresh,sppt_thresh_fact<a name='864'>
<a name='865'>
       INTEGER :: I,J,K,kh<a name='866'>
<a name='867'>
<font color=#447700>! Here the random process at each gridpoint is capped if it exceeds a value thresh <a name='868'></font>
<a name='869'>
       thresh=sppt_thresh_fact*gridpt_stddev_sppt<a name='870'>
       DO j = jts,jte<a name='871'>
         DO k = kts,min(kte-1,kte_stoch-1)<a name='872'>
           DO i = its,ite <a name='873'>
<font color=#447700>!                rstoch(i,k,j)=MAX(MIN(rstoch(i,k,j),thresh),-1.*thresh))<a name='874'></font>
             if (rstoch(i,k,j).lt.-thresh) then<a name='875'>
                 rstoch(i,k,j)=-thresh<a name='876'>
             endif<a name='877'>
             if (rstoch(i,k,j).gt.thresh) then<a name='878'>
                 rstoch(i,k,j)=thresh<a name='879'>
             endif<a name='880'>
           ENDDO<a name='881'>
         ENDDO<a name='882'>
       ENDDO<a name='883'>
<a name='884'>
<font color=#447700>! Perturb the tendencies of u,v,q,t.<a name='885'></font>
       DO j = jts,MIN(jde-1,jte)<a name='886'>
         DO k = kts,kte-1<a name='887'>
         kh = min( k, kte_stoch-1 ) <a name='888'>
           DO i = its,ite <a name='889'>
              ru_tendf(i,k,j)      = ru_tendf(i,k,j)*(1.0 + rstoch(i,kh,j))<a name='890'>
           ENDDO<a name='891'>
         ENDDO<a name='892'>
       ENDDO<a name='893'>
<a name='894'>
       DO j = jts,jte<a name='895'>
         DO k = kts,kte-1<a name='896'>
         kh = min( k, kte_stoch-1 ) <a name='897'>
            DO i = its,MIN(ide-1,ite)<a name='898'>
              rv_tendf(i,k,j)      = rv_tendf(i,k,j)*(1.0 + rstoch(i,kh,j))<a name='899'>
           ENDDO<a name='900'>
         ENDDO<a name='901'>
       ENDDO<a name='902'>
<a name='903'>
       DO j = jts,MIN(jde-1,jte)<a name='904'>
         DO k = kts,kte-1<a name='905'>
         kh = min( k, kte_stoch-1 ) <a name='906'>
           DO i = its,MIN(ide-1,ite)<a name='907'>
              moist_tend(i,k,j)    = moist_tend(i,k,j)*(1.0 + rstoch(i,kh,j))<a name='908'>
              t_tendf   (i,k,j)    =    t_tendf(i,k,j)*(1.0 + rstoch(i,kh,j))<a name='909'>
           ENDDO<a name='910'>
         ENDDO<a name='911'>
       ENDDO<a name='912'>
<a name='913'>
      end subroutine perturb_physics_tend<a name='914'>
<a name='915'>
<font color=#447700>!     ------------------------------------------------------------------<a name='916'></font>
<font color=#447700>!!************** UPDATE SPECTRAL PATTERN AND TRANFORM GRIDPOINT SPACE***<a name='917'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='918'></font>
<font color=#447700>! This subroutine evolves the spectral pattern and transforms it back to gridpoint space.<a name='919'></font>
<a name='920'>
<a name='921'>
<A NAME='RAND_PERT_UPDATE'><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='922'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>RAND_PERT_UPDATE</font>       (grid, variable_in,                   &amp; <A href='../../call_to/RAND_PERT_UPDATE.html' TARGET='index'>9</A>,<A href='../../call_from/RAND_PERT_UPDATE.html' TARGET='index'>7</A><a name='923'>
                          SPFORCS,SPFORCC,SP_AMP,ALPH_RAND,                   &amp;<a name='924'>
                          ips, ipe, jps, jpe, kps, kpe,                       &amp;<a name='925'>
                          ids, ide, jds, jde, kds, kde,                       &amp;<a name='926'>
                          ims, ime, jms, jme, kms, kme,                       &amp;<a name='927'>
                          kts, kte,                                           &amp;<a name='928'>
                          imsx,imex,jmsx,jmex,kmsx,kmex,                      &amp;<a name='929'>
                          ipsx,ipex,jpsx,jpex,kpsx,kpex,                      &amp;<a name='930'>
                          imsy,imey,jmsy,jmey,kmsy,kmey,                      &amp;<a name='931'>
                          ipsy,ipey,jpsy,jpey,kpsy,kpey,                      &amp;<a name='932'>
                          kpe_stoch,kde_stoch,kme_stoch,kte_stoch,            &amp;<a name='933'>
                          restart,iseedarr,                                   &amp;<a name='934'>
                          DX,DY,skebs_vertstruc,                          &amp;<a name='935'>
                          RAND_PERT,thresh_fact,gridpt_stddev,                &amp;<a name='936'>
                          VERTSTRUCC,VERTSTRUCS,VERTAMP                       )<a name='937'>
<a name='938'>
<a name='939'>
<a name='940'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_16">, ONLY : domain<a name='941'>
#ifdef DM_PARALLEL<a name='942'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_13">, ONLY : local_communicator, mytask, ntasks, ntasks_x, ntasks_y, local_communicator_periodic, &amp;<a name='943'>
                          wrf_dm_maxval, wrf_err_message, local_communicator_x, local_communicator_y, data_order_xzy<a name='944'>
#endif<a name='945'>
<a name='946'>
<a name='947'>
      IMPLICIT NONE<a name='948'>
<a name='949'>
      TYPE ( domain ), INTENT(INOUT) :: grid<a name='950'>
<a name='951'>
 <a name='952'>
      INTEGER , INTENT(IN)     ::               ids, ide, jds, jde, kds, kde,   &amp;<a name='953'>
                                                ims, ime, jms, jme, kms, kme,   &amp;<a name='954'>
                                                ips, ipe, jps, jpe, kps, kpe,   &amp; <a name='955'>
                                                kts, kte                       <a name='956'>
      INTEGER , INTENT(IN)     ::               imsx,imex,jmsx,jmex,kmsx,kmex, &amp;<a name='957'>
                                                ipsx,ipex,jpsx,jpex,kpsx,kpex, &amp;<a name='958'>
                                                imsy,imey,jmsy,jmey,kmsy,kmey, &amp;<a name='959'>
                                                ipsy,ipey,jpsy,jpey,kpsy,kpey<a name='960'>
      INTEGER                  ::               kpe_stoch,kde_stoch,kme_stoch,kte_stoch <a name='961'>
<a name='962'>
      REAL    , INTENT(IN)     ::               ALPH_RAND,dx,dy,thresh_fact,gridpt_stddev<a name='963'>
      INTEGER , INTENT(IN)     ::               skebs_vertstruc<a name='964'>
      CHARACTER, INTENT(IN)    ::               variable_in <font color=#447700>! T, U, V                <a name='965'></font>
                                               <font color=#447700>! T          ! random field, T<a name='966'></font>
                                               <font color=#447700>! U          ! first derivative of streamfunction with regard to y; for skebs: U<a name='967'></font>
                                               <font color=#447700>! V          ! first derivative of streamfunction with regard to x; for skebs: V<a name='968'></font>
<a name='969'>
      INTEGER, DIMENSION (kms:kme),             INTENT(INOUT) :: iseedarr<a name='970'>
      REAL, DIMENSION(ims:ime,kms:kme, jms:jme),INTENT(IN)    :: VERTSTRUCC,VERTSTRUCS<a name='971'>
      REAL, DIMENSION(ims:ime,jms:jme)         ,INTENT(INOUT) :: SPFORCS,SPFORCC,SP_AMP<a name='972'>
      REAL, DIMENSION(kms:kme )                ,INTENT(IN)    :: VERTAMP<a name='973'>
      REAL, DIMENSION(ims:ime,kms:kme_stoch, jms:jme)         :: RAND_PERT  <a name='974'>
      REAL                     ::               RY,RX<a name='975'>
<a name='976'>
<a name='977'>
<font color=#447700>! Local Variabels <a name='978'></font>
      INTEGER                  ::               IK,IL,ILEV,NLON,NLAT,IJ,I,J,K<a name='979'>
      INTEGER                  ::               gridsp32y,gridsm32y,gridsp32x,gridsm32x,gridsp32 ,gridsm32<a name='980'>
      INTEGER                  ::               gridep32y,gridem32y,gridep32x,gridem32x,gridep32 ,gridem32<a name='981'>
      REAL                     ::               thresh<a name='982'>
<a name='983'>
      REAL, DIMENSION(ims:ime,kms:kme_stoch, jms:jme)         :: RAND_REAL, RAND_IMAG<a name='984'>
      LOGICAL :: RESTART<a name='985'>
      CHARACTER  :: variable<a name='986'>
<a name='987'>
      variable = variable_in<a name='988'>
<a name='989'>
      NLAT=(jde-jds)+1 <font color=#447700>!KMAX<a name='990'></font>
      NLON=(ide-ids)+1 <font color=#447700>!LMAX<a name='991'></font>
      RY=  NLAT*DY<a name='992'>
      RX=  NLON*DX<a name='993'>
<a name='994'>
<font color=#447700>! Update the pattern generator by evolving each spectral coefficients as AR1<a name='995'></font>
<a name='996'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='997'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='998'></font>
       DO ij = 1 , grid%num_tiles<a name='999'>
             IF (variable .ne. 'V') THEN  <font color=#447700>!T, random field, U, don't update for V <a name='1000'></font>
              CALL <A href='../../html_code/dyn_em/module_stoch.F.html#UPDATE_STOCH'>UPDATE_STOCH</A><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_STOCH_1">( &amp;<a name='1001'>
                         SPFORCS,SPFORCC,SP_AMP,ALPH_RAND,                   &amp;<a name='1002'>
                         restart,iseedarr,                         &amp;<a name='1003'>
                         ids, ide, jds, jde, kds, kde,                       &amp;<a name='1004'>
                         ims, ime, jms, jme, kms, kme,                       &amp;<a name='1005'>
                         grid%i_start(ij), grid%i_end(ij), grid%j_start(ij), grid%j_end(ij), kts, kte                        )      <a name='1006'>
             endif<a name='1007'>
  <a name='1008'>
<font color=#447700>! Put spectral coefficients in arrays RAND_REAL,RAND_IMAG <a name='1009'></font>
<a name='1010'>
              IF (variable == 'T')   THEN  <font color=#447700>! T, rand <a name='1011'></font>
              DO IK=grid%j_start(ij), grid%j_end(ij)<a name='1012'>
               DO ILEV=kts,kte_stoch<a name='1013'>
                DO IL=grid%i_start(ij),grid%i_end(ij)<a name='1014'>
                       grid%RAND_REAL(IL,ILEV,IK)  = SPFORCC(IL,IK)<a name='1015'>
                       grid%RAND_IMAG(IL,ILEV,IK)  = SPFORCS(IL,IK)<a name='1016'>
                  ENDDO<a name='1017'>
                ENDDO<a name='1018'>
              ENDDO<a name='1019'>
<a name='1020'>
              ELSEIF (variable == 'U') THEN <font color=#447700>!U  <a name='1021'></font>
              DO IK=grid%j_start(ij), grid%j_end(ij)<a name='1022'>
               DO ILEV=kts,kte_stoch<a name='1023'>
                DO IL=grid%i_start(ij),grid%i_end(ij)<a name='1024'>
                       grid%RAND_REAL(IL,ILEV,IK)  =  2*RPI/RY*  wavenumber_k(IK) * SPFORCS(IL,IK)<a name='1025'>
                       grid%RAND_IMAG(IL,ILEV,IK)  = -2*RPI/RY*  wavenumber_k(IK) * SPFORCC(IL,IK)<a name='1026'>
                  ENDDO<a name='1027'>
                ENDDO<a name='1028'>
              ENDDO<a name='1029'>
<a name='1030'>
              ELSEIF (variable == 'V') THEN <font color=#447700>!V  <a name='1031'></font>
              DO IK=grid%j_start(ij), grid%j_end(ij)<a name='1032'>
               DO ILEV=kts,kte_stoch<a name='1033'>
                DO IL=grid%i_start(ij),grid%i_end(ij)<a name='1034'>
                       grid%RAND_REAL(IL,ILEV,IK)  = -2*RPI/RX*  wavenumber_l(IL) * SPFORCS(IL,IK)<a name='1035'>
                       grid%RAND_IMAG(IL,ILEV,IK)  =  2*RPI/RX*  wavenumber_l(IL) * SPFORCC(IL,IK)<a name='1036'>
                  ENDDO<a name='1037'>
                ENDDO<a name='1038'>
              ENDDO<a name='1039'>
              endif<a name='1040'>
<a name='1041'>
<a name='1042'>
<font color=#447700>! Apply vertical structure function<a name='1043'></font>
<a name='1044'>
           IF (skebs_vertstruc.ne.0) then<a name='1045'>
             DO ILEV=kts,kte_stoch<a name='1046'>
              DO IL=grid%i_start(ij),grid%i_end(ij)<a name='1047'>
                DO IK=grid%j_start(ij), grid%j_end(ij)<a name='1048'>
                  grid%RAND_REAL(IL,ILEV,IK)  = VERTAMP(ILEV) * &amp; <a name='1049'>
                       (grid%RAND_REAL(IL,ILEV,IK) * VERTSTRUCC(IL,ILEV,IK) - grid%RAND_IMAG(IL,ILEV,IK) * VERTSTRUCS(IL,ILEV,IK))<a name='1050'>
                  grid%RAND_IMAG(IL,ILEV,IK)  = VERTAMP(ILEV) * &amp; <a name='1051'>
                       (grid%RAND_REAL(IL,ILEV,IK) * VERTSTRUCS(IL,ILEV,IK) + grid%RAND_IMAG(IL,ILEV,IK) * VERTSTRUCC(IL,ILEV,IK))<a name='1052'>
                ENDDO<a name='1053'>
             ENDDO<a name='1054'>
           ENDDO<a name='1055'>
           ENDIF<a name='1056'>
        ENDDO<a name='1057'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1058'></font>
<a name='1059'>
<font color=#447700>! Transform spectral pattern to gridpoint space <a name='1060'></font>
          <a name='1061'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1062'></font>
<a name='1063'>
<font color=#447700>! Roll out into latitude bands and perform FFT along latitude bands<a name='1064'></font>
<a name='1065'>
<font color=#447700>! Save a copy of the indices as we might need them to change when<a name='1066'></font>
<font color=#447700>! doing the "thin" 3d arrays (where the "k" dimension is unity).<a name='1067'></font>
<font color=#447700>! These are the original Z-transposed and X-transposed k-dimensions.<a name='1068'></font>
<a name='1069'>
        gridsp32x=grid%sp32x<a name='1070'>
        gridsm32x=grid%sm32x<a name='1071'>
        gridep32x=grid%ep32x<a name='1072'>
        gridem32x=grid%em32x<a name='1073'>
        gridsp32 =grid%sp32<a name='1074'>
        gridsm32 =grid%sm32<a name='1075'>
        gridep32 =grid%ep32<a name='1076'>
        gridem32 =grid%em32<a name='1077'>
<a name='1078'>
<font color=#447700>! Set number of vertical levels to which ever is smaller: the full number<a name='1079'></font>
<font color=#447700>! of vertical levels, or the number of levels to be transformed into <a name='1080'></font>
<font color=#447700>! gridpoint space.<a name='1081'></font>
<a name='1082'>
        grid%sp32x=min(kpsx,grid%num_stoch_levels)<a name='1083'>
        grid%sm32x=min(kmsx,grid%num_stoch_levels)<a name='1084'>
        grid%ep32x=min(kpex,grid%num_stoch_levels)<a name='1085'>
        grid%em32x=min(kmex,grid%num_stoch_levels)<a name='1086'>
        grid%sp32 =min(kps ,grid%num_stoch_levels)<a name='1087'>
        grid%sm32 =min(kms ,grid%num_stoch_levels)<a name='1088'>
        grid%ep32 =min(kpe ,grid%num_stoch_levels)<a name='1089'>
        grid%em32 =min(kme ,grid%num_stoch_levels)<a name='1090'>
<a name='1091'>
#include "<A href='../../html_code/include/XPOSE_RAND_REAL_z2x.inc.html'>XPOSE_RAND_REAL_z2x.inc</A>"<A NAME="XPOSE_RAND_REAL_z2x.inc_1"><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1092'>
#include "<A href='../../html_code/include/XPOSE_RAND_IMAG_z2x.inc.html'>XPOSE_RAND_IMAG_z2x.inc</A>"<A NAME="XPOSE_RAND_IMAG_z2x.inc_2"><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1093'>
        call <A href='../../html_code/dyn_em/module_stoch.F.html#DO_FFTBACK_ALONG_X'>do_fftback_along_x</A><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DO_FFTBACK_ALONG_X_1">(grid%RAND_REAL_xxx,grid%RAND_IMAG_xxx,                  &amp;<a name='1094'>
                              ids,ide,jds,jde,                                          &amp; <a name='1095'>
                              imsx,imex,jmsx,jmex,kmsx,min(kmex,grid%num_stoch_levels), &amp; <a name='1096'>
                              ipsx,ipex,jpsx,jpex,kpsx,min(kpex,grid%num_stoch_levels))  <a name='1097'>
#include "<A href='../../html_code/include/XPOSE_RAND_REAL_x2z.inc.html'>XPOSE_RAND_REAL_x2z.inc</A>"<A NAME="XPOSE_RAND_REAL_x2z.inc_3"><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1098'>
#include "<A href='../../html_code/include/XPOSE_RAND_IMAG_x2z.inc.html'>XPOSE_RAND_IMAG_x2z.inc</A>"<A NAME="XPOSE_RAND_IMAG_x2z.inc_4"><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1099'>
<a name='1100'>
<font color=#447700>! Roll out into longitude bands and perform FFT along longitude bands<a name='1101'></font>
<a name='1102'>
<font color=#447700>! Save a copy of the indices as we might need them to change when<a name='1103'></font>
<font color=#447700>! doing the "thin" 3d arrays (where the "k" dimension is unity).<a name='1104'></font>
<font color=#447700>! These are the original Y-transposed k-dimensions.<a name='1105'></font>
<a name='1106'>
        gridsp32y=grid%sp32y<a name='1107'>
        gridsm32y=grid%sm32y<a name='1108'>
        gridep32y=grid%ep32y<a name='1109'>
        gridem32y=grid%em32y<a name='1110'>
<a name='1111'>
<font color=#447700>! Again, set number of vertical levels to the min of the number of levels and the<a name='1112'></font>
<font color=#447700>! number of stochastic levels.<a name='1113'></font>
<a name='1114'>
        grid%sp32y=min(kpsy,grid%num_stoch_levels)<a name='1115'>
        grid%sm32y=min(kmsy,grid%num_stoch_levels)<a name='1116'>
        grid%ep32y=min(kpey,grid%num_stoch_levels)<a name='1117'>
        grid%em32y=min(kmey,grid%num_stoch_levels)<a name='1118'>
<a name='1119'>
#include "<A href='../../html_code/include/XPOSE_RAND_REAL_z2y.inc.html'>XPOSE_RAND_REAL_z2y.inc</A>"<A NAME="XPOSE_RAND_REAL_z2y.inc_5"><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1120'>
#include "<A href='../../html_code/include/XPOSE_RAND_IMAG_z2y.inc.html'>XPOSE_RAND_IMAG_z2y.inc</A>"<A NAME="XPOSE_RAND_IMAG_z2y.inc_6"><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1121'>
        call <A href='../../html_code/dyn_em/module_stoch.F.html#DO_FFTBACK_ALONG_Y'>do_fftback_along_y</A><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DO_FFTBACK_ALONG_Y_1">(grid%RAND_REAL_yyy,grid%RAND_IMAG_yyy,                  &amp;<a name='1122'>
                              ids,ide,jds,jde,                                          &amp; <a name='1123'>
                              imsy,imey,jmsy,jmey,kmsy,min(kmey,grid%num_stoch_levels), &amp; <a name='1124'>
                              ipsy,ipey,jpsy,jpey,kpsy,min(kpey,grid%num_stoch_levels))<a name='1125'>
#include "<A href='../../html_code/include/XPOSE_RAND_REAL_y2z.inc.html'>XPOSE_RAND_REAL_y2z.inc</A>"<A NAME="XPOSE_RAND_REAL_y2z.inc_7"><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1126'>
#include "<A href='../../html_code/include/XPOSE_RAND_IMAG_y2z.inc.html'>XPOSE_RAND_IMAG_y2z.inc</A>"<A NAME="XPOSE_RAND_IMAG_y2z.inc_8"><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1127'>
<a name='1128'>
<font color=#447700>! Put the original vertical "k" dimensions back.<a name='1129'></font>
<a name='1130'>
        grid%sp32x=gridsp32x<a name='1131'>
        grid%sm32x=gridsm32x<a name='1132'>
        grid%ep32x=gridep32x<a name='1133'>
        grid%em32x=gridem32x<a name='1134'>
        grid%sp32y=gridsp32y<a name='1135'>
        grid%sm32y=gridsm32y<a name='1136'>
        grid%ep32y=gridep32y<a name='1137'>
        grid%em32y=gridem32y<a name='1138'>
        grid%sp32 =gridsp32<a name='1139'>
        grid%sm32 =gridsm32<a name='1140'>
        grid%ep32 =gridep32<a name='1141'>
        grid%em32 =gridem32<a name='1142'>
<a name='1143'>
#else<a name='1144'>
        call <A href='../../html_code/dyn_em/module_stoch.F.html#DO_FFTBACK_ALONG_X'>do_fftback_along_x</A><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DO_FFTBACK_ALONG_X_2">(grid%RAND_REAL,grid%RAND_IMAG,                          &amp;<a name='1145'>
                              ids,ide,jds,jde,                                          &amp; <a name='1146'>
                              ims,ime,jms,jme,kms,min(kme,grid%num_stoch_levels),       &amp; <a name='1147'>
                              ips,ipe,jps,jpe,kps,min(kpe,grid%num_stoch_levels))   <a name='1148'>
        call <A href='../../html_code/dyn_em/module_stoch.F.html#DO_FFTBACK_ALONG_Y'>do_fftback_along_y</A><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_PERT_UPDATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DO_FFTBACK_ALONG_Y_2">(grid%RAND_REAL,grid%RAND_IMAG,                          &amp; <a name='1149'>
                              ids,ide,jds,jde,                                          &amp; <a name='1150'>
                              ims,ime,jms,jme,kms,min(kme,grid%num_stoch_levels),       &amp; <a name='1151'>
                              ips,ipe,jps,jpe,kps,min(kpe,grid%num_stoch_levels))<a name='1152'>
#endif<a name='1153'>
<a name='1154'>
<a name='1155'>
      thresh=thresh_fact*gridpt_stddev<a name='1156'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1157'></font>
      <font color=#447700>!$OMP PRIVATE ( ij )<a name='1158'></font>
        DO ij = 1 , grid%num_tiles<a name='1159'>
               DO k=kts,min(kte,grid%num_stoch_levels)<a name='1160'>
                 DO I=grid%i_start(ij), grid%i_end(ij)<a name='1161'>
                   DO j=grid%j_start(ij), grid%j_end(ij)<a name='1162'>
                     RAND_PERT(I,K,J)=grid%RAND_REAL(I,K,J) <a name='1163'>
                     RAND_PERT(I,K,J)=MAX(MIN(grid%RAND_REAL(I,K,J),thresh),-1.0*thresh)<a name='1164'>
                   ENDDO<a name='1165'>
                 ENDDO<a name='1166'>
                ENDDO<a name='1167'>
        ENDDO<a name='1168'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1169'></font>
<a name='1170'>
<a name='1171'>
       END SUBROUTINE RAND_PERT_UPDATE<a name='1172'>
<a name='1173'>
<font color=#447700>!     ------------------------------------------------------------------<a name='1174'></font>
<font color=#447700>!!************** SUBROUTINE DO_FFTBACK_ALONG_X<a name='1175'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='1176'></font>
<A NAME='DO_FFTBACK_ALONG_X'><A href='../../html_code/dyn_em/module_stoch.F.html#DO_FFTBACK_ALONG_X' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1177'>
       <font color=#993300>subroutine </font><font color=#cc0000>do_fftback_along_x</font>(                            &amp;  <A href='../../call_to/DO_FFTBACK_ALONG_X.html' TARGET='index'>2</A>,<A href='../../call_from/DO_FFTBACK_ALONG_X.html' TARGET='index'>1</A><a name='1178'>
                               fieldc,fields,                    &amp;<a name='1179'>
                               ids,ide,jds,jde,                  &amp; <a name='1180'>
                               imsx,imex,jmsx,jmex,kmsx,kmex,    &amp;<a name='1181'>
                               ipsx,ipex,jpsx,jpex,kpsx,kpex     ) <a name='1182'>
       IMPLICIT NONE<a name='1183'>
 <a name='1184'>
       INTEGER, INTENT(IN):: imsx,imex,jmsx,jmex,kmsx,kmex,    &amp;<a name='1185'>
                             ipsx,ipex,jpsx,jpex,kpsx,kpex,    &amp; <a name='1186'>
                             ids,ide,jds,jde<a name='1187'>
<a name='1188'>
  <a name='1189'>
       REAL, DIMENSION    (imsx:imex, kmsx:kmex, jmsx:jmex) :: fieldc,fields<a name='1190'>
<a name='1191'>
       COMPLEX, DIMENSION (ipsx:ipex)            :: dummy_complex<a name='1192'>
       INTEGER                                   :: IER,LENWRK,KMAX,LMAX,I,J,K<a name='1193'>
       REAL, ALLOCATABLE                         :: WORK(:)<a name='1194'>
<a name='1195'>
       CHARACTER (LEN=160) :: mess<a name='1196'>
<a name='1197'>
<a name='1198'>
       KMAX=(jde-jds)+1<a name='1199'>
       LMAX=(ide-ids)+1<a name='1200'>
<a name='1201'>
       LENWRK=2*KMAX*LMAX<a name='1202'>
       ALLOCATE(WORK(LENWRK))<a name='1203'>
       LENSAV= 4*(KMAX+LMAX)+INT(LOG(REAL(KMAX))) + INT(LOG(REAL(LMAX))) + 8<a name='1204'>
<a name='1205'>
       DO k=kpsx,kpex <a name='1206'>
         DO j = jpsx, jpex<a name='1207'>
           DO i = ipsx, ipex<a name='1208'>
             dummy_complex(i)=cmplx(fieldc(i,k,j),fields(i,k,j))<a name='1209'>
           ENDDO<a name='1210'>
           CALL cFFT1B (LMAX, 1 ,dummy_complex,LMAX, WSAVE1, LENSAV, WORK, LENWRK, IER)<a name='1211'>
           if (ier.ne.0) then <a name='1212'>
              WRITE(mess,FMT='(A)') 'error in cFFT1B in do_fftback_along_x, field U'<a name='1213'>
              CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/module_stoch.F.html#DO_FFTBACK_ALONG_X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_19">(0,mess)<a name='1214'>
           end if<a name='1215'>
           DO i = ipsx, ipex<a name='1216'>
             fieldc(i,k,j)=real(dummy_complex(i))<a name='1217'>
             fields(i,k,j)=imag(dummy_complex(i))<a name='1218'>
           END DO<a name='1219'>
         END DO<a name='1220'>
       END DO<a name='1221'>
<a name='1222'>
       DEALLOCATE(WORK)<a name='1223'>
       end subroutine do_fftback_along_x<a name='1224'>
<a name='1225'>
<font color=#447700>!!     ------------------------------------------------------------------<a name='1226'></font>
<font color=#447700>!!!************** SUBROUTINE DO_FFTBACK_ALONG_Y<a name='1227'></font>
<font color=#447700>!!     ------------------------------------------------------------------<a name='1228'></font>
<A NAME='DO_FFTBACK_ALONG_Y'><A href='../../html_code/dyn_em/module_stoch.F.html#DO_FFTBACK_ALONG_Y' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1229'>
       <font color=#993300>subroutine </font><font color=#cc0000>do_fftback_along_y</font>(                            &amp; <A href='../../call_to/DO_FFTBACK_ALONG_Y.html' TARGET='index'>2</A>,<A href='../../call_from/DO_FFTBACK_ALONG_Y.html' TARGET='index'>1</A><a name='1230'>
                               fieldc,fields,                    &amp;<a name='1231'>
                               ids,ide,jds,jde,                  &amp; <a name='1232'>
                               imsy,imey,jmsy,jmey,kmsy,kmey,    &amp;<a name='1233'>
                               ipsy,ipey,jpsy,jpey,kpsy,kpey     )<a name='1234'>
       IMPLICIT NONE<a name='1235'>
 <a name='1236'>
       INTEGER :: IER,LENWRK,KMAX,LMAX,I,J,K,skebs_vertstruc<a name='1237'>
 <a name='1238'>
       INTEGER, INTENT(IN) :: imsy,imey,jmsy,jmey,kmsy,kmey,    &amp;<a name='1239'>
                              ipsy,ipey,jpsy,jpey,kpsy,kpey,    &amp; <a name='1240'>
                              ids,ide,jds,jde<a name='1241'>
  <a name='1242'>
       REAL, DIMENSION    (imsy:imey, kmsy:kmey, jmsy:jmey) :: fieldc,fields<a name='1243'>
<a name='1244'>
       COMPLEX, DIMENSION (jpsy:jpey)            :: dummy_complex<a name='1245'>
       REAL, ALLOCATABLE :: WORK(:)<a name='1246'>
<a name='1247'>
       CHARACTER (LEN=160) :: mess<a name='1248'>
<a name='1249'>
       KMAX=(jde-jds)+1<a name='1250'>
       LMAX=(ide-ids)+1<a name='1251'>
       LENWRK=2*KMAX*LMAX<a name='1252'>
       ALLOCATE(WORK(LENWRK))<a name='1253'>
       LENSAV= 4*(KMAX+LMAX)+INT(LOG(REAL(KMAX))) + INT(LOG(REAL(LMAX))) + 8<a name='1254'>
<a name='1255'>
<a name='1256'>
<a name='1257'>
        DO k=kpsy,kpey<a name='1258'>
          DO i = ipsy, ipey<a name='1259'>
            DO j = jpsy,jpey<a name='1260'>
            dummy_complex(j)=cmplx(fieldc(i,k,j),fields(i,k,j))<a name='1261'>
            ENDDO<a name='1262'>
            CALL cFFT1B (KMAX, 1 ,dummy_complex,KMAX, WSAVE2, LENSAV, WORK, LENWRK, IER)<a name='1263'>
            if (ier.ne.0) then <a name='1264'>
               WRITE(mess,FMT='(A)') 'error in cFFT1B in do_fftback_along_y, field U'<a name='1265'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/module_stoch.F.html#DO_FFTBACK_ALONG_Y' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_20">(0,mess)<a name='1266'>
            end if<a name='1267'>
            DO j = jpsy, jpey<a name='1268'>
            fieldc(i,k,j)=real(dummy_complex(j))<a name='1269'>
            fields(i,k,j)=imag(dummy_complex(j))<a name='1270'>
            END DO<a name='1271'>
          END DO<a name='1272'>
        END DO <font color=#447700>! k_start-k_end<a name='1273'></font>
<a name='1274'>
     <a name='1275'>
       DEALLOCATE(WORK)<a name='1276'>
       end subroutine do_fftback_along_y<a name='1277'>
<font color=#447700>!     ------------------------------------------------------------------<a name='1278'></font>
<font color=#447700>!!************** TRANSFORM FROM GRIDPOILT SPACE TO SPHERICAL HARMONICS **<a name='1279'></font>
<font color=#447700>!     ------------------------------------------------------------------<a name='1280'></font>
<A NAME='FINDINDEX'><A href='../../html_code/dyn_em/module_stoch.F.html#FINDINDEX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1281'>
      <font color=#993300>subroutine </font><font color=#cc0000>findindex</font>( wavenumber_k, wavenumber_L,             &amp;  <A href='../../call_to/FINDINDEX.html' TARGET='index'>3</A><a name='1282'>
                       ids, ide, jds, jde, kds, kde,                &amp;<a name='1283'>
                       ims, ime, jms, jme, kms, kme,                &amp;<a name='1284'>
                       its, ite, jts, jte, kts, kte                 )<a name='1285'>
<a name='1286'>
      IMPLICIT NONE<a name='1287'>
      INTEGER :: IK,IL,KMAX,LMAX<a name='1288'>
      INTEGER, DIMENSION (jds:jde)::  wavenumber_k<a name='1289'>
      INTEGER, DIMENSION (ids:ide)::  wavenumber_l<a name='1290'>
      INTEGER , INTENT(IN)     ::  ids, ide, jds, jde, kds, kde,   &amp;<a name='1291'>
                                   ims, ime, jms, jme, kms, kme,   &amp;<a name='1292'>
                                   its, ite, jts, jte, kts, kte<a name='1293'>
      KMAX=(jde-jds)+1 <a name='1294'>
      LMAX=(ide-ids)+1 <a name='1295'>
<a name='1296'>
      <font color=#447700>!map wave numbers K,L to indeces IK, IL<a name='1297'></font>
      DO IK=1,KMAX/2+1 <a name='1298'>
        wavenumber_k(IK)=IK-1 <a name='1299'>
      ENDDO<a name='1300'>
      DO IK=KMAX,KMAX/2+2,-1<a name='1301'>
        wavenumber_k(IK)=IK-KMAX-1 <a name='1302'>
      ENDDO<a name='1303'>
      DO IL=1,LMAX/2+1 <a name='1304'>
        wavenumber_l(IL)=IL-1<a name='1305'>
      ENDDO<a name='1306'>
      DO IL=LMAX,LMAX/2+2,-1<a name='1307'>
        wavenumber_l(IL)=IL-LMAX-1 <a name='1308'>
      ENDDO<a name='1309'>
<a name='1310'>
      END subroutine findindex<a name='1311'>
       <a name='1312'>
<font color=#447700>!     ------------------------------------------------------------------<a name='1313'></font>
<A NAME='GAUSS_NOISE'><A href='../../html_code/dyn_em/module_stoch.F.html#GAUSS_NOISE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1314'>
     <font color=#993300>subroutine </font><font color=#cc0000>gauss_noise</font>(z) <A href='../../call_to/GAUSS_NOISE.html' TARGET='index'>2</A><a name='1315'>
      real :: z                    <font color=#447700>! output<a name='1316'></font>
      real :: x,y,r, coeff         <font color=#447700>! INPUT<a name='1317'></font>
<a name='1318'>
<font color=#447700>!  [2.1] Get two uniform variate random numbers IL range 0 to 1:<a name='1319'></font>
<a name='1320'>
      do<a name='1321'>
<a name='1322'>
      call random_number( x )<a name='1323'>
      call random_number( y )<a name='1324'>
<a name='1325'>
<font color=#447700>!     [2.2] Transform to range -1 to 1 and calculate sum of squares:<a name='1326'></font>
<a name='1327'>
      x = 2.0 * x - 1.0<a name='1328'>
      y = 2.0 * y - 1.0<a name='1329'>
      r = x * x + y * y<a name='1330'>
<a name='1331'>
      if ( r &gt; 0.0 .and. r &lt; 1.0 ) exit<a name='1332'>
<a name='1333'>
      end do<a name='1334'>
<font color=#447700>!<a name='1335'></font>
<font color=#447700>!  [2.3] Use Box-Muller transformation to get normal deviates:<a name='1336'></font>
<a name='1337'>
      coeff = sqrt( -2.0 * log(r) / r )<a name='1338'>
      z = coeff * x<a name='1339'>
<a name='1340'>
     end subroutine gauss_noise<a name='1341'>
<font color=#447700>!     ------------------------------------------------------------------<a name='1342'></font>
<A NAME='RAND_SEED'><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_SEED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1343'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>rand_seed</font> (config_flags, iseed1, iseedarr, kms, kme) <A href='../../call_to/RAND_SEED.html' TARGET='index'>6</A>,<A href='../../call_from/RAND_SEED.html' TARGET='index'>1</A><a name='1344'>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_stoch.F.html#RAND_SEED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_15"><a name='1345'>
     IMPLICIT NONE<a name='1346'>
<font color=#447700>!<a name='1347'></font>
<font color=#447700>!  Structure that contains run-time configuration (namelist) data for domain<a name='1348'></font>
      TYPE (grid_config_rec_type)                       :: config_flags<a name='1349'>
<font color=#447700>!<a name='1350'></font>
<font color=#447700>! Arguments<a name='1351'></font>
     INTEGER             :: kms, kme, iseed1 <a name='1352'>
     INTEGER, DIMENSION (kms:kme), INTENT(OUT)           :: iseedarr<a name='1353'>
<a name='1354'>
<font color=#447700>! Local<a name='1355'></font>
      integer*8          :: fctime, one_big<a name='1356'>
      integer            :: i <a name='1357'>
<a name='1358'>
      fctime = config_flags%start_year * ( config_flags%start_month*100+config_flags%start_day) + config_flags%start_hour<a name='1359'>
<a name='1360'>
      one_big = 1<a name='1361'>
      iseedarr=0.0<a name='1362'>
      do i = kms,kme-3,4<a name='1363'>
         iseedarr(i  )= iseed1+config_flags%nens*1000000<a name='1364'>
         iseedarr(i+1)= mod(fctime+iseed1*config_flags%nens*1000000,19211*one_big)<a name='1365'>
         iseedarr(i+2)= mod(fctime+iseed1*config_flags%nens*1000000,71209*one_big)<a name='1366'>
         iseedarr(i+3)= mod(fctime+iseed1*config_flags%nens*1000000,11279*one_big)<a name='1367'>
      enddo<a name='1368'>
<a name='1369'>
      end SUBROUTINE rand_seed<a name='1370'>
<font color=#447700>!     ------------------------------------------------------------------<a name='1371'></font>
      end module module_stoch<a name='1372'>
</pre></body></html>