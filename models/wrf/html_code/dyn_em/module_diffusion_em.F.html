<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( HYBRID_COORD==1 )<a name='2'>
#  define mu(...) (c1(k)*XXPCTXX(__VA_ARGS__)+c2(k))<a name='3'>
#  define XXPCTXX(...) mu(__VA_ARGS__)<a name='4'>
#endif<a name='5'>
<a name='6'>
<font color=#447700>! WRF:MODEL_LAYER:PHYSICS<a name='7'></font>
<a name='8'>
<A NAME='MODULE_DIFFUSION_EM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#MODULE_DIFFUSION_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='9'>
    <font color=#993300>MODULE </font><font color=#cc0000>module_diffusion_em</font> <A href='../../call_to/MODULE_DIFFUSION_EM.html' TARGET='index'>2</A><a name='10'>
<a name='11'>
    USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_5">, only: set_physical_bc3d<a name='12'>
    USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_5">, only: p_m23, p_m13, p_m22, p_m33, p_r23, p_r13, p_r12, p_m12, p_m11<a name='13'>
    USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_1">, only: grid_config_rec_type, param_first_scalar, p_qv, p_qi, p_qc<a name='14'>
    USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#module_diffusion_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_5"><a name='15'>
<a name='16'>
    CONTAINS<a name='17'>
<a name='18'>
<font color=#447700>!=======================================================================<a name='19'></font>
<font color=#447700>!=======================================================================<a name='20'></font>
<a name='21'>
<A NAME='CAL_DEFORM_AND_DIV'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_DEFORM_AND_DIV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='22'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_deform_and_div</font>( config_flags, u, v, w, div,       &amp; <A href='../../call_to/CAL_DEFORM_AND_DIV.html' TARGET='index'>1</A><a name='23'>
                                   defor11, defor22, defor33,        &amp;<a name='24'>
                                   defor12, defor13, defor23,        &amp;<a name='25'>
                                   nba_rij, n_nba_rij,               &amp;<a name='26'>
                                   u_base, v_base, msfux, msfuy,     &amp;<a name='27'>
                                   msfvx, msfvy, msftx, msfty,       &amp;<a name='28'>
                                   rdx, rdy, dn, dnw, rdz, rdzw,     &amp;<a name='29'>
                                   fnm, fnp, cf1, cf2, cf3, zx, zy,  &amp;<a name='30'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='31'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='32'>
                                   its, ite, jts, jte, kts, kte      )<a name='33'>
<a name='34'>
<font color=#447700>! History:     Sep 2003  Changes by Jason Knievel and George Bryan, NCAR<a name='35'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='36'></font>
<font color=#447700>!              ...        ...<a name='37'></font>
<a name='38'>
<font color=#447700>! Purpose:     This routine calculates deformation and 3-d divergence.<a name='39'></font>
<a name='40'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='41'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='42'></font>
<a name='43'>
<font color=#447700>!-----------------------------------------------------------------------<a name='44'></font>
<font color=#447700>! Comments 10-MAR-05<a name='45'></font>
<font color=#447700>! Equations 13a-f, Chen and Dudhia 2000, Appendix A:<a name='46'></font>
<font color=#447700>! Eqn 13a: D11=defor11= 2m^2 * (partial du^/dX + partial dpsi/dx * partial du^/dpsi)<a name='47'></font>
<font color=#447700>! Eqn 13b: D22=defor22= 2m^2 * (partial dv^/dY + partial dpsi/dy * partial dv^/dpsi)<a name='48'></font>
<font color=#447700>! Eqn 13c: D33=defor33= 2 * partial dw/dz [SIMPLER FORM]<a name='49'></font>
<font color=#447700>! Eqn 13d: D12=defor12= m^2 * (partial dv^/dX + partial du^/dY +<a name='50'></font>
<font color=#447700>!                              partial dpsi/dx * partial dv^/dpsi +<a name='51'></font>
<font color=#447700>!                              partial dpsi/dy * partial du^/dpsi)<a name='52'></font>
<font color=#447700>! Eqn 13e: D13=defor13= m^2 * (partial dw^/dX + partial dpsi/dx * partial dw^/dpsi)<a name='53'></font>
<font color=#447700>!                           + partial du/dz [SIMPLER FORM]<a name='54'></font>
<font color=#447700>! Eqn 13f: D23=defor23= m^2 * (partial dw^/dY + partial dpsi/dy * partial dw^/dpsi)<a name='55'></font>
<font color=#447700>!                           + partial dv/dz [SIMPLER FORM]<a name='56'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='57'></font>
<font color=#447700>! Begin declarations.<a name='58'></font>
<a name='59'>
    IMPLICIT NONE<a name='60'>
<a name='61'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='62'>
    :: config_flags<a name='63'>
<a name='64'>
    INTEGER, INTENT( IN )  &amp;<a name='65'>
    :: ids, ide, jds, jde, kds, kde, &amp;<a name='66'>
       ims, ime, jms, jme, kms, kme, &amp;<a name='67'>
       its, ite, jts, jte, kts, kte<a name='68'>
<a name='69'>
    REAL, INTENT( IN )  &amp;<a name='70'>
    :: rdx, rdy, cf1, cf2, cf3<a name='71'>
<a name='72'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='73'>
    :: fnm, fnp, dn, dnw, u_base, v_base<a name='74'>
<a name='75'>
    REAL, DIMENSION( ims:ime , jms:jme ),  INTENT( IN )  &amp;<a name='76'>
    :: msfux, msfuy, msfvx, msfvy, msftx, msfty<a name='77'>
<a name='78'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='79'>
    ::  u, v, w, zx, zy, rdz, rdzw<a name='80'>
<a name='81'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='82'>
    :: defor11, defor22, defor33, defor12, defor13, defor23, div<a name='83'>
<a name='84'>
   INTEGER, INTENT(  IN ) :: n_nba_rij<a name='85'>
<a name='86'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_rij), INTENT(INOUT) &amp;<a name='87'>
   :: nba_rij<a name='88'>
<a name='89'>
<a name='90'>
<font color=#447700>! Local variables.<a name='91'></font>
<a name='92'>
    INTEGER  &amp;<a name='93'>
    :: i, j, k, ktf, ktes1, ktes2, i_start, i_end, j_start, j_end<a name='94'>
<a name='95'>
    REAL  &amp;<a name='96'>
    :: tmp, tmpzx, tmpzy, tmpzeta_z, cft1, cft2<a name='97'>
<a name='98'>
    REAL, DIMENSION( its:ite, jts:jte )  &amp;<a name='99'>
    :: mm, zzavg, zeta_zd12<a name='100'>
<a name='101'>
    REAL, DIMENSION( its-2:ite+2, kts:kte, jts-2:jte+2 )  &amp;<a name='102'>
    :: tmp1, hat, hatavg<a name='103'>
<a name='104'>
<font color=#447700>! End declarations.<a name='105'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='106'></font>
<a name='107'>
<font color=#447700>! Comments 10-MAR-2005<a name='108'></font>
<font color=#447700>! Treat all differentials as 'div-style' [or 'curl-style'],<a name='109'></font>
<font color=#447700>! i.e., du/dX becomes (in map coordinate space) mx*my * d(u/my)/dx,<a name='110'></font>
<font color=#447700>! NB - all equations referred to here are from Chen and Dudhia 2002, from the<a name='111'></font>
<font color=#447700>! WRF physics documents web pages:<a name='112'></font>
<font color=#447700>! http://www.mmm.ucar.edu/wrf/users/docs/wrf-doc-physics.pdf<a name='113'></font>
<a name='114'>
<font color=#447700>!=======================================================================<a name='115'></font>
<font color=#447700>! In the following section, calculate 3-d divergence and the first three<a name='116'></font>
<font color=#447700>! (defor11, defor22, defor33) of six deformation terms.<a name='117'></font>
<a name='118'>
    ktes1   = kte-1<a name='119'>
    ktes2   = kte-2<a name='120'>
<a name='121'>
    cft2    = - 0.5 * dnw(ktes1) / dn(ktes1)<a name='122'>
    cft1    = 1.0 - cft2<a name='123'>
<a name='124'>
    ktf     = MIN( kte, kde-1 )<a name='125'>
<a name='126'>
    i_start = its<a name='127'>
    i_end   = MIN( ite, ide-1 )<a name='128'>
    j_start = jts<a name='129'>
    j_end   = MIN( jte, jde-1 )<a name='130'>
<a name='131'>
<font color=#447700>! Square the map scale factor.<a name='132'></font>
<a name='133'>
    DO j = j_start, j_end<a name='134'>
    DO i = i_start, i_end<a name='135'>
      mm(i,j) = msftx(i,j) * msfty(i,j)<a name='136'>
    END DO<a name='137'>
    END DO<a name='138'>
<a name='139'>
<font color=#447700>!-----------------------------------------------------------------------<a name='140'></font>
<font color=#447700>! Calculate du/dx.<a name='141'></font>
<a name='142'>
<font color=#447700>! Apply a coordinate transformation to zonal velocity, u.<a name='143'></font>
<a name='144'>
    DO j = j_start, j_end<a name='145'>
    DO k = kts, ktf<a name='146'>
    DO i = i_start, i_end+1<a name='147'>
      hat(i,k,j) = u(i,k,j) / msfuy(i,j)<a name='148'>
    END DO<a name='149'>
    END DO<a name='150'>
    END DO<a name='151'>
<a name='152'>
<font color=#447700>! Average in x and z.<a name='153'></font>
<a name='154'>
    DO j=j_start,j_end<a name='155'>
    DO k=kts+1,ktf<a name='156'>
    DO i=i_start,i_end<a name='157'>
      hatavg(i,k,j) = 0.5 *  &amp;<a name='158'>
                    ( fnm(k) * ( hat(i,k  ,j) + hat(i+1,  k,j) ) +  &amp;<a name='159'>
                      fnp(k) * ( hat(i,k-1,j) + hat(i+1,k-1,j) ) )<a name='160'>
    END DO<a name='161'>
    END DO<a name='162'>
    END DO<a name='163'>
<a name='164'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='165'></font>
<a name='166'>
    DO j = j_start, j_end<a name='167'>
    DO i = i_start, i_end<a name='168'>
      hatavg(i,1,j)   =  0.5 * (  &amp;<a name='169'>
                         cf1 * hat(i  ,1,j) +  &amp;<a name='170'>
                         cf2 * hat(i  ,2,j) +  &amp;<a name='171'>
                         cf3 * hat(i  ,3,j) +  &amp;<a name='172'>
                         cf1 * hat(i+1,1,j) +  &amp;<a name='173'>
                         cf2 * hat(i+1,2,j) +  &amp;<a name='174'>
                         cf3 * hat(i+1,3,j) )<a name='175'>
      hatavg(i,kte,j) =  0.5 * (  &amp;<a name='176'>
                        cft1 * ( hat(i,ktes1,j) + hat(i+1,ktes1,j) )  +  &amp;<a name='177'>
                        cft2 * ( hat(i,ktes2,j) + hat(i+1,ktes2,j) ) )<a name='178'>
    END DO<a name='179'>
    END DO<a name='180'>
<a name='181'>
    <font color=#447700>! Comments 10-MAR-05<a name='182'></font>
    <font color=#447700>! Eqn 13a: D11=defor11= 2m^2 * (partial du^/dX + partial dpsi/dx * partial du^/dpsi)<a name='183'></font>
    <font color=#447700>! Below, D11 is set = 2*tmp1<a name='184'></font>
    <font color=#447700>! =&gt; tmp1 = m^2 * (partial du^/dX + partial dpsi/dx * partial du^/dpsi)<a name='185'></font>
    <font color=#447700>! tmpzx = averaged value of dpsi/dx (=zx)<a name='186'></font>
<a name='187'>
    DO j = j_start, j_end<a name='188'>
    DO k = kts, ktf<a name='189'>
    DO i = i_start, i_end<a name='190'>
      tmpzx       = 0.25 * (  &amp;<a name='191'>
                    zx(i,k  ,j) + zx(i+1,k  ,j) +  &amp;<a name='192'>
                    zx(i,k+1,j) + zx(i+1,k+1,j) )<a name='193'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) *tmpzx * rdzw(i,k,j)<a name='194'>
      <font color=#447700>! tmp1 to here = partial dpsi/dx * partial du^/dpsi:<a name='195'></font>
    END DO<a name='196'>
    END DO<a name='197'>
    END DO<a name='198'>
<a name='199'>
    DO j = j_start, j_end<a name='200'>
    DO k = kts, ktf<a name='201'>
    DO i = i_start, i_end<a name='202'>
      tmp1(i,k,j) = mm(i,j) * ( rdx * ( hat(i+1,k,j) - hat(i,k,j) ) -  &amp;<a name='203'>
                    tmp1(i,k,j))<a name='204'>
    END DO<a name='205'>
    END DO<a name='206'>
    END DO<a name='207'>
<a name='208'>
<font color=#447700>! End calculation of du/dx.<a name='209'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='210'></font>
<a name='211'>
<font color=#447700>!-----------------------------------------------------------------------<a name='212'></font>
<font color=#447700>! Calculate defor11 (2*du/dx).<a name='213'></font>
<font color=#447700>! Comments 10-MAR-05<a name='214'></font>
<font color=#447700>! Eqn 13a: D11=defor11= 2 m^2 * (partial du^/dX + partial dpsi/dx * partial du^/dpsi)<a name='215'></font>
<font color=#447700>!                     = 2*tmp1<a name='216'></font>
<a name='217'>
    DO j = j_start, j_end<a name='218'>
    DO k = kts, ktf<a name='219'>
    DO i = i_start, i_end<a name='220'>
      defor11(i,k,j) = 2.0 * tmp1(i,k,j)<a name='221'>
    END DO<a name='222'>
    END DO<a name='223'>
    END DO<a name='224'>
<a name='225'>
<font color=#447700>! End calculation of defor11.<a name='226'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='227'></font>
<a name='228'>
<font color=#447700>!-----------------------------------------------------------------------<a name='229'></font>
<font color=#447700>! Calculate zonal divergence (du/dx) and add it to the divergence array.<a name='230'></font>
<a name='231'>
    DO j = j_start, j_end<a name='232'>
    DO k = kts, ktf<a name='233'>
    DO i = i_start, i_end<a name='234'>
      div(i,k,j) = tmp1(i,k,j)<a name='235'>
    END DO<a name='236'>
    END DO<a name='237'>
    END DO<a name='238'>
<a name='239'>
<font color=#447700>! End calculation of zonal divergence.<a name='240'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='241'></font>
<a name='242'>
<font color=#447700>!-----------------------------------------------------------------------<a name='243'></font>
<font color=#447700>! Calculate dv/dy.<a name='244'></font>
<a name='245'>
<font color=#447700>! Apply a coordinate transformation to meridional velocity, v.<a name='246'></font>
<a name='247'>
    DO j = j_start, j_end+1<a name='248'>
    DO k = kts, ktf<a name='249'>
    DO i = i_start, i_end<a name='250'>
      <font color=#447700>! Because msfvx at the poles will be undefined (1./0.), we will have<a name='251'></font>
      <font color=#447700>! trouble.  But we are OK since v at the poles is 0., and that takes<a name='252'></font>
      <font color=#447700>! precedence in this case.<a name='253'></font>
      IF ((config_flags%polar) .AND. ((j == jds) .OR. (j == jde))) THEN<a name='254'>
         hat(i,k,j) = 0.<a name='255'>
      ELSE <font color=#447700>! normal code<a name='256'></font>
      hat(i,k,j) = v(i,k,j) / msfvx(i,j)<a name='257'>
      ENDIF<a name='258'>
    END DO<a name='259'>
    END DO<a name='260'>
    END DO<a name='261'>
<a name='262'>
<font color=#447700>! Account for the slope in y of eta surfaces.<a name='263'></font>
<a name='264'>
    DO j=j_start,j_end<a name='265'>
    DO k=kts+1,ktf<a name='266'>
    DO i=i_start,i_end<a name='267'>
      hatavg(i,k,j) = 0.5 * (  &amp;<a name='268'>
                      fnm(k) * ( hat(i,k  ,j) + hat(i,k  ,j+1) ) +  &amp;<a name='269'>
                      fnp(k) * ( hat(i,k-1,j) + hat(i,k-1,j+1) ) )<a name='270'>
    END DO<a name='271'>
    END DO<a name='272'>
    END DO<a name='273'>
<a name='274'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='275'></font>
<a name='276'>
    DO j = j_start, j_end<a name='277'>
    DO i = i_start, i_end<a name='278'>
      hatavg(i,1,j)   =  0.5 * (  &amp;<a name='279'>
                         cf1 * hat(i,1,j  ) +  &amp;<a name='280'>
                         cf2 * hat(i,2,j  ) +  &amp;<a name='281'>
                         cf3 * hat(i,3,j  ) +  &amp;<a name='282'>
                         cf1 * hat(i,1,j+1) +  &amp;<a name='283'>
                         cf2 * hat(i,2,j+1) +  &amp;<a name='284'>
                         cf3 * hat(i,3,j+1) )<a name='285'>
      hatavg(i,kte,j) =  0.5 * (  &amp;<a name='286'>
                        cft1 * ( hat(i,ktes1,j) + hat(i,ktes1,j+1) ) +  &amp;<a name='287'>
                        cft2 * ( hat(i,ktes2,j) + hat(i,ktes2,j+1) ) )<a name='288'>
    END DO<a name='289'>
    END DO<a name='290'>
<a name='291'>
    <font color=#447700>! Comments 10-MAR-05<a name='292'></font>
    <font color=#447700>! Eqn 13b: D22=defor22= 2m^2 * (partial dv^/dY + partial dpsi/dy * partial dv^/dpsi)<a name='293'></font>
    <font color=#447700>! Below, D22 is set = 2*tmp1<a name='294'></font>
    <font color=#447700>! =&gt; tmp1 = m^2 * (partial dv^/dY + partial dpsi/dy * partial dv^/dpsi)<a name='295'></font>
    <font color=#447700>! tmpzy = averaged value of dpsi/dy (=zy)<a name='296'></font>
<a name='297'>
    DO j = j_start, j_end<a name='298'>
    DO k = kts, ktf<a name='299'>
    DO i = i_start, i_end<a name='300'>
      tmpzy       =  0.25 * (  &amp;<a name='301'>
                     zy(i,k  ,j) + zy(i,k  ,j+1) +  &amp;<a name='302'>
                     zy(i,k+1,j) + zy(i,k+1,j+1)  )<a name='303'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) * tmpzy * rdzw(i,k,j)<a name='304'>
      <font color=#447700>! tmp1 to here = partial dpsi/dy * partial dv^/dpsi:<a name='305'></font>
    END DO<a name='306'>
    END DO<a name='307'>
    END DO<a name='308'>
<a name='309'>
    DO j = j_start, j_end<a name='310'>
    DO k = kts, ktf<a name='311'>
    DO i = i_start, i_end<a name='312'>
      tmp1(i,k,j) = mm(i,j) * (  &amp;<a name='313'>
                    rdy * ( hat(i,k,j+1) - hat(i,k,j) ) - tmp1(i,k,j) )<a name='314'>
    END DO<a name='315'>
    END DO<a name='316'>
    END DO<a name='317'>
<a name='318'>
<font color=#447700>! End calculation of dv/dy.<a name='319'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='320'></font>
<a name='321'>
<font color=#447700>!-----------------------------------------------------------------------<a name='322'></font>
<font color=#447700>! Calculate defor22 (2*dv/dy).<a name='323'></font>
<font color=#447700>! Comments 10-MAR-05<a name='324'></font>
<font color=#447700>! Eqn 13b: D22=defor22= 2 m^2 * (partial dv^/dY + partial dpsi/dy * partial dv^/dpsi)<a name='325'></font>
<font color=#447700>!                     = 2*tmp1<a name='326'></font>
<a name='327'>
    DO j = j_start, j_end<a name='328'>
    DO k = kts, ktf<a name='329'>
    DO i = i_start, i_end<a name='330'>
      defor22(i,k,j) = 2.0 * tmp1(i,k,j)<a name='331'>
    END DO<a name='332'>
    END DO<a name='333'>
    END DO<a name='334'>
<a name='335'>
<font color=#447700>! End calculation of defor22.<a name='336'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='337'></font>
<a name='338'>
<font color=#447700>!-----------------------------------------------------------------------<a name='339'></font>
<font color=#447700>! Calculate meridional divergence (dv/dy) and add it to the divergence<a name='340'></font>
<font color=#447700>! array.<a name='341'></font>
<a name='342'>
    DO j = j_start, j_end<a name='343'>
    DO k = kts, ktf<a name='344'>
    DO i = i_start, i_end<a name='345'>
      div(i,k,j) = div(i,k,j) + tmp1(i,k,j)<a name='346'>
    END DO<a name='347'>
    END DO<a name='348'>
    END DO<a name='349'>
<a name='350'>
<font color=#447700>! End calculation of meridional divergence.<a name='351'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='352'></font>
<a name='353'>
<font color=#447700>!-----------------------------------------------------------------------<a name='354'></font>
<font color=#447700>! Comments 10-MAR-05<a name='355'></font>
<font color=#447700>! Eqn 13c: D33=defor33= 2 * partial dw/dz<a name='356'></font>
<font color=#447700>! Below, D33 is set = 2*tmp1<a name='357'></font>
<font color=#447700>! =&gt; tmp1 = partial dw/dz<a name='358'></font>
<a name='359'>
<font color=#447700>! Calculate dw/dz.<a name='360'></font>
<a name='361'>
    DO j = j_start, j_end<a name='362'>
    DO k = kts, ktf<a name='363'>
    DO i = i_start, i_end<a name='364'>
      tmp1(i,k,j) = ( w(i,k+1,j) - w(i,k,j) ) * rdzw(i,k,j)<a name='365'>
    END DO<a name='366'>
    END DO<a name='367'>
    END DO<a name='368'>
<a name='369'>
<font color=#447700>! End calculation of dw/dz.<a name='370'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='371'></font>
<a name='372'>
<font color=#447700>!-----------------------------------------------------------------------<a name='373'></font>
<font color=#447700>! Calculate defor33 (2*dw/dz).<a name='374'></font>
<a name='375'>
    DO j = j_start, j_end<a name='376'>
    DO k = kts, ktf<a name='377'>
    DO i = i_start, i_end<a name='378'>
      defor33(i,k,j) = 2.0 * tmp1(i,k,j)<a name='379'>
    END DO<a name='380'>
    END DO<a name='381'>
    END DO<a name='382'>
<a name='383'>
<font color=#447700>! End calculation of defor33.<a name='384'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='385'></font>
<a name='386'>
<font color=#447700>!-----------------------------------------------------------------------<a name='387'></font>
<font color=#447700>! Calculate vertical divergence (dw/dz) and add it to the divergence<a name='388'></font>
<font color=#447700>! array.<a name='389'></font>
<a name='390'>
    DO j = j_start, j_end<a name='391'>
    DO k = kts, ktf<a name='392'>
    DO i = i_start, i_end<a name='393'>
      div(i,k,j) = div(i,k,j) + tmp1(i,k,j)<a name='394'>
    END DO<a name='395'>
    END DO<a name='396'>
    END DO<a name='397'>
<a name='398'>
<font color=#447700>! End calculation of vertical divergence.<a name='399'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='400'></font>
<a name='401'>
<font color=#447700>! Three-dimensional divergence is now finished and values are in array<a name='402'></font>
<font color=#447700>! "div."  Also, the first three (defor11, defor22, defor33) of six<a name='403'></font>
<font color=#447700>! deformation terms are now calculated at pressure points.<a name='404'></font>
<font color=#447700>!=======================================================================<a name='405'></font>
<a name='406'>
<font color=#447700>! Comments 10-MAR-2005<a name='407'></font>
<font color=#447700>! Treat all differentials as 'div-style' [or 'curl-style'],<a name='408'></font>
<font color=#447700>! i.e., du/dY becomes (in map coordinate space) mx*my * d(u/mx)/dy,<a name='409'></font>
<font color=#447700>!       dv/dX becomes (in map coordinate space) mx*my * d(v/my)/dx,<a name='410'></font>
<font color=#447700>! (see e.g. Haltiner and Williams p. 441)<a name='411'></font>
<a name='412'>
<font color=#447700>!=======================================================================<a name='413'></font>
<font color=#447700>! Calculate the final three deformations (defor12, defor13, defor23) at<a name='414'></font>
<font color=#447700>! vorticity points.<a name='415'></font>
<a name='416'>
    i_start = its<a name='417'>
    i_end   = ite<a name='418'>
    j_start = jts<a name='419'>
    j_end   = jte<a name='420'>
<a name='421'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='422'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='423'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='424'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='425'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='426'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='427'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='428'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='429'>
      IF ( config_flags%periodic_x ) i_start = its<a name='430'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='431'>
<a name='432'>
<a name='433'>
<font color=#447700>!-----------------------------------------------------------------------<a name='434'></font>
<font color=#447700>! Calculate du/dy.<a name='435'></font>
<a name='436'>
<font color=#447700>! First, calculate an average mapscale factor.<a name='437'></font>
<a name='438'>
<font color=#447700>! Comments 10-MAR-05<a name='439'></font>
<font color=#447700>! du/dy =&gt; need u map scale factor in x (which is defined at u points)<a name='440'></font>
<font color=#447700>! averaged over j and j-1<a name='441'></font>
<font color=#447700>! dv/dx =&gt; need v map scale factor in y (which is defined at v points)<a name='442'></font>
<font color=#447700>! averaged over i and i-1<a name='443'></font>
<a name='444'>
    DO j = j_start, j_end<a name='445'>
    DO i = i_start, i_end<a name='446'>
      mm(i,j) = 0.25 * ( msfux(i,j-1) + msfux(i,j) ) * ( msfvy(i-1,j) + msfvy(i,j) )<a name='447'>
    END DO<a name='448'>
    END DO<a name='449'>
<a name='450'>
<font color=#447700>! Apply a coordinate transformation to zonal velocity, u.<a name='451'></font>
<a name='452'>
    DO j =j_start-1, j_end<a name='453'>
    DO k =kts, ktf<a name='454'>
    DO i =i_start, i_end<a name='455'>
      <font color=#447700>! Fixes to set_physical_bc2/3d for polar boundary conditions<a name='456'></font>
      <font color=#447700>! remove issues with loop over j<a name='457'></font>
      hat(i,k,j) = u(i,k,j) / msfux(i,j)<a name='458'>
    END DO<a name='459'>
    END DO<a name='460'>
    END DO<a name='461'>
<a name='462'>
<font color=#447700>! Average in y and z.<a name='463'></font>
<a name='464'>
    DO j=j_start,j_end<a name='465'>
    DO k=kts+1,ktf<a name='466'>
    DO i=i_start,i_end<a name='467'>
      hatavg(i,k,j) = 0.5 * (  &amp;<a name='468'>
                      fnm(k) * ( hat(i,k  ,j-1) + hat(i,k  ,j) ) +  &amp;<a name='469'>
                      fnp(k) * ( hat(i,k-1,j-1) + hat(i,k-1,j) ) )<a name='470'>
    END DO<a name='471'>
    END DO<a name='472'>
    END DO<a name='473'>
<a name='474'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='475'></font>
<a name='476'>
    DO j = j_start, j_end<a name='477'>
    DO i = i_start, i_end<a name='478'>
      hatavg(i,1,j)   =  0.5 * (  &amp;<a name='479'>
                         cf1 * hat(i,1,j-1) +  &amp;<a name='480'>
                         cf2 * hat(i,2,j-1) +  &amp;<a name='481'>
                         cf3 * hat(i,3,j-1) +  &amp;<a name='482'>
                         cf1 * hat(i,1,j  ) +  &amp;<a name='483'>
                         cf2 * hat(i,2,j  ) +  &amp;<a name='484'>
                         cf3 * hat(i,3,j  ) )<a name='485'>
      hatavg(i,kte,j) =  0.5 * (  &amp;<a name='486'>
                        cft1 * ( hat(i,ktes1,j-1) + hat(i,ktes1,j) ) +  &amp;<a name='487'>
                        cft2 * ( hat(i,ktes2,j-1) + hat(i,ktes2,j) ) )<a name='488'>
    END DO<a name='489'>
    END DO<a name='490'>
<a name='491'>
    <font color=#447700>! tmpzy = averaged value of dpsi/dy (=zy) on vorticity grid<a name='492'></font>
    <font color=#447700>! tmp1  = partial dpsi/dy * partial du^/dpsi<a name='493'></font>
    DO j = j_start, j_end<a name='494'>
    DO k = kts, ktf<a name='495'>
    DO i = i_start, i_end<a name='496'>
      tmpzy       = 0.25 * (  &amp;<a name='497'>
                    zy(i-1,k  ,j) + zy(i,k  ,j) +  &amp;<a name='498'>
                    zy(i-1,k+1,j) + zy(i,k+1,j) )<a name='499'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) *  &amp;<a name='500'>
                    0.25 * tmpzy * ( rdzw(i,k,j) + rdzw(i-1,k,j) + &amp;<a name='501'>
                                     rdzw(i-1,k,j-1) + rdzw(i,k,j-1) )<a name='502'>
    END DO<a name='503'>
    END DO<a name='504'>
    END DO<a name='505'>
<a name='506'>
<font color=#447700>! End calculation of du/dy.<a name='507'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='508'></font>
<a name='509'>
<font color=#447700>!-----------------------------------------------------------------------<a name='510'></font>
<font color=#447700>! Add the first term to defor12 (du/dy+dv/dx) at vorticity points.<a name='511'></font>
<a name='512'>
<font color=#447700>! Comments 10-MAR-05<a name='513'></font>
<font color=#447700>! Eqn 13d: D12=defor12= m^2 * (partial dv^/dX + partial du^/dY +<a name='514'></font>
<font color=#447700>!                              partial dpsi/dx * partial dv^/dpsi +<a name='515'></font>
<font color=#447700>!                              partial dpsi/dy * partial du^/dpsi)<a name='516'></font>
<font color=#447700>! Here deal with m^2 * (partial du^/dY + partial dpsi/dy * partial du^/dpsi)<a name='517'></font>
<font color=#447700>! Still need to add v^ terms:<a name='518'></font>
<font color=#447700>!   m^2 * (partial dv^/dX + partial dpsi/dx * partial dv^/dpsi)<a name='519'></font>
<a name='520'>
    DO j = j_start, j_end<a name='521'>
    DO k = kts, ktf<a name='522'>
    DO i = i_start, i_end<a name='523'>
      defor12(i,k,j) = mm(i,j) * (  &amp;<a name='524'>
                       rdy * ( hat(i,k,j) - hat(i,k,j-1) ) - tmp1(i,k,j) )<a name='525'>
    END DO<a name='526'>
    END DO<a name='527'>
    END DO<a name='528'>
<a name='529'>
<font color=#447700>! End addition of the first term to defor12.<a name='530'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='531'></font>
<a name='532'>
<font color=#447700>!-----------------------------------------------------------------------<a name='533'></font>
<font color=#447700>! Calculate dv/dx.<a name='534'></font>
<a name='535'>
<font color=#447700>! Apply a coordinate transformation to meridional velocity, v.<a name='536'></font>
<a name='537'>
    DO j = j_start, j_end<a name='538'>
    DO k = kts, ktf<a name='539'>
    DO i = i_start-1, i_end<a name='540'>
       hat(i,k,j) = v(i,k,j) / msfvy(i,j)<a name='541'>
    END DO<a name='542'>
    END DO<a name='543'>
    END DO<a name='544'>
<a name='545'>
<font color=#447700>! Account for the slope in x of eta surfaces.<a name='546'></font>
<a name='547'>
    DO j = j_start, j_end<a name='548'>
    DO k = kts+1, ktf<a name='549'>
    DO i = i_start, i_end<a name='550'>
      hatavg(i,k,j) = 0.5 * (  &amp;<a name='551'>
                      fnm(k) * ( hat(i-1,k  ,j) + hat(i,k  ,j) ) +  &amp;<a name='552'>
                      fnp(k) * ( hat(i-1,k-1,j) + hat(i,k-1,j) ) )<a name='553'>
    END DO<a name='554'>
    END DO<a name='555'>
    END DO<a name='556'>
<a name='557'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='558'></font>
<a name='559'>
    DO j = j_start, j_end<a name='560'>
    DO i = i_start, i_end<a name='561'>
       hatavg(i,1,j)   =  0.5 * (  &amp;<a name='562'>
                          cf1 * hat(i-1,1,j) +  &amp;<a name='563'>
                          cf2 * hat(i-1,2,j) +  &amp;<a name='564'>
                          cf3 * hat(i-1,3,j) +  &amp;<a name='565'>
                          cf1 * hat(i  ,1,j) +  &amp;<a name='566'>
                          cf2 * hat(i  ,2,j) +  &amp;<a name='567'>
                          cf3 * hat(i  ,3,j) )<a name='568'>
       hatavg(i,kte,j) =  0.5 * (  &amp;<a name='569'>
                         cft1 * ( hat(i,ktes1,j) + hat(i-1,ktes1,j) ) +  &amp;<a name='570'>
                         cft2 * ( hat(i,ktes2,j) + hat(i-1,ktes2,j) ) )<a name='571'>
    END DO<a name='572'>
    END DO<a name='573'>
<a name='574'>
    <font color=#447700>! Fixes to set_physical_bc2/3d have made any check for polar B.C.'s<a name='575'></font>
    <font color=#447700>! unnecessary in this place.  zx, rdzw, and hatavg are all defined<a name='576'></font>
    <font color=#447700>! in places they need to be and the values at the poles are replications<a name='577'></font>
    <font color=#447700>! of the values one grid point in, so the averaging over j and j-1 works<a name='578'></font>
    <font color=#447700>! to act as just using the value at j or j-1 (with out extra code).<a name='579'></font>
    <font color=#447700>!<a name='580'></font>
    <font color=#447700>! tmpzx = averaged value of dpsi/dx (=zx) on vorticity grid<a name='581'></font>
    <font color=#447700>! tmp1  = partial dpsi/dx * partial dv^/dpsi<a name='582'></font>
    DO j = j_start, j_end<a name='583'>
    DO k = kts, ktf<a name='584'>
    DO i = i_start, i_end<a name='585'>
      tmpzx       = 0.25 * (  &amp;<a name='586'>
                    zx(i,k  ,j-1) + zx(i,k  ,j) +  &amp;<a name='587'>
                    zx(i,k+1,j-1) + zx(i,k+1,j) )<a name='588'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) *  &amp;<a name='589'>
                    0.25 * tmpzx * ( rdzw(i,k,j) + rdzw(i,k,j-1) + &amp;<a name='590'>
                                     rdzw(i-1,k,j-1) + rdzw(i-1,k,j) )<a name='591'>
    END DO<a name='592'>
    END DO<a name='593'>
    END DO<a name='594'>
<a name='595'>
<font color=#447700>! End calculation of dv/dx.<a name='596'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='597'></font>
<a name='598'>
<font color=#447700>!-----------------------------------------------------------------------<a name='599'></font>
<font color=#447700>! Add the second term to defor12 (du/dy+dv/dx) at vorticity points.<a name='600'></font>
<a name='601'>
<font color=#447700>! Comments 10-MAR-05<a name='602'></font>
<font color=#447700>! Eqn 13d: D12=defor12= m^2 * (partial dv^/dX + partial du^/dY +<a name='603'></font>
<font color=#447700>!                              partial dpsi/dx * partial dv^/dpsi +<a name='604'></font>
<font color=#447700>!                              partial dpsi/dy * partial du^/dpsi)<a name='605'></font>
<font color=#447700>! Here adding v^ terms:<a name='606'></font>
<font color=#447700>!    m^2 * (partial dv^/dX + partial dpsi/dx * partial dv^/dpsi)<a name='607'></font>
<a name='608'>
  IF ( config_flags%sfs_opt .GT. 0 ) THEN <font color=#447700>! NBA--<a name='609'></font>
<a name='610'>
<font color=#447700>!JDM____________________________________________________________________<a name='611'></font>
<font color=#447700>!<a name='612'></font>
<font color=#447700>!     s12 =  du/dy + dv/dx<a name='613'></font>
<font color=#447700>!         = (du/dy - dz/dy*du/dz) + (dv/dx - dz/dx*dv/dz)<a name='614'></font>
<font color=#447700>!            ______defor12______             ___tmp1___<a name='615'></font>
<font color=#447700>!<a name='616'></font>
<font color=#447700>!     r12 =  du/dy - dv/dx<a name='617'></font>
<font color=#447700>!         = (du/dy - dz/dy*du/dz) - (dv/dx - dz/dx*dv/dz)<a name='618'></font>
<font color=#447700>!            ______defor12______             ___tmp1___<a name='619'></font>
<font color=#447700>!_______________________________________________________________________<a name='620'></font>
<a name='621'>
<a name='622'>
    DO j = j_start, j_end<a name='623'>
    DO k = kts, ktf<a name='624'>
    DO i = i_start, i_end<a name='625'>
<a name='626'>
      nba_rij(i,k,j,P_r12) = defor12(i,k,j) -  &amp;<a name='627'>
                             mm(i,j) * (   &amp;<a name='628'>
                             rdx * ( hat(i,k,j) - hat(i-1,k,j) ) - tmp1(i,k,j) )<a name='629'>
<a name='630'>
      defor12(i,k,j) = defor12(i,k,j) +  &amp;<a name='631'>
                       mm(i,j) * (  &amp;<a name='632'>
                       rdx * ( hat(i,k,j) - hat(i-1,k,j) ) - tmp1(i,k,j) )<a name='633'>
    END DO<a name='634'>
    END DO<a name='635'>
    END DO<a name='636'>
<a name='637'>
<font color=#447700>! End addition of the second term to defor12.<a name='638'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='639'></font>
<a name='640'>
<font color=#447700>!-----------------------------------------------------------------------<a name='641'></font>
<font color=#447700>! Update the boundary for defor12 (might need to change later).<a name='642'></font>
<a name='643'>
    IF ( .NOT. config_flags%periodic_x .AND. i_start .EQ. ids+1 ) THEN<a name='644'>
      DO j = jts, jte<a name='645'>
      DO k = kts, kte<a name='646'>
        defor12(ids,k,j) = defor12(ids+1,k,j)<a name='647'>
        nba_rij(ids,k,j,P_r12) = nba_rij(ids+1,k,j,P_r12)<a name='648'>
      END DO<a name='649'>
      END DO<a name='650'>
    END IF<a name='651'>
<a name='652'>
    IF ( .NOT. config_flags%periodic_y .AND. j_start .EQ. jds+1) THEN<a name='653'>
      DO k = kts, kte<a name='654'>
      DO i = its, ite<a name='655'>
        defor12(i,k,jds) = defor12(i,k,jds+1)<a name='656'>
        nba_rij(i,k,jds,P_r12) = nba_rij(i,k,jds+1,P_r12)<a name='657'>
      END DO<a name='658'>
      END DO<a name='659'>
    END IF<a name='660'>
<a name='661'>
    IF ( .NOT. config_flags%periodic_x .AND. i_end .EQ. ide-1) THEN<a name='662'>
      DO j = jts, jte<a name='663'>
      DO k = kts, kte<a name='664'>
        defor12(ide,k,j) = defor12(ide-1,k,j)<a name='665'>
        nba_rij(ide,k,j,P_r12) = nba_rij(ide-1,k,j,P_r12)<a name='666'>
      END DO<a name='667'>
      END DO<a name='668'>
    END IF<a name='669'>
<a name='670'>
    IF ( .NOT. config_flags%periodic_y .AND. j_end .EQ. jde-1) THEN<a name='671'>
      DO k = kts, kte<a name='672'>
      DO i = its, ite<a name='673'>
        defor12(i,k,jde) = defor12(i,k,jde-1)<a name='674'>
        nba_rij(i,k,jde,P_r12) = nba_rij(i,k,jde-1,P_r12)<a name='675'>
      END DO<a name='676'>
      END DO<a name='677'>
    END IF<a name='678'>
<a name='679'>
  ELSE <font color=#447700>! NOT NBA--------------------------------------------------------<a name='680'></font>
<a name='681'>
    DO j = j_start, j_end<a name='682'>
    DO k = kts, ktf<a name='683'>
    DO i = i_start, i_end<a name='684'>
      defor12(i,k,j) = defor12(i,k,j) +  &amp;<a name='685'>
                       mm(i,j) * (  &amp;<a name='686'>
                       rdx * ( hat(i,k,j) - hat(i-1,k,j) ) - tmp1(i,k,j) )<a name='687'>
    END DO<a name='688'>
    END DO<a name='689'>
    END DO<a name='690'>
<a name='691'>
<font color=#447700>! End addition of the second term to defor12.<a name='692'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='693'></font>
<a name='694'>
<font color=#447700>!-----------------------------------------------------------------------<a name='695'></font>
<font color=#447700>! Update the boundary for defor12 (might need to change later).<a name='696'></font>
<a name='697'>
    IF ( .NOT. config_flags%periodic_x .AND. i_start .EQ. ids+1 ) THEN<a name='698'>
      DO j = jts, jte<a name='699'>
      DO k = kts, kte<a name='700'>
        defor12(ids,k,j) = defor12(ids+1,k,j)<a name='701'>
      END DO<a name='702'>
      END DO<a name='703'>
    END IF<a name='704'>
<a name='705'>
    IF ( .NOT. config_flags%periodic_y .AND. j_start .EQ. jds+1) THEN<a name='706'>
      DO k = kts, kte<a name='707'>
      DO i = its, ite<a name='708'>
        defor12(i,k,jds) = defor12(i,k,jds+1)<a name='709'>
      END DO<a name='710'>
      END DO<a name='711'>
    END IF<a name='712'>
<a name='713'>
    IF ( .NOT. config_flags%periodic_x .AND. i_end .EQ. ide-1) THEN<a name='714'>
      DO j = jts, jte<a name='715'>
      DO k = kts, kte<a name='716'>
        defor12(ide,k,j) = defor12(ide-1,k,j)<a name='717'>
      END DO<a name='718'>
      END DO<a name='719'>
    END IF<a name='720'>
<a name='721'>
    IF ( .NOT. config_flags%periodic_y .AND. j_end .EQ. jde-1) THEN<a name='722'>
      DO k = kts, kte<a name='723'>
      DO i = its, ite<a name='724'>
        defor12(i,k,jde) = defor12(i,k,jde-1)<a name='725'>
      END DO<a name='726'>
      END DO<a name='727'>
    END IF<a name='728'>
<a name='729'>
  ENDIF <font color=#447700>! NBA-----------------------------------------------------------<a name='730'></font>
<a name='731'>
<font color=#447700>! End update of boundary for defor12.<a name='732'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='733'></font>
<a name='734'>
<font color=#447700>! Comments 10-MAR-05<a name='735'></font>
<font color=#447700>! Further deformation terms not needed for 2-dimensional Smagorinsky diffusion,<a name='736'></font>
<font color=#447700>! so those terms have not been dealt with yet.<a name='737'></font>
<font color=#447700>! A "y" has simply been added to all map scale factors to allow the model to<a name='738'></font>
<font color=#447700>! compile without errors.<a name='739'></font>
<a name='740'>
<font color=#447700>!-----------------------------------------------------------------------<a name='741'></font>
<font color=#447700>! Calculate dw/dx.<a name='742'></font>
<a name='743'>
    i_start = its<a name='744'>
    i_end   = MIN( ite, ide-1 )<a name='745'>
    j_start = jts<a name='746'>
    j_end   = MIN( jte, jde-1 )<a name='747'>
<a name='748'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='749'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='750'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='751'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='752'>
<a name='753'>
    IF ( config_flags%periodic_x ) i_start = its<a name='754'>
    IF ( config_flags%periodic_x ) i_end = MIN( ite, ide )<a name='755'>
    IF ( config_flags%periodic_y ) j_end = MIN( jte, jde )<a name='756'>
<a name='757'>
<font color=#447700>! Square the mapscale factor.<a name='758'></font>
<a name='759'>
    DO j = jts, jte<a name='760'>
    DO i = its, ite<a name='761'>
      mm(i,j) = msfux(i,j) * msfuy(i,j)<a name='762'>
    END DO<a name='763'>
    END DO<a name='764'>
<a name='765'>
<font color=#447700>! Apply a coordinate transformation to vertical velocity, w.  This is for both<a name='766'></font>
<font color=#447700>! defor13 and defor23.<a name='767'></font>
<a name='768'>
    DO j = j_start, j_end<a name='769'>
    DO k = kts, kte<a name='770'>
    DO i = i_start, i_end<a name='771'>
      hat(i,k,j) = w(i,k,j) / msfty(i,j)<a name='772'>
    END DO<a name='773'>
    END DO<a name='774'>
    END DO<a name='775'>
<a name='776'>
    i = i_start-1<a name='777'>
    DO j = j_start, MIN( jte, jde-1 )<a name='778'>
    DO k = kts, kte<a name='779'>
      hat(i,k,j) = w(i,k,j) / msfty(i,j)<a name='780'>
    END DO<a name='781'>
    END DO<a name='782'>
<a name='783'>
    j = j_start-1<a name='784'>
    DO k = kts, kte<a name='785'>
    DO i = i_start, MIN( ite, ide-1 )<a name='786'>
      hat(i,k,j) = w(i,k,j) / msfty(i,j)<a name='787'>
    END DO<a name='788'>
    END DO<a name='789'>
<a name='790'>
<font color=#447700>! QUESTION: What is this for?<a name='791'></font>
<a name='792'>
    DO j = j_start, j_end<a name='793'>
    DO k = kts, ktf<a name='794'>
    DO i = i_start, i_end<a name='795'>
      hatavg(i,k,j) = 0.25 * (  &amp;<a name='796'>
                      hat(i  ,k  ,j) +  &amp;<a name='797'>
                      hat(i  ,k+1,j) +  &amp;<a name='798'>
                      hat(i-1,k  ,j) +  &amp;<a name='799'>
                      hat(i-1,k+1,j) )<a name='800'>
    END DO<a name='801'>
    END DO<a name='802'>
    END DO<a name='803'>
<a name='804'>
<font color=#447700>! Calculate dw/dx.<a name='805'></font>
<a name='806'>
    DO j = j_start, j_end<a name='807'>
    DO k = kts+1, ktf<a name='808'>
    DO i = i_start, i_end<a name='809'>
      tmp1(i,k,j) = ( hatavg(i,k,j) - hatavg(i,k-1,j) ) * zx(i,k,j) *  &amp;<a name='810'>
                    0.5 * ( rdz(i,k,j) + rdz(i-1,k,j) )<a name='811'>
    END DO<a name='812'>
    END DO<a name='813'>
    END DO<a name='814'>
<a name='815'>
<font color=#447700>! End calculation of dw/dx.<a name='816'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='817'></font>
<a name='818'>
<font color=#447700>!-----------------------------------------------------------------------<a name='819'></font>
<font color=#447700>! Add the first term (dw/dx) to defor13 (dw/dx+du/dz) at vorticity<a name='820'></font>
<font color=#447700>! points.<a name='821'></font>
<a name='822'>
    DO j = j_start, j_end<a name='823'>
    DO k = kts+1, ktf<a name='824'>
    DO i = i_start, i_end<a name='825'>
      defor13(i,k,j) = mm(i,j) * (  &amp;<a name='826'>
                       rdx * ( hat(i,k,j) - hat(i-1,k,j) ) - tmp1(i,k,j) )<a name='827'>
    END DO<a name='828'>
    END DO<a name='829'>
    END DO<a name='830'>
<a name='831'>
    DO j = j_start, j_end<a name='832'>
    DO i = i_start, i_end<a name='833'>
      defor13(i,kts,j  ) = 0.0<a name='834'>
      defor13(i,ktf+1,j) = 0.0<a name='835'>
    END DO<a name='836'>
    END DO<a name='837'>
<a name='838'>
<font color=#447700>! End addition of the first term to defor13.<a name='839'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='840'></font>
<a name='841'>
<font color=#447700>!-----------------------------------------------------------------------<a name='842'></font>
<font color=#447700>! Calculate du/dz.<a name='843'></font>
<a name='844'>
    IF ( config_flags%mix_full_fields ) THEN<a name='845'>
<a name='846'>
      DO j = j_start, j_end<a name='847'>
      DO k = kts+1, ktf<a name='848'>
      DO i = i_start, i_end<a name='849'>
        tmp1(i,k,j) = ( u(i,k,j) - u(i,k-1,j) ) *  &amp;<a name='850'>
                      0.5 * ( rdz(i,k,j) + rdz(i-1,k,j) )<a name='851'>
      END DO<a name='852'>
      END DO<a name='853'>
      END DO<a name='854'>
<a name='855'>
    ELSE<a name='856'>
<a name='857'>
      DO j = j_start, j_end<a name='858'>
      DO k = kts+1, ktf<a name='859'>
      DO i = i_start, i_end<a name='860'>
        tmp1(i,k,j) = ( u(i,k,j) - u_base(k) - u(i,k-1,j) + u_base(k-1) ) *  &amp;<a name='861'>
                      0.5 * ( rdz(i,k,j) + rdz(i-1,k,j) )<a name='862'>
      END DO<a name='863'>
      END DO<a name='864'>
      END DO<a name='865'>
<a name='866'>
    END IF<a name='867'>
<a name='868'>
<font color=#447700>!-----------------------------------------------------------------------<a name='869'></font>
<font color=#447700>! Add the second term (du/dz) to defor13 (dw/dx+du/dz) at vorticity<a name='870'></font>
<font color=#447700>! points.<a name='871'></font>
<a name='872'>
<a name='873'>
  IF ( config_flags%sfs_opt .GT. 0 ) THEN <font color=#447700>! NBA--<a name='874'></font>
<a name='875'>
<font color=#447700>!JDM____________________________________________________________________<a name='876'></font>
<font color=#447700>!<a name='877'></font>
<font color=#447700>!     s13 = du/dz +  dw/dx<a name='878'></font>
<font color=#447700>!         = du/dz + (dw/dx - dz/dx*dw/dz)<a name='879'></font>
<font color=#447700>!         = tmp1  +  ______defor13______<a name='880'></font>
<font color=#447700>!<a name='881'></font>
<font color=#447700>!     r13 = du/dz -  dw/dx<a name='882'></font>
<font color=#447700>!         = du/dz - (dw/dx - dz/dx*dw/dz)<a name='883'></font>
<font color=#447700>!         = tmp1  -  ______defor13______<a name='884'></font>
<font color=#447700>!_______________________________________________________________________<a name='885'></font>
<a name='886'>
    DO j = j_start, j_end<a name='887'>
    DO k = kts+1, ktf<a name='888'>
    DO i = i_start, i_end<a name='889'>
      nba_rij(i,k,j,P_r13) =  tmp1(i,k,j) - defor13(i,k,j)<a name='890'>
      defor13(i,k,j) = defor13(i,k,j) + tmp1(i,k,j)<a name='891'>
    END DO<a name='892'>
    END DO<a name='893'>
    END DO<a name='894'>
<a name='895'>
    DO j = j_start, j_end <font color=#447700>!change for different surface B. C.<a name='896'></font>
    DO i = i_start, i_end<a name='897'>
      nba_rij(i,kts  ,j,P_r13) = 0.0<a name='898'>
      nba_rij(i,ktf+1,j,P_r13) = 0.0<a name='899'>
    END DO<a name='900'>
    END DO<a name='901'>
<a name='902'>
  ELSE <font color=#447700>! NOT NBA--------------------------------------------------------<a name='903'></font>
<a name='904'>
    DO j = j_start, j_end<a name='905'>
    DO k = kts+1, ktf<a name='906'>
    DO i = i_start, i_end<a name='907'>
      defor13(i,k,j) = defor13(i,k,j) + tmp1(i,k,j)<a name='908'>
    END DO<a name='909'>
    END DO<a name='910'>
    END DO<a name='911'>
<a name='912'>
  ENDIF <font color=#447700>! NBA-----------------------------------------------------------<a name='913'></font>
<a name='914'>
<font color=#447700>! End addition of the second term to defor13.<a name='915'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='916'></font>
<a name='917'>
<font color=#447700>!-----------------------------------------------------------------------<a name='918'></font>
<font color=#447700>! Calculate dw/dy.<a name='919'></font>
<a name='920'>
    i_start = its<a name='921'>
    i_end   = MIN( ite, ide-1 )<a name='922'>
    j_start = jts<a name='923'>
    j_end   = MIN( jte, jde-1 )<a name='924'>
<a name='925'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='926'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='927'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='928'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='929'>
    IF ( config_flags%periodic_y ) j_end = MIN( jte, jde )<a name='930'>
      IF ( config_flags%periodic_x ) i_start = its<a name='931'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='932'>
<a name='933'>
<font color=#447700>! Square mapscale factor.<a name='934'></font>
<a name='935'>
    DO j = jts, jte<a name='936'>
    DO i = its, ite<a name='937'>
      mm(i,j) = msfvx(i,j) * msfvy(i,j)<a name='938'>
    END DO<a name='939'>
    END DO<a name='940'>
<a name='941'>
<font color=#447700>! Apply a coordinate transformation to vertical velocity, w.  Added by CW 7/19/07<a name='942'></font>
<a name='943'>
    DO j = j_start, j_end<a name='944'>
    DO k = kts, kte<a name='945'>
    DO i = i_start, i_end<a name='946'>
      hat(i,k,j) = w(i,k,j) / msftx(i,j)<a name='947'>
    END DO<a name='948'>
    END DO<a name='949'>
    END DO<a name='950'>
<a name='951'>
    i = i_start-1<a name='952'>
    DO j = j_start, MIN( jte, jde-1 )<a name='953'>
    DO k = kts, kte<a name='954'>
      hat(i,k,j) = w(i,k,j) / msftx(i,j)<a name='955'>
    END DO<a name='956'>
    END DO<a name='957'>
<a name='958'>
    j = j_start-1<a name='959'>
    DO k = kts, kte<a name='960'>
    DO i = i_start, MIN( ite, ide-1 )<a name='961'>
      hat(i,k,j) = w(i,k,j) / msftx(i,j)<a name='962'>
    END DO<a name='963'>
    END DO<a name='964'>
<a name='965'>
<font color=#447700>! QUESTION: What is this for?<a name='966'></font>
<a name='967'>
    DO j = j_start, j_end<a name='968'>
    DO k = kts, ktf<a name='969'>
    DO i = i_start, i_end<a name='970'>
      hatavg(i,k,j) = 0.25 * (  &amp;<a name='971'>
                      hat(i,k  ,j  ) +  &amp;<a name='972'>
                      hat(i,k+1,j  ) +  &amp;<a name='973'>
                      hat(i,k  ,j-1) +  &amp;<a name='974'>
                      hat(i,k+1,j-1) )<a name='975'>
    END DO<a name='976'>
    END DO<a name='977'>
    END DO<a name='978'>
<a name='979'>
<font color=#447700>! Calculate dw/dy and store in tmp1.<a name='980'></font>
<a name='981'>
    DO j = j_start, j_end<a name='982'>
    DO k = kts+1, ktf<a name='983'>
    DO i = i_start, i_end<a name='984'>
      tmp1(i,k,j) = ( hatavg(i,k,j) - hatavg(i,k-1,j) ) * zy(i,k,j) *  &amp;<a name='985'>
                    0.5 * ( rdz(i,k,j) + rdz(i,k,j-1) )<a name='986'>
    END DO<a name='987'>
    END DO<a name='988'>
    END DO<a name='989'>
<a name='990'>
<font color=#447700>! End calculation of dw/dy.<a name='991'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='992'></font>
<a name='993'>
<font color=#447700>!-----------------------------------------------------------------------<a name='994'></font>
<font color=#447700>! Add the first term (dw/dy) to defor23 (dw/dy+dv/dz) at vorticity<a name='995'></font>
<font color=#447700>! points.<a name='996'></font>
<a name='997'>
    DO j = j_start, j_end<a name='998'>
    DO k = kts+1, ktf<a name='999'>
    DO i = i_start, i_end<a name='1000'>
      defor23(i,k,j) = mm(i,j) * (  &amp;<a name='1001'>
                       rdy * ( hat(i,k,j) - hat(i,k,j-1) ) - tmp1(i,k,j) )<a name='1002'>
    END DO<a name='1003'>
    END DO<a name='1004'>
    END DO<a name='1005'>
<a name='1006'>
    DO j = j_start, j_end<a name='1007'>
    DO i = i_start, i_end<a name='1008'>
      defor23(i,kts,j  ) = 0.0<a name='1009'>
      defor23(i,ktf+1,j) = 0.0<a name='1010'>
    END DO<a name='1011'>
    END DO<a name='1012'>
<a name='1013'>
<font color=#447700>! End addition of the first term to defor23.<a name='1014'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1015'></font>
<a name='1016'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1017'></font>
<font color=#447700>! Calculate dv/dz.<a name='1018'></font>
<a name='1019'>
    IF ( config_flags%mix_full_fields ) THEN<a name='1020'>
<a name='1021'>
      DO j = j_start, j_end<a name='1022'>
      DO k = kts+1, ktf<a name='1023'>
      DO i = i_start, i_end<a name='1024'>
        tmp1(i,k,j) = ( v(i,k,j) - v(i,k-1,j) ) *  &amp;<a name='1025'>
                      0.5 * ( rdz(i,k,j) + rdz(i,k,j-1) )<a name='1026'>
      END DO<a name='1027'>
      END DO<a name='1028'>
      END DO<a name='1029'>
<a name='1030'>
    ELSE<a name='1031'>
<a name='1032'>
      DO j = j_start, j_end<a name='1033'>
      DO k = kts+1, ktf<a name='1034'>
      DO i = i_start, i_end<a name='1035'>
        tmp1(i,k,j) = ( v(i,k,j) - v_base(k) - v(i,k-1,j) + v_base(k-1) ) *  &amp;<a name='1036'>
                      0.5 * ( rdz(i,k,j) + rdz(i,k,j-1) )<a name='1037'>
      END DO<a name='1038'>
      END DO<a name='1039'>
      END DO<a name='1040'>
<a name='1041'>
    END IF<a name='1042'>
<a name='1043'>
<font color=#447700>! End calculation of dv/dz.<a name='1044'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1045'></font>
<a name='1046'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1047'></font>
<font color=#447700>! Add the second term (dv/dz) to defor23 (dw/dy+dv/dz) at vorticity<a name='1048'></font>
<font color=#447700>! points.<a name='1049'></font>
<a name='1050'>
  IF ( config_flags%sfs_opt .GT. 0 ) THEN <font color=#447700>! NBA--<a name='1051'></font>
<a name='1052'>
<font color=#447700>!JDM___________________________________________________________________<a name='1053'></font>
<font color=#447700>!<a name='1054'></font>
<font color=#447700>!     s23 = dv/dz +  dw/dy<a name='1055'></font>
<font color=#447700>!         = dv/dz + (dw/dy - dz/dy*dw/dz)<a name='1056'></font>
<font color=#447700>!           tmp1  +  ______defor23______<a name='1057'></font>
<font color=#447700>!<a name='1058'></font>
<font color=#447700>!     r23 = dv/dz -  dw/dy<a name='1059'></font>
<font color=#447700>!         = dv/dz - (dw/dy - dz/dy*dw/dz)<a name='1060'></font>
<font color=#447700>!         = tmp1  -  ______defor23______<a name='1061'></font>
<a name='1062'>
<font color=#447700>! Add tmp1 to defor23.<a name='1063'></font>
<a name='1064'>
    DO j = j_start, j_end<a name='1065'>
    DO k = kts+1, ktf<a name='1066'>
    DO i = i_start, i_end<a name='1067'>
      nba_rij(i,k,j,P_r23) = tmp1(i,k,j) - defor23(i,k,j)<a name='1068'>
      defor23(i,k,j) = defor23(i,k,j) + tmp1(i,k,j)<a name='1069'>
    END DO<a name='1070'>
    END DO<a name='1071'>
    END DO<a name='1072'>
<a name='1073'>
    DO j = j_start, j_end<a name='1074'>
      DO i = i_start, i_end<a name='1075'>
        nba_rij(i,kts  ,j,P_r23) = 0.0<a name='1076'>
        nba_rij(i,ktf+1,j,P_r23) = 0.0<a name='1077'>
      END DO<a name='1078'>
    END DO<a name='1079'>
<a name='1080'>
<font color=#447700>! End addition of the second term to defor23.<a name='1081'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1082'></font>
<a name='1083'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1084'></font>
<font color=#447700>! Update the boundary for defor13 and defor23 (might need to change<a name='1085'></font>
<font color=#447700>! later).<a name='1086'></font>
<a name='1087'>
    IF ( .NOT. config_flags%periodic_x .AND. i_start .EQ. ids+1) THEN<a name='1088'>
      DO j = jts, jte<a name='1089'>
      DO k = kts, kte<a name='1090'>
        defor13(ids,k,j) = defor13(ids+1,k,j)<a name='1091'>
        defor23(ids,k,j) = defor23(ids+1,k,j)<a name='1092'>
        nba_rij(ids,k,j,P_r13) = nba_rij(ids+1,k,j,P_r13)<a name='1093'>
        nba_rij(ids,k,j,P_r23) = nba_rij(ids+1,k,j,P_r23)<a name='1094'>
      END DO<a name='1095'>
      END DO<a name='1096'>
    END IF<a name='1097'>
<a name='1098'>
    IF ( .NOT. config_flags%periodic_y .AND. j_start .EQ. jds+1) THEN<a name='1099'>
      DO k = kts, kte<a name='1100'>
      DO i = its, ite<a name='1101'>
        defor13(i,k,jds) = defor13(i,k,jds+1)<a name='1102'>
        defor23(i,k,jds) = defor23(i,k,jds+1)<a name='1103'>
        nba_rij(i,k,jds,P_r13) = nba_rij(i,k,jds+1,P_r13)<a name='1104'>
        nba_rij(i,k,jds,P_r23) = nba_rij(i,k,jds+1,P_r23)<a name='1105'>
      END DO<a name='1106'>
      END DO<a name='1107'>
    END IF<a name='1108'>
<a name='1109'>
    IF ( .NOT. config_flags%periodic_x .AND. i_end .EQ. ide-1) THEN<a name='1110'>
      DO j = jts, jte<a name='1111'>
      DO k = kts, kte<a name='1112'>
        defor13(ide,k,j) = defor13(ide-1,k,j)<a name='1113'>
        defor23(ide,k,j) = defor23(ide-1,k,j)<a name='1114'>
        nba_rij(ide,k,j,P_r13) = nba_rij(ide-1,k,j,P_r13)<a name='1115'>
        nba_rij(ide,k,j,P_r23) = nba_rij(ide-1,k,j,P_r23)<a name='1116'>
      END DO<a name='1117'>
      END DO<a name='1118'>
    END IF<a name='1119'>
<a name='1120'>
    IF ( .NOT. config_flags%periodic_y .AND. j_end .EQ. jde-1) THEN<a name='1121'>
      DO k = kts, kte<a name='1122'>
      DO i = its, ite<a name='1123'>
        defor13(i,k,jde) = defor13(i,k,jde-1)<a name='1124'>
        defor23(i,k,jde) = defor23(i,k,jde-1)<a name='1125'>
        nba_rij(i,k,jde,P_r13) = nba_rij(i,k,jde-1,P_r13)<a name='1126'>
        nba_rij(i,k,jde,P_r23) = nba_rij(i,k,jde-1,P_r23)<a name='1127'>
      END DO<a name='1128'>
      END DO<a name='1129'>
    END IF<a name='1130'>
<a name='1131'>
  ELSE <font color=#447700>! NOT NBA--------------------------------------------------------<a name='1132'></font>
<a name='1133'>
<font color=#447700>! Add tmp1 to defor23.<a name='1134'></font>
<a name='1135'>
    DO j = j_start, j_end<a name='1136'>
    DO k = kts+1, ktf<a name='1137'>
    DO i = i_start, i_end<a name='1138'>
      defor23(i,k,j) = defor23(i,k,j) + tmp1(i,k,j)<a name='1139'>
    END DO<a name='1140'>
    END DO<a name='1141'>
    END DO<a name='1142'>
<a name='1143'>
<font color=#447700>! End addition of the second term to defor23.<a name='1144'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1145'></font>
<a name='1146'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1147'></font>
<font color=#447700>! Update the boundary for defor13 and defor23 (might need to change<a name='1148'></font>
<font color=#447700>! later).<a name='1149'></font>
<a name='1150'>
    IF ( .NOT. config_flags%periodic_x .AND. i_start .EQ. ids+1) THEN<a name='1151'>
      DO j = jts, jte<a name='1152'>
      DO k = kts, kte<a name='1153'>
        defor13(ids,k,j) = defor13(ids+1,k,j)<a name='1154'>
        defor23(ids,k,j) = defor23(ids+1,k,j)<a name='1155'>
      END DO<a name='1156'>
      END DO<a name='1157'>
    END IF<a name='1158'>
<a name='1159'>
    IF ( .NOT. config_flags%periodic_y .AND. j_start .EQ. jds+1) THEN<a name='1160'>
      DO k = kts, kte<a name='1161'>
      DO i = its, ite<a name='1162'>
        defor13(i,k,jds) = defor13(i,k,jds+1)<a name='1163'>
        defor23(i,k,jds) = defor23(i,k,jds+1)<a name='1164'>
      END DO<a name='1165'>
      END DO<a name='1166'>
    END IF<a name='1167'>
<a name='1168'>
    IF ( .NOT. config_flags%periodic_x .AND. i_end .EQ. ide-1) THEN<a name='1169'>
      DO j = jts, jte<a name='1170'>
      DO k = kts, kte<a name='1171'>
        defor13(ide,k,j) = defor13(ide-1,k,j)<a name='1172'>
        defor23(ide,k,j) = defor23(ide-1,k,j)<a name='1173'>
      END DO<a name='1174'>
      END DO<a name='1175'>
    END IF<a name='1176'>
<a name='1177'>
    IF ( .NOT. config_flags%periodic_y .AND. j_end .EQ. jde-1) THEN<a name='1178'>
      DO k = kts, kte<a name='1179'>
      DO i = its, ite<a name='1180'>
        defor13(i,k,jde) = defor13(i,k,jde-1)<a name='1181'>
        defor23(i,k,jde) = defor23(i,k,jde-1)<a name='1182'>
      END DO<a name='1183'>
      END DO<a name='1184'>
    END IF<a name='1185'>
<a name='1186'>
  ENDIF <font color=#447700>! NBA-----------------------------------------------------------<a name='1187'></font>
<a name='1188'>
<font color=#447700>! End update of boundary for defor13 and defor23.<a name='1189'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1190'></font>
<a name='1191'>
<font color=#447700>! The second three (defor12, defor13, defor23) of six deformation terms<a name='1192'></font>
<font color=#447700>! are now calculated at vorticity points.<a name='1193'></font>
<font color=#447700>!=======================================================================<a name='1194'></font>
<a name='1195'>
    END SUBROUTINE cal_deform_and_div<a name='1196'>
<a name='1197'>
<font color=#447700>!=======================================================================<a name='1198'></font>
<font color=#447700>!=======================================================================<a name='1199'></font>
<a name='1200'>
<A NAME='CALCULATE_KM_KH'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1201'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>calculate_km_kh</font>( config_flags, dt,                        &amp; <A href='../../call_to/CALCULATE_KM_KH.html' TARGET='index'>1</A>,<A href='../../call_from/CALCULATE_KM_KH.html' TARGET='index'>7</A><a name='1202'>
                                dampcoef, zdamp, damp_opt,               &amp;<a name='1203'>
                                xkmh, xkmv, xkhh, xkhv,                  &amp;<a name='1204'>
                                BN2, khdif, kvdif, div,                  &amp;<a name='1205'>
                                defor11, defor22, defor33,               &amp;<a name='1206'>
                                defor12, defor13, defor23,               &amp;<a name='1207'>
                                tke, p8w, t8w, theta, t, p, moist,       &amp;<a name='1208'>
                                dn, dnw, dx, dy, rdz, rdzw, isotropic,   &amp;<a name='1209'>
                                n_moist, cf1, cf2, cf3, warm_rain,       &amp;<a name='1210'>
                                mix_upper_bound,                         &amp;<a name='1211'>
                                msftx, msfty,                            &amp;<a name='1212'>
                                zx, zy,                                  &amp;<a name='1213'>
                                ids, ide, jds, jde, kds, kde,            &amp;<a name='1214'>
                                ims, ime, jms, jme, kms, kme,            &amp;<a name='1215'>
                                its, ite, jts, jte, kts, kte             )<a name='1216'>
<a name='1217'>
<font color=#447700>! History:     Sep 2003  Changes by George Bryan and Jason Knievel, NCAR<a name='1218'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='1219'></font>
<font color=#447700>!              ...       ...<a name='1220'></font>
<a name='1221'>
<font color=#447700>! Purpose:     This routine calculates exchange coefficients for the TKE<a name='1222'></font>
<font color=#447700>!              scheme.<a name='1223'></font>
<a name='1224'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='1225'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='1226'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='1227'></font>
<a name='1228'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1229'></font>
<font color=#447700>! Begin declarations.<a name='1230'></font>
<a name='1231'>
    IMPLICIT NONE<a name='1232'>
<a name='1233'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='1234'>
    :: config_flags<a name='1235'>
<a name='1236'>
    INTEGER, INTENT( IN )  &amp;<a name='1237'>
    :: n_moist, damp_opt, isotropic,  &amp;<a name='1238'>
       ids, ide, jds, jde, kds, kde,  &amp;<a name='1239'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='1240'>
       its, ite, jts, jte, kts, kte<a name='1241'>
<a name='1242'>
    LOGICAL, INTENT( IN )  &amp;<a name='1243'>
    :: warm_rain<a name='1244'>
<a name='1245'>
    REAL, INTENT( IN )  &amp;<a name='1246'>
    :: dx, dy, zdamp, dt, dampcoef, cf1, cf2, cf3, khdif, kvdif<a name='1247'>
<a name='1248'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='1249'>
    :: dnw, dn<a name='1250'>
<a name='1251'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme, n_moist ), INTENT( INOUT )  &amp;<a name='1252'>
    :: moist<a name='1253'>
<a name='1254'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='1255'>
    :: xkmv, xkmh, xkhv, xkhh, BN2<a name='1256'>
<a name='1257'>
    REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),  INTENT( IN )  &amp;<a name='1258'>
    :: defor11, defor22, defor33, defor12, defor13, defor23,      &amp;<a name='1259'>
       div, rdz, rdzw, p8w, t8w, theta, t, p, zx, zy<a name='1260'>
<a name='1261'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='1262'>
    :: tke<a name='1263'>
<a name='1264'>
    REAL, INTENT( IN )  &amp;<a name='1265'>
    :: mix_upper_bound<a name='1266'>
<a name='1267'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='1268'>
    :: msftx, msfty<a name='1269'>
<a name='1270'>
<font color=#447700>! Local variables.<a name='1271'></font>
<a name='1272'>
    INTEGER  &amp;<a name='1273'>
    :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='1274'>
<a name='1275'>
<font color=#447700>! End declarations.<a name='1276'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1277'></font>
<a name='1278'>
    ktf     = MIN( kte, kde-1 )<a name='1279'>
    i_start = its<a name='1280'>
    i_end   = MIN( ite, ide-1 )<a name='1281'>
    j_start = jts<a name='1282'>
    j_end   = MIN( jte, jde-1 )<a name='1283'>
<a name='1284'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_N2'>calculate_N2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_N2_1">( config_flags, BN2, moist,           &amp;<a name='1285'>
                       theta, t, p, p8w, t8w,              &amp;<a name='1286'>
                       dnw, dn, rdz, rdzw,                 &amp;<a name='1287'>
                       n_moist, cf1, cf2, cf3, warm_rain,  &amp;<a name='1288'>
                       ids, ide, jds, jde, kds, kde,       &amp;<a name='1289'>
                       ims, ime, jms, jme, kms, kme,       &amp;<a name='1290'>
                       its, ite, jts, jte, kts, kte        )<a name='1291'>
<a name='1292'>
<font color=#447700>! Select a scheme for calculating diffusion coefficients.<a name='1293'></font>
<a name='1294'>
    km_coef: SELECT CASE( config_flags%km_opt )<a name='1295'>
<a name='1296'>
      CASE (1)<a name='1297'>
            CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#ISOTROPIC_KM'>isotropic_km</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ISOTROPIC_KM_1">( config_flags, xkmh, xkmv,                &amp;<a name='1298'>
                               xkhh, xkhv, khdif, kvdif,                &amp;<a name='1299'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='1300'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='1301'>
                               its, ite, jts, jte, kts, kte             )<a name='1302'>
      CASE (2)<a name='1303'>
            CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_KM'>tke_km</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_KM_1">(       config_flags, xkmh, xkmv,                &amp;<a name='1304'>
                               xkhh, xkhv, BN2, tke, p8w, t8w, theta,   &amp;<a name='1305'>
                               rdz, rdzw, dx, dy, dt, isotropic,        &amp;<a name='1306'>
                               mix_upper_bound, msftx, msfty,           &amp;<a name='1307'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='1308'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='1309'>
                               its, ite, jts, jte, kts, kte             )<a name='1310'>
      CASE (3)<a name='1311'>
            CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG_KM'>smag_km</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMAG_KM_1">(      config_flags, xkmh, xkmv,                &amp;<a name='1312'>
                               xkhh, xkhv, BN2, div,                    &amp;<a name='1313'>
                               defor11, defor22, defor33,               &amp;<a name='1314'>
                               defor12, defor13, defor23,               &amp;<a name='1315'>
                               rdzw, dx, dy, dt, isotropic,             &amp;<a name='1316'>
                               mix_upper_bound, msftx, msfty,           &amp;<a name='1317'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='1318'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='1319'>
                               its, ite, jts, jte, kts, kte             )<a name='1320'>
      CASE (4)<a name='1321'>
            CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG2D_KM'>smag2d_km</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMAG2D_KM_1">(    config_flags, xkmh, xkmv,                &amp;<a name='1322'>
                               xkhh, xkhv, defor11, defor22, defor12,   &amp;<a name='1323'>
                               rdzw, dx, dy, msftx, msfty,              &amp;<a name='1324'>
                               zx, zy,                                  &amp;<a name='1325'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='1326'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='1327'>
                               its, ite, jts, jte, kts, kte             )<a name='1328'>
      CASE DEFAULT<a name='1329'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_15">( 'Please choose diffusion coefficient scheme' )<a name='1330'>
<a name='1331'>
    END SELECT km_coef<a name='1332'>
<a name='1333'>
    IF ( damp_opt .eq. 1 ) THEN<a name='1334'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_DAMPKM'>cal_dampkm</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_KM_KH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_DAMPKM_1">( config_flags, xkmh, xkhh, xkmv, xkhv,    &amp;<a name='1335'>
                       dx, dy, dt, dampcoef, rdz, rdzw, zdamp,  &amp;<a name='1336'>
                       msftx, msfty,                            &amp;<a name='1337'>
                       ids, ide, jds, jde, kds, kde,            &amp;<a name='1338'>
                       ims, ime, jms, jme, kms, kme,            &amp;<a name='1339'>
                       its, ite, jts, jte, kts, kte             )<a name='1340'>
    END IF<a name='1341'>
<a name='1342'>
    END SUBROUTINE calculate_km_kh<a name='1343'>
<a name='1344'>
<font color=#447700>!=======================================================================<a name='1345'></font>
<a name='1346'>
<A NAME='CAL_DAMPKM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_DAMPKM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1347'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_dampkm</font>( config_flags,xkmh,xkhh,xkmv,xkhv,                       &amp; <A href='../../call_to/CAL_DAMPKM.html' TARGET='index'>1</A><a name='1348'>
                       dx,dy,dt,dampcoef,                                      &amp;<a name='1349'>
                       rdz, rdzw ,zdamp,                                       &amp;<a name='1350'>
                       msftx, msfty,                                           &amp;<a name='1351'>
                       ids,ide, jds,jde, kds,kde,                              &amp;<a name='1352'>
                       ims,ime, jms,jme, kms,kme,                              &amp;<a name='1353'>
                       its,ite, jts,jte, kts,kte                              )<a name='1354'>
<a name='1355'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1356'></font>
<font color=#447700>! Begin declarations.<a name='1357'></font>
<a name='1358'>
   IMPLICIT NONE<a name='1359'>
<a name='1360'>
   TYPE(grid_config_rec_type) , INTENT(IN   ) :: config_flags<a name='1361'>
<a name='1362'>
   INTEGER ,          INTENT(IN   )           :: ids, ide, jds, jde, kds, kde, &amp;<a name='1363'>
                                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1364'>
                                                 its, ite, jts, jte, kts, kte<a name='1365'>
<a name='1366'>
   REAL    ,          INTENT(IN   )           :: zdamp,dx,dy,dt,dampcoef<a name='1367'>
<a name='1368'>
<a name='1369'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT)    ::     xkmh , &amp;<a name='1370'>
                                                                         xkhh , &amp;<a name='1371'>
                                                                         xkmv , &amp;<a name='1372'>
                                                                         xkhv<a name='1373'>
<a name='1374'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   )    ::     rdz,   &amp;<a name='1375'>
                                                                         rdzw<a name='1376'>
<a name='1377'>
   REAL , DIMENSION( ims:ime, jms:jme), INTENT(IN   )             ::     msftx, &amp;<a name='1378'>
                                                                         msfty<a name='1379'>
<font color=#447700>! LOCAL VARS<a name='1380'></font>
<a name='1381'>
   INTEGER :: i_start, i_end, j_start, j_end, ktf, ktfm1, i, j, k<a name='1382'>
   REAL    :: kmmax,kmmvmax,degrad90,dz,tmp<a name='1383'>
   REAL    :: ds<a name='1384'>
   REAL ,     DIMENSION( its:ite )                                ::   deltaz<a name='1385'>
   REAL , DIMENSION( its:ite, kts:kte, jts:jte)                   ::   dampk,dampkv<a name='1386'>
<a name='1387'>
<font color=#447700>! End declarations.<a name='1388'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1389'></font>
<a name='1390'>
   ktf = min(kte,kde-1)<a name='1391'>
   ktfm1 = ktf-1<a name='1392'>
<a name='1393'>
   i_start = its<a name='1394'>
   i_end   = MIN(ite,ide-1)<a name='1395'>
   j_start = jts<a name='1396'>
   j_end   = MIN(jte,jde-1)<a name='1397'>
<a name='1398'>
<font color=#447700>! keep upper damping diffusion away from relaxation zones at boundaries if used<a name='1399'></font>
   IF(config_flags%specified .OR. config_flags%nested)THEN<a name='1400'>
     i_start = MAX(i_start,ids+config_flags%spec_bdy_width-1)<a name='1401'>
     i_end   = MIN(i_end,ide-config_flags%spec_bdy_width)<a name='1402'>
     j_start = MAX(j_start,jds+config_flags%spec_bdy_width-1)<a name='1403'>
     j_end   = MIN(j_end,jde-config_flags%spec_bdy_width)<a name='1404'>
   ENDIF<a name='1405'>
<a name='1406'>
   kmmax=dx*dx/dt<a name='1407'>
   degrad90=DEGRAD*90.<a name='1408'>
   DO j = j_start, j_end<a name='1409'>
<a name='1410'>
      k=ktf<a name='1411'>
      DO i = i_start, i_end<a name='1412'>
         <font color=#447700>! Unmodified dx used above may produce very large diffusivities<a name='1413'></font>
         <font color=#447700>! when msftx is very large.  And the above formula ignores the fact<a name='1414'></font>
         <font color=#447700>! that dy may now be different from dx as well.  Let's fix that by<a name='1415'></font>
         <font color=#447700>! defining a "ds" as the minimum of the "real-space" (physical<a name='1416'></font>
         <font color=#447700>! distance) values of dx and dy, and then using that smallest value<a name='1417'></font>
         <font color=#447700>! to calculate a point-by-point kmmax<a name='1418'></font>
         ds = MIN(dx/msftx(i,j),dy/msfty(i,j))<a name='1419'>
         kmmax=ds*ds/dt<a name='1420'>
<a name='1421'>
<font color=#447700>!         deltaz(i)=0.5*dnw(k)/zeta_z(i,j)<a name='1422'></font>
<font color=#447700>!         dz=dnw(k)/zeta_z(i,j)<a name='1423'></font>
         dz = 1./rdzw(i,k,j)<a name='1424'>
         deltaz(i) = 0.5*dz<a name='1425'>
<a name='1426'>
         kmmvmax=dz*dz/dt<a name='1427'>
         tmp=min(deltaz(i)/zdamp,1.)<a name='1428'>
         dampk(i,k,j)=cos(degrad90*tmp)*cos(degrad90*tmp)*kmmax*dampcoef<a name='1429'>
         dampkv(i,k,j)=cos(degrad90*tmp)*cos(degrad90*tmp)*kmmvmax*dampcoef<a name='1430'>
<font color=#447700>! set upper limit on vertical K (based on horizontal K)<a name='1431'></font>
         dampkv(i,k,j)=min(dampkv(i,k,j),dampk(i,k,j))<a name='1432'>
<a name='1433'>
      ENDDO<a name='1434'>
<a name='1435'>
      DO k = ktfm1,kts,-1<a name='1436'>
      DO i = i_start, i_end<a name='1437'>
         <font color=#447700>! Unmodified dx used above may produce very large diffusivities<a name='1438'></font>
         <font color=#447700>! when msftx is very large.  And the above formula ignores the fact<a name='1439'></font>
         <font color=#447700>! that dy may now be different from dx as well.  Let's fix that by<a name='1440'></font>
         <font color=#447700>! defining a "ds" as the minimum of the "real-space" (physical<a name='1441'></font>
         <font color=#447700>! distance) values of dx and dy, and then using that smallest value<a name='1442'></font>
         <font color=#447700>! to calculate a point-by-point kmmax<a name='1443'></font>
         ds = MIN(dx/msftx(i,j),dy/msfty(i,j))<a name='1444'>
         kmmax=ds*ds/dt<a name='1445'>
<a name='1446'>
<font color=#447700>!         deltaz(i)=deltaz(i)+dn(k)/zeta_z(i,j)<a name='1447'></font>
<font color=#447700>!         dz=dnw(k)/zeta_z(i,j)<a name='1448'></font>
         dz = 1./rdz(i,k,j)<a name='1449'>
         deltaz(i) = deltaz(i) + dz<a name='1450'>
         dz = 1./rdzw(i,k,j)<a name='1451'>
<a name='1452'>
         kmmvmax=dz*dz/dt<a name='1453'>
         tmp=min(deltaz(i)/zdamp,1.)<a name='1454'>
         dampk(i,k,j)=cos(degrad90*tmp)*cos(degrad90*tmp)*kmmax*dampcoef<a name='1455'>
         dampkv(i,k,j)=cos(degrad90*tmp)*cos(degrad90*tmp)*kmmvmax*dampcoef<a name='1456'>
<font color=#447700>! set upper limit on vertical K (based on horizontal K)<a name='1457'></font>
         dampkv(i,k,j)=min(dampkv(i,k,j),dampk(i,k,j))<a name='1458'>
      ENDDO<a name='1459'>
      ENDDO<a name='1460'>
<a name='1461'>
   ENDDO<a name='1462'>
<a name='1463'>
   DO j = j_start, j_end<a name='1464'>
   DO k = kts,ktf<a name='1465'>
   DO i = i_start, i_end<a name='1466'>
      xkmh(i,k,j)=max(xkmh(i,k,j),dampk(i,k,j))<a name='1467'>
      xkhh(i,k,j)=max(xkhh(i,k,j),dampk(i,k,j))<a name='1468'>
      xkmv(i,k,j)=max(xkmv(i,k,j),dampkv(i,k,j))<a name='1469'>
      xkhv(i,k,j)=max(xkhv(i,k,j),dampkv(i,k,j))<a name='1470'>
   ENDDO<a name='1471'>
   ENDDO<a name='1472'>
   ENDDO<a name='1473'>
<a name='1474'>
END SUBROUTINE cal_dampkm<a name='1475'>
<a name='1476'>
<font color=#447700>!=======================================================================<a name='1477'></font>
<font color=#447700>!=======================================================================<a name='1478'></font>
<a name='1479'>
<A NAME='CALCULATE_N2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_N2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1480'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>calculate_N2</font>( config_flags, BN2, moist,           &amp; <A href='../../call_to/CALCULATE_N2.html' TARGET='index'>1</A>,<A href='../../call_from/CALCULATE_N2.html' TARGET='index'>3</A><a name='1481'>
                             theta, t, p, p8w, t8w,              &amp;<a name='1482'>
                             dnw, dn, rdz, rdzw,                 &amp;<a name='1483'>
                             n_moist, cf1, cf2, cf3, warm_rain,  &amp;<a name='1484'>
                             ids, ide, jds, jde, kds, kde,       &amp;<a name='1485'>
                             ims, ime, jms, jme, kms, kme,       &amp;<a name='1486'>
                             its, ite, jts, jte, kts, kte        )<a name='1487'>
<a name='1488'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1489'></font>
<font color=#447700>! Begin declarations.<a name='1490'></font>
<a name='1491'>
    IMPLICIT NONE<a name='1492'>
<a name='1493'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='1494'>
    :: config_flags<a name='1495'>
<a name='1496'>
    INTEGER, INTENT( IN )  &amp;<a name='1497'>
    :: n_moist,  &amp;<a name='1498'>
       ids, ide, jds, jde, kds, kde, &amp;<a name='1499'>
       ims, ime, jms, jme, kms, kme, &amp;<a name='1500'>
       its, ite, jts, jte, kts, kte<a name='1501'>
<a name='1502'>
    LOGICAL, INTENT( IN )  &amp;<a name='1503'>
    :: warm_rain<a name='1504'>
<a name='1505'>
    REAL, INTENT( IN )  &amp;<a name='1506'>
    :: cf1, cf2, cf3<a name='1507'>
<a name='1508'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='1509'>
    :: BN2<a name='1510'>
<a name='1511'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='1512'>
    :: rdz, rdzw, theta, t, p, p8w, t8w<a name='1513'>
<a name='1514'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='1515'>
    :: dnw, dn<a name='1516'>
<a name='1517'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme, n_moist), INTENT( INOUT )  &amp;<a name='1518'>
    :: moist<a name='1519'>
<a name='1520'>
<font color=#447700>! Local variables.<a name='1521'></font>
<a name='1522'>
    INTEGER  &amp;<a name='1523'>
    :: i, j, k, ktf, ispe, ktes1, ktes2,  &amp;<a name='1524'>
       i_start, i_end, j_start, j_end<a name='1525'>
<a name='1526'>
    REAL  &amp;<a name='1527'>
    :: coefa, thetaep1, thetaem1, qc_cr, es, tc, qlpqi, qsw, qsi,  &amp;<a name='1528'>
       tmpdz, xlvqv, thetaesfc, thetasfc, qvtop, qvsfc, thetatop, thetaetop<a name='1529'>
<a name='1530'>
    REAL, DIMENSION( its:ite, jts:jte )  &amp;<a name='1531'>
    :: tmp1sfc, tmp1top<a name='1532'>
<a name='1533'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='1534'>
    :: tmp1, qvs, qctmp<a name='1535'>
<a name='1536'>
<font color=#447700>! End declarations.<a name='1537'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1538'></font>
<a name='1539'>
    qc_cr   = 0.00001  <font color=#447700>! in Kg/Kg<a name='1540'></font>
<a name='1541'>
    ktf     = MIN( kte, kde-1 )<a name='1542'>
    ktes1   = kte-1<a name='1543'>
    ktes2   = kte-2<a name='1544'>
<a name='1545'>
    i_start = its<a name='1546'>
    i_end   = MIN( ite, ide-1 )<a name='1547'>
    j_start = jts<a name='1548'>
    j_end   = MIN( jte, jde-1 )<a name='1549'>
<a name='1550'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='1551'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='1552'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='1553'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='1554'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='1555'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='1556'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='1557'>
         config_flags%nested) j_end   = MIN( jde-2 ,jte )<a name='1558'>
      IF ( config_flags%periodic_x ) i_start = its<a name='1559'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='1560'>
<a name='1561'>
    IF ( P_QC .GT. PARAM_FIRST_SCALAR) THEN<a name='1562'>
      DO j = j_start, j_end<a name='1563'>
      DO k = kts, ktf<a name='1564'>
      DO i = i_start, i_end<a name='1565'>
        qctmp(i,k,j) = moist(i,k,j,P_QC)<a name='1566'>
      END DO<a name='1567'>
      END DO<a name='1568'>
      END DO<a name='1569'>
    ELSE<a name='1570'>
      DO j = j_start, j_end<a name='1571'>
      DO k = kts, ktf<a name='1572'>
      DO i = i_start, i_end<a name='1573'>
         qctmp(i,k,j) = 0.0<a name='1574'>
      END DO<a name='1575'>
      END DO<a name='1576'>
      END DO<a name='1577'>
    END IF<a name='1578'>
<a name='1579'>
    DO j = jts, jte<a name='1580'>
    DO k = kts, kte<a name='1581'>
    DO i = its, ite<a name='1582'>
      tmp1(i,k,j) = 0.0<a name='1583'>
    END DO<a name='1584'>
    END DO<a name='1585'>
    END DO<a name='1586'>
<a name='1587'>
    DO j = jts,jte<a name='1588'>
    DO i = its,ite<a name='1589'>
      tmp1sfc(i,j) = 0.0<a name='1590'>
      tmp1top(i,j) = 0.0<a name='1591'>
    END DO<a name='1592'>
    END DO<a name='1593'>
<a name='1594'>
    DO ispe = PARAM_FIRST_SCALAR, n_moist<a name='1595'>
      IF ( ispe .EQ. P_QV .OR. ispe .EQ. P_QC .OR. ispe .EQ. P_QI) THEN<a name='1596'>
        DO j = j_start, j_end<a name='1597'>
        DO k = kts, ktf<a name='1598'>
        DO i = i_start, i_end<a name='1599'>
          tmp1(i,k,j) = tmp1(i,k,j) + moist(i,k,j,ispe)<a name='1600'>
        END DO<a name='1601'>
        END DO<a name='1602'>
        END DO<a name='1603'>
<a name='1604'>
        DO j = j_start, j_end<a name='1605'>
        DO i = i_start, i_end<a name='1606'>
          tmp1sfc(i,j) = tmp1sfc(i,j) +  &amp;<a name='1607'>
                         cf1 * moist(i,1,j,ispe) +  &amp;<a name='1608'>
                         cf2 * moist(i,2,j,ispe) +  &amp;<a name='1609'>
                         cf3 * moist(i,3,j,ispe)<a name='1610'>
          tmp1top(i,j) = tmp1top(i,j) +  &amp;<a name='1611'>
                         moist(i,ktes1,j,ispe) + &amp;<a name='1612'>
                         ( moist(i,ktes1,j,ispe) - moist(i,ktes2,j,ispe) ) *  &amp;<a name='1613'>
                         0.5 * dnw(ktes1) / dn(ktes1)<a name='1614'>
        END DO<a name='1615'>
        END DO<a name='1616'>
      END IF<a name='1617'>
    END DO<a name='1618'>
<a name='1619'>
<font color=#447700>! Calculate saturation mixing ratio.<a name='1620'></font>
<a name='1621'>
    DO j = j_start, j_end<a name='1622'>
    DO k = kts, ktf<a name='1623'>
    DO i = i_start, i_end<a name='1624'>
      tc         = t(i,k,j) - SVPT0<a name='1625'>
      es         = 1000.0 * SVP1 * EXP( SVP2 * tc / ( t(i,k,j) - SVP3 ) )<a name='1626'>
      qvs(i,k,j) = EP_2 * es / ( p(i,k,j) - es )<a name='1627'>
    END DO<a name='1628'>
    END DO<a name='1629'>
    END DO<a name='1630'>
<a name='1631'>
    DO j = j_start, j_end<a name='1632'>
    DO k = kts+1, ktf-1<a name='1633'>
    DO i = i_start, i_end<a name='1634'>
      tmpdz = 1.0 / rdz(i,k,j) + 1.0 / rdz(i,k+1,j)<a name='1635'>
      IF ( moist(i,k,j,P_QV) .GE. qvs(i,k,j) .OR. qctmp(i,k,j) .GE. qc_cr) THEN<a name='1636'>
        xlvqv      = XLV * moist(i,k,j,P_QV)<a name='1637'>
        coefa      = ( 1.0 + xlvqv / R_d / t(i,k,j) ) / &amp;<a name='1638'>
                     ( 1.0 + XLV * xlvqv / Cp / R_v / t(i,k,j) / t(i,k,j) ) /  &amp;<a name='1639'>
                     theta(i,k,j)<a name='1640'>
        thetaep1   = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_N2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_1">(i,k+1,j) *  &amp;<a name='1641'>
                     ( 1.0 + XLV * qvs(i,k+1,j) / Cp / t(i,k+1,j) )<a name='1642'>
        thetaem1   = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_N2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_2">(i,k-1,j) *  &amp;<a name='1643'>
                     ( 1.0 + XLV * qvs(i,k-1,j) / Cp / t(i,k-1,j) )<a name='1644'>
        BN2(i,k,j) = g * ( coefa * ( thetaep1 - thetaem1 ) / tmpdz -  &amp;<a name='1645'>
                     ( tmp1(i,k+1,j) - tmp1(i,k-1,j) ) / tmpdz )<a name='1646'>
      ELSE<a name='1647'>
        BN2(i,k,j) = g * ( (theta(i,k+1,j) - theta(i,k-1,j) ) /  &amp;<a name='1648'>
                     theta(i,k,j) / tmpdz +  &amp;<a name='1649'>
                     1.61 * ( moist(i,k+1,j,P_QV) - moist(i,k-1,j,P_QV) ) / &amp;<a name='1650'>
                     tmpdz -   &amp;<a name='1651'>
                     ( tmp1(i,k+1,j) - tmp1(i,k-1,j) ) / tmpdz )<a name='1652'>
      ENDIF<a name='1653'>
    END DO<a name='1654'>
    END DO<a name='1655'>
    END DO<a name='1656'>
<a name='1657'>
    k = kts<a name='1658'>
    DO j = j_start, j_end<a name='1659'>
    DO i = i_start, i_end<a name='1660'>
      tmpdz     = 1.0 / rdz(i,k+1,j) + 0.5 / rdzw(i,k,j)<a name='1661'>
      thetasfc  = T8w(i,kts,j) / ( p8w(i,k,j) / p1000mb )**( R_d / Cp )<a name='1662'>
      IF ( moist(i,k,j,P_QV) .GE. qvs(i,k,j) .OR. qctmp(i,k,j) .GE. qc_cr) THEN<a name='1663'>
        qvsfc     = cf1 * qvs(i,1,j) +  &amp;<a name='1664'>
                    cf2 * qvs(i,2,j) +  &amp;<a name='1665'>
                    cf3 * qvs(i,3,j)<a name='1666'>
        xlvqv      = XLV * moist(i,k,j,P_QV)<a name='1667'>
        coefa      = ( 1.0 + xlvqv / R_d / t(i,k,j) ) /  &amp;<a name='1668'>
                     ( 1.0 + XLV * xlvqv / Cp / R_v / t(i,k,j) / t(i,k,j) ) /  &amp;<a name='1669'>
                     theta(i,k,j)<a name='1670'>
        thetaep1   = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALCULATE_N2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_3">(i,k+1,j) *  &amp;<a name='1671'>
                     ( 1.0 + XLV * qvs(i,k+1,j) / Cp / t(i,k+1,j) )<a name='1672'>
        thetaesfc  = thetasfc *  &amp;<a name='1673'>
                     ( 1.0 + XLV * qvsfc / Cp / t8w(i,kts,j) )<a name='1674'>
        BN2(i,k,j) = g * ( coefa * ( thetaep1 - thetaesfc ) / tmpdz -  &amp;<a name='1675'>
                     ( tmp1(i,k+1,j) - tmp1sfc(i,j) ) / tmpdz )<a name='1676'>
      ELSE<a name='1677'>
        qvsfc     = cf1 * moist(i,1,j,P_QV) +  &amp;<a name='1678'>
                    cf2 * moist(i,2,j,P_QV) +  &amp;<a name='1679'>
                    cf3 * moist(i,3,j,P_QV)<a name='1680'>
<font color=#447700>!        BN2(i,k,j) = g * ( ( theta(i,k+1,j) - thetasfc ) /  &amp;<a name='1681'></font>
<font color=#447700>!                     theta(i,k,j) / tmpdz +  &amp;<a name='1682'></font>
<font color=#447700>!                     1.61 * ( moist(i,k+1,j,P_QV) - qvsfc ) /  &amp;<a name='1683'></font>
<font color=#447700>!                     tmpdz -  &amp;<a name='1684'></font>
<font color=#447700>!                     ( tmp1(i,k+1,j) - tmp1sfc(i,j) ) / tmpdz  )<a name='1685'></font>
<font color=#447700>!...... MARTA: change in computation of BN2 at the surface, WCS 040331<a name='1686'></font>
<a name='1687'>
        tmpdz= 1./rdzw(i,k,j) <font color=#447700>! controlare come calcola rdzw<a name='1688'></font>
        BN2(i,k,j) = g * ( ( theta(i,k+1,j) - theta(i,k,j)) /  &amp;<a name='1689'>
                     theta(i,k,j) / tmpdz +  &amp;<a name='1690'>
                     1.61 * ( moist(i,k+1,j,P_QV) - qvsfc ) /  &amp;<a name='1691'>
                     tmpdz -  &amp;<a name='1692'>
                     ( tmp1(i,k+1,j) - tmp1sfc(i,j) ) / tmpdz  )<a name='1693'>
<font color=#447700>! end of MARTA/WCS change<a name='1694'></font>
<a name='1695'>
      ENDIF<a name='1696'>
    END DO<a name='1697'>
    END DO<a name='1698'>
<a name='1699'>
<a name='1700'>
<font color=#447700>!...... MARTA: change in computation of BN2 at the top, WCS 040331<a name='1701'></font>
    DO j = j_start, j_end<a name='1702'>
    DO i = i_start, i_end<a name='1703'>
       BN2(i,ktf,j)=BN2(i,ktf-1,j)<a name='1704'>
    END DO<a name='1705'>
    END DO<a name='1706'>
<font color=#447700>! end of MARTA/WCS change<a name='1707'></font>
<a name='1708'>
    END SUBROUTINE calculate_N2<a name='1709'>
<a name='1710'>
<font color=#447700>!=======================================================================<a name='1711'></font>
<font color=#447700>!=======================================================================<a name='1712'></font>
<a name='1713'>
<A NAME='ISOTROPIC_KM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#ISOTROPIC_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1714'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>isotropic_km</font>( config_flags,                                         &amp; <A href='../../call_to/ISOTROPIC_KM.html' TARGET='index'>1</A><a name='1715'>
                         xkmh,xkmv,xkhh,xkhv,khdif,kvdif,                      &amp;<a name='1716'>
                         ids,ide, jds,jde, kds,kde,                            &amp;<a name='1717'>
                         ims,ime, jms,jme, kms,kme,                            &amp;<a name='1718'>
                         its,ite, jts,jte, kts,kte                            )<a name='1719'>
<a name='1720'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1721'></font>
<font color=#447700>! Begin declarations.<a name='1722'></font>
<a name='1723'>
   IMPLICIT NONE<a name='1724'>
<a name='1725'>
   TYPE(grid_config_rec_type) , INTENT(IN   ) :: config_flags<a name='1726'>
<a name='1727'>
   INTEGER ,          INTENT(IN   )           :: ids, ide, jds, jde, kds, kde, &amp;<a name='1728'>
                                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1729'>
                                                 its, ite, jts, jte, kts, kte<a name='1730'>
<a name='1731'>
   REAL    ,          INTENT(IN   )           :: khdif,kvdif<a name='1732'>
<a name='1733'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) ::     xkmh, &amp;<a name='1734'>
                                                                         xkmv, &amp;<a name='1735'>
                                                                         xkhh, &amp;<a name='1736'>
                                                                         xkhv<a name='1737'>
<font color=#447700>! LOCAL VARS<a name='1738'></font>
<a name='1739'>
   INTEGER :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='1740'>
   REAL    :: khdif3,kvdif3<a name='1741'>
<a name='1742'>
<font color=#447700>! End declarations.<a name='1743'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1744'></font>
<a name='1745'>
   ktf = kte<a name='1746'>
<a name='1747'>
   i_start = its<a name='1748'>
   i_end   = MIN(ite,ide-1)<a name='1749'>
   j_start = jts<a name='1750'>
   j_end   = MIN(jte,jde-1)<a name='1751'>
<a name='1752'>
<font color=#447700>!   khdif3=khdif*3.<a name='1753'></font>
<font color=#447700>!   kvdif3=kvdif*3.<a name='1754'></font>
   khdif3=khdif/prandtl<a name='1755'>
   kvdif3=kvdif/prandtl<a name='1756'>
<a name='1757'>
   DO j = j_start, j_end<a name='1758'>
   DO k = kts, ktf<a name='1759'>
   DO i = i_start, i_end<a name='1760'>
      xkmh(i,k,j)=khdif<a name='1761'>
      xkmv(i,k,j)=kvdif<a name='1762'>
      xkhh(i,k,j)=khdif3<a name='1763'>
      xkhv(i,k,j)=kvdif3<a name='1764'>
   ENDDO<a name='1765'>
   ENDDO<a name='1766'>
   ENDDO<a name='1767'>
<a name='1768'>
END SUBROUTINE isotropic_km<a name='1769'>
<a name='1770'>
<font color=#447700>!=======================================================================<a name='1771'></font>
<font color=#447700>!=======================================================================<a name='1772'></font>
<a name='1773'>
<A NAME='SMAG_KM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1774'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>smag_km</font>( config_flags,xkmh,xkmv,xkhh,xkhv,BN2,                      &amp; <A href='../../call_to/SMAG_KM.html' TARGET='index'>1</A><a name='1775'>
                    div,defor11,defor22,defor33,defor12,                       &amp;<a name='1776'>
                    defor13,defor23,                                           &amp;<a name='1777'>
                    rdzw,dx,dy,dt,isotropic,                                   &amp;<a name='1778'>
                    mix_upper_bound, msftx, msfty,                             &amp;<a name='1779'>
                    ids,ide, jds,jde, kds,kde,                                 &amp;<a name='1780'>
                    ims,ime, jms,jme, kms,kme,                                 &amp;<a name='1781'>
                    its,ite, jts,jte, kts,kte                                  )<a name='1782'>
<a name='1783'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1784'></font>
<font color=#447700>! Begin declarations.<a name='1785'></font>
<a name='1786'>
   IMPLICIT NONE<a name='1787'>
<a name='1788'>
   TYPE(grid_config_rec_type) , INTENT(IN   ) :: config_flags<a name='1789'>
<a name='1790'>
   INTEGER ,          INTENT(IN   )           :: ids, ide, jds, jde, kds, kde, &amp;<a name='1791'>
                                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1792'>
                                                 its, ite, jts, jte, kts, kte<a name='1793'>
<a name='1794'>
   INTEGER ,          INTENT(IN   )           :: isotropic<a name='1795'>
   REAL    ,          INTENT(IN   )           :: dx, dy, dt, mix_upper_bound<a name='1796'>
<a name='1797'>
<a name='1798'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) ::      BN2, &amp;<a name='1799'>
                                                                         rdzw<a name='1800'>
<a name='1801'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) ::     xkmh, &amp;<a name='1802'>
                                                                         xkmv, &amp;<a name='1803'>
                                                                         xkhh, &amp;<a name='1804'>
                                                                         xkhv<a name='1805'>
<a name='1806'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ),  INTENT(IN   )      ::      &amp;<a name='1807'>
                                                                      defor11, &amp;<a name='1808'>
                                                                      defor22, &amp;<a name='1809'>
                                                                      defor33, &amp;<a name='1810'>
                                                                      defor12, &amp;<a name='1811'>
                                                                      defor13, &amp;<a name='1812'>
                                                                      defor23, &amp;<a name='1813'>
                                                                          div<a name='1814'>
   REAL , DIMENSION( ims:ime, jms:jme), INTENT(IN   ) ::                msftx, &amp;<a name='1815'>
                                                                        msfty<a name='1816'>
<font color=#447700>! LOCAL VARS<a name='1817'></font>
<a name='1818'>
   INTEGER :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='1819'>
   REAL    :: deltas, tmp, pr, mlen_h, mlen_v, c_s<a name='1820'>
<a name='1821'>
   REAL, DIMENSION( its:ite , kts:kte , jts:jte )                 ::     def2<a name='1822'>
<a name='1823'>
<font color=#447700>! End declarations.<a name='1824'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1825'></font>
<a name='1826'>
   ktf = min(kte,kde-1)<a name='1827'>
<a name='1828'>
   i_start = its<a name='1829'>
   i_end   = MIN(ite,ide-1)<a name='1830'>
   j_start = jts<a name='1831'>
   j_end   = MIN(jte,jde-1)<a name='1832'>
<a name='1833'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='1834'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='1835'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='1836'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='1837'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='1838'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='1839'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='1840'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='1841'>
      IF ( config_flags%periodic_x ) i_start = its<a name='1842'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='1843'>
<a name='1844'>
   pr = prandtl<a name='1845'>
   c_s = config_flags%c_s<a name='1846'>
<a name='1847'>
   do j=j_start,j_end<a name='1848'>
   do k=kts,ktf<a name='1849'>
   do i=i_start,i_end<a name='1850'>
      def2(i,k,j)=0.5*(defor11(i,k,j)*defor11(i,k,j) + &amp;<a name='1851'>
                       defor22(i,k,j)*defor22(i,k,j) + &amp;<a name='1852'>
                       defor33(i,k,j)*defor33(i,k,j))<a name='1853'>
   enddo<a name='1854'>
   enddo<a name='1855'>
   enddo<a name='1856'>
<a name='1857'>
   do j=j_start,j_end<a name='1858'>
   do k=kts,ktf<a name='1859'>
   do i=i_start,i_end<a name='1860'>
      tmp=0.25*(defor12(i  ,k,j)+defor12(i  ,k,j+1)+ &amp;<a name='1861'>
                defor12(i+1,k,j)+defor12(i+1,k,j+1))<a name='1862'>
      def2(i,k,j)=def2(i,k,j)+tmp*tmp<a name='1863'>
   enddo<a name='1864'>
   enddo<a name='1865'>
   enddo<a name='1866'>
<a name='1867'>
   do j=j_start,j_end<a name='1868'>
   do k=kts,ktf<a name='1869'>
   do i=i_start,i_end<a name='1870'>
      tmp=0.25*(defor13(i  ,k+1,j)+defor13(i  ,k,j)+ &amp;<a name='1871'>
                defor13(i+1,k+1,j)+defor13(i+1,k,j))<a name='1872'>
      def2(i,k,j)=def2(i,k,j)+tmp*tmp<a name='1873'>
   enddo<a name='1874'>
   enddo<a name='1875'>
   enddo<a name='1876'>
<a name='1877'>
   do j=j_start,j_end<a name='1878'>
   do k=kts,ktf<a name='1879'>
   do i=i_start,i_end<a name='1880'>
      tmp=0.25*(defor23(i,k+1,j  )+defor23(i,k,j  )+ &amp;<a name='1881'>
                defor23(i,k+1,j+1)+defor23(i,k,j+1))<a name='1882'>
      def2(i,k,j)=def2(i,k,j)+tmp*tmp<a name='1883'>
   enddo<a name='1884'>
   enddo<a name='1885'>
   enddo<a name='1886'>
<font color=#447700>!<a name='1887'></font>
   IF (isotropic .EQ. 0) THEN<a name='1888'>
      DO j = j_start, j_end<a name='1889'>
      DO k = kts, ktf<a name='1890'>
      DO i = i_start, i_end<a name='1891'>
         mlen_h=sqrt(dx/msftx(i,j) * dy/msfty(i,j))<a name='1892'>
         mlen_v= 1./rdzw(i,k,j)<a name='1893'>
         tmp=max(0.,def2(i,k,j)-BN2(i,k,j)/pr)<a name='1894'>
         tmp=tmp**0.5<a name='1895'>
         xkmh(i,k,j)=max(c_s*c_s*mlen_h*mlen_h*tmp, 1.0E-6*mlen_h*mlen_h )<a name='1896'>
         xkmh(i,k,j)=min(xkmh(i,k,j), mix_upper_bound * mlen_h * mlen_h / dt )<a name='1897'>
         xkmv(i,k,j)=max(c_s*c_s*mlen_v*mlen_v*tmp, 1.0E-6*mlen_v*mlen_v )<a name='1898'>
         xkmv(i,k,j)=min(xkmv(i,k,j), mix_upper_bound * mlen_v * mlen_v / dt )<a name='1899'>
         xkhh(i,k,j)=xkmh(i,k,j)/pr<a name='1900'>
         xkhh(i,k,j)=min(xkhh(i,k,j), mix_upper_bound * mlen_h * mlen_h / dt )<a name='1901'>
         xkhv(i,k,j)=xkmv(i,k,j)/pr<a name='1902'>
         xkhv(i,k,j)=min(xkhv(i,k,j), mix_upper_bound * mlen_v * mlen_v / dt )<a name='1903'>
      ENDDO<a name='1904'>
      ENDDO<a name='1905'>
      ENDDO<a name='1906'>
   ELSE<a name='1907'>
      DO j = j_start, j_end<a name='1908'>
      DO k = kts, ktf<a name='1909'>
      DO i = i_start, i_end<a name='1910'>
         deltas=(dx/msftx(i,j) * dy/msfty(i,j)/rdzw(i,k,j))**0.33333333<a name='1911'>
         tmp=max(0.,def2(i,k,j)-BN2(i,k,j)/pr)<a name='1912'>
         tmp=tmp**0.5<a name='1913'>
         xkmh(i,k,j)=max(c_s*c_s*deltas*deltas*tmp, 1.0E-6*deltas*deltas )<a name='1914'>
         xkmh(i,k,j)=min(xkmh(i,k,j), mix_upper_bound * dx/msftx(i,j) * dy/msfty(i,j) / dt )<a name='1915'>
         xkmv(i,k,j)=xkmh(i,k,j)<a name='1916'>
         xkmv(i,k,j)=min(xkmv(i,k,j), mix_upper_bound / rdzw(i,k,j) / rdzw(i,k,j) / dt )<a name='1917'>
         xkhh(i,k,j)=xkmh(i,k,j)/pr<a name='1918'>
         xkhh(i,k,j)=min(xkhh(i,k,j), mix_upper_bound * dx/msftx(i,j) * dy/msfty(i,j) / dt )<a name='1919'>
         xkhv(i,k,j)=xkmv(i,k,j)/pr<a name='1920'>
         xkhv(i,k,j)=min(xkhv(i,k,j), mix_upper_bound / rdzw(i,k,j) / rdzw(i,k,j) / dt )<a name='1921'>
      ENDDO<a name='1922'>
      ENDDO<a name='1923'>
      ENDDO<a name='1924'>
   ENDIF<a name='1925'>
<a name='1926'>
END SUBROUTINE smag_km<a name='1927'>
<a name='1928'>
<font color=#447700>!=======================================================================<a name='1929'></font>
<font color=#447700>!=======================================================================<a name='1930'></font>
<a name='1931'>
<A NAME='SMAG2D_KM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#SMAG2D_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1932'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>smag2d_km</font>( config_flags,xkmh,xkmv,xkhh,xkhv,                        &amp; <A href='../../call_to/SMAG2D_KM.html' TARGET='index'>1</A><a name='1933'>
                    defor11,defor22,defor12,                                   &amp;<a name='1934'>
                    rdzw,dx,dy,msftx, msfty,zx,zy,                             &amp;<a name='1935'>
                    ids,ide, jds,jde, kds,kde,                                 &amp;<a name='1936'>
                    ims,ime, jms,jme, kms,kme,                                 &amp;<a name='1937'>
                    its,ite, jts,jte, kts,kte                                  )<a name='1938'>
<a name='1939'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1940'></font>
<font color=#447700>! Begin declarations.<a name='1941'></font>
<a name='1942'>
   IMPLICIT NONE<a name='1943'>
<a name='1944'>
   TYPE(grid_config_rec_type) , INTENT(IN   ) :: config_flags<a name='1945'>
<a name='1946'>
   INTEGER ,          INTENT(IN   )           :: ids, ide, jds, jde, kds, kde, &amp;<a name='1947'>
                                                 ims, ime, jms, jme, kms, kme, &amp;<a name='1948'>
                                                 its, ite, jts, jte, kts, kte<a name='1949'>
<a name='1950'>
   REAL    ,          INTENT(IN   )           :: dx, dy<a name='1951'>
<a name='1952'>
<a name='1953'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) ::     rdzw,zx,zy<a name='1954'>
<a name='1955'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) ::     xkmh, &amp;<a name='1956'>
                                                                         xkmv, &amp;<a name='1957'>
                                                                         xkhh, &amp;<a name='1958'>
                                                                         xkhv<a name='1959'>
<a name='1960'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ),  INTENT(IN   )      ::      &amp;<a name='1961'>
                                                                      defor11, &amp;<a name='1962'>
                                                                      defor22, &amp;<a name='1963'>
                                                                      defor12<a name='1964'>
<a name='1965'>
   REAL , DIMENSION( ims:ime, jms:jme), INTENT(IN   ) ::                msftx, &amp;<a name='1966'>
                                                                        msfty<a name='1967'>
<font color=#447700>! LOCAL VARS<a name='1968'></font>
<a name='1969'>
   INTEGER :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='1970'>
   REAL    :: deltas, tmp, pr, mlen_h, c_s<a name='1971'>
   REAL    :: dxm, dym, tmpzx, tmpzy, alpha, def_limit<a name='1972'>
<a name='1973'>
   REAL, DIMENSION( its:ite , kts:kte , jts:jte )                 ::     def2<a name='1974'>
<a name='1975'>
<font color=#447700>! End declarations.<a name='1976'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1977'></font>
<a name='1978'>
   ktf = min(kte,kde-1)<a name='1979'>
<a name='1980'>
   i_start = its<a name='1981'>
   i_end   = MIN(ite,ide-1)<a name='1982'>
   j_start = jts<a name='1983'>
   j_end   = MIN(jte,jde-1)<a name='1984'>
<a name='1985'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='1986'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='1987'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='1988'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='1989'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='1990'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='1991'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='1992'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='1993'>
      IF ( config_flags%periodic_x ) i_start = its<a name='1994'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='1995'>
<a name='1996'>
   pr=prandtl<a name='1997'>
   c_s = config_flags%c_s<a name='1998'>
<a name='1999'>
   do j=j_start,j_end<a name='2000'>
   do k=kts,ktf<a name='2001'>
   do i=i_start,i_end<a name='2002'>
      def2(i,k,j)=0.25*((defor11(i,k,j)-defor22(i,k,j))*(defor11(i,k,j)-defor22(i,k,j)))<a name='2003'>
      tmp=0.25*(defor12(i  ,k,j)+defor12(i  ,k,j+1)+ &amp;<a name='2004'>
                defor12(i+1,k,j)+defor12(i+1,k,j+1))<a name='2005'>
      def2(i,k,j)=def2(i,k,j)+tmp*tmp<a name='2006'>
   enddo<a name='2007'>
   enddo<a name='2008'>
   enddo<a name='2009'>
<font color=#447700>!<a name='2010'></font>
      DO j = j_start, j_end<a name='2011'>
      DO k = kts, ktf<a name='2012'>
      DO i = i_start, i_end<a name='2013'>
         mlen_h=sqrt(dx/msftx(i,j) * dy/msfty(i,j))<a name='2014'>
         tmp=sqrt(def2(i,k,j))<a name='2015'>
<font color=#447700>!        xkmh(i,k,j)=max(c_s*c_s*mlen_h*mlen_h*tmp, 1.0E-6*mlen_h*mlen_h )<a name='2016'></font>
         xkmh(i,k,j)=c_s*c_s*mlen_h*mlen_h*tmp<a name='2017'>
         xkmh(i,k,j)=min(xkmh(i,k,j), 10.*mlen_h )<a name='2018'>
         xkmv(i,k,j)=0.<a name='2019'>
         xkhh(i,k,j)=xkmh(i,k,j)/pr<a name='2020'>
         xkhv(i,k,j)=0.<a name='2021'>
         IF(config_flags%diff_opt .EQ. 2)THEN<a name='2022'>
<font color=#447700>! jd: reduce diffusion coefficient by slope factor (modified by JB August 2014)<a name='2023'></font>
            dxm=dx/msftx(i,j)<a name='2024'>
            dym=dy/msfty(i,j)<a name='2025'>
            tmpzx = (0.25*( abs(zx(i,k,j))+ abs(zx(i+1,k,j  )) + abs(zx(i,k+1,j))+ abs(zx(i+1,k+1,j  )))*rdzw(i,k,j)*dxm)<a name='2026'>
            tmpzy = (0.25*( abs(zy(i,k,j))+ abs(zy(i  ,k,j+1)) + abs(zy(i,k+1,j))+ abs(zy(i  ,k+1,j+1)))*rdzw(i,k,j)*dym)<a name='2027'>
            alpha = max(sqrt(tmpzx*tmpzx+tmpzy*tmpzy),1.0)<a name='2028'>
<font color=#447700>! If deformation is large, further reduce the diffusion coefficient<a name='2029'></font>
            def_limit = max(10./mlen_h,1.e-3)<a name='2030'>
           if ( tmp .gt. def_limit ) then<a name='2031'>
             xkmh(i,k,j)=xkmh(i,k,j)/(alpha*alpha)<a name='2032'>
           else<a name='2033'>
             xkmh(i,k,j)=xkmh(i,k,j)/(alpha)<a name='2034'>
           endif<a name='2035'>
           xkhh(i,k,j)=xkmh(i,k,j)/pr<a name='2036'>
         ENDIF<a name='2037'>
      ENDDO<a name='2038'>
      ENDDO<a name='2039'>
      ENDDO<a name='2040'>
<a name='2041'>
END SUBROUTINE smag2d_km<a name='2042'>
<a name='2043'>
<font color=#447700>!=======================================================================<a name='2044'></font>
<font color=#447700>!=======================================================================<a name='2045'></font>
<a name='2046'>
<A NAME='TKE_KM'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_KM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2047'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_km</font>( config_flags, xkmh, xkmv, xkhh, xkhv,         &amp; <A href='../../call_to/TKE_KM.html' TARGET='index'>1</A>,<A href='../../call_from/TKE_KM.html' TARGET='index'>1</A><a name='2048'>
                       bn2, tke, p8w, t8w, theta,                    &amp;<a name='2049'>
                       rdz, rdzw, dx,dy, dt, isotropic,              &amp;<a name='2050'>
                       mix_upper_bound, msftx, msfty,                &amp;<a name='2051'>
                       ids, ide, jds, jde, kds, kde,                 &amp;<a name='2052'>
                       ims, ime, jms, jme, kms, kme,                 &amp;<a name='2053'>
                       its, ite, jts, jte, kts, kte                  )<a name='2054'>
<a name='2055'>
<font color=#447700>! History:     Sep 2003   Changes by Jason Knievel and George Bryan, NCAR<a name='2056'></font>
<font color=#447700>!              Oct 2001   Converted to mass core by Bill Skamarock, NCAR<a name='2057'></font>
<font color=#447700>!              ...        ...<a name='2058'></font>
<a name='2059'>
<font color=#447700>! Purpose:     This routine calculates the exchange coefficients for the<a name='2060'></font>
<font color=#447700>!              TKE turbulence parameterization.<a name='2061'></font>
<a name='2062'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='2063'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='2064'></font>
<a name='2065'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2066'></font>
<font color=#447700>! Begin declarations.<a name='2067'></font>
<a name='2068'>
    IMPLICIT NONE<a name='2069'>
<a name='2070'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='2071'>
    :: config_flags<a name='2072'>
<a name='2073'>
    INTEGER, INTENT( IN )  &amp;<a name='2074'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='2075'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='2076'>
       its, ite, jts, jte, kts, kte<a name='2077'>
<a name='2078'>
    INTEGER, INTENT( IN )  :: isotropic<a name='2079'>
    REAL, INTENT( IN )  &amp;<a name='2080'>
    :: dx, dy, dt<a name='2081'>
<a name='2082'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='2083'>
    :: tke, p8w, t8w, theta, rdz, rdzw, bn2<a name='2084'>
<a name='2085'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='2086'>
    :: xkmh, xkmv, xkhh, xkhv<a name='2087'>
<a name='2088'>
    REAL, INTENT( IN )  &amp;<a name='2089'>
    :: mix_upper_bound<a name='2090'>
<a name='2091'>
   REAL , DIMENSION( ims:ime, jms:jme), INTENT(IN   ) ::     msftx, &amp;<a name='2092'>
                                                             msfty<a name='2093'>
<font color=#447700>! Local variables.<a name='2094'></font>
<a name='2095'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='2096'>
    :: l_scale<a name='2097'>
<a name='2098'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='2099'>
    :: dthrdn<a name='2100'>
<a name='2101'>
    REAL  &amp;<a name='2102'>
    :: deltas, tmp, mlen_s, mlen_h, mlen_v, tmpdz,  &amp;<a name='2103'>
       thetasfc, thetatop, minkx, pr_inv, pr_inv_h, pr_inv_v, c_k<a name='2104'>
<a name='2105'>
    INTEGER  &amp;<a name='2106'>
    :: i_start, i_end, j_start, j_end, ktf, i, j, k<a name='2107'>
<a name='2108'>
    REAL, PARAMETER :: tke_seed_value = 1.e-06<a name='2109'>
    REAL            :: tke_seed<a name='2110'>
    REAL, PARAMETER :: epsilon = 1.e-10<a name='2111'>
<a name='2112'>
<font color=#447700>! End declarations.<a name='2113'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2114'></font>
<a name='2115'>
    ktf     = MIN( kte, kde-1 )<a name='2116'>
    i_start = its<a name='2117'>
    i_end   = MIN( ite, ide-1 )<a name='2118'>
    j_start = jts<a name='2119'>
    j_end   = MIN( jte, jde-1 )<a name='2120'>
<a name='2121'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='2122'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='2123'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='2124'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='2125'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='2126'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='2127'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='2128'>
         config_flags%nested) j_end   = MIN( jde-2, jte)<a name='2129'>
      IF ( config_flags%periodic_x ) i_start = its<a name='2130'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='2131'>
<a name='2132'>
<font color=#447700>! in the absence of surface drag or a surface heat flux, there<a name='2133'></font>
<font color=#447700>! is no way to generate tke without pre-existing tke.  Use<a name='2134'></font>
<font color=#447700>! tke_seed if the drag and flux are off.<a name='2135'></font>
<a name='2136'>
    c_k = config_flags%c_k<a name='2137'>
    tke_seed = tke_seed_value<a name='2138'>
    if( (config_flags%tke_drag_coefficient .gt. epsilon) .or.  &amp;<a name='2139'>
        (config_flags%tke_heat_flux .gt. epsilon)  ) tke_seed = 0.<a name='2140'>
<a name='2141'>
    DO j = j_start, j_end<a name='2142'>
    DO k = kts+1, ktf-1<a name='2143'>
    DO i = i_start, i_end<a name='2144'>
      tmpdz         = 1.0 / rdz(i,k+1,j) + 1.0 / rdz(i,k,j)<a name='2145'>
      dthrdn(i,k,j) = ( theta(i,k+1,j) - theta(i,k-1,j) ) / tmpdz<a name='2146'>
    END DO<a name='2147'>
    END DO<a name='2148'>
    END DO<a name='2149'>
<a name='2150'>
    k = kts<a name='2151'>
    DO j = j_start, j_end<a name='2152'>
    DO i = i_start, i_end<a name='2153'>
      tmpdz         = 1.0 / rdzw(i,k+1,j) + 1.0 / rdzw(i,k,j)<a name='2154'>
      thetasfc      = T8w(i,kts,j) / ( p8w(i,k,j) / p1000mb )**( R_d / Cp )<a name='2155'>
      dthrdn(i,k,j) = ( theta(i,k+1,j) - thetasfc ) / tmpdz<a name='2156'>
    END DO<a name='2157'>
    END DO<a name='2158'>
<a name='2159'>
    k = ktf<a name='2160'>
    DO j = j_start, j_end<a name='2161'>
    DO i = i_start, i_end<a name='2162'>
      tmpdz         = 1.0 / rdz(i,k,j) + 0.5 / rdzw(i,k,j)<a name='2163'>
      thetatop      = T8w(i,kde,j) / ( p8w(i,kde,j) / p1000mb )**( R_d / Cp )<a name='2164'>
      dthrdn(i,k,j) = ( thetatop - theta(i,k-1,j) ) / tmpdz<a name='2165'>
    END DO<a name='2166'>
    END DO<a name='2167'>
<a name='2168'>
    IF ( isotropic .EQ. 0 ) THEN<a name='2169'>
      DO j = j_start, j_end<a name='2170'>
      DO k = kts, ktf<a name='2171'>
      DO i = i_start, i_end<a name='2172'>
        mlen_h = SQRT( dx/msftx(i,j) * dy/msfty(i,j) )<a name='2173'>
        tmp    = SQRT( MAX( tke(i,k,j), tke_seed ) )<a name='2174'>
        deltas = 1.0 / rdzw(i,k,j)<a name='2175'>
        mlen_v = deltas<a name='2176'>
        IF ( dthrdn(i,k,j) .GT. 0.) THEN<a name='2177'>
          mlen_s = 0.76 * tmp / ( ABS( g / theta(i,k,j) * dthrdn(i,k,j) ) )**0.5<a name='2178'>
          mlen_v = MIN( mlen_v, mlen_s )<a name='2179'>
        END IF<a name='2180'>
        xkmh(i,k,j)  = MAX( c_k * tmp * mlen_h, 1.0E-6 * mlen_h * mlen_h )<a name='2181'>
        xkmh(i,k,j)  = MIN( xkmh(i,k,j), mix_upper_bound * mlen_h *mlen_h / dt )<a name='2182'>
        xkmv(i,k,j)  = MAX( c_k * tmp * mlen_v, 1.0E-6 * deltas * deltas )<a name='2183'>
        xkmv(i,k,j)  = MIN( xkmv(i,k,j), mix_upper_bound * deltas *deltas / dt )<a name='2184'>
        pr_inv_h     = 1./prandtl<a name='2185'>
        pr_inv_v     = 1.0 + 2.0 * mlen_v / deltas<a name='2186'>
        xkhh(i,k,j)  = xkmh(i,k,j) * pr_inv_h<a name='2187'>
        xkhv(i,k,j)  = xkmv(i,k,j) * pr_inv_v<a name='2188'>
      END DO<a name='2189'>
      END DO<a name='2190'>
      END DO<a name='2191'>
    ELSE<a name='2192'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALC_L_SCALE'>calc_l_scale</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_KM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_L_SCALE_1">( config_flags, tke, BN2, l_scale,      &amp;<a name='2193'>
                         i_start, i_end, ktf, j_start, j_end,  &amp;<a name='2194'>
                         dx, dy, rdzw, msftx, msfty,           &amp;<a name='2195'>
                         ids, ide, jds, jde, kds, kde,         &amp;<a name='2196'>
                         ims, ime, jms, jme, kms, kme,         &amp;<a name='2197'>
                         its, ite, jts, jte, kts, kte          )<a name='2198'>
      DO j = j_start, j_end<a name='2199'>
      DO k = kts, ktf<a name='2200'>
      DO i = i_start, i_end<a name='2201'>
        tmp          = SQRT( MAX( tke(i,k,j), tke_seed ) )<a name='2202'>
        deltas       = ( dx/msftx(i,j) * dy/msfty(i,j) / rdzw(i,k,j) )**0.33333333<a name='2203'>
        xkmh(i,k,j)  = c_k * tmp * l_scale(i,k,j)<a name='2204'>
        xkmh(i,k,j)  = MIN( mix_upper_bound * dx/msftx(i,j) * dy/msfty(i,j) / dt,  xkmh(i,k,j) )<a name='2205'>
        xkmv(i,k,j)  = c_k * tmp * l_scale(i,k,j)<a name='2206'>
        xkmv(i,k,j)  = MIN( mix_upper_bound / rdzw(i,k,j) / rdzw(i,k,j) / dt ,  xkmv(i,k,j) )<a name='2207'>
        pr_inv       = 1.0 + 2.0 * l_scale(i,k,j) / deltas<a name='2208'>
        xkhh(i,k,j)  = MIN( mix_upper_bound * dx/msftx(i,j) * dy/msfty(i,j) / dt, xkmh(i,k,j) * pr_inv )<a name='2209'>
        xkhv(i,k,j)  = MIN( mix_upper_bound / rdzw(i,k,j) / rdzw(i,k,j) / dt, xkmv(i,k,j) * pr_inv )<a name='2210'>
      END DO<a name='2211'>
      END DO<a name='2212'>
      END DO<a name='2213'>
    END IF<a name='2214'>
<a name='2215'>
    END SUBROUTINE tke_km<a name='2216'>
<a name='2217'>
<font color=#447700>!=======================================================================<a name='2218'></font>
<font color=#447700>!=======================================================================<a name='2219'></font>
<a name='2220'>
<A NAME='CALC_L_SCALE'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALC_L_SCALE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2221'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_l_scale</font>( config_flags, tke, BN2, l_scale,      &amp; <A href='../../call_to/CALC_L_SCALE.html' TARGET='index'>2</A><a name='2222'>
                             i_start, i_end, ktf, j_start, j_end,  &amp;<a name='2223'>
                             dx, dy, rdzw, msftx, msfty,           &amp;<a name='2224'>
                             ids, ide, jds, jde, kds, kde,         &amp;<a name='2225'>
                             ims, ime, jms, jme, kms, kme,         &amp;<a name='2226'>
                             its, ite, jts, jte, kts, kte          )<a name='2227'>
<a name='2228'>
<font color=#447700>! History:     Sep 2003   Written by Bryan and Knievel, NCAR<a name='2229'></font>
<a name='2230'>
<font color=#447700>! Purpose:     This routine calculates the length scale, based on stability,<a name='2231'></font>
<font color=#447700>!              for TKE parameterization of subgrid-scale turbulence.<a name='2232'></font>
<a name='2233'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2234'></font>
<font color=#447700>! Begin declarations.<a name='2235'></font>
<a name='2236'>
    IMPLICIT NONE<a name='2237'>
<a name='2238'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='2239'>
    :: config_flags<a name='2240'>
<a name='2241'>
    INTEGER, INTENT( IN )  &amp;<a name='2242'>
    :: i_start, i_end, ktf, j_start, j_end,  &amp;<a name='2243'>
       ids, ide, jds, jde, kds, kde,         &amp;<a name='2244'>
       ims, ime, jms, jme, kms, kme,         &amp;<a name='2245'>
       its, ite, jts, jte, kts, kte<a name='2246'>
<a name='2247'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='2248'>
    :: BN2, tke, rdzw<a name='2249'>
<a name='2250'>
    REAL, INTENT( IN )  &amp;<a name='2251'>
    :: dx, dy<a name='2252'>
<a name='2253'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte ), INTENT( OUT )  &amp;<a name='2254'>
    :: l_scale<a name='2255'>
<a name='2256'>
    REAL , DIMENSION( ims:ime, jms:jme), INTENT(IN   ) ::     msftx, &amp;<a name='2257'>
                                                              msfty<a name='2258'>
<font color=#447700>! Local variables.<a name='2259'></font>
<a name='2260'>
    INTEGER  &amp;<a name='2261'>
    :: i, j, k<a name='2262'>
<a name='2263'>
    REAL  &amp;<a name='2264'>
    :: deltas, tmp<a name='2265'>
<a name='2266'>
<font color=#447700>! End declarations.<a name='2267'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2268'></font>
<a name='2269'>
    DO j = j_start, j_end<a name='2270'>
    DO k = kts, ktf<a name='2271'>
    DO i = i_start, i_end<a name='2272'>
      deltas         = ( dx/msftx(i,j) * dy/msfty(i,j) / rdzw(i,k,j) )**0.33333333<a name='2273'>
      l_scale(i,k,j) = deltas<a name='2274'>
<a name='2275'>
      IF ( BN2(i,k,j) .gt. 1.0e-6 ) THEN<a name='2276'>
        tmp            = SQRT( MAX( tke(i,k,j), 1.0e-6 ) )<a name='2277'>
        l_scale(i,k,j) = 0.76 * tmp / SQRT( BN2(i,k,j) )<a name='2278'>
        l_scale(i,k,j) = MIN( l_scale(i,k,j), deltas)<a name='2279'>
        l_scale(i,k,j) = MAX( l_scale(i,k,j), 0.001 * deltas )<a name='2280'>
      END IF<a name='2281'>
<a name='2282'>
    END DO<a name='2283'>
    END DO<a name='2284'>
    END DO<a name='2285'>
<a name='2286'>
    END SUBROUTINE calc_l_scale<a name='2287'>
<a name='2288'>
<font color=#447700>!=======================================================================<a name='2289'></font>
<font color=#447700>!=======================================================================<a name='2290'></font>
<a name='2291'>
<A NAME='HORIZONTAL_DIFFUSION_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2292'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_2</font> ( rt_tendf, ru_tendf, rv_tendf, rw_tendf,    &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_2.html' TARGET='index'>1</A>,<A href='../../call_from/HORIZONTAL_DIFFUSION_2.html' TARGET='index'>9</A><a name='2293'>
                                    tke_tendf,                                 &amp;<a name='2294'>
                                    moist_tendf, n_moist,                      &amp;<a name='2295'>
                                    chem_tendf, n_chem,                        &amp;<a name='2296'>
                                    scalar_tendf, n_scalar,                    &amp;<a name='2297'>
                                    tracer_tendf, n_tracer,                    &amp;<a name='2298'>
                                    thp, theta, tke, config_flags,             &amp;<a name='2299'>
                                    defor11, defor22, defor12,                 &amp;<a name='2300'>
                                    defor13, defor23,                          &amp;<a name='2301'>
                                    nba_mij, n_nba_mij,                        &amp;<a name='2302'>
                                    div,                                       &amp;<a name='2303'>
                                    moist, chem, scalar,tracer,                &amp;<a name='2304'>
                                    msfux, msfuy, msfvx, msfvy,                &amp;<a name='2305'>
                                    msftx, msfty, xkmh, xkhh,km_opt,           &amp;<a name='2306'>
                                    rdx, rdy, rdz, rdzw, fnm, fnp,             &amp;<a name='2307'>
                                    cf1, cf2, cf3, zx, zy, dn, dnw, rho,       &amp;<a name='2308'>
                                    ids, ide, jds, jde, kds, kde,              &amp;<a name='2309'>
                                    ims, ime, jms, jme, kms, kme,              &amp;<a name='2310'>
                                    its, ite, jts, jte, kts, kte               )<a name='2311'>
<a name='2312'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2313'></font>
<font color=#447700>! Begin declarations.<a name='2314'></font>
<a name='2315'>
   IMPLICIT NONE<a name='2316'>
<a name='2317'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2318'>
<a name='2319'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2320'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2321'>
                                            its, ite, jts, jte, kts, kte<a name='2322'>
<a name='2323'>
   INTEGER ,        INTENT(IN   ) ::        n_moist,n_chem,n_scalar,n_tracer,km_opt<a name='2324'>
<a name='2325'>
   REAL ,           INTENT(IN   ) ::        cf1, cf2, cf3<a name='2326'>
<a name='2327'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='2328'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='2329'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    dnw<a name='2330'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    dn<a name='2331'>
<a name='2332'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfux, &amp;<a name='2333'>
                                                                    msfuy, &amp;<a name='2334'>
                                                                    msfvx, &amp;<a name='2335'>
                                                                    msfvy, &amp;<a name='2336'>
                                                                    msftx, &amp;<a name='2337'>
                                                                    msfty<a name='2338'>
<a name='2339'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::rt_tendf,&amp;<a name='2340'>
                                                                 ru_tendf,&amp;<a name='2341'>
                                                                 rv_tendf,&amp;<a name='2342'>
                                                                 rw_tendf,&amp;<a name='2343'>
                                                                tke_tendf<a name='2344'>
<a name='2345'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist),                 &amp;<a name='2346'>
          INTENT(INOUT) ::                                    moist_tendf<a name='2347'>
<a name='2348'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_chem),                  &amp;<a name='2349'>
          INTENT(INOUT) ::                                     chem_tendf<a name='2350'>
<a name='2351'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_scalar),                &amp;<a name='2352'>
          INTENT(INOUT) ::                                   scalar_tendf<a name='2353'>
<a name='2354'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_tracer),                &amp;<a name='2355'>
          INTENT(INOUT) ::                                   tracer_tendf<a name='2356'>
<a name='2357'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist),                 &amp;<a name='2358'>
          INTENT(IN   ) ::                                          moist<a name='2359'>
<a name='2360'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_chem),                  &amp;<a name='2361'>
          INTENT(IN   ) ::                                          chem<a name='2362'>
<a name='2363'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_scalar) ,               &amp;<a name='2364'>
          INTENT(IN   ) ::                                         scalar<a name='2365'>
<a name='2366'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_tracer) ,               &amp;<a name='2367'>
          INTENT(IN   ) ::                                         tracer<a name='2368'>
<a name='2369'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor11, &amp;<a name='2370'>
                                                                 defor22, &amp;<a name='2371'>
                                                                 defor12, &amp;<a name='2372'>
                                                                 defor13, &amp;<a name='2373'>
                                                                 defor23, &amp;<a name='2374'>
                                                                     div, &amp;<a name='2375'>
                                                                    xkmh, &amp;<a name='2376'>
                                                                    xkhh, &amp;<a name='2377'>
                                                                      zx, &amp;<a name='2378'>
                                                                      zy, &amp;<a name='2379'>
                                                                   theta, &amp;<a name='2380'>
                                                                     thp, &amp;<a name='2381'>
                                                                     tke, &amp;<a name='2382'>
                                                                     rdz, &amp;<a name='2383'>
                                                                    rdzw, &amp;<a name='2384'>
                                                                     rho<a name='2385'>
<a name='2386'>
<a name='2387'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='2388'>
                                                                     rdy<a name='2389'>
   INTEGER, INTENT(  IN ) :: n_nba_mij<a name='2390'>
<a name='2391'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_mij), INTENT(INOUT) &amp;<a name='2392'>
   :: nba_mij<a name='2393'>
<a name='2394'>
<font color=#447700>! LOCAL VARS<a name='2395'></font>
<a name='2396'>
   INTEGER :: im, ic, is<a name='2397'>
<a name='2398'>
<font color=#447700>!  REAL , DIMENSION(its-1:ite+1, kts:kte, jts-1:jte+1)       ::     xkhh<a name='2399'></font>
<a name='2400'>
<font color=#447700>! End declarations.<a name='2401'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2402'></font>
<a name='2403'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2404'></font>
<font color=#447700>! Call diffusion subroutines.<a name='2405'></font>
<a name='2406'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_U_2'>horizontal_diffusion_u_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_U_2_1">( ru_tendf, config_flags,                 &amp;<a name='2407'>
                                   defor11, defor12, div,                  &amp;<a name='2408'>
                                   nba_mij, n_nba_mij,                     &amp;<a name='2409'>
                                   tke(ims,kms,jms),                       &amp;<a name='2410'>
                                   msfux, msfuy, xkmh, rdx, rdy, fnm, fnp, &amp;<a name='2411'>
                                   dnw, zx, zy, rdzw, rho,                 &amp;<a name='2412'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2413'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2414'>
                                   its, ite, jts, jte, kts, kte           )<a name='2415'>
<a name='2416'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_V_2'>horizontal_diffusion_v_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_V_2_1">( rv_tendf, config_flags,                 &amp;<a name='2417'>
                                   defor12, defor22, div,                  &amp;<a name='2418'>
                                   nba_mij, n_nba_mij,                     &amp;<a name='2419'>
                                   tke(ims,kms,jms),                       &amp;<a name='2420'>
                                   msfvx, msfvy, xkmh, rdx, rdy, fnm, fnp, &amp;<a name='2421'>
                                   dnw, zx, zy, rdzw, rho,                 &amp;<a name='2422'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2423'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2424'>
                                   its, ite, jts, jte, kts, kte           )<a name='2425'>
<a name='2426'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_W_2'>horizontal_diffusion_w_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_W_2_1">( rw_tendf, config_flags,                 &amp;<a name='2427'>
                                   defor13, defor23, div,                  &amp;<a name='2428'>
                                   nba_mij, n_nba_mij,                     &amp;<a name='2429'>
                                   tke(ims,kms,jms),                       &amp;<a name='2430'>
                                   msftx, msfty, xkmh, rdx, rdy, fnm, fnp, &amp;<a name='2431'>
                                   dn, zx, zy, rdz, rho,                   &amp;<a name='2432'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2433'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2434'>
                                   its, ite, jts, jte, kts, kte           )<a name='2435'>
<a name='2436'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_1">  ( rt_tendf, config_flags, thp,            &amp;<a name='2437'>
                                   msftx, msfty, msfux, msfuy,             &amp;<a name='2438'>
                                   msfvx, msfvy, xkhh, rdx, rdy,           &amp;<a name='2439'>
                                   fnm, fnp, cf1, cf2, cf3,                &amp;<a name='2440'>
                                   zx, zy, rdz, rdzw, dnw, dn, rho,        &amp;<a name='2441'>
                                   .false.,                                &amp;<a name='2442'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2443'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2444'>
                                   its, ite, jts, jte, kts, kte           )<a name='2445'>
<a name='2446'>
    IF (km_opt .eq. 2)                                                     &amp;<a name='2447'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_2">  ( tke_tendf(ims,kms,jms),                 &amp;<a name='2448'>
                                   config_flags,                           &amp;<a name='2449'>
                                   tke(ims,kms,jms),                       &amp;<a name='2450'>
                                   msftx, msfty, msfux, msfuy,             &amp;<a name='2451'>
                                   msfvx, msfvy, xkhh, rdx, rdy,           &amp;<a name='2452'>
                                   fnm, fnp, cf1, cf2, cf3,                &amp;<a name='2453'>
                                   zx, zy, rdz, rdzw, dnw, dn, rho,        &amp;<a name='2454'>
                                   .true.,                                 &amp;<a name='2455'>
                                   ids, ide, jds, jde, kds, kde,           &amp;<a name='2456'>
                                   ims, ime, jms, jme, kms, kme,           &amp;<a name='2457'>
                                   its, ite, jts, jte, kts, kte           )<a name='2458'>
<a name='2459'>
    IF (n_moist .ge. PARAM_FIRST_SCALAR) THEN<a name='2460'>
<a name='2461'>
      moist_loop: do im = PARAM_FIRST_SCALAR, n_moist<a name='2462'>
<a name='2463'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_3">( moist_tendf(ims,kms,jms,im),       &amp;<a name='2464'>
                                       config_flags,                      &amp;<a name='2465'>
                                       moist(ims,kms,jms,im),             &amp;<a name='2466'>
                                       msftx, msfty, msfux, msfuy,        &amp;<a name='2467'>
                                       msfvx, msfvy, xkhh, rdx, rdy,      &amp;<a name='2468'>
                                       fnm, fnp, cf1, cf2, cf3,           &amp;<a name='2469'>
                                       zx, zy, rdz, rdzw, dnw, dn, rho,   &amp;<a name='2470'>
                                       .false.,                           &amp;<a name='2471'>
                                       ids, ide, jds, jde, kds, kde,      &amp;<a name='2472'>
                                       ims, ime, jms, jme, kms, kme,      &amp;<a name='2473'>
                                       its, ite, jts, jte, kts, kte      )<a name='2474'>
<a name='2475'>
      ENDDO moist_loop<a name='2476'>
<a name='2477'>
    ENDIF<a name='2478'>
<a name='2479'>
    IF (n_chem .ge. PARAM_FIRST_SCALAR) THEN<a name='2480'>
<a name='2481'>
      chem_loop: do ic = PARAM_FIRST_SCALAR, n_chem<a name='2482'>
<a name='2483'>
        CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_4">( chem_tendf(ims,kms,jms,ic),     &amp;<a name='2484'>
                                     config_flags,                   &amp;<a name='2485'>
                                     chem(ims,kms,jms,ic),           &amp;<a name='2486'>
                                     msftx, msfty, msfux, msfuy,     &amp;<a name='2487'>
                                     msfvx, msfvy, xkhh, rdx, rdy,   &amp;<a name='2488'>
                                     fnm, fnp, cf1, cf2, cf3,        &amp;<a name='2489'>
                                     zx, zy, rdz, rdzw, dnw, dn, rho,&amp;<a name='2490'>
                                     .false.,                        &amp;<a name='2491'>
                                     ids, ide, jds, jde, kds, kde,   &amp;<a name='2492'>
                                     ims, ime, jms, jme, kms, kme,   &amp;<a name='2493'>
                                     its, ite, jts, jte, kts, kte    )<a name='2494'>
<a name='2495'>
      ENDDO chem_loop<a name='2496'>
<a name='2497'>
    ENDIF<a name='2498'>
<a name='2499'>
    IF (n_tracer .ge. PARAM_FIRST_SCALAR) THEN<a name='2500'>
<a name='2501'>
      tracer_loop: do ic = PARAM_FIRST_SCALAR, n_tracer<a name='2502'>
<a name='2503'>
        CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_5">( tracer_tendf(ims,kms,jms,ic),     &amp;<a name='2504'>
                                     config_flags,                     &amp;<a name='2505'>
                                     tracer(ims,kms,jms,ic),           &amp;<a name='2506'>
                                     msftx, msfty, msfux, msfuy,       &amp;<a name='2507'>
                                     msfvx, msfvy, xkhh, rdx, rdy,     &amp;<a name='2508'>
                                     fnm, fnp, cf1, cf2, cf3,          &amp;<a name='2509'>
                                     zx, zy, rdz, rdzw, dnw, dn, rho,  &amp;<a name='2510'>
                                     .false.,                          &amp;<a name='2511'>
                                     ids, ide, jds, jde, kds, kde,     &amp;<a name='2512'>
                                     ims, ime, jms, jme, kms, kme,     &amp;<a name='2513'>
                                     its, ite, jts, jte, kts, kte     )<a name='2514'>
<a name='2515'>
      ENDDO tracer_loop<a name='2516'>
<a name='2517'>
    ENDIF<a name='2518'>
    IF (n_scalar .ge. PARAM_FIRST_SCALAR) THEN<a name='2519'>
<a name='2520'>
      scalar_loop: do is = PARAM_FIRST_SCALAR, n_scalar<a name='2521'>
<a name='2522'>
        CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S'>horizontal_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_S_6">( scalar_tendf(ims,kms,jms,is),     &amp;<a name='2523'>
                                     config_flags,                     &amp;<a name='2524'>
                                     scalar(ims,kms,jms,is),           &amp;<a name='2525'>
                                     msftx, msfty, msfux, msfuy,       &amp;<a name='2526'>
                                     msfvx, msfvy, xkhh, rdx, rdy,     &amp;<a name='2527'>
                                     fnm, fnp, cf1, cf2, cf3,          &amp;<a name='2528'>
                                     zx, zy, rdz, rdzw, dnw, dn, rho,  &amp;<a name='2529'>
                                     .false.,                          &amp;<a name='2530'>
                                     ids, ide, jds, jde, kds, kde,     &amp;<a name='2531'>
                                     ims, ime, jms, jme, kms, kme,     &amp;<a name='2532'>
                                     its, ite, jts, jte, kts, kte     )<a name='2533'>
<a name='2534'>
      ENDDO scalar_loop<a name='2535'>
<a name='2536'>
    ENDIF<a name='2537'>
<a name='2538'>
    END SUBROUTINE horizontal_diffusion_2<a name='2539'>
<a name='2540'>
<font color=#447700>!=======================================================================<a name='2541'></font>
<font color=#447700>!=======================================================================<a name='2542'></font>
<a name='2543'>
<A NAME='HORIZONTAL_DIFFUSION_U_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_U_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2544'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_u_2</font>( tendency, config_flags,              &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_U_2.html' TARGET='index'>1</A>,<A href='../../call_from/HORIZONTAL_DIFFUSION_U_2.html' TARGET='index'>2</A><a name='2545'>
                                     defor11, defor12, div,               &amp;<a name='2546'>
                                     nba_mij, n_nba_mij,                  &amp;<a name='2547'>
                                     tke,                                 &amp;<a name='2548'>
                                     msfux, msfuy,                        &amp;<a name='2549'>
                                     xkmh, rdx, rdy, fnm, fnp,            &amp;<a name='2550'>
                                     dnw, zx, zy, rdzw, rho,              &amp;<a name='2551'>
                                     ids, ide, jds, jde, kds, kde,        &amp;<a name='2552'>
                                     ims, ime, jms, jme, kms, kme,        &amp;<a name='2553'>
                                     its, ite, jts, jte, kts, kte        )<a name='2554'>
<a name='2555'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2556'></font>
<font color=#447700>! Begin declarations.<a name='2557'></font>
<a name='2558'>
   IMPLICIT NONE<a name='2559'>
<a name='2560'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2561'>
<a name='2562'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2563'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2564'>
                                            its, ite, jts, jte, kts, kte<a name='2565'>
<a name='2566'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='2567'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='2568'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    dnw<a name='2569'>
<a name='2570'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::  msfux, &amp;<a name='2571'>
                                                                   msfuy<a name='2572'>
<a name='2573'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='2574'>
<a name='2575'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::   rdzw, &amp;<a name='2576'>
                                                                     rho<a name='2577'>
<a name='2578'>
<a name='2579'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor11, &amp;<a name='2580'>
                                                                 defor12, &amp;<a name='2581'>
                                                                     div, &amp;<a name='2582'>
                                                                     tke, &amp;<a name='2583'>
                                                                    xkmh, &amp;<a name='2584'>
                                                                      zx, &amp;<a name='2585'>
                                                                      zy<a name='2586'>
<a name='2587'>
   INTEGER, INTENT(  IN ) :: n_nba_mij<a name='2588'>
<a name='2589'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_mij),  INTENT(INOUT) &amp;<a name='2590'>
   :: nba_mij<a name='2591'>
<a name='2592'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='2593'>
                                                                     rdy<a name='2594'>
<font color=#447700>! Local data<a name='2595'></font>
<a name='2596'>
   INTEGER :: i, j, k, ktf<a name='2597'>
<a name='2598'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2599'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext<a name='2600'>
<a name='2601'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)    :: titau1avg, &amp;<a name='2602'>
                                                              titau2avg, &amp;<a name='2603'>
                                                                 titau1, &amp;<a name='2604'>
                                                                 titau2, &amp;<a name='2605'>
                                                                 xkxavg, &amp;<a name='2606'>
                                                                  rravg, &amp;<a name='2607'>
                                                                zy_at_u, &amp;<a name='2608'>
                                                                zx_at_u<a name='2609'>
<a name='2610'>
<font color=#447700>! new<a name='2611'></font>
<font color=#447700>!                                                                 zxavg, &amp;<a name='2612'></font>
<font color=#447700>!                                                                 zyavg<a name='2613'></font>
   REAL :: mrdx, mrdy, rcoup<a name='2614'>
<a name='2615'>
   REAL :: tmpzy, tmpzeta_z<a name='2616'>
<a name='2617'>
   REAL :: tmpdz<a name='2618'>
<a name='2619'>
   REAL :: term1, term2, term3<a name='2620'>
<a name='2621'>
<font color=#447700>! End declarations.<a name='2622'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2623'></font>
<a name='2624'>
   ktf=MIN(kte,kde-1)<a name='2625'>
<a name='2626'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2627'></font>
<font color=#447700>! u :   p (.), u(|), w(-)<a name='2628'></font>
<font color=#447700>!<a name='2629'></font>
<font color=#447700>!       p  u  p  u                                  u     u<a name='2630'></font>
<font color=#447700>!<a name='2631'></font>
<font color=#447700>! p  |  .  |  .  |  .  |   k+1                |  .  |  .  |  .  |   k+1<a name='2632'></font>
<font color=#447700>!<a name='2633'></font>
<font color=#447700>! w     - 13  -     -      k+1                     13               k+1<a name='2634'></font>
<font color=#447700>!<a name='2635'></font>
<font color=#447700>! p  |  11 O 11  |  .  |   k                  |  12 O 12  |  .  |   k<a name='2636'></font>
<font color=#447700>!<a name='2637'></font>
<font color=#447700>! w     - 13  -     -      k                       13               k<a name='2638'></font>
<font color=#447700>!<a name='2639'></font>
<font color=#447700>! p  |  .  |  .  |  .  |   k-1                |  .  |  .  |  .  |   k-1<a name='2640'></font>
<font color=#447700>!<a name='2641'></font>
<font color=#447700>!      i-1 i  i i+1                          j-1 j  j j+1 j+1<a name='2642'></font>
<font color=#447700>!<a name='2643'></font>
<a name='2644'>
   i_start = its<a name='2645'>
   i_end   = ite<a name='2646'>
   j_start = jts<a name='2647'>
   j_end   = MIN(jte,jde-1)<a name='2648'>
<a name='2649'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='2650'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='2651'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='2652'>
        config_flags%nested) i_end   = MIN(ide-1,ite)<a name='2653'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='2654'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='2655'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='2656'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='2657'>
      IF ( config_flags%periodic_x ) i_start = its<a name='2658'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='2659'>
<a name='2660'>
<font color=#447700>! titau1 = titau11<a name='2661'></font>
   is_ext=1<a name='2662'>
   ie_ext=0<a name='2663'>
   js_ext=0<a name='2664'>
   je_ext=0<a name='2665'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_11_22_33'>cal_titau_11_22_33</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_U_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_11_22_33_1">( config_flags, titau1,            &amp;<a name='2666'>
                            tke, xkmh, defor11,              &amp;<a name='2667'>
                            nba_mij(ims,kms,jms,P_m11), rho, &amp;<a name='2668'>
                            is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='2669'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='2670'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='2671'>
                            its, ite, jts, jte, kts, kte     )<a name='2672'>
<a name='2673'>
<font color=#447700>! titau2 = titau12<a name='2674'></font>
   is_ext=0<a name='2675'>
   ie_ext=0<a name='2676'>
   js_ext=0<a name='2677'>
   je_ext=1<a name='2678'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_12_21'>cal_titau_12_21</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_U_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_12_21_1">( config_flags, titau2,            &amp;<a name='2679'>
                         xkmh, defor12,                   &amp;<a name='2680'>
                         nba_mij(ims,kms,jms,P_m12), rho, &amp;<a name='2681'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='2682'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='2683'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='2684'>
                         its, ite, jts, jte, kts, kte     )<a name='2685'>
<a name='2686'>
<font color=#447700>! titau1avg = titau11avg<a name='2687'></font>
<font color=#447700>! titau2avg = titau12avg<a name='2688'></font>
<a name='2689'>
   DO j = j_start, j_end<a name='2690'>
   DO k = kts+1,ktf<a name='2691'>
   DO i = i_start, i_end<a name='2692'>
      titau1avg(i,k,j)=0.5*(fnm(k)*(titau1(i-1,k  ,j)+titau1(i,k  ,j))+ &amp;<a name='2693'>
                            fnp(k)*(titau1(i-1,k-1,j)+titau1(i,k-1,j)))<a name='2694'>
      titau2avg(i,k,j)=0.5*(fnm(k)*(titau2(i,k  ,j+1)+titau2(i,k  ,j))+ &amp;<a name='2695'>
                            fnp(k)*(titau2(i,k-1,j+1)+titau2(i,k-1,j)))<a name='2696'>
<font color=#447700>!     tmpzy = 0.25*( zy(i-1,k,j  )+zy(i,k,j  )+ &amp;<a name='2697'></font>
<font color=#447700>!                    zy(i-1,k,j+1)+zy(i,k,j+1)  )<a name='2698'></font>
<font color=#447700>!      tmpzeta_z = 0.5*(zeta_z(i,j)+zeta_z(i-1,j))<a name='2699'></font>
<font color=#447700>!      titau1avg(i,k,j)=titau1avg(i,k,j)*zx(i,k,j)*tmpzeta_z<a name='2700'></font>
<font color=#447700>!      titau2avg(i,k,j)=titau2avg(i,k,j)*tmpzy    *tmpzeta_z<a name='2701'></font>
<a name='2702'>
      zx_at_u(i, k, j) = 0.5 * (zx(i, k, j) + zx(i, k + 1 , j))<a name='2703'>
      zy_at_u(i, k, j) = 0.125 * (zy(i - 1, k, j) + zy(i, k, j) + &amp;<a name='2704'>
          zy(i - 1, k, j + 1) + zy(i, k, j + 1) + zy(i - 1, k + 1, j) + &amp;<a name='2705'>
          zy(i, k + 1, j) + zy(i - 1, k + 1, j + 1) + zy(i, k + 1, j + 1))<a name='2706'>
<a name='2707'>
<font color=#447700>!     titau1avg(i,k,j)=titau1avg(i,k,j)*zx(i,k,j)<a name='2708'></font>
<font color=#447700>!     titau2avg(i,k,j)=titau2avg(i,k,j)*tmpzy<a name='2709'></font>
<a name='2710'>
   ENDDO<a name='2711'>
   ENDDO<a name='2712'>
   ENDDO<a name='2713'>
<font color=#447700>!<a name='2714'></font>
   DO j = j_start, j_end<a name='2715'>
   DO i = i_start, i_end<a name='2716'>
      titau1avg(i,kts,j)=0.<a name='2717'>
      titau1avg(i,ktf+1,j)=0.<a name='2718'>
      titau2avg(i,kts,j)=0.<a name='2719'>
      titau2avg(i,ktf+1,j)=0.<a name='2720'>
      zx_at_u(i, kts, j) = 0.5 * (zx(i, kts, j) + zx(i, kts + 1 , j))<a name='2721'>
      zy_at_u(i, kts, j) = 0.125 * (zy(i - 1, kts, j) + zy(i, kts, j) + &amp;<a name='2722'>
          zy(i - 1, kts, j + 1) + zy(i, kts, j + 1) + zy(i - 1, kts + 1, j) + &amp;<a name='2723'>
          zy(i, kts + 1, j) + zy(i - 1, kts + 1, j + 1) + zy(i, kts + 1, j + 1))<a name='2724'>
   ENDDO<a name='2725'>
   ENDDO<a name='2726'>
<font color=#447700>!<a name='2727'></font>
   DO j = j_start, j_end<a name='2728'>
   DO k = kts,ktf<a name='2729'>
   DO i = i_start, i_end<a name='2730'>
<a name='2731'>
      mrdx=msfux(i,j)*rdx<a name='2732'>
      mrdy=msfuy(i,j)*rdy<a name='2733'>
<a name='2734'>
      tmpdz = (1./rdzw(i,k,j)+1./rdzw(i-1,k,j))/2.<a name='2735'>
      tendency(i,k,j)=tendency(i,k,j) +  g*tmpdz/dnw(k) *             &amp;<a name='2736'>
           (mrdx*(titau1(i,k,j  ) - titau1(i-1,k,j)) +                &amp;<a name='2737'>
            mrdy*(titau2(i,k,j+1) - titau2(i  ,k,j)) -                &amp;<a name='2738'>
            msfuy(i,j)*zx_at_u(i,k,j)*(titau1avg(i,k+1,j)-titau1avg(i,k,j)) / tmpdz - &amp;<a name='2739'>
            msfuy(i,j)*zy_at_u(i,k,j)*(titau2avg(i,k+1,j)-titau2avg(i,k,j)) / tmpdz   &amp;<a name='2740'>
                                                                  )<a name='2741'>
   ENDDO<a name='2742'>
   ENDDO<a name='2743'>
   ENDDO<a name='2744'>
<a name='2745'>
END SUBROUTINE horizontal_diffusion_u_2<a name='2746'>
<a name='2747'>
<font color=#447700>!=======================================================================<a name='2748'></font>
<font color=#447700>!=======================================================================<a name='2749'></font>
<a name='2750'>
<A NAME='HORIZONTAL_DIFFUSION_V_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_V_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2751'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_v_2</font>( tendency, config_flags,              &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_V_2.html' TARGET='index'>1</A>,<A href='../../call_from/HORIZONTAL_DIFFUSION_V_2.html' TARGET='index'>2</A><a name='2752'>
                                     defor12, defor22, div,               &amp;<a name='2753'>
                                     nba_mij, n_nba_mij,                  &amp;<a name='2754'>
                                     tke,                                 &amp;<a name='2755'>
                                     msfvx, msfvy,                        &amp;<a name='2756'>
                                     xkmh, rdx, rdy, fnm, fnp,            &amp;<a name='2757'>
                                     dnw, zx, zy, rdzw, rho,              &amp;<a name='2758'>
                                     ids, ide, jds, jde, kds, kde,        &amp;<a name='2759'>
                                     ims, ime, jms, jme, kms, kme,        &amp;<a name='2760'>
                                     its, ite, jts, jte, kts, kte        )<a name='2761'>
<a name='2762'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2763'></font>
<font color=#447700>! Begin declarations.<a name='2764'></font>
<a name='2765'>
   IMPLICIT NONE<a name='2766'>
<a name='2767'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2768'>
<a name='2769'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2770'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2771'>
                                            its, ite, jts, jte, kts, kte<a name='2772'>
<a name='2773'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='2774'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='2775'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    dnw<a name='2776'>
<a name='2777'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::  msfvx, &amp;<a name='2778'>
                                                                   msfvy<a name='2779'>
<a name='2780'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: tendency<a name='2781'>
<a name='2782'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor12, &amp;<a name='2783'>
                                                                 defor22, &amp;<a name='2784'>
                                                                     div, &amp;<a name='2785'>
                                                                     tke, &amp;<a name='2786'>
                                                                    xkmh, &amp;<a name='2787'>
                                                                      zx, &amp;<a name='2788'>
                                                                      zy, &amp;<a name='2789'>
                                                                    rdzw, &amp;<a name='2790'>
                                                                     rho<a name='2791'>
<a name='2792'>
   INTEGER,  INTENT(  IN ) :: n_nba_mij<a name='2793'>
<a name='2794'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_mij),  INTENT(INOUT) &amp;<a name='2795'>
   :: nba_mij<a name='2796'>
<a name='2797'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='2798'>
                                                                     rdy<a name='2799'>
<a name='2800'>
<font color=#447700>! Local data<a name='2801'></font>
<a name='2802'>
   INTEGER :: i, j, k, ktf<a name='2803'>
<a name='2804'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2805'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext<a name='2806'>
<a name='2807'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)    :: titau1avg, &amp;<a name='2808'>
                                                              titau2avg, &amp;<a name='2809'>
                                                                 titau1, &amp;<a name='2810'>
                                                                 titau2, &amp;<a name='2811'>
                                                                 xkxavg, &amp;<a name='2812'>
                                                                  rravg, &amp;<a name='2813'>
                                                                zy_at_v, &amp;<a name='2814'>
                                                                zx_at_v<a name='2815'>
<font color=#447700>! new<a name='2816'></font>
<font color=#447700>!                                                                 zxavg, &amp;<a name='2817'></font>
<font color=#447700>!                                                                 zyavg<a name='2818'></font>
<a name='2819'>
   REAL :: mrdx, mrdy, rcoup<a name='2820'>
   REAL :: tmpdz<a name='2821'>
   REAL :: tmpzx, tmpzeta_z<a name='2822'>
<a name='2823'>
<font color=#447700>! End declarations.<a name='2824'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2825'></font>
<a name='2826'>
   ktf=MIN(kte,kde-1)<a name='2827'>
<a name='2828'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2829'></font>
<font color=#447700>! v :   p (.), v(+), w(-)<a name='2830'></font>
<font color=#447700>!<a name='2831'></font>
<font color=#447700>!       p  v  p  v                                  v     v<a name='2832'></font>
<font color=#447700>!<a name='2833'></font>
<font color=#447700>! p  +  .  +  .  +  .  +   k+1                +  .  +  .  +  .  +   k+1<a name='2834'></font>
<font color=#447700>!<a name='2835'></font>
<font color=#447700>! w     - 23  -     -      k+1                     23               k+1<a name='2836'></font>
<font color=#447700>!<a name='2837'></font>
<font color=#447700>! p  +  22 O 22  +  .  +   k                  +  21 O 21  +  .  +   k<a name='2838'></font>
<font color=#447700>!<a name='2839'></font>
<font color=#447700>! w     - 23  -     -      k                       23               k<a name='2840'></font>
<font color=#447700>!<a name='2841'></font>
<font color=#447700>! p  +  .  +  .  +  .  +   k-1                +  .  +  .  +  .  +   k-1<a name='2842'></font>
<font color=#447700>!<a name='2843'></font>
<font color=#447700>!      j-1 j  j j+1                          i-1 i  i i+1 i+1<a name='2844'></font>
<font color=#447700>!<a name='2845'></font>
<a name='2846'>
   i_start = its<a name='2847'>
   i_end   = MIN(ite,ide-1)<a name='2848'>
   j_start = jts<a name='2849'>
   j_end   = jte<a name='2850'>
<a name='2851'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='2852'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='2853'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='2854'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='2855'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='2856'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='2857'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='2858'>
        config_flags%nested) j_end   = MIN(jde-1,jte)<a name='2859'>
      IF ( config_flags%periodic_x ) i_start = its<a name='2860'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='2861'>
<a name='2862'>
<font color=#447700>! titau1 = titau21<a name='2863'></font>
   is_ext=0<a name='2864'>
   ie_ext=1<a name='2865'>
   js_ext=0<a name='2866'>
   je_ext=0<a name='2867'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_12_21'>cal_titau_12_21</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_V_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_12_21_2">( config_flags, titau1,           &amp;<a name='2868'>
                         xkmh, defor12,                  &amp;<a name='2869'>
                         nba_mij(ims,kms,jms,P_m12),rho, &amp;<a name='2870'>
                         is_ext,ie_ext,js_ext,je_ext,    &amp;<a name='2871'>
                         ids, ide, jds, jde, kds, kde,   &amp;<a name='2872'>
                         ims, ime, jms, jme, kms, kme,   &amp;<a name='2873'>
                         its, ite, jts, jte, kts, kte    )<a name='2874'>
<a name='2875'>
<font color=#447700>! titau2 = titau22<a name='2876'></font>
   is_ext=0<a name='2877'>
   ie_ext=0<a name='2878'>
   js_ext=1<a name='2879'>
   je_ext=0<a name='2880'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_11_22_33'>cal_titau_11_22_33</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_V_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_11_22_33_2">( config_flags, titau2,           &amp;<a name='2881'>
                            tke, xkmh, defor22,             &amp;<a name='2882'>
                            nba_mij(ims,kms,jms,P_m22),rho, &amp;<a name='2883'>
                            is_ext, ie_ext, js_ext, je_ext, &amp;<a name='2884'>
                            ids, ide, jds, jde, kds, kde,   &amp;<a name='2885'>
                            ims, ime, jms, jme, kms, kme,   &amp;<a name='2886'>
                            its, ite, jts, jte, kts, kte    )<a name='2887'>
<a name='2888'>
   DO j = j_start, j_end<a name='2889'>
   DO k = kts+1,ktf<a name='2890'>
   DO i = i_start, i_end<a name='2891'>
      titau1avg(i,k,j)=0.5*(fnm(k)*(titau1(i+1,k  ,j)+titau1(i,k  ,j))+ &amp;<a name='2892'>
                            fnp(k)*(titau1(i+1,k-1,j)+titau1(i,k-1,j)))<a name='2893'>
      titau2avg(i,k,j)=0.5*(fnm(k)*(titau2(i,k  ,j-1)+titau2(i,k  ,j))+ &amp;<a name='2894'>
                            fnp(k)*(titau2(i,k-1,j-1)+titau2(i,k-1,j)))<a name='2895'>
<a name='2896'>
<font color=#447700>!      tmpzx = 0.25*( zx(i,k,j  )+zx(i+1,k,j  )+ &amp;<a name='2897'></font>
<font color=#447700>!                     zx(i,k,j-1)+zx(i+1,k,j-1)  )<a name='2898'></font>
      zx_at_v(i, k, j) = 0.125 * (zx(i, k, j) + zx(i + 1, k, j) +     &amp;<a name='2899'>
          zx(i, k, j - 1) + zx(i + 1, k, j - 1) + zx(i, k + 1, j) +   &amp;<a name='2900'>
          zx(i + 1, k + 1, j) + zx(i, k + 1, j - 1) + zx(i + 1, k + 1, j - 1))<a name='2901'>
      zy_at_v(i, k, j) = 0.5 * (zy(i, k, j) + zy(i, k + 1 , j))<a name='2902'>
<a name='2903'>
<font color=#447700>!     titau1avg(i,k,j)=titau1avg(i,k,j)*tmpzx<a name='2904'></font>
<font color=#447700>!     titau2avg(i,k,j)=titau2avg(i,k,j)*zy(i,k,j)<a name='2905'></font>
<a name='2906'>
<a name='2907'>
   ENDDO<a name='2908'>
   ENDDO<a name='2909'>
   ENDDO<a name='2910'>
<a name='2911'>
   DO j = j_start, j_end<a name='2912'>
   DO i = i_start, i_end<a name='2913'>
      titau1avg(i,kts,j)=0.<a name='2914'>
      titau1avg(i,ktf+1,j)=0.<a name='2915'>
      titau2avg(i,kts,j)=0.<a name='2916'>
      titau2avg(i,ktf+1,j)=0.<a name='2917'>
      zx_at_v(i, kts, j) = 0.125 * (zx(i, kts, j) + zx(i + 1, kts, j) +     &amp;<a name='2918'>
          zx(i, kts, j - 1) + zx(i + 1, kts, j - 1) + zx(i, kts + 1, j) + &amp;<a name='2919'>
          zx(i + 1, kts + 1, j) + zx(i, kts + 1, j - 1) + zx(i + 1, kts + 1, j - 1))<a name='2920'>
      zy_at_v(i, kts, j) = 0.5 * (zy(i, kts, j) + zy(i, kts + 1 , j))<a name='2921'>
   ENDDO<a name='2922'>
   ENDDO<a name='2923'>
<font color=#447700>!<a name='2924'></font>
   DO j = j_start, j_end<a name='2925'>
   DO k = kts,ktf<a name='2926'>
   DO i = i_start, i_end<a name='2927'>
<a name='2928'>
      mrdx=msfvx(i,j)*rdx<a name='2929'>
      mrdy=msfvy(i,j)*rdy<a name='2930'>
      tmpdz = (1./rdzw(i,k,j)+1./rdzw(i,k,j-1))/2.<a name='2931'>
      tendency(i,k,j)=tendency(i,k,j) +    g*tmpdz/dnw(k) *           &amp;<a name='2932'>
           (mrdy*(titau2(i,k,j  ) - titau2(i,k,j-1)) +                &amp;<a name='2933'>
            mrdx*(titau1(i+1,k,j) - titau1(i  ,k,j)) -                &amp;<a name='2934'>
            msfvy(i,j)*zx_at_v(i,k,j)*(titau1avg(i,k+1,j)-titau1avg(i,k,j)) / tmpdz - &amp;<a name='2935'>
            msfvy(i,j)*zy_at_v(i,k,j)*(titau2avg(i,k+1,j)-titau2avg(i,k,j)) / tmpdz   &amp;<a name='2936'>
                                                                  )<a name='2937'>
<a name='2938'>
   ENDDO<a name='2939'>
   ENDDO<a name='2940'>
   ENDDO<a name='2941'>
<a name='2942'>
END SUBROUTINE horizontal_diffusion_v_2<a name='2943'>
<a name='2944'>
<font color=#447700>!=======================================================================<a name='2945'></font>
<font color=#447700>!=======================================================================<a name='2946'></font>
<a name='2947'>
<A NAME='HORIZONTAL_DIFFUSION_W_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_W_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2948'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_w_2</font>( tendency, config_flags,              &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_W_2.html' TARGET='index'>1</A>,<A href='../../call_from/HORIZONTAL_DIFFUSION_W_2.html' TARGET='index'>2</A><a name='2949'>
                                     defor13, defor23, div,               &amp;<a name='2950'>
                                     nba_mij, n_nba_mij,                  &amp;<a name='2951'>
                                     tke,                                 &amp;<a name='2952'>
                                     msftx, msfty,                        &amp;<a name='2953'>
                                     xkmh, rdx, rdy, fnm, fnp,            &amp;<a name='2954'>
                                     dn, zx, zy, rdz, rho,                &amp;<a name='2955'>
                                     ids, ide, jds, jde, kds, kde,        &amp;<a name='2956'>
                                     ims, ime, jms, jme, kms, kme,        &amp;<a name='2957'>
                                     its, ite, jts, jte, kts, kte        )<a name='2958'>
<a name='2959'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2960'></font>
<font color=#447700>! Begin declarations.<a name='2961'></font>
<a name='2962'>
   IMPLICIT NONE<a name='2963'>
<a name='2964'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2965'>
<a name='2966'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='2967'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='2968'>
                                            its, ite, jts, jte, kts, kte<a name='2969'>
<a name='2970'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='2971'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='2972'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    dn<a name='2973'>
<a name='2974'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::  msftx, &amp;<a name='2975'>
                                                                   msfty<a name='2976'>
<a name='2977'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: tendency<a name='2978'>
<a name='2979'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor13, &amp;<a name='2980'>
                                                                 defor23, &amp;<a name='2981'>
                                                                     div, &amp;<a name='2982'>
                                                                     tke, &amp;<a name='2983'>
                                                                    xkmh, &amp;<a name='2984'>
                                                                      zx, &amp;<a name='2985'>
                                                                      zy, &amp;<a name='2986'>
                                                                     rdz, &amp;<a name='2987'>
                                                                     rho<a name='2988'>
<a name='2989'>
   INTEGER,  INTENT(  IN ) :: n_nba_mij<a name='2990'>
<a name='2991'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_mij),  INTENT(INOUT) &amp;<a name='2992'>
   :: nba_mij<a name='2993'>
<a name='2994'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='2995'>
                                                                     rdy<a name='2996'>
<a name='2997'>
<font color=#447700>! Local data<a name='2998'></font>
<a name='2999'>
   INTEGER :: i, j, k, ktf<a name='3000'>
<a name='3001'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3002'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext<a name='3003'>
<a name='3004'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)    :: titau1avg, &amp;<a name='3005'>
                                                              titau2avg, &amp;<a name='3006'>
                                                                 titau1, &amp;<a name='3007'>
                                                                 titau2, &amp;<a name='3008'>
                                                                 xkxavg, &amp;<a name='3009'>
                                                                  rravg, &amp;<a name='3010'>
                                                                zx_at_w, &amp;<a name='3011'>
                                                                zy_at_w<a name='3012'>
<font color=#447700>! new<a name='3013'></font>
<font color=#447700>!                                                                 zxavg, &amp;<a name='3014'></font>
<font color=#447700>!                                                                 zyavg<a name='3015'></font>
<a name='3016'>
   REAL :: mrdx, mrdy, rcoup<a name='3017'>
<a name='3018'>
   REAL :: tmpzx, tmpzy, tmpzeta_z<a name='3019'>
<a name='3020'>
<font color=#447700>! End declarations.<a name='3021'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3022'></font>
<a name='3023'>
   ktf=MIN(kte,kde-1)<a name='3024'>
<a name='3025'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3026'></font>
<font color=#447700>! w :   p (.), u(|), v(+), w(-)<a name='3027'></font>
<font color=#447700>!<a name='3028'></font>
<font color=#447700>!       p  u  p  u                               p  v  p  v<a name='3029'></font>
<font color=#447700>!<a name='3030'></font>
<font color=#447700>! w     -     -     -      k+1             w     -     -     -      k+1<a name='3031'></font>
<font color=#447700>!<a name='3032'></font>
<font color=#447700>! p     .  | 33  |  .      k               p     .  + 33  +  .      k<a name='3033'></font>
<font color=#447700>!<a name='3034'></font>
<font color=#447700>! w     -  31 O 31  -      k               w     -  32 O 32  -      k<a name='3035'></font>
<font color=#447700>!<a name='3036'></font>
<font color=#447700>! p     .  | 33  |  .      k-1             p     .  | 33  |  .      k-1<a name='3037'></font>
<font color=#447700>!<a name='3038'></font>
<font color=#447700>! w     -     -     -      k-1             w     -     -     -      k-1<a name='3039'></font>
<font color=#447700>!<a name='3040'></font>
<font color=#447700>!      i-1 i  i i+1                             j-1 j  j j+1<a name='3041'></font>
<font color=#447700>!<a name='3042'></font>
   i_start = its<a name='3043'>
   i_end   = MIN(ite,ide-1)<a name='3044'>
   j_start = jts<a name='3045'>
   j_end   = MIN(jte,jde-1)<a name='3046'>
<a name='3047'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='3048'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3049'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='3050'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='3051'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='3052'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3053'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='3054'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='3055'>
      IF ( config_flags%periodic_x ) i_start = its<a name='3056'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='3057'>
<a name='3058'>
<font color=#447700>! titau1 = titau31<a name='3059'></font>
   is_ext=0<a name='3060'>
   ie_ext=1<a name='3061'>
   js_ext=0<a name='3062'>
   je_ext=0<a name='3063'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_13_31'>cal_titau_13_31</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_W_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_13_31_1">( config_flags, titau1, defor13,   &amp;<a name='3064'>
                         nba_mij(ims,kms,jms,P_m13),      &amp;<a name='3065'>
                         xkmh, fnm, fnp, rho,             &amp;<a name='3066'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3067'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='3068'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='3069'>
                         its, ite, jts, jte, kts, kte     )<a name='3070'>
<a name='3071'>
<font color=#447700>! titau2 = titau32<a name='3072'></font>
   is_ext=0<a name='3073'>
   ie_ext=0<a name='3074'>
   js_ext=0<a name='3075'>
   je_ext=1<a name='3076'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_23_32'>cal_titau_23_32</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_W_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_23_32_1">( config_flags, titau2, defor23,   &amp;<a name='3077'>
                         nba_mij(ims,kms,jms,P_m23),      &amp;<a name='3078'>
                         xkmh, fnm, fnp, rho,             &amp;<a name='3079'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3080'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='3081'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='3082'>
                         its, ite, jts, jte, kts, kte     )<a name='3083'>
<a name='3084'>
<font color=#447700>! titau1avg = titau31avg * zx * zeta_z = titau13avg * zx * zeta_z<a name='3085'></font>
<font color=#447700>! titau2avg = titau32avg * zy * zeta_z = titau23avg * zy * zeta_z<a name='3086'></font>
<a name='3087'>
   DO j = j_start, j_end<a name='3088'>
   DO k = kts,ktf<a name='3089'>
   DO i = i_start, i_end<a name='3090'>
      titau1avg(i,k,j)=0.25*(titau1(i+1,k+1,j)+titau1(i,k+1,j)+ &amp;<a name='3091'>
                             titau1(i+1,k  ,j)+titau1(i,k  ,j))<a name='3092'>
      titau2avg(i,k,j)=0.25*(titau2(i,k+1,j+1)+titau2(i,k+1,j)+ &amp;<a name='3093'>
                             titau2(i,k  ,j+1)+titau2(i,k  ,j))<a name='3094'>
      zx_at_w(i, k, j) = 0.5 * (zx(i, k, j) + zx(i + 1, k, j))<a name='3095'>
      zy_at_w(i, k, j) = 0.5 * (zy(i, k, j) + zy(i, k, j + 1))<a name='3096'>
<font color=#447700>! new<a name='3097'></font>
<font color=#447700>!      tmpzx  =0.25*( zx(i,k  ,j)+zx(i+1,k  ,j)+ &amp;<a name='3098'></font>
<font color=#447700>!                     zx(i,k+1,j)+zx(i+1,k+1,j)  )<a name='3099'></font>
<font color=#447700>!      tmpzy  =0.25*( zy(i,k  ,j)+zy(i,k  ,j+1)+ &amp;<a name='3100'></font>
<font color=#447700>!                     zy(i,k+1,j)+zy(i,k+1,j+1)  )<a name='3101'></font>
<a name='3102'>
<font color=#447700>!      titau1avg(i,k,j)=titau1avg(i,k,j)*tmpzx<a name='3103'></font>
<font color=#447700>!      titau2avg(i,k,j)=titau2avg(i,k,j)*tmpzy<a name='3104'></font>
<font color=#447700>!      titau1avg(i,k,j)=titau1avg(i,k,j)*tmpzx*zeta_z(i,j)<a name='3105'></font>
<font color=#447700>!      titau2avg(i,k,j)=titau2avg(i,k,j)*tmpzy*zeta_z(i,j)<a name='3106'></font>
   ENDDO<a name='3107'>
   ENDDO<a name='3108'>
   ENDDO<a name='3109'>
<a name='3110'>
   DO j = j_start, j_end<a name='3111'>
   DO i = i_start, i_end<a name='3112'>
      titau1avg(i,ktf+1,j)=0.<a name='3113'>
      titau2avg(i,ktf+1,j)=0.<a name='3114'>
   ENDDO<a name='3115'>
   ENDDO<a name='3116'>
<a name='3117'>
   DO j = j_start, j_end<a name='3118'>
   DO k = kts+1,ktf<a name='3119'>
   DO i = i_start, i_end<a name='3120'>
<a name='3121'>
      mrdx=msftx(i,j)*rdx<a name='3122'>
      mrdy=msfty(i,j)*rdy<a name='3123'>
<a name='3124'>
     tendency(i,k,j)=tendency(i,k,j) +   g/(dn(k)*rdz(i,k,j)) *         &amp;<a name='3125'>
           (mrdx*(titau1(i+1,k,j)-titau1(i,k,j))+                       &amp;<a name='3126'>
            mrdy*(titau2(i,k,j+1)-titau2(i,k,j))-                       &amp;<a name='3127'>
            msfty(i,j)*rdz(i,k,j)*(zx_at_w(i,k,j)*(titau1avg(i,k,j)-titau1avg(i,k-1,j))+ &amp;<a name='3128'>
                                   zy_at_w(i,k,j)*(titau2avg(i,k,j)-titau2avg(i,k-1,j))  &amp;<a name='3129'>
                                  )                                     &amp;<a name='3130'>
           )<a name='3131'>
   ENDDO<a name='3132'>
   ENDDO<a name='3133'>
   ENDDO<a name='3134'>
<a name='3135'>
END SUBROUTINE horizontal_diffusion_w_2<a name='3136'>
<a name='3137'>
<font color=#447700>!=======================================================================<a name='3138'></font>
<font color=#447700>!=======================================================================<a name='3139'></font>
<a name='3140'>
<A NAME='HORIZONTAL_DIFFUSION_S'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#HORIZONTAL_DIFFUSION_S' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3141'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_s</font> (tendency, config_flags, var,           &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_S.html' TARGET='index'>6</A><a name='3142'>
                                   msftx, msfty, msfux, msfuy,            &amp;<a name='3143'>
                                   msfvx, msfvy, xkhh, rdx, rdy,          &amp;<a name='3144'>
                                   fnm, fnp, cf1, cf2, cf3,               &amp;<a name='3145'>
                                   zx, zy, rdz, rdzw, dnw, dn, rho,       &amp;<a name='3146'>
                                   doing_tke,                             &amp;<a name='3147'>
                                   ids, ide, jds, jde, kds, kde,          &amp;<a name='3148'>
                                   ims, ime, jms, jme, kms, kme,          &amp;<a name='3149'>
                                   its, ite, jts, jte, kts, kte           )<a name='3150'>
<a name='3151'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3152'></font>
<font color=#447700>! Begin declarations.<a name='3153'></font>
<a name='3154'>
   IMPLICIT NONE<a name='3155'>
<a name='3156'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3157'>
<a name='3158'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='3159'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3160'>
                                            its, ite, jts, jte, kts, kte<a name='3161'>
<a name='3162'>
   LOGICAL,         INTENT(IN   ) ::        doing_tke<a name='3163'>
<a name='3164'>
   REAL , INTENT(IN   )           ::        cf1, cf2, cf3<a name='3165'>
<a name='3166'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='3167'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='3168'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::     dn<a name='3169'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    dnw<a name='3170'>
<a name='3171'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfux<a name='3172'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfuy<a name='3173'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfvx<a name='3174'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfvy<a name='3175'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msftx<a name='3176'>
   REAL , DIMENSION( ims:ime, jms:jme) ,         INTENT(IN   ) ::   msfty<a name='3177'>
<a name='3178'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: tendency<a name='3179'>
<a name='3180'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::         &amp;<a name='3181'>
                                                                    xkhh, &amp;<a name='3182'>
                                                                     rdz, &amp;<a name='3183'>
                                                                    rdzw, &amp;<a name='3184'>
                                                                     rho<a name='3185'>
<a name='3186'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::    var, &amp;<a name='3187'>
                                                                      zx, &amp;<a name='3188'>
                                                                      zy<a name='3189'>
<a name='3190'>
   REAL ,                                        INTENT(IN   ) ::    rdx, &amp;<a name='3191'>
                                                                     rdy<a name='3192'>
<a name='3193'>
<font color=#447700>! Local data<a name='3194'></font>
<a name='3195'>
   INTEGER :: i, j, k, ktf<a name='3196'>
<a name='3197'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3198'>
<a name='3199'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)    ::     H1avg, &amp;<a name='3200'>
                                                                  H2avg, &amp;<a name='3201'>
                                                                     H1, &amp;<a name='3202'>
                                                                     H2, &amp;<a name='3203'>
                                                                 xkxavg, &amp;<a name='3204'>
                                                                zx_at_m, &amp;<a name='3205'>
                                                                zy_at_m<a name='3206'>
<a name='3207'>
   REAL , DIMENSION( its:ite, kts:kte, jts:jte)            ::  tmptendf<a name='3208'>
<a name='3209'>
   REAL    :: mrdx, mrdy, rcoup<a name='3210'>
   REAL    :: tmpzx, tmpzy, tmpzeta_z, rdzu, rdzv<a name='3211'>
   INTEGER :: ktes1,ktes2<a name='3212'>
<a name='3213'>
<font color=#447700>! End declarations.<a name='3214'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3215'></font>
<a name='3216'>
   ktf=MIN(kte,kde-1)<a name='3217'>
<a name='3218'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3219'></font>
<font color=#447700>! scalars:   t (.), u(|), v(+), w(-)<a name='3220'></font>
<font color=#447700>!<a name='3221'></font>
<font color=#447700>!       t  u  t  u                               t  v  t  v<a name='3222'></font>
<font color=#447700>!<a name='3223'></font>
<font color=#447700>! w     -     3     -      k+1             w     -     3     -      k+1<a name='3224'></font>
<font color=#447700>!<a name='3225'></font>
<font color=#447700>! t     .  1  O  1  .      k               t     .  2  O  2  .      k<a name='3226'></font>
<font color=#447700>!<a name='3227'></font>
<font color=#447700>! w     -     3     -      k               w     -     3     -      k<a name='3228'></font>
<font color=#447700>!<a name='3229'></font>
<font color=#447700>! t     .  |  .  |  .      k-1             t     .  +  .  +  .      k-1<a name='3230'></font>
<font color=#447700>!<a name='3231'></font>
<font color=#447700>! w     -     -     -      k-1             w     -     -     -      k-1<a name='3232'></font>
<font color=#447700>!<a name='3233'></font>
<font color=#447700>! t    i-1 i  i i+1                             j-1 j  j j+1<a name='3234'></font>
<font color=#447700>!<a name='3235'></font>
<a name='3236'>
   ktes1=kte-1<a name='3237'>
   ktes2=kte-2<a name='3238'>
<a name='3239'>
   i_start = its<a name='3240'>
   i_end   = MIN(ite,ide-1)<a name='3241'>
   j_start = jts<a name='3242'>
   j_end   = MIN(jte,jde-1)<a name='3243'>
<a name='3244'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='3245'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3246'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='3247'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='3248'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='3249'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3250'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='3251'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='3252'>
      IF ( config_flags%periodic_x ) i_start = its<a name='3253'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='3254'>
<a name='3255'>
<font color=#447700>! diffusion of the TKE needs mutiple 2<a name='3256'></font>
<a name='3257'>
   IF ( doing_tke ) THEN<a name='3258'>
      DO j = j_start, j_end<a name='3259'>
      DO k = kts,ktf<a name='3260'>
      DO i = i_start, i_end<a name='3261'>
         tmptendf(i,k,j)=tendency(i,k,j)<a name='3262'>
      ENDDO<a name='3263'>
      ENDDO<a name='3264'>
      ENDDO<a name='3265'>
   ENDIF<a name='3266'>
<a name='3267'>
<font color=#447700>! H1 = partial var over partial x<a name='3268'></font>
<a name='3269'>
   DO j = j_start, j_end<a name='3270'>
   DO k = kts, ktf<a name='3271'>
   DO i = i_start, i_end + 1<a name='3272'>
      xkxavg(i,k,j)=0.5*(xkhh(i-1,k,j)+xkhh(i,k,j))*0.5*(rho(i-1,k,j)+rho(i,k,j))<a name='3273'>
   ENDDO<a name='3274'>
   ENDDO<a name='3275'>
   ENDDO<a name='3276'>
<a name='3277'>
   DO j = j_start, j_end<a name='3278'>
   DO k = kts+1, ktf<a name='3279'>
   DO i = i_start, i_end + 1<a name='3280'>
      H1avg(i,k,j)=0.5*(fnm(k)*(var(i-1,k  ,j)+var(i,k  ,j))+  &amp;<a name='3281'>
                        fnp(k)*(var(i-1,k-1,j)+var(i,k-1,j)))<a name='3282'>
   ENDDO<a name='3283'>
   ENDDO<a name='3284'>
   ENDDO<a name='3285'>
<a name='3286'>
   DO j = j_start, j_end<a name='3287'>
   DO i = i_start, i_end + 1<a name='3288'>
      H1avg(i,kts  ,j)=0.5*(cf1*var(i  ,1,j)+cf2*var(i  ,2,j)+ &amp;<a name='3289'>
                            cf3*var(i  ,3,j)+cf1*var(i-1,1,j)+  &amp;<a name='3290'>
                            cf2*var(i-1,2,j)+cf3*var(i-1,3,j))<a name='3291'>
      H1avg(i,ktf+1,j)=0.5*(var(i,ktes1,j)+(var(i,ktes1,j)- &amp;<a name='3292'>
                            var(i,ktes2,j))*0.5*dnw(ktes1)/dn(ktes1)+ &amp;<a name='3293'>
                            var(i-1,ktes1,j)+(var(i-1,ktes1,j)- &amp;<a name='3294'>
                            var(i-1,ktes2,j))*0.5*dnw(ktes1)/dn(ktes1))<a name='3295'>
   ENDDO<a name='3296'>
   ENDDO<a name='3297'>
<a name='3298'>
   DO j = j_start, j_end<a name='3299'>
   DO k = kts, ktf<a name='3300'>
   DO i = i_start, i_end + 1<a name='3301'>
<font color=#447700>! new<a name='3302'></font>
      tmpzx = 0.5*( zx(i,k,j)+ zx(i,k+1,j))<a name='3303'>
      rdzu = 2./(1./rdzw(i,k,j) + 1./rdzw(i-1,k,j))<a name='3304'>
      H1(i,k,j)=-msfux(i,j)*xkxavg(i,k,j)*(                      &amp;<a name='3305'>
                 rdx*(var(i,k,j)-var(i-1,k,j)) - tmpzx*         &amp;<a name='3306'>
                     (H1avg(i,k+1,j)-H1avg(i,k,j))*rdzu )<a name='3307'>
<a name='3308'>
<font color=#447700>!      tmpzeta_z = 0.5*(zeta_z(i,j)+zeta_z(i-1,j))<a name='3309'></font>
<font color=#447700>!      H1(i,k,j)=-msfuy(i,j)*xkxavg(i,k,j)*(                         &amp;<a name='3310'></font>
<font color=#447700>!                 rdx*(var(i,k,j)-var(i-1,k,j)) - tmpzx*tmpzeta_z*  &amp;<a name='3311'></font>
<font color=#447700>!                     (H1avg(i,k+1,j)-H1avg(i,k,j))/dnw(k))<a name='3312'></font>
   ENDDO<a name='3313'>
   ENDDO<a name='3314'>
   ENDDO<a name='3315'>
<a name='3316'>
<font color=#447700>! H2 = partial var over partial y<a name='3317'></font>
<a name='3318'>
   DO j = j_start, j_end + 1<a name='3319'>
   DO k = kts, ktf<a name='3320'>
   DO i = i_start, i_end<a name='3321'>
      xkxavg(i,k,j)=0.5*(xkhh(i,k,j-1)+xkhh(i,k,j))*0.5*(rho(i,k,j-1)+rho(i,k,j))<a name='3322'>
   ENDDO<a name='3323'>
   ENDDO<a name='3324'>
   ENDDO<a name='3325'>
<a name='3326'>
   DO j = j_start, j_end + 1<a name='3327'>
   DO k = kts+1,   ktf<a name='3328'>
   DO i = i_start, i_end<a name='3329'>
      H2avg(i,k,j)=0.5*(fnm(k)*(var(i,k  ,j-1)+var(i,k  ,j))+  &amp;<a name='3330'>
                        fnp(k)*(var(i,k-1,j-1)+var(i,k-1,j)))<a name='3331'>
   ENDDO<a name='3332'>
   ENDDO<a name='3333'>
   ENDDO<a name='3334'>
<a name='3335'>
   DO j = j_start, j_end + 1<a name='3336'>
   DO i = i_start, i_end<a name='3337'>
      H2avg(i,kts  ,j)=0.5*(cf1*var(i,1,j  )+cf2*var(i  ,2,j)+ &amp;<a name='3338'>
                            cf3*var(i,3,j  )+cf1*var(i,1,j-1)+  &amp;<a name='3339'>
                            cf2*var(i,2,j-1)+cf3*var(i,3,j-1))<a name='3340'>
      H2avg(i,ktf+1,j)=0.5*(var(i,ktes1,j)+(var(i,ktes1,j)- &amp;<a name='3341'>
                            var(i,ktes2,j))*0.5*dnw(ktes1)/dn(ktes1)+ &amp;<a name='3342'>
                            var(i,ktes1,j-1)+(var(i,ktes1,j-1)- &amp;<a name='3343'>
                            var(i,ktes2,j-1))*0.5*dnw(ktes1)/dn(ktes1))<a name='3344'>
   ENDDO<a name='3345'>
   ENDDO<a name='3346'>
<a name='3347'>
   DO j = j_start, j_end + 1<a name='3348'>
   DO k = kts, ktf<a name='3349'>
   DO i = i_start, i_end<a name='3350'>
<font color=#447700>! new<a name='3351'></font>
      tmpzy = 0.5*( zy(i,k,j)+ zy(i,k+1,j))<a name='3352'>
      rdzv = 2./(1./rdzw(i,k,j) + 1./rdzw(i,k,j-1))<a name='3353'>
      H2(i,k,j)=-msfvy(i,j)*xkxavg(i,k,j)*(                       &amp;<a name='3354'>
                 rdy*(var(i,k,j)-var(i,k,j-1)) - tmpzy*          &amp;<a name='3355'>
                     (H2avg(i ,k+1,j)-H2avg(i,k,j))*rdzv)<a name='3356'>
<a name='3357'>
<font color=#447700>!      tmpzeta_z = 0.5*(zeta_z(i,j)+zeta_z(i,j-1))<a name='3358'></font>
<font color=#447700>!      H2(i,k,j)=-msfvy(i,j)*xkxavg(i,k,j)*(                         &amp;<a name='3359'></font>
<font color=#447700>!                 rdy*(var(i,k,j)-var(i,k,j-1)) - tmpzy*tmpzeta_z*  &amp;<a name='3360'></font>
<font color=#447700>!                     (H2avg(i ,k+1,j)-H2avg(i,k,j))/dnw(k))<a name='3361'></font>
   ENDDO<a name='3362'>
   ENDDO<a name='3363'>
   ENDDO<a name='3364'>
<a name='3365'>
   DO j = j_start, j_end<a name='3366'>
   DO k = kts+1, ktf<a name='3367'>
   DO i = i_start, i_end<a name='3368'>
      H1avg(i,k,j)=0.5*(fnm(k)*(H1(i+1,k  ,j)+H1(i,k  ,j))+  &amp;<a name='3369'>
                        fnp(k)*(H1(i+1,k-1,j)+H1(i,k-1,j)))<a name='3370'>
      H2avg(i,k,j)=0.5*(fnm(k)*(H2(i,k  ,j+1)+H2(i,k  ,j))+  &amp;<a name='3371'>
                        fnp(k)*(H2(i,k-1,j+1)+H2(i,k-1,j)))<a name='3372'>
<font color=#447700>! new<a name='3373'></font>
<font color=#447700>!     zxavg(i,k,j)=fnm(k)*zx(i,k,j)+fnp(k)*zx(i,k-1,j)<a name='3374'></font>
<font color=#447700>!     zyavg(i,k,j)=fnm(k)*zy(i,k,j)+fnp(k)*zy(i,k-1,j)<a name='3375'></font>
<a name='3376'>
<font color=#447700>! H1avg(i,k,j)=zx*H1avg*zeta_z<a name='3377'></font>
<font color=#447700>! H2avg(i,k,j)=zy*H2avg*zeta_z<a name='3378'></font>
<a name='3379'>
      zx_at_m(i, k, j) = 0.25*(zx(i,k,j)+ zx(i+1,k,j) + zx(i,k+1,j)+ zx(i+1,k+1,j))<a name='3380'>
      zy_at_m(i, k, j) = 0.25*(zy(i,k,j)+ zy(i,k,j+1) + zy(i,k+1,j)+ zy(i,k+1,j+1))<a name='3381'>
<a name='3382'>
<font color=#447700>!      H1avg(i,k,j)=H1avg(i,k,j)*tmpzx*zeta_z(i,j)<a name='3383'></font>
<font color=#447700>!      H2avg(i,k,j)=H2avg(i,k,j)*tmpzy*zeta_z(i,j)<a name='3384'></font>
   ENDDO<a name='3385'>
   ENDDO<a name='3386'>
   ENDDO<a name='3387'>
<a name='3388'>
   DO j = j_start, j_end<a name='3389'>
   DO i = i_start, i_end<a name='3390'>
      H1avg(i,kts  ,j)=0.<a name='3391'>
      H1avg(i,ktf+1,j)=0.<a name='3392'>
      H2avg(i,kts  ,j)=0.<a name='3393'>
      H2avg(i,ktf+1,j)=0.<a name='3394'>
      zx_at_m(i, kts, j) = 0.25*(zx(i,kts,j)+ zx(i+1,kts,j) + zx(i,kts+1,j)+ zx(i+1,kts+1,j))<a name='3395'>
      zy_at_m(i, kts, j) = 0.25*(zy(i,kts,j)+ zy(i,kts,j+1) + zy(i,kts+1,j)+ zy(i,kts+1,j+1))<a name='3396'>
<a name='3397'>
   ENDDO<a name='3398'>
   ENDDO<a name='3399'>
<a name='3400'>
   DO j = j_start, j_end<a name='3401'>
   DO k = kts,ktf<a name='3402'>
   DO i = i_start, i_end<a name='3403'>
<a name='3404'>
      mrdx=msftx(i,j)*rdx<a name='3405'>
      mrdy=msfty(i,j)*rdy<a name='3406'>
<a name='3407'>
      tendency(i,k,j)=tendency(i,k,j) +   g/(dnw(k)*rdzw(i,k,j)) * &amp;<a name='3408'>
           (mrdx*(H1(i+1,k,j)-H1(i  ,k,j)) +                       &amp;<a name='3409'>
            mrdy*(H2(i,k,j+1)-H2(i,k,j  )) -                       &amp;<a name='3410'>
            msftx(i,j)*zx_at_m(i, k, j)*(H1avg(i,k+1,j)-H1avg(i,k,j))*rdzw(i,k,j) - &amp;<a name='3411'>
            msfty(i,j)*zy_at_m(i, k, j)*(H2avg(i,k+1,j)-H2avg(i,k,j))*rdzw(i,k,j)   &amp;<a name='3412'>
           )<a name='3413'>
   ENDDO<a name='3414'>
   ENDDO<a name='3415'>
   ENDDO<a name='3416'>
<a name='3417'>
   IF ( doing_tke ) THEN<a name='3418'>
      DO j = j_start, j_end<a name='3419'>
      DO k = kts,ktf<a name='3420'>
      DO i = i_start, i_end<a name='3421'>
          tendency(i,k,j)=tmptendf(i,k,j)+2.* &amp;<a name='3422'>
                          (tendency(i,k,j)-tmptendf(i,k,j))<a name='3423'>
      ENDDO<a name='3424'>
      ENDDO<a name='3425'>
      ENDDO<a name='3426'>
   ENDIF<a name='3427'>
<a name='3428'>
END SUBROUTINE horizontal_diffusion_s<a name='3429'>
<a name='3430'>
<font color=#447700>!=======================================================================<a name='3431'></font>
<font color=#447700>!=======================================================================<a name='3432'></font>
<a name='3433'>
<A NAME='VERTICAL_DIFFUSION_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3434'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_2</font>   ( ru_tendf, rv_tendf, rw_tendf, rt_tendf,   &amp; <A href='../../call_to/VERTICAL_DIFFUSION_2.html' TARGET='index'>1</A>,<A href='../../call_from/VERTICAL_DIFFUSION_2.html' TARGET='index'>12</A><a name='3435'>
                                    tke_tendf, moist_tendf, n_moist,          &amp;<a name='3436'>
                                    chem_tendf, n_chem,                       &amp;<a name='3437'>
                                    scalar_tendf, n_scalar,                   &amp;<a name='3438'>
                                    tracer_tendf, n_tracer,                   &amp;<a name='3439'>
                                    u_2, v_2,                                 &amp;<a name='3440'>
                                    thp,u_base,v_base,t_base,qv_base,tke,     &amp;<a name='3441'>
                                    config_flags,defor13,defor23,defor33,     &amp;<a name='3442'>
                                    nba_mij, n_nba_mij,                       &amp;<a name='3443'>
                                    div,                                      &amp;<a name='3444'>
                                    moist,chem,scalar,tracer,                 &amp;<a name='3445'>
                                    xkmv,xkhv,xkmh,km_opt,                    &amp; <font color=#447700>! xkmh added<a name='3446'></font>
                                    fnm, fnp, dn, dnw, rdz, rdzw,             &amp;<a name='3447'>
                                    hfx, qfx, ust, rho,                       &amp;<a name='3448'>
                                    ids, ide, jds, jde, kds, kde,             &amp;<a name='3449'>
                                    ims, ime, jms, jme, kms, kme,             &amp;<a name='3450'>
                                    its, ite, jts, jte, kts, kte              )<a name='3451'>
<a name='3452'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3453'></font>
<font color=#447700>! Begin declarations.<a name='3454'></font>
<a name='3455'>
   IMPLICIT NONE<a name='3456'>
<a name='3457'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3458'>
<a name='3459'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='3460'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3461'>
                                            its, ite, jts, jte, kts, kte<a name='3462'>
<a name='3463'>
   INTEGER ,        INTENT(IN   ) ::        n_moist,n_chem,n_scalar,n_tracer,km_opt<a name='3464'>
<a name='3465'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fnm<a name='3466'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fnp<a name='3467'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: dnw<a name='3468'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  dn<a name='3469'>
<a name='3470'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: qv_base<a name='3471'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  u_base<a name='3472'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  v_base<a name='3473'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::  t_base<a name='3474'>
<a name='3475'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::ru_tendf,&amp;<a name='3476'>
                                                                 rv_tendf,&amp;<a name='3477'>
                                                                 rw_tendf,&amp;<a name='3478'>
                                                                tke_tendf,&amp;<a name='3479'>
                                                                rt_tendf<a name='3480'>
<a name='3481'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist),                 &amp;<a name='3482'>
          INTENT(INOUT) ::                                    moist_tendf<a name='3483'>
<a name='3484'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_chem),                  &amp;<a name='3485'>
          INTENT(INOUT) ::                                     chem_tendf<a name='3486'>
<a name='3487'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_scalar) ,               &amp;<a name='3488'>
          INTENT(INOUT) ::                                   scalar_tendf<a name='3489'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_tracer) ,               &amp;<a name='3490'>
          INTENT(INOUT) ::                                   tracer_tendf<a name='3491'>
<a name='3492'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist),                 &amp;<a name='3493'>
          INTENT(INOUT) ::                                          moist<a name='3494'>
<a name='3495'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_chem),                  &amp;<a name='3496'>
          INTENT(INOUT) ::                                           chem<a name='3497'>
<a name='3498'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_scalar) ,               &amp;<a name='3499'>
          INTENT(IN   ) ::                                         scalar<a name='3500'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_tracer) ,               &amp;<a name='3501'>
          INTENT(IN   ) ::                                         tracer<a name='3502'>
<a name='3503'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::defor13, &amp;<a name='3504'>
                                                                 defor23, &amp;<a name='3505'>
                                                                 defor33, &amp;<a name='3506'>
                                                                     div, &amp;<a name='3507'>
                                                                    xkmv, &amp;<a name='3508'>
                                                                    xkhv, &amp;<a name='3509'>
                                                                    xkmh, &amp;<a name='3510'>
                                                                     tke, &amp;<a name='3511'>
                                                                     rdz, &amp;<a name='3512'>
                                                                     u_2, &amp;<a name='3513'>
                                                                     v_2, &amp;<a name='3514'>
                                                                    rdzw<a name='3515'>
<a name='3516'>
   INTEGER, INTENT(  IN ) :: n_nba_mij<a name='3517'>
<a name='3518'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_mij), INTENT(INOUT) &amp;<a name='3519'>
   :: nba_mij<a name='3520'>
<a name='3521'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(IN   )   :: rho<a name='3522'>
   REAL , DIMENSION( ims:ime, jms:jme), INTENT(INOUT)            :: hfx,  &amp;<a name='3523'>
                                                                    qfx<a name='3524'>
   REAL , DIMENSION( ims:ime, jms:jme), INTENT(IN   )            :: ust<a name='3525'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::    thp<a name='3526'>
<a name='3527'>
<font color=#447700>! LOCAL VAR<a name='3528'></font>
<a name='3529'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme)  ::    var_mix<a name='3530'>
<a name='3531'>
   INTEGER :: im, i,j,k<a name='3532'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3533'>
<a name='3534'>
<font color=#447700>!  REAL , DIMENSION( its:ite, kts:kte, jts:jte) :: xkhv<a name='3535'></font>
<a name='3536'>
<font color=#447700>!***************************************************************************<a name='3537'></font>
<font color=#447700>!***************************************************************************<a name='3538'></font>
<font color=#447700>!MODIFICA VARIABILI PER I FLUSSI<a name='3539'></font>
<font color=#447700>!<a name='3540'></font>
    REAL :: V0_u,V0_v,tao_xz,tao_yz,ustar,cd0<a name='3541'>
    REAL :: xsfc,psi1,vk2,zrough,lnz<a name='3542'>
    REAL :: heat_flux, moist_flux, heat_flux0<a name='3543'>
    REAL :: cpm<a name='3544'>
<font color=#447700>!<a name='3545'></font>
<font color=#447700>!FINE MODIFICA VARIABILI PER I FLUSSI<a name='3546'></font>
<font color=#447700>!***************************************************************************<a name='3547'></font>
<font color=#447700>!<a name='3548'></font>
<a name='3549'>
<font color=#447700>! End declarations.<a name='3550'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3551'></font>
<a name='3552'>
   i_start = its<a name='3553'>
   i_end   = MIN(ite,ide-1)<a name='3554'>
   j_start = jts<a name='3555'>
   j_end   = MIN(jte,jde-1)<a name='3556'>
<font color=#447700>!<a name='3557'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3558'></font>
<a name='3559'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_U_2'>vertical_diffusion_u_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_U_2_1">( ru_tendf, config_flags,        &amp;<a name='3560'>
                                   defor13, xkmv,                 &amp;<a name='3561'>
                                   nba_mij, n_nba_mij,            &amp;<a name='3562'>
                                   dnw, rdzw, fnm, fnp, rho,      &amp;<a name='3563'>
                                   ids, ide, jds, jde, kds, kde,  &amp;<a name='3564'>
                                   ims, ime, jms, jme, kms, kme,  &amp;<a name='3565'>
                                   its, ite, jts, jte, kts, kte  )<a name='3566'>
<a name='3567'>
<a name='3568'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_V_2'>vertical_diffusion_v_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_V_2_1">( rv_tendf, config_flags,        &amp;<a name='3569'>
                                   defor23, xkmv,                 &amp;<a name='3570'>
                                   nba_mij, n_nba_mij,            &amp;<a name='3571'>
                                   dnw, rdzw, fnm, fnp, rho,      &amp;<a name='3572'>
                                   ids, ide, jds, jde, kds, kde,  &amp;<a name='3573'>
                                   ims, ime, jms, jme, kms, kme,  &amp;<a name='3574'>
                                   its, ite, jts, jte, kts, kte  )<a name='3575'>
<a name='3576'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_W_2'>vertical_diffusion_w_2</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_W_2_1">( rw_tendf, config_flags,        &amp;<a name='3577'>
                                   defor33, tke(ims,kms,jms),     &amp;<a name='3578'>
                                   nba_mij, n_nba_mij,            &amp;<a name='3579'>
                                   div, xkmh,                     &amp;<a name='3580'>
                                   dn, rdz, fnm, fnp, rho,        &amp;<a name='3581'>
                                   ids, ide, jds, jde, kds, kde,  &amp;<a name='3582'>
                                   ims, ime, jms, jme, kms, kme,  &amp;<a name='3583'>
                                   its, ite, jts, jte, kts, kte  )<a name='3584'>
<a name='3585'>
<font color=#447700>!*****************************************<a name='3586'></font>
<font color=#447700>!*****************************************<a name='3587'></font>
<font color=#447700>!  MODIFICA al flusso di momento alla parete<a name='3588'></font>
<font color=#447700>!<a name='3589'></font>
  vflux: SELECT CASE( config_flags%isfflx )<a name='3590'>
  CASE (0) <font color=#447700>! Assume cd a constant, specified in namelist<a name='3591'></font>
    cd0 = config_flags%tke_drag_coefficient  <font color=#447700>! constant drag coefficient<a name='3592'></font>
                                             <font color=#447700>! set in namelist.input<a name='3593'></font>
<font color=#447700>!<a name='3594'></font>
<font color=#447700>!calcolo del modulo della velocita<a name='3595'></font>
    DO j = j_start, j_end<a name='3596'>
    DO i = i_start, ite<a name='3597'>
       V0_u=0.<a name='3598'>
       tao_xz=0.<a name='3599'>
       V0_u=    sqrt((u_2(i,kts,j)**2) +         &amp;<a name='3600'>
                        (((v_2(i  ,kts,j  )+          &amp;<a name='3601'>
                           v_2(i  ,kts,j+1)+          &amp;<a name='3602'>
                           v_2(i-1,kts,j  )+          &amp;<a name='3603'>
                           v_2(i-1,kts,j+1))/4)**2))+epsilon<a name='3604'>
<a name='3605'>
       tao_xz=cd0*V0_u*u_2(i,kts,j)*(rho(i,kts,j)+rho(i-1,kts,j))/2.<a name='3606'>
       ru_tendf(i,kts,j)=ru_tendf(i,kts,j) +   g*tao_xz/dnw(kts)<a name='3607'>
       IF ( (config_flags%m_opt .EQ. 1) .OR. (config_flags%sfs_opt .GT. 0) ) THEN<a name='3608'>
          nba_mij(i,kts,j,P_m13) = -tao_xz<a name='3609'>
       ENDIF<a name='3610'>
    ENDDO<a name='3611'>
    ENDDO<a name='3612'>
<font color=#447700>!<a name='3613'></font>
    DO j = j_start, jte<a name='3614'>
    DO i = i_start, i_end<a name='3615'>
       V0_v=0.<a name='3616'>
       tao_yz=0.<a name='3617'>
       V0_v=    sqrt((v_2(i,kts,j)**2) +         &amp;<a name='3618'>
                        (((u_2(i  ,kts,j  )+          &amp;<a name='3619'>
                           u_2(i  ,kts,j-1)+          &amp;<a name='3620'>
                           u_2(i+1,kts,j  )+          &amp;<a name='3621'>
                           u_2(i+1,kts,j-1))/4)**2))+epsilon<a name='3622'>
<a name='3623'>
       tao_yz=cd0*V0_v*v_2(i,kts,j)*(rho(i,kts,j)+rho(i,kts,j-1))/2.<a name='3624'>
       rv_tendf(i,kts,j)=rv_tendf(i,kts,j) +   g*tao_yz/dnw(kts)<a name='3625'>
       IF ( (config_flags%m_opt .EQ. 1) .OR. (config_flags%sfs_opt .GT. 0) ) THEN<a name='3626'>
          nba_mij(i,kts,j,P_m23) = -tao_yz<a name='3627'>
       ENDIF<a name='3628'>
    ENDDO<a name='3629'>
    ENDDO<a name='3630'>
<a name='3631'>
  CASE (1,2) <font color=#447700>! ustar computed from surface routine<a name='3632'></font>
    DO j = j_start, j_end<a name='3633'>
    DO i = i_start, ite<a name='3634'>
       V0_u=0.<a name='3635'>
       tao_xz=0.<a name='3636'>
       V0_u=    sqrt((u_2(i,kts,j)**2) +         &amp;<a name='3637'>
                        (((v_2(i  ,kts,j  )+          &amp;<a name='3638'>
                           v_2(i  ,kts,j+1)+          &amp;<a name='3639'>
                           v_2(i-1,kts,j  )+          &amp;<a name='3640'>
                           v_2(i-1,kts,j+1))/4)**2))+epsilon<a name='3641'>
       ustar=0.5*(ust(i,j)+ust(i-1,j))<a name='3642'>
<a name='3643'>
       tao_xz=ustar*ustar*u_2(i,kts,j)*(rho(i,kts,j)+rho(i-1,kts,j))/(2.*V0_u)<a name='3644'>
       ru_tendf(i,kts,j)=ru_tendf(i,kts,j) +   g*tao_xz/dnw(kts)<a name='3645'>
       IF ( (config_flags%m_opt .EQ. 1) .OR. (config_flags%sfs_opt .GT. 0) ) THEN<a name='3646'>
          nba_mij(i,kts,j,P_m13) = -tao_xz<a name='3647'>
       ENDIF<a name='3648'>
    ENDDO<a name='3649'>
    ENDDO<a name='3650'>
<a name='3651'>
    DO j = j_start, jte<a name='3652'>
    DO i = i_start, i_end<a name='3653'>
       V0_v=0.<a name='3654'>
       tao_yz=0.<a name='3655'>
       V0_v=    sqrt((v_2(i,kts,j)**2) +         &amp;<a name='3656'>
                        (((u_2(i  ,kts,j  )+          &amp;<a name='3657'>
                           u_2(i  ,kts,j-1)+          &amp;<a name='3658'>
                           u_2(i+1,kts,j  )+          &amp;<a name='3659'>
                           u_2(i+1,kts,j-1))/4)**2))+epsilon<a name='3660'>
       ustar=0.5*(ust(i,j)+ust(i,j-1))<a name='3661'>
<a name='3662'>
       tao_yz=ustar*ustar*v_2(i,kts,j)*(rho(i,kts,j)+rho(i,kts,j-1))/(2.*V0_v)<a name='3663'>
       rv_tendf(i,kts,j)=rv_tendf(i,kts,j) +   g*tao_yz/dnw(kts)<a name='3664'>
       IF ( (config_flags%m_opt .EQ. 1) .OR. (config_flags%sfs_opt .GT. 0) ) THEN<a name='3665'>
          nba_mij(i,kts,j,P_m23) = -tao_yz<a name='3666'>
       ENDIF<a name='3667'>
    ENDDO<a name='3668'>
    ENDDO<a name='3669'>
<a name='3670'>
  CASE DEFAULT<a name='3671'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_16">( 'isfflx value invalid for diff_opt=2' )<a name='3672'>
  END SELECT vflux<a name='3673'>
<a name='3674'>
<font color=#447700>!<a name='3675'></font>
<font color=#447700>!  FINE MODIFICA al flusso di momento alla parete<a name='3676'></font>
<font color=#447700>!*****************************************<a name='3677'></font>
<font color=#447700>!*****************************************<a name='3678'></font>
<a name='3679'>
   IF ( config_flags%mix_full_fields ) THEN<a name='3680'>
<a name='3681'>
     DO j=jts,min(jte,jde-1)<a name='3682'>
     DO k=kts,kte-1<a name='3683'>
     DO i=its,min(ite,ide-1)<a name='3684'>
       var_mix(i,k,j) = thp(i,k,j)<a name='3685'>
     ENDDO<a name='3686'>
     ENDDO<a name='3687'>
     ENDDO<a name='3688'>
<a name='3689'>
   ELSE<a name='3690'>
<a name='3691'>
     DO j=jts,min(jte,jde-1)<a name='3692'>
     DO k=kts,kte-1<a name='3693'>
     DO i=its,min(ite,ide-1)<a name='3694'>
       var_mix(i,k,j) = thp(i,k,j) - t_base(k)<a name='3695'>
     ENDDO<a name='3696'>
     ENDDO<a name='3697'>
     ENDDO<a name='3698'>
<a name='3699'>
   END IF<a name='3700'>
<a name='3701'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_1">( rt_tendf, config_flags, var_mix, xkhv, &amp;<a name='3702'>
                              dn, dnw, rdz, rdzw, fnm, fnp, rho,     &amp;<a name='3703'>
                              .false.,                               &amp;<a name='3704'>
                              ids, ide, jds, jde, kds, kde,          &amp;<a name='3705'>
                              ims, ime, jms, jme, kms, kme,          &amp;<a name='3706'>
                              its, ite, jts, jte, kts, kte          )<a name='3707'>
<a name='3708'>
<a name='3709'>
<font color=#447700>!*****************************************<a name='3710'></font>
<font color=#447700>!*****************************************<a name='3711'></font>
<font color=#447700>!MODIFICA al flusso di calore<a name='3712'></font>
<font color=#447700>!<a name='3713'></font>
<font color=#447700>!<a name='3714'></font>
  hflux: SELECT CASE( config_flags%isfflx )<a name='3715'>
  CASE (0,2) <font color=#447700>! with fixed surface heat flux given in the namelist<a name='3716'></font>
    heat_flux = config_flags%tke_heat_flux  <font color=#447700>! constant heat flux value<a name='3717'></font>
                                            <font color=#447700>! set in namelist.input<a name='3718'></font>
    DO j = j_start, j_end<a name='3719'>
    DO i = i_start, i_end<a name='3720'>
       cpm = cp * (1. + 0.8 * moist(i,kts,j,P_QV))<a name='3721'>
       hfx(i,j)=heat_flux*cpm*rho(i,kts,j)         <font color=#447700>! provided for output only<a name='3722'></font>
       rt_tendf(i,kts,j)=rt_tendf(i,kts,j)  &amp;<a name='3723'>
             -g*heat_flux*rho(i,kts,j)/dnw(kts)<a name='3724'>
    ENDDO<a name='3725'>
    ENDDO<a name='3726'>
<a name='3727'>
  CASE (1) <font color=#447700>! use surface heat flux computed from surface routine<a name='3728'></font>
    DO j = j_start, j_end<a name='3729'>
    DO i = i_start, i_end<a name='3730'>
<a name='3731'>
       cpm = cp * (1. + 0.8 * moist(i,kts,j,P_QV))<a name='3732'>
       heat_flux = hfx(i,j)/cpm<a name='3733'>
       rt_tendf(i,kts,j)=rt_tendf(i,kts,j)  &amp;<a name='3734'>
            -g*heat_flux/dnw(kts)<a name='3735'>
<a name='3736'>
    ENDDO<a name='3737'>
    ENDDO<a name='3738'>
<a name='3739'>
  CASE DEFAULT<a name='3740'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_17">( 'isfflx value invalid for diff_opt=2' )<a name='3741'>
  END SELECT hflux<a name='3742'>
<a name='3743'>
<font color=#447700>!<a name='3744'></font>
<font color=#447700>! FINE MODIFICA al flusso di calore<a name='3745'></font>
<font color=#447700>!*****************************************<a name='3746'></font>
<font color=#447700>!*****************************************<a name='3747'></font>
<a name='3748'>
   If (km_opt .eq. 2) then<a name='3749'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_2">( tke_tendf(ims,kms,jms),               &amp;<a name='3750'>
                              config_flags, tke(ims,kms,jms),       &amp;<a name='3751'>
                              xkhv,                                 &amp;<a name='3752'>
                              dn, dnw, rdz, rdzw, fnm, fnp, rho,    &amp;<a name='3753'>
                              .true.,                               &amp;<a name='3754'>
                              ids, ide, jds, jde, kds, kde,         &amp;<a name='3755'>
                              ims, ime, jms, jme, kms, kme,         &amp;<a name='3756'>
                              its, ite, jts, jte, kts, kte         )<a name='3757'>
   endif<a name='3758'>
<a name='3759'>
   IF (n_moist .ge. PARAM_FIRST_SCALAR) THEN<a name='3760'>
<a name='3761'>
     moist_loop: do im = PARAM_FIRST_SCALAR, n_moist<a name='3762'>
<a name='3763'>
       IF ( (.not. config_flags%mix_full_fields) .and. (im == P_QV) ) THEN<a name='3764'>
<a name='3765'>
         DO j=jts,min(jte,jde-1)<a name='3766'>
         DO k=kts,kte-1<a name='3767'>
         DO i=its,min(ite,ide-1)<a name='3768'>
          var_mix(i,k,j) = moist(i,k,j,im) - qv_base(k)<a name='3769'>
         ENDDO<a name='3770'>
         ENDDO<a name='3771'>
         ENDDO<a name='3772'>
<a name='3773'>
       ELSE<a name='3774'>
<a name='3775'>
         DO j=jts,min(jte,jde-1)<a name='3776'>
         DO k=kts,kte-1<a name='3777'>
         DO i=its,min(ite,ide-1)<a name='3778'>
          var_mix(i,k,j) = moist(i,k,j,im)<a name='3779'>
         ENDDO<a name='3780'>
         ENDDO<a name='3781'>
         ENDDO<a name='3782'>
<a name='3783'>
       END IF<a name='3784'>
<a name='3785'>
<a name='3786'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_3">( moist_tendf(ims,kms,jms,im),         &amp;<a name='3787'>
                                     config_flags, var_mix,               &amp;<a name='3788'>
                                     xkhv,                                &amp;<a name='3789'>
                                     dn, dnw, rdz, rdzw, fnm, fnp, rho,   &amp;<a name='3790'>
                                     .false.,                             &amp;<a name='3791'>
                                     ids, ide, jds, jde, kds, kde,        &amp;<a name='3792'>
                                     ims, ime, jms, jme, kms, kme,        &amp;<a name='3793'>
                                     its, ite, jts, jte, kts, kte        )<a name='3794'>
<a name='3795'>
<font color=#447700>!*****************************************<a name='3796'></font>
<font color=#447700>!*****************************************<a name='3797'></font>
<font color=#447700>!MODIFICATIONS for water vapor flux<a name='3798'></font>
<font color=#447700>!<a name='3799'></font>
<font color=#447700>!<a name='3800'></font>
  qflux: SELECT CASE( config_flags%isfflx )<a name='3801'>
  CASE (0)<a name='3802'>
<font color=#447700>! do nothing<a name='3803'></font>
  CASE (1,2) <font color=#447700>! with surface moisture flux<a name='3804'></font>
    IF ( im == P_QV ) THEN<a name='3805'>
       DO j = j_start, j_end<a name='3806'>
       DO i = i_start, i_end<a name='3807'>
          moist_flux = qfx(i,j)<a name='3808'>
          moist_tendf(i,kts,j,im)=moist_tendf(i,kts,j,im)  &amp;<a name='3809'>
               -g*moist_flux/dnw(kts)<a name='3810'>
       ENDDO<a name='3811'>
       ENDDO<a name='3812'>
    ENDIF<a name='3813'>
<a name='3814'>
  CASE DEFAULT<a name='3815'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_18">( 'isfflx value invalid for diff_opt=2' )<a name='3816'>
  END SELECT qflux<a name='3817'>
<font color=#447700>!<a name='3818'></font>
<font color=#447700>! END MODIFICATIONS for water vapor flux<a name='3819'></font>
<font color=#447700>!*****************************************<a name='3820'></font>
<font color=#447700>!*****************************************<a name='3821'></font>
     ENDDO moist_loop<a name='3822'>
<a name='3823'>
   ENDIF<a name='3824'>
<a name='3825'>
   IF (n_chem .ge. PARAM_FIRST_SCALAR) THEN<a name='3826'>
<a name='3827'>
     chem_loop: do im = PARAM_FIRST_SCALAR, n_chem<a name='3828'>
<a name='3829'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_4">( chem_tendf(ims,kms,jms,im),         &amp;<a name='3830'>
                                     config_flags, chem(ims,kms,jms,im), &amp;<a name='3831'>
                                     xkhv,                               &amp;<a name='3832'>
                                     dn, dnw, rdz, rdzw, fnm, fnp, rho,  &amp;<a name='3833'>
                                     .false.,                            &amp;<a name='3834'>
                                     ids, ide, jds, jde, kds, kde,       &amp;<a name='3835'>
                                     ims, ime, jms, jme, kms, kme,       &amp;<a name='3836'>
                                     its, ite, jts, jte, kts, kte         )<a name='3837'>
     ENDDO chem_loop<a name='3838'>
<a name='3839'>
   ENDIF<a name='3840'>
<a name='3841'>
   IF (n_tracer .ge. PARAM_FIRST_SCALAR) THEN<a name='3842'>
<a name='3843'>
     tracer_loop: do im = PARAM_FIRST_SCALAR, n_tracer<a name='3844'>
<a name='3845'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_5">( tracer_tendf(ims,kms,jms,im),         &amp;<a name='3846'>
                                     config_flags, tracer(ims,kms,jms,im), &amp;<a name='3847'>
                                     xkhv,                                 &amp;<a name='3848'>
                                     dn, dnw, rdz, rdzw, fnm, fnp, rho,    &amp;<a name='3849'>
                                     .false.,                              &amp;<a name='3850'>
                                     ids, ide, jds, jde, kds, kde,         &amp;<a name='3851'>
                                     ims, ime, jms, jme, kms, kme,         &amp;<a name='3852'>
                                     its, ite, jts, jte, kts, kte         )<a name='3853'>
     ENDDO tracer_loop<a name='3854'>
<a name='3855'>
   ENDIF<a name='3856'>
<a name='3857'>
<a name='3858'>
   IF (n_scalar .ge. PARAM_FIRST_SCALAR) THEN<a name='3859'>
<a name='3860'>
     scalar_loop: do im = PARAM_FIRST_SCALAR, n_scalar<a name='3861'>
<a name='3862'>
          CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S'>vertical_diffusion_s</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_S_6">( scalar_tendf(ims,kms,jms,im),         &amp;<a name='3863'>
                                     config_flags, scalar(ims,kms,jms,im), &amp;<a name='3864'>
                                     xkhv,                                 &amp;<a name='3865'>
                                     dn, dnw, rdz, rdzw, fnm, fnp, rho,    &amp;<a name='3866'>
                                     .false.,                              &amp;<a name='3867'>
                                     ids, ide, jds, jde, kds, kde,         &amp;<a name='3868'>
                                     ims, ime, jms, jme, kms, kme,         &amp;<a name='3869'>
                                     its, ite, jts, jte, kts, kte         )<a name='3870'>
     ENDDO scalar_loop<a name='3871'>
<a name='3872'>
   ENDIF<a name='3873'>
<a name='3874'>
END SUBROUTINE vertical_diffusion_2<a name='3875'>
<a name='3876'>
<font color=#447700>!=======================================================================<a name='3877'></font>
<font color=#447700>!=======================================================================<a name='3878'></font>
<a name='3879'>
<A NAME='VERTICAL_DIFFUSION_U_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_U_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3880'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_u_2</font>( tendency, config_flags,                &amp; <A href='../../call_to/VERTICAL_DIFFUSION_U_2.html' TARGET='index'>1</A>,<A href='../../call_from/VERTICAL_DIFFUSION_U_2.html' TARGET='index'>1</A><a name='3881'>
                                   defor13, xkmv,                         &amp;<a name='3882'>
                                   nba_mij, n_nba_mij,                    &amp;<a name='3883'>
                                   dnw, rdzw, fnm, fnp, rho,              &amp;<a name='3884'>
                                   ids, ide, jds, jde, kds, kde,          &amp;<a name='3885'>
                                   ims, ime, jms, jme, kms, kme,          &amp;<a name='3886'>
                                   its, ite, jts, jte, kts, kte          )<a name='3887'>
<a name='3888'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3889'></font>
<font color=#447700>! Begin declarations.<a name='3890'></font>
<a name='3891'>
   IMPLICIT NONE<a name='3892'>
<a name='3893'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3894'>
<a name='3895'>
   INTEGER ,         INTENT(IN   ) ::       ids, ide, jds, jde, kds, kde, &amp;<a name='3896'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='3897'>
                                            its, ite, jts, jte, kts, kte<a name='3898'>
<a name='3899'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='3900'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='3901'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      :: dnw<a name='3902'>
<font color=#447700>!   REAL , DIMENSION( ims:ime , jms:jme ) ,  INTENT(IN   )      :: zeta_z<a name='3903'></font>
<a name='3904'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='3905'>
<a name='3906'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) ,                       &amp;<a name='3907'>
                                            INTENT(IN   )      ::defor13, &amp;<a name='3908'>
                                                                    xkmv, &amp;<a name='3909'>
                                                                    rdzw, &amp;<a name='3910'>
                                                                     rho<a name='3911'>
<a name='3912'>
   INTEGER, INTENT(  IN ) :: n_nba_mij<a name='3913'>
<a name='3914'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_mij), INTENT(INOUT) &amp;<a name='3915'>
   :: nba_mij<a name='3916'>
<a name='3917'>
<font color=#447700>! LOCAL VARS<a name='3918'></font>
<a name='3919'>
   INTEGER :: i, j, k, ktf<a name='3920'>
<a name='3921'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3922'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext<a name='3923'>
<a name='3924'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)        :: titau3<a name='3925'>
<a name='3926'>
   REAL , DIMENSION( its:ite, jts:jte)                         ::  zzavg<a name='3927'>
<a name='3928'>
   REAL :: rdzu<a name='3929'>
<a name='3930'>
<font color=#447700>! End declarations.<a name='3931'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3932'></font>
<a name='3933'>
   ktf=MIN(kte,kde-1)<a name='3934'>
<a name='3935'>
   i_start = its<a name='3936'>
   i_end   = ite<a name='3937'>
   j_start = jts<a name='3938'>
   j_end   = MIN(jte,jde-1)<a name='3939'>
<a name='3940'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='3941'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3942'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='3943'>
        config_flags%nested) i_end   = MIN(ide-1,ite)<a name='3944'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='3945'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='3946'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='3947'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='3948'>
      IF ( config_flags%periodic_x ) i_start = its<a name='3949'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='3950'>
<a name='3951'>
<font color=#447700>! titau3 = titau13<a name='3952'></font>
   is_ext=0<a name='3953'>
   ie_ext=0<a name='3954'>
   js_ext=0<a name='3955'>
   je_ext=0<a name='3956'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_13_31'>cal_titau_13_31</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_U_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_13_31_2">( config_flags, titau3, defor13,   &amp;<a name='3957'>
                         nba_mij(ims,kms,jms,P_m13),      &amp;<a name='3958'>
                         xkmv, fnm, fnp, rho,             &amp;<a name='3959'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='3960'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='3961'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='3962'>
                         its, ite, jts, jte, kts, kte     )<a name='3963'>
<font color=#447700>!<a name='3964'></font>
      DO j = j_start, j_end<a name='3965'>
      DO k=kts+1,ktf<a name='3966'>
      DO i = i_start, i_end<a name='3967'>
<a name='3968'>
         rdzu = -g/(dnw(k))<a name='3969'>
         tendency(i,k,j)=tendency(i,k,j)-rdzu*(titau3(i,k+1,j)-titau3(i,k,j))<a name='3970'>
<a name='3971'>
      ENDDO<a name='3972'>
      ENDDO<a name='3973'>
      ENDDO<a name='3974'>
<a name='3975'>
<font color=#447700>! ******** MODIF...<a name='3976'></font>
<font color=#447700>!  we will pick up the surface drag (titau3(i,kts,j)) later<a name='3977'></font>
<font color=#447700>!<a name='3978'></font>
       DO j = j_start, j_end<a name='3979'>
       k=kts<a name='3980'>
       DO i = i_start, i_end<a name='3981'>
<a name='3982'>
          rdzu = -g/dnw(k)<a name='3983'>
          tendency(i,k,j)=tendency(i,k,j)-rdzu*(titau3(i,k+1,j))<a name='3984'>
       ENDDO<a name='3985'>
       ENDDO<a name='3986'>
<font color=#447700>! ******** MODIF...<a name='3987'></font>
<a name='3988'>
END SUBROUTINE vertical_diffusion_u_2<a name='3989'>
<a name='3990'>
<font color=#447700>!=======================================================================<a name='3991'></font>
<font color=#447700>!=======================================================================<a name='3992'></font>
<a name='3993'>
<A NAME='VERTICAL_DIFFUSION_V_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_V_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3994'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_v_2</font>( tendency, config_flags,                &amp; <A href='../../call_to/VERTICAL_DIFFUSION_V_2.html' TARGET='index'>1</A>,<A href='../../call_from/VERTICAL_DIFFUSION_V_2.html' TARGET='index'>1</A><a name='3995'>
                                   defor23, xkmv,                         &amp;<a name='3996'>
                                   nba_mij, n_nba_mij,                    &amp;<a name='3997'>
                                   dnw, rdzw, fnm, fnp, rho,              &amp;<a name='3998'>
                                   ids, ide, jds, jde, kds, kde,          &amp;<a name='3999'>
                                   ims, ime, jms, jme, kms, kme,          &amp;<a name='4000'>
                                   its, ite, jts, jte, kts, kte          )<a name='4001'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4002'></font>
<font color=#447700>! Begin declarations.<a name='4003'></font>
<a name='4004'>
   IMPLICIT NONE<a name='4005'>
<a name='4006'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='4007'>
<a name='4008'>
   INTEGER ,         INTENT(IN   ) ::       ids, ide, jds, jde, kds, kde, &amp;<a name='4009'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='4010'>
                                            its, ite, jts, jte, kts, kte<a name='4011'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='4012'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='4013'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      :: dnw<a name='4014'>
<font color=#447700>!   REAL , DIMENSION( ims:ime , jms:jme ) ,  INTENT(IN   )      :: zeta_z<a name='4015'></font>
<a name='4016'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='4017'>
<a name='4018'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) ,                       &amp;<a name='4019'>
                                            INTENT(IN   )      ::defor23, &amp;<a name='4020'>
                                                                    xkmv, &amp;<a name='4021'>
                                                                    rdzw, &amp;<a name='4022'>
                                                                     rho<a name='4023'>
<a name='4024'>
   INTEGER, INTENT(  IN ) :: n_nba_mij<a name='4025'>
<a name='4026'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_mij),  INTENT(INOUT) &amp;<a name='4027'>
   :: nba_mij<a name='4028'>
<a name='4029'>
<font color=#447700>! LOCAL VARS<a name='4030'></font>
<a name='4031'>
   INTEGER :: i, j, k, ktf<a name='4032'>
<a name='4033'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='4034'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext<a name='4035'>
<a name='4036'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)        :: titau3<a name='4037'>
<a name='4038'>
   REAL , DIMENSION( its:ite, jts:jte)                         ::  zzavg<a name='4039'>
<a name='4040'>
   REAL  :: rdzv<a name='4041'>
<a name='4042'>
<font color=#447700>! End declarations.<a name='4043'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4044'></font>
<a name='4045'>
   ktf=MIN(kte,kde-1)<a name='4046'>
<a name='4047'>
   i_start = its<a name='4048'>
   i_end   = MIN(ite,ide-1)<a name='4049'>
   j_start = jts<a name='4050'>
   j_end   = jte<a name='4051'>
<a name='4052'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='4053'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='4054'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='4055'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='4056'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='4057'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='4058'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='4059'>
        config_flags%nested) j_end   = MIN(jde-1,jte)<a name='4060'>
      IF ( config_flags%periodic_x ) i_start = its<a name='4061'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='4062'>
<a name='4063'>
<font color=#447700>! titau3 = titau23<a name='4064'></font>
   is_ext=0<a name='4065'>
   ie_ext=0<a name='4066'>
   js_ext=0<a name='4067'>
   je_ext=0<a name='4068'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_23_32'>cal_titau_23_32</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_V_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_23_32_2">( config_flags, titau3, defor23,   &amp;<a name='4069'>
                         nba_mij(ims,kms,jms,P_m23),      &amp;<a name='4070'>
                         xkmv, fnm, fnp, rho,             &amp;<a name='4071'>
                         is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='4072'>
                         ids, ide, jds, jde, kds, kde,    &amp;<a name='4073'>
                         ims, ime, jms, jme, kms, kme,    &amp;<a name='4074'>
                         its, ite, jts, jte, kts, kte     )<a name='4075'>
<a name='4076'>
   DO j = j_start, j_end<a name='4077'>
   DO k = kts+1,ktf<a name='4078'>
   DO i = i_start, i_end<a name='4079'>
<a name='4080'>
      rdzv = - g / dnw(k)<a name='4081'>
      tendency(i,k,j)=tendency(i,k,j)-rdzv*(titau3(i,k+1,j)-titau3(i,k,j))<a name='4082'>
<a name='4083'>
   ENDDO<a name='4084'>
   ENDDO<a name='4085'>
   ENDDO<a name='4086'>
<a name='4087'>
<font color=#447700>! ******** MODIF...<a name='4088'></font>
<font color=#447700>!  we will pick up the surface drag (titau3(i,kts,j)) later<a name='4089'></font>
<font color=#447700>!<a name='4090'></font>
       DO j = j_start, j_end<a name='4091'>
       k=kts<a name='4092'>
       DO i = i_start, i_end<a name='4093'>
<a name='4094'>
        rdzv = - g / dnw(k)<a name='4095'>
        tendency(i,k,j)=tendency(i,k,j)-rdzv*(titau3(i,k+1,j))<a name='4096'>
<a name='4097'>
       ENDDO<a name='4098'>
       ENDDO<a name='4099'>
<font color=#447700>! ******** MODIF...<a name='4100'></font>
<a name='4101'>
END SUBROUTINE vertical_diffusion_v_2<a name='4102'>
<a name='4103'>
<font color=#447700>!=======================================================================<a name='4104'></font>
<font color=#447700>!=======================================================================<a name='4105'></font>
<a name='4106'>
<A NAME='VERTICAL_DIFFUSION_W_2'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_W_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4107'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_w_2</font>(tendency, config_flags,                 &amp; <A href='../../call_to/VERTICAL_DIFFUSION_W_2.html' TARGET='index'>1</A>,<A href='../../call_from/VERTICAL_DIFFUSION_W_2.html' TARGET='index'>1</A><a name='4108'>
                                defor33, tke,                             &amp;<a name='4109'>
                                nba_mij, n_nba_mij,                       &amp;<a name='4110'>
                                div, xkmh,                                &amp;<a name='4111'>
                                dn, rdz, fnm, fnp, rho,                   &amp;<a name='4112'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4113'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4114'>
                                its, ite, jts, jte, kts, kte              )<a name='4115'>
<a name='4116'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4117'></font>
<font color=#447700>! Begin declarations.<a name='4118'></font>
<a name='4119'>
   IMPLICIT NONE<a name='4120'>
<a name='4121'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='4122'>
<a name='4123'>
   INTEGER ,         INTENT(IN   ) ::       ids, ide, jds, jde, kds, kde, &amp;<a name='4124'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='4125'>
                                            its, ite, jts, jte, kts, kte<a name='4126'>
<a name='4127'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      ::  dn, fnm, fnp<a name='4128'>
<a name='4129'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='4130'>
<a name='4131'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) ,                       &amp;<a name='4132'>
                                            INTENT(IN   )      ::defor33, &amp;<a name='4133'>
                                                                     tke, &amp;<a name='4134'>
                                                                     div, &amp;<a name='4135'>
                                                                    xkmh, &amp;<a name='4136'>
                                                                     rdz, &amp;<a name='4137'>
                                                                     rho<a name='4138'>
<a name='4139'>
   INTEGER, INTENT(  IN ) :: n_nba_mij<a name='4140'>
<a name='4141'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_nba_mij),  INTENT(INOUT) &amp;<a name='4142'>
   :: nba_mij<a name='4143'>
<a name='4144'>
<font color=#447700>! LOCAL VARS<a name='4145'></font>
<a name='4146'>
   INTEGER :: i, j, k, ktf<a name='4147'>
<a name='4148'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='4149'>
   INTEGER :: is_ext,ie_ext,js_ext,je_ext<a name='4150'>
<a name='4151'>
   REAL , DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1)        :: titau3<a name='4152'>
<a name='4153'>
<font color=#447700>! End declarations.<a name='4154'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4155'></font>
<a name='4156'>
   ktf=MIN(kte,kde-1)<a name='4157'>
<a name='4158'>
   i_start = its<a name='4159'>
   i_end   = MIN(ite,ide-1)<a name='4160'>
   j_start = jts<a name='4161'>
   j_end   = MIN(jte,jde-1)<a name='4162'>
<a name='4163'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='4164'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='4165'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='4166'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='4167'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='4168'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='4169'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='4170'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='4171'>
      IF ( config_flags%periodic_x ) i_start = its<a name='4172'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='4173'>
<a name='4174'>
<font color=#447700>! titau3 = titau33<a name='4175'></font>
   is_ext=0<a name='4176'>
   ie_ext=0<a name='4177'>
   js_ext=0<a name='4178'>
   je_ext=0<a name='4179'>
   CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_11_22_33'>cal_titau_11_22_33</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_W_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_TITAU_11_22_33_3">( config_flags, titau3,            &amp;<a name='4180'>
                            tke, xkmh, defor33,              &amp;<a name='4181'>
                            nba_mij(ims,kms,jms,P_m33), rho, &amp;<a name='4182'>
                            is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='4183'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='4184'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='4185'>
                            its, ite, jts, jte, kts, kte     )<a name='4186'>
<a name='4187'>
<font color=#447700>!   DO j = j_start, j_end<a name='4188'></font>
<font color=#447700>!   DO k = kts+1, ktf<a name='4189'></font>
<font color=#447700>!   DO i = i_start, i_end<a name='4190'></font>
<font color=#447700>!      titau3(i,k,j)=titau3(i,k,j)*zeta_z(i,j)<a name='4191'></font>
<font color=#447700>!   ENDDO<a name='4192'></font>
<font color=#447700>!   ENDDO<a name='4193'></font>
<font color=#447700>!   ENDDO<a name='4194'></font>
<a name='4195'>
   DO j = j_start, j_end<a name='4196'>
   DO k = kts+1, ktf<a name='4197'>
   DO i = i_start, i_end<a name='4198'>
       tendency(i,k,j)=tendency(i,k,j)+   g*(titau3(i,k,j)-titau3(i,k-1,j))/dn(k)<a name='4199'>
   ENDDO<a name='4200'>
   ENDDO<a name='4201'>
   ENDDO<a name='4202'>
<a name='4203'>
END SUBROUTINE vertical_diffusion_w_2<a name='4204'>
<a name='4205'>
<font color=#447700>!=======================================================================<a name='4206'></font>
<font color=#447700>!=======================================================================<a name='4207'></font>
<a name='4208'>
<A NAME='VERTICAL_DIFFUSION_S'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#VERTICAL_DIFFUSION_S' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4209'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_s</font>( tendency, config_flags, var, xkhv,       &amp; <A href='../../call_to/VERTICAL_DIFFUSION_S.html' TARGET='index'>6</A><a name='4210'>
                                 dn, dnw, rdz, rdzw, fnm, fnp, rho,       &amp;<a name='4211'>
                                 doing_tke,                               &amp;<a name='4212'>
                                 ids, ide, jds, jde, kds, kde,            &amp;<a name='4213'>
                                 ims, ime, jms, jme, kms, kme,            &amp;<a name='4214'>
                                 its, ite, jts, jte, kts, kte            )<a name='4215'>
<a name='4216'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4217'></font>
<font color=#447700>! Begin declarations.<a name='4218'></font>
<a name='4219'>
   IMPLICIT NONE<a name='4220'>
<a name='4221'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='4222'>
<a name='4223'>
   INTEGER ,         INTENT(IN   ) ::       ids, ide, jds, jde, kds, kde, &amp;<a name='4224'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='4225'>
                                            its, ite, jts, jte, kts, kte<a name='4226'>
<a name='4227'>
   LOGICAL,         INTENT(IN   ) ::        doing_tke<a name='4228'>
<a name='4229'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnm<a name='4230'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) ::    fnp<a name='4231'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      ::  dn<a name='4232'>
   REAL , DIMENSION( kms:kme ) ,            INTENT(IN   )      :: dnw<a name='4233'>
<a name='4234'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::tendency<a name='4235'>
<a name='4236'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) , INTENT(IN) ::   xkhv<a name='4237'>
<a name='4238'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) ,                       &amp;<a name='4239'>
                                            INTENT(IN   )      ::    var, &amp;<a name='4240'>
                                                                     rdz, &amp;<a name='4241'>
                                                                    rdzw, &amp;<a name='4242'>
                                                                     rho<a name='4243'>
<font color=#447700>! LOCAL VARS<a name='4244'></font>
<a name='4245'>
   INTEGER :: i, j, k, ktf<a name='4246'>
<a name='4247'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='4248'>
<a name='4249'>
   REAL , DIMENSION( its:ite, kts:kte, jts:jte)            ::        H3, &amp;<a name='4250'>
                                                                 xkxavg, &amp;<a name='4251'>
                                                                  rravg<a name='4252'>
<a name='4253'>
   REAL , DIMENSION( its:ite, kts:kte, jts:jte)            ::  tmptendf<a name='4254'>
<a name='4255'>
<font color=#447700>! End declarations.<a name='4256'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4257'></font>
<a name='4258'>
   ktf=MIN(kte,kde-1)<a name='4259'>
<a name='4260'>
   i_start = its<a name='4261'>
   i_end   = MIN(ite,ide-1)<a name='4262'>
   j_start = jts<a name='4263'>
   j_end   = MIN(jte,jde-1)<a name='4264'>
<a name='4265'>
   IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='4266'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='4267'>
   IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='4268'>
        config_flags%nested) i_end   = MIN(ide-2,ite)<a name='4269'>
   IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='4270'>
        config_flags%nested) j_start = MAX(jds+1,jts)<a name='4271'>
   IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='4272'>
        config_flags%nested) j_end   = MIN(jde-2,jte)<a name='4273'>
      IF ( config_flags%periodic_x ) i_start = its<a name='4274'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='4275'>
<a name='4276'>
   IF (doing_tke) THEN<a name='4277'>
      DO j = j_start, j_end<a name='4278'>
      DO k = kts,ktf<a name='4279'>
      DO i = i_start, i_end<a name='4280'>
         tmptendf(i,k,j)=tendency(i,k,j)<a name='4281'>
      ENDDO<a name='4282'>
      ENDDO<a name='4283'>
      ENDDO<a name='4284'>
   ENDIF<a name='4285'>
<a name='4286'>
<font color=#447700>! H3<a name='4287'></font>
<a name='4288'>
   xkxavg = 0.<a name='4289'>
<a name='4290'>
   DO j = j_start, j_end<a name='4291'>
   DO k = kts+1,ktf<a name='4292'>
   DO i = i_start, i_end<a name='4293'>
      xkxavg(i,k,j)=fnm(k)*xkhv(i,k,j)+fnp(k)*xkhv(i,k-1,j)<a name='4294'>
      xkxavg(i,k,j)=xkxavg(i,k,j)*(fnm(k)*rho(i,k,j)+fnp(k)*rho(i,k-1,j))<a name='4295'>
      H3(i,k,j)=-xkxavg(i,k,j)*(var(i,k,j)-var(i,k-1,j))*rdz(i,k,j)<a name='4296'>
   ENDDO<a name='4297'>
   ENDDO<a name='4298'>
   ENDDO<a name='4299'>
<a name='4300'>
   DO j = j_start, j_end<a name='4301'>
   DO i = i_start, i_end<a name='4302'>
      H3(i,kts,j)=0.<a name='4303'>
      H3(i,ktf+1,j)=0.<a name='4304'>
   ENDDO<a name='4305'>
   ENDDO<a name='4306'>
<a name='4307'>
   DO j = j_start, j_end<a name='4308'>
   DO k = kts,ktf<a name='4309'>
   DO i = i_start, i_end<a name='4310'>
      tendency(i,k,j)=tendency(i,k,j)  &amp;<a name='4311'>
                       +   g * (H3(i,k+1,j)-H3(i,k,j))/dnw(k)<a name='4312'>
   ENDDO<a name='4313'>
   ENDDO<a name='4314'>
   ENDDO<a name='4315'>
<a name='4316'>
   IF (doing_tke) THEN<a name='4317'>
      DO j = j_start, j_end<a name='4318'>
      DO k = kts,ktf<a name='4319'>
      DO i = i_start, i_end<a name='4320'>
          tendency(i,k,j)=tmptendf(i,k,j)+2.* &amp;<a name='4321'>
                          (tendency(i,k,j)-tmptendf(i,k,j))<a name='4322'>
      ENDDO<a name='4323'>
      ENDDO<a name='4324'>
      ENDDO<a name='4325'>
   ENDIF<a name='4326'>
<a name='4327'>
END SUBROUTINE vertical_diffusion_s<a name='4328'>
<a name='4329'>
<font color=#447700>!=======================================================================<a name='4330'></font>
<font color=#447700>!=======================================================================<a name='4331'></font>
<a name='4332'>
<A NAME='CAL_TITAU_11_22_33'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_11_22_33' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4333'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_titau_11_22_33</font>( config_flags, titau,              &amp; <A href='../../call_to/CAL_TITAU_11_22_33.html' TARGET='index'>3</A><a name='4334'>
                                   tke, xkx, defor,                  &amp;<a name='4335'>
                                   mtau, rho,                        &amp;<a name='4336'>
                                   is_ext, ie_ext, js_ext, je_ext,   &amp;<a name='4337'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='4338'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='4339'>
                                   its, ite, jts, jte, kts, kte      )<a name='4340'>
<a name='4341'>
<font color=#447700>! History:     Sep 2003  Changes by George Bryan and Jason Knievel, NCAR<a name='4342'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='4343'></font>
<font color=#447700>!              Aug 2000  Original code by Shu-Hua Chen, UC-Davis<a name='4344'></font>
<a name='4345'>
<font color=#447700>! Purpose:     This routine calculates stress terms (taus) for use in<a name='4346'></font>
<font color=#447700>!              the calculation of production of TKE by sheared wind<a name='4347'></font>
<a name='4348'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='4349'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='4350'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='4351'></font>
<a name='4352'>
<font color=#447700>! Key:<a name='4353'></font>
<a name='4354'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4355'></font>
<font color=#447700>! Begin declarations.<a name='4356'></font>
<a name='4357'>
    IMPLICIT NONE<a name='4358'>
<a name='4359'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='4360'>
    :: config_flags<a name='4361'>
<a name='4362'>
    INTEGER, INTENT( IN )  &amp;<a name='4363'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='4364'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='4365'>
       its, ite, jts, jte, kts, kte<a name='4366'>
<a name='4367'>
    INTEGER, INTENT( IN )  &amp;<a name='4368'>
    :: is_ext, ie_ext, js_ext, je_ext<a name='4369'>
<a name='4370'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 ), INTENT( INOUT )  &amp;<a name='4371'>
    :: titau<a name='4372'>
<a name='4373'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='4374'>
    :: defor, xkx, tke, rho<a name='4375'>
<a name='4376'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='4377'>
    :: mtau<a name='4378'>
<a name='4379'>
<font color=#447700>! Local variables.<a name='4380'></font>
<a name='4381'>
    INTEGER  &amp;<a name='4382'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='4383'>
<a name='4384'>
<font color=#447700>! End declarations.<a name='4385'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4386'></font>
<a name='4387'>
    ktf = MIN( kte, kde-1 )<a name='4388'>
<a name='4389'>
    i_start = its<a name='4390'>
    i_end   = ite<a name='4391'>
    j_start = jts<a name='4392'>
    j_end   = jte<a name='4393'>
<a name='4394'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='4395'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='4396'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='4397'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='4398'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='4399'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='4400'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='4401'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='4402'>
      IF ( config_flags%periodic_x ) i_start = its<a name='4403'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='4404'>
<a name='4405'>
    i_start = i_start - is_ext<a name='4406'>
    i_end   = i_end   + ie_ext<a name='4407'>
    j_start = j_start - js_ext<a name='4408'>
    j_end   = j_end   + je_ext<a name='4409'>
<a name='4410'>
    IF ( config_flags%sfs_opt .GT. 0 ) THEN <font color=#447700>! USE NBA MODEL SFS STRESSES<a name='4411'></font>
<a name='4412'>
      DO j = j_start, j_end<a name='4413'>
      DO k = kts, ktf<a name='4414'>
      DO i = i_start, i_end<a name='4415'>
<a name='4416'>
        titau(i,k,j) = rho(i,k,j) * mtau(i,k,j)<a name='4417'>
<a name='4418'>
      END DO<a name='4419'>
      END DO<a name='4420'>
      END DO<a name='4421'>
<a name='4422'>
    ELSE <font color=#447700>!NOT NBA<a name='4423'></font>
<a name='4424'>
      IF ( config_flags%m_opt .EQ. 1 ) THEN <font color=#447700>! ASSIGN STRESS TO MTAU FOR OUTPUT<a name='4425'></font>
<a name='4426'>
        DO j = j_start, j_end<a name='4427'>
        DO k = kts, ktf<a name='4428'>
        DO i = i_start, i_end<a name='4429'>
<a name='4430'>
          titau(i,k,j) = - rho(i,k,j) * xkx(i,k,j) * defor(i,k,j)<a name='4431'>
          mtau(i,k,j) = - xkx(i,k,j) * defor(i,k,j)<a name='4432'>
<a name='4433'>
        END DO<a name='4434'>
        END DO<a name='4435'>
        END DO<a name='4436'>
<a name='4437'>
      ELSE <font color=#447700>!NO STRESS OUTPUT<a name='4438'></font>
<a name='4439'>
        DO j = j_start, j_end<a name='4440'>
        DO k = kts, ktf<a name='4441'>
        DO i = i_start, i_end<a name='4442'>
<a name='4443'>
          titau(i,k,j) = - rho(i,k,j) * xkx(i,k,j) * defor(i,k,j)<a name='4444'>
<a name='4445'>
        END DO<a name='4446'>
        END DO<a name='4447'>
        END DO<a name='4448'>
<a name='4449'>
      ENDIF<a name='4450'>
<a name='4451'>
    ENDIF<a name='4452'>
<a name='4453'>
    END SUBROUTINE cal_titau_11_22_33<a name='4454'>
<a name='4455'>
<font color=#447700>!=======================================================================<a name='4456'></font>
<font color=#447700>!=======================================================================<a name='4457'></font>
<a name='4458'>
<A NAME='CAL_TITAU_12_21'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_12_21' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4459'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_titau_12_21</font>( config_flags, titau,             &amp; <A href='../../call_to/CAL_TITAU_12_21.html' TARGET='index'>2</A><a name='4460'>
                                xkx, defor,                      &amp;<a name='4461'>
                                mtau, rho,                       &amp;<a name='4462'>
                                is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='4463'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='4464'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='4465'>
                                its, ite, jts, jte, kts, kte     )<a name='4466'>
<a name='4467'>
<font color=#447700>! History:     Sep 2003   Modifications by George Bryan and Jason Knievel, NCAR<a name='4468'></font>
<font color=#447700>!              Oct 2001   Converted to mass core by Bill Skamarock, NCAR<a name='4469'></font>
<font color=#447700>!              Aug 2000   Original code by Shu-Hua Chen, UC-Davis<a name='4470'></font>
<a name='4471'>
<font color=#447700>! Pusrpose     This routine calculates the stress terms (taus) for use in<a name='4472'></font>
<font color=#447700>!              the calculation of production of TKE by sheared wind<a name='4473'></font>
<a name='4474'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='4475'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='4476'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='4477'></font>
<a name='4478'>
<font color=#447700>! Key:<a name='4479'></font>
<a name='4480'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4481'></font>
<font color=#447700>! Begin declarations.<a name='4482'></font>
<a name='4483'>
    IMPLICIT NONE<a name='4484'>
<a name='4485'>
    TYPE( grid_config_rec_type), INTENT( IN )  &amp;<a name='4486'>
    :: config_flags<a name='4487'>
<a name='4488'>
    INTEGER, INTENT( IN )  &amp;<a name='4489'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='4490'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='4491'>
       its, ite, jts, jte, kts, kte<a name='4492'>
<a name='4493'>
    INTEGER, INTENT( IN )  &amp;<a name='4494'>
    :: is_ext, ie_ext, js_ext, je_ext<a name='4495'>
<a name='4496'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 ), INTENT( INOUT )  &amp;<a name='4497'>
    :: titau<a name='4498'>
<a name='4499'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='4500'>
    :: defor, xkx, rho<a name='4501'>
<a name='4502'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='4503'>
    :: mtau<a name='4504'>
<a name='4505'>
<font color=#447700>! Local variables.<a name='4506'></font>
<a name='4507'>
    INTEGER  &amp;<a name='4508'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='4509'>
<a name='4510'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 )  &amp;<a name='4511'>
    :: xkxavg<a name='4512'>
<a name='4513'>
<font color=#447700>! End declarations.<a name='4514'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4515'></font>
<a name='4516'>
    ktf = MIN( kte, kde-1 )<a name='4517'>
<a name='4518'>
<font color=#447700>! Needs one more point in the x and y directions.<a name='4519'></font>
<a name='4520'>
    i_start = its<a name='4521'>
    i_end   = ite<a name='4522'>
    j_start = jts<a name='4523'>
    j_end   = jte<a name='4524'>
<a name='4525'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='4526'>
         config_flags%nested ) i_start = MAX( ids+1, its )<a name='4527'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='4528'>
         config_flags%nested ) i_end   = MIN( ide-1, ite )<a name='4529'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='4530'>
         config_flags%nested ) j_start = MAX( jds+1, jts )<a name='4531'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='4532'>
         config_flags%nested ) j_end   = MIN( jde-1, jte )<a name='4533'>
      IF ( config_flags%periodic_x ) i_start = its<a name='4534'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='4535'>
<a name='4536'>
    i_start = i_start - is_ext<a name='4537'>
    i_end   = i_end   + ie_ext<a name='4538'>
    j_start = j_start - js_ext<a name='4539'>
    j_end   = j_end   + je_ext<a name='4540'>
<a name='4541'>
    DO j = j_start, j_end<a name='4542'>
    DO k = kts, ktf<a name='4543'>
    DO i = i_start, i_end<a name='4544'>
      xkxavg(i,k,j) = 0.25 * ( xkx(i-1,k,j  ) + xkx(i,k,j  ) +  &amp;<a name='4545'>
                               xkx(i-1,k,j-1) + xkx(i,k,j-1) )<a name='4546'>
      xkxavg(i,k,j) = xkxavg(i,k,j) * .25 * ( rho(i-1,k,j  ) + rho(i,k,j  )  +  &amp;<a name='4547'>
                                              rho(i-1,k,j-1) + rho(i,k,j-1) )<a name='4548'>
    END DO<a name='4549'>
    END DO<a name='4550'>
    END DO<a name='4551'>
<a name='4552'>
<font color=#447700>! titau12 or titau21<a name='4553'></font>
<a name='4554'>
    IF ( config_flags%sfs_opt .GT. 0 ) THEN <font color=#447700>! USE NBA MODEL SFS STRESSES<a name='4555'></font>
<a name='4556'>
      DO j = j_start, j_end<a name='4557'>
      DO k = kts, ktf<a name='4558'>
      DO i = i_start, i_end<a name='4559'>
<a name='4560'>
        titau(i,k,j) = rho(i,k,j) * mtau(i,k,j)<a name='4561'>
<a name='4562'>
      END DO<a name='4563'>
      END DO<a name='4564'>
      END DO<a name='4565'>
<a name='4566'>
    ELSE <font color=#447700>! NOT NBA<a name='4567'></font>
<a name='4568'>
      IF ( config_flags%m_opt .EQ. 1 ) THEN <font color=#447700>! ASSIGN STRESS TO MTAU FOR OUTPUT<a name='4569'></font>
<a name='4570'>
        DO j = j_start, j_end<a name='4571'>
        DO k = kts, ktf<a name='4572'>
        DO i = i_start, i_end<a name='4573'>
          titau(i,k,j) = - xkxavg(i,k,j) * defor(i,k,j)<a name='4574'>
          mtau(i,k,j) = - xkxavg(i,k,j) * defor(i,k,j)  / rho(i,k,j)<a name='4575'>
<a name='4576'>
        END DO<a name='4577'>
        END DO<a name='4578'>
        END DO<a name='4579'>
<a name='4580'>
      ELSE <font color=#447700>! NO STRESS OUTPUT<a name='4581'></font>
<a name='4582'>
        DO j = j_start, j_end<a name='4583'>
        DO k = kts, ktf<a name='4584'>
        DO i = i_start, i_end<a name='4585'>
<a name='4586'>
          titau(i,k,j) = - xkxavg(i,k,j) * defor(i,k,j)<a name='4587'>
<a name='4588'>
        END DO<a name='4589'>
        END DO<a name='4590'>
        END DO<a name='4591'>
<a name='4592'>
      ENDIF<a name='4593'>
<a name='4594'>
    ENDIF<a name='4595'>
<a name='4596'>
    END SUBROUTINE cal_titau_12_21<a name='4597'>
<a name='4598'>
<font color=#447700>!=======================================================================<a name='4599'></font>
<a name='4600'>
<A NAME='CAL_TITAU_13_31'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_13_31' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4601'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_titau_13_31</font>( config_flags, titau,             &amp; <A href='../../call_to/CAL_TITAU_13_31.html' TARGET='index'>2</A><a name='4602'>
                                defor,                           &amp;<a name='4603'>
                                mtau,                            &amp;<a name='4604'>
                                xkx, fnm, fnp, rho,              &amp;<a name='4605'>
                                is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='4606'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='4607'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='4608'>
                                its, ite, jts, jte, kts, kte     )<a name='4609'>
<a name='4610'>
<font color=#447700>! History:     Sep 2003   Modifications by George Bryan and Jason Knievel, NCAR<a name='4611'></font>
<font color=#447700>!              Oct 2001   Converted to mass core by Bill Skamarock, NCAR<a name='4612'></font>
<font color=#447700>!              Aug 2000   Original code by Shu-Hua Chen, UC-Davis<a name='4613'></font>
<a name='4614'>
<font color=#447700>! Purpose:     This routine calculates the stress terms (taus) for use in<a name='4615'></font>
<font color=#447700>!              the calculation of production of TKE by sheared wind<a name='4616'></font>
<a name='4617'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='4618'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='4619'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='4620'></font>
<a name='4621'>
<font color=#447700>! Key:<a name='4622'></font>
<a name='4623'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4624'></font>
<font color=#447700>! Begin declarations.<a name='4625'></font>
<a name='4626'>
    IMPLICIT NONE<a name='4627'>
<a name='4628'>
    TYPE( grid_config_rec_type), INTENT( IN )  &amp;<a name='4629'>
    :: config_flags<a name='4630'>
<a name='4631'>
    INTEGER, INTENT( IN )  &amp;<a name='4632'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='4633'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='4634'>
       its, ite, jts, jte, kts, kte<a name='4635'>
<a name='4636'>
    INTEGER, INTENT( IN )  &amp;<a name='4637'>
    :: is_ext, ie_ext, js_ext, je_ext<a name='4638'>
<a name='4639'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='4640'>
    :: fnm, fnp<a name='4641'>
<a name='4642'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 ), INTENT( INOUT )  &amp;<a name='4643'>
    :: titau<a name='4644'>
<a name='4645'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme), INTENT( IN )  &amp;<a name='4646'>
    :: defor, xkx, rho<a name='4647'>
<a name='4648'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='4649'>
    :: mtau<a name='4650'>
<a name='4651'>
<font color=#447700>! Local variables.<a name='4652'></font>
<a name='4653'>
    INTEGER  &amp;<a name='4654'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='4655'>
<a name='4656'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 )  &amp;<a name='4657'>
    :: xkxavg<a name='4658'>
<a name='4659'>
<font color=#447700>! End declarations.<a name='4660'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4661'></font>
<a name='4662'>
    ktf = MIN( kte, kde-1 )<a name='4663'>
<a name='4664'>
<font color=#447700>! Find ide-1 and jde-1 for averaging to p point.<a name='4665'></font>
<a name='4666'>
    i_start = its<a name='4667'>
    i_end   = ite<a name='4668'>
    j_start = jts<a name='4669'>
    j_end   = MIN( jte, jde-1 )<a name='4670'>
<a name='4671'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='4672'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='4673'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='4674'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='4675'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='4676'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='4677'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='4678'>
         config_flags%nested) j_end   = MIN( jde-2, jte )<a name='4679'>
      IF ( config_flags%periodic_x ) i_start = its<a name='4680'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='4681'>
<a name='4682'>
    i_start = i_start - is_ext<a name='4683'>
    i_end   = i_end   + ie_ext<a name='4684'>
    j_start = j_start - js_ext<a name='4685'>
    j_end   = j_end   + je_ext<a name='4686'>
<a name='4687'>
    DO j = j_start, j_end<a name='4688'>
    DO k = kts+1, ktf<a name='4689'>
    DO i = i_start, i_end<a name='4690'>
      xkxavg(i,k,j) = 0.5 * ( fnm(k) * ( xkx(i,k  ,j) + xkx(i-1,k  ,j) ) +  &amp;<a name='4691'>
                              fnp(k) * ( xkx(i,k-1,j) + xkx(i-1,k-1,j) ) )<a name='4692'>
      xkxavg(i,k,j) = xkxavg(i,k,j) * 0.5 * ( fnm(k) * ( rho(i-1,k  ,j) + rho(i,k  ,j) ) + &amp;<a name='4693'>
                                              fnp(k) * ( rho(i-1,k-1,j) + rho(i,k-1,j) ) )<a name='4694'>
    END DO<a name='4695'>
    END DO<a name='4696'>
    END DO<a name='4697'>
<a name='4698'>
    IF ( config_flags%sfs_opt .GT. 0 ) THEN <font color=#447700>! USE NBA MODEL SFS STRESSES<a name='4699'></font>
<a name='4700'>
      DO j = j_start, j_end<a name='4701'>
      DO k = kts+1, ktf<a name='4702'>
      DO i = i_start, i_end<a name='4703'>
         titau(i,k,j) = rho(i,k,j) * mtau(i,k,j)<a name='4704'>
      ENDDO<a name='4705'>
      ENDDO<a name='4706'>
      ENDDO<a name='4707'>
<a name='4708'>
    ELSE <font color=#447700>! NOT NBA<a name='4709'></font>
<a name='4710'>
      IF ( config_flags%m_opt .EQ. 1 ) THEN <font color=#447700>! ASSIGN STRESS TO MTAU FOR OUTPUT<a name='4711'></font>
<a name='4712'>
        DO j = j_start, j_end<a name='4713'>
        DO k = kts+1, ktf<a name='4714'>
        DO i = i_start, i_end<a name='4715'>
<a name='4716'>
          titau(i,k,j) = - xkxavg(i,k,j) * defor(i,k,j)<a name='4717'>
          mtau(i,k,j) = - xkxavg(i,k,j) * defor(i,k,j)  / rho(i,k,j)<a name='4718'>
<a name='4719'>
        ENDDO<a name='4720'>
        ENDDO<a name='4721'>
        ENDDO<a name='4722'>
<a name='4723'>
      ELSE <font color=#447700>! NO STRESS OUTPUT<a name='4724'></font>
<a name='4725'>
        DO j = j_start, j_end<a name='4726'>
        DO k = kts+1, ktf<a name='4727'>
        DO i = i_start, i_end<a name='4728'>
<a name='4729'>
          titau(i,k,j) = - xkxavg(i,k,j) * defor(i,k,j)<a name='4730'>
<a name='4731'>
        ENDDO<a name='4732'>
        ENDDO<a name='4733'>
        ENDDO<a name='4734'>
<a name='4735'>
      ENDIF<a name='4736'>
<a name='4737'>
    ENDIF<a name='4738'>
<a name='4739'>
    DO j = j_start, j_end<a name='4740'>
    DO i = i_start, i_end<a name='4741'>
      titau(i,kts  ,j) = 0.0<a name='4742'>
      titau(i,ktf+1,j) = 0.0<a name='4743'>
    ENDDO<a name='4744'>
    ENDDO<a name='4745'>
<a name='4746'>
    END SUBROUTINE cal_titau_13_31<a name='4747'>
<a name='4748'>
<font color=#447700>!=======================================================================<a name='4749'></font>
<font color=#447700>!=======================================================================<a name='4750'></font>
<a name='4751'>
<A NAME='CAL_TITAU_23_32'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_TITAU_23_32' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4752'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_titau_23_32</font>( config_flags, titau, defor,      &amp; <A href='../../call_to/CAL_TITAU_23_32.html' TARGET='index'>2</A><a name='4753'>
                                mtau,                            &amp;<a name='4754'>
                                xkx, fnm, fnp, rho,              &amp;<a name='4755'>
                                is_ext, ie_ext, js_ext, je_ext,  &amp;<a name='4756'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='4757'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='4758'>
                                its, ite, jts, jte, kts, kte     )<a name='4759'>
<a name='4760'>
<font color=#447700>! History:     Sep 2003  Changes by George Bryan and Jason Knievel, NCAR<a name='4761'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='4762'></font>
<font color=#447700>!              Aug 2000  Original code by Shu-Hua Chen, UC-Davis<a name='4763'></font>
<a name='4764'>
<font color=#447700>! Purpose:     This routine calculates stress terms (taus) for use in<a name='4765'></font>
<font color=#447700>!              the calculation of production of TKE by sheared wind<a name='4766'></font>
<a name='4767'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='4768'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='4769'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='4770'></font>
<a name='4771'>
<font color=#447700>! Key:<a name='4772'></font>
<a name='4773'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4774'></font>
<font color=#447700>! Begin declarations.<a name='4775'></font>
<a name='4776'>
    IMPLICIT NONE<a name='4777'>
<a name='4778'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='4779'>
    :: config_flags<a name='4780'>
<a name='4781'>
    INTEGER, INTENT( IN )  &amp;<a name='4782'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='4783'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='4784'>
       its, ite, jts, jte, kts, kte<a name='4785'>
<a name='4786'>
    INTEGER, INTENT( IN )  &amp;<a name='4787'>
    :: is_ext,ie_ext,js_ext,je_ext<a name='4788'>
<a name='4789'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='4790'>
    :: fnm, fnp<a name='4791'>
<a name='4792'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 ), INTENT( INOUT )  &amp;<a name='4793'>
    :: titau<a name='4794'>
<a name='4795'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='4796'>
    :: defor, xkx, rho<a name='4797'>
<a name='4798'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='4799'>
    :: mtau<a name='4800'>
<a name='4801'>
<font color=#447700>! Local variables.<a name='4802'></font>
<a name='4803'>
    INTEGER  &amp;<a name='4804'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='4805'>
<a name='4806'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 )  &amp;<a name='4807'>
    :: xkxavg<a name='4808'>
<a name='4809'>
<font color=#447700>! End declarations.<a name='4810'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4811'></font>
<a name='4812'>
     ktf = MIN( kte, kde-1 )<a name='4813'>
<a name='4814'>
<font color=#447700>! Find ide-1 and jde-1 for averaging to p point.<a name='4815'></font>
<a name='4816'>
    i_start = its<a name='4817'>
    i_end   = MIN( ite, ide-1 )<a name='4818'>
    j_start = jts<a name='4819'>
    j_end   = jte<a name='4820'>
<a name='4821'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='4822'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='4823'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='4824'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='4825'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='4826'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='4827'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='4828'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='4829'>
      IF ( config_flags%periodic_x ) i_start = its<a name='4830'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='4831'>
<a name='4832'>
    i_start = i_start - is_ext<a name='4833'>
    i_end   = i_end   + ie_ext<a name='4834'>
    j_start = j_start - js_ext<a name='4835'>
    j_end   = j_end   + je_ext<a name='4836'>
<a name='4837'>
    DO j = j_start, j_end<a name='4838'>
    DO k = kts+1, ktf<a name='4839'>
    DO i = i_start, i_end<a name='4840'>
      xkxavg(i,k,j) = 0.5 * ( fnm(k) * ( xkx(i,k  ,j) + xkx(i,k  ,j-1) ) +  &amp;<a name='4841'>
                              fnp(k) * ( xkx(i,k-1,j) + xkx(i,k-1,j-1) ) )<a name='4842'>
      xkxavg(i,k,j) = xkxavg(i,k,j) * 0.5 * ( fnm(k) * ( rho(i,k  ,j) + rho(i,k  ,j-1) ) +  &amp;<a name='4843'>
                                              fnp(k) * ( rho(i,k-1,j) + rho(i,k-1,j-1) ) )<a name='4844'>
    END DO<a name='4845'>
    END DO<a name='4846'>
    END DO<a name='4847'>
<a name='4848'>
    IF ( config_flags%sfs_opt .GT. 0 ) THEN <font color=#447700>! USE NBA MODEL SFS STRESSES<a name='4849'></font>
<a name='4850'>
      DO j = j_start, j_end<a name='4851'>
      DO k = kts+1, ktf<a name='4852'>
      DO i = i_start, i_end<a name='4853'>
<a name='4854'>
        titau(i,k,j) =  rho(i,k,j) * mtau(i,k,j)<a name='4855'>
<a name='4856'>
      END DO<a name='4857'>
      END DO<a name='4858'>
      END DO<a name='4859'>
<a name='4860'>
    ELSE <font color=#447700>! NOT NBA<a name='4861'></font>
<a name='4862'>
      IF ( config_flags%m_opt .EQ. 1 ) THEN <font color=#447700>! ASSIGN STRESS TO MTAU FOR OUTPUT<a name='4863'></font>
<a name='4864'>
        DO j = j_start, j_end<a name='4865'>
        DO k = kts+1, ktf<a name='4866'>
        DO i = i_start, i_end<a name='4867'>
<a name='4868'>
          titau(i,k,j) = - xkxavg(i,k,j) * defor(i,k,j)<a name='4869'>
          mtau(i,k,j) = - xkxavg(i,k,j) * defor(i,k,j)  / rho(i,k,j)<a name='4870'>
<a name='4871'>
        END DO<a name='4872'>
        END DO<a name='4873'>
        END DO<a name='4874'>
<a name='4875'>
      ELSE <font color=#447700>! NO STRESS OUTPUT<a name='4876'></font>
<a name='4877'>
        DO j = j_start, j_end<a name='4878'>
        DO k = kts+1, ktf<a name='4879'>
        DO i = i_start, i_end<a name='4880'>
<a name='4881'>
          titau(i,k,j) = -  xkxavg(i,k,j) * defor(i,k,j)<a name='4882'>
<a name='4883'>
        END DO<a name='4884'>
        END DO<a name='4885'>
        END DO<a name='4886'>
<a name='4887'>
      ENDIF<a name='4888'>
<a name='4889'>
    ENDIF<a name='4890'>
<a name='4891'>
    DO j = j_start, j_end<a name='4892'>
    DO i = i_start, i_end<a name='4893'>
      titau(i,kts  ,j) = 0.0<a name='4894'>
      titau(i,ktf+1,j) = 0.0<a name='4895'>
    END DO<a name='4896'>
    END DO<a name='4897'>
<a name='4898'>
    END SUBROUTINE cal_titau_23_32<a name='4899'>
<a name='4900'>
<font color=#447700>!=======================================================================<a name='4901'></font>
<font color=#447700>!=======================================================================<a name='4902'></font>
<a name='4903'>
<A NAME='PHY_BC'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4904'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>phy_bc</font> ( config_flags,div,defor11,defor22,defor33,              &amp; <A href='../../call_to/PHY_BC.html' TARGET='index'>1</A>,<A href='../../call_from/PHY_BC.html' TARGET='index'>18</A><a name='4905'>
                    defor12,defor13,defor23,xkmh,xkmv,xkhh,xkhv,tke,rho,   &amp;<a name='4906'>
                    RUBLTEN, RVBLTEN,                                      &amp;<a name='4907'>
                    RUCUTEN, RVCUTEN,                                      &amp;<a name='4908'>
                    RUSHTEN, RVSHTEN,                                      &amp;<a name='4909'>
                    ids, ide, jds, jde, kds, kde,                          &amp;<a name='4910'>
                    ims, ime, jms, jme, kms, kme,                          &amp;<a name='4911'>
                    ips, ipe, jps, jpe, kps, kpe,                          &amp;<a name='4912'>
                    its, ite, jts, jte, kts, kte                           )<a name='4913'>
<a name='4914'>
<font color=#447700>!------------------------------------------------------------------------------<a name='4915'></font>
<font color=#447700>! Begin declarations.<a name='4916'></font>
<a name='4917'>
   IMPLICIT NONE<a name='4918'>
<a name='4919'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='4920'>
<a name='4921'>
   INTEGER ,        INTENT(IN   ) ::        ids, ide, jds, jde, kds, kde, &amp;<a name='4922'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='4923'>
                                            ips, ipe, jps, jpe, kps, kpe, &amp;<a name='4924'>
                                            its, ite, jts, jte, kts, kte<a name='4925'>
<a name='4926'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::RUBLTEN, &amp;<a name='4927'>
                                                                 RVBLTEN, &amp;<a name='4928'>
                                                                 RUCUTEN, &amp;<a name='4929'>
                                                                 RVCUTEN, &amp;<a name='4930'>
                                                                 RUSHTEN, &amp;<a name='4931'>
                                                                 RVSHTEN, &amp;<a name='4932'>
                                                                 defor11, &amp;<a name='4933'>
                                                                 defor22, &amp;<a name='4934'>
                                                                 defor33, &amp;<a name='4935'>
                                                                 defor12, &amp;<a name='4936'>
                                                                 defor13, &amp;<a name='4937'>
                                                                 defor23, &amp;<a name='4938'>
                                                                    xkmh, &amp;<a name='4939'>
                                                                    xkmv, &amp;<a name='4940'>
                                                                    xkhh, &amp;<a name='4941'>
                                                                    xkhv, &amp;<a name='4942'>
                                                                     tke, &amp;<a name='4943'>
                                                                     div, &amp;<a name='4944'>
                                                                     rho<a name='4945'>
<a name='4946'>
<font color=#447700>! End declarations.<a name='4947'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4948'></font>
<a name='4949'>
   IF(config_flags%bl_pbl_physics .GT. 0) THEN<a name='4950'>
<a name='4951'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_55">( RUBLTEN , 't', config_flags,              &amp;<a name='4952'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4953'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4954'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4955'>
                                its, ite, jts, jte, kts, kte              )<a name='4956'>
<a name='4957'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_56">( RVBLTEN , 't', config_flags,              &amp;<a name='4958'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4959'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4960'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4961'>
                                its, ite, jts, jte, kts, kte              )<a name='4962'>
<a name='4963'>
   ENDIF<a name='4964'>
<a name='4965'>
   IF(config_flags%cu_physics .GT. 0) THEN<a name='4966'>
<a name='4967'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_57">( RUCUTEN , 't', config_flags,              &amp;<a name='4968'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4969'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4970'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4971'>
                                its, ite, jts, jte, kts, kte              )<a name='4972'>
<a name='4973'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_58">( RVCUTEN , 't', config_flags,              &amp;<a name='4974'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4975'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4976'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4977'>
                                its, ite, jts, jte, kts, kte              )<a name='4978'>
<a name='4979'>
   ENDIF<a name='4980'>
<a name='4981'>
   IF(config_flags%shcu_physics .GT. 0) THEN<a name='4982'>
<a name='4983'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_59">( RUSHTEN , 't', config_flags,              &amp;<a name='4984'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4985'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4986'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4987'>
                                its, ite, jts, jte, kts, kte              )<a name='4988'>
<a name='4989'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_60">( RVSHTEN , 't', config_flags,              &amp;<a name='4990'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='4991'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='4992'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='4993'>
                                its, ite, jts, jte, kts, kte              )<a name='4994'>
<a name='4995'>
   ENDIF<a name='4996'>
<a name='4997'>
   <font color=#447700>! move out of the conditional, below; horiz coeffs needed for<a name='4998'></font>
   <font color=#447700>! all diff_opt cases.  JM<a name='4999'></font>
<a name='5000'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_61">( xkmh    , 't', config_flags,                   &amp;<a name='5001'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5002'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5003'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5004'>
                                its, ite, jts, jte, kts, kte              )<a name='5005'>
<a name='5006'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_62">( xkhh    , 't', config_flags,                   &amp;<a name='5007'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5008'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5009'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5010'>
                                its, ite, jts, jte, kts, kte              )<a name='5011'>
<a name='5012'>
   IF(config_flags%diff_opt .eq. 2) THEN<a name='5013'>
<a name='5014'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_63">( xkmv    , 't', config_flags,                   &amp;<a name='5015'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5016'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5017'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5018'>
                                its, ite, jts, jte, kts, kte              )<a name='5019'>
<a name='5020'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_64">( xkhv    , 't', config_flags,                   &amp;<a name='5021'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5022'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5023'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5024'>
                                its, ite, jts, jte, kts, kte              )<a name='5025'>
<a name='5026'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_65">( div     , 't', config_flags,                   &amp;<a name='5027'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5028'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5029'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5030'>
                                its, ite, jts, jte, kts, kte              )<a name='5031'>
<a name='5032'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_66">( defor11 , 't', config_flags,                   &amp;<a name='5033'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5034'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5035'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5036'>
                                its, ite, jts, jte, kts, kte              )<a name='5037'>
<a name='5038'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_67">( defor22 , 't', config_flags,                   &amp;<a name='5039'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5040'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5041'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5042'>
                                its, ite, jts, jte, kts, kte              )<a name='5043'>
<a name='5044'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_68">( defor33 , 't', config_flags,                   &amp;<a name='5045'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5046'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5047'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5048'>
                                its, ite, jts, jte, kts, kte              )<a name='5049'>
<a name='5050'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_69">( defor12 , 'd', config_flags,                   &amp;<a name='5051'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5052'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5053'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5054'>
                                its, ite, jts, jte, kts, kte              )<a name='5055'>
<a name='5056'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_70">( defor13 , 'e', config_flags,                   &amp;<a name='5057'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5058'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5059'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5060'>
                                its, ite, jts, jte, kts, kte              )<a name='5061'>
<a name='5062'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_71">( defor23 , 'f', config_flags,                   &amp;<a name='5063'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5064'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5065'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5066'>
                                its, ite, jts, jte, kts, kte              )<a name='5067'>
<a name='5068'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#PHY_BC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_72">( rho , 't', config_flags,                       &amp;<a name='5069'>
                                ids, ide, jds, jde, kds, kde,             &amp;<a name='5070'>
                                ims, ime, jms, jme, kms, kme,             &amp;<a name='5071'>
                                ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='5072'>
                                its, ite, jts, jte, kts, kte              )<a name='5073'>
   ENDIF<a name='5074'>
<a name='5075'>
END SUBROUTINE phy_bc<a name='5076'>
<a name='5077'>
<font color=#447700>!=======================================================================<a name='5078'></font>
<font color=#447700>!=======================================================================<a name='5079'></font>
<a name='5080'>
<A NAME='TKE_RHS'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5081'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_rhs</font>( tendency, BN2, config_flags,            &amp; <A href='../../call_to/TKE_RHS.html' TARGET='index'>1</A>,<A href='../../call_from/TKE_RHS.html' TARGET='index'>3</A><a name='5082'>
                        defor11, defor22, defor33,              &amp;<a name='5083'>
                        defor12, defor13, defor23,              &amp;<a name='5084'>
                        u, v, w, div, tke, mu, c1, c2,          &amp;<a name='5085'>
                        theta, p, p8w, t8w, z, fnm, fnp,        &amp;<a name='5086'>
                        cf1, cf2, cf3, msftx, msfty,            &amp;<a name='5087'>
                        xkmh, xkmv, xkhv,                       &amp;<a name='5088'>
                        rdx, rdy, dx, dy, dt, zx, zy,           &amp;<a name='5089'>
                        rdz, rdzw, dn, dnw, isotropic,          &amp;<a name='5090'>
                        hfx, qfx, qv, ust, rho,                 &amp;<a name='5091'>
                        ids, ide, jds, jde, kds, kde,           &amp;<a name='5092'>
                        ims, ime, jms, jme, kms, kme,           &amp;<a name='5093'>
                        its, ite, jts, jte, kts, kte            )<a name='5094'>
<a name='5095'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5096'></font>
<font color=#447700>! Begin declarations.<a name='5097'></font>
<a name='5098'>
    IMPLICIT NONE<a name='5099'>
<a name='5100'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='5101'>
    :: config_flags<a name='5102'>
<a name='5103'>
    INTEGER, INTENT( IN )  &amp;<a name='5104'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='5105'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='5106'>
       its, ite, jts, jte, kts, kte<a name='5107'>
<a name='5108'>
    INTEGER, INTENT( IN )  :: isotropic<a name='5109'>
    REAL, INTENT( IN )  &amp;<a name='5110'>
    :: cf1, cf2, cf3, dt, rdx, rdy, dx, dy<a name='5111'>
<a name='5112'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='5113'>
    :: fnm, fnp, dnw, dn<a name='5114'>
<a name='5115'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='5116'>
    :: msftx, msfty<a name='5117'>
<a name='5118'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='5119'>
    :: tendency<a name='5120'>
<a name='5121'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='5122'>
    :: defor11, defor22, defor33, defor12, defor13, defor23,  &amp;<a name='5123'>
       div, BN2, tke, xkmh, xkmv, xkhv, zx, zy, u, v, w, theta,  &amp;<a name='5124'>
       p, p8w, t8w, z, rdz, rdzw<a name='5125'>
<a name='5126'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='5127'>
    :: mu<a name='5128'>
    REAL, DIMENSION( kms:kme)          , INTENT( IN )  &amp;<a name='5129'>
    :: c1, c2<a name='5130'>
<a name='5131'>
    REAL, DIMENSION ( ims:ime, jms:jme ), INTENT( IN )   &amp;<a name='5132'>
    :: hfx, ust, qfx<a name='5133'>
    REAL, DIMENSION ( ims:ime, kms:kme, jms:jme ), INTENT ( IN ) &amp;<a name='5134'>
    :: qv, rho<a name='5135'>
<a name='5136'>
<font color=#447700>! Local variables.<a name='5137'></font>
<a name='5138'>
    INTEGER  &amp;<a name='5139'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='5140'>
<a name='5141'>
<font color=#447700>! End declarations.<a name='5142'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5143'></font>
<a name='5144'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_SHEAR'>tke_shear</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_SHEAR_1">(    tendency, config_flags,                &amp;<a name='5145'>
                       defor11, defor22, defor33,             &amp;<a name='5146'>
                       defor12, defor13, defor23,             &amp;<a name='5147'>
                       u, v, w, tke, ust, mu,                 &amp;<a name='5148'>
                       c1, c2, fnm, fnp,                      &amp;<a name='5149'>
                       cf1, cf2, cf3, msftx, msfty,           &amp;<a name='5150'>
                       xkmh, xkmv,                            &amp;<a name='5151'>
                       rdx, rdy, zx, zy, rdz, rdzw, dnw, dn,  &amp;<a name='5152'>
                       ids, ide, jds, jde, kds, kde,          &amp;<a name='5153'>
                       ims, ime, jms, jme, kms, kme,          &amp;<a name='5154'>
                       its, ite, jts, jte, kts, kte           )<a name='5155'>
<a name='5156'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_BUOYANCY'>tke_buoyancy</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_BUOYANCY_1">( tendency, config_flags, mu, c1, c2,    &amp;<a name='5157'>
                       tke, xkhv, BN2, theta, dt,             &amp;<a name='5158'>
                       hfx, qfx, qv,  rho,                    &amp;<a name='5159'>
                       ids, ide, jds, jde, kds, kde,          &amp;<a name='5160'>
                       ims, ime, jms, jme, kms, kme,          &amp;<a name='5161'>
                       its, ite, jts, jte, kts, kte           )<a name='5162'>
<a name='5163'>
    CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_DISSIP'>tke_dissip</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_RHS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TKE_DISSIP_1">(   tendency, config_flags, mu, c1, c2,    &amp;<a name='5164'>
                       tke, bn2, theta, p8w, t8w, z,          &amp;<a name='5165'>
                       dx, dy,rdz, rdzw, isotropic,           &amp;<a name='5166'>
                       msftx, msfty,                          &amp;<a name='5167'>
                       ids, ide, jds, jde, kds, kde,          &amp;<a name='5168'>
                       ims, ime, jms, jme, kms, kme,          &amp;<a name='5169'>
                       its, ite, jts, jte, kts, kte           )<a name='5170'>
<a name='5171'>
<font color=#447700>! Set a lower limit on TKE.<a name='5172'></font>
<a name='5173'>
    ktf     = MIN( kte, kde-1 )<a name='5174'>
    i_start = its<a name='5175'>
    i_end   = MIN( ite, ide-1 )<a name='5176'>
    j_start = jts<a name='5177'>
    j_end   = MIN( jte, jde-1 )<a name='5178'>
<a name='5179'>
    IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='5180'>
         config_flags%nested) i_start = MAX(ids+1,its)<a name='5181'>
    IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='5182'>
         config_flags%nested) i_end   = MIN(ide-2,ite)<a name='5183'>
    IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='5184'>
         config_flags%nested) j_start = MAX(jds+1,jts)<a name='5185'>
    IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='5186'>
         config_flags%nested) j_end   = MIN(jde-2,jte)<a name='5187'>
      IF ( config_flags%periodic_x ) i_start = its<a name='5188'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='5189'>
<a name='5190'>
    DO j = j_start, j_end<a name='5191'>
    DO k = kts, ktf<a name='5192'>
    DO i = i_start, i_end<a name='5193'>
      tendency(i,k,j) = max( tendency(i,k,j), -mu(i,j) * max( 0.0 , tke(i,k,j) ) / dt )<a name='5194'>
    END DO<a name='5195'>
    END DO<a name='5196'>
    END DO<a name='5197'>
<a name='5198'>
    END SUBROUTINE tke_rhs<a name='5199'>
<a name='5200'>
<font color=#447700>!=======================================================================<a name='5201'></font>
<font color=#447700>!=======================================================================<a name='5202'></font>
<a name='5203'>
<A NAME='TKE_BUOYANCY'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_BUOYANCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5204'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_buoyancy</font>( tendency, config_flags, mu,    &amp; <A href='../../call_to/TKE_BUOYANCY.html' TARGET='index'>1</A>,<A href='../../call_from/TKE_BUOYANCY.html' TARGET='index'>1</A><a name='5205'>
                             c1, c2,                        &amp;<a name='5206'>
                             tke, xkhv, BN2, theta, dt,     &amp;<a name='5207'>
                             hfx, qfx, qv,  rho,            &amp;<a name='5208'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='5209'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='5210'>
                             its, ite, jts, jte, kts, kte   )<a name='5211'>
<a name='5212'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5213'></font>
<font color=#447700>! Begin declarations.<a name='5214'></font>
<a name='5215'>
    IMPLICIT NONE<a name='5216'>
<a name='5217'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='5218'>
    :: config_flags<a name='5219'>
<a name='5220'>
    INTEGER, INTENT( IN )  &amp;<a name='5221'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='5222'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='5223'>
       its, ite, jts, jte, kts, kte<a name='5224'>
<a name='5225'>
    REAL, INTENT( IN )  &amp;<a name='5226'>
    :: dt<a name='5227'>
<a name='5228'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='5229'>
    :: tendency<a name='5230'>
<a name='5231'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='5232'>
    :: xkhv, tke, BN2, theta<a name='5233'>
<a name='5234'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='5235'>
    :: mu<a name='5236'>
    REAL, DIMENSION( kms:kme)          , INTENT( IN )  &amp;<a name='5237'>
    :: c1, c2<a name='5238'>
<a name='5239'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT ( IN ) &amp;<a name='5240'>
    :: qv, rho<a name='5241'>
<a name='5242'>
    REAL, DIMENSION(ims:ime, jms:jme ), INTENT ( IN ) :: hfx, qfx<a name='5243'>
<a name='5244'>
<font color=#447700>! Local variables.<a name='5245'></font>
<a name='5246'>
    INTEGER  &amp;<a name='5247'>
    :: i, j, k, ktf<a name='5248'>
<a name='5249'>
    INTEGER  &amp;<a name='5250'>
    :: i_start, i_end, j_start, j_end<a name='5251'>
<a name='5252'>
    REAL :: heat_flux, heat_flux0<a name='5253'>
<a name='5254'>
    REAL :: cpm<a name='5255'>
<a name='5256'>
<font color=#447700>! End declarations.<a name='5257'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5258'></font>
<a name='5259'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5260'></font>
<font color=#447700>! Add to the TKE tendency the term that accounts for production of TKE<a name='5261'></font>
<font color=#447700>! due to buoyant motions.<a name='5262'></font>
<a name='5263'>
    ktf     = MIN( kte, kde-1 )<a name='5264'>
    i_start = its<a name='5265'>
    i_end   = MIN( ite, ide-1 )<a name='5266'>
    j_start = jts<a name='5267'>
    j_end   = MIN( jte, jde-1 )<a name='5268'>
<a name='5269'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='5270'>
         config_flags%nested ) i_start = MAX( ids+1, its )<a name='5271'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='5272'>
         config_flags%nested ) i_end   = MIN( ide-2, ite )<a name='5273'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='5274'>
         config_flags%nested ) j_start = MAX( jds+1, jts )<a name='5275'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='5276'>
         config_flags%nested ) j_end   = MIN( jde-2, jte )<a name='5277'>
      IF ( config_flags%periodic_x ) i_start = its<a name='5278'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='5279'>
<a name='5280'>
    DO j = j_start, j_end<a name='5281'>
    DO k = kts+1, ktf<a name='5282'>
    DO i = i_start, i_end<a name='5283'>
      tendency(i,k,j) = tendency(i,k,j) - mu(i,j) * xkhv(i,k,j) * BN2(i,k,j)<a name='5284'>
    END DO<a name='5285'>
    END DO<a name='5286'>
    END DO<a name='5287'>
<a name='5288'>
<font color=#447700>! MARTA: change in the computation of the tke's tendency  at the surface.<a name='5289'></font>
<font color=#447700>!  the buoyancy flux is the average of the surface heat flux (0.06) and the<a name='5290'></font>
<font color=#447700>!   flux at the first w level<a name='5291'></font>
<font color=#447700>!<a name='5292'></font>
<font color=#447700>! WCS 040331<a name='5293'></font>
<a name='5294'>
  hflux: SELECT CASE( config_flags%isfflx )<a name='5295'>
  CASE (0,2) <font color=#447700>! with fixed surface heat flux given in the namelist<a name='5296'></font>
   heat_flux0 = config_flags%tke_heat_flux  <font color=#447700>! constant heat flux value<a name='5297'></font>
                                            <font color=#447700>! set in namelist.input<a name='5298'></font>
<font color=#447700>! LES mods<a name='5299'></font>
   K=KTS<a name='5300'>
   DO j = j_start, j_end<a name='5301'>
   DO i = i_start, i_end<a name='5302'>
      heat_flux = heat_flux0<a name='5303'>
      tendency(i,k,j)= tendency(i,k,j) - &amp;<a name='5304'>
                   mu(i,j)*((xkhv(i,k,j)*BN2(i,k,j))- (g/theta(i,k,j))*heat_flux)/2.<a name='5305'>
<a name='5306'>
   ENDDO<a name='5307'>
   ENDDO<a name='5308'>
<a name='5309'>
  CASE (1) <font color=#447700>! use surface heat flux computed from surface routine<a name='5310'></font>
   K=KTS<a name='5311'>
   DO j = j_start, j_end<a name='5312'>
   DO i = i_start, i_end<a name='5313'>
      cpm = cp * (1. + 0.8*qv(i,k,j))<a name='5314'>
      heat_flux = (hfx(i,j)/cpm)/rho(i,k,j)<a name='5315'>
<a name='5316'>
      tendency(i,k,j)= tendency(i,k,j) - &amp;<a name='5317'>
                   mu(i,j)*((xkhv(i,k,j)*BN2(i,k,j))- (g/theta(i,k,j))*heat_flux)/2.<a name='5318'>
<a name='5319'>
   ENDDO<a name='5320'>
   ENDDO<a name='5321'>
<a name='5322'>
  CASE DEFAULT<a name='5323'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_BUOYANCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_19">( 'isfflx value invalid for diff_opt=2' )<a name='5324'>
  END SELECT hflux<a name='5325'>
<a name='5326'>
<font color=#447700>! end of MARTA/WCS change<a name='5327'></font>
<a name='5328'>
<font color=#447700>! The tendency array now includes production of TKE from buoyant<a name='5329'></font>
<font color=#447700>! motions.<a name='5330'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5331'></font>
<a name='5332'>
    END SUBROUTINE tke_buoyancy<a name='5333'>
<a name='5334'>
<font color=#447700>!=======================================================================<a name='5335'></font>
<font color=#447700>!=======================================================================<a name='5336'></font>
<a name='5337'>
<A NAME='TKE_DISSIP'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_DISSIP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5338'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_dissip</font>( tendency, config_flags,            &amp; <A href='../../call_to/TKE_DISSIP.html' TARGET='index'>1</A>,<A href='../../call_from/TKE_DISSIP.html' TARGET='index'>1</A><a name='5339'>
                           mu, c1, c2,                        &amp;<a name='5340'>
                           tke, bn2, theta, p8w, t8w, z,      &amp;<a name='5341'>
                           dx, dy, rdz, rdzw, isotropic,      &amp;<a name='5342'>
                           msftx, msfty,                      &amp;<a name='5343'>
                           ids, ide, jds, jde, kds, kde,      &amp;<a name='5344'>
                           ims, ime, jms, jme, kms, kme,      &amp;<a name='5345'>
                           its, ite, jts, jte, kts, kte       )<a name='5346'>
<a name='5347'>
<font color=#447700>! History:     Sep 2003  Changes by George Bryan and Jason Knievel, NCAR<a name='5348'></font>
<font color=#447700>!              Oct 2001  Converted to mass core by Bill Skamarock, NCAR<a name='5349'></font>
<font color=#447700>!              Aug 2000  Original code by Shu-Hua Chen, UC-Davis<a name='5350'></font>
<a name='5351'>
<font color=#447700>! Purpose:     This routine calculates dissipation of turbulent kinetic<a name='5352'></font>
<font color=#447700>!              energy.<a name='5353'></font>
<a name='5354'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='5355'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='5356'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='5357'></font>
<a name='5358'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5359'></font>
<font color=#447700>! Begin declarations.<a name='5360'></font>
<a name='5361'>
    IMPLICIT NONE<a name='5362'>
<a name='5363'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='5364'>
    :: config_flags<a name='5365'>
<a name='5366'>
    INTEGER, INTENT( IN )  &amp;<a name='5367'>
    ::  ids, ide, jds, jde, kds, kde,  &amp;<a name='5368'>
        ims, ime, jms, jme, kms, kme,  &amp;<a name='5369'>
        its, ite, jts, jte, kts, kte<a name='5370'>
<a name='5371'>
    INTEGER, INTENT( IN )  :: isotropic<a name='5372'>
    REAL, INTENT( IN )  &amp;<a name='5373'>
    :: dx, dy<a name='5374'>
<a name='5375'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='5376'>
    :: tendency<a name='5377'>
<a name='5378'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='5379'>
    :: tke, bn2, theta, p8w, t8w, z, rdz, rdzw<a name='5380'>
<a name='5381'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='5382'>
    :: mu<a name='5383'>
    REAL, DIMENSION( kms:kme)          , INTENT( IN )  &amp;<a name='5384'>
    :: c1, c2<a name='5385'>
<a name='5386'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='5387'>
    :: msftx, msfty<a name='5388'>
<font color=#447700>! Local variables.<a name='5389'></font>
<a name='5390'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='5391'>
    :: dthrdn<a name='5392'>
<a name='5393'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='5394'>
    :: l_scale<a name='5395'>
<a name='5396'>
    REAL, DIMENSION( its:ite )  &amp;<a name='5397'>
    :: sumtke,  sumtkez<a name='5398'>
<a name='5399'>
    INTEGER  &amp;<a name='5400'>
    :: i, j, k, ktf, i_start, i_end, j_start, j_end<a name='5401'>
<a name='5402'>
    REAL  &amp;<a name='5403'>
    :: disp_len, deltas, coefc, tmpdz, len_s, thetasfc,  &amp;<a name='5404'>
       thetatop, len_0, tketmp, tmp, ce1, ce2, c_k<a name='5405'>
<a name='5406'>
<font color=#447700>! End declarations.<a name='5407'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5408'></font>
    c_k = config_flags%c_k<a name='5409'>
<a name='5410'>
    ce1 = ( c_k / 0.10 ) * 0.19<a name='5411'>
    ce2 = max( 0.0 , 0.93 - ce1 )<a name='5412'>
<a name='5413'>
    ktf     = MIN( kte, kde-1 )<a name='5414'>
    i_start = its<a name='5415'>
    i_end   = MIN(ite,ide-1)<a name='5416'>
    j_start = jts<a name='5417'>
    j_end   = MIN(jte,jde-1)<a name='5418'>
<a name='5419'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='5420'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='5421'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='5422'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='5423'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='5424'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='5425'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='5426'>
         config_flags%nested) j_end   = MIN( jde-2, jte )<a name='5427'>
      IF ( config_flags%periodic_x ) i_start = its<a name='5428'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='5429'>
<a name='5430'>
      CALL <A href='../../html_code/dyn_em/module_diffusion_em.F.html#CALC_L_SCALE'>calc_l_scale</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_DISSIP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_L_SCALE_2">( config_flags, tke, BN2, l_scale,      &amp;<a name='5431'>
                         i_start, i_end, ktf, j_start, j_end,  &amp;<a name='5432'>
                         dx, dy, rdzw, msftx, msfty,           &amp;<a name='5433'>
                         ids, ide, jds, jde, kds, kde,         &amp;<a name='5434'>
                         ims, ime, jms, jme, kms, kme,         &amp;<a name='5435'>
                         its, ite, jts, jte, kts, kte          )<a name='5436'>
      DO j = j_start, j_end<a name='5437'>
      DO k = kts, ktf<a name='5438'>
      DO i = i_start, i_end<a name='5439'>
        deltas  = ( dx/msftx(i,j) * dy/msfty(i,j) / rdzw(i,k,j) )**0.33333333<a name='5440'>
        tketmp  = MAX( tke(i,k,j), 1.0e-6 )<a name='5441'>
<a name='5442'>
<font color=#447700>! Apply Deardorff's (1980) "wall effect" at the bottom of the domain.<a name='5443'></font>
<font color=#447700>! For LES with fine grid, no need for this wall effect!<a name='5444'></font>
<a name='5445'>
        IF ( k .eq. kts .or. k .eq. ktf ) then<a name='5446'>
          coefc = 3.9<a name='5447'>
        ELSE<a name='5448'>
          coefc = ce1 + ce2 * l_scale(i,k,j) / deltas<a name='5449'>
        END IF<a name='5450'>
<a name='5451'>
        tendency(i,k,j) = tendency(i,k,j) - &amp;<a name='5452'>
                          mu(i,j) * coefc * tketmp**1.5 / l_scale(i,k,j)<a name='5453'>
      END DO<a name='5454'>
      END DO<a name='5455'>
      END DO<a name='5456'>
<a name='5457'>
    END SUBROUTINE tke_dissip<a name='5458'>
<a name='5459'>
<font color=#447700>!=======================================================================<a name='5460'></font>
<font color=#447700>!=======================================================================<a name='5461'></font>
<a name='5462'>
<A NAME='TKE_SHEAR'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_SHEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5463'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>tke_shear</font>( tendency, config_flags,                &amp; <A href='../../call_to/TKE_SHEAR.html' TARGET='index'>1</A>,<A href='../../call_from/TKE_SHEAR.html' TARGET='index'>2</A><a name='5464'>
                          defor11, defor22, defor33,             &amp;<a name='5465'>
                          defor12, defor13, defor23,             &amp;<a name='5466'>
                          u, v, w, tke, ust, mu, c1, c2,         &amp;<a name='5467'>
                          fnm, fnp,                              &amp;<a name='5468'>
                          cf1, cf2, cf3, msftx, msfty,           &amp;<a name='5469'>
                          xkmh, xkmv,                            &amp;<a name='5470'>
                          rdx, rdy, zx, zy, rdz, rdzw, dn, dnw,  &amp;<a name='5471'>
                          ids, ide, jds, jde, kds, kde,          &amp;<a name='5472'>
                          ims, ime, jms, jme, kms, kme,          &amp;<a name='5473'>
                          its, ite, jts, jte, kts, kte           )<a name='5474'>
<a name='5475'>
<font color=#447700>! History:     Sep 2003   Rewritten by George Bryan and Jason Knievel,<a name='5476'></font>
<font color=#447700>!                         NCAR<a name='5477'></font>
<font color=#447700>!              Oct 2001   Converted to mass core by Bill Skamarock, NCAR<a name='5478'></font>
<font color=#447700>!              Aug 2000   Original code by Shu-Hua Chen, UC-Davis<a name='5479'></font>
<a name='5480'>
<font color=#447700>! Purpose:     This routine calculates the production of turbulent<a name='5481'></font>
<font color=#447700>!              kinetic energy by stresses due to sheared wind.<a name='5482'></font>
<a name='5483'>
<font color=#447700>! References:  Klemp and Wilhelmson (JAS 1978)<a name='5484'></font>
<font color=#447700>!              Deardorff (B-L Meteor 1980)<a name='5485'></font>
<font color=#447700>!              Chen and Dudhia (NCAR WRF physics report 2000)<a name='5486'></font>
<a name='5487'>
<font color=#447700>! Key:<a name='5488'></font>
<a name='5489'>
<font color=#447700>! avg          temporary working array<a name='5490'></font>
<font color=#447700>! cf1<a name='5491'></font>
<font color=#447700>! cf2<a name='5492'></font>
<font color=#447700>! cf3<a name='5493'></font>
<font color=#447700>! defor11      deformation term ( du/dx + du/dx )<a name='5494'></font>
<font color=#447700>! defor12      deformation term ( dv/dx + du/dy ); same as defor21<a name='5495'></font>
<font color=#447700>! defor13      deformation term ( dw/dx + du/dz ); same as defor31<a name='5496'></font>
<font color=#447700>! defor22      deformation term ( dv/dy + dv/dy )<a name='5497'></font>
<font color=#447700>! defor23      deformation term ( dw/dy + dv/dz ); same as defor32<a name='5498'></font>
<font color=#447700>! defor33      deformation term ( dw/dz + dw/dz )<a name='5499'></font>
<font color=#447700>! div          3-d divergence<a name='5500'></font>
<font color=#447700>! dn<a name='5501'></font>
<font color=#447700>! dnw<a name='5502'></font>
<font color=#447700>! fnm<a name='5503'></font>
<font color=#447700>! fnp<a name='5504'></font>
<font color=#447700>! msftx<a name='5505'></font>
<font color=#447700>! msfty<a name='5506'></font>
<font color=#447700>! rdx<a name='5507'></font>
<font color=#447700>! rdy<a name='5508'></font>
<font color=#447700>! tendency<a name='5509'></font>
<font color=#447700>! titau        tau (stress tensor) with a tilde, indicating division by<a name='5510'></font>
<font color=#447700>!              a map-scale factor and the fraction of the total modeled<a name='5511'></font>
<font color=#447700>!              atmosphere beneath a given altitude (titau = tau/m/zeta)<a name='5512'></font>
<font color=#447700>! tke          turbulent kinetic energy<a name='5513'></font>
<a name='5514'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5515'></font>
<font color=#447700>! Begin declarations.<a name='5516'></font>
<a name='5517'>
    IMPLICIT NONE<a name='5518'>
<a name='5519'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='5520'>
    :: config_flags<a name='5521'>
<a name='5522'>
    INTEGER, INTENT( IN )  &amp;<a name='5523'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='5524'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='5525'>
       its, ite, jts, jte, kts, kte<a name='5526'>
<a name='5527'>
    REAL, INTENT( IN )  &amp;<a name='5528'>
    :: cf1, cf2, cf3, rdx, rdy<a name='5529'>
<a name='5530'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='5531'>
    :: fnm, fnp, dn, dnw<a name='5532'>
<a name='5533'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='5534'>
    :: msftx, msfty<a name='5535'>
<a name='5536'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='5537'>
    :: tendency<a name='5538'>
<a name='5539'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='5540'>
    :: defor11, defor22, defor33, defor12, defor13, defor23,    &amp;<a name='5541'>
       tke, xkmh, xkmv, zx, zy, u, v, w, rdz, rdzw<a name='5542'>
<a name='5543'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='5544'>
    :: mu<a name='5545'>
    REAL, DIMENSION( kms:kme)          , INTENT( IN )  &amp;<a name='5546'>
    :: c1, c2<a name='5547'>
<a name='5548'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( IN )  &amp;<a name='5549'>
    :: ust<a name='5550'>
<a name='5551'>
<font color=#447700>! Local variables.<a name='5552'></font>
<a name='5553'>
    INTEGER  &amp;<a name='5554'>
    :: i, j, k, ktf, ktes1, ktes2,      &amp;<a name='5555'>
       i_start, i_end, j_start, j_end,  &amp;<a name='5556'>
       is_ext, ie_ext, js_ext, je_ext<a name='5557'>
<a name='5558'>
    REAL  &amp;<a name='5559'>
    :: mtau<a name='5560'>
<a name='5561'>
    REAL, DIMENSION( its-1:ite+1, kts:kte, jts-1:jte+1 )  &amp;<a name='5562'>
    :: avg, titau, tmp2<a name='5563'>
<a name='5564'>
    REAL, DIMENSION( its:ite, kts:kte, jts:jte )  &amp;<a name='5565'>
    :: titau12, tmp1, zxavg, zyavg<a name='5566'>
<a name='5567'>
    REAL :: absU, cd0, Cd<a name='5568'>
<a name='5569'>
<font color=#447700>! End declarations.<a name='5570'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5571'></font>
<a name='5572'>
    ktf    = MIN( kte, kde-1 )<a name='5573'>
    ktes1  = kte-1<a name='5574'>
    ktes2  = kte-2<a name='5575'>
<a name='5576'>
    i_start = its<a name='5577'>
    i_end   = MIN( ite, ide-1 )<a name='5578'>
    j_start = jts<a name='5579'>
    j_end   = MIN( jte, jde-1 )<a name='5580'>
<a name='5581'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='5582'>
         config_flags%nested ) i_start = MAX( ids+1, its )<a name='5583'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='5584'>
         config_flags%nested ) i_end   = MIN( ide-2, ite )<a name='5585'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='5586'>
         config_flags%nested ) j_start = MAX( jds+1, jts )<a name='5587'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='5588'>
         config_flags%nested ) j_end   = MIN( jde-2, jte )<a name='5589'>
      IF ( config_flags%periodic_x ) i_start = its<a name='5590'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='5591'>
<a name='5592'>
    DO j = j_start, j_end<a name='5593'>
    DO k = kts, ktf<a name='5594'>
    DO i = i_start, i_end<a name='5595'>
      zxavg(i,k,j) = 0.25 * ( zx(i,k  ,j) + zx(i+1,k  ,j) + &amp;<a name='5596'>
                              zx(i,k+1,j) + zx(i+1,k+1,j)  )<a name='5597'>
      zyavg(i,k,j) = 0.25 * ( zy(i,k  ,j) + zy(i,k  ,j+1) + &amp;<a name='5598'>
                              zy(i,k+1,j) + zy(i,k+1,j+1)  )<a name='5599'>
    END DO<a name='5600'>
    END DO<a name='5601'>
    END DO<a name='5602'>
<a name='5603'>
<font color=#447700>! Begin calculating production of turbulence due to shear.  The approach<a name='5604'></font>
<font color=#447700>! is to add together contributions from six terms, each of which is the<a name='5605'></font>
<font color=#447700>! square of a deformation that is then multiplied by an exchange<a name='5606'></font>
<font color=#447700>! coefficiant.  The same exchange coefficient is assumed for horizontal<a name='5607'></font>
<font color=#447700>! and vertical coefficients for some of the terms (the vertical value is<a name='5608'></font>
<font color=#447700>! the one used).<a name='5609'></font>
<a name='5610'>
<font color=#447700>! For defor11.<a name='5611'></font>
<a name='5612'>
    DO j = j_start, j_end<a name='5613'>
    DO k = kts, ktf<a name='5614'>
    DO i = i_start, i_end<a name='5615'>
      tendency(i,k,j) = tendency(i,k,j) + 0.5 *  &amp;<a name='5616'>
                        mu(i,j) * xkmh(i,k,j) * ( ( defor11(i,k,j) )**2 )<a name='5617'>
    END DO<a name='5618'>
    END DO<a name='5619'>
    END DO<a name='5620'>
<a name='5621'>
<font color=#447700>! For defor22.<a name='5622'></font>
<a name='5623'>
    DO j = j_start, j_end<a name='5624'>
    DO k = kts, ktf<a name='5625'>
    DO i = i_start, i_end<a name='5626'>
      tendency(i,k,j) = tendency(i,k,j) + 0.5 *  &amp;<a name='5627'>
                        mu(i,j) * xkmh(i,k,j) * ( ( defor22(i,k,j) )**2 )<a name='5628'>
    END DO<a name='5629'>
    END DO<a name='5630'>
    END DO<a name='5631'>
<a name='5632'>
<font color=#447700>! For defor33.<a name='5633'></font>
<a name='5634'>
    DO j = j_start, j_end<a name='5635'>
    DO k = kts, ktf<a name='5636'>
    DO i = i_start, i_end<a name='5637'>
      tendency(i,k,j) = tendency(i,k,j) + 0.5 *  &amp;<a name='5638'>
                        mu(i,j) * xkmv(i,k,j) * ( ( defor33(i,k,j) )**2 )<a name='5639'>
    END DO<a name='5640'>
    END DO<a name='5641'>
    END DO<a name='5642'>
<a name='5643'>
<font color=#447700>! For defor12.<a name='5644'></font>
<a name='5645'>
    DO j = j_start, j_end<a name='5646'>
    DO k = kts, ktf<a name='5647'>
    DO i = i_start, i_end<a name='5648'>
      avg(i,k,j) = 0.25 *  &amp;<a name='5649'>
                   ( ( defor12(i  ,k,j)**2 ) + ( defor12(i  ,k,j+1)**2 ) +  &amp;<a name='5650'>
                     ( defor12(i+1,k,j)**2 ) + ( defor12(i+1,k,j+1)**2 ) )<a name='5651'>
    END DO<a name='5652'>
    END DO<a name='5653'>
    END DO<a name='5654'>
<a name='5655'>
    DO j = j_start, j_end<a name='5656'>
    DO k = kts, ktf<a name='5657'>
    DO i = i_start, i_end<a name='5658'>
      tendency(i,k,j) = tendency(i,k,j) + mu(i,j) * xkmh(i,k,j) * avg(i,k,j)<a name='5659'>
    END DO<a name='5660'>
    END DO<a name='5661'>
    END DO<a name='5662'>
<a name='5663'>
<font color=#447700>! For defor13.<a name='5664'></font>
<a name='5665'>
    DO j = j_start, j_end<a name='5666'>
    DO k = kts+1, ktf<a name='5667'>
    DO i = i_start, i_end+1<a name='5668'>
      tmp2(i,k,j) = defor13(i,k,j)<a name='5669'>
    END DO<a name='5670'>
    END DO<a name='5671'>
    END DO<a name='5672'>
<a name='5673'>
    DO j = j_start, j_end<a name='5674'>
    DO i = i_start, i_end+1<a name='5675'>
      tmp2(i,kts  ,j) = 0.0<a name='5676'>
      tmp2(i,ktf+1,j) = 0.0<a name='5677'>
    END DO<a name='5678'>
    END DO<a name='5679'>
<a name='5680'>
    DO j = j_start, j_end<a name='5681'>
    DO k = kts, ktf<a name='5682'>
    DO i = i_start, i_end<a name='5683'>
      avg(i,k,j) = 0.25 *  &amp;<a name='5684'>
                   ( ( tmp2(i  ,k+1,j)**2 ) + ( tmp2(i  ,k,j)**2 ) +  &amp;<a name='5685'>
                     ( tmp2(i+1,k+1,j)**2 ) + ( tmp2(i+1,k,j)**2 ) )<a name='5686'>
    END DO<a name='5687'>
    END DO<a name='5688'>
    END DO<a name='5689'>
<a name='5690'>
    DO j = j_start, j_end<a name='5691'>
    DO k = kts, ktf<a name='5692'>
    DO i = i_start, i_end<a name='5693'>
      tendency(i,k,j) = tendency(i,k,j) + mu(i,j) * xkmv(i,k,j) * avg(i,k,j)<a name='5694'>
    END DO<a name='5695'>
    END DO<a name='5696'>
    END DO<a name='5697'>
<a name='5698'>
<font color=#447700>!MARTA: add the drag at the surface; WCS 040331<a name='5699'></font>
    K=KTS<a name='5700'>
<a name='5701'>
  uflux: SELECT CASE( config_flags%isfflx )<a name='5702'>
  CASE (0) <font color=#447700>! Assume cd a constant, specified in namelist<a name='5703'></font>
<a name='5704'>
    cd0 = config_flags%tke_drag_coefficient  <font color=#447700>! drag coefficient set<a name='5705'></font>
                                             <font color=#447700>! in namelist.input<a name='5706'></font>
    DO j = j_start, j_end<a name='5707'>
    DO i = i_start, i_end<a name='5708'>
<a name='5709'>
      absU=0.5*sqrt((u(i,k,j)+u(i+1,k,j))**2+(v(i,k,j)+v(i,k,j+1))**2)<a name='5710'>
      Cd = cd0<a name='5711'>
      tendency(i,k,j) = tendency(i,k,j) +       &amp;<a name='5712'>
           mu(i,j)*( (u(i,k,j)+u(i+1,k,j))*0.5* &amp;<a name='5713'>
                     Cd*absU*(defor13(i,kts+1,j)+defor13(i+1,kts+1,j))*0.5 )<a name='5714'>
<a name='5715'>
    END DO<a name='5716'>
    END DO<a name='5717'>
<a name='5718'>
  CASE (1,2) <font color=#447700>! ustar computed from surface routine<a name='5719'></font>
<a name='5720'>
    DO j = j_start, j_end<a name='5721'>
    DO i = i_start, i_end<a name='5722'>
<a name='5723'>
      absU=0.5*sqrt((u(i,k,j)+u(i+1,k,j))**2+(v(i,k,j)+v(i,k,j+1))**2)+epsilon<a name='5724'>
      Cd = (ust(i,j)**2)/(absU**2)<a name='5725'>
      tendency(i,k,j) = tendency(i,k,j) +       &amp;<a name='5726'>
           mu(i,j)*( (u(i,k,j)+u(i+1,k,j))*0.5* &amp;<a name='5727'>
                     Cd*absU*(defor13(i,kts+1,j)+defor13(i+1,kts+1,j))*0.5 )<a name='5728'>
<a name='5729'>
    END DO<a name='5730'>
    END DO<a name='5731'>
<a name='5732'>
  CASE DEFAULT<a name='5733'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_SHEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_20">( 'isfflx value invalid for diff_opt=2' )<a name='5734'>
  END SELECT uflux<a name='5735'>
<font color=#447700>! end of MARTA/WCS change<a name='5736'></font>
<a name='5737'>
<font color=#447700>! For defor23.<a name='5738'></font>
<a name='5739'>
    DO j = j_start, j_end+1<a name='5740'>
    DO k = kts+1, ktf<a name='5741'>
    DO i = i_start, i_end<a name='5742'>
      tmp2(i,k,j) = defor23(i,k,j)<a name='5743'>
    END DO<a name='5744'>
    END DO<a name='5745'>
    END DO<a name='5746'>
<a name='5747'>
    DO j = j_start, j_end+1<a name='5748'>
    DO i = i_start, i_end<a name='5749'>
      tmp2(i,kts,  j) = 0.0<a name='5750'>
      tmp2(i,ktf+1,j) = 0.0<a name='5751'>
    END DO<a name='5752'>
    END DO<a name='5753'>
<a name='5754'>
    DO j = j_start, j_end<a name='5755'>
    DO k = kts, ktf<a name='5756'>
    DO i = i_start, i_end<a name='5757'>
      avg(i,k,j) = 0.25 *  &amp;<a name='5758'>
                   ( ( tmp2(i,k+1,j  )**2 ) + ( tmp2(i,k,j  )**2) +  &amp;<a name='5759'>
                     ( tmp2(i,k+1,j+1)**2 ) + ( tmp2(i,k,j+1)**2) )<a name='5760'>
    END DO<a name='5761'>
    END DO<a name='5762'>
    END DO<a name='5763'>
<a name='5764'>
    DO j = j_start, j_end<a name='5765'>
    DO k = kts, ktf<a name='5766'>
    DO i = i_start, i_end<a name='5767'>
      tendency(i,k,j) = tendency(i,k,j) + mu(i,j) * xkmv(i,k,j) * avg(i,k,j)<a name='5768'>
    END DO<a name='5769'>
    END DO<a name='5770'>
    END DO<a name='5771'>
<a name='5772'>
<font color=#447700>!MARTA: add the drag at the surface; WCS 040331<a name='5773'></font>
    K=KTS<a name='5774'>
<a name='5775'>
  vflux: SELECT CASE( config_flags%isfflx )<a name='5776'>
  CASE (0) <font color=#447700>! Assume cd a constant, specified in namelist<a name='5777'></font>
<a name='5778'>
    cd0 = config_flags%tke_drag_coefficient   <font color=#447700>! constant drag coefficient<a name='5779'></font>
                                              <font color=#447700>! set in namelist.input<a name='5780'></font>
    DO j = j_start, j_end<a name='5781'>
    DO i = i_start, i_end<a name='5782'>
<a name='5783'>
      absU=0.5*sqrt((u(i,k,j)+u(i+1,k,j))**2+(v(i,k,j)+v(i,k,j+1))**2)<a name='5784'>
      Cd = cd0<a name='5785'>
      tendency(i,k,j) = tendency(i,k,j) +       &amp;<a name='5786'>
           mu(i,j)*( (v(i,k,j)+v(i,k,j+1))*0.5* &amp;<a name='5787'>
                     Cd*absU*(defor23(i,kts+1,j)+defor23(i,kts+1,j+1))*0.5 )<a name='5788'>
<a name='5789'>
    END DO<a name='5790'>
    END DO<a name='5791'>
<a name='5792'>
  CASE (1,2) <font color=#447700>! ustar computed from surface routine<a name='5793'></font>
<a name='5794'>
    DO j = j_start, j_end<a name='5795'>
    DO i = i_start, i_end<a name='5796'>
<a name='5797'>
      absU=0.5*sqrt((u(i,k,j)+u(i+1,k,j))**2+(v(i,k,j)+v(i,k,j+1))**2)+epsilon<a name='5798'>
      Cd = (ust(i,j)**2)/(absU**2)<a name='5799'>
      tendency(i,k,j) = tendency(i,k,j) +       &amp;<a name='5800'>
           mu(i,j)*( (v(i,k,j)+v(i,k,j+1))*0.5* &amp;<a name='5801'>
                     Cd*absU*(defor23(i,kts+1,j)+defor23(i,kts+1,j+1))*0.5 )<a name='5802'>
<a name='5803'>
    END DO<a name='5804'>
    END DO<a name='5805'>
<a name='5806'>
  CASE DEFAULT<a name='5807'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_diffusion_em.F.html#TKE_SHEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_21">( 'isfflx value invalid for diff_opt=2' )<a name='5808'>
  END SELECT vflux<a name='5809'>
<font color=#447700>! end of MARTA/WCS change<a name='5810'></font>
<a name='5811'>
    END SUBROUTINE tke_shear<a name='5812'>
<a name='5813'>
<font color=#447700>!=======================================================================<a name='5814'></font>
<font color=#447700>!=======================================================================<a name='5815'></font>
<a name='5816'>
<A NAME='COMPUTE_DIFF_METRICS'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#COMPUTE_DIFF_METRICS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5817'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>compute_diff_metrics</font>( config_flags, ph, phb, z, rdz, rdzw,  &amp; <A href='../../call_to/COMPUTE_DIFF_METRICS.html' TARGET='index'>1</A><a name='5818'>
                                     zx, zy, rdx, rdy,                     &amp;<a name='5819'>
                                     ids, ide, jds, jde, kds, kde,         &amp;<a name='5820'>
                                     ims, ime, jms, jme, kms, kme,         &amp;<a name='5821'>
                                     its, ite, jts, jte, kts, kte         )<a name='5822'>
<a name='5823'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5824'></font>
<font color=#447700>! Begin declarations.<a name='5825'></font>
<a name='5826'>
    IMPLICIT NONE<a name='5827'>
<a name='5828'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='5829'>
    :: config_flags<a name='5830'>
<a name='5831'>
    INTEGER, INTENT( IN )  &amp;<a name='5832'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='5833'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='5834'>
       its, ite, jts, jte, kts, kte<a name='5835'>
<a name='5836'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='5837'>
    :: ph, phb<a name='5838'>
<a name='5839'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( OUT )  &amp;<a name='5840'>
    :: rdz, rdzw, zx, zy, z<a name='5841'>
<a name='5842'>
<a name='5843'>
    REAL, INTENT( IN )  &amp;<a name='5844'>
    :: rdx, rdy<a name='5845'>
<a name='5846'>
<font color=#447700>! Local variables.<a name='5847'></font>
<a name='5848'>
    REAL, DIMENSION( its-1:ite, kts:kte, jts-1:jte )  &amp;<a name='5849'>
    :: z_at_w<a name='5850'>
<a name='5851'>
    INTEGER  &amp;<a name='5852'>
    :: i, j, k, i_start, i_end, j_start, j_end, ktf<a name='5853'>
<a name='5854'>
<font color=#447700>! End declarations.<a name='5855'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5856'></font>
<a name='5857'>
    ktf = MIN( kte, kde-1 )<a name='5858'>
<a name='5859'>
<font color=#447700>! Bug fix, WCS, 22 april 2002.<a name='5860'></font>
<a name='5861'>
<font color=#447700>! We need rdzw in halo for average to u and v points.<a name='5862'></font>
<a name='5863'>
    j_start = jts-1<a name='5864'>
    j_end   = jte<a name='5865'>
<a name='5866'>
<font color=#447700>! Begin with dz computations.<a name='5867'></font>
<a name='5868'>
    DO j = j_start, j_end<a name='5869'>
<a name='5870'>
      IF ( ( j_start &gt;= jts ) .AND. ( j_end &lt;= MIN( jte, jde-1 ) ) ) THEN<a name='5871'>
        i_start = its-1<a name='5872'>
        i_end   = ite<a name='5873'>
      ELSE<a name='5874'>
        i_start = its<a name='5875'>
        i_end   = MIN( ite, ide-1 )<a name='5876'>
      END IF<a name='5877'>
<a name='5878'>
<font color=#447700>! Compute z at w points for rdz and rdzw computations.  We'll switch z<a name='5879'></font>
<font color=#447700>! to z at p points before returning<a name='5880'></font>
<a name='5881'>
      DO k = 1, kte<a name='5882'>
<a name='5883'>
<font color=#447700>! Bug fix, WCS, 22 april 2002<a name='5884'></font>
<a name='5885'>
      DO i = i_start, i_end<a name='5886'>
        z_at_w(i,k,j) = ( ph(i,k,j) + phb(i,k,j) ) / g<a name='5887'>
      END DO<a name='5888'>
      END DO<a name='5889'>
<a name='5890'>
      DO k = 1, ktf<a name='5891'>
      DO i = i_start, i_end<a name='5892'>
        rdzw(i,k,j) = 1.0 / ( z_at_w(i,k+1,j) - z_at_w(i,k,j) )<a name='5893'>
      END DO<a name='5894'>
      END DO<a name='5895'>
<a name='5896'>
      DO k = 2, ktf<a name='5897'>
      DO i = i_start, i_end<a name='5898'>
        rdz(i,k,j) = 2.0 / ( z_at_w(i,k+1,j) - z_at_w(i,k-1,j) )<a name='5899'>
      END DO<a name='5900'>
      END DO<a name='5901'>
<a name='5902'>
<font color=#447700>! Bug fix, WCS, 22 april 2002; added the following code<a name='5903'></font>
<a name='5904'>
      DO i = i_start, i_end<a name='5905'>
        rdz(i,1,j) = 2./(z_at_w(i,2,j)-z_at_w(i,1,j))<a name='5906'>
      END DO<a name='5907'>
<a name='5908'>
    END DO<a name='5909'>
<a name='5910'>
<font color=#447700>! End bug fix.<a name='5911'></font>
<a name='5912'>
<font color=#447700>! Now compute zx and zy; we'll assume that the halo for ph and phb is<a name='5913'></font>
<font color=#447700>! properly filled.<a name='5914'></font>
<a name='5915'>
    i_start = its<a name='5916'>
    i_end   = MIN( ite, ide-1 )<a name='5917'>
    j_start = jts<a name='5918'>
    j_end   = MIN( jte, jde-1 )<a name='5919'>
<a name='5920'>
    DO j = j_start, j_end<a name='5921'>
    DO k = 1, kte<a name='5922'>
    DO i = MAX( ids+1, its ), i_end<a name='5923'>
      zx(i,k,j) = rdx * ( phb(i,k,j) - phb(i-1,k,j) ) / g<a name='5924'>
    END DO<a name='5925'>
    END DO<a name='5926'>
    END DO<a name='5927'>
<a name='5928'>
    DO j = j_start, j_end<a name='5929'>
    DO k = 1, kte<a name='5930'>
    DO i = MAX( ids+1, its ), i_end<a name='5931'>
      zx(i,k,j) = zx(i,k,j) + rdx * ( ph(i,k,j) - ph(i-1,k,j) ) / g<a name='5932'>
    END DO<a name='5933'>
    END DO<a name='5934'>
    END DO<a name='5935'>
<a name='5936'>
    DO j = MAX( jds+1, jts ), j_end<a name='5937'>
    DO k = 1, kte<a name='5938'>
    DO i = i_start, i_end<a name='5939'>
      zy(i,k,j) = rdy * ( phb(i,k,j) - phb(i,k,j-1) ) / g<a name='5940'>
    END DO<a name='5941'>
    END DO<a name='5942'>
    END DO<a name='5943'>
<a name='5944'>
    DO j = MAX( jds+1, jts ), j_end<a name='5945'>
    DO k = 1, kte<a name='5946'>
    DO i = i_start, i_end<a name='5947'>
      zy(i,k,j) = zy(i,k,j) + rdy * ( ph(i,k,j) - ph(i,k,j-1) ) / g<a name='5948'>
    END DO<a name='5949'>
    END DO<a name='5950'>
    END DO<a name='5951'>
<a name='5952'>
<font color=#447700>! Some b.c. on zx and zy.<a name='5953'></font>
<a name='5954'>
    IF ( .NOT. config_flags%periodic_x ) THEN<a name='5955'>
<a name='5956'>
      IF ( ite == ide ) THEN<a name='5957'>
        DO j = j_start, j_end<a name='5958'>
        DO k = 1, ktf<a name='5959'>
          zx(ide,k,j) = 0.0<a name='5960'>
        END DO<a name='5961'>
        END DO<a name='5962'>
      END IF<a name='5963'>
<a name='5964'>
      IF ( its == ids ) THEN<a name='5965'>
        DO j = j_start, j_end<a name='5966'>
        DO k = 1, ktf<a name='5967'>
          zx(ids,k,j) = 0.0<a name='5968'>
        END DO<a name='5969'>
        END DO<a name='5970'>
      END IF<a name='5971'>
<a name='5972'>
    ELSE<a name='5973'>
<a name='5974'>
      IF ( ite == ide ) THEN<a name='5975'>
        DO j=j_start,j_end<a name='5976'>
        DO k=1,ktf<a name='5977'>
         zx(ide,k,j) = rdx * ( phb(ide,k,j) - phb(ide-1,k,j) ) / g<a name='5978'>
        END DO<a name='5979'>
        END DO<a name='5980'>
<a name='5981'>
        DO j = j_start, j_end<a name='5982'>
        DO k = 1, ktf<a name='5983'>
          zx(ide,k,j) = zx(ide,k,j) + rdx * ( ph(ide,k,j) - ph(ide-1,k,j) ) / g<a name='5984'>
        END DO<a name='5985'>
        END DO<a name='5986'>
      END IF<a name='5987'>
<a name='5988'>
      IF ( its == ids ) THEN<a name='5989'>
        DO j = j_start, j_end<a name='5990'>
        DO k = 1, ktf<a name='5991'>
          zx(ids,k,j) = rdx * ( phb(ids,k,j) - phb(ids-1,k,j) ) / g<a name='5992'>
        END DO<a name='5993'>
        END DO<a name='5994'>
<a name='5995'>
        DO j =j_start,j_end<a name='5996'>
        DO k =1,ktf<a name='5997'>
          zx(ids,k,j) = zx(ids,k,j) + rdx * ( ph(ids,k,j) - ph(ids-1,k,j) ) / g<a name='5998'>
        END DO<a name='5999'>
        END DO<a name='6000'>
      END IF<a name='6001'>
<a name='6002'>
    END IF<a name='6003'>
<a name='6004'>
    IF ( .NOT. config_flags%periodic_y ) THEN<a name='6005'>
<a name='6006'>
      IF ( jte == jde ) THEN<a name='6007'>
        DO k =1, ktf<a name='6008'>
        DO i =i_start, i_end<a name='6009'>
          zy(i,k,jde) = 0.0<a name='6010'>
        END DO<a name='6011'>
        END DO<a name='6012'>
      END IF<a name='6013'>
<a name='6014'>
      IF ( jts == jds ) THEN<a name='6015'>
        DO k =1, ktf<a name='6016'>
        DO i =i_start, i_end<a name='6017'>
          zy(i,k,jds) = 0.0<a name='6018'>
        END DO<a name='6019'>
        END DO<a name='6020'>
      END IF<a name='6021'>
<a name='6022'>
    ELSE<a name='6023'>
<a name='6024'>
      IF ( jte == jde ) THEN<a name='6025'>
        DO k=1, ktf<a name='6026'>
        DO i =i_start, i_end<a name='6027'>
          zy(i,k,jde) = rdy * ( phb(i,k,jde) - phb(i,k,jde-1) ) / g<a name='6028'>
        END DO<a name='6029'>
        END DO<a name='6030'>
<a name='6031'>
        DO k = 1, ktf<a name='6032'>
        DO i =i_start, i_end<a name='6033'>
          zy(i,k,jde) = zy(i,k,jde) + rdy * ( ph(i,k,jde) - ph(i,k,jde-1) ) / g<a name='6034'>
        END DO<a name='6035'>
        END DO<a name='6036'>
      END IF<a name='6037'>
<a name='6038'>
      IF ( jts == jds ) THEN<a name='6039'>
        DO k = 1, ktf<a name='6040'>
        DO i =i_start, i_end<a name='6041'>
          zy(i,k,jds) = rdy * ( phb(i,k,jds) - phb(i,k,jds-1) ) / g<a name='6042'>
        END DO<a name='6043'>
        END DO<a name='6044'>
<a name='6045'>
        DO k = 1, ktf<a name='6046'>
        DO i =i_start, i_end<a name='6047'>
          zy(i,k,jds) = zy(i,k,jds) + rdy * ( ph(i,k,jds) - ph(i,k,jds-1) ) / g<a name='6048'>
        END DO<a name='6049'>
        END DO<a name='6050'>
      END IF<a name='6051'>
<a name='6052'>
    END IF<a name='6053'>
<a name='6054'>
<font color=#447700>! Calculate z at p points.<a name='6055'></font>
<a name='6056'>
    DO j = j_start, j_end<a name='6057'>
      DO k = 1, ktf<a name='6058'>
      DO i = i_start, i_end<a name='6059'>
        z(i,k,j) = 0.5 *  &amp;<a name='6060'>
                   ( ph(i,k,j) + phb(i,k,j) + ph(i,k+1,j) + phb(i,k+1,j) ) / g<a name='6061'>
      END DO<a name='6062'>
      END DO<a name='6063'>
    END DO<a name='6064'>
<a name='6065'>
    END SUBROUTINE compute_diff_metrics<a name='6066'>
<a name='6067'>
<A NAME='CAL_HELICITY'><A href='../../html_code/dyn_em/module_diffusion_em.F.html#CAL_HELICITY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6068'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>cal_helicity</font> ( config_flags, u, v, w, uh, up_heli_max,&amp; <A href='../../call_to/CAL_HELICITY.html' TARGET='index'>1</A><a name='6069'>
                                   ph, phb,                          &amp;<a name='6070'>
                                   msfux, msfuy,                     &amp;<a name='6071'>
                                   msfvx, msfvy,                     &amp;<a name='6072'>
                                   ht,                               &amp;<a name='6073'>
                                   rdx, rdy, dn, dnw, rdz, rdzw,     &amp;<a name='6074'>
                                   fnm, fnp, cf1, cf2, cf3, zx, zy,  &amp;<a name='6075'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='6076'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='6077'>
                                   its, ite, jts, jte, kts, kte      )<a name='6078'>
<a name='6079'>
<font color=#447700>! History:     Apr 2007  Coded by Scott Dembek, USRA, basically using<a name='6080'></font>
<font color=#447700>!                        code segments stolen from the deformation<a name='6081'></font>
<font color=#447700>!                        and divergence subroutine.<a name='6082'></font>
<font color=#447700>!              ...        ...<a name='6083'></font>
<a name='6084'>
<font color=#447700>! Purpose:     This routine calculates updraft helicity.<a name='6085'></font>
<font color=#447700>!              w ( dv/dx - du/dy )<a name='6086'></font>
<a name='6087'>
<font color=#447700>! References:<a name='6088'></font>
<a name='6089'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6090'></font>
<font color=#447700>! Begin declarations.<a name='6091'></font>
<a name='6092'>
    IMPLICIT NONE<a name='6093'>
<a name='6094'>
    TYPE( grid_config_rec_type ), INTENT( IN )  &amp;<a name='6095'>
    :: config_flags<a name='6096'>
<a name='6097'>
    INTEGER, INTENT( IN )  &amp;<a name='6098'>
    :: ids, ide, jds, jde, kds, kde, &amp;<a name='6099'>
       ims, ime, jms, jme, kms, kme, &amp;<a name='6100'>
       its, ite, jts, jte, kts, kte<a name='6101'>
<a name='6102'>
    REAL, INTENT( IN )  &amp;<a name='6103'>
    :: rdx, rdy, cf1, cf2, cf3<a name='6104'>
<a name='6105'>
    REAL, DIMENSION( kms:kme ), INTENT( IN )  &amp;<a name='6106'>
    :: fnm, fnp, dn, dnw<a name='6107'>
<a name='6108'>
    REAL, DIMENSION( ims:ime , jms:jme ),  INTENT( IN )  &amp;<a name='6109'>
    :: msfux, msfuy, msfvx, msfvy, ht<a name='6110'>
<a name='6111'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='6112'>
    ::  u, v, w, ph, phb, zx, zy, rdz, rdzw<a name='6113'>
<a name='6114'>
    REAL, DIMENSION( ims:ime, jms:jme ), INTENT( INOUT )  &amp;<a name='6115'>
    :: uh, up_heli_max<a name='6116'>
<a name='6117'>
<font color=#447700>! Local variables.<a name='6118'></font>
<a name='6119'>
    INTEGER  &amp;<a name='6120'>
    :: i, j, k, ktf, ktes1, ktes2, i_start, i_end, j_start, j_end<a name='6121'>
<a name='6122'>
    REAL  &amp;<a name='6123'>
    :: tmp, tmpzx, tmpzy, tmpzeta_z, cft1, cft2<a name='6124'>
<a name='6125'>
    REAL  &amp;<a name='6126'>
    :: zl, zu, uh_smth<a name='6127'>
<a name='6128'>
    REAL, DIMENSION( its-3:ite+2, jts-3:jte+2 )  :: mm<a name='6129'>
<a name='6130'>
    REAL, DIMENSION( its-3:ite+2, kts:kte, jts-3:jte+2 )  &amp;<a name='6131'>
    :: tmp1, hat, hatavg<a name='6132'>
<a name='6133'>
    REAL, DIMENSION( its-3:ite+2, kts:kte, jts-3:jte+2 )  &amp;<a name='6134'>
    :: wavg, rvort<a name='6135'>
<a name='6136'>
    LOGICAL, DIMENSION( its-3:ite+2, jts-3:jte+2 )  &amp;<a name='6137'>
    :: use_column<a name='6138'>
<a name='6139'>
<font color=#447700>! End declarations.<a name='6140'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6141'></font>
<a name='6142'>
<font color=#447700>!=======================================================================<a name='6143'></font>
<font color=#447700>! In the following section, calculate the vertical component of the<a name='6144'></font>
<font color=#447700>! relative vorticity as the first two terms of the updraft helicity<a name='6145'></font>
<font color=#447700>! w ( dv/dx - du/dy ).<a name='6146'></font>
<a name='6147'>
    ktes1   = kte-1<a name='6148'>
    ktes2   = kte-2<a name='6149'>
<a name='6150'>
    cft2    = - 0.5 * dnw(ktes1) / dn(ktes1)<a name='6151'>
    cft1    = 1.0 - cft2<a name='6152'>
<a name='6153'>
    ktf     = MIN( kte, kde-1 )<a name='6154'>
<a name='6155'>
<font color=#447700>!=======================================================================<a name='6156'></font>
<a name='6157'>
    i_start = its<a name='6158'>
    i_end   = ite<a name='6159'>
    j_start = jts<a name='6160'>
    j_end   = jte<a name='6161'>
<a name='6162'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='6163'>
         config_flags%nested) i_start = MAX( ids+1, its-2 )<a name='6164'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='6165'>
         config_flags%nested) i_end   = MIN( ide-1, ite+2 )<a name='6166'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='6167'>
         config_flags%nested) j_start = MAX( jds+1, jts-2 )<a name='6168'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='6169'>
         config_flags%nested) j_end   = MIN( jde-1, jte+2 )<a name='6170'>
    IF ( config_flags%periodic_x ) i_start = its<a name='6171'>
    IF ( config_flags%periodic_x ) i_end = ite<a name='6172'>
<a name='6173'>
<a name='6174'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6175'></font>
<font color=#447700>! Calculate dv/dx.<a name='6176'></font>
<a name='6177'>
<font color=#447700>! First, calculate an average mapscale factor.<a name='6178'></font>
<a name='6179'>
<font color=#447700>! Comments 10-MAR-05<a name='6180'></font>
<font color=#447700>! du/dy =&gt; need u map scale factor in x (which is defined at u points)<a name='6181'></font>
<font color=#447700>! averaged over j and j-1<a name='6182'></font>
<font color=#447700>! dv/dx =&gt; need v map scale factor in y (which is defined at v points)<a name='6183'></font>
<font color=#447700>! averaged over i and i-1<a name='6184'></font>
<a name='6185'>
    DO j = j_start, j_end<a name='6186'>
    DO i = i_start, i_end<a name='6187'>
      mm(i,j) = 0.25 * ( msfux(i,j-1) + msfux(i,j) ) * ( msfvy(i-1,j) + msfvy(i,j) )<a name='6188'>
    END DO<a name='6189'>
    END DO<a name='6190'>
<a name='6191'>
<font color=#447700>! Apply a coordinate transformation to meridional velocity, v.<a name='6192'></font>
<a name='6193'>
    DO j = j_start, j_end<a name='6194'>
    DO k = kts, ktf<a name='6195'>
    DO i = i_start-1, i_end<a name='6196'>
       hat(i,k,j) = v(i,k,j) / msfvy(i,j)<a name='6197'>
    END DO<a name='6198'>
    END DO<a name='6199'>
    END DO<a name='6200'>
<a name='6201'>
<font color=#447700>! Account for the slope in x of eta surfaces.<a name='6202'></font>
<a name='6203'>
    DO j = j_start, j_end<a name='6204'>
    DO k = kts+1, ktf<a name='6205'>
    DO i = i_start, i_end<a name='6206'>
      hatavg(i,k,j) = 0.5 * (  &amp;<a name='6207'>
                      fnm(k) * ( hat(i-1,k  ,j) + hat(i,k  ,j) ) +  &amp;<a name='6208'>
                      fnp(k) * ( hat(i-1,k-1,j) + hat(i,k-1,j) ) )<a name='6209'>
    END DO<a name='6210'>
    END DO<a name='6211'>
    END DO<a name='6212'>
<a name='6213'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='6214'></font>
<a name='6215'>
    DO j = j_start, j_end<a name='6216'>
    DO i = i_start, i_end<a name='6217'>
       hatavg(i,1,j)   =  0.5 * (  &amp;<a name='6218'>
                          cf1 * hat(i-1,1,j) +  &amp;<a name='6219'>
                          cf2 * hat(i-1,2,j) +  &amp;<a name='6220'>
                          cf3 * hat(i-1,3,j) +  &amp;<a name='6221'>
                          cf1 * hat(i  ,1,j) +  &amp;<a name='6222'>
                          cf2 * hat(i  ,2,j) +  &amp;<a name='6223'>
                          cf3 * hat(i  ,3,j) )<a name='6224'>
       hatavg(i,kte,j) =  0.5 * (  &amp;<a name='6225'>
                          cft1 * ( hat(i,ktes1,j) + hat(i-1,ktes1,j) ) +  &amp;<a name='6226'>
                          cft2 * ( hat(i,ktes2,j) + hat(i-1,ktes2,j) ) )<a name='6227'>
    END DO<a name='6228'>
    END DO<a name='6229'>
<a name='6230'>
    <font color=#447700>! Fixes to set_physical_bc2/3d have made any check for polar B.C.'s<a name='6231'></font>
    <font color=#447700>! unnecessary in this place.  zx, rdzw, and hatavg are all defined<a name='6232'></font>
    <font color=#447700>! in places they need to be and the values at the poles are replications<a name='6233'></font>
    <font color=#447700>! of the values one grid point in, so the averaging over j and j-1 works<a name='6234'></font>
    <font color=#447700>! to act as just using the value at j or j-1 (with out extra code).<a name='6235'></font>
    <font color=#447700>!<a name='6236'></font>
    <font color=#447700>! tmpzx = averaged value of dpsi/dx (=zx) on vorticity grid<a name='6237'></font>
    <font color=#447700>! tmp1  = partial dpsi/dx * partial dv^/dpsi<a name='6238'></font>
    DO j = j_start, j_end<a name='6239'>
    DO k = kts, ktf<a name='6240'>
    DO i = i_start, i_end<a name='6241'>
      tmpzx       = 0.25 * (  &amp;<a name='6242'>
                    zx(i,k  ,j-1) + zx(i,k  ,j) +  &amp;<a name='6243'>
                    zx(i,k+1,j-1) + zx(i,k+1,j) )<a name='6244'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) *  &amp;<a name='6245'>
                    0.25 * tmpzx * ( rdzw(i,k,j) + rdzw(i,k,j-1) + &amp;<a name='6246'>
                                     rdzw(i-1,k,j-1) + rdzw(i-1,k,j) )<a name='6247'>
    END DO<a name='6248'>
    END DO<a name='6249'>
    END DO<a name='6250'>
<a name='6251'>
<font color=#447700>! End calculation of dv/dx.<a name='6252'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6253'></font>
<a name='6254'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6255'></font>
<font color=#447700>! Calculate the first parenthetical term of<a name='6256'></font>
<font color=#447700>! updraft helicity = w ( dv/dx - du/dy ) at vorticity points.<a name='6257'></font>
<a name='6258'>
    DO j = j_start, j_end<a name='6259'>
    DO k = kts, ktf<a name='6260'>
    DO i = i_start, i_end<a name='6261'>
      rvort(i,k,j) = mm(i,j) * (  &amp;<a name='6262'>
                     rdx * ( hat(i,k,j) - hat(i-1,k,j) ) - tmp1(i,k,j) )<a name='6263'>
    END DO<a name='6264'>
    END DO<a name='6265'>
    END DO<a name='6266'>
<a name='6267'>
<font color=#447700>! End calculation of the first parenthetical term of updraft helicity.<a name='6268'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6269'></font>
<a name='6270'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6271'></font>
<font color=#447700>! Calculate du/dy.<a name='6272'></font>
<a name='6273'>
<font color=#447700>! Apply a coordinate transformation to zonal velocity, u.<a name='6274'></font>
<a name='6275'>
    DO j =j_start-1, j_end<a name='6276'>
    DO k =kts, ktf<a name='6277'>
    DO i =i_start, i_end<a name='6278'>
      <font color=#447700>! Fixes to set_physical_bc2/3d for polar boundary conditions<a name='6279'></font>
      <font color=#447700>! remove issues with loop over j<a name='6280'></font>
      hat(i,k,j) = u(i,k,j) / msfux(i,j)<a name='6281'>
    END DO<a name='6282'>
    END DO<a name='6283'>
    END DO<a name='6284'>
<a name='6285'>
<font color=#447700>! Average in y and z.<a name='6286'></font>
<a name='6287'>
    DO j=j_start,j_end<a name='6288'>
    DO k=kts+1,ktf<a name='6289'>
    DO i=i_start,i_end<a name='6290'>
      hatavg(i,k,j) = 0.5 * (  &amp;<a name='6291'>
                      fnm(k) * ( hat(i,k  ,j-1) + hat(i,k  ,j) ) +  &amp;<a name='6292'>
                      fnp(k) * ( hat(i,k-1,j-1) + hat(i,k-1,j) ) )<a name='6293'>
    END DO<a name='6294'>
    END DO<a name='6295'>
    END DO<a name='6296'>
<a name='6297'>
<font color=#447700>! Extrapolate to top and bottom of domain (to w levels).<a name='6298'></font>
<a name='6299'>
    DO j = j_start, j_end<a name='6300'>
    DO i = i_start, i_end<a name='6301'>
      hatavg(i,1,j)   =  0.5 * (  &amp;<a name='6302'>
                         cf1 * hat(i,1,j-1) +  &amp;<a name='6303'>
                         cf2 * hat(i,2,j-1) +  &amp;<a name='6304'>
                         cf3 * hat(i,3,j-1) +  &amp;<a name='6305'>
                         cf1 * hat(i,1,j  ) +  &amp;<a name='6306'>
                         cf2 * hat(i,2,j  ) +  &amp;<a name='6307'>
                         cf3 * hat(i,3,j  ) )<a name='6308'>
      hatavg(i,kte,j) =  0.5 * (  &amp;<a name='6309'>
                         cft1 * ( hat(i,ktes1,j-1) + hat(i,ktes1,j) ) +  &amp;<a name='6310'>
                         cft2 * ( hat(i,ktes2,j-1) + hat(i,ktes2,j) ) )<a name='6311'>
    END DO<a name='6312'>
    END DO<a name='6313'>
<a name='6314'>
    <font color=#447700>! tmpzy = averaged value of dpsi/dy (=zy) on vorticity grid<a name='6315'></font>
    <font color=#447700>! tmp1  = partial dpsi/dy * partial du^/dpsi<a name='6316'></font>
    DO j = j_start, j_end<a name='6317'>
    DO k = kts, ktf<a name='6318'>
    DO i = i_start, i_end<a name='6319'>
      tmpzy       = 0.25 * (  &amp;<a name='6320'>
                    zy(i-1,k  ,j) + zy(i,k  ,j) +  &amp;<a name='6321'>
                    zy(i-1,k+1,j) + zy(i,k+1,j) )<a name='6322'>
      tmp1(i,k,j) = ( hatavg(i,k+1,j) - hatavg(i,k,j) ) *  &amp;<a name='6323'>
                    0.25 * tmpzy * ( rdzw(i,k,j) + rdzw(i-1,k,j) + &amp;<a name='6324'>
                                     rdzw(i-1,k,j-1) + rdzw(i,k,j-1) )<a name='6325'>
    END DO<a name='6326'>
    END DO<a name='6327'>
    END DO<a name='6328'>
<a name='6329'>
<font color=#447700>! End calculation of du/dy.<a name='6330'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='6331'></font>
<a name='6332'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6333'></font>
<font color=#447700>! Add (subtract, actually) the second parenthetical term to<a name='6334'></font>
<font color=#447700>! updraft helicity = w ( dv/dx - du/dy ) at vorticity points.<a name='6335'></font>
<a name='6336'>
    DO j = j_start, j_end<a name='6337'>
    DO k = kts, ktf<a name='6338'>
    DO i = i_start, i_end<a name='6339'>
      rvort(i,k,j) = rvort(i,k,j) -  &amp;<a name='6340'>
                     mm(i,j) * (  &amp;<a name='6341'>
                     rdy * ( hat(i,k,j) - hat(i,k,j-1) ) - tmp1(i,k,j) )<a name='6342'>
    END DO<a name='6343'>
    END DO<a name='6344'>
    END DO<a name='6345'>
<a name='6346'>
<font color=#447700>! End addition of the second parenthetical term to updraft helicity.<a name='6347'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6348'></font>
<a name='6349'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6350'></font>
<font color=#447700>! Update the boundary for the vorticity.<a name='6351'></font>
<a name='6352'>
     IF ( .NOT. config_flags%periodic_x .AND. i_start .EQ. ids+1 ) THEN<a name='6353'>
       DO j = jts, jte<a name='6354'>
       DO k = kts, kte<a name='6355'>
         rvort(ids,k,j) = rvort(ids+1,k,j)<a name='6356'>
       END DO<a name='6357'>
       END DO<a name='6358'>
     END IF<a name='6359'>
<a name='6360'>
     IF ( .NOT. config_flags%periodic_y .AND. j_start .EQ. jds+1) THEN<a name='6361'>
       DO k = kts, kte<a name='6362'>
       DO i = its, ite<a name='6363'>
         rvort(i,k,jds) = rvort(i,k,jds+1)<a name='6364'>
       END DO<a name='6365'>
       END DO<a name='6366'>
     END IF<a name='6367'>
<a name='6368'>
     IF ( .NOT. config_flags%periodic_x .AND. i_end .EQ. ide-1) THEN<a name='6369'>
       DO j = jts, jte<a name='6370'>
       DO k = kts, kte<a name='6371'>
         rvort(ide,k,j) = rvort(ide-1,k,j)<a name='6372'>
       END DO<a name='6373'>
       END DO<a name='6374'>
     END IF<a name='6375'>
<a name='6376'>
     IF ( .NOT. config_flags%periodic_y .AND. j_end .EQ. jde-1) THEN<a name='6377'>
       DO k = kts, kte<a name='6378'>
       DO i = its, ite<a name='6379'>
         rvort(i,k,jde) = rvort(i,k,jde-1)<a name='6380'>
       END DO<a name='6381'>
       END DO<a name='6382'>
     END IF<a name='6383'>
<a name='6384'>
<font color=#447700>! End update of boundary for the vorticity.<a name='6385'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6386'></font>
<a name='6387'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6388'></font>
<font color=#447700>! Calculate an 8-point average of w used to complete the<a name='6389'></font>
<font color=#447700>! calculation of updraft helicity = w ( dv/dx - du/dy ).<a name='6390'></font>
<a name='6391'>
    DO j = j_start, j_end<a name='6392'>
    DO k = kts, ktf<a name='6393'>
    DO i = i_start, i_end<a name='6394'>
      wavg(i,k,j) = 0.125 * (  &amp;<a name='6395'>
                    w(i,k  ,j  ) + w(i-1,k  ,j  ) +  &amp;<a name='6396'>
                    w(i,k  ,j-1) + w(i-1,k  ,j-1) +  &amp;<a name='6397'>
                    w(i,k+1,j  ) + w(i-1,k+1,j  ) +  &amp;<a name='6398'>
                    w(i,k+1,j-1) + w(i-1,k+1,j-1) )<a name='6399'>
    END DO<a name='6400'>
    END DO<a name='6401'>
    END DO<a name='6402'>
<a name='6403'>
<font color=#447700>! End addition of the average w calculation for updraft helicity.<a name='6404'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6405'></font>
<a name='6406'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6407'></font>
<font color=#447700>! Complete the updraft helicity calculation, only including columns with<a name='6408'></font>
<font color=#447700>! positive vertical velocity between the 2000 m and 5000 m levels.<a name='6409'></font>
<a name='6410'>
    DO j = j_start, j_end<a name='6411'>
    DO i = i_start, i_end<a name='6412'>
      use_column(i,j) = .true.<a name='6413'>
      uh(i,j) = 0.<a name='6414'>
    END DO<a name='6415'>
    END DO<a name='6416'>
<a name='6417'>
    <font color=#447700>!  We want zl and zu to be the height above ground, so we subtract<a name='6418'></font>
    <font color=#447700>!  the terrain elevation from the geopotential/g.<a name='6419'></font>
<a name='6420'>
    DO j = j_start, j_end<a name='6421'>
    DO k = kts, ktf<a name='6422'>
    DO i = i_start, i_end<a name='6423'>
      zl = ( 0.25 * (  &amp;<a name='6424'>
           (( ph(i  ,k  ,j  ) + phb(i  ,k  ,j  ) ) / g - ht(i  ,j  ) ) +  &amp;<a name='6425'>
           (( ph(i-1,k  ,j  ) + phb(i-1,k  ,j  ) ) / g - ht(i-1,j  ) ) +  &amp;<a name='6426'>
           (( ph(i  ,k  ,j-1) + phb(i  ,k  ,j-1) ) / g - ht(i  ,j-1) ) +  &amp;<a name='6427'>
           (( ph(i-1,k  ,j-1) + phb(i-1,k  ,j-1) ) / g - ht(i-1,j-1) ) ) )<a name='6428'>
<a name='6429'>
      zu = ( 0.25 * (  &amp;<a name='6430'>
           (( ph(i  ,k+1,j  ) + phb(i  ,k+1,j  ) ) / g - ht(i  ,j  ) ) +  &amp;<a name='6431'>
           (( ph(i-1,k+1,j  ) + phb(i-1,k+1,j  ) ) / g - ht(i-1,j  ) ) +  &amp;<a name='6432'>
           (( ph(i  ,k+1,j-1) + phb(i  ,k+1,j-1) ) / g - ht(i  ,j-1) ) +  &amp;<a name='6433'>
           (( ph(i-1,k+1,j-1) + phb(i-1,k+1,j-1) ) / g - ht(i-1,j-1) ) ) )<a name='6434'>
<a name='6435'>
      IF ( zl .GE. 2000. .AND. zu .LE. 5000. ) THEN<a name='6436'>
        IF ( wavg(i,k,j) .GT. 0. .AND. wavg(i,k+1,j) .GT. 0. ) THEN<a name='6437'>
          uh(i,j) = uh(i,j) + ( ( wavg(i,k,j) * rvort(i,k,j) + &amp;<a name='6438'>
                    wavg(i,k+1,j) * rvort(i,k+1,j) ) * 0.5 ) &amp;<a name='6439'>
                    * ( zu - zl )<a name='6440'>
        ELSE<a name='6441'>
          use_column(i,j) = .false.<a name='6442'>
          uh(i,j) = 0.<a name='6443'>
        ENDIF<a name='6444'>
      ENDIF<a name='6445'>
    END DO<a name='6446'>
    END DO<a name='6447'>
    END DO<a name='6448'>
<a name='6449'>
<font color=#447700>! Apply a smoother<a name='6450'></font>
<a name='6451'>
    DO j = MAX(jds+1,jts),MIN(jde-2,jte)<a name='6452'>
    DO i = MAX(ids+1,its),MIN(ide-2,ite)<a name='6453'>
      uh_smth = 0.25   *   uh(i  ,j  ) + &amp;<a name='6454'>
                0.125  * ( uh(i+1,j  ) + uh(i-1,j  ) + &amp;<a name='6455'>
                           uh(i  ,j+1) + uh(i  ,j-1) ) + &amp;<a name='6456'>
                0.0625 * ( uh(i+1,j+1) + uh(i+1,j-1) + &amp;<a name='6457'>
                           uh(i-1,j+1) + uh(i-1,j-1) )<a name='6458'>
<a name='6459'>
      IF ( use_column(i,j) ) THEN<a name='6460'>
        IF ( uh_smth .GT. up_heli_max(i,j) ) THEN<a name='6461'>
           up_heli_max(i,j) = uh_smth<a name='6462'>
        ENDIF<a name='6463'>
      ENDIF<a name='6464'>
<a name='6465'>
<font color=#447700>!     IF ( up_heli_max(i,j) .GT. 1.0e+3 ) THEN<a name='6466'></font>
<font color=#447700>!       print *,' i,j,up_heli_max = ', i,j,up_heli_max(i,j)<a name='6467'></font>
<font color=#447700>!     ENDIF<a name='6468'></font>
    END DO<a name='6469'>
    END DO<a name='6470'>
<a name='6471'>
<font color=#447700>! End addition of the average w calculation for updraft helicity.<a name='6472'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6473'></font>
<a name='6474'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6475'></font>
<font color=#447700>! Update the boundary for updraft helicity (might need to change later).<a name='6476'></font>
<a name='6477'>
    IF ( .NOT. config_flags%periodic_x .AND. i_start .EQ. ids+1 ) THEN<a name='6478'>
      DO j = jts, jte<a name='6479'>
      DO k = kts, kte<a name='6480'>
<font color=#447700>!        rvort(ids,k,j) = rvort(ids+1,k,j)<a name='6481'></font>
        up_heli_max(ids,j) = up_heli_max(ids+1,j)<a name='6482'>
      END DO<a name='6483'>
      END DO<a name='6484'>
    END IF<a name='6485'>
<a name='6486'>
    IF ( .NOT. config_flags%periodic_y .AND. j_start .EQ. jds+1) THEN<a name='6487'>
      DO k = kts, kte<a name='6488'>
      DO i = its, ite<a name='6489'>
<font color=#447700>!        rvort(i,k,jds) = rvort(i,k,jds+1)<a name='6490'></font>
        up_heli_max(i,jds) = up_heli_max(i,jds+1)<a name='6491'>
      END DO<a name='6492'>
      END DO<a name='6493'>
    END IF<a name='6494'>
<a name='6495'>
    IF ( .NOT. config_flags%periodic_x .AND. i_end .EQ. ide-1) THEN<a name='6496'>
      DO j = jts, jte<a name='6497'>
      DO k = kts, kte<a name='6498'>
<font color=#447700>!        rvort(ide,k,j) = rvort(ide-1,k,j)<a name='6499'></font>
        up_heli_max(ide,j) = up_heli_max(ide-1,j)<a name='6500'>
      END DO<a name='6501'>
      END DO<a name='6502'>
    END IF<a name='6503'>
<a name='6504'>
    IF ( .NOT. config_flags%periodic_y .AND. j_end .EQ. jde-1) THEN<a name='6505'>
      DO k = kts, kte<a name='6506'>
      DO i = its, ite<a name='6507'>
<font color=#447700>!        rvort(i,k,jde) = rvort(i,k,jde-1)<a name='6508'></font>
        up_heli_max(i,jde) = up_heli_max(i,jde-1)<a name='6509'>
      END DO<a name='6510'>
      END DO<a name='6511'>
    END IF<a name='6512'>
<a name='6513'>
<font color=#447700>! End update of boundary for updraft helicity.<a name='6514'></font>
<a name='6515'>
    END SUBROUTINE cal_helicity<a name='6516'>
<a name='6517'>
<font color=#447700>!=======================================================================<a name='6518'></font>
<font color=#447700>!=======================================================================<a name='6519'></font>
<a name='6520'>
    END MODULE module_diffusion_em<a name='6521'>
<a name='6522'>
<font color=#447700>!=======================================================================<a name='6523'></font>
<font color=#447700>!=======================================================================<a name='6524'></font>
</pre></body></html>