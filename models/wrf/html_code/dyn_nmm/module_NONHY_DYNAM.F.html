<HTML> <BODY BGCOLOR=#bbeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!NCEP_MESO:MODEL_LAYER: NONHYDROSTATIC DYNAMICS ROUTINES<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='6'></font>
<font color=#447700>!<a name='7'></font>
#include "<A href='../../html_code/include/nmm_loop_basemacros.h.html'>nmm_loop_basemacros.h</A>"<A NAME="nmm_loop_basemacros.h_1"><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#module_NONHY_DYNAM.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='8'>
#include "<A href='../../html_code/include/nmm_loop_macros.h.html'>nmm_loop_macros.h</A>"<A NAME="nmm_loop_macros.h_2"><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#module_NONHY_DYNAM.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='9'>
<font color=#447700>!<a name='10'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='11'></font>
<font color=#447700>!<a name='12'></font>
<A NAME='MODULE_NONHY_DYNAM'><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#MODULE_NONHY_DYNAM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='13'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_NONHY_DYNAM</font> <A href='../../call_to/MODULE_NONHY_DYNAM.html' TARGET='index'>2</A><a name='14'>
<font color=#447700>!<a name='15'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='16'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#module_NONHY_DYNAM.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_28"><a name='17'>
<font color=#447700>!     USE MODULE_INDX<a name='18'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='19'></font>
<font color=#447700>!<a name='20'></font>
      REAL :: CAPA=R_D/CP,RG=1./G,TRG=2.*R_D/G<a name='21'>
<font color=#447700>!<a name='22'></font>
      CONTAINS<a name='23'>
<font color=#447700>!<a name='24'></font>
<font color=#447700>!***********************************************************************<a name='25'></font>
<A NAME='EPS'><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#EPS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='26'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>EPS</font>(NTSD,DT,HYDRO,DX,DY,FAD                            &amp; <A href='../../call_to/EPS.html' TARGET='index'>1</A><a name='27'>
                    ,AETA1,DETA1,DETA2,PDTOP,PT                               &amp;<a name='28'>
                    ,HBM2,HBM3                                          &amp;<a name='29'>
                    ,PDSL,PDSLO,PINT,RTOP,PETDT,PDWDT                   &amp;<a name='30'>
                    ,DWDT,DWDTMN,DWDTMX                                 &amp;<a name='31'>
                    ,FNS,FEW,FNE,FSE                                    &amp;<a name='32'>
                    ,T,U,V,W,W_TOT,Q,CWM                                      &amp;<a name='33'>
                    ,DEF3D,HDAC,BARO                                    &amp;<a name='34'>
                    ,WP,dwdt_damping_lev                                                 &amp;    <a name='35'>
                    ,IHE,IHW,IVE,IVW                                    &amp;<a name='36'>
                    ,IDS,IDE,JDS,JDE,KDS,KDE                            &amp;<a name='37'>
                    ,IMS,IME,JMS,JME,KMS,KME                            &amp;<a name='38'>
                    ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='39'>
<font color=#447700>!***********************************************************************<a name='40'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='41'></font>
<font color=#447700>!                .      .    .<a name='42'></font>
<font color=#447700>! SUBPROGRAM:    EPS<a name='43'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 9?-??-??<a name='44'></font>
<font color=#447700>!<a name='45'></font>
<font color=#447700>! ABSTRACT:<a name='46'></font>
<font color=#447700>!     EPS COMPUTES THE VERTICAL AND HORIZONTAL ADVECTION OF DZ/DT<a name='47'></font>
<font color=#447700>!<a name='48'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='49'></font>
<font color=#447700>!   9?-??-??  JANJIC     - ORIGINATOR<a name='50'></font>
<font color=#447700>!   00-01-05  BLACK      - DISTRIBUTED MEMORY AND THREADS<a name='51'></font>
<font color=#447700>!   02-02-07  BLACK      - CONVERTED TO WRF STRUCTURE<a name='52'></font>
<font color=#447700>!   04-11-22  BLACK      - THREADED<a name='53'></font>
<font color=#447700>!   05-12-12  BLACK      - CONVERTED FROM IKJ TO IJK<a name='54'></font>
<font color=#447700>!<a name='55'></font>
<font color=#447700>! USAGE: CALL EPS FROM SUBROUTINE SOLVE_RUNSTREAM<a name='56'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='57'></font>
<font color=#447700>!<a name='58'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST:<a name='59'></font>
<font color=#447700>!<a name='60'></font>
<font color=#447700>!   OUTPUT FILES:<a name='61'></font>
<font color=#447700>!     NONE<a name='62'></font>
<font color=#447700>!<a name='63'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='64'></font>
<font color=#447700>!<a name='65'></font>
<font color=#447700>!     UNIQUE: NONE<a name='66'></font>
<font color=#447700>!<a name='67'></font>
<font color=#447700>!     LIBRARY: NONE<a name='68'></font>
<font color=#447700>!<a name='69'></font>
<font color=#447700>! ATTRIBUTES:<a name='70'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='71'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='72'></font>
<font color=#447700>!$$$<a name='73'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='74'></font>
<font color=#447700>!<a name='75'></font>
      IMPLICIT NONE<a name='76'>
<font color=#447700>!-----------------------------------------------------------------------<a name='77'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='78'>
                           ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='79'>
                           ,ITS,ITE,JTS,JTE,KTS,KTE <a name='80'>
<font color=#447700>!<a name='81'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='82'>
<font color=#447700>!<a name='83'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='84'></font>
<font color=#447700>!<a name='85'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='86'>
<font color=#447700>!<a name='87'></font>
      REAL,INTENT(IN) :: DT,DY,PDTOP,PT,WP<a name='88'>
<font color=#447700>! level where starts dwdt damping, read in from namelist<a name='89'></font>
      real,INTENT(IN) :: dwdt_damping_lev<a name='90'>
<font color=#447700>!<a name='91'></font>
      REAL,DIMENSION(KMS:KME-1),INTENT(IN) :: DETA1,DETA2,AETA1<a name='92'>
<font color=#447700>!<a name='93'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DWDTMN,DWDTMX,DX    &amp;<a name='94'>
                                                   ,FAD,HBM2,HBM3       &amp;<a name='95'>
                                                   ,PDSL,PDSLO          &amp;<a name='96'>
                                                   ,HDAC,BARO<a name='97'>
<font color=#447700>!<a name='98'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PETDT,DEF3D<a name='99'>
<font color=#447700>!<a name='100'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: CWM         &amp;<a name='101'>
                                                           ,FEW,FNE     &amp;<a name='102'>
                                                           ,FNS,FSE     &amp;<a name='103'>
                                                           ,Q,RTOP      &amp;<a name='104'>
                                                           ,U,V<a name='105'>
<font color=#447700>!<a name='106'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: DWDT     &amp;<a name='107'>
                                                              ,PDWDT    &amp;<a name='108'>
                                                              ,T<a name='109'>
<font color=#447700>!<a name='110'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: PINT,W<a name='111'>
<font color=#447700>!<a name='112'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(OUT)   :: W_TOT<a name='113'>
<font color=#447700>!<a name='114'></font>
      LOGICAL,INTENT(IN) :: HYDRO<a name='115'>
<font color=#447700>!<a name='116'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='117'></font>
<font color=#447700>!<a name='118'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='119'></font>
<font color=#447700>!<a name='120'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='121'></font>
<font color=#447700>!<a name='122'></font>
      INTEGER,PARAMETER :: NTSHY=2<a name='123'>
<font color=#447700>!<a name='124'></font>
      REAL,PARAMETER :: WGHT=0.35<a name='125'>
      REAL,PARAMETER :: SLPD=1500.<a name='126'>
      REAL,PARAMETER :: PI=3.14159<a name='127'>
<font color=#447700>!<a name='128'></font>
      INTEGER,DIMENSION(KTS:KTE) :: LA<a name='129'>
<font color=#447700>!<a name='130'></font>
      INTEGER :: I,J,K,LMP,LSLTP,L<a name='131'>
<font color=#447700>!<a name='132'></font>
      REAL,DIMENSION(KTS:KTE) :: B1,B2,B3,C0,CWM_K,DWDT_K,Q_K,RDPP      &amp;<a name='133'>
                                ,RTOP_K,T_K,WHY<a name='134'>
<font color=#447700>!<a name='135'></font>
      REAL,DIMENSION(ITS:ITE) :: DPTU_I,PNP1_I,PSTRUP_I<a name='136'>
<font color=#447700>!<a name='137'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: TTB,WEW,WNE,WNS,WSE<a name='138'>
<font color=#447700>!<a name='139'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE) :: B1_IK,B2_IK,B3_IK,C0_IK        &amp;<a name='140'>
                                        ,CWM_IK,DWDT_IK,Q_IK            &amp;<a name='141'>
                                        ,RDPP_IK,RTOP_IK,T_IK<a name='142'>
<font color=#447700>!<a name='143'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE+1) :: CHI_IK,COFF_IK               &amp;<a name='144'>
                                          ,PINT_IK,PSTR_IK,W_IK<a name='145'>
<font color=#447700>!<a name='146'></font>
      REAL :: ADDT,DELP,DETAL,DP,DPDE,DPPL,DPSTR,DPTL,DPTU              &amp;<a name='147'>
             ,DWDTT,EPSN,FCT,FFC,GDT,GDT2                               &amp;<a name='148'>
             ,PNP,PP1,PSTRDN,PSTRUP,RDP,RDPDN,RDPUP,RDT                 &amp;<a name='149'>
             ,TFC,TMP,TTAL,TTFC,HKNE_IJ,HKSE_IJ,ADVEC,ARG,SLTP,PAVG<a name='150'>
<font color=#447700>!<a name='151'></font>
      LOGICAL :: BOT,TOP,DIFFW<a name='152'>
<font color=#447700>!<a name='153'></font>
      CHARACTER(LEN=255) :: message<a name='154'>
<a name='155'>
<font color=#447700>!-----------------------------------------------------------------------<a name='156'></font>
<font color=#447700>!***********************************************************************<a name='157'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='158'></font>
      IF(NTSD&lt;=NTSHY.OR.HYDRO)THEN<a name='159'>
<font color=#447700>!***<a name='160'></font>
        DO J=MYJS_P2,MYJE_P2<a name='161'>
        DO I=MYIS_P1,MYIE_P1<a name='162'>
          PINT(I,J,KTE+1)=PT<a name='163'>
        ENDDO<a name='164'>
        ENDDO<a name='165'>
<font color=#447700>!<a name='166'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='167'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='168'></font>
        DO K=KTS,KTE<a name='169'>
          DO J=MYJS_P2,MYJE_P2<a name='170'>
          DO I=MYIS_P1,MYIE_P1<a name='171'>
            DWDT(I,J,K)=1.<a name='172'>
            PDWDT(I,J,K)=1.<a name='173'>
          ENDDO<a name='174'>
          ENDDO<a name='175'>
        ENDDO<a name='176'>
<font color=#447700>!<a name='177'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='178'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='179'></font>
        DO K=KTE,KTS,-1<a name='180'>
          DO J=MYJS_P2,MYJE_P2<a name='181'>
          DO I=MYIS_P1,MYIE_P1<a name='182'>
            PINT(I,J,K)=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)+PINT(I,J,K+1)<a name='183'>
          ENDDO<a name='184'>
          ENDDO<a name='185'>
        ENDDO<a name='186'>
<font color=#447700>!***<a name='187'></font>
        RETURN<a name='188'>
<font color=#447700>!***<a name='189'></font>
      ENDIF<a name='190'>
<font color=#447700>!-----------------------------------------------------------------------<a name='191'></font>
      ADDT=DT<a name='192'>
      RDT=1./ADDT<a name='193'>
<font color=#447700>!-----------------------------------------------------------------------<a name='194'></font>
<font color=#447700>!<a name='195'></font>
<font color=#447700>!***  TIME TENDENCY<a name='196'></font>
<font color=#447700>!<a name='197'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='198'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='199'></font>
      DO K=KTS,KTE<a name='200'>
        DO J=MYJS_P1,MYJE_P1<a name='201'>
        DO I=MYIS_P1,MYIE_P1<a name='202'>
          DWDT(I,J,K)=(W(I,J,K)-DWDT(I,J,K))*HBM2(I,J)*RDT<a name='203'>
        ENDDO<a name='204'>
        ENDDO<a name='205'>
      ENDDO<a name='206'>
<a name='207'>
<a name='208'>
      IF (DT &gt; 0 .and. WP .ge. 0.001) THEN<a name='209'>
         DIFFW=.TRUE.<a name='210'>
      ELSE<a name='211'>
         DIFFW=.FALSE.<a name='212'>
      ENDIF<a name='213'>
<a name='214'>
      IF(DIFFW) THEN<a name='215'>
<a name='216'>
        DO K=KTS,KTE<a name='217'>
         DO J=MYJS_P1,MYJE1_P1<a name='218'>
          DO I=MYIS_P1,MYIE1_P1<a name='219'>
            HKNE_IJ=(DEF3D(I,J,K)+DEF3D(I+IHE(J),J+1,K))<a name='220'>
            HKSE_IJ=(DEF3D(I+IHE(J),J-1,K)+DEF3D(I,J,K))<a name='221'>
            WNE(I,J)=(W (I+IHE(J),J+1,K)-W (I,J,K))*HKNE_IJ<a name='222'>
            WSE(I,J)=(W (I+IHE(J),J-1,K)-W (I,J,K))*HKSE_IJ<a name='223'>
          ENDDO <a name='224'>
         ENDDO <a name='225'>
<a name='226'>
         DO J=MYJS2,MYJE2<a name='227'>
          DO I=MYIS,MYIE<a name='228'>
              DWDT(I,J,K)= DWDT(I,J,K) - ( WNE (I,J)-WNE (I+IHW(J),J-1) +  &amp;<a name='229'>
                                           WSE (I,J)-WSE (I+IHW(J),J+1) ) * &amp;<a name='230'>
                                           HDAC(I,J)*HBM2(I,J)*RDT <a name='231'>
          ENDDO <a name='232'>
         ENDDO <a name='233'>
        ENDDO<a name='234'>
<a name='235'>
       ENDIF<a name='236'>
<font color=#447700>!<a name='237'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='238'></font>
<font color=#447700>!***<a name='239'></font>
<font color=#447700>!***  VERTICAL ADVECTION<a name='240'></font>
<font color=#447700>!***<a name='241'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='242'></font>
<font color=#447700>!<a name='243'></font>
      DO J=MYJS2,MYJE2<a name='244'>
      DO I=MYIS,MYIE<a name='245'>
        TTB(I,J)=0.<a name='246'>
      ENDDO<a name='247'>
      ENDDO<a name='248'>
<font color=#447700>!<a name='249'></font>
      DO K=KTE,KTS+1,-1<a name='250'>
<font color=#447700>!<a name='251'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='252'></font>
<font color=#447700>!$omp&amp; private(i,j,ttal)<a name='253'></font>
      DO J=MYJS2,MYJE2<a name='254'>
      DO I=MYIS,MYIE<a name='255'>
        TTAL=(W(I,J,K-1)-W(I,J,K))*PETDT(I,J,K-1)*0.5<a name='256'>
        DWDT(I,J,K)=(TTAL+TTB(I,J))                                     &amp;<a name='257'>
                   /(DETA1(K)*PDTOP+DETA2(K)*PDSLO(I,J))                &amp;<a name='258'>
                    +DWDT(I,J,K)<a name='259'>
        TTB(I,J)=TTAL<a name='260'>
      ENDDO<a name='261'>
      ENDDO<a name='262'>
      ENDDO<a name='263'>
<font color=#447700>!<a name='264'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='265'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='266'></font>
      DO J=MYJS2,MYJE2<a name='267'>
      DO I=MYIS1,MYIE1<a name='268'>
        TTB(I,J)=(W(I,J,KTS)-W(I,J,KTS+1))*PETDT(I,J,KTS)*0.5<a name='269'>
        DWDT(I,J,KTS)=TTB(I,J)/(DETA1(KTS)*PDTOP+DETA2(KTS)*PDSLO(I,J)) &amp;<a name='270'>
                     +DWDT(I,J,KTS)<a name='271'>
      ENDDO<a name='272'>
      ENDDO<a name='273'>
<font color=#447700>!-----------------------------------------------------------------------<a name='274'></font>
<font color=#447700>!***<a name='275'></font>
<font color=#447700>!***  END OF VERTICAL ADVECTION<a name='276'></font>
<font color=#447700>!***<a name='277'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='278'></font>
<font color=#447700>!<a name='279'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='280'></font>
<font color=#447700>!***<a name='281'></font>
<font color=#447700>!***  HORIZONTAL ADVECTION<a name='282'></font>
<font color=#447700>!***<a name='283'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='284'></font>
<font color=#447700>!<a name='285'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='286'></font>
<font color=#447700>!$omp&amp; private(dpde,i,j,k)<a name='287'></font>
<font color=#447700>!<a name='288'></font>
      main_horizontal:  DO K=KTS,KTE<a name='289'>
<font color=#447700>!<a name='290'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='291'></font>
<font color=#447700>!***  THE WORKING ARRAYS FOR THE PRIMARY VARIABLES<a name='292'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='293'></font>
<font color=#447700>!<a name='294'></font>
        DO J=MYJS1_P3,MYJE1_P3<a name='295'>
        DO I=MYIS_P3,MYIE_P3<a name='296'>
          WEW(I,J)=FEW(I,J,K)*(W(I+IVE(J),J,K)-W(I+IVW(J),J,K))<a name='297'>
          WNS(I,J)=FNS(I,J,K)*(W(I,J+1,K)-W(I,J-1,K))<a name='298'>
        ENDDO<a name='299'>
        ENDDO<a name='300'>
<font color=#447700>!<a name='301'></font>
<font color=#447700>!***    DIAGONAL FLUXES AND DIAGONALLY AVERAGED WIND<a name='302'></font>
<font color=#447700>!<a name='303'></font>
        DO J=MYJS1_P2,MYJE2_P2<a name='304'>
        DO I=MYIS_P2,MYIE1_P2<a name='305'>
          WNE(I,J)=FNE(I,J,K)*(W(I+IHE(J),J+1,K)-W(I,J,K))<a name='306'>
        ENDDO<a name='307'>
        ENDDO<a name='308'>
<font color=#447700>!<a name='309'></font>
        DO J=MYJS2_P2,MYJE1_P2<a name='310'>
        DO I=MYIS_P2,MYIE1_P2<a name='311'>
          WSE(I,J)=FSE(I,J,K)*(W(I+IHE(J),J-1,K)-W(I,J,K))<a name='312'>
        ENDDO<a name='313'>
        ENDDO<a name='314'>
<font color=#447700>!<a name='315'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='316'></font>
<font color=#447700>!***    ADVECTION OF W<a name='317'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='318'></font>
<font color=#447700>!<a name='319'></font>
        DO J=MYJS3,MYJE3<a name='320'>
        DO I=MYIS2,MYIE2<a name='321'>
          DPDE=DETA1(K)*PDTOP+DETA2(K)*PDSLO(I,J)<a name='322'>
          ADVEC=-(WEW(I+IHW(J),J)      +WEW(I+IHE(J),J)           &amp;<a name='323'>
                       +WNS(I,J-1)           +WNS(I,J+1)                &amp;<a name='324'>
                       +WNE(I+IHW(J),J-1)    +WNE(I,J)                  &amp;<a name='325'>
                       +WSE(I,J)             +WSE(I+IHW(J),J+1))        &amp;<a name='326'>
                       *FAD(I,J)*2.0*HBM3(I,J)/(DPDE*DT)<a name='327'>
          DWDT(I,J,K)= ADVEC + DWDT(I,J,K)<a name='328'>
        ENDDO<a name='329'>
        ENDDO<a name='330'>
<a name='331'>
      ENDDO main_horizontal<a name='332'>
<a name='333'>
<font color=#447700>!-----------------------------------------------------------------------<a name='334'></font>
<font color=#447700>!***<a name='335'></font>
<font color=#447700>!***  END OF HORIZONTAL ADVECTION<a name='336'></font>
<font color=#447700>!***<a name='337'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='338'></font>
<a name='339'>
      IF (WP .ge. 0.001) then<a name='340'>
<a name='341'>
        do l=1,KTE<a name='342'>
          why(l)=-99.<a name='343'>
        enddo<a name='344'>
<font color=#447700>!<a name='345'></font>
        lsltp=0<a name='346'>
        SLTP=(PT+AETA1(KTE-1)*PDTOP+PT+AETA1(KTE)*PDTOP)*0.5<a name='347'>
        DO L=KTE,2,-1<a name='348'>
          PAVG=PT+PDTOP*(AETA1(L)+AETA1(L-1))*0.5<a name='349'>
          ARG=( PAVG-SLTP )/SLPD<a name='350'>
          if(arg.gt.1.) exit<a name='351'>
          why(l)=1.-cos(arg*pi*0.5)**2<a name='352'>
          lsltp=l<a name='353'>
        enddo<a name='354'>
<a name='355'>
<a name='356'>
<font color=#447700>!<a name='357'></font>
      DO l=lsltp,KTE<a name='358'>
       DO J=MYJS2_P1,MYJE2_P1<a name='359'>
        DO I=MYIS1_P1,MYIE1_P1<a name='360'>
            dwdt(i,j,l)=dwdt(i,j,l)*why(l)<a name='361'>
        ENDDO<a name='362'>
       ENDDO<a name='363'>
      ENDDO<a name='364'>
<a name='365'>
<font color=#447700>!-----------------------------------------------------------------------<a name='366'></font>
<font color=#447700>!---taking external mode out--------------------------------------------<a name='367'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='368'></font>
<a name='369'>
       DO J=MYJS2_P1,MYJE2_P1<a name='370'>
        DO I=MYIS1_P1,MYIE1_P1<a name='371'>
          TTB(I,J)=0.<a name='372'>
        ENDDO<a name='373'>
       ENDDO<a name='374'>
<font color=#447700>!<a name='375'></font>
      DO K=KTS,KTE<a name='376'>
       DO J=MYJS2_P1,MYJE2_P1<a name='377'>
        DO I=MYIS1_P1,MYIE1_P1<a name='378'>
            DPDE=DETA1(K)*PDTOP+DETA2(K)*PDSLO(I,J)<a name='379'>
            TTB(I,J)=DPDE*DWDT(I,J,K)+TTB(I,J)<a name='380'>
        ENDDO<a name='381'>
       ENDDO<a name='382'>
      ENDDO<a name='383'>
<font color=#447700>!<a name='384'></font>
       DO J=MYJS2_P1,MYJE2_P1<a name='385'>
        DO I=MYIS1_P1,MYIE1_P1<a name='386'>
          TTB(I,J)=TTB(I,J)/(PDSLO(I,J)+PDTOP)<a name='387'>
        ENDDO<a name='388'>
       ENDDO<a name='389'>
<font color=#447700>!<a name='390'></font>
      DO K=KTS,KTE<a name='391'>
       DO J=MYJS2_P1,MYJE2_P1<a name='392'>
        DO I=MYIS1_P1,MYIE1_P1<a name='393'>
            DWDT(I,J,K)=DWDT(I,J,K)-TTB(I,J)<a name='394'>
        ENDDO<a name='395'>
       ENDDO<a name='396'>
      ENDDO<a name='397'>
     endif<a name='398'>
<a name='399'>
<font color=#447700>!dumping dwdt at stratsphere, Zhan<a name='400'></font>
<a name='401'>
      if ( dwdt_damping_lev .ge. 0.001 ) then<a name='402'>
        lsltp=0<a name='403'>
        SLTP=(PT+AETA1(KTE-1)*PDTOP+PT+AETA1(KTE)*PDTOP)*0.5<a name='404'>
        DO L=KTE,2,-1<a name='405'>
          PAVG=PT+PDTOP*(AETA1(L)+AETA1(L-1))*0.5<a name='406'>
          ARG=( PAVG-SLTP )/dwdt_damping_lev<a name='407'>
          if(arg.gt.1.) exit<a name='408'>
          why(l)=1.-cos(arg*pi*0.5)**2<a name='409'>
          lsltp=l<a name='410'>
        enddo<a name='411'>
<font color=#447700>!<a name='412'></font>
      DO l=lsltp,KTE<a name='413'>
       DO J=MYJS2_P1,MYJE2_P1<a name='414'>
        DO I=MYIS1_P1,MYIE1_P1<a name='415'>
            dwdt(i,j,l)=dwdt(i,j,l)*why(l)<a name='416'>
        ENDDO<a name='417'>
       ENDDO<a name='418'>
      ENDDO<a name='419'>
      endif<a name='420'>
<font color=#447700>!dumping dwdt at stratsphere, Zhan<a name='421'></font>
<a name='422'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='423'></font>
<font color=#447700>!$omp&amp; private(dwdtt,i,j,k)<a name='424'></font>
      DO K=KTS,KTE<a name='425'>
      DO J=MYJS,MYJE<a name='426'>
      DO I=MYIS,MYIE<a name='427'>
        DWDTT=DWDT(I,J,K)<a name='428'>
        DWDTT=MAX(DWDTT,DWDTMN(I,J))<a name='429'>
        DWDTT=MIN(DWDTT,DWDTMX(I,J))<a name='430'>
<font color=#447700>!<a name='431'></font>
        DWDT(I,J,K)=(DWDTT*RG+1.)*(1.-WP)+PDWDT(I,J,K)*WP<a name='432'>
      ENDDO<a name='433'>
      ENDDO<a name='434'>
      ENDDO<a name='435'>
<font color=#447700>!-----------------------------------------------------------------------<a name='436'></font>
<font color=#447700>!---setting dwdt (epsilon at this point) on h points to 1. along bdy ---<a name='437'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='438'></font>
      IF (WP .ge. 0.001) THEN<a name='439'>
<a name='440'>
        do K=KTS,KTE<a name='441'>
          if (JDS .eq. JTS) then<a name='442'>
            do J=jts,jts+1<a name='443'>
              do I=its,ite<a name='444'>
                DWDT(I,J,K)=1.<a name='445'>
              enddo<a name='446'>
            enddo<a name='447'>
          endif<a name='448'>
<font color=#447700>!<a name='449'></font>
          if (JTE .ge. JDE-2) then<a name='450'>
            do j=jte-1,jte<a name='451'>
              do i=its,ite<a name='452'>
                DWDT(I,J,K)=1.<a name='453'>
              enddo<a name='454'>
            enddo<a name='455'>
          endif<a name='456'>
<font color=#447700>!<a name='457'></font>
          if(ITS .eq. IDS)then<a name='458'>
            do j=jts,jte<a name='459'>
              do i=its,its+1<a name='460'>
                DWDT(I,J,K)=1.<a name='461'>
              enddo<a name='462'>
            enddo<a name='463'>
          endif<a name='464'>
<font color=#447700>!<a name='465'></font>
          if(ITE .ge. IDE-2)then<a name='466'>
            do j=jts,jte<a name='467'>
              do i=ite-1,ite<a name='468'>
                DWDT(I,J,K)=1.<a name='469'>
              enddo<a name='470'>
            enddo<a name='471'>
          endif<a name='472'>
        enddo<a name='473'>
<a name='474'>
        ENDIF<a name='475'>
 <a name='476'>
      GDT=G*DT<a name='477'>
      GDT2=GDT*GDT<a name='478'>
      FFC=-R_D/GDT2<a name='479'>
<font color=#447700>!<a name='480'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='481'></font>
<font color=#447700>!<a name='482'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='483'></font>
<font color=#447700>!$omp&amp; private(b1_ik,b2_ik,b3_ik,c0_ik,chi_ik,coff_ik,cwm_ik,           &amp;<a name='484'></font>
<font color=#447700>!$omp&amp;        delp,dppl,dpstr,dptl,dptu_i,dwdt_ik,fct,i,j,k,            &amp;<a name='485'></font>
<font color=#447700>!$omp&amp;        pint_ik,pnp1_i,pp1,pstr_ik,pstrdn,pstrup_i,q_ik,          &amp;<a name='486'></font>
<font color=#447700>!$omp&amp;        rdpdn,rdpup,rtop_ik,t_ik,tfc,tmp,ttfc,w_ik)<a name='487'></font>
<font color=#447700>!<a name='488'></font>
<a name='489'>
<a name='490'>
      final_update:  DO J=MYJS3,MYJE3<a name='491'>
<font color=#447700>!<a name='492'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='493'></font>
<font color=#447700>!***  EXTRACT COLUMNS FROM 3-D ARRAYS<a name='494'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='495'></font>
<font color=#447700>!<a name='496'></font>
        DO K=KTS,KTE<a name='497'>
        DO I=MYIS2,MYIE2<a name='498'>
          CWM_IK(I,K)=CWM(I,J,K)<a name='499'>
          DWDT_IK(I,K)=DWDT(I,J,K)<a name='500'>
          Q_IK(I,K)=Q(I,J,K)<a name='501'>
          RTOP_IK(I,K)=RTOP(I,J,K)<a name='502'>
          T_IK(I,K)=T(I,J,K)<a name='503'>
        ENDDO<a name='504'>
        ENDDO<a name='505'>
<font color=#447700>!<a name='506'></font>
        DO K=KTS,KTE+1<a name='507'>
        DO I=MYIS2,MYIE2<a name='508'>
          PINT_IK(I,K)=PINT(I,J,K)<a name='509'>
          W_IK(I,K)=W(I,J,K)<a name='510'>
        ENDDO<a name='511'>
        ENDDO<a name='512'>
<font color=#447700>!<a name='513'></font>
        DO I=MYIS2,MYIE2<a name='514'>
          PSTR_IK(I,KTE+1)=PT<a name='515'>
        ENDDO<a name='516'>
<font color=#447700>!<a name='517'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='518'></font>
<font color=#447700>!<a name='519'></font>
        DO K=KTE,KTS,-1<a name='520'>
<font color=#447700>!<a name='521'></font>
          IF(K==KTE)THEN<a name='522'>
            DO I=MYIS2,MYIE2<a name='523'>
              DPPL=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='524'>
              RDPP_IK(I,K)=1./DPPL<a name='525'>
              DPSTR=DWDT_IK(I,K)*DPPL<a name='526'>
              PSTR_IK(I,K)=PT+DPSTR<a name='527'>
              PP1=PT+DPSTR<a name='528'>
              PNP1_I(I)=(PP1-PINT_IK(I,K))*WGHT+PINT_IK(I,K)<a name='529'>
              TFC=Q_IK(I,K)*P608+(1.-CWM_IK(I,K))<a name='530'>
              TTFC=-CAPA*TFC+1.<a name='531'>
              COFF_IK(I,K)=T_IK(I,K)*TTFC*TFC*DPPL*FFC                  &amp;<a name='532'>
                          /((PT+PNP1_I(I))*(PT+PNP1_I(I)))<a name='533'>
            ENDDO<a name='534'>
          ELSE<a name='535'>
            DO I=MYIS2,MYIE2<a name='536'>
              DPPL=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='537'>
              RDPP_ik(I,K)=1./DPPL<a name='538'>
              DPSTR=DWDT_IK(I,K)*DPPL<a name='539'>
              PSTR_IK(I,K)=PSTR_IK(I,K+1)+DPSTR<a name='540'>
              PP1=PNP1_I(I)+DPSTR<a name='541'>
              PNP=(PP1-PINT_IK(I,K))*WGHT+PINT_IK(I,K)<a name='542'>
              TFC=Q_IK(I,K)*P608+(1.-CWM_IK(I,K))<a name='543'>
              TTFC=-CAPA*TFC+1.<a name='544'>
              COFF_IK(I,K)=T_IK(I,K)*TTFC*TFC*DPPL*FFC                  &amp;<a name='545'>
                          /((PNP1_I(I)+PNP)*(PNP+PNP1_I(I)))<a name='546'>
              PNP1_I(I)=PNP<a name='547'>
            ENDDO <a name='548'>
          ENDIF<a name='549'>
<font color=#447700>!<a name='550'></font>
        ENDDO<a name='551'>
<font color=#447700>!<a name='552'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='553'></font>
<font color=#447700>!<a name='554'></font>
        DO I=MYIS2,MYIE2<a name='555'>
<font color=#447700>!!BUG!!   PSTRUP_I(I)=-(PSTR_IK(I,KTE)-PINT_IK(I,KTE))*COFF_IK(I,KTE)<a name='556'></font>
          PSTRUP_I(I)=-(PSTR_IK(I,KTE+1)+PSTR_IK(I,KTE)                 &amp;<a name='557'>
                       -PINT_IK(I,KTE+1)-PINT_IK(I,KTE))*COFF_IK(I,KTE)<a name='558'>
        ENDDO<a name='559'>
<font color=#447700>!<a name='560'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='561'></font>
        DO K=KTE-1,KTS,-1<a name='562'>
<font color=#447700>!<a name='563'></font>
          IF(K==KTE-1)THEN<a name='564'>
            DO I=MYIS2,MYIE2<a name='565'>
              RDPDN=RDPP_IK(I,K)<a name='566'>
              RDPUP=RDPP_IK(I,K+1)<a name='567'>
<font color=#447700>!<a name='568'></font>
              PSTRDN=-(PSTR_IK(I,K+1)+PSTR_IK(I,K)                      &amp;<a name='569'>
                      -PINT_IK(I,K+1)-PINT_IK(I,K))                     &amp;<a name='570'>
                      *COFF_IK(I,K)<a name='571'>
<font color=#447700>!<a name='572'></font>
              B1_IK(I,K)=COFF_IK(I,K+1)+RDPUP<a name='573'>
              B2_IK(I,K)=(COFF_IK(I,K+1)+COFF_IK(I,K))-(RDPUP+RDPDN)<a name='574'>
              B3_IK(I,K)=COFF_IK(I,K)+RDPDN<a name='575'>
              C0_IK(I,K)=PSTRUP_I(I)+PSTRDN<a name='576'>
              PSTRUP_I(I)=PSTRDN<a name='577'>
            ENDDO<a name='578'>
          ELSE<a name='579'>
            DO I=MYIS2,MYIE2<a name='580'>
              RDPDN=RDPP_IK(I,K)<a name='581'>
              RDPUP=RDPP_IK(I,K+1)<a name='582'>
<font color=#447700>!<a name='583'></font>
              PSTRDN=-(PSTR_IK(I,K+1)+PSTR_IK(I,K)                      &amp;<a name='584'>
                      -PINT_IK(I,K+1)-PINT_IK(I,K))                     &amp;<a name='585'>
                      *COFF_IK(I,K)<a name='586'>
<font color=#447700>!<a name='587'></font>
              B1_IK(I,K)=COFF_IK(I,K+1)+RDPUP<a name='588'>
              B2_IK(I,K)=(COFF_IK(I,K+1)+COFF_IK(I,K))-(RDPUP+RDPDN)<a name='589'>
              B3_IK(I,K)=COFF_IK(I,K)+RDPDN<a name='590'>
              C0_IK(I,K)=PSTRUP_I(I)+PSTRDN<a name='591'>
              PSTRUP_I(I)=PSTRDN<a name='592'>
            ENDDO<a name='593'>
          ENDIF<a name='594'>
<font color=#447700>!<a name='595'></font>
        ENDDO<a name='596'>
<font color=#447700>!<a name='597'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='598'></font>
<font color=#447700>!***  ELIMINATION<a name='599'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='600'></font>
<font color=#447700>!<a name='601'></font>
        DO K=KTE-2,KTS,-1<a name='602'>
<font color=#447700>!<a name='603'></font>
          IF(K&gt;KTS)THEN<a name='604'>
            DO I=MYIS2,MYIE2<a name='605'>
              TMP=-B1_IK(I,K)/B2_IK(I,K+1)<a name='606'>
              B2_IK(I,K)=B3_IK(I,K+1)*TMP+B2_IK(I,K)<a name='607'>
              C0_IK(I,K)=C0_IK(I,K+1)*TMP+C0_IK(I,K)<a name='608'>
            ENDDO<a name='609'>
          ELSE<a name='610'>
            DO I=MYIS2,MYIE2<a name='611'>
              TMP=-B1_IK(I,K)/B2_IK(I,K+1)<a name='612'>
              B2_IK(I,K)=B3_IK(I,K+1)*TMP                               &amp;<a name='613'>
                       +(B2_IK(I,KTS)+B3_IK(I,KTS))<a name='614'>
              C0_IK(I,K)=C0_IK(I,K+1)*TMP+C0_IK(I,K)<a name='615'>
            ENDDO<a name='616'>
          ENDIF<a name='617'>
<font color=#447700>!<a name='618'></font>
        ENDDO<a name='619'>
<font color=#447700>!<a name='620'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='621'></font>
<font color=#447700>!***  BACK SUBSTITUTION<a name='622'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='623'></font>
<font color=#447700>!<a name='624'></font>
        DO K=KTS+1,KTE<a name='625'>
<font color=#447700>!<a name='626'></font>
          IF(K==KTS+1)THEN<a name='627'>
            DO I=MYIS2,MYIE2<a name='628'>
              CHI_IK(I,K)=C0_IK(I,KTS)/B2_IK(I,KTS)<a name='629'>
              CHI_IK(I,KTS)=CHI_IK(I,K)<a name='630'>
            ENDDO<a name='631'>
          ELSE<a name='632'>
            DO I=MYIS2,MYIE2<a name='633'>
              CHI_IK(I,K)=(-B3_IK(I,K-1)*CHI_IK(I,K-1)+C0_IK(I,K-1))    &amp;<a name='634'>
                          /B2_IK(I,K-1)<a name='635'>
            ENDDO<a name='636'>
          ENDIF<a name='637'>
<font color=#447700>!<a name='638'></font>
        ENDDO<a name='639'>
<font color=#447700>!-----------------------------------------------------------------------<a name='640'></font>
<font color=#447700>!<a name='641'></font>
        FCT=0.5/CP<a name='642'>
<font color=#447700>!<a name='643'></font>
        DO K=KTE,KTS,-1<a name='644'>
<font color=#447700>!<a name='645'></font>
          IF(K==KTE)THEN<a name='646'>
            DO I=MYIS2,MYIE2<a name='647'>
              DPTL=(CHI_IK(I,K)+PSTR_IK(I,K)-PINT_IK(I,K))*HBM3(I,J)<a name='648'>
              PINT_IK(I,K)=PINT_IK(I,K)+DPTL<a name='649'>
              T_IK(I,K)=DPTL*RTOP_IK(I,K)*FCT+T_IK(I,K)<a name='650'>
              DELP=(PINT_IK(I,K)-PINT_IK(I,K+1))*RDPP_IK(I,K)<a name='651'>
              W_IK(I,K)=((DELP-DWDT_IK(I,K))*GDT+W_IK(I,K))*HBM3(I,J)<a name='652'>
              DWDT_IK(I,K)=(DELP-1.)*HBM3(I,J)+1.<a name='653'>
              DPTU_I(I)=DPTL<a name='654'>
            ENDDO<a name='655'>
          ELSE<a name='656'>
            DO I=MYIS2,MYIE2<a name='657'>
              DPTL=(CHI_IK(I,K)+PSTR_IK(I,K)-PINT_IK(I,K))*HBM3(I,J)<a name='658'>
              PINT_IK(I,K)=PINT_IK(I,K)+DPTL<a name='659'>
              T_IK(I,K)=(DPTU_I(I)+DPTL)*RTOP_IK(I,K)*FCT+T_IK(I,K)<a name='660'>
              DELP=(PINT_IK(I,K)-PINT_IK(I,K+1))*RDPP_IK(I,K)<a name='661'>
              W_IK(I,K)=((DELP-DWDT_IK(I,K))*GDT+W_IK(I,K))*HBM3(I,J)<a name='662'>
              DWDT_IK(I,K)=(DELP-1.)*HBM3(I,J)+1.<a name='663'>
              DPTU_I(I)=DPTL<a name='664'>
            ENDDO<a name='665'>
          ENDIF<a name='666'>
<font color=#447700>!<a name='667'></font>
        ENDDO<a name='668'>
<font color=#447700>!<a name='669'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='670'></font>
        DO K=KTS,KTE<a name='671'>
        DO I=MYIS2,MYIE2<a name='672'>
          PINT(I,J,K)=PINT_IK(I,K)<a name='673'>
          T(I,J,K)=T_IK(I,K)<a name='674'>
          W(I,J,K)=W_IK(I,K)<a name='675'>
          DWDT(I,J,K)=DWDT_IK(I,K)<a name='676'>
        ENDDO<a name='677'>
        ENDDO<a name='678'>
<font color=#447700>!-----------------------------------------------------------------------<a name='679'></font>
<font color=#447700>!<a name='680'></font>
      ENDDO final_update<a name='681'>
<font color=#447700>!<a name='682'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='683'></font>
<font color=#447700>!***  DEFINE OUTPUT W FIELD<a name='684'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='685'></font>
<font color=#447700>!<a name='686'></font>
        IF (WP .ge. 0.001) THEN<a name='687'>
            DO K=KTS,KTE+1<a name='688'>
            DO J=MYJS,MYJE<a name='689'>
            DO I=MYIS,MYIE<a name='690'>
               W_TOT(I,J,K)=W(I,J,K)+BARO(I,J)<a name='691'>
            ENDDO<a name='692'>
            ENDDO<a name='693'>
            ENDDO<a name='694'>
        ELSE<a name='695'>
            DO K=KTS,KTE+1<a name='696'>
            DO J=MYJS,MYJE<a name='697'>
            DO I=MYIS,MYIE<a name='698'>
               W_TOT(I,J,K)=W(I,J,K)<a name='699'>
            ENDDO<a name='700'>
            ENDDO<a name='701'>
            ENDDO<a name='702'>
        ENDIF<a name='703'>
<font color=#447700>!<a name='704'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='705'></font>
<font color=#447700>!<a name='706'></font>
      END SUBROUTINE EPS<a name='707'>
<font color=#447700>!<a name='708'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='709'></font>
<font color=#447700>!<a name='710'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='711'></font>
<font color=#447700>!***********************************************************************<a name='712'></font>
<A NAME='VADZ'><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#VADZ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='713'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VADZ</font>(NTSD,DT,FIS,SIGMA,DFL,HBM2                        &amp; <A href='../../call_to/VADZ.html' TARGET='index'>1</A><a name='714'>
                     ,DETA1,DETA2,PDTOP                                 &amp;<a name='715'>
                     ,PINT,PDSL,PDSLO,PETDT                             &amp;<a name='716'>
                     ,RTOP,T,Q,CWM,Z,W,DWDT,PDWDT                       &amp;<a name='717'>
                     ,IHE,IHW,IVE,IVW                                   &amp;<a name='718'>
                     ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='719'>
                     ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='720'>
                     ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='721'>
<font color=#447700>!***********************************************************************<a name='722'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='723'></font>
<font color=#447700>!                .      .    .     <a name='724'></font>
<font color=#447700>! SUBPROGRAM:    VADZ        VERTICAL ADVECTION OF HEIGHT<a name='725'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 93-11-17<a name='726'></font>
<font color=#447700>!     <a name='727'></font>
<font color=#447700>! ABSTRACT:<a name='728'></font>
<font color=#447700>!     VADV CALCULATES THE CONTRIBUTION OF THE VERTICAL ADVECTION<a name='729'></font>
<font color=#447700>!     OF HEIGHT IN ORDER TO COMPUTE W=DZ/DT DIAGNOSTICALLY<a name='730'></font>
<font color=#447700>!     <a name='731'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='732'></font>
<font color=#447700>!   96-05-??  JANJIC     - ORIGINATOR<a name='733'></font>
<font color=#447700>!   00-01-04  BLACK      - DISTRIBUTED MEMORY AND THREADS<a name='734'></font>
<font color=#447700>!   01-03-26  BLACK      - CONVERTED TO WRF STRUCTURE<a name='735'></font>
<font color=#447700>!   02-02-19  BLACK      - CONVERSION UPDATED<a name='736'></font>
<font color=#447700>!   04-11-22  BLACK      - THREADED<a name='737'></font>
<font color=#447700>!   05-12-12  BLACK      - CONVERTED FROM IKJ TO IJK<a name='738'></font>
<font color=#447700>!     <a name='739'></font>
<font color=#447700>! USAGE: CALL VADZ FROM MAIN PROGRAM<a name='740'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='741'></font>
<font color=#447700>!<a name='742'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST:<a name='743'></font>
<font color=#447700>!<a name='744'></font>
<font color=#447700>!   OUTPUT FILES:<a name='745'></font>
<font color=#447700>!     NONE<a name='746'></font>
<font color=#447700>!<a name='747'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='748'></font>
<font color=#447700>!<a name='749'></font>
<font color=#447700>!     UNIQUE: NONE<a name='750'></font>
<font color=#447700>!<a name='751'></font>
<font color=#447700>!     LIBRARY: NONE<a name='752'></font>
<font color=#447700>!<a name='753'></font>
<font color=#447700>! ATTRIBUTES:<a name='754'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='755'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='756'></font>
<font color=#447700>!$$$<a name='757'></font>
<font color=#447700>!***********************************************************************<a name='758'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='759'></font>
<font color=#447700>!<a name='760'></font>
      IMPLICIT NONE<a name='761'>
<font color=#447700>!<a name='762'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='763'></font>
#ifdef  AS_RECEIVED<a name='764'>
      LOGICAL,INTENT(IN) :: SIGMA<a name='765'>
#else<a name='766'>
      INTEGER,INTENT(IN) :: SIGMA<a name='767'>
#endif<a name='768'>
<font color=#447700>!<a name='769'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='770'>
<font color=#447700>!<a name='771'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='772'>
                           ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='773'>
                           ,ITS,ITE,JTS,JTE,KTS,KTE<a name='774'>
<font color=#447700>!<a name='775'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='776'>
<font color=#447700>!<a name='777'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='778'></font>
<font color=#447700>!<a name='779'></font>
      REAL,INTENT(IN) :: DT,PDTOP<a name='780'>
<font color=#447700>!<a name='781'></font>
      REAL,DIMENSION(KTS:KTE),INTENT(IN) :: DETA1,DETA2<a name='782'>
<font color=#447700>!<a name='783'></font>
      REAL,DIMENSION(KTS:KTE+1),INTENT(IN) :: DFL<a name='784'>
<font color=#447700>!<a name='785'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: FIS,HBM2,PDSL,PDSLO<a name='786'>
<font color=#447700>!<a name='787'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PETDT<a name='788'>
<font color=#447700>!<a name='789'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: CWM,Q       &amp;<a name='790'>
                                                           ,RTOP,T<a name='791'>
<font color=#447700>!<a name='792'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(OUT) :: PDWDT<a name='793'>
<font color=#447700>!<a name='794'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: DWDT<a name='795'>
<font color=#447700>!<a name='796'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PINT<a name='797'>
<font color=#447700>!<a name='798'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(OUT) :: W,Z<a name='799'>
<font color=#447700>!-----------------------------------------------------------------------<a name='800'></font>
<font color=#447700>!<a name='801'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='802'></font>
<font color=#447700>!<a name='803'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='804'></font>
      INTEGER :: I,J,K<a name='805'>
<font color=#447700>!<a name='806'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME) :: FNE,FSE,TTB<a name='807'>
<font color=#447700>!<a name='808'></font>
      REAL :: DZ,RDT,TTAL,ZETA<a name='809'>
<font color=#447700>!-----------------------------------------------------------------------<a name='810'></font>
<font color=#447700>!***********************************************************************<a name='811'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='812'></font>
      RDT=1./DT<a name='813'>
<font color=#447700>!<a name='814'></font>
      DO K=KTS,KTE<a name='815'>
        DO J=MYJS,MYJE<a name='816'>
        DO I=MYIS,MYIE<a name='817'>
          PDWDT(I,J,K)=DWDT(I,J,K)<a name='818'>
          DWDT(I,J,K)=W(I,J,K)<a name='819'>
        ENDDO<a name='820'>
        ENDDO<a name='821'>
      ENDDO<a name='822'>
<font color=#447700>!<a name='823'></font>
      DO J=MYJS,MYJE<a name='824'>
      DO I=MYIS,MYIE<a name='825'>
        W(I,J,KTS)=0.<a name='826'>
<font color=#447700>!<a name='827'></font>
#ifdef AS_RECEIVED<a name='828'>
        IF(SIGMA)THEN<a name='829'>
#else<a name='830'>
        IF(SIGMA==1)THEN<a name='831'>
#endif<a name='832'>
          Z(I,J,KTS)=FIS(I,J)*RG<a name='833'>
        ELSE<a name='834'>
          Z(I,J,KTS)=0.<a name='835'>
        ENDIF<a name='836'>
      ENDDO<a name='837'>
      ENDDO<a name='838'>
<font color=#447700>!<a name='839'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='840'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='841'></font>
<font color=#447700>!$omp&amp; private(dz,i,j,k,zeta)<a name='842'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='843'></font>
<font color=#447700>!<a name='844'></font>
      kloop1 : DO K=KTS,KTE<a name='845'>
<font color=#447700>!<a name='846'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='847'></font>
<font color=#447700>!<a name='848'></font>
        DO J=MYJS,MYJE<a name='849'>
        DO I=MYIS,MYIE<a name='850'>
<font color=#447700>!<a name='851'></font>
          ZETA=DFL(K+1)*RG<a name='852'>
          DZ=(Q(I,J,K)*P608-CWM(I,J,K)+1.)*T(I,J,K)                     &amp;<a name='853'>
            /(PINT(I,J,K+1)+PINT(I,J,K))                                &amp;<a name='854'>
            *(DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J))*TRG<a name='855'>
          Z(I,J,K+1)=Z(I,J,K)+DZ<a name='856'>
          W(I,J,K+1)=(DZ-RTOP(I,J,K)                                    &amp;<a name='857'>
                    *(DETA1(K)*PDTOP+DETA2(K)*PDSLO(I,J))*RG)           &amp;<a name='858'>
                    *HBM2(I,J)                                          &amp;<a name='859'>
                    +W(I,J,K)<a name='860'>
<font color=#447700>!<a name='861'></font>
        ENDDO<a name='862'>
        ENDDO<a name='863'>
<font color=#447700>!<a name='864'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='865'></font>
<font color=#447700>!<a name='866'></font>
      ENDDO kloop1<a name='867'>
<font color=#447700>!<a name='868'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='869'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='870'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='871'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='872'></font>
      DO K=KTS,KTE<a name='873'>
<font color=#447700>!<a name='874'></font>
        DO J=MYJS,MYJE<a name='875'>
        DO I=MYIS,MYIE<a name='876'>
          Z(I,J,K)=(Z(I,J,K+1)+Z(I,J,K))*0.5<a name='877'>
          W(I,J,K)=(W(I,J,K+1)+W(I,J,K))*HBM2(I,J)*0.5*RDT<a name='878'>
        ENDDO<a name='879'>
        ENDDO<a name='880'>
<font color=#447700>!<a name='881'></font>
      ENDDO<a name='882'>
<font color=#447700>!-----------------------------------------------------------------------<a name='883'></font>
<font color=#447700>!<a name='884'></font>
      DO J=MYJS,MYJE<a name='885'>
      DO I=MYIS,MYIE<a name='886'>
        TTB(I,J)=0.<a name='887'>
      ENDDO<a name='888'>
      ENDDO<a name='889'>
<font color=#447700>!<a name='890'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='891'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='892'></font>
<font color=#447700>!$omp&amp; private(i,j,k,ttal)<a name='893'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='894'></font>
      DO K=KTE,KTS+1,-1<a name='895'>
        DO J=MYJS2,MYJE2<a name='896'>
        DO I=MYIS1,MYIE1<a name='897'>
          TTAL=(Z(I,J,K-1)-Z(I,J,K))*PETDT(I,J,K-1)*0.5<a name='898'>
          W(I,J,K)=(TTAL+TTB(I,J))/(DETA1(K)*PDTOP+DETA2(K)*PDSLO(I,J)) &amp;<a name='899'>
                  +W(I,J,K)<a name='900'>
          TTB(I,J)=TTAL<a name='901'>
        ENDDO<a name='902'>
        ENDDO<a name='903'>
      ENDDO<a name='904'>
<font color=#447700>!<a name='905'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='906'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='907'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='908'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='909'></font>
      DO J=MYJS2,MYJE2<a name='910'>
      DO I=MYIS1,MYIE1<a name='911'>
        W(I,J,KTS)=TTB(I,J)/(DETA1(KTS)*PDTOP+DETA2(KTS)*PDSLO(I,J))    &amp;<a name='912'>
                  +W(I,J,KTS)<a name='913'>
      ENDDO<a name='914'>
      ENDDO<a name='915'>
<font color=#447700>!-----------------------------------------------------------------------<a name='916'></font>
      END SUBROUTINE VADZ<a name='917'>
<font color=#447700>!-----------------------------------------------------------------------<a name='918'></font>
<font color=#447700>!<a name='919'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='920'></font>
<font color=#447700>!***********************************************************************<a name='921'></font>
<A NAME='HADZ'><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#HADZ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='922'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HADZ</font>(NTSD,DT,HYDRO,HBM2,DETA1,DETA2,PDTOP              &amp; <A href='../../call_to/HADZ.html' TARGET='index'>1</A>,<A href='../../call_from/HADZ.html' TARGET='index'>2</A><a name='923'>
                     ,DX,DY,FAD                                         &amp;<a name='924'>
                     ,FEW,FNS,FNE,FSE                                   &amp;<a name='925'>
                     ,PDSL,U,V,W,Z,WP,BARO                              &amp;<a name='926'>
                     ,IHE,IHW,IVE,IVW                                   &amp;<a name='927'>
                     ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='928'>
                     ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='929'>
                     ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='930'>
<font color=#447700>!***********************************************************************<a name='931'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='932'></font>
<font color=#447700>!                .      .    .     <a name='933'></font>
<font color=#447700>! SUBPROGRAM:    HADZ        HORIZONTAL ADVECTION OF HEIGHT<a name='934'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 96-05-??       <a name='935'></font>
<font color=#447700>!     <a name='936'></font>
<font color=#447700>! ABSTRACT:<a name='937'></font>
<font color=#447700>!     HADZ CALCULATES DIAGNOSTICALLY THE CONTRIBUTION OF<a name='938'></font>
<font color=#447700>!     THE HORIZONTAL ADVECTION OF HEIGHT<a name='939'></font>
<font color=#447700>!     <a name='940'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='941'></font>
<font color=#447700>!   96-05-??  JANJIC     - ORIGINATOR<a name='942'></font>
<font color=#447700>!   00-01-04  BLACK      - DISTRIBUTED MEMORY AND THREADS<a name='943'></font>
<font color=#447700>!   01-03-26  BLACK      - CONVERTED TO WRF STRUCTURE<a name='944'></font>
<font color=#447700>!   04-11-22  BLACK      - THREADED<a name='945'></font>
<font color=#447700>!   05-12-12  BLACK      - CONVERTED FROM IKJ TO IJK<a name='946'></font>
<font color=#447700>!<a name='947'></font>
<font color=#447700>! USAGE: CALL HADZ FROM MAIN PROGRAM<a name='948'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='949'></font>
<font color=#447700>!<a name='950'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST:<a name='951'></font>
<font color=#447700>!     NONE<a name='952'></font>
<font color=#447700>!<a name='953'></font>
<font color=#447700>!   OUTPUT FILES:<a name='954'></font>
<font color=#447700>!<a name='955'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='956'></font>
<font color=#447700>!<a name='957'></font>
<font color=#447700>!     UNIQUE: NONE<a name='958'></font>
<font color=#447700>!<a name='959'></font>
<font color=#447700>!     LIBRARY: NONE<a name='960'></font>
<font color=#447700>!<a name='961'></font>
<font color=#447700>! ATTRIBUTES:<a name='962'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='963'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='964'></font>
<font color=#447700>!$$$<a name='965'></font>
<font color=#447700>!***********************************************************************<a name='966'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='967'></font>
<font color=#447700>!<a name='968'></font>
      IMPLICIT NONE<a name='969'>
<font color=#447700>!<a name='970'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='971'></font>
      LOGICAL,INTENT(IN) :: HYDRO<a name='972'>
<font color=#447700>!<a name='973'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='974'>
<font color=#447700>!<a name='975'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='976'>
                           ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='977'>
                           ,ITS,ITE,JTS,JTE,KTS,KTE<a name='978'>
<font color=#447700>!<a name='979'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='980'>
<font color=#447700>!<a name='981'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='982'></font>
<font color=#447700>!<a name='983'></font>
      REAL,INTENT(IN) :: DT,DY,PDTOP,WP<a name='984'>
<font color=#447700>!<a name='985'></font>
      REAL,DIMENSION(KMS:KME-1),INTENT(IN) :: DETA1,DETA2<a name='986'>
<font color=#447700>!<a name='987'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DX,FAD,HBM2,PDSL<a name='988'>
<a name='989'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: BARO<a name='990'>
<font color=#447700>!<a name='991'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: U,V<a name='992'>
<font color=#447700>!<a name='993'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(OUT) :: FEW,FNE    &amp;<a name='994'>
                                                            ,FNS,FSE<a name='995'>
<font color=#447700>!<a name='996'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: Z<a name='997'>
<font color=#447700>!<a name='998'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: W<a name='999'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1000'></font>
<font color=#447700>!<a name='1001'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1002'></font>
<font color=#447700>!<a name='1003'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1004'></font>
      INTEGER,PARAMETER :: NTSHY=2<a name='1005'>
<font color=#447700>!<a name='1006'></font>
      INTEGER :: I,J,K<a name='1007'>
<font color=#447700>!<a name='1008'></font>
      REAL :: FEWP,FNEP,FNSP,FSEP,UDY,VDX<a name='1009'>
<font color=#447700>!<a name='1010'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: DPDE,UNED,USED         &amp;<a name='1011'>
     &amp;                                          ,ZEW,ZNE,ZNS,ZSE,TTB<a name='1012'>
<font color=#447700>!<a name='1013'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1014'></font>
<font color=#447700>!***********************************************************************<a name='1015'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1016'></font>
      IF(NTSD+1&lt;=NTSHY.OR.HYDRO)THEN<a name='1017'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1018'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1019'></font>
        DO K=KTS,KTE<a name='1020'>
          DO J=MYJS,MYJE<a name='1021'>
          DO I=MYIS,MYIE<a name='1022'>
            W(I,J,K)=0.<a name='1023'>
          ENDDO<a name='1024'>
          ENDDO<a name='1025'>
        ENDDO<a name='1026'>
<font color=#447700>!***<a name='1027'></font>
        RETURN<a name='1028'>
<font color=#447700>!***<a name='1029'></font>
      ENDIF<a name='1030'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1031'></font>
<font color=#447700>!***********************************************************************<a name='1032'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1033'></font>
<font color=#447700>!<a name='1034'></font>
<font color=#447700>!***  FIRST ZERO OUT SOME WORKING ARRAYS<a name='1035'></font>
<font color=#447700>!<a name='1036'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1037'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1038'></font>
      DO J=JTS-5,JTE+5<a name='1039'>
      DO I=ITS-5,ITE+5<a name='1040'>
        ZEW(i,j)=0<a name='1041'>
        ZNE(i,j)=0<a name='1042'>
        ZNS(i,j)=0<a name='1043'>
        ZSE(i,j)=0<a name='1044'>
        TTB(i,j)=0<a name='1045'>
        DPDE(I,J)=0.<a name='1046'>
        UNED(I,J)=0.<a name='1047'>
<A href='../../html_code/share/dfi.F.html#D'></A><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#HADZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_3">D(I,J)=0.<a name='1048'>
      ENDDO<a name='1049'>
      ENDDO<a name='1050'>
<font color=#447700>!<a name='1051'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1052'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1053'></font>
<font color=#447700>!$omp&amp; private(dpde,fewp,fnep,fnsp,fsep,i,j,udy,uned,used,vdx           &amp;<a name='1054'></font>
<font color=#447700>!$omp&amp;        ,zew,zne,zns,zse)<a name='1055'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1056'></font>
<font color=#447700>!<a name='1057'></font>
      main_integration:  DO K=KTS,KTE<a name='1058'>
<font color=#447700>!<a name='1059'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1060'></font>
<font color=#447700>!<a name='1061'></font>
<font color=#447700>!***  MASS FLUXES AND MASS POINT ADVECTION COMPONENTS<a name='1062'></font>
<font color=#447700>!<a name='1063'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1064'></font>
<font color=#447700>!<a name='1065'></font>
        DO J=MYJS_P3,MYJE_P3<a name='1066'>
        DO I=MYIS_P4,MYIE_P4<a name='1067'>
          DPDE(I,J)=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='1068'>
        ENDDO<a name='1069'>
        ENDDO<a name='1070'>
<font color=#447700>!<a name='1071'></font>
        DO J=MYJS1_P3,MYJE1_P3<a name='1072'>
        DO I=MYIS_P3,MYIE_P3<a name='1073'>
          UDY=U(I,J,K)*DY<a name='1074'>
          VDX=V(I,J,K)*DX(I,J)<a name='1075'>
<font color=#447700>!<a name='1076'></font>
          FEWP=UDY*(DPDE(I+IVW(J),J)+DPDE(I+IVE(J),J))<a name='1077'>
          FNSP=VDX*(DPDE(I,J-1)+DPDE(I,J+1))<a name='1078'>
<font color=#447700>!<a name='1079'></font>
          FEW(I,J,K)=FEWP<a name='1080'>
          FNS(I,J,K)=FNSP<a name='1081'>
<font color=#447700>!<a name='1082'></font>
          ZEW(I,J)=FEWP*(Z(I+IVE(J),J,K)-Z(I+IVW(J),J,K))<a name='1083'>
          ZNS(I,J)=FNSP*(Z(I,J+1,K)-Z(I,J-1,K))<a name='1084'>
<font color=#447700>!<a name='1085'></font>
          UNED(I,J)=UDY+VDX<a name='1086'>
<A href='../../html_code/share/dfi.F.html#D'></A><A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#HADZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_4">D(I,J)=UDY-VDX<a name='1087'>
<font color=#447700>!<a name='1088'></font>
        ENDDO<a name='1089'>
        ENDDO<a name='1090'>
<font color=#447700>!<a name='1091'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1092'></font>
<font color=#447700>!<a name='1093'></font>
<font color=#447700>!***  DIAGONAL FLUXES AND DIAGONALLY AVERAGED WIND<a name='1094'></font>
<font color=#447700>!<a name='1095'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1096'></font>
        DO J=MYJS1_P2,MYJE2_P2<a name='1097'>
        DO I=MYIS_P2,MYIE1_P2<a name='1098'>
          FNEP=(UNED(I+IHE(J),J)+UNED(I,J+1))                           &amp;<a name='1099'>
     &amp;        *(DPDE(I,J)+DPDE(I+IHE(J),J+1))<a name='1100'>
          FNE(I,J,K)=FNEP<a name='1101'>
          ZNE(I,J)=FNEP*(Z(I+IHE(J),J+1,K)-Z(I,J,K))<a name='1102'>
        ENDDO<a name='1103'>
        ENDDO<a name='1104'>
<font color=#447700>!<a name='1105'></font>
        DO J=MYJS2_P2,MYJE1_P2<a name='1106'>
        DO I=MYIS_P2,MYIE1_P2<a name='1107'>
          FSEP=(USED(I+IHE(J),J)+USED(I,J-1))                           &amp;<a name='1108'>
     &amp;        *(DPDE(I,J)+DPDE(I+IHE(J),J-1))<a name='1109'>
          FSE(I,J,K)=FSEP<a name='1110'>
          ZSE(I,J)=FSEP*(Z(I+IHE(J),J-1,K)-Z(I,J,K))<a name='1111'>
        ENDDO<a name='1112'>
        ENDDO<a name='1113'>
<font color=#447700>!<a name='1114'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1115'></font>
<font color=#447700>!<a name='1116'></font>
<font color=#447700>!***  ADVECTION OF Z<a name='1117'></font>
<font color=#447700>!<a name='1118'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1119'></font>
<font color=#447700>!<a name='1120'></font>
        DO J=MYJS2_P1,MYJE2_P1<a name='1121'>
        DO I=MYIS1_P1,MYIE1_P1<a name='1122'>
<a name='1123'>
          W(I,J,K)=-(ZEW(I+IHW(J),J)  +ZEW(I+IHE(J),J)                  &amp;<a name='1124'>
                    +ZNS(I,J-1)       +ZNS(I,J+1)                       &amp;<a name='1125'>
                    +ZNE(I+IHW(J),J-1)+ZNE(I,J)                         &amp;<a name='1126'>
                    +ZSE(I,J)         +ZSE(I+IHW(J),J+1))               &amp;<a name='1127'>
                    *FAD(I,J)*2.0*HBM2(I,J)/(DPDE(I,J)*DT)              &amp;<a name='1128'>
                    +W(I,J,K)<a name='1129'>
<a name='1130'>
        ENDDO<a name='1131'>
        ENDDO<a name='1132'>
<a name='1133'>
      ENDDO main_integration<a name='1134'>
<a name='1135'>
      IF (WP .ge. 0.001) then<a name='1136'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1137'></font>
<font color=#447700>!---taking external mode out--------------------------------------------<a name='1138'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1139'></font>
	<a name='1140'>
       DO J=MYJS2_P1,MYJE2_P1<a name='1141'>
        DO I=MYIS1_P1,MYIE1_P1<a name='1142'>
          BARO(I,J)=0.<a name='1143'>
        ENDDO<a name='1144'>
       ENDDO<a name='1145'>
<font color=#447700>!<a name='1146'></font>
      DO K=KTS,KTE<a name='1147'>
       DO J=MYJS2_P1,MYJE2_P1<a name='1148'>
        DO I=MYIS1_P1,MYIE1_P1<a name='1149'>
            DPDE(I,J)=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='1150'>
            BARO(I,J)=(DPDE(I,J))*W(I,J,K)+BARO(I,J)<a name='1151'>
        ENDDO<a name='1152'>
       ENDDO<a name='1153'>
      ENDDO<a name='1154'>
<font color=#447700>!<a name='1155'></font>
       DO J=MYJS2_P1,MYJE2_P1<a name='1156'>
        DO I=MYIS1_P1,MYIE1_P1<a name='1157'>
          BARO(I,J)=BARO(I,J)/(PDSL(I,J)+PDTOP)<a name='1158'>
        ENDDO<a name='1159'>
       ENDDO<a name='1160'>
<font color=#447700>!<a name='1161'></font>
<a name='1162'>
      DO K=KTS,KTE<a name='1163'>
       DO J=MYJS2_P1,MYJE2_P1<a name='1164'>
        DO I=MYIS1_P1,MYIE1_P1<a name='1165'>
            W(I,J,K)=W(I,J,K)-BARO(I,J)<a name='1166'>
        ENDDO<a name='1167'>
       ENDDO<a name='1168'>
      ENDDO<a name='1169'>
 <a name='1170'>
      ENDIF<a name='1171'>
<font color=#447700>!<a name='1172'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1173'></font>
<font color=#447700>!<a name='1174'></font>
      END SUBROUTINE HADZ<a name='1175'>
<font color=#447700>!<a name='1176'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1177'></font>
<font color=#447700>!<a name='1178'></font>
      END MODULE MODULE_NONHY_DYNAM<a name='1179'>
<font color=#447700>!<a name='1180'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1181'></font>
</pre></body></html>