<HTML> <BODY BGCOLOR=#bbeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!NCEP_MESO:MODEL_LAYER: INERTIAL GRAVITY WAVE ADJUSTMENT<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6'></font>
#include "<A href='../../html_code/include/nmm_loop_basemacros.h.html'>nmm_loop_basemacros.h</A>"<A NAME="nmm_loop_basemacros.h_1"><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#module_IGWAVE_ADJUST.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='7'>
#include "<A href='../../html_code/include/nmm_loop_macros.h.html'>nmm_loop_macros.h</A>"<A NAME="nmm_loop_macros.h_2"><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#module_IGWAVE_ADJUST.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='8'>
#define  DATA_CALLS_INCLUDED<a name='9'>
<font color=#447700>!-----------------------------------------------------------------------<a name='10'></font>
<font color=#447700>!<a name='11'></font>
<A NAME='MODULE_IGWAVE_ADJUST'><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#MODULE_IGWAVE_ADJUST' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='12'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_IGWAVE_ADJUST</font> <A href='../../call_to/MODULE_IGWAVE_ADJUST.html' TARGET='index'>2</A><a name='13'>
<font color=#447700>!<a name='14'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='15'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#module_IGWAVE_ADJUST.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_24">, only: R_d, p608<a name='16'>
<font color=#447700>!     USE MODULE_EXCHANGE<a name='17'></font>
      USE <A href='../../html_code/share/module_MPP.F.html#MODULE_MPP'>MODULE_MPP</A><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#module_IGWAVE_ADJUST.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MPP_2">,ONLY: MYPE<a name='18'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>MODULE_WRF_ERROR</A><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#module_IGWAVE_ADJUST.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_9">     <a name='19'>
<font color=#447700>!     USE MODULE_TIMERS  ! this one creates a name conflict at compile time<a name='20'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='21'></font>
<font color=#447700>!***<a name='22'></font>
<font color=#447700>!***  SPECIFY THE NUMBER OF TIMES TO SMOOTH THE VERTICAL VELOCITY<a name='23'></font>
<font color=#447700>!***  AND THE NUMBER OF ROWS FROM THE NORTHERN AND SOUTHERN EDGES<a name='24'></font>
<font color=#447700>!***  OF THE GLOBAL DOMAIN BEYOND WHICH THE SMOOTHING DOES NOT GO<a name='25'></font>
<font color=#447700>!***  FOR SUBROUTINE PDTE<a name='26'></font>
<font color=#447700>!<a name='27'></font>
      INTEGER :: KSMUD=0,LNSDT=7<a name='28'>
<font color=#447700>!<a name='29'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='30'></font>
<font color=#447700>!<a name='31'></font>
      CONTAINS<a name='32'>
<font color=#447700>!<a name='33'></font>
<font color=#447700>!***********************************************************************<a name='34'></font>
<A NAME='PFDHT'><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PFDHT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='35'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>PFDHT</font>(NTSD,LAST_TIME,PT,DETA1,DETA2,PDTOP,RES,FIS      &amp; <A href='../../call_to/PFDHT.html' TARGET='index'>1</A><a name='36'>
     &amp;                ,HYDRO,SIGMA,FIRST,DX,DY                          &amp;<a name='37'>
     &amp;                ,HBM2,VBM2,VBM3                                   &amp;<a name='38'>
     &amp;                ,FDIV,FCP,WPDAR,DFL,CPGFU,CPGFV                   &amp;<a name='39'>
     &amp;                ,PD,PDSL,T,Q,U,V,CWM,OMGALF,PINT,DWDT             &amp;<a name='40'>
     &amp;                ,RTOP,DIV,FEW,FNS,FNE,FSE                         &amp;<a name='41'>
     &amp;                ,IHE,IHW,IVE,IVW                                  &amp;<a name='42'>
     &amp;                ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='43'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='44'>
     &amp;                ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='45'>
<font color=#447700>!***********************************************************************<a name='46'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='47'></font>
<font color=#447700>!                .      .    .<a name='48'></font>
<font color=#447700>! SUBPROGRAM:    PFDHT       DIVERGENCE/HORIZONTAL OMEGA-ALPHA<a name='49'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 93-10-28<a name='50'></font>
<font color=#447700>!<a name='51'></font>
<font color=#447700>! ABSTRACT:<a name='52'></font>
<font color=#447700>!     PFDHT CALCULATES THE PRESSURE GRADIENT FORCE, UPDATES THE<a name='53'></font>
<font color=#447700>!     VELOCITY COMPONENTS DUE TO THE EFFECT OF THE PRESSURE GRADIENT<a name='54'></font>
<font color=#447700>!     AND CORIOILS FORCES, COMPUTES THE DIVERGENCE INCLUDING THE<a name='55'></font>
<font color=#447700>!     MODIFICATION PREVENTING GRAVITY WAVE GRID SEPARATION, AND<a name='56'></font>
<font color=#447700>!     CALCULATES THE HORIZONTAL PART OF THE OMEGA-ALPHA TERM.<a name='57'></font>
<font color=#447700>!     (THE PART PROPORTIONAL TO THE ADVECTION OF MASS ALONG<a name='58'></font>
<font color=#447700>!      COORDINATE SURFACES).<a name='59'></font>
<font color=#447700>!<a name='60'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='61'></font>
<font color=#447700>!   87-06-??  JANJIC     - ORIGINATOR<a name='62'></font>
<font color=#447700>!   95-03-25  BLACK      - CONVERSION FROM 1-D TO 2-D IN HORIZONTAL<a name='63'></font>
<font color=#447700>!   96-03-29  BLACK      - ADDED EXTERNAL EDGE<a name='64'></font>
<font color=#447700>!   98-10-30  BLACK      - MODIFIED FOR DISTRIBUTED MEMORY<a name='65'></font>
<font color=#447700>!   02-02-01  BLACK      - REWRITTEN FOR WRF CODING STANDARDS<a name='66'></font>
<font color=#447700>!   04-02-17  JANJIC     - REMOVED UPDATE OF TEMPERATURE<a name='67'></font>
<font color=#447700>!   04-11-23  BLACK      - THREADED<a name='68'></font>
<font color=#447700>!   05-12-09  BLACK      - CONVERTED FROM IKJ TO IJK<a name='69'></font>
<font color=#447700>!<a name='70'></font>
<font color=#447700>! USAGE: CALL PFDHT FROM MAIN PROGRAM SOLVE_RUNSTREAM<a name='71'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='72'></font>
<font color=#447700>!<a name='73'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST:<a name='74'></font>
<font color=#447700>!<a name='75'></font>
<font color=#447700>!   OUTPUT FILES:<a name='76'></font>
<font color=#447700>!     NONE<a name='77'></font>
<font color=#447700>!<a name='78'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='79'></font>
<font color=#447700>!<a name='80'></font>
<font color=#447700>!     UNIQUE: NONE<a name='81'></font>
<font color=#447700>!<a name='82'></font>
<font color=#447700>!     LIBRARY: NONE<a name='83'></font>
<font color=#447700>!<a name='84'></font>
<font color=#447700>! ATTRIBUTES:<a name='85'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='86'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='87'></font>
<font color=#447700>!$$$  <a name='88'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='89'></font>
<font color=#447700>!***********************************************************************<a name='90'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='91'></font>
      IMPLICIT NONE<a name='92'>
<font color=#447700>!-----------------------------------------------------------------------<a name='93'></font>
      LOGICAL,INTENT(IN) :: FIRST,HYDRO<a name='94'>
      INTEGER,INTENT(IN) :: SIGMA<a name='95'>
<font color=#447700>!<a name='96'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='97'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='98'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='99'>
<font color=#447700>!<a name='100'></font>
      INTEGER, DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='101'>
<font color=#447700>!<a name='102'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='103'>
      LOGICAL,INTENT(IN) :: LAST_TIME<a name='104'>
<font color=#447700>!<a name='105'></font>
      REAL,INTENT(IN) :: CPGFV,DY,PDTOP,PT<a name='106'>
<font color=#447700>!<a name='107'></font>
      REAL,DIMENSION(KMS:KME-1),INTENT(IN) :: DETA1,DETA2<a name='108'>
<font color=#447700>!<a name='109'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: DFL<a name='110'>
<font color=#447700>!<a name='111'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: CPGFU,DX,FCP,FDIV   &amp;<a name='112'>
     &amp;                                             ,PD,FIS,RES,WPDAR    &amp;<a name='113'>
     &amp;                                             ,HBM2,VBM2,VBM3<a name='114'>
<font color=#447700>!<a name='115'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: CWM,DWDT    &amp;<a name='116'>
     &amp;                                                     ,Q,T<a name='117'>
<font color=#447700>!<a name='118'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PINT<a name='119'>
<font color=#447700>!<a name='120'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: DIV      &amp;<a name='121'>
     &amp;                                                        ,OMGALF   &amp;<a name='122'>
     &amp;                                                        ,RTOP,U,V<a name='123'>
<font color=#447700>!<a name='124'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(OUT) :: FEW,FNS    &amp;<a name='125'>
     &amp;                                                      ,FNE,FSE<a name='126'>
<font color=#447700>!<a name='127'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: PDSL<a name='128'>
<font color=#447700>!<a name='129'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='130'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='131'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='132'></font>
<font color=#447700>!<a name='133'></font>
      INTEGER :: I,J,K<a name='134'>
<font color=#447700>!<a name='135'></font>
      REAL :: SLP_STD=101300.0<a name='136'>
<font color=#447700>!<a name='137'></font>
      REAL :: APELP,DFI,DCNEK,DCSEK,DPFNEK,DPFSEK,DPNEK,DPSEK           &amp;<a name='138'>
     &amp;       ,EDIV,FIUP,PRSFRC,PVNEK,PVSEK,RTOPP,VM<a name='139'>
<font color=#447700>!<a name='140'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: ADPDNE,ADPDSE          &amp;<a name='141'>
     &amp;                                          ,ADPDX,ADPDY,APEL       &amp;<a name='142'>
     &amp;                                          ,CNE,CSE,DFDZ,DPDE      &amp;<a name='143'>
     &amp;                                          ,DPFEW,DPFNS            &amp;<a name='144'>
     &amp;                                          ,FILO,FIM,HM            &amp;<a name='145'>
     &amp;                                          ,PCEW,PCNE,PCNS,PCSE    &amp;<a name='146'>
     &amp;                                          ,PCXC,PEW,PNE,PNS       &amp;<a name='147'>
     &amp;                                          ,PPNE,PPSE,PSE          &amp;<a name='148'>
     &amp;                                          ,RDPD,RDPDX,RDPDY       &amp;<a name='149'>
     &amp;                                          ,TEW,TNE,TNS,TSE        &amp;<a name='150'>
     &amp;                                          ,UDY,VDX<a name='151'>
<font color=#447700>!<a name='152'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='153'></font>
<font color=#447700>!***********************************************************************<a name='154'></font>
<font color=#447700>!<a name='155'></font>
<font color=#447700>!                                       <a name='156'></font>
<font color=#447700>!                CSE                          CSE            -------  1<a name='157'></font>
<font color=#447700>!                 *                            *  <a name='158'></font>
<font color=#447700>!                 *                            *    <a name='159'></font>
<font color=#447700>!       *******   *                  *******   *   <a name='160'></font>
<font color=#447700>!      *       *  *                 *       *  *  <a name='161'></font>
<font color=#447700>!   CNE         * *              CNE         * *       <a name='162'></font>
<font color=#447700>!               TEW----------OMGALF----------TEW             -------  0<a name='163'></font>
<font color=#447700>!   CSE         * *              CSE         * *         <a name='164'></font>
<font color=#447700>!      *       *  *                 *       *  *       <a name='165'></font>
<font color=#447700>!       *******   *                  *******   *     <a name='166'></font>
<font color=#447700>!                 *                            *   <a name='167'></font>
<font color=#447700>!                 *                            * <a name='168'></font>
<font color=#447700>!                CNE                          CNE            ------- -1<a name='169'></font>
<font color=#447700>!                                        <a name='170'></font>
<font color=#447700>!<a name='171'></font>
<font color=#447700>!<a name='172'></font>
<font color=#447700>! <a name='173'></font>
<font color=#447700>!***********************************************************************<a name='174'></font>
<font color=#447700>! <a name='175'></font>
<font color=#447700>!                              CSE                           -------  2<a name='176'></font>
<font color=#447700>!                               *<a name='177'></font>
<font color=#447700>!                               *<a name='178'></font>
<font color=#447700>!                               *<a name='179'></font>
<font color=#447700>!                               *<a name='180'></font>
<font color=#447700>!                      CNE*****TNS                           -------  1<a name='181'></font>
<font color=#447700>!                      CSE     | *<a name='182'></font>
<font color=#447700>!                              | *<a name='183'></font>
<font color=#447700>!                              | *<a name='184'></font>
<font color=#447700>!                              | *<a name='185'></font>
<font color=#447700>!                              | CNE<a name='186'></font>
<font color=#447700>!                            OMGALF                          -------  0<a name='187'></font>
<font color=#447700>!                              | CSE<a name='188'></font>
<font color=#447700>!                              | *<a name='189'></font>
<font color=#447700>!                              | *<a name='190'></font>
<font color=#447700>!                              | *<a name='191'></font>
<font color=#447700>!                      CNE     | *<a name='192'></font>
<font color=#447700>!                      CSE*****TNS                           ------- -1<a name='193'></font>
<font color=#447700>!                               *<a name='194'></font>
<font color=#447700>!                               *<a name='195'></font>
<font color=#447700>!                               *<a name='196'></font>
<font color=#447700>!                               *<a name='197'></font>
<font color=#447700>!                              CNE                           ------- -2<a name='198'></font>
<font color=#447700>! <a name='199'></font>
<font color=#447700>!***********************************************************************<a name='200'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='201'></font>
<font color=#447700>!***  PREPARATORY CALCULATIONS<a name='202'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='203'></font>
<font color=#447700>!     call hpm_start('PFDHT')<a name='204'></font>
<font color=#447700>!<a name='205'></font>
<font color=#447700>!$omp parallel do<a name='206'></font>
      DO K=KMS,KME<a name='207'>
        DO J=JMS,JME<a name='208'>
        DO I=IMS,IME<a name='209'>
          OMGALF(I,J,K)=0.<a name='210'>
          DIV(I,J,K)=0.<a name='211'>
        ENDDO<a name='212'>
        ENDDO<a name='213'>
      ENDDO<a name='214'>
<font color=#447700>!<a name='215'></font>
<font color=#447700>!$omp parallel do<a name='216'></font>
      DO J=JMS,JME<a name='217'>
      DO I=IMS,IME<a name='218'>
        PDSL(I,J)=0.<a name='219'>
      ENDDO<a name='220'>
      ENDDO<a name='221'>
<font color=#447700>!<a name='222'></font>
<font color=#447700>!$omp parallel do<a name='223'></font>
      DO J=JTS-5,JTE+5<a name='224'>
      DO I=ITS-5,ITE+5<a name='225'>
        ADPDNE(I,J)=0.<a name='226'>
        ADPDSE(I,J)=0.<a name='227'>
        ADPDX(I,J)=0.<a name='228'>
        ADPDY(I,J)=0.<a name='229'>
        APEL(I,J)=0.<a name='230'>
        CNE (I,J)=0.<a name='231'>
        CSE (I,J)=0.<a name='232'>
        DFDZ(I,J)=0.<a name='233'>
        DPDE(I,J)=0.<a name='234'>
        DPFEW(I,J)=0.<a name='235'>
        DPFNS(I,J)=0.<a name='236'>
        FILO(I,J)=0.<a name='237'>
        FIM (I,J)=0.<a name='238'>
        HM (I,J)=0.<a name='239'>
        PCEW(I,J)=0.<a name='240'>
        PCNE(I,J)=0.<a name='241'>
        PCNS(I,J)=0.<a name='242'>
        PCSE(I,J)=0.<a name='243'>
        PCXC(I,J)=0.<a name='244'>
        PEW (I,J)=0.<a name='245'>
        PNE (I,J)=0.<a name='246'>
        PNS (I,J)=0.<a name='247'>
        PPNE(I,J)=0.<a name='248'>
        PPSE(I,J)=0.<a name='249'>
        PSE (I,J)=0.<a name='250'>
        RDPD(I,J)=0.<a name='251'>
        RDPDX(I,J)=0.<a name='252'>
        RDPDY(I,J)=0.<a name='253'>
        TEW (I,J)=0.<a name='254'>
        TNE (I,J)=0.<a name='255'>
        TNS (I,J)=0.<a name='256'>
        TSE (I,J)=0.<a name='257'>
        UDY (I,J)=0.<a name='258'>
        VDX (I,J)=0.<a name='259'>
      ENDDO<a name='260'>
      ENDDO<a name='261'>
<font color=#447700>!<a name='262'></font>
      IF(SIGMA==1)THEN<a name='263'>
<font color=#447700>!$omp parallel do<a name='264'></font>
        DO J=MYJS_P4,MYJE_P4<a name='265'>
        DO I=MYIS_P4,MYIE_P4<a name='266'>
          FILO(I,J)=FIS(I,J)<a name='267'>
          PDSL(I,J)=PD(I,J)<a name='268'>
        ENDDO<a name='269'>
        ENDDO<a name='270'>
      ELSE<a name='271'>
<font color=#447700>!$omp parallel do<a name='272'></font>
        DO J=MYJS_P4,MYJE_P4<a name='273'>
        DO I=MYIS_P4,MYIE_P4<a name='274'>
          FILO(I,J)=0.0<a name='275'>
          PDSL(I,J)=RES(I,J)*PD(I,J)<a name='276'>
        ENDDO<a name='277'>
        ENDDO<a name='278'>
      ENDIF<a name='279'>
<font color=#447700>!<a name='280'></font>
      PRSFRC=PDTOP/(SLP_STD-PT)<a name='281'>
<font color=#447700>!<a name='282'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='283'></font>
<font color=#447700>!<a name='284'></font>
<font color=#447700>!***  MAIN VERTICAL INTEGRATION LOOP<a name='285'></font>
<font color=#447700>!<a name='286'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='287'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='288'></font>
<font color=#447700>!$omp&amp; private(adpdne,adpdse,adpdx,adpdy,                               &amp;<a name='289'></font>
<font color=#447700>!$omp&amp;         apel,cne,cse,dcnek,dcsek,dfdz,dpde,dpfew,dpfnek,         &amp;<a name='290'></font>
<font color=#447700>!$omp&amp;         dpfns,dpfsek,dpnek,ediv,few,fne,fns,fse,hm,              &amp;<a name='291'></font>
<font color=#447700>!$omp&amp;         pcew,pcne,pcns,pcse,pcxc,pew,pne,pns,ppne,ppse,          &amp;<a name='292'></font>
<font color=#447700>!$omp&amp;         pse,pvnek,pvsek,rdpd,rdpdx,rdpdy,tew,tne,tns,tse,        &amp;<a name='293'></font>
<font color=#447700>!$omp&amp;         udy,vdx,vm)<a name='294'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='295'></font>
<font color=#447700>!<a name='296'></font>
       main_integration : DO K=KTS,KTE<a name='297'>
<font color=#447700>!<a name='298'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='299'></font>
<font color=#447700>!<a name='300'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='301'></font>
<font color=#447700>!***  INTEGRATE THE GEOPOTENTIAL<a name='302'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='303'></font>
<font color=#447700>!<a name='304'></font>
        DO J=MYJS_P4,MYJE_P4<a name='305'>
        DO I=MYIS_P4,MYIE_P4<a name='306'>
<font color=#447700>!<a name='307'></font>
          HM(I,J)=HBM2(I,J)<a name='308'>
<font color=#447700>!<a name='309'></font>
          APELP=(PINT(I,J,K+1)+PINT(I,J,K))*0.5<a name='310'>
          RTOPP=(Q(I,J,K)*P608-CWM(I,J,K)+1.)*T(I,J,K)*R_D/APELP<a name='311'>
          DFI=RTOPP*(DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J))<a name='312'>
<font color=#447700>!<a name='313'></font>
          APEL(I,J)=APELP<a name='314'>
          RTOP(I,J,K)=RTOPP<a name='315'>
          DFDZ(I,J)=RTOPP<a name='316'>
<font color=#447700>!<a name='317'></font>
          FIUP=FILO(I,J)+DFI<a name='318'>
          FIM(I,J)=FILO(I,J)+FIUP<a name='319'>
<font color=#447700>!     if(i==154.and.j==096)then<a name='320'></font>
<font color=#447700>!       write(0,10281)k,q(i,j,k),cwm(i,j,k),t(i,j,k),apelp,pdsl(i,j)<a name='321'></font>
10281   format(' k=',i2,' q=',z8,' cwm=',z8,' t=',z8,' apelp=',z8,' pdsl=',z8)<a name='322'>
<font color=#447700>!     endif<a name='323'></font>
          FILO(I,J)=FIUP<a name='324'>
<font color=#447700>!<a name='325'></font>
        ENDDO<a name='326'>
        ENDDO<a name='327'>
<font color=#447700>!<a name='328'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='329'></font>
<font color=#447700>!<a name='330'></font>
        DO J=MYJS_P4,MYJE_P4<a name='331'>
        DO I=MYIS_P4,MYIE_P4<a name='332'>
          DPDE(I,J)=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='333'>
        ENDDO<a name='334'>
        ENDDO<a name='335'>
<font color=#447700>!<a name='336'></font>
        DO J=MYJS,MYJE<a name='337'>
        DO I=MYIS,MYIE<a name='338'>
          RDPD(I,J)=1./DPDE(I,J)<a name='339'>
        ENDDO<a name='340'>
        ENDDO<a name='341'>
<font color=#447700>!<a name='342'></font>
        DO J=MYJS1_P3,MYJE1_P3<a name='343'>
        DO I=MYIS_P3,MYIE_P3<a name='344'>
          ADPDX(I,J)=DPDE(I+IVW(J),J)+DPDE(I+IVE(J),J)<a name='345'>
          ADPDY(I,J)=DPDE(I,J+1)+DPDE(I,J-1)<a name='346'>
          RDPDX(I,J)=1./ADPDX(I,J)<a name='347'>
          RDPDY(I,J)=1./ADPDY(I,J)<a name='348'>
        ENDDO<a name='349'>
        ENDDO<a name='350'>
<font color=#447700>!<a name='351'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='352'></font>
<font color=#447700>!***  DIAGONAL CONTRIBUTIONS TO PRESSURE GRADIENT FORCE<a name='353'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='354'></font>
<font color=#447700>!<a name='355'></font>
        DO J=MYJS_P3,MYJE1_P3<a name='356'>
        DO I=MYIS_P3,MYIE_P3<a name='357'>
          ADPDNE(I,J)=DPDE(I+IHE(J),J+1)+DPDE(I,J)<a name='358'>
          PNE(I,J)=(FIM (I+IHE(J),J+1)-FIM (I,J))                       &amp;<a name='359'>
     &amp;            *(DWDT(I+IHE(J),J+1,K)+DWDT(I,J,K))<a name='360'>
          PPNE(I,J)=PNE(I,J)*ADPDNE(I,J)<a name='361'>
          CNE(I,J)=(DFDZ(I+IHE(J),J+1)+DFDZ(I,J))*2.                    &amp;<a name='362'>
     &amp;            *(APEL(I+IHE(J),J+1)-APEL(I,J))<a name='363'>
          PCNE(I,J)=CNE(I,J)*ADPDNE(I,J)<a name='364'>
        ENDDO<a name='365'>
        ENDDO<a name='366'>
<font color=#447700>!<a name='367'></font>
        DO J=MYJS1_P3,MYJE_P3<a name='368'>
        DO I=MYIS_P3,MYIE_P3<a name='369'>
          ADPDSE(I,J)=DPDE(I+IHE(J),J-1)+DPDE(I,J)<a name='370'>
          PSE(I,J)=(FIM (I+IHE(J),J-1)-FIM (I,J))                       &amp;<a name='371'>
     &amp;            *(DWDT(I+IHE(J),J-1,K)+DWDT(I,J,K))<a name='372'>
<font color=#447700>!     if(i==154.and.j==096.and.k==kte)then<a name='373'></font>
<font color=#447700>!       write(0,58391)PSE(I,J),FIM(I+IHE(J),J-1),FIM(I,J),DWDT(I+IHE(J),J-1,K),DWDT(I,J,K),ihe(j)<a name='374'></font>
58391   format(' pse=',z8,' fim=',2(1x,z8),' dwdt=',2(1x,z8),' ihe=',i2)<a name='375'>
<font color=#447700>!     endif<a name='376'></font>
          PPSE(I,J)=PSE(I,J)*ADPDSE(I,J)<a name='377'>
          CSE(I,J)=(DFDZ(I+IHE(J),J-1)+DFDZ(I,J))*2.                    &amp;<a name='378'>
     &amp;            *(APEL(I+IHE(J),J-1)-APEL(I,J))<a name='379'>
          PCSE(I,J)=CSE(I,J)*ADPDSE(I,J)<a name='380'>
        ENDDO<a name='381'>
        ENDDO<a name='382'>
<font color=#447700>!<a name='383'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='384'></font>
<font color=#447700>!***  CONTINUITY EQUATION MODIFICATION<a name='385'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='386'></font>
<font color=#447700>!<a name='387'></font>
        DO J=MYJS1_P1,MYJE1_P1<a name='388'>
        DO I=MYIS_P1,MYIE_P1<a name='389'>
<font color=#447700>!     if(i==155.and.j==096.and.k==kte)then<a name='390'></font>
<font color=#447700>!       write(0,72451)PNE(I+IVW(J),J),PNE(I,J-1),PSE(I+IVW(J),J),PSE(I,J+1),ivw(j)<a name='391'></font>
<font color=#447700>!       write(0,72452)CNE(I+IVW(J),J),CNE(I,J-1),CSE(I+IVW(J),J),CSE(I,J+1)<a name='392'></font>
72451   format(' pne=',2(1x,z8),' pse=',2(1x,z8),' ivw=',i2)<a name='393'>
72452   format(' cne=',2(1x,z8),' cse=',2(1x,z8))<a name='394'>
<font color=#447700>!     endif<a name='395'></font>
          PCXC(I,J)=VBM3(I,J)*                                          &amp;<a name='396'>
     &amp;             (PNE(I+IVW(J),J)+CNE(I+IVW(J),J)                     &amp;<a name='397'>
     &amp;             +PSE(I+IVW(J),J)+CSE(I+IVW(J),J)                     &amp;<a name='398'>
     &amp;             -PNE(I,J-1)-CNE(I,J-1)                               &amp;<a name='399'>
     &amp;             -PSE(I,J+1)-CSE(I,J+1))<a name='400'>
        ENDDO<a name='401'>
        ENDDO<a name='402'>
<font color=#447700>!<a name='403'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='404'></font>
<font color=#447700>!<a name='405'></font>
        DO J=MYJS2,MYJE2<a name='406'>
        DO I=MYIS1,MYIE1<a name='407'>
<font color=#447700>!     if(i==155.and.j==095.and.k==kte)then<a name='408'></font>
<font color=#447700>!       write(0,76501)deta1(k),deta2(k),prsfrc,wpdar(i,j),ihe(j),ihw(j)<a name='409'></font>
<font color=#447700>!       write(0,76502)PCXC(I+IHE(J),J),PCXC(I,J+1),PCXC(I+IHW(J),J),PCXC(I,J-1)<a name='410'></font>
76501   format(' deta1=',z8,' deta2=',z8,' prsfrc=',z8,' wpdar=',z8,' ihe=',i2,' ihw=',i2)<a name='411'>
76502   format(' pcxc=',4(1x,z8))<a name='412'>
<font color=#447700>!     endif<a name='413'></font>
          DIV(I,J,K)=(DETA1(K)*PRSFRC                                   &amp;   <a name='414'>
     &amp;               +DETA2(K)*(1.-PRSFRC))*WPDAR(I,J)                  &amp;<a name='415'>
     &amp;              *(PCXC(I+IHE(J),J)-PCXC(I,J+1)                      &amp;<a name='416'>
     &amp;               +PCXC(I+IHW(J),J)-PCXC(I,J-1))<a name='417'>
        ENDDO<a name='418'>
        ENDDO<a name='419'>
<font color=#447700>!<a name='420'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='421'></font>
<font color=#447700>!***  LATITUDINAL AND LONGITUDINAL PRESSURE FORCE COMPONENTS<a name='422'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='423'></font>
<font color=#447700>!<a name='424'></font>
        DO J=MYJS1_P2,MYJE1_P2<a name='425'>
        DO I=MYIS_P2,MYIE_P3<a name='426'>
          DPNEK=PNE(I+IVW(J),J)+PNE(I,J-1)<a name='427'>
          DPSEK=PSE(I+IVW(J),J)+PSE(I,J+1)<a name='428'>
          PEW(I,J)=DPNEK+DPSEK<a name='429'>
          PNS(I,J)=DPNEK-DPSEK<a name='430'>
          DCNEK=CNE(I+IVW(J),J)+CNE(I,J-1)<a name='431'>
          DCSEK=CSE(I+IVW(J),J)+CSE(I,J+1)<a name='432'>
          PCEW(I,J)=(DCNEK+DCSEK)*ADPDX(I,J)<a name='433'>
          PCNS(I,J)=(DCNEK-DCSEK)*ADPDY(I,J)<a name='434'>
        ENDDO<a name='435'>
        ENDDO<a name='436'>
<font color=#447700>!<a name='437'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='438'></font>
<font color=#447700>!<a name='439'></font>
        IF(.NOT.FIRST)THEN     <font color=#447700>! Skip at timestep 0<a name='440'></font>
<font color=#447700>!<a name='441'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='442'></font>
<font color=#447700>!***  UPDATE U AND V FOR PRESSURE GRADIENT FORCE<a name='443'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='444'></font>
<font color=#447700>!<a name='445'></font>
          DO J=MYJS2_P2,MYJE2_P2<a name='446'>
          DO I=MYIS_P2,MYIE1_P2<a name='447'>
            DPFNEK=((PPNE(I+IVW(J),J)+PPNE(I,J-1))                      &amp;<a name='448'>
     &amp;             +(PCNE(I+IVW(J),J)+PCNE(I,J-1)))<a name='449'>
            DPFNEK=DPFNEK+DPFNEK<a name='450'>
            DPFSEK=((PPSE(I+IVW(J),J)+PPSE(I,J+1))                      &amp;<a name='451'>
     &amp;             +(PCSE(I+IVW(J),J)+PCSE(I,J+1)))<a name='452'>
            DPFSEK=DPFSEK+DPFSEK<a name='453'>
            DPFEW(I,J)=DPFNEK+DPFSEK<a name='454'>
            DPFNS(I,J)=DPFNEK-DPFSEK<a name='455'>
          ENDDO<a name='456'>
          ENDDO<a name='457'>
<font color=#447700>!<a name='458'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='459'></font>
<font color=#447700>!<a name='460'></font>
          DO J=MYJS2_P3,MYJE2_P3<a name='461'>
          DO I=MYIS_P2,MYIE1_P2<a name='462'>
            VM=VBM2(I,J)<a name='463'>
            U(I,J,K)=(((DPFEW(I,J)+PCEW(I,J))*RDPDX(I,J)                &amp;<a name='464'>
     &amp;                 +PEW(I,J))*CPGFU(I,J))*VM+U(I,J,K)<a name='465'>
            V(I,J,K)=(((DPFNS(I,J)+PCNS(I,J))*RDPDY(I,J)                &amp;<a name='466'>
     &amp;                 +PNS(I,J))*CPGFV)*VM+V(I,J,K)<a name='467'>
          ENDDO<a name='468'>
          ENDDO<a name='469'>
<font color=#447700>!<a name='470'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='471'></font>
<font color=#447700>!<a name='472'></font>
        ENDIF    <font color=#447700>!End of IF block executed for FIRST equal to .FALSE.<a name='473'></font>
<font color=#447700>!<a name='474'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='475'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='476'></font>
<font color=#447700>!<a name='477'></font>
        IF(.NOT.LAST_TIME)THEN    <font color=#447700>!Do not execute block at last timestep<a name='478'></font>
<font color=#447700>!<a name='479'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='480'></font>
<font color=#447700>!***  LATITUDINAL AND LONGITUDINAL FLUXES AND OMEGA-ALPHA COMPONENTS<a name='481'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='482'></font>
<font color=#447700>!<a name='483'></font>
          DO J=MYJS1_P2,MYJE1_P2<a name='484'>
          DO I=MYIS_P2,MYIE_P3<a name='485'>
            UDY(I,J)=DY*U(I,J,K)<a name='486'>
            FEW(I,J,K)=UDY(I,J)*ADPDX(I,J)<a name='487'>
            TEW(I,J)=UDY(I,J)*PCEW(I,J)<a name='488'>
            VDX(I,J)=DX(I,J)*V(I,J,K)<a name='489'>
<font color=#447700>!     if(i==178.and.j==003.and.k==53)then<a name='490'></font>
<font color=#447700>!       write(0,77601)udy(i,j),dy,u(i,j,k)<a name='491'></font>
77601   format(' udy=',z8,' dy=',z8,' u=',z8)<a name='492'>
<font color=#447700>!     endif<a name='493'></font>
            FNS(I,J,K)=VDX(I,J)*ADPDY(I,J)<a name='494'>
            TNS(I,J)=VDX(I,J)*PCNS(I,J)<a name='495'>
          ENDDO<a name='496'>
          ENDDO<a name='497'>
<font color=#447700>!<a name='498'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='499'></font>
<font color=#447700>!***  DIAGONAL FLUXES AND DIAGONALLY AVERAGED WIND<a name='500'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='501'></font>
<font color=#447700>!<a name='502'></font>
          DO J=MYJS1_P1,MYJE2_P1<a name='503'>
          DO I=MYIS_P1,MYIE1_P1<a name='504'>
            PVNEK=(UDY(I+IHE(J),J)+VDX(I+IHE(J),J))                     &amp;<a name='505'>
     &amp;           +(UDY(I,J+1)+VDX(I,J+1))<a name='506'>
            FNE(I,J,K)=PVNEK*ADPDNE(I,J)<a name='507'>
<font color=#447700>!     if(i==178.and.j==003.and.k==53)then<a name='508'></font>
<font color=#447700>!       write(0,33781)fne(i,j,k),dpde(i+ihe(j),j+1),dpde(i,j),ihe(j)<a name='509'></font>
<font color=#447700>!       write(0,33782)udy(i+ihe(j),j),udy(i,j+1),vdx(i+ihe(j),j),vdx(i,j+1)<a name='510'></font>
33781   format(' fne=',z8,' dpdne=',2(1x,z8),' ihe=',i2)<a name='511'>
33782   format(' udy=',2(1x,z8),' vdx=',2(1x,z8))<a name='512'>
<font color=#447700>!     endif<a name='513'></font>
            TNE(I,J)=PVNEK*PCNE(I,J)*2.<a name='514'>
          ENDDO<a name='515'>
          ENDDO<a name='516'>
<font color=#447700>!<a name='517'></font>
          DO J=MYJS2_P1,MYJE1_P1<a name='518'>
          DO I=MYIS_P1,MYIE1_P1<a name='519'>
            PVSEK=(UDY(I+IHE(J),J)-VDX(I+IHE(J),J))                     &amp;<a name='520'>
     &amp;           +(UDY(I,J-1)-VDX(I,J-1))<a name='521'>
            FSE(I,J,K)=PVSEK*ADPDSE(I,J)<a name='522'>
            TSE(I,J)=PVSEK*PCSE(I,J)*2.<a name='523'>
          ENDDO<a name='524'>
          ENDDO<a name='525'>
<font color=#447700>!<a name='526'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='527'></font>
<font color=#447700>!***  HORIZONTAL PART OF OMEGA-ALPHA &amp; DIVERGENCE<a name='528'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='529'></font>
<font color=#447700>!<a name='530'></font>
          DO J=MYJS2,MYJE2<a name='531'>
          DO I=MYIS1,MYIE1<a name='532'>
            OMGALF(I,J,K)=(TEW(I+IHE(J),J)+TEW(I+IHW(J),J)              &amp;<a name='533'>
     &amp;                    +TNS(I,J+1)     +TNS(I,J-1)                   &amp;<a name='534'>
     &amp;                    +TNE(I,J)       +TNE(I+IHW(J),J-1)            &amp;<a name='535'>
     &amp;                    +TSE(I,J)       +TSE(I+IHW(J),J+1))           &amp;<a name='536'>
     &amp;                    *RDPD(I,J)*FCP(I,J)*HM(I,J)<a name='537'>
<font color=#447700>! <a name='538'></font>
<font color=#447700>!     if(i==178.and.j==003.and.k==53)then<a name='539'></font>
<font color=#447700>!       write(0,36311)div(i,j,k),fdiv(i,j),ihe(j),ihw(j)<a name='540'></font>
<font color=#447700>!       write(0,36312)FEW(I+IHE(J),J,K),FEW(I+IHW(J),J,K),FNS(I,J+1,K),FNS(I,J-1,K)<a name='541'></font>
<font color=#447700>!       write(0,36313)FNE(I,J,K),FNE(I+IHW(J),J-1,K),FSE(I,J,K),FSE(I+IHW(J),J+1,K)<a name='542'></font>
36311   format(' PFDHT div=',z8,' fdiv=',z8,' ihe=',i2,' ihw=',i2)<a name='543'>
36312   format(' few=',2(1x,z8),' fns=',2(1x,z8))<a name='544'>
36313   format(' fne=',2(1x,z8),' fse=',2(1x,z8))<a name='545'>
<font color=#447700>!     endif<a name='546'></font>
            EDIV=(FEW(I+IHE(J),J,K)  +FNS(I,J+1,K)                      &amp;<a name='547'>
                 +FNE(I,J,K)         +FSE(I,J,K)                        &amp;<a name='548'>
                -(FEW(I+IHW(J),J,K)  +FNS(I,J-1,K)                      &amp;<a name='549'>
                 +FNE(I+IHW(J),J-1,K)+FSE(I+IHW(J),J+1,K)))*FDIV(I,J)<a name='550'>
<font color=#447700>!<a name='551'></font>
            DIV(I,J,K)=(EDIV+DIV(I,J,K))*HM(I,J)<a name='552'>
          ENDDO<a name='553'>
          ENDDO<a name='554'>
<font color=#447700>!<a name='555'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='556'></font>
<font color=#447700>!<a name='557'></font>
        ENDIF   <font color=#447700>!End block to skip execution at last timestep<a name='558'></font>
<font color=#447700>!<a name='559'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='560'></font>
<font color=#447700>!<a name='561'></font>
      ENDDO main_integration<a name='562'>
<font color=#447700>!<a name='563'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='564'></font>
<font color=#447700>!     call hpm_stop('PFDHT')<a name='565'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='566'></font>
<font color=#447700>!<a name='567'></font>
      END SUBROUTINE PFDHT<a name='568'>
<font color=#447700>!<a name='569'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='570'></font>
<font color=#447700>!***********************************************************************<a name='571'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='572'></font>
<A NAME='PDTE'><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PDTE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='573'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>PDTE</font>(                                                  &amp; <A href='../../call_to/PDTE.html' TARGET='index'>1</A>,<A href='../../call_from/PDTE.html' TARGET='index'>5</A><a name='574'>
#ifdef DM_PARALLEL<a name='575'>
     &amp;                GRID,MYPE,MPI_COMM_COMP,                          &amp;<a name='576'>
#endif<a name='577'>
     &amp;                NTSD,DT,PT,ETA2,RES,HYDRO,HBM2                    &amp;<a name='578'>
     &amp;               ,PD,PDSL,PDSLO                                     &amp;<a name='579'>
     &amp;               ,PETDT,DIV,PSDT                                    &amp;<a name='580'>
     &amp;               ,IHE,IHW,IVE,IVW                                   &amp;                 <a name='581'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='582'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='583'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='584'>
<font color=#447700>!***********************************************************************<a name='585'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='586'></font>
<font color=#447700>!                .      .    .     <a name='587'></font>
<font color=#447700>! SUBPROGRAM:    PDTE        SURFACE PRESSURE TENDENCY CALC<a name='588'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP2      DATE: 96-07-??      <a name='589'></font>
<font color=#447700>!     <a name='590'></font>
<font color=#447700>! ABSTRACT:<a name='591'></font>
<font color=#447700>!     PDTE VERTICALLY INTEGRATES THE MASS FLUX DIVERGENCE TO<a name='592'></font>
<font color=#447700>!     OBTAIN THE SURFACE PRESSURE TENDENCY AND VERTICAL VELOCITY ON<a name='593'></font>
<font color=#447700>!     THE LAYER INTERFACES.  THEN IT UPDATES THE HYDROSTATIC SURFACE<a name='594'></font>
<font color=#447700>!     PRESSURE AND THE NONHYDROSTATIC PRESSURE.<a name='595'></font>
<font color=#447700>!     <a name='596'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='597'></font>
<font color=#447700>!   87-06-??  JANJIC     - ORIGINATOR<a name='598'></font>
<font color=#447700>!   95-03-25  BLACK      - CONVERSION FROM 1-D TO 2-D IN HORIZONTAL<a name='599'></font>
<font color=#447700>!   96-05-??  JANJIC     - ADDED NONHYDROSTATIC EFFECTS &amp; MERGED THE<a name='600'></font>
<font color=#447700>!                          PREVIOUS SUBROUTINES PDTE &amp; PDNEW<a name='601'></font>
<font color=#447700>!   00-01-03  BLACK      - DISTRIBUTED MEMORY AND THREADS<a name='602'></font>
<font color=#447700>!   01-02-23  BLACK      - CONVERTED TO WRF FORMAT<a name='603'></font>
<font color=#447700>!   01-04-11  BLACK      - REWRITTEN FOR WRF CODING STANDARDS<a name='604'></font>
<font color=#447700>!   04-02-17  JANJIC     - MOVED UPDATE OF T DUE TO OMEGA-ALPHA TERM<a name='605'></font>
<font color=#447700>!                          AND UPDATE OF PINT TO NEW ROUTINE VTOA<a name='606'></font>
<font color=#447700>!   04-11-23  BLACK      - THREADED<a name='607'></font>
<font color=#447700>!   05-12-09  BLACK      - CONVERTED FROM IKJ TO IJK<a name='608'></font>
<font color=#447700>!     <a name='609'></font>
<font color=#447700>! USAGE: CALL PDTE FROM SUBROUTINE SOLVE_RUNSTREAM<a name='610'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='611'></font>
<font color=#447700>!  <a name='612'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST: <a name='613'></font>
<font color=#447700>!     <a name='614'></font>
<font color=#447700>!   OUTPUT FILES:<a name='615'></font>
<font color=#447700>!     NONE<a name='616'></font>
<font color=#447700>!     <a name='617'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='618'></font>
<font color=#447700>!  <a name='619'></font>
<font color=#447700>!     UNIQUE: NONE<a name='620'></font>
<font color=#447700>!  <a name='621'></font>
<font color=#447700>!     LIBRARY: NONE<a name='622'></font>
<font color=#447700>!  <a name='623'></font>
<font color=#447700>! ATTRIBUTES:<a name='624'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='625'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='626'></font>
<font color=#447700>!$$$  <a name='627'></font>
<font color=#447700>!***********************************************************************<a name='628'></font>
#ifdef DM_PARALLEL<a name='629'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PDTE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_36">, ONLY: DOMAIN<a name='630'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>MODULE_DM</A><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PDTE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_27">,                    ONLY : LOCAL_COMMUNICATOR       &amp;<a name='631'>
                                              ,MYTASK,NTASKS,NTASKS_X   &amp;<a name='632'>
                                              ,NTASKS_Y                 &amp;<a name='633'>
                                              ,wrf_dm_sum_real          &amp;<a name='634'>
                                              ,wrf_dm_sum_integer          <a name='635'>
      USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>MODULE_COMM_DM</A><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PDTE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_13">, only: HALO_NMM_E_sub<a name='636'>
#endif<a name='637'>
<font color=#447700>!-----------------------------------------------------------------------<a name='638'></font>
      IMPLICIT NONE<a name='639'>
<font color=#447700>!-----------------------------------------------------------------------<a name='640'></font>
#ifdef DM_PARALLEL<a name='641'>
      TYPE (DOMAIN) :: GRID<a name='642'>
      INTEGER,INTENT(IN) :: MYPE,MPI_COMM_COMP<a name='643'>
#endif<a name='644'>
<font color=#447700>!-----------------------------------------------------------------------<a name='645'></font>
      LOGICAL,INTENT(IN) :: HYDRO<a name='646'>
<font color=#447700>!<a name='647'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='648'>
                           ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='649'>
                           ,ITS,ITE,JTS,JTE,KTS,KTE<a name='650'>
<font color=#447700>!<a name='651'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='652'>
<font color=#447700>!<a name='653'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='654'>
<font color=#447700>!<a name='655'></font>
      REAL,INTENT(IN) :: DT,PT<a name='656'>
<font color=#447700>!<a name='657'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: ETA2<a name='658'>
<font color=#447700>!<a name='659'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: RES,HBM2   <a name='660'>
<font color=#447700>!<a name='661'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: DIV<a name='662'>
<font color=#447700>!<a name='663'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: PD,PDSL<a name='664'>
<font color=#447700>!<a name='665'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: PETDT<a name='666'>
<font color=#447700>!<a name='667'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: PDSLO,PSDT<a name='668'>
<font color=#447700>!<a name='669'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='670'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='671'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='672'></font>
<font color=#447700>!<a name='673'></font>
      INTEGER :: I,IHH,IHL,IX,J,JHH,JHL,JX,K,KS,NSMUD<a name='674'>
      INTEGER :: MY_IS_GLB,MY_IE_GLB,MY_JS_GLB,MY_JE_GLB<a name='675'>
      INTEGER :: LOC_NPTS, GLB_NPTS<a name='676'>
#ifdef DM_PARALLEL<a name='677'>
      INTEGER :: IPS,IPE,JPS,JPE,KPS,KPE,IRET<a name='678'>
#endif<a name='679'>
<font color=#447700>!#ifdef DEREF_KLUDGE<a name='680'></font>
<font color=#447700>!! SEE http://www.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='681'></font>
<font color=#447700>!      INTEGER :: SM31,EM31,SM32,EM32,SM33,EM33<a name='682'></font>
<font color=#447700>!      INTEGER :: SM31X,EM31X,SM32X,EM32X,SM33X,EM33X<a name='683'></font>
<font color=#447700>!      INTEGER :: SM31Y,EM31Y,SM32Y,EM32Y,SM33Y,EM33Y<a name='684'></font>
<font color=#447700>!#endif<a name='685'></font>
<font color=#447700>!<a name='686'></font>
      REAL :: PETDTL, TASK_CHANGE, GLOBAL_CHANGE, GLOBAL_CHANGE_WRF<a name='687'>
<font color=#447700>!<a name='688'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: HBMS,PNE,PRET,PSE<a name='689'>
<font color=#447700>!<a name='690'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='691'></font>
<font color=#447700>!***********************************************************************<a name='692'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='693'></font>
<font color=#447700>!#include "deref_kludge.h"<a name='694'></font>
<font color=#447700>!<a name='695'></font>
      DO J=JMS,JME<a name='696'>
      DO I=IMS,IME<a name='697'>
        PDSLO(I,J)=0.<a name='698'>
      ENDDO<a name='699'>
      ENDDO<a name='700'>
<font color=#447700>!<a name='701'></font>
      MY_IS_GLB=ITS<a name='702'>
      MY_IE_GLB=ITE<a name='703'>
      MY_JS_GLB=JTS<a name='704'>
      MY_JE_GLB=JTE<a name='705'>
<font color=#447700>!<a name='706'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='707'></font>
<font color=#447700>!***  VERTICALLY INTEGRATE THE HORIZONTAL DIVERGENCE<a name='708'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='709'></font>
<font color=#447700>!<a name='710'></font>
<a name='711'>
      LOC_NPTS=0<a name='712'>
<a name='713'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='714'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='715'></font>
      DO K=KTE-1,KTS,-1<a name='716'>
        DO J=MYJS_P2,MYJE_P2<a name='717'>
        DO I=MYIS_P2,MYIE_P2<a name='718'>
          DIV(I,J,K)=DIV(I,J,K+1)+DIV(I,J,K)<a name='719'>
        if (K .eq. KTS) then<a name='720'>
         LOC_NPTS=LOC_NPTS+1<a name='721'>
        endif<a name='722'>
<a name='723'>
        ENDDO<a name='724'>
        ENDDO<a name='725'>
      ENDDO<a name='726'>
<a name='727'>
#ifdef DM_PARALLEL<a name='728'>
      GLB_NPTS=<A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_INTEGER'>wrf_dm_sum_integer</A><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PDTE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_SUM_INTEGER_1">(LOC_NPTS)<a name='729'>
#else<a name='730'>
      GLB_NPTS=LOC_NPTS<a name='731'>
#endif<a name='732'>
<a name='733'>
<font color=#447700>!<a name='734'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='735'></font>
<font color=#447700>!***  COMPUTATION OF PRESSURE TENDENCY<a name='736'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='737'></font>
<font color=#447700>!<a name='738'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='739'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='740'></font>
      DO J=MYJS_P2,MYJE_P2<a name='741'>
      DO I=MYIS_P2,MYIE_P2<a name='742'>
        PSDT(I,J)=-DIV(I,J,KTS)<a name='743'>
        PDSLO(I,J)=PDSL(I,J)<a name='744'>
      ENDDO<a name='745'>
      ENDDO<a name='746'>
<font color=#447700>!-----------------------------------------------------------------------<a name='747'></font>
      DO J=JMS,JME<a name='748'>
      DO I=IMS,IME<a name='749'>
        PDSL(I,J)=0.<a name='750'>
      ENDDO<a name='751'>
      ENDDO<a name='752'>
<font color=#447700>!<a name='753'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='754'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='755'></font>
<a name='756'>
      TASK_CHANGE=0.<a name='757'>
<a name='758'>
      DO J=MYJS_P2,MYJE_P2<a name='759'>
      DO I=MYIS_P2,MYIE_P2<a name='760'>
        PD(I,J)=PSDT(I,J)*DT+PD(I,J)<a name='761'>
        PRET(I,J)=PSDT(I,J)*RES(I,J)<a name='762'>
        PDSL(I,J)=PD(I,J)*RES(I,J)<a name='763'>
        TASK_CHANGE=TASK_CHANGE+abs(PSDT(I,J)*108./DT)  <font color=#447700>! .01*10800/dt (hPa/3 h)<a name='764'></font>
      ENDDO<a name='765'>
      ENDDO<a name='766'>
<a name='767'>
#ifdef DM_PARALLEL<a name='768'>
      GLOBAL_CHANGE_WRF=<A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_REAL'>wrf_dm_sum_real</A><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PDTE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_SUM_REAL_1">(TASK_CHANGE)/GLB_NPTS<a name='769'>
#else<a name='770'>
      GLOBAL_CHANGE_WRF=TASK_CHANGE/GLB_NPTS<a name='771'>
#endif<a name='772'>
<a name='773'>
      grid%avgPchg=global_change_wrf<a name='774'>
<a name='775'>
<font color=#447700>! NOTE: These below messages are moved to frame/module_integrate.F,<a name='776'></font>
<font color=#447700>! and are merged with the timing information.<a name='777'></font>
#ifdef DM_PARALLEL<a name='778'>
      <font color=#447700>! if ( MYPE == 0 ) then<a name='779'></font>
      <font color=#447700>!   write(wrf_err_message,*) 'avg global change (hPa/3h): ', GLOBAL_CHANGE_WRF<a name='780'></font>
      <font color=#447700>!   call wrf_debug(1,wrf_err_message)<a name='781'></font>
      <font color=#447700>! endif<a name='782'></font>
#else<a name='783'>
        <font color=#447700>! write(wrf_err_message,*) 'avg global change (hPa/3h): ', GLOBAL_CHANGE_WRF<a name='784'></font>
        <font color=#447700>! call wrf_debug(1,wrf_err_message)<a name='785'></font>
#endif<a name='786'>
<a name='787'>
<font color=#447700>!<a name='788'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='789'></font>
<font color=#447700>!***  COMPUTATION OF PETDT<a name='790'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='791'></font>
<font color=#447700>!<a name='792'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='793'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='794'></font>
      DO K=KTE-1,KTS,-1<a name='795'>
        DO J=MYJS_P2,MYJE_P2<a name='796'>
        DO I=MYIS_P2,MYIE_P2<a name='797'>
          PETDT(I,J,K)=-(PRET(I,J)*ETA2(K+1)+DIV(I,J,K+1))              &amp;<a name='798'>
     &amp;                  *HBM2(I,J)<a name='799'>
        ENDDO<a name='800'>
        ENDDO<a name='801'>
      ENDDO<a name='802'>
<font color=#447700>!<a name='803'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='804'></font>
<font color=#447700>!***  SMOOTHING VERTICAL VELOCITY ALONG BOUNDARIES<a name='805'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='806'></font>
<font color=#447700>!<a name='807'></font>
      nonhydrostatic_smoothing: IF(.NOT.HYDRO.AND.KSMUD.GT.0)THEN<a name='808'>
<font color=#447700>!<a name='809'></font>
        NSMUD=KSMUD<a name='810'>
<font color=#447700>!<a name='811'></font>
        DO J=MYJS,MYJE<a name='812'>
        DO I=MYIS,MYIE<a name='813'>
          HBMS(I,J)=HBM2(I,J)<a name='814'>
        ENDDO<a name='815'>
        ENDDO<a name='816'>
<font color=#447700>!<a name='817'></font>
        JHL=LNSDT<a name='818'>
        JHH=JDE-JHL+1<a name='819'>
<font color=#447700>!<a name='820'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='821'></font>
<font color=#447700>!$omp&amp; private(i,ihh,ihl,ix,j,jx)<a name='822'></font>
        DO J=JHL,JHH<a name='823'>
          IF(J.GE.MY_JS_GLB.AND.J.LE.MY_JE_GLB)THEN<a name='824'>
            IHL=JHL/2+1<a name='825'>
            IHH=IDE-IHL+MOD(J,2)<a name='826'>
<font color=#447700>!<a name='827'></font>
            DO I=IHL,IHH<a name='828'>
              IF(I.GE.MY_IS_GLB.AND.I.LE.MY_IE_GLB)THEN<a name='829'>
                IX=I    <font color=#447700>! -MY_IS_GLB+1<a name='830'></font>
                JX=J    <font color=#447700>! -MY_JS_GLB+1<a name='831'></font>
                HBMS(IX,JX)=0.<a name='832'>
              ENDIF<a name='833'>
            ENDDO<a name='834'>
<font color=#447700>!<a name='835'></font>
          ENDIF<a name='836'>
        ENDDO<a name='837'>
<font color=#447700>!<a name='838'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='839'></font>
<font color=#447700>!***<a name='840'></font>
<font color=#447700>!***  SMOOTH THE VERTICAL VELOCITY<a name='841'></font>
<font color=#447700>!***<a name='842'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='843'></font>
<font color=#447700>!<a name='844'></font>
        DO KS=1,NSMUD<a name='845'>
<font color=#447700>!<a name='846'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='847'></font>
<font color=#447700>!<a name='848'></font>
<font color=#447700>!***  PNE AT H(I,J) LIES BETWEEN (I,J) AND THE H POINT TO THE NE.<a name='849'></font>
<font color=#447700>!***  PSE AT H(I,J) LIES BETWEEN (I,J) AND THE H POINT TO THE SE.<a name='850'></font>
<font color=#447700>!<a name='851'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='852'></font>
<font color=#447700>!$omp&amp; private(i,j,k,petdtl,pne,pse)<a name='853'></font>
<font color=#447700>!<a name='854'></font>
          DO K=KTS+1,KTE<a name='855'>
<font color=#447700>!<a name='856'></font>
            DO J=MYJS_P1,MYJE1_P1<a name='857'>
            DO I=MYIS_P1,MYIE1_P1<a name='858'>
              PNE(I,J)=PETDT(I+IHE(J),J+1,K)-PETDT(I,J,K)<a name='859'>
            ENDDO<a name='860'>
            ENDDO<a name='861'>
<font color=#447700>!<a name='862'></font>
            DO J=MYJS1_P1,MYJE_P1<a name='863'>
            DO I=MYIS_P1,MYIE1_P1<a name='864'>
              PSE(I,J)=PETDT(I+IHE(J),J-1,K)-PETDT(I,J,K)<a name='865'>
            ENDDO<a name='866'>
            ENDDO<a name='867'>
<font color=#447700>!<a name='868'></font>
            DO J=MYJS2,MYJE2<a name='869'>
            DO I=MYIS1,MYIE1<a name='870'>
              PETDTL=(PNE(I,J)-PNE(I+IHW(J),J-1)                        &amp;<a name='871'>
     &amp;               +PSE(I,J)-PSE(I+IHW(J),J+1))*HBM2(I,J)<a name='872'>
              PETDT(I,J,K)=PETDTL*HBMS(I,J)*0.125+PETDT(I,J,K)<a name='873'>
            ENDDO<a name='874'>
            ENDDO<a name='875'>
<font color=#447700>!<a name='876'></font>
          ENDDO<a name='877'>
<font color=#447700>!<a name='878'></font>
#ifdef DM_PARALLEL<a name='879'>
<font color=#447700>!          IPS=ITS;IPE=ITE;JPS=JTS;JPE=JTE;KPS=KTS;KPE=KTE<a name='880'></font>
# include "<A href='../../html_code/include/HALO_NMM_E.inc.html'>HALO_NMM_E.inc</A>"<A NAME="HALO_NMM_E.inc_3"><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PDTE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='881'>
#endif<a name='882'>
<font color=#447700>!-----------------------------------------------------------------------<a name='883'></font>
<font color=#447700>!<a name='884'></font>
        ENDDO  <font color=#447700>! End of smoothing loop<a name='885'></font>
<font color=#447700>!<a name='886'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='887'></font>
<font color=#447700>!<a name='888'></font>
      ENDIF nonhydrostatic_smoothing<a name='889'>
<font color=#447700>!<a name='890'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='891'></font>
<font color=#447700>!<a name='892'></font>
      END SUBROUTINE PDTE<a name='893'>
<font color=#447700>!<a name='894'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='895'></font>
<font color=#447700>!***********************************************************************<a name='896'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='897'></font>
<A NAME='VTOA'><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#VTOA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='898'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VTOA</font>(                                                  &amp; <A href='../../call_to/VTOA.html' TARGET='index'>1</A><a name='899'>
     &amp;                NTSD,DT,PT,ETA2                                   &amp;<a name='900'>
     &amp;               ,HBM2,EF4T                                         &amp;<a name='901'>
     &amp;               ,T,DWDT,RTOP,OMGALF                                &amp;<a name='902'>
     &amp;               ,PINT,DIV,PSDT,RES                                 &amp;<a name='903'>
     &amp;               ,IHE,IHW,IVE,IVW                                   &amp;                 <a name='904'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='905'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='906'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='907'>
<font color=#447700>!***********************************************************************<a name='908'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='909'></font>
<font color=#447700>!                .      .    .     <a name='910'></font>
<font color=#447700>! SUBPROGRAM:    VTOA        OMEGA-ALPHA<a name='911'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP2      DATE: 04-02-17      <a name='912'></font>
<font color=#447700>!     <a name='913'></font>
<font color=#447700>! ABSTRACT:<a name='914'></font>
<font color=#447700>!     VTOA UPDATES THE NONHYDROSTATIC PRESSURE AND ADDS THE<a name='915'></font>
<font color=#447700>!     CONTRIBUTION OF THE OMEGA-ALPHA TERM OF THE THERMODYNAMIC<a name='916'></font>
<font color=#447700>!     EQUATION.  ALSO, THE OMEGA-ALPHA TERM IS COMPUTED FOR DIAGNOSTICS.<a name='917'></font>
<font color=#447700>!     <a name='918'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='919'></font>
<font color=#447700>!   04-02-17  JANJIC     - SEPARATED FROM ORIGINAL PDTEDT ROUTINE<a name='920'></font>
<font color=#447700>!   04-11-23  BLACK      - THREADED<a name='921'></font>
<font color=#447700>!     <a name='922'></font>
<a name='923'>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='924'></font>
<font color=#447700>!  <a name='925'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST: <a name='926'></font>
<font color=#447700>!     <a name='927'></font>
<font color=#447700>!   OUTPUT FILES:<a name='928'></font>
<font color=#447700>!     NONE<a name='929'></font>
<font color=#447700>!     <a name='930'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='931'></font>
<font color=#447700>!  <a name='932'></font>
<font color=#447700>!     UNIQUE: NONE<a name='933'></font>
<font color=#447700>!  <a name='934'></font>
<font color=#447700>!     LIBRARY: NONE<a name='935'></font>
<font color=#447700>!  <a name='936'></font>
<font color=#447700>! ATTRIBUTES:<a name='937'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='938'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='939'></font>
<font color=#447700>!$$$  <a name='940'></font>
<font color=#447700>!***********************************************************************<a name='941'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='942'></font>
      IMPLICIT NONE<a name='943'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='944'>
                           ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='945'>
                           ,ITS,ITE,JTS,JTE,KTS,KTE<a name='946'>
<font color=#447700>!<a name='947'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='948'>
<font color=#447700>!<a name='949'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='950'>
<font color=#447700>!<a name='951'></font>
      REAL,INTENT(IN) :: DT,EF4T,PT<a name='952'>
<font color=#447700>!<a name='953'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: ETA2<a name='954'>
<font color=#447700>!<a name='955'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: HBM2,PSDT,RES<a name='956'>
<font color=#447700>!<a name='957'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: DIV,DWDT    &amp;<a name='958'>
     &amp;                                                     ,RTOP<a name='959'>
<font color=#447700>!<a name='960'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: OMGALF,T  <a name='961'>
<font color=#447700>!<a name='962'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: PINT<a name='963'>
<font color=#447700>!<a name='964'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='965'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='966'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='967'></font>
<font color=#447700>!<a name='968'></font>
      INTEGER :: I,J,K<a name='969'>
<font color=#447700>!<a name='970'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: PRET,TPM<a name='971'>
<font color=#447700>!<a name='972'></font>
      REAL :: DWDTP,RHS,TPMP<a name='973'>
<font color=#447700>!<a name='974'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='975'></font>
<font color=#447700>!***********************************************************************<a name='976'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='977'></font>
<font color=#447700>!***  PREPARATIONS<a name='978'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='979'></font>
<font color=#447700>!<a name='980'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='981'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='982'></font>
      DO J=MYJS_P2,MYJE_P2<a name='983'>
      DO I=MYIS_P2,MYIE_P2<a name='984'>
        PINT(I,J,KTE+1)=PT<a name='985'>
        TPM(I,J)=PT+PINT(I,J,KTE)<a name='986'>
        PRET(I,J)=PSDT(I,J)*RES(I,J)<a name='987'>
      ENDDO<a name='988'>
      ENDDO<a name='989'>
<font color=#447700>!<a name='990'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='991'></font>
<font color=#447700>!***  KINETIC ENERGY GENERATION TERMS IN T EQUATION<a name='992'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='993'></font>
<font color=#447700>!<a name='994'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='995'></font>
<font color=#447700>!$omp&amp; private(dwdtp,i,j,rhs,tpmp)<a name='996'></font>
      DO J=MYJS,MYJE<a name='997'>
      DO I=MYIS,MYIE<a name='998'>
        DWDTP=DWDT(I,J,KTE)<a name='999'>
        TPMP=PINT(I,J,KTE)+PINT(I,J,KTE-1)<a name='1000'>
<font color=#447700>!<a name='1001'></font>
        RHS=-DIV(I,J,KTE)*RTOP(I,J,KTE)*DWDTP*EF4T<a name='1002'>
        OMGALF(I,J,KTE)=OMGALF(I,J,KTE)+RHS<a name='1003'>
        T(I,J,KTE)=OMGALF(I,J,KTE)*HBM2(I,J)+T(I,J,KTE)<a name='1004'>
        PINT(I,J,KTE)=PRET(I,J)*(ETA2(KTE+1)+ETA2(KTE))*DWDTP*DT        &amp;<a name='1005'>
     &amp;             +TPM(I,J)-PINT(I,J,KTE+1)<a name='1006'>
<font color=#447700>!<a name='1007'></font>
        TPM(I,J)=TPMP<a name='1008'>
      ENDDO<a name='1009'>
      ENDDO<a name='1010'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1011'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1012'></font>
<font color=#447700>!$omp&amp; private(dwdtp,i,j,k,rhs,tpmp)<a name='1013'></font>
      DO K=KTE-1,KTS+1,-1<a name='1014'>
        DO J=MYJS,MYJE<a name='1015'>
        DO I=MYIS,MYIE<a name='1016'>
          DWDTP=DWDT(I,J,K)<a name='1017'>
          TPMP=PINT(I,J,K)+PINT(I,J,K-1)<a name='1018'>
<font color=#447700>!<a name='1019'></font>
          RHS=-(DIV(I,J,K+1)+DIV(I,J,K))*RTOP(I,J,K)*DWDTP*EF4T<a name='1020'>
          OMGALF(I,J,K)=OMGALF(I,J,K)+RHS<a name='1021'>
          T(I,J,K)=OMGALF(I,J,K)*HBM2(I,J)+T(I,J,K)<a name='1022'>
          PINT(I,J,K)=PRET(I,J)*(ETA2(K+1)+ETA2(K))*DWDTP*DT            &amp;<a name='1023'>
     &amp;               +TPM(I,J)-PINT(I,J,K+1)<a name='1024'>
<font color=#447700>!<a name='1025'></font>
          TPM(I,J)=TPMP<a name='1026'>
        ENDDO<a name='1027'>
        ENDDO<a name='1028'>
      ENDDO<a name='1029'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1030'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1031'></font>
<font color=#447700>!$omp&amp; private(dwdtp,i,j,rhs)<a name='1032'></font>
      DO J=MYJS,MYJE<a name='1033'>
      DO I=MYIS,MYIE<a name='1034'>
<font color=#447700>!<a name='1035'></font>
        DWDTP=DWDT(I,J,KTS)<a name='1036'>
<font color=#447700>!<a name='1037'></font>
<font color=#447700>!     if(i==77.and.j==53)then<a name='1038'></font>
<font color=#447700>!       write(0,28361)t(i,j,kts),omgalf(i,j,kts),rtop(i,j,kts),dwdtp<a name='1039'></font>
<font color=#447700>!       write(0,28362)div(i,j,kts),div(i,j,kts+1),ef4t<a name='1040'></font>
28361   format(' t=',z8,' omgalf=',z8,' rtop=',z8,' dwdtp=',z8)<a name='1041'>
28362   format(' div=',2(1x,z8),' ef4t=',z8)<a name='1042'>
<font color=#447700>!     endif<a name='1043'></font>
        RHS=-(DIV(I,J,KTS+1)+DIV(I,J,KTS))*RTOP(I,J,KTS)*DWDTP*EF4T<a name='1044'>
        OMGALF(I,J,KTS)=OMGALF(I,J,KTS)+RHS<a name='1045'>
        T(I,J,KTS)=OMGALF(I,J,KTS)*HBM2(I,J)+T(I,J,KTS)<a name='1046'>
        PINT(I,J,KTS)=PRET(I,J)*(ETA2(KTS+1)+ETA2(KTS))*DWDTP*DT        &amp;<a name='1047'>
     &amp;                 +TPM(I,J)-PINT(I,J,KTS+1)<a name='1048'>
      ENDDO<a name='1049'>
      ENDDO<a name='1050'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1051'></font>
<font color=#447700>!<a name='1052'></font>
      END SUBROUTINE VTOA<a name='1053'>
<font color=#447700>!<a name='1054'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1055'></font>
<font color=#447700>!***********************************************************************<a name='1056'></font>
<A NAME='DDAMP'><A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#DDAMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1057'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>DDAMP</font>(NTSD,DT,DETA1,DETA2,PDSL,PDTOP,DIV,HBM2          &amp; <A href='../../call_to/DDAMP.html' TARGET='index'>1</A><a name='1058'>
     &amp;                ,T,U,V,DDMPU,DDMPV                                &amp;<a name='1059'>
     &amp;                ,IHE,IHW,IVE,IVW                                  &amp;              <a name='1060'>
     &amp;                ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='1061'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='1062'>
     &amp;                ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1063'>
<font color=#447700>!***********************************************************************<a name='1064'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='1065'></font>
<font color=#447700>!                .      .    .     <a name='1066'></font>
<font color=#447700>! SUBPROGRAM:    DDAMP       DIVERGENCE DAMPING<a name='1067'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 94-03-08       <a name='1068'></font>
<font color=#447700>!     <a name='1069'></font>
<font color=#447700>! ABSTRACT:<a name='1070'></font>
<font color=#447700>!     DDAMP MODIFIES THE WIND COMPONENTS SO AS TO REDUCE THE<a name='1071'></font>
<font color=#447700>!     HORIZONTAL DIVERGENCE.<a name='1072'></font>
<font color=#447700>!     <a name='1073'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='1074'></font>
<font color=#447700>!   87-08-??  JANJIC     - ORIGINATOR<a name='1075'></font>
<font color=#447700>!   95-03-25  BLACK      - CONVERSION FROM 1-D TO 2-D IN HORIZONTAL<a name='1076'></font>
<font color=#447700>!   95-03-28  BLACK      - ADDED EXTERNAL EDGE<a name='1077'></font>
<font color=#447700>!   98-10-30  BLACK      - MODIFIED FOR DISTRIBUTED MEMORY<a name='1078'></font>
<font color=#447700>!   01-03-12  BLACK      - CONVERTED TO WRF STRUCTURE<a name='1079'></font>
<font color=#447700>!   04-11-18  BLACK      - THREADED<a name='1080'></font>
<font color=#447700>!   05-12-09  BLACK      - CONVERTED FROM IKJ TO IJK<a name='1081'></font>
<font color=#447700>!     <a name='1082'></font>
<font color=#447700>! USAGE: CALL DDAMP FROM SUBROUTINE SOLVE_RUNSTREAM<a name='1083'></font>
<font color=#447700>!<a name='1084'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='1085'></font>
<font color=#447700>!  <a name='1086'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST: <a name='1087'></font>
<font color=#447700>!     <a name='1088'></font>
<font color=#447700>!   OUTPUT FILES:<a name='1089'></font>
<font color=#447700>!     NONE<a name='1090'></font>
<font color=#447700>!     <a name='1091'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='1092'></font>
<font color=#447700>!  <a name='1093'></font>
<font color=#447700>!     UNIQUE: NONE<a name='1094'></font>
<font color=#447700>!  <a name='1095'></font>
<font color=#447700>!     LIBRARY: NONE<a name='1096'></font>
<font color=#447700>!  <a name='1097'></font>
<font color=#447700>! ATTRIBUTES:<a name='1098'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='1099'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='1100'></font>
<font color=#447700>!$$$  <a name='1101'></font>
<font color=#447700>!***********************************************************************<a name='1102'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1103'></font>
      IMPLICIT NONE<a name='1104'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1105'></font>
<font color=#447700>!<a name='1106'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='1107'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='1108'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='1109'>
<font color=#447700>!<a name='1110'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='1111'>
<font color=#447700>!<a name='1112'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='1113'>
<font color=#447700>!<a name='1114'></font>
      REAL,INTENT(IN) :: DT,PDTOP<a name='1115'>
<font color=#447700>!<a name='1116'></font>
      REAL,DIMENSION(KMS:KME-1),INTENT(IN) :: DETA1,DETA2<a name='1117'>
<font color=#447700>!<a name='1118'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DDMPU,DDMPV         &amp;<a name='1119'>
     &amp;                                             ,HBM2,PDSL<a name='1120'>
<font color=#447700>!<a name='1121'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: DIV,T    &amp;<a name='1122'>
     &amp;                                                        ,U,V<a name='1123'>
<font color=#447700>!<a name='1124'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1125'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1126'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1127'></font>
<font color=#447700>!<a name='1128'></font>
      INTEGER :: I,J,K<a name='1129'>
<font color=#447700>!<a name='1130'></font>
      REAL :: FCIM,FCXM,RDPDX,RDPDY<a name='1131'>
<font color=#447700>!<a name='1132'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: DIVE,DPDE,PDE          &amp;<a name='1133'>
     &amp;                                          ,XDIVX,XDIVY<a name='1134'>
<font color=#447700>!<a name='1135'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1136'></font>
<font color=#447700>!***********************************************************************<a name='1137'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1138'></font>
<font color=#447700>!<a name='1139'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1140'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1141'></font>
      DO J=JTS-5,JTE+5<a name='1142'>
      DO I=ITS-5,ITE+5<a name='1143'>
        PDE(I,J)=0.<a name='1144'>
        DPDE(I,J)=0.<a name='1145'>
        XDIVX(I,J)=0.<a name='1146'>
        XDIVY(I,J)=0.<a name='1147'>
      ENDDO<a name='1148'>
      ENDDO<a name='1149'>
<font color=#447700>!<a name='1150'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1151'></font>
<font color=#447700>!<a name='1152'></font>
      FCXM=1.<a name='1153'>
<font color=#447700>!<a name='1154'></font>
<font color=#447700>!$omp parallel do<a name='1155'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1156'></font>
      DO J=MYJS_P2,MYJE_P2<a name='1157'>
      DO I=MYIS_P2,MYIE_P2<a name='1158'>
        PDE (I,J)=PDSL(I,J)+PDTOP<a name='1159'>
        DIVE(I,J)=0.<a name='1160'>
      ENDDO<a name='1161'>
      ENDDO<a name='1162'>
<font color=#447700>!<a name='1163'></font>
      DO K=KTS,KTE<a name='1164'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1165'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1166'></font>
        DO J=MYJS_P2,MYJE_P2<a name='1167'>
        DO I=MYIS_P2,MYIE_P2<a name='1168'>
          DIVE(I,J)=DIV(I,J,K)*HBM2(I,J)+DIVE(I,J)<a name='1169'>
        ENDDO<a name='1170'>
        ENDDO<a name='1171'>
      ENDDO<a name='1172'>
<font color=#447700>!<a name='1173'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1174'></font>
<font color=#447700>!$omp&amp; private(i,j,rdpdx,rdpdy,fcxm)<a name='1175'></font>
      DO J=MYJS2,MYJE2<a name='1176'>
      DO I=MYIS1_P1,MYIE1_P1<a name='1177'>
        RDPDX=DDMPU(I,J)*FCXM                                           &amp;<a name='1178'>
     &amp;       /(PDE(I+IVW(J),J)  +PDE(I+IVE(J),J))    <a name='1179'>
        RDPDY=DDMPV(I,J)*FCXM                                           &amp;<a name='1180'>
     &amp;       /(PDE(I       ,J-1)+PDE(I     ,J+1))<a name='1181'>
<font color=#447700>!<a name='1182'></font>
        XDIVX(I,J)=(DIVE(I+IVE(J),J  )-DIVE(I+IVW(J),J  ))*RDPDX<a name='1183'>
        XDIVY(I,J)=(DIVE(I       ,J+1)-DIVE(I       ,J-1))*RDPDY<a name='1184'>
      ENDDO<a name='1185'>
      ENDDO<a name='1186'>
<font color=#447700>!<a name='1187'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1188'></font>
<font color=#447700>!<a name='1189'></font>
      FCIM=1.<a name='1190'>
<font color=#447700>!<a name='1191'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1192'></font>
<font color=#447700>!$omp&amp; private(dpde,i,j,k,rdpdx,rdpdy,fcim)<a name='1193'></font>
<font color=#447700>!<a name='1194'></font>
      fcim_loop: DO K=KTS,KTE<a name='1195'>
<font color=#447700>!<a name='1196'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1197'></font>
<font color=#447700>!<a name='1198'></font>
        DO J=MYJS_P2,MYJE_P2<a name='1199'>
        DO I=MYIS_P1,MYIE_P1<a name='1200'>
          DPDE(I,J)=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='1201'>
          DIV(I,J,K)=DIV(I,J,K)*HBM2(I,J)<a name='1202'>
        ENDDO<a name='1203'>
        ENDDO<a name='1204'>
<font color=#447700>!<a name='1205'></font>
        DO J=MYJS2,MYJE2<a name='1206'>
        DO I=MYIS1_P1,MYIE1_P1<a name='1207'>
          RDPDX=DDMPU(I,J)*FCIM                                        &amp;<a name='1208'>
     &amp;         /(DPDE(I+IVW(J),J)  +DPDE(I+IVE(J),J))<a name='1209'>
          RDPDY=DDMPV(I,J)*FCIM                                        &amp;<a name='1210'>
     &amp;         /(DPDE(I       ,J-1)+DPDE(I       ,J+1))<a name='1211'>
          U(I,J,K)=((DIV(I+IVE(J),J,K  )-DIV(I+IVW(J),J,K  ))*RDPDX    &amp;<a name='1212'>
     &amp;             +XDIVX(I,J))+U(I,J,K)<a name='1213'>
          V(I,J,K)=((DIV(I       ,J+1,K)-DIV(I       ,J-1,K))*RDPDY    &amp;<a name='1214'>
     &amp;             +XDIVY(I,J))+V(I,J,K)<a name='1215'>
        ENDDO<a name='1216'>
        ENDDO<a name='1217'>
<font color=#447700>!<a name='1218'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1219'></font>
<font color=#447700>!<a name='1220'></font>
      ENDDO fcim_loop<a name='1221'>
<font color=#447700>!<a name='1222'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1223'></font>
<font color=#447700>!<a name='1224'></font>
<a name='1225'>
      END SUBROUTINE DDAMP<a name='1226'>
<font color=#447700>!<a name='1227'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1228'></font>
<font color=#447700>!<a name='1229'></font>
      END MODULE MODULE_IGWAVE_ADJUST<a name='1230'>
<font color=#447700>!<a name='1231'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1232'></font>
</pre></body></html>