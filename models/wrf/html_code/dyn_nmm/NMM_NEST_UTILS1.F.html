<HTML> <BODY BGCOLOR=#bbeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if (NMM_NEST == 1)<a name='2'>
<font color=#447700>!===========================================================================<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>! E-GRID NESTING UTILITIES: This is gopal's doing<a name='5'></font>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!===========================================================================<a name='7'></font>
<a name='8'>
<A NAME='MED_NEST_EGRID_CONFIGURE'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_nest_egrid_configure</font> ( parent , nest ) <A href='../../call_to/MED_NEST_EGRID_CONFIGURE.html' TARGET='index'>3</A>,<A href='../../call_from/MED_NEST_EGRID_CONFIGURE.html' TARGET='index'>21</A><a name='10'>
 USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_56"><a name='11'>
 USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_78"><a name='12'>
 USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_43"><a name='13'>
 USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_6"><a name='14'>
<a name='15'>
 IMPLICIT NONE<a name='16'>
 TYPE(domain) , POINTER             :: parent , nest<a name='17'>
 TYPE(domain), POINTER  :: grid<a name='18'>
 REAL, PARAMETER                    :: ERAD=6371200.<a name='19'>
 REAL, PARAMETER                    :: DTR=0.01745329<a name='20'>
 REAL, PARAMETER                    :: DTAD=1.0<a name='21'>
 REAL, PARAMETER                    :: CP=1004.6<a name='22'>
 INTEGER                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='23'>
 INTEGER                            :: IMS,IME,JMS,JME,KMS,KME<a name='24'>
 INTEGER                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='25'>
 CHARACTER(LEN=255)                 :: message<a name='26'>
 CHARACTER (LEN=256) :: char_junk<a name='27'>
<a name='28'>
 INTEGER :: comzilla<a name='29'>
<a name='30'>
<a name='31'>
<font color=#447700>!----------------------------------------------------------------------------<a name='32'></font>
<font color=#447700>!  PURPOSE: <a name='33'></font>
<font color=#447700>!         - Initialize nested domain configurations including setting up <a name='34'></font>
<font color=#447700>!           wbd,sbd and some other variables and 1D arrays. <a name='35'></font>
<font color=#447700>!         - Note that in order to obtain coincident grid points, which  <a name='36'></font>
<font color=#447700>!           is a basic requirement for RSL, WRF infrastructure, we use <a name='37'></font>
<font color=#447700>!           western and southern boundaries of nested domain (nest%wbd0<a name='38'></font>
<font color=#447700>!           and nest%sbd0 derived from the parent domain. In this case<a name='39'></font>
<font color=#447700>!           the nested domain may be considered as a part of the parent <a name='40'></font>
<font color=#447700>!           domain with a higher resolution (telescoping ?). <a name='41'></font>
<font color=#447700>!         - Also note that in this case, the central lat/lons for nested <a name='42'></font>
<font color=#447700>!           domain should coincide with the central lat/lons of the parent,<a name='43'></font>
<font color=#447700>!           although the nested domain NEED NOT be located at the center of<a name='44'></font>
<font color=#447700>!           the domain.<a name='45'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='46'></font>
<font color=#447700>!<a name='47'></font>
<font color=#447700>!   BASIC TEST FOR PARENT DOMAIN: CHECK IF JMAX IS ODD. SINCE JDE IN THE NAMELIST<a name='48'></font>
<font color=#447700>!   IS JMAX + 1, WE NEED TO CHECK IF JDE IS EVEN IN WRF CONTEXT<a name='49'></font>
<a name='50'>
    IF(MOD(parent%ed32,2) .NE. 0)THEN<a name='51'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_113">("PARENT DOMAIN: JMAX IS EVEN, INCREASE e_sn IN THE namelist.input BY 1")<a name='52'>
    ENDIF<a name='53'>
<a name='54'>
<font color=#447700>!   BASIC TEST FOR NESTED DOMAIN: CHECK IF JMAX IS ODD. SINCE JDE IN THE NAMELIST<a name='55'></font>
<font color=#447700>!   IS JMAX + 1, WE NEED TO CHECK IF JDE IS EVEN IN WRF CONTEXT<a name='56'></font>
<a name='57'>
    IF(MOD(nest%ed32,2) .NE. 0)THEN<a name='58'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_114">("NESTED DOMAIN: JMAX IS EVEN, INCREASE e_sn IN THE namelist.input BY 1")<a name='59'>
    ENDIF<a name='60'>
<a name='61'>
<font color=#447700>!   Parent grid configuration, including, western and southern boundary<a name='62'></font>
<a name='63'>
    IDS = parent%sd31<a name='64'>
    IDE = parent%ed31<a name='65'>
    JDS = parent%sd32<a name='66'>
    JDE = parent%ed32<a name='67'>
    KDS = parent%sd33<a name='68'>
    KDE = parent%ed33<a name='69'>
<a name='70'>
    IMS = parent%sm31<a name='71'>
    IME = parent%em31<a name='72'>
    JMS = parent%sm32<a name='73'>
    JME = parent%em32<a name='74'>
    KMS = parent%sm33<a name='75'>
    KME = parent%em33<a name='76'>
<a name='77'>
    ITS = parent%sp31<a name='78'>
    ITE = parent%ep31<a name='79'>
    JTS = parent%sp32<a name='80'>
    JTE = parent%ep32<a name='81'>
    KTS = parent%sp33<a name='82'>
    KTE = parent%ep33<a name='83'>
<a name='84'>
<font color=#447700>!   grid configuration<a name='85'></font>
<a name='86'>
    <font color=#447700>! calculate wbd0 and sbd0 only for MOAD i.e. grid with parent_id == 0<a name='87'></font>
    if (parent%parent_id == 0 ) then        <font color=#447700>! Dusan's doing<a name='88'></font>
       parent%wbd0 = -(IDE-2)*parent%dx     <font color=#447700>! WBD0: in degrees;factor 2 takes care of dummy last column<a name='89'></font>
       parent%sbd0 = -((JDE-1)/2)*parent%dy <font color=#447700>! SBD0: in degrees; note that JDE-1 should be odd  <a name='90'></font>
       parent%wbd0var = parent%wbd0<a name='91'>
       parent%sbd0var = parent%sbd0<a name='92'>
    end if<a name='93'>
    nest%wbd0   = parent%wbd0 + (nest%i_parent_start-1)*2.*parent%dx + mod(nest%j_parent_start+1,2)*parent%dx<a name='94'>
    nest%sbd0   = parent%sbd0 + (nest%j_parent_start-1)*parent%dy<a name='95'>
    nest%wbd0var = nest%wbd0<a name='96'>
    nest%sbd0var = nest%sbd0<a name='97'>
    nest%dx     = parent%dx/nest%parent_grid_ratio<a name='98'>
    nest%dy     = parent%dy/nest%parent_grid_ratio<a name='99'>
<a name='100'>
    write(message,*)" -     nest%id    = ",nest%id<a name='101'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_156">(trim(message))<a name='102'>
    write(message,*)" -   parent%id    = ",nest%id<a name='103'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_157">(trim(message))<a name='104'>
    write(message,*)" - i_parent_start = ",nest%i_parent_start<a name='105'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_158">(trim(message))<a name='106'>
    write(message,*)" - j_parent_start = ",nest%j_parent_start<a name='107'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_159">(trim(message))<a name='108'>
    write(message,*)" - parent%wbd0    = ",parent%wbd0<a name='109'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_160">(trim(message))<a name='110'>
    write(message,*)" - parent%sbd0    = ",parent%sbd0<a name='111'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_161">(trim(message))<a name='112'>
    write(message,*)" - nest%wbd0      = ",nest%wbd0<a name='113'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_162">(trim(message))<a name='114'>
    write(message,*)" - nest%sbd0      = ",nest%sbd0<a name='115'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_163">(trim(message))<a name='116'>
    write(message,*)" - nest%dx        = ",nest%dx<a name='117'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_164">(trim(message))<a name='118'>
    write(message,*)" - nest%dy        = ",nest%dy<a name='119'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_165">(trim(message))<a name='120'>
<font color=#447700>!<a name='121'></font>
    CALL nl_set_dx (nest%id , nest%dx)   <font color=#447700>! for output purpose<a name='122'></font>
    CALL nl_set_dy (nest%id , nest%dy)   <font color=#447700>! for output purpose<a name='123'></font>
<a name='124'>
<font color=#447700>!   set lat-lons; parent set to nested domain<a name='125'></font>
<a name='126'>
    CALL nl_get_cen_lat (parent%id, parent%cen_lat) <font color=#447700>! cen_lat of parent set to nested domain<a name='127'></font>
    CALL nl_get_cen_lon (parent%id, parent%cen_lon) <font color=#447700>! cen_lon of parent set to nested domain<a name='128'></font>
<a name='129'>
   IF ( parent%active_this_task .AND. nest%active_this_task ) THEN<a name='130'>
    nest%cen_lat=parent%cen_lat<a name='131'>
    nest%cen_lon=parent%cen_lon<a name='132'>
<font color=#447700>!<a name='133'></font>
    CALL nl_set_cen_lat ( nest%id , nest%cen_lat)  <font color=#447700>! for output purpose<a name='134'></font>
    CALL nl_set_cen_lon ( nest%id , nest%cen_lon)  <font color=#447700>! for output purpose<a name='135'></font>
<a name='136'>
    write(message,*)" - nest%cen_lat   = ",nest%cen_lat<a name='137'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_166">(trim(message))<a name='138'>
    write(message,*)" - nest%cen_lon   = ",nest%cen_lon<a name='139'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_167">(trim(message))<a name='140'>
<a name='141'>
<a name='142'>
<font color=#447700>!   soil configuration<a name='143'></font>
<a name='144'>
#if ( HWRF == 1 )<a name='145'>
<font color=#447700>!zhang <a name='146'></font>
    if ( .not.nest%analysis ) then<a name='147'>
#endif<a name='148'>
    nest%sldpth  = parent%sldpth<a name='149'>
    nest%dzsoil  = parent%dzsoil<a name='150'>
    nest%rtdpth  = parent%rtdpth<a name='151'>
#if ( HWRF == 1 ) <a name='152'>
    endif<a name='153'>
#endif<a name='154'>
<a name='155'>
<font color=#447700>!   numerical set up<a name='156'></font>
<a name='157'>
    nest%deta        = parent%deta<a name='158'>
    nest%aeta        = parent%aeta<a name='159'>
    nest%etax        = parent%etax<a name='160'>
    nest%dfl         = parent%dfl<a name='161'>
    nest%deta1       = parent%deta1<a name='162'>
    nest%aeta1       = parent%aeta1<a name='163'>
    nest%eta1        = parent%eta1<a name='164'>
    nest%deta2       = parent%deta2<a name='165'>
    nest%aeta2       = parent%aeta2<a name='166'>
    nest%eta2        = parent%eta2<a name='167'>
    nest%pdtop       = parent%pdtop<a name='168'>
    nest%pt          = parent%pt<a name='169'>
    nest%dfrlg       = parent%dfrlg<a name='170'>
    nest%num_soil_layers = parent%num_soil_layers<a name='171'>
    nest%num_moves       = parent%num_moves<a name='172'>
<a name='173'>
<font color=#447700>! Unfortunately, some of the single value constants in used in module_initialize have <a name='174'></font>
<font color=#447700>! to be defiend here instead of the usual spot in med_initialize_nest_nmm. There<a name='175'></font>
<font color=#447700>! appears to be a problem in Registry and related code in this area.<a name='176'></font>
<font color=#447700>!<a name='177'></font>
<font color=#447700>! state  logical upstrm   -      dyn_nmm     -      -      -<a name='178'></font>
<a name='179'>
<a name='180'>
    nest%dlmd   = nest%dx<a name='181'>
    nest%dphd   = nest%dy<a name='182'>
    nest%dy_nmm = erad*(nest%dphd*dtr)<a name='183'>
    nest%cpgfv  = -nest%dt/(48.*nest%dy_nmm)<a name='184'>
    nest%en     = nest%dt/( 4.*nest%dy_nmm)*dtad<a name='185'>
    nest%ent    = nest%dt/(16.*nest%dy_nmm)*dtad<a name='186'>
    nest%f4d    = -.5*nest%dt*dtad<a name='187'>
    nest%f4q    = -nest%dt*dtad<a name='188'>
    nest%ef4t   = .5*nest%dt/cp<a name='189'>
<a name='190'>
<font color=#447700>!  Other output configurations that will make grads happy <a name='191'></font>
<a name='192'>
   CALL nl_get_truelat1 (parent%id, parent%truelat1 )<a name='193'>
   CALL nl_get_truelat2 (parent%id, parent%truelat2 )<a name='194'>
#if ( HWRF == 1 )<a name='195'>
<font color=#447700>! bao : to make the restart output identical at the restart initial time for stand_lon<a name='196'></font>
   CALL nl_get_stand_lon (parent%id, parent%stand_lon )<a name='197'>
#endif<a name='198'>
   CALL nl_get_map_proj (parent%id, parent%map_proj )<a name='199'>
   CALL nl_get_iswater (parent%id, parent%iswater )<a name='200'>
<a name='201'>
   nest%truelat1=parent%truelat1<a name='202'>
   nest%truelat2=parent%truelat2<a name='203'>
<font color=#447700>!bao<a name='204'></font>
   nest%stand_lon=parent%stand_lon<a name='205'>
<font color=#447700>!bao<a name='206'></font>
   nest%map_proj=parent%map_proj<a name='207'>
   nest%iswater=parent%iswater<a name='208'>
<a name='209'>
   CALL nl_set_truelat1(nest%id, nest%truelat1)<a name='210'>
   CALL nl_set_truelat2(nest%id, nest%truelat2)<a name='211'>
<font color=#447700>!bao<a name='212'></font>
   CALL nl_set_stand_lon(nest%id, nest%stand_lon)<a name='213'>
<font color=#447700>!bao<a name='214'></font>
   CALL nl_set_map_proj(nest%id, nest%map_proj)<a name='215'>
   CALL nl_set_iswater(nest%id, nest%iswater)<a name='216'>
<a name='217'>
   CALL nl_get_mminlu ( 1, char_junk )<a name='218'>
   IF ( nest%id .GT. 1 ) THEN<a name='219'>
     CALL nl_set_mminlu ( nest%id, char_junk )<a name='220'>
   ENDIF<a name='221'>
<a name='222'>
  ENDIF<a name='223'>
<font color=#447700>!!!!!!!!!!!!!<a name='224'></font>
<font color=#447700>! handle case where task computes parent or nest but not both (case of both is handled above)<a name='225'></font>
  IF ( parent%active_this_task .OR. nest%active_this_task ) THEN<a name='226'>
     IF ( parent%active_this_task ) THEN<a name='227'>
       comzilla = mpi_comm_to_kid( which_kid( nest%id ) , parent%id )<a name='228'>
<font color=#447700>!debug write(0,*)__FILE__,__LINE__,'Patt: mpi_comm_to_kid ',comzilla,which_kid( nest%id ) ,nest%id, parent%id<a name='229'></font>
       grid =&gt; parent<a name='230'>
     ELSE<a name='231'>
       comzilla = mpi_comm_to_mom( nest%id )<a name='232'>
<font color=#447700>!debug write(0,*)__FILE__,__LINE__,'Natt: mpi_comm_to_mom ',comzilla,nest%id<a name='233'></font>
       grid =&gt; nest<a name='234'>
     ENDIF<a name='235'>
<a name='236'>
#define BCAST_RARRAY(X) BYTE_BCAST( X, size(X)*RWORDSIZE, comzilla )  <a name='237'>
<font color=#447700>!   soil configuration<a name='238'></font>
#if ( HWRF == 1 )<a name='239'>
<font color=#447700>!zhang <a name='240'></font>
    if ( .not.nest%analysis ) then<a name='241'>
#endif<a name='242'>
      CALL BCAST_RARRAY( grid%sldpth ) <font color=#447700>!  nest%sldpth  = parent%sldpth<a name='243'></font>
      CALL BCAST_RARRAY( grid%dzsoil ) <font color=#447700>!  nest%dzsoil  = parent%dzsoil<a name='244'></font>
      CALL BCAST_RARRAY( grid%rtdpth ) <font color=#447700>!  nest%rtdpth  = parent%rtdpth<a name='245'></font>
#if ( HWRF == 1 ) <a name='246'>
    endif<a name='247'>
#endif<a name='248'>
<a name='249'>
     IF ( parent%active_this_task ) THEN<a name='250'>
       CALL nl_get_mminlu ( 1, char_junk )<a name='251'>
     ENDIF<a name='252'>
     CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_STRING_COMM'>wrf_dm_bcast_string_comm</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_COMM_1">( char_junk, LEN(char_junk),comzilla) <font color=#447700>! nest%mminlu  = trim(parent%mminlu)<a name='253'></font>
     IF ( nest%active_this_task .AND. nest%id .GT. 1 ) THEN<a name='254'>
       CALL nl_set_mminlu ( nest%id, char_junk )<a name='255'>
     ENDIF<a name='256'>
<a name='257'>
<font color=#447700>!   numerical set up<a name='258'></font>
<a name='259'>
      CALL BYTE_BCAST( grid%cen_lat, RWORDSIZE, comzilla )  <font color=#447700>!<a name='260'></font>
      CALL BYTE_BCAST( grid%cen_lon, RWORDSIZE, comzilla )  <font color=#447700>!<a name='261'></font>
      CALL nl_set_cen_lat ( nest%id , nest%cen_lat)  <font color=#447700>! for output purpose<a name='262'></font>
      CALL nl_set_cen_lon ( nest%id , nest%cen_lon)  <font color=#447700>! for output purpose<a name='263'></font>
    <font color=#447700>! "For output purposes" is not entirely true, because <a name='264'></font>
    <font color=#447700>! the central lat (parent) is needed in the call to EARTH_LATLON<a name='265'></font>
    <font color=#447700>! but it is derived (read from the input) so if this task isn't active<a name='266'></font>
    <font color=#447700>! on the parent, it won't know it, so set it here.<a name='267'></font>
    <font color=#447700>! Other way to have done this would have been to pass the nested cen_lat/lon<a name='268'></font>
    <font color=#447700>! into EARTH_LATLON instead of the parent's.  Flipped a coin.<a name='269'></font>
      IF ( .NOT. parent%active_this_task ) THEN<a name='270'>
        CALL nl_set_cen_lat ( parent%id , nest%cen_lat)  <font color=#447700>! for output purpose<a name='271'></font>
        CALL nl_set_cen_lon ( parent%id , nest%cen_lon)  <font color=#447700>! for output purpose<a name='272'></font>
      ENDIF<a name='273'>
<a name='274'>
      IF ( nest%active_this_task ) THEN<a name='275'>
        write(message,*)" - nest%cen_lat   = ",nest%cen_lat<a name='276'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_168">(trim(message))<a name='277'>
        write(message,*)" - nest%cen_lon   = ",nest%cen_lon<a name='278'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_169">(trim(message))<a name='279'>
      ENDIF<a name='280'>
<a name='281'>
      CALL BYTE_BCAST( grid%truelat1, RWORDSIZE, comzilla )  <font color=#447700>!<a name='282'></font>
      CALL BYTE_BCAST( grid%truelat2, RWORDSIZE, comzilla )  <font color=#447700>!<a name='283'></font>
      CALL nl_set_truelat1(nest%id, nest%truelat1)<a name='284'>
      CALL nl_set_truelat2(nest%id, nest%truelat2)<a name='285'>
<a name='286'>
      CALL BYTE_BCAST( grid%stand_lon, RWORDSIZE, comzilla )  <font color=#447700>!<a name='287'></font>
      CALL nl_set_stand_lon(nest%id, nest%stand_lon)<a name='288'>
<a name='289'>
      CALL BYTE_BCAST( grid%map_proj, IWORDSIZE, comzilla )  <font color=#447700>!<a name='290'></font>
      CALL BYTE_BCAST( grid%iswater, IWORDSIZE, comzilla )  <font color=#447700>!<a name='291'></font>
      CALL nl_set_map_proj(nest%id, nest%map_proj)<a name='292'>
      CALL nl_set_iswater(nest%id, nest%iswater)<a name='293'>
<a name='294'>
      CALL BCAST_RARRAY( grid%deta )  <font color=#447700>!  nest%deta        = parent%deta<a name='295'></font>
      CALL BCAST_RARRAY( grid%aeta )  <font color=#447700>!  nest%aeta        = parent%aeta<a name='296'></font>
      CALL BCAST_RARRAY( grid%etax )  <font color=#447700>!  nest%etax        = parent%etax<a name='297'></font>
      CALL BCAST_RARRAY( grid%dfl )   <font color=#447700>!  nest%dfl         = parent%dfl<a name='298'></font>
      CALL BCAST_RARRAY( grid%deta1 ) <font color=#447700>!  nest%deta1       = parent%deta1<a name='299'></font>
      CALL BCAST_RARRAY( grid%aeta1 ) <font color=#447700>!  nest%aeta1       = parent%aeta1<a name='300'></font>
      CALL BCAST_RARRAY( grid%eta1 )  <font color=#447700>!  nest%eta1        = parent%eta1<a name='301'></font>
      CALL BCAST_RARRAY( grid%deta2 ) <font color=#447700>!  nest%deta2       = parent%deta2<a name='302'></font>
      CALL BCAST_RARRAY( grid%aeta2 ) <font color=#447700>!  nest%aeta2       = parent%aeta2<a name='303'></font>
      CALL BCAST_RARRAY( grid%eta2 )  <font color=#447700>!  nest%eta2        = parent%eta2<a name='304'></font>
      CALL BYTE_BCAST( grid%pdtop, RWORDSIZE, comzilla ) <font color=#447700>!  nest%pdtop       = parent%pdtop<a name='305'></font>
      CALL BYTE_BCAST( grid%pt, RWORDSIZE, comzilla )    <font color=#447700>!  nest%pt          = parent%pt<a name='306'></font>
      CALL BYTE_BCAST( grid%dfrlg, RWORDSIZE, comzilla ) <font color=#447700>!  nest%dfrlg       = parent%dfrlg<a name='307'></font>
      CALL BYTE_BCAST( grid%num_soil_layers, IWORDSIZE, comzilla ) <font color=#447700>!  nest%num_soil_layers = parent%num_soil_layers<a name='308'></font>
      CALL BYTE_BCAST( grid%num_moves, IWORDSIZE, comzilla )       <font color=#447700>!  nest%num_moves       = parent%num_moves<a name='309'></font>
<a name='310'>
<font color=#447700>! Unfortunately, some of the single value constants in used in module_initialize have<a name='311'></font>
<font color=#447700>! to be defiend here instead of the usual spot in med_initialize_nest_nmm. There<a name='312'></font>
<font color=#447700>! appears to be a problem in Registry and related code in this area.<a name='313'></font>
<font color=#447700>!<a name='314'></font>
<font color=#447700>! state  logical upstrm   -      dyn_nmm     -      -      -<a name='315'></font>
<a name='316'>
  ENDIF<a name='317'>
<a name='318'>
  IF ( nest%active_this_task ) THEN<a name='319'>
<a name='320'>
    nest%dlmd   = nest%dx<a name='321'>
    nest%dphd   = nest%dy<a name='322'>
    nest%dy_nmm = erad*(nest%dphd*dtr)<a name='323'>
    nest%cpgfv  = -nest%dt/(48.*nest%dy_nmm)<a name='324'>
    nest%en     = nest%dt/( 4.*nest%dy_nmm)*dtad<a name='325'>
    nest%ent    = nest%dt/(16.*nest%dy_nmm)*dtad<a name='326'>
    nest%f4d    = -.5*nest%dt*dtad<a name='327'>
    nest%f4q    = -nest%dt*dtad<a name='328'>
    nest%ef4t   = .5*nest%dt/cp<a name='329'>
<a name='330'>
  ENDIF<a name='331'>
<a name='332'>
<a name='333'>
<font color=#447700>!   physics and other configurations<a name='334'></font>
<font color=#447700>!   CALL nl_get_iswater (parent%id, nest%iswater) ! iswater is just based on parents<a name='335'></font>
<font color=#447700>!   CALL nl_get_bl_surface_physics (nest%id,  nest%bl_surface_physics )<a name='336'></font>
<font color=#447700>!   CALL nl_get_num_soil_layers( parent%num_soil_layers )<a name='337'></font>
<font color=#447700>!   CALL nl_get_real_data_init_type (parent%real_data_init_type)<a name='338'></font>
<a name='339'>
END SUBROUTINE med_nest_egrid_configure<a name='340'>
<a name='341'>
<A NAME='MED_CONSTRUCT_EGRID_WEIGHTS'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='342'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_construct_egrid_weights</font> ( parent , nest ) <A href='../../call_to/MED_CONSTRUCT_EGRID_WEIGHTS.html' TARGET='index'>3</A>,<A href='../../call_from/MED_CONSTRUCT_EGRID_WEIGHTS.html' TARGET='index'>13</A><a name='343'>
 USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_57"><a name='344'>
 USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_79"><a name='345'>
 USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_44"><a name='346'>
 USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_7"><a name='347'>
<a name='348'>
 IMPLICIT NONE<a name='349'>
 TYPE(domain) , POINTER             :: parent , nest<a name='350'>
 TYPE(domain), POINTER  :: grid<a name='351'>
 LOGICAL, EXTERNAL                  :: wrf_dm_on_monitor<a name='352'>
 INTEGER                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='353'>
 INTEGER                            :: IMS,IME,JMS,JME,KMS,KME<a name='354'>
 INTEGER                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='355'>
 INTEGER                            :: I,J,II,JJ,NII,NJJ<a name='356'>
 REAL                               :: parent_CLAT,parent_CLON,parent_WBD,parent_SBD,parent_DLMD,parent_DPHD<a name='357'>
 REAL                               :: nest_WBD,nest_SBD,nest_DLMD,nest_DPHD<a name='358'>
 REAL                               :: SW_LATD,SW_LOND<a name='359'>
 REAL                               :: ADDSUM1,ADDSUM2<a name='360'>
 REAL                               :: xr,zr,xc<a name='361'>
 INTEGER :: comzilla<a name='362'>
<font color=#447700>!-----------------------------------------------------------------------------------------------------------<a name='363'></font>
<font color=#447700>!   PURPOSE: <a name='364'></font>
<font color=#447700>!           - Initialize lat-lons and determine weights <a name='365'></font>
<font color=#447700>!<a name='366'></font>
<font color=#447700>!----------------------------------------------------------------------------------------------------------<a name='367'></font>
<a name='368'>
<font color=#447700>!   First obtain central latitude and longitude for the parent domain<a name='369'></font>
<a name='370'>
  IF ( parent%active_this_task .OR.  nest%active_this_task ) THEN<a name='371'>
    IF ( parent%active_this_task ) THEN<a name='372'>
       comzilla = mpi_comm_to_kid( which_kid( nest%id ) , parent%id )<a name='373'>
       grid =&gt; parent<a name='374'>
    ELSE<a name='375'>
       comzilla = mpi_comm_to_mom( nest%id )<a name='376'>
       grid =&gt; nest<a name='377'>
    ENDIF<a name='378'>
  ENDIF<a name='379'>
<a name='380'>
    CALL nl_get_cen_lat (parent%ID, parent_CLAT)<a name='381'>
    CALL nl_get_cen_lon (parent%ID, parent_CLON)<a name='382'>
<a name='383'>
<font color=#447700>!   Parent grid configuration, including, western and southern boundary<a name='384'></font>
<a name='385'>
    IDS = parent%sd31<a name='386'>
    IDE = parent%ed31<a name='387'>
    JDS = parent%sd32<a name='388'>
    JDE = parent%ed32<a name='389'>
    KDS = parent%sd33<a name='390'>
    KDE = parent%ed33<a name='391'>
<a name='392'>
    IMS = parent%sm31<a name='393'>
    IME = parent%em31<a name='394'>
    JMS = parent%sm32<a name='395'>
    JME = parent%em32<a name='396'>
    KMS = parent%sm33<a name='397'>
    KME = parent%em33<a name='398'>
<a name='399'>
    ITS  = parent%sp31<a name='400'>
    ITE  = parent%ep31<a name='401'>
    JTS  = parent%sp32<a name='402'>
    JTE  = parent%ep32<a name='403'>
    KTS  = parent%sp33<a name='404'>
    KTE  = parent%ep33<a name='405'>
<font color=#447700>!<a name='406'></font>
    parent_DLMD = parent%dx                <font color=#447700>! DLMD: dlamda in degrees <a name='407'></font>
    parent_DPHD = parent%dy                <font color=#447700>! DPHD: dphi in degrees <a name='408'></font>
    parent_WBD  = parent%wbd0<a name='409'>
    parent_SBD  = parent%sbd0<a name='410'>
<a name='411'>
<font color=#447700>!   Now compute Geodetic lat/lon (Positive East) of parent grid in degrees<a name='412'></font>
<a name='413'>
  IF ( parent%active_this_task ) THEN<a name='414'>
<a name='415'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#EARTH_LATLON'>EARTH_LATLON</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EARTH_LATLON_1"> ( parent%HLAT,parent%HLON,parent%VLAT,parent%VLON,  &amp; <font color=#447700>!output<a name='416'></font>
                        parent_DLMD,parent_DPHD,parent_WBD,parent_SBD,                    &amp; <font color=#447700>!inputs <a name='417'></font>
                        parent_CLAT,parent_CLON,                                          &amp;<a name='418'>
                        IDS,IDE,JDS,JDE,KDS,KDE,                                          &amp;<a name='419'>
                        IMS,IME,JMS,JME,KMS,KME,                                          &amp;<a name='420'>
                        ITS,ITE,JTS,JTE,KTS,KTE                                           )<a name='421'>
  ENDIF<a name='422'>
<a name='423'>
<font color=#447700>!   Nested grid configuration, including, western and southern boundary<a name='424'></font>
<a name='425'>
    IDS = nest%sd31<a name='426'>
    IDE = nest%ed31<a name='427'>
    JDS = nest%sd32<a name='428'>
    JDE = nest%ed32<a name='429'>
    KDS = nest%sd33<a name='430'>
    KDE = nest%ed33<a name='431'>
<a name='432'>
    IMS = nest%sm31<a name='433'>
    IME = nest%em31<a name='434'>
    JMS = nest%sm32<a name='435'>
    JME = nest%em32<a name='436'>
    KMS = nest%sm33<a name='437'>
    KME = nest%em33<a name='438'>
<a name='439'>
    ITS  = nest%sp31<a name='440'>
    ITE  = nest%ep31<a name='441'>
    JTS  = nest%sp32<a name='442'>
    JTE  = nest%ep32<a name='443'>
    KTS  = nest%sp33<a name='444'>
    KTE  = nest%ep33<a name='445'>
<font color=#447700>!<a name='446'></font>
    nest_DLMD = nest%dx<a name='447'>
    nest_DPHD = nest%dy<a name='448'>
    nest_WBD  = nest%wbd0<a name='449'>
    nest_SBD  = nest%sbd0<a name='450'>
<a name='451'>
<font color=#447700>!<a name='452'></font>
<font color=#447700>!   Now compute Geodetic lat/lon (Positive East) of nest in degrees, with the same central lat-lon<a name='453'></font>
<font color=#447700>!   as the parent grid<a name='454'></font>
<font color=#447700>!<a name='455'></font>
<a name='456'>
  IF ( nest%active_this_task ) THEN<a name='457'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#EARTH_LATLON'>EARTH_LATLON</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EARTH_LATLON_2"> ( nest%HLAT,nest%HLON,nest%VLAT,nest%VLON, &amp; <font color=#447700>! output<a name='458'></font>
                        nest_DLMD,nest_DPHD,nest_WBD,nest_SBD,                   &amp; <font color=#447700>! nest inputs<a name='459'></font>
                        parent_CLAT,parent_CLON,                                 &amp; <font color=#447700>! parent central lat/lon<a name='460'></font>
                        IDS,IDE,JDS,JDE,KDS,KDE,                                 &amp; <font color=#447700>! nested domain dimension<a name='461'></font>
                        IMS,IME,JMS,JME,KMS,KME,                                 &amp;<a name='462'>
                        ITS,ITE,JTS,JTE,KTS,KTE                                  )<a name='463'>
<a name='464'>
<font color=#447700>!   Determine the weights of nested grid h points nearest to H points of parent domain <a name='465'></font>
<a name='466'>
  if(nest%vortex_tracker /= 1) then<a name='467'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW'>G2T2H_new</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G2T2H_NEW_1">(    nest%IIH,nest%JJH,                            &amp; <font color=#447700>! output grid index in parent grid<a name='468'></font>
                       nest%HBWGT1,nest%HBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='469'></font>
                       nest%HBWGT3,nest%HBWGT4,                      &amp;<a name='470'>
                       nest%I_PARENT_START,nest%J_PARENT_START,      &amp; <font color=#447700>! nest start I, J in parent domain<a name='471'></font>
                       3,                              &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='472'></font>
                       IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='473'></font>
                       IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='474'>
                       ITS,ITE,JTS,JTE,KTS,KTE      )<a name='475'>
  else<a name='476'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H'>G2T2H</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G2T2H_1">( nest%IIH,nest%JJH,                       &amp; <font color=#447700>! output grid index on nested grid<a name='477'></font>
                nest%HBWGT1,nest%HBWGT2,                 &amp; <font color=#447700>! output weights on the nested grid <a name='478'></font>
                nest%HBWGT3,nest%HBWGT4,                 &amp;<a name='479'>
                nest%HLAT,nest%HLON,                     &amp; <font color=#447700>! target (nest) input lat lon in degrees<a name='480'></font>
                parent_DLMD,parent_DPHD,parent_WBD,parent_SBD,   &amp; <font color=#447700>! parent res, western and south boundaries<a name='481'></font>
                parent_CLAT,parent_CLON,                         &amp; <font color=#447700>! parent central lat,lon, all in degrees<a name='482'></font>
                parent%ed31,parent%ed32,                         &amp; <font color=#447700>! parent imax and jmax<a name='483'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                         &amp; <font color=#447700>! <a name='484'></font>
                IMS,IME,JMS,JME,KMS,KME,                         &amp; <font color=#447700>! nested grid configuration<a name='485'></font>
                ITS,ITE,JTS,JTE,KTS,KTE                          ) <font color=#447700>!<a name='486'></font>
  endif<a name='487'>
<a name='488'>
<a name='489'>
<font color=#447700>!   Determine the weights of nested grid v points nearest to V points of parent domain<a name='490'></font>
<a name='491'>
  if(nest%vortex_tracker /= 1) then<a name='492'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW'>G2T2V_new</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G2T2V_NEW_1">(    nest%IIV,nest%JJV,                            &amp; <font color=#447700>! output grid index in parent grid<a name='493'></font>
                       nest%VBWGT1,nest%VBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='494'></font>
                       nest%VBWGT3,nest%VBWGT4,                      &amp;<a name='495'>
                       nest%I_PARENT_START,nest%J_PARENT_START,      &amp; <font color=#447700>! nest start I, J in parent domain<a name='496'></font>
                       3,                              &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='497'></font>
                       IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='498'></font>
                       IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='499'>
                       ITS,ITE,JTS,JTE,KTS,KTE      )<a name='500'>
  else<a name='501'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V'>G2T2V</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G2T2V_1">( nest%IIV,nest%JJV,                       &amp; <font color=#447700>! output grid index on nested grid<a name='502'></font>
                nest%VBWGT1,nest%VBWGT2,                 &amp; <font color=#447700>! output weights on the nested grid<a name='503'></font>
                nest%VBWGT3,nest%VBWGT4,                 &amp;<a name='504'>
                nest%VLAT,nest%VLON,                     &amp; <font color=#447700>! target (nest) input lat lon in degrees<a name='505'></font>
                parent_DLMD,parent_DPHD,parent_WBD,parent_SBD,   &amp; <font color=#447700>! parent res, western and south boundaries<a name='506'></font>
                parent_CLAT,parent_CLON,                         &amp; <font color=#447700>! parent central lat,lon, all in degrees<a name='507'></font>
                parent%ed31,parent%ed32,                         &amp; <font color=#447700>! parent imax and jmax<a name='508'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                         &amp; <font color=#447700>!<a name='509'></font>
                IMS,IME,JMS,JME,KMS,KME,                         &amp; <font color=#447700>! nested grid configuration<a name='510'></font>
                ITS,ITE,JTS,JTE,KTS,KTE                          ) <font color=#447700>!<a name='511'></font>
  endif<a name='512'>
<a name='513'>
<font color=#447700>! Generate nearest neighbor information for parent-&gt;nest nearest<a name='514'></font>
<font color=#447700>! neighbor interpolation:<a name='515'></font>
  call <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INIT_HNEAR'>INIT_HNEAR</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_HNEAR_1">(nest%iih, nest%jjh, nest%hbwgt1, nest%hbwgt2, &amp;<a name='516'>
                  nest%hbwgt3, nest%hbwgt4,                     &amp;<a name='517'>
                  nest%hnear_i, nest%hnear_j,                   &amp;<a name='518'>
                  IDS,IDE,JDS,JDE,KDS,KDE,                      &amp;<a name='519'>
                  IMS,IME,JMS,JME,KMS,KME,                      &amp;<a name='520'>
                  ITS,ITE,JTS,JTE,KTS,KTE)<a name='521'>
<a name='522'>
<a name='523'>
<font color=#447700>!*** CHECK WEIGHTS AT MASS AND VELOCITY POINTS<a name='524'></font>
<a name='525'>
     CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#WEIGTS_CHECK'>WEIGTS_CHECK</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WEIGTS_CHECK_1">(nest%HBWGT1,nest%HBWGT2,          &amp; <font color=#447700>! output weights on the nested grid<a name='526'></font>
                       nest%HBWGT3,nest%HBWGT4,          &amp;<a name='527'>
                       nest%VBWGT1,nest%VBWGT2,          &amp; <font color=#447700>! output weights on the nested grid<a name='528'></font>
                       nest%VBWGT3,nest%VBWGT4,          &amp;<a name='529'>
                       IDS,IDE,JDS,JDE,KDS,KDE,                  &amp; <font color=#447700>!<a name='530'></font>
                       IMS,IME,JMS,JME,KMS,KME,                  &amp; <font color=#447700>! nested grid configuration<a name='531'></font>
                       ITS,ITE,JTS,JTE,KTS,KTE                   )<a name='532'>
<a name='533'>
<font color=#447700>!*** CHECK DOMAIN BOUNDS BEFORE PROCEEDING TO INTERPOLATION<a name='534'></font>
<font color=#447700>!<a name='535'></font>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK'>BOUNDS_CHECK</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOUNDS_CHECK_1">( nest%IIH,nest%JJH,nest%IIV,nest%JJV,   &amp;<a name='536'>
                       nest%i_parent_start,nest%j_parent_start,nest%shw,      &amp;<a name='537'>
                       IDS,IDE,JDS,JDE,KDS,KDE,                               &amp; <font color=#447700>!<a name='538'></font>
                       IMS,IME,JMS,JME,KMS,KME,                               &amp; <font color=#447700>! nested grid configuration<a name='539'></font>
                       ITS,ITE,JTS,JTE,KTS,KTE                                )<a name='540'>
  ENDIF<a name='541'>
<a name='542'>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='543'></font>
<a name='544'>
END SUBROUTINE med_construct_egrid_weights <a name='545'>
<a name='546'>
<A NAME='MED_SET_EGRID_LOCS'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_SET_EGRID_LOCS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='547'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_set_egrid_locs</font> ( parent , nest ) <A href='../../call_to/MED_SET_EGRID_LOCS.html' TARGET='index'>2</A>,<A href='../../call_from/MED_SET_EGRID_LOCS.html' TARGET='index'>5</A><a name='548'>
 USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_SET_EGRID_LOCS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_80"><a name='549'>
 USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_SET_EGRID_LOCS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_45"><a name='550'>
 USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_SET_EGRID_LOCS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_8"><a name='551'>
<a name='552'>
 IMPLICIT NONE<a name='553'>
 TYPE(domain)             :: parent , nest<a name='554'>
 LOGICAL, EXTERNAL                  :: wrf_dm_on_monitor<a name='555'>
 INTEGER                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='556'>
 INTEGER                            :: IMS,IME,JMS,JME,KMS,KME<a name='557'>
 INTEGER                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='558'>
 INTEGER                            :: I,J,II,JJ,NII,NJJ<a name='559'>
 REAL                               :: parent_CLAT,parent_CLON,parent_WBD,parent_SBD,parent_DLMD,parent_DPHD<a name='560'>
 REAL                               :: nest_WBD,nest_SBD,nest_DLMD,nest_DPHD<a name='561'>
 REAL                               :: SW_LATD,SW_LOND<a name='562'>
 REAL                               :: ADDSUM1,ADDSUM2<a name='563'>
 REAL                               :: xr,zr,xc<a name='564'>
character*255 :: message<a name='565'>
<font color=#447700>!-----------------------------------------------------------------------------------------------------------<a name='566'></font>
<font color=#447700>!   PURPOSE: <a name='567'></font>
<font color=#447700>!           - Initialize lat-lons and determine weights <a name='568'></font>
<font color=#447700>!<a name='569'></font>
<font color=#447700>!----------------------------------------------------------------------------------------------------------<a name='570'></font>
<a name='571'>
<font color=#447700>!   First obtain central latitude and longitude for the parent domain<a name='572'></font>
<a name='573'>
    CALL nl_get_cen_lat (parent%ID, parent_CLAT)<a name='574'>
    CALL nl_get_cen_lon (parent%ID, parent_CLON)<a name='575'>
<a name='576'>
<font color=#447700>!   Parent grid configuration, including, western and southern boundary<a name='577'></font>
<a name='578'>
    IDS = parent%sd31<a name='579'>
    IDE = parent%ed31<a name='580'>
    JDS = parent%sd32<a name='581'>
    JDE = parent%ed32<a name='582'>
    KDS = parent%sd33<a name='583'>
    KDE = parent%ed33<a name='584'>
<a name='585'>
    IMS = parent%sm31<a name='586'>
    IME = parent%em31<a name='587'>
    JMS = parent%sm32<a name='588'>
    JME = parent%em32<a name='589'>
    KMS = parent%sm33<a name='590'>
    KME = parent%em33<a name='591'>
<a name='592'>
    ITS  = parent%sp31<a name='593'>
    ITE  = parent%ep31<a name='594'>
    JTS  = parent%sp32<a name='595'>
    JTE  = parent%ep32<a name='596'>
    KTS  = parent%sp33<a name='597'>
    KTE  = parent%ep33<a name='598'>
<font color=#447700>!<a name='599'></font>
    parent_DLMD = parent%dx                <font color=#447700>! DLMD: dlamda in degrees <a name='600'></font>
    parent_DPHD = parent%dy                <font color=#447700>! DPHD: dphi in degrees <a name='601'></font>
    parent_WBD  = parent%wbd0<a name='602'>
    parent_SBD  = parent%sbd0<a name='603'>
<a name='604'>
<font color=#447700>!   Now compute Geodetic lat/lon (Positive East) of parent grid in degrees<a name='605'></font>
<a name='606'>
  IF ( parent%active_this_task ) THEN<a name='607'>
<a name='608'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#EARTH_LATLON'>EARTH_LATLON</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_SET_EGRID_LOCS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EARTH_LATLON_3"> ( parent%HLAT,parent%HLON,parent%VLAT,parent%VLON,  &amp; <font color=#447700>!output<a name='609'></font>
                        parent_DLMD,parent_DPHD,parent_WBD,parent_SBD,                    &amp; <font color=#447700>!inputs <a name='610'></font>
                        parent_CLAT,parent_CLON,                                          &amp;<a name='611'>
                        IDS,IDE,JDS,JDE,KDS,KDE,                                          &amp;<a name='612'>
                        IMS,IME,JMS,JME,KMS,KME,                                          &amp;<a name='613'>
                        ITS,ITE,JTS,JTE,KTS,KTE                                           )<a name='614'>
  ENDIF<a name='615'>
<a name='616'>
    if(nest%id == parent%id) return <font color=#447700>! nothing more to do; same data structure<a name='617'></font>
<a name='618'>
<font color=#447700>!   Nested grid configuration, including, western and southern boundary<a name='619'></font>
<a name='620'>
    IDS = nest%sd31<a name='621'>
    IDE = nest%ed31<a name='622'>
    JDS = nest%sd32<a name='623'>
    JDE = nest%ed32<a name='624'>
    KDS = nest%sd33<a name='625'>
    KDE = nest%ed33<a name='626'>
<a name='627'>
    IMS = nest%sm31<a name='628'>
    IME = nest%em31<a name='629'>
    JMS = nest%sm32<a name='630'>
    JME = nest%em32<a name='631'>
    KMS = nest%sm33<a name='632'>
    KME = nest%em33<a name='633'>
<a name='634'>
    ITS  = nest%sp31<a name='635'>
    ITE  = nest%ep31<a name='636'>
    JTS  = nest%sp32<a name='637'>
    JTE  = nest%ep32<a name='638'>
    KTS  = nest%sp33<a name='639'>
    KTE  = nest%ep33<a name='640'>
<font color=#447700>!<a name='641'></font>
    nest_DLMD = nest%dx<a name='642'>
    nest_DPHD = nest%dy<a name='643'>
    nest_WBD  = nest%wbd0<a name='644'>
    nest_SBD  = nest%sbd0<a name='645'>
<a name='646'>
<font color=#447700>!<a name='647'></font>
<font color=#447700>!   Now compute Geodetic lat/lon (Positive East) of nest in degrees, with the same central lat-lon<a name='648'></font>
<font color=#447700>!   as the parent grid<a name='649'></font>
<font color=#447700>!<a name='650'></font>
<a name='651'>
  IF ( nest%active_this_task ) THEN<a name='652'>
<a name='653'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#EARTH_LATLON'>EARTH_LATLON</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_SET_EGRID_LOCS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EARTH_LATLON_4"> ( nest%HLAT,nest%HLON,nest%VLAT,nest%VLON, &amp; <font color=#447700>! output<a name='654'></font>
                        nest_DLMD,nest_DPHD,nest_WBD,nest_SBD,                   &amp; <font color=#447700>! nest inputs<a name='655'></font>
                        parent_CLAT,parent_CLON,                                 &amp; <font color=#447700>! parent central lat/lon<a name='656'></font>
                        IDS,IDE,JDS,JDE,KDS,KDE,                                 &amp; <font color=#447700>! nested domain dimension<a name='657'></font>
                        IMS,IME,JMS,JME,KMS,KME,                                 &amp;<a name='658'>
                        ITS,ITE,JTS,JTE,KTS,KTE                                  )<a name='659'>
  ENDIF<a name='660'>
  end SUBROUTINE med_set_egrid_locs<a name='661'>
<font color=#447700>!======================================================================================<a name='662'></font>
<font color=#447700>!<a name='663'></font>
<font color=#447700>! compute earth lat-lons for parent and the nest before interpolations<a name='664'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='665'></font>
<a name='666'>
<A NAME='EARTH_LATLON'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#EARTH_LATLON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='667'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>EARTH_LATLON</font> ( HLAT,HLON,VLAT,VLON,     &amp; <font color=#447700>!Earth lat,lon at H and V points <A href='../../call_to/EARTH_LATLON.html' TARGET='index'>5</A><a name='668'></font>
                          DLMD1,DPHD1,WBD1,SBD1,   &amp; <font color=#447700>!input res,west &amp; south boundaries,<a name='669'></font>
                          CENTRAL_LAT,CENTRAL_LON, &amp; <font color=#447700>! central lat,lon, all in degrees   <a name='670'></font>
                          IDS,IDE,JDS,JDE,KDS,KDE, &amp;  <a name='671'>
                          IMS,IME,JMS,JME,KMS,KME, &amp;<a name='672'>
                          ITS,ITE,JTS,JTE,KTS,KTE  )<a name='673'>
<font color=#447700>!============================================================================<a name='674'></font>
<font color=#447700>!<a name='675'></font>
 IMPLICIT NONE<a name='676'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='677'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME <a name='678'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE  <a name='679'>
 REAL,       INTENT(IN   )                            :: DLMD1,DPHD1,WBD1,SBD1<a name='680'>
 REAL,       INTENT(IN   )                            :: CENTRAL_LAT,CENTRAL_LON<a name='681'>
 REAL, DIMENSION(IMS:IME,JMS:JME), INTENT(OUT)        :: HLAT,HLON,VLAT,VLON<a name='682'>
<a name='683'>
<font color=#447700>! local<a name='684'></font>
<a name='685'>
<a name='686'>
 INTEGER,PARAMETER                           :: KNUM=SELECTED_REAL_KIND(13) <a name='687'>
 INTEGER                                     :: I,J<a name='688'>
 REAL(KIND=KNUM)                             :: WB,SB,DLM,DPH,TPH0,STPH0,CTPH0<a name='689'>
 REAL(KIND=KNUM)                             :: TDLM,TDPH,TLMH,TLMV,TLMH0,TLMV0,TPHH,TPHV,DTR<a name='690'>
 REAL(KIND=KNUM)                             :: STPH,CTPH,STPV,CTPV,PI_2<a name='691'>
 REAL(KIND=KNUM)                             :: SPHH,CLMH,FACTH,SPHV,CLMV,FACTV<a name='692'>
 REAL(KIND=KNUM), DIMENSION(IMS:IME,JMS:JME) :: GLATH,GLONH,GLATV,GLONV<a name='693'>
 REAL(KIND=KNUM) :: DLMD8,DPHD8,WBD8,SBD8,CLAT8,CLON8<a name='694'>
 REAL(KIND=KNUM) :: CPHH, CPHV<a name='695'>
<font color=#447700>!-------------------------------------------------------------------------<a name='696'></font>
 DLMD8=DLMD1<a name='697'>
 DPHD8=DPHD1<a name='698'>
 WBD8=WBD1<a name='699'>
 SBD8=SBD1<a name='700'>
 CLAT8=CENTRAL_LAT<a name='701'>
 CLON8=CENTRAL_LON<a name='702'>
<font color=#447700>!<a name='703'></font>
      PI_2 = ACOS(0.)<a name='704'>
      DTR  = PI_2/90.<a name='705'>
      WB   = WBD8 * DTR                 <font color=#447700>! WB:   western boundary in radians<a name='706'></font>
      SB   = SBD8 * DTR                 <font color=#447700>! SB:   southern boundary in radians<a name='707'></font>
      DLM  = DLMD8 * DTR                <font color=#447700>! DLM:  dlamda in radians <a name='708'></font>
      DPH  = DPHD8 * DTR                <font color=#447700>! DPH:  dphi   in radians<a name='709'></font>
      TDLM = DLM + DLM                  <font color=#447700>! TDLM: 2.0*dlamda <a name='710'></font>
      TDPH = DPH + DPH                  <font color=#447700>! TDPH: 2.0*DPH <a name='711'></font>
<a name='712'>
<font color=#447700>!     For earth lat lon only<a name='713'></font>
<a name='714'>
      TPH0  = CLAT8*DTR                <font color=#447700>! TPH0: central lat in radians <a name='715'></font>
      STPH0 = SIN(TPH0)<a name='716'>
      CTPH0 = COS(TPH0)<a name='717'>
<a name='718'>
                                                <font color=#447700>!    .H<a name='719'></font>
      DO J = JTS,MIN(JTE,JDE-1)                 <font color=#447700>! H./    This loop takes care of zig-zag <a name='720'></font>
<font color=#447700>!                                               !   \.H  starting points along j  <a name='721'></font>
         TLMH0 = WB - TDLM + MOD(J+1,2) * DLM   <font color=#447700>!  ./    TLMH (rotated lats at H points)<a name='722'></font>
         TLMV0 = WB - TDLM + MOD(J,2) * DLM     <font color=#447700>!  H     (//ly for V points) <a name='723'></font>
         TPHH = SB + (J-1)*DPH                  <font color=#447700>!   TPHH (rotated lons at H points) are simple trans.<a name='724'></font>
         TPHV = TPHH                            <font color=#447700>!   TPHV (rotated lons at V points) are simple trans.<a name='725'></font>
         STPH = SIN(TPHH)<a name='726'>
         CTPH = COS(TPHH)<a name='727'>
         STPV = SIN(TPHV)<a name='728'>
         CTPV = COS(TPHV)<a name='729'>
                                                              <font color=#447700>!   .H<a name='730'></font>
         DO I = ITS,MIN(ITE,IDE-1)                            <font color=#447700>!  / <a name='731'></font>
           TLMH = TLMH0 + I*TDLM                              <font color=#447700>!  \.H   .U   .H <a name='732'></font>
<font color=#447700>!                                                             !H./ ----&gt;&lt;----<a name='733'></font>
           SPHH = CTPH0 * STPH + STPH0 * CTPH * COS(TLMH)     <font color=#447700>!     DLM + DLM<a name='734'></font>
           CPHH = sqrt(1-SPHH**2)<a name='735'>
           GLATH(I,J)=ASIN(SPHH)                              <font color=#447700>! GLATH: Earth Lat in radians <a name='736'></font>
           <font color=#447700>!CLMH = CTPH*COS(TLMH)/(COS(GLATH(I,J))*CTPH0) &amp;<a name='737'></font>
           <font color=#447700>!     - TAN(GLATH(I,J))*TAN(TPH0)<a name='738'></font>
           CLMH = (CTPH*COS(TLMH)-SPHH*STPH0) / (CPHH*CTPH0)<a name='739'>
           IF(CLMH .GT. 1.) CLMH = 1.0<a name='740'>
           IF(CLMH .LT. -1.) CLMH = -1.0<a name='741'>
           FACTH = 1.<a name='742'>
           IF(TLMH .GT. 0.) FACTH = -1.<a name='743'>
           GLONH(I,J) = -CLON8*DTR + FACTH*ACOS(CLMH)<a name='744'>
<a name='745'>
         ENDDO                                    <a name='746'>
<a name='747'>
         DO I = ITS,MIN(ITE,IDE-1)<a name='748'>
           TLMV = TLMV0 + I*TDLM<a name='749'>
           SPHV = CTPH0 * STPV + STPH0 * CTPV * COS(TLMV)<a name='750'>
           CPHV = sqrt(1-SPHV**2)<a name='751'>
           GLATV(I,J) = ASIN(SPHV)<a name='752'>
           <font color=#447700>!CLMV = CTPV*COS(TLMV)/(COS(GLATV(I,J))*CTPH0) &amp;<a name='753'></font>
           <font color=#447700>!     - TAN(GLATV(I,J))*TAN(TPH0)<a name='754'></font>
           CLMV = (CTPV*COS(TLMV)-SPHV*STPH0) / (CPHV*CTPH0)<a name='755'>
           IF(CLMV .GT. 1.) CLMV = 1.<a name='756'>
           IF(CLMV .LT. -1.) CLMV = -1.<a name='757'>
           FACTV = 1.<a name='758'>
           IF(TLMV .GT. 0.) FACTV = -1.<a name='759'>
           GLONV(I,J) = -CLON8*DTR + FACTV*ACOS(CLMV)<a name='760'>
<a name='761'>
         ENDDO<a name='762'>
<a name='763'>
      ENDDO<a name='764'>
<a name='765'>
<font color=#447700>!     Conversion to degrees (may not be required, eventually)<a name='766'></font>
<a name='767'>
      DO J = JTS, MIN(JTE,JDE-1)<a name='768'>
       DO I = ITS, MIN(ITE,IDE-1)<a name='769'>
          HLAT(I,J) = GLATH(I,J) / DTR<a name='770'>
          HLON(I,J)= -GLONH(I,J)/DTR<a name='771'>
          IF(HLON(I,J) .GT. 180.) HLON(I,J) = HLON(I,J)  - 360.<a name='772'>
          IF(HLON(I,J) .LT. -180.) HLON(I,J) = HLON(I,J) + 360.<a name='773'>
<font color=#447700>!<a name='774'></font>
          VLAT(I,J) = GLATV(I,J) / DTR<a name='775'>
          VLON(I,J) = -GLONV(I,J) / DTR<a name='776'>
          IF(VLON(I,J) .GT. 180.) VLON(I,J) = VLON(I,J)  - 360.<a name='777'>
          IF(VLON(I,J) .LT. -180.) VLON(I,J) = VLON(I,J) + 360.<a name='778'>
<a name='779'>
       ENDDO<a name='780'>
      ENDDO<a name='781'>
<a name='782'>
END SUBROUTINE EARTH_LATLON<a name='783'>
<a name='784'>
<font color=#447700>!-----------------------------------------------------------------------------  <a name='785'></font>
<a name='786'>
<A NAME='INIT_HNEAR'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INIT_HNEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='787'>
<font color=#993300>subroutine </font><font color=#cc0000>init_hnear</font>(iih,jjh,hbwgt1,hbwgt2,hbwgt3,hbwgt4, &amp; <A href='../../call_to/INIT_HNEAR.html' TARGET='index'>2</A><a name='788'>
                      hnear_i,hnear_j,                     &amp;<a name='789'>
                      IDS,IDE,JDS,JDE,KDS,KDE,             &amp;<a name='790'>
                      IMS,IME,JMS,JME,KMS,KME,             &amp;<a name='791'>
                      ITS,ITE,JTS,JTE,KTS,KTE)<a name='792'>
  implicit none<a name='793'>
  integer, intent(in) :: ids,ide,jds,jde,kds,kde, &amp;<a name='794'>
                         ims,ime,jms,jme,kms,kme, &amp;<a name='795'>
                         its,ite,jts,jte,kts,kte, &amp;<a name='796'>
                         iih(ims:ime,jms:jme), jjh(ims:ime,jms:jme)<a name='797'>
  integer, dimension(ims:ime,jms:jme), intent(out) :: hnear_i,hnear_j<a name='798'>
  real, dimension(ims:ime,jms:jme), intent(in) :: hbwgt1, hbwgt2, hbwgt3, hbwgt4<a name='799'>
<a name='800'>
  integer :: i,j,iweight,a<a name='801'>
  real :: rweight<a name='802'>
<a name='803'>
  do j=jts,min(jte,jde-1)<a name='804'>
     do i=its,min(ite,ide-1)<a name='805'>
        a=1-mod(JJH(i,j),2)<a name='806'>
<a name='807'>
        iweight=1<a name='808'>
        rweight=hbwgt1(i,j)<a name='809'>
<a name='810'>
        if(hbwgt2(i,j)&gt;rweight) then<a name='811'>
           iweight=2 ; rweight=hbwgt2(i,j)<a name='812'>
        endif<a name='813'>
<a name='814'>
        if(hbwgt3(i,j)&gt;rweight) then<a name='815'>
           iweight=3 ; rweight=hbwgt3(i,j)<a name='816'>
        endif<a name='817'>
<a name='818'>
        if(hbwgt4(i,j)&gt;rweight) then<a name='819'>
           iweight=4<a name='820'>
        endif<a name='821'>
<a name='822'>
        select case(iweight)<a name='823'>
        case(1)<a name='824'>
           hnear_i(i,j)=IIH(I,J)   ; hnear_j(i,j)=JJH(I,J)<a name='825'>
        case(2)<a name='826'>
           hnear_i(i,j)=IIH(I,J)+1 ; hnear_j(i,j)=JJH(I,J)<a name='827'>
        case(3)<a name='828'>
           hnear_i(i,j)=IIH(I,J)+a ; hnear_j(i,j)=JJH(I,J)-1<a name='829'>
        case default <font color=#447700>! case(4)<a name='830'></font>
           hnear_i(i,j)=IIH(I,J)+a ; hnear_j(i,j)=JJH(I,J)+1<a name='831'>
        end select<a name='832'>
     enddo<a name='833'>
  enddo<a name='834'>
end subroutine init_hnear<a name='835'>
<a name='836'>
<font color=#447700>!-----------------------------------------------------------------------------  <a name='837'></font>
<a name='838'>
<A NAME='G2T2H'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='839'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>G2T2H</font>( IIH,JJH,                     &amp; <font color=#447700>! output grid index and weights  <A href='../../call_to/G2T2H.html' TARGET='index'>1</A>,<A href='../../call_from/G2T2H.html' TARGET='index'>6</A><a name='840'></font>
                    HBWGT1,HBWGT2,               &amp; <font color=#447700>! output weights in terms of parent grid<a name='841'></font>
                    HBWGT3,HBWGT4,               &amp; <a name='842'>
                    HLAT,HLON,                   &amp; <font color=#447700>! target (nest) input lat lon in degrees<a name='843'></font>
                    DLMD1,DPHD1,WBD1,SBD1,       &amp; <font color=#447700>! parent res, west and south boundaries<a name='844'></font>
                    CENTRAL_LAT,CENTRAL_LON,     &amp; <font color=#447700>! parent central lat,lon, all in degrees<a name='845'></font>
                    P_IDE,P_JDE,                 &amp; <font color=#447700>! parent imax and jmax<a name='846'></font>
                    IDS,IDE,JDS,JDE,KDS,KDE,     &amp; <font color=#447700>! target (nest) dIMEnsions<a name='847'></font>
                    IMS,IME,JMS,JME,KMS,KME,     &amp;<a name='848'>
                    ITS,ITE,JTS,JTE,KTS,KTE      )<a name='849'>
<a name='850'>
<font color=#447700>! <a name='851'></font>
<font color=#447700>!***  Tom Black   - Initial Version<a name='852'></font>
<font color=#447700>!***  Gopal       - Revised Version for WRF (includes coincident grid points) <a name='853'></font>
<font color=#447700>!*** <a name='854'></font>
<font color=#447700>!***  GIVEN PARENT CENTRAL LAT-LONS, RESOLUTION AND WESTERN AND SOUTHERN BOUNDARY,<a name='855'></font>
<font color=#447700>!***  AND THE NESTED GRID LAT-LONS AT H POINTS, THIS ROUTINE FIRST LOCATES THE <a name='856'></font>
<font color=#447700>!***  INDICES,IIH,JJH, OF THE PARENT DOMAIN'S H POINTS THAT LIES CLOSEST TO THE<a name='857'></font>
<font color=#447700>!***  h POINTS OF THE NESTED DOMAIN   <a name='858'></font>
<font color=#447700>!<a name='859'></font>
<font color=#447700>!============================================================================<a name='860'></font>
<font color=#447700>!<a name='861'></font>
 IMPLICIT NONE<a name='862'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='863'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='864'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='865'>
 INTEGER,    INTENT(IN   )                            :: P_IDE,P_JDE<a name='866'>
 REAL,       INTENT(IN   )                            :: DLMD1,DPHD1,WBD1,SBD1<a name='867'>
 REAL,       INTENT(IN   )                            :: CENTRAL_LAT,CENTRAL_LON<a name='868'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(IN)   :: HLAT,HLON<a name='869'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='870'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='871'>
<a name='872'>
<font color=#447700>! local<a name='873'></font>
<a name='874'>
 INTEGER,PARAMETER :: KNUM=SELECTED_REAL_KIND(13)<a name='875'>
 INTEGER           :: IMT,JMT,N2R,MK,K,I,J,DSLP0,DSLOPE<a name='876'>
 INTEGER           :: NROW,NCOL,KROWS<a name='877'>
 REAL(KIND=KNUM)   :: X,Y,Z,TLAT,TLON<a name='878'>
 REAL(KIND=KNUM)   :: PI_2,D2R,R2D,GLAT,GLON,DPH,DLM,TPH0,TLM0,WB,SB                <a name='879'>
 REAL(KIND=KNUM)   :: ROW,COL,SLP0,TLATHC,TLONHC,DENOM,SLOPE<a name='880'>
 REAL(KIND=KNUM)   :: TLAT1,TLAT2,TLON1,TLON2,DLM1,DLM2,DLM3,DLM4,D1,D2<a name='881'>
 REAL(KIND=KNUM)   :: DLA1,DLA2,DLA3,DLA4,S1,R1,DS1,AN1,AN2,AN3                    <font color=#447700>! Q<a name='882'></font>
 REAL(KIND=KNUM)   :: DL1,DL2,DL3,DL4,DL1I,DL2I,DL3I,DL4I,SUMDL,TLONO,TLATO <a name='883'>
 REAL(KIND=KNUM)   :: DTEMP<a name='884'>
 REAL   , DIMENSION(IMS:IME,JMS:JME)    :: TLATHX,TLONHX<a name='885'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME)    :: KOUTB<a name='886'>
<font color=#447700>!------------------------------------------------------------------------------- <a name='887'></font>
<a name='888'>
  IMT=2*P_IDE-2             <font color=#447700>! parent i dIMEnsions <a name='889'></font>
  JMT=P_JDE/2               <font color=#447700>! parent j dIMEnsions <a name='890'></font>
  PI_2=ACOS(0.)<a name='891'>
  D2R=PI_2/90.<a name='892'>
  R2D=1./D2R<a name='893'>
  DPH=DPHD1*D2R<a name='894'>
  DLM=DLMD1*D2R<a name='895'>
  TPH0= CENTRAL_LAT*D2R<a name='896'>
  TLM0=-CENTRAL_LON*D2R        <font color=#447700>! NOTE THE MINUS HERE<a name='897'></font>
  WB=WBD1*D2R                   <font color=#447700>! CONVERT NESTED GRID H POINTS FROM GEODETIC<a name='898'></font>
  SB=SBD1*D2R<a name='899'>
  SLP0=DPHD1/DLMD1<a name='900'>
  DSLP0=NINT(R2D*ATAN(SLP0))<a name='901'>
  DS1=SQRT(DPH*DPH+DLM*DLM)    <font color=#447700>! Q<a name='902'></font>
  AN1=ASIN(DLM/DS1)<a name='903'>
  AN2=ASIN(DPH/DS1)<a name='904'>
<a name='905'>
  DO J =  JTS,MIN(JTE,JDE-1) <a name='906'>
    DO I = ITS,MIN(ITE,IDE-1) <a name='907'>
<a name='908'>
<font color=#447700>!***<a name='909'></font>
<font color=#447700>!***  LOCATE TARGET h POINTS (HLAT AND HLON) ON THE PARENT DOMAIN AND<a name='910'></font>
<font color=#447700>!***  DETERMINE THE INDICES IN TERMS OF THE PARENT DOMAIN. FIRST <a name='911'></font>
<font color=#447700>!***  CONVERT NESTED GRID h POINTS FROM GEODETIC TO TRANSFORMED <a name='912'></font>
<font color=#447700>!***  COORDINATE ON THE PARENT GRID<a name='913'></font>
<font color=#447700>!<a name='914'></font>
<a name='915'>
      GLAT=HLAT(I,J)*D2R<a name='916'>
      GLON= (360. - HLON(I,J))*D2R<a name='917'>
      X=COS(TPH0)*COS(GLAT)*COS(GLON-TLM0)+SIN(TPH0)*SIN(GLAT)<a name='918'>
      Y=-COS(GLAT)*SIN(GLON-TLM0)<a name='919'>
      Z=COS(TPH0)*SIN(GLAT)-SIN(TPH0)*COS(GLAT)*COS(GLON-TLM0)<a name='920'>
      TLAT=R2D*ATAN(Z/SQRT(X*X+Y*Y))<a name='921'>
      TLON=R2D*ATAN(Y/X)<a name='922'>
<a name='923'>
<font color=#447700>!      ROW=TLAT/DPHD1+JMT         ! JMT IS THE CENTRAL ROW OF THE PARENT DOMAIN<a name='924'></font>
<font color=#447700>!      COL=TLON/DLMD1+P_IDE-1     ! (P_IDE-1) IS THE CENTRAL COLUMN OF THE PARENT DOMAIN <a name='925'></font>
<a name='926'>
      ROW=(TLAT-SBD1)/DPHD1+1     <font color=#447700>! Dusan's doing<a name='927'></font>
      COL=(TLON-WBD1)/DLMD1+1     <font color=#447700>! Dusan's doing<a name='928'></font>
<a name='929'>
      NROW=INT(ROW + 0.001)     <font color=#447700>! ROUND-OFF IS AVOIDED WITHOUT USING NINT ON PURPOSE<a name='930'></font>
      NCOL=INT(COL + 0.001)     <a name='931'>
      TLAT=TLAT*D2R<a name='932'>
      TLON=TLON*D2R<a name='933'>
<a name='934'>
<font color=#447700>!***  <a name='935'></font>
<font color=#447700>!***<a name='936'></font>
<font color=#447700>!***  FIRST CONSIDER THE SITUATION WHERE THE POINT h IS AT<a name='937'></font>
<font color=#447700>!***<a name='938'></font>
<font color=#447700>!***              V      H<a name='939'></font>
<font color=#447700>!***<a name='940'></font>
<font color=#447700>!***<a name='941'></font>
<font color=#447700>!***                 H           <a name='942'></font>
<font color=#447700>!***              H      V<a name='943'></font>
<font color=#447700>!***<a name='944'></font>
<font color=#447700>!***  THEN LOCATE THE NEAREST H POINT ON THE PARENT GRID<a name='945'></font>
<font color=#447700>!***<a name='946'></font>
      IF(MOD(NROW,2).EQ.1.AND.MOD(NCOL,2).EQ.1.OR.     &amp;     <a name='947'>
         MOD(NROW,2).EQ.0.AND.MOD(NCOL,2).EQ.0)THEN        <a name='948'>
           TLAT1=(NROW-JMT)*DPH                           <a name='949'>
           TLAT2=TLAT1+DPH                              <a name='950'>
           TLON1=(NCOL-(P_IDE-1))*DLM                                   <a name='951'>
           TLON2=TLON1+DLM                                 <a name='952'>
           DLM1=TLON-TLON1                                 <a name='953'>
           DLM2=TLON-TLON2<a name='954'>
<font color=#447700>!           D1=ACOS(COS(TLAT)*COS(TLAT1)*COS(DLM1)+SIN(TLAT)*SIN(TLAT1))<a name='955'></font>
<font color=#447700>!           D2=ACOS(COS(TLAT)*COS(TLAT2)*COS(DLM2)+SIN(TLAT)*SIN(TLAT2))<a name='956'></font>
           DTEMP=MIN(1.0_KNUM,COS(TLAT)*COS(TLAT1)*COS(DLM1)+SIN(TLAT)*SIN(TLAT1))<a name='957'>
           D1=ACOS(DTEMP)<a name='958'>
           DTEMP=MIN(1.0_KNUM,COS(TLAT)*COS(TLAT2)*COS(DLM2)+SIN(TLAT)*SIN(TLAT2))<a name='959'>
           D2=ACOS(DTEMP)<a name='960'>
            IF(D1.GT.D2)THEN<a name='961'>
             NROW=NROW+1                    <font color=#447700>! FIND THE NEAREST H ROW<a name='962'></font>
             NCOL=NCOL+1                    <font color=#447700>! FIND THE NEAREST H COLUMN<a name='963'></font>
            ENDIF <a name='964'>
      ELSE<a name='965'>
<font color=#447700>!***<a name='966'></font>
<font color=#447700>!***  NOW CONSIDER THE SITUATION WHERE THE POINT h IS AT<a name='967'></font>
<font color=#447700>!***<a name='968'></font>
<font color=#447700>!***              H      V<a name='969'></font>
<font color=#447700>!***<a name='970'></font>
<font color=#447700>!***<a name='971'></font>
<font color=#447700>!***                 H <a name='972'></font>
<font color=#447700>!***              V      H<a name='973'></font>
<font color=#447700>!***<a name='974'></font>
<font color=#447700>!***  THEN LOCATE THE NEAREST H POINT ON THE PARENT GRID<a name='975'></font>
<font color=#447700>!***<a name='976'></font>
<font color=#447700>!***<a name='977'></font>
           TLAT1=(NROW+1-JMT)*DPH<a name='978'>
           TLAT2=TLAT1-DPH<a name='979'>
           TLON1=(NCOL-(P_IDE-1))*DLM<a name='980'>
           TLON2=TLON1+DLM<a name='981'>
           DLM1=TLON-TLON1<a name='982'>
           DLM2=TLON-TLON2<a name='983'>
<font color=#447700>!           D1=ACOS(COS(TLAT)*COS(TLAT1)*COS(DLM1)+SIN(TLAT)*SIN(TLAT1))<a name='984'></font>
<font color=#447700>!           D2=ACOS(COS(TLAT)*COS(TLAT2)*COS(DLM2)+SIN(TLAT)*SIN(TLAT2))<a name='985'></font>
           DTEMP=MIN(1.0_KNUM,COS(TLAT)*COS(TLAT1)*COS(DLM1)+SIN(TLAT)*SIN(TLAT1))<a name='986'>
           D1=ACOS(DTEMP)<a name='987'>
           DTEMP=MIN(1.0_KNUM,COS(TLAT)*COS(TLAT2)*COS(DLM2)+SIN(TLAT)*SIN(TLAT2))<a name='988'>
           D2=ACOS(DTEMP)<a name='989'>
             IF(D1.LT.D2)THEN<a name='990'>
              NROW=NROW+1                    <font color=#447700>! FIND THE NEAREST H ROW<a name='991'></font>
             ELSE<a name='992'>
              NCOL=NCOL+1                    <font color=#447700>! FIND THE NEAREST H COLUMN<a name='993'></font>
             ENDIF<a name='994'>
      ENDIF<a name='995'>
<a name='996'>
      KROWS=((NROW-1)/2)*IMT<a name='997'>
      IF(MOD(NROW,2).EQ.1)THEN<a name='998'>
        K=KROWS+(NCOL+1)/2<a name='999'>
      ELSE<a name='1000'>
        K=KROWS+P_IDE-1+NCOL/2<a name='1001'>
      ENDIF<a name='1002'>
<a name='1003'>
<font color=#447700>!***<a name='1004'></font>
<font color=#447700>!***  WE NOW KNOW THAT THE INNER GRID POINT IN QUESTION IS<a name='1005'></font>
<font color=#447700>!***  NEAREST TO THE CENTER K AS SEEN BELOW.  WE MUST FIND<a name='1006'></font>
<font color=#447700>!***  WHICH OF THE FOUR H-BOXES (OF WHICH THIS H POINT IS<a name='1007'></font>
<font color=#447700>!***  A VERTEX) SURROUNDS THE INNER GRID h POINT IN QUESTION.<a name='1008'></font>
<font color=#447700>!***<a name='1009'></font>
<font color=#447700>!**<a name='1010'></font>
<font color=#447700>!***                  H<a name='1011'></font>
<font color=#447700>!***<a name='1012'></font>
<font color=#447700>!***<a name='1013'></font>
<font color=#447700>!***<a name='1014'></font>
<font color=#447700>!***            H     V     H<a name='1015'></font>
<font color=#447700>!***<a name='1016'></font>
<font color=#447700>!***<a name='1017'></font>
<font color=#447700>!***               H<a name='1018'></font>
<font color=#447700>!***      H     V     H     V     H<a name='1019'></font>
<font color=#447700>!***<a name='1020'></font>
<font color=#447700>!***<a name='1021'></font>
<font color=#447700>!***<a name='1022'></font>
<font color=#447700>!***            H     V     H<a name='1023'></font>
<font color=#447700>!***<a name='1024'></font>
<font color=#447700>!***<a name='1025'></font>
<font color=#447700>!***<a name='1026'></font>
<font color=#447700>!***                  H<a name='1027'></font>
<font color=#447700>!***<a name='1028'></font>
<font color=#447700>!***<a name='1029'></font>
<font color=#447700>!***  FIND THE SLOPE OF THE LINE CONNECTING h AND THE CENTER H.<a name='1030'></font>
<font color=#447700>!***<a name='1031'></font>
    N2R=K/IMT<a name='1032'>
    MK=MOD(K,IMT)<a name='1033'>
<font color=#447700>!<a name='1034'></font>
    IF(MK.EQ.0)THEN<a name='1035'>
      TLATHC=SB+(2*N2R-1)*DPH<a name='1036'>
    ELSE<a name='1037'>
      TLATHC=SB+(2*N2R+(MK-1)/(P_IDE-1))*DPH<a name='1038'>
    ENDIF<a name='1039'>
<font color=#447700>!<a name='1040'></font>
    IF(MK.LE.(P_IDE-1))THEN<a name='1041'>
      TLONHC=WB+2*(MK-1)*DLM<a name='1042'>
    ELSE<a name='1043'>
      TLONHC=WB+(2*(MK-(P_IDE-1))-1)*DLM<a name='1044'>
    ENDIF<a name='1045'>
  <a name='1046'>
<font color=#447700>!<a name='1047'></font>
<font color=#447700>!***  EXECUTE CAUTION IF YOU NEED TO CHANGE THESE CONDITIONS. SINCE WE ARE<a name='1048'></font>
<font color=#447700>!***  DEALING WITH SLOPES TO GENERATE DIAMOND SHAPE H BOXES, WE NEED TO BE<a name='1049'></font>
<font color=#447700>!***  CAREFUL HERE      <a name='1050'></font>
<font color=#447700>!<a name='1051'></font>
<a name='1052'>
    IF(ABS(TLON-TLONHC) .LE. 1.E-4)TLONHC=TLON<a name='1053'>
    IF(ABS(TLAT-TLATHC) .LE. 1.E-4)TLATHC=TLAT<a name='1054'>
    DENOM=(TLON-TLONHC)<a name='1055'>
<font color=#447700>!<a name='1056'></font>
<font color=#447700>!***<a name='1057'></font>
<font color=#447700>!***STORE THE LOCATION OF THE WESTERNMOST VERTEX OF THE H-BOX ON<a name='1058'></font>
<font color=#447700>!***THE OUTER GRID THAT SURROUNDS THE h POINT ON THE INNER GRID.<a name='1059'></font>
<font color=#447700>!***<a name='1060'></font>
<font color=#447700>!*** COINCIDENT CONDITIONS<a name='1061'></font>
<a name='1062'>
    IF(DENOM.EQ.0.0)THEN<a name='1063'>
<a name='1064'>
      IF(TLATHC.EQ.TLAT)THEN<a name='1065'>
        KOUTB(I,J)=K<a name='1066'>
        IIH(I,J) = NCOL<a name='1067'>
        JJH(I,J) = NROW<a name='1068'>
        TLATHX(I,J)=TLATHC<a name='1069'>
        TLONHX(I,J)=TLONHC<a name='1070'>
        HBWGT1(I,J)=1.0<a name='1071'>
        HBWGT2(I,J)=0.0<a name='1072'>
        HBWGT3(I,J)=0.0<a name='1073'>
        HBWGT4(I,J)=0.0<a name='1074'>
      ELSE                                      <font color=#447700>! SAME LONGITUDE BUT DIFFERENT LATS<a name='1075'></font>
<font color=#447700>!<a name='1076'></font>
         IF(TLATHC .GT. TLAT)THEN      <font color=#447700>! NESTED POINT SOUTH OF PARENT<a name='1077'></font>
          KOUTB(I,J)=K-(P_IDE-1)<a name='1078'>
          IIH(I,J) = NCOL-1<a name='1079'>
          JJH(I,J) = NROW-1<a name='1080'>
          TLATHX(I,J)=TLATHC-DPH<a name='1081'>
          TLONHX(I,J)=TLONHC-DLM<a name='1082'>
         ELSE                                   <font color=#447700>! NESTED POINT NORTH OF PARENT<a name='1083'></font>
          KOUTB(I,J)=K+(P_IDE-1)-1<a name='1084'>
          IIH(I,J) = NCOL-1<a name='1085'>
          JJH(I,J) = NROW+1<a name='1086'>
          TLATHX(I,J)=TLATHC+DPH<a name='1087'>
          TLONHX(I,J)=TLONHC-DLM<a name='1088'>
         ENDIF<a name='1089'>
<font color=#447700>!***<a name='1090'></font>
<font color=#447700>!***<a name='1091'></font>
<font color=#447700>!***                  4<a name='1092'></font>
<font color=#447700>!***<a name='1093'></font>
<font color=#447700>!***                  H<a name='1094'></font>
<font color=#447700>!***             1         2<a name='1095'></font>
<font color=#447700>!***<a name='1096'></font>
<font color=#447700>!***                  3<a name='1097'></font>
<font color=#447700>!***  DL 1-4 ARE THE ANGULAR DISTANCES FROM h TO EACH VERTEX<a name='1098'></font>
<a name='1099'>
       TLATO=TLATHX(I,J)<a name='1100'>
       TLONO=TLONHX(I,J)<a name='1101'>
       DLM1=TLON-TLONO<a name='1102'>
       DLA1=TLAT-TLATO                                               <font color=#447700>! Q<a name='1103'></font>
<font color=#447700>!      DL1=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM1)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1104'></font>
       DL1=SQRT(DLM1*DLM1+DLA1*DLA1)                                 <font color=#447700>! Q <a name='1105'></font>
<font color=#447700>!<a name='1106'></font>
       TLATO=TLATHX(I,J)<a name='1107'>
       TLONO=TLONHX(I,J)+2.*DLM<a name='1108'>
       DLM2=TLON-TLONO<a name='1109'>
       DLA2=TLAT-TLATO                                               <font color=#447700>! Q<a name='1110'></font>
<font color=#447700>!      DL2=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM2)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1111'></font>
       DL2=SQRT(DLM2*DLM2+DLA2*DLA2)                                 <font color=#447700>! Q<a name='1112'></font>
<font color=#447700>! <a name='1113'></font>
       TLATO=TLATHX(I,J)-DPH<a name='1114'>
       TLONO=TLONHX(I,J)+DLM<a name='1115'>
       DLM3=TLON-TLONO<a name='1116'>
       DLA3=TLAT-TLATO                                               <font color=#447700>! Q<a name='1117'></font>
<font color=#447700>!      DL3=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM3)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1118'></font>
       DL3=SQRT(DLM3*DLM3+DLA3*DLA3)                                 <font color=#447700>! Q<a name='1119'></font>
 <a name='1120'>
       TLATO=TLATHX(I,J)+DPH<a name='1121'>
       TLONO=TLONHX(I,J)+DLM<a name='1122'>
       DLM4=TLON-TLONO<a name='1123'>
       DLA4=TLAT-TLATO                                               <font color=#447700>! Q<a name='1124'></font>
<font color=#447700>!      DL4=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM4)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1125'></font>
       DL4=SQRT(DLM4*DLM4+DLA4*DLA4)                                 <font color=#447700>! Q<a name='1126'></font>
<a name='1127'>
<a name='1128'>
<font color=#447700>!      THE BILINEAR WEIGHTS<a name='1129'></font>
<font color=#447700>!***<a name='1130'></font>
<font color=#447700>!***<a name='1131'></font>
       AN3=ATAN2(DLA1,DLM1)                                          <font color=#447700>! Q<a name='1132'></font>
       R1=DL1*SIN(AN2-AN3)/SIN(2.*AN1)<a name='1133'>
       S1=DL1*SIN(2.*PI_2-2*AN1-AN2+AN3)/SIN(2.*AN1)<a name='1134'>
       R1=R1/DS1<a name='1135'>
       S1=S1/DS1<a name='1136'>
       DL1I=(1.-R1)*(1.-S1)<a name='1137'>
       DL2I=R1*S1<a name='1138'>
       DL3I=R1*(1.-S1)<a name='1139'>
       DL4I=(1.-R1)*S1<a name='1140'>
<font color=#447700>!<a name='1141'></font>
       HBWGT1(I,J)=DL1I<a name='1142'>
       HBWGT2(I,J)=DL2I<a name='1143'>
       HBWGT3(I,J)=DL3I<a name='1144'>
       HBWGT4(I,J)=DL4I<a name='1145'>
<font color=#447700>! <a name='1146'></font>
      ENDIF<a name='1147'>
<a name='1148'>
    ELSE<a name='1149'>
<font color=#447700>!<a name='1150'></font>
<font color=#447700>!*** NON-COINCIDENT POINTS   <a name='1151'></font>
<font color=#447700>!<a name='1152'></font>
      SLOPE=(TLAT-TLATHC)/DENOM<a name='1153'>
      DSLOPE=NINT(R2D*ATAN(SLOPE))<a name='1154'>
<a name='1155'>
      IF(DSLOPE.LE.DSLP0.AND.DSLOPE.GE.-DSLP0)THEN<a name='1156'>
        IF(TLON.GT.TLONHC)THEN<a name='1157'>
          IF(TLONHC.GE.-WB-DLM)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_115">("1H:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1158'>
          KOUTB(I,J)=K<a name='1159'>
          IIH(I,J) = NCOL<a name='1160'>
          JJH(I,J) = NROW<a name='1161'>
          TLATHX(I,J)=TLATHC<a name='1162'>
          TLONHX(I,J)=TLONHC<a name='1163'>
        ELSE<a name='1164'>
          IF(TLONHC.LE.WB+DLM)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_116">("2H:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1165'>
          KOUTB(I,J)=K-1<a name='1166'>
          IIH(I,J) = NCOL-2<a name='1167'>
          JJH(I,J) = NROW<a name='1168'>
          TLATHX(I,J)=TLATHC<a name='1169'>
          TLONHX(I,J)=TLONHC -2.*DLM<a name='1170'>
        ENDIF<a name='1171'>
<a name='1172'>
<font color=#447700>!<a name='1173'></font>
      ELSEIF(DSLOPE.GT.DSLP0)THEN<a name='1174'>
        IF(TLON.GT.TLONHC)THEN<a name='1175'>
          IF(TLATHC.GE.-SB-DPH)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_117">("3H:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1176'>
          KOUTB(I,J)=K+(P_IDE-1)-1<a name='1177'>
          IIH(I,J) = NCOL-1<a name='1178'>
          JJH(I,J) = NROW+1<a name='1179'>
          TLATHX(I,J)=TLATHC+DPH<a name='1180'>
          TLONHX(I,J)=TLONHC-DLM<a name='1181'>
        ELSE<a name='1182'>
          IF(TLATHC.LE.SB+DPH)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_118">("4H:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1183'>
          KOUTB(I,J)=K-(P_IDE-1)<a name='1184'>
          IIH(I,J) = NCOL-1<a name='1185'>
          JJH(I,J) = NROW-1<a name='1186'>
          TLATHX(I,J)=TLATHC-DPH<a name='1187'>
          TLONHX(I,J)=TLONHC-DLM<a name='1188'>
        ENDIF<a name='1189'>
<a name='1190'>
<font color=#447700>!<a name='1191'></font>
      ELSEIF(DSLOPE.LT.-DSLP0)THEN<a name='1192'>
        IF(TLON.GT.TLONHC)THEN<a name='1193'>
          IF(TLATHC.LE.SB+DPH)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_119">("5H:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1194'>
          KOUTB(I,J)=K-(P_IDE-1)<a name='1195'>
          IIH(I,J) = NCOL-1<a name='1196'>
          JJH(I,J) = NROW-1<a name='1197'>
          TLATHX(I,J)=TLATHC-DPH<a name='1198'>
          TLONHX(I,J)=TLONHC-DLM<a name='1199'>
        ELSE<a name='1200'>
          IF(TLATHC.GE.-SB-DPH)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_120">("6H:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1201'>
          KOUTB(I,J)=K+(P_IDE-1)-1<a name='1202'>
          IIH(I,J) = NCOL-1<a name='1203'>
          JJH(I,J) = NROW+1<a name='1204'>
          TLATHX(I,J)=TLATHC+DPH<a name='1205'>
          TLONHX(I,J)=TLONHC-DLM<a name='1206'>
        ENDIF<a name='1207'>
      ENDIF<a name='1208'>
<a name='1209'>
<font color=#447700>!<a name='1210'></font>
<font color=#447700>!***  NOW WE WILL MOVE AS FOLLOWS:<a name='1211'></font>
<font color=#447700>!***<a name='1212'></font>
<font color=#447700>!***<a name='1213'></font>
<font color=#447700>!***                      4<a name='1214'></font>
<font color=#447700>!***<a name='1215'></font>
<font color=#447700>!***<a name='1216'></font>
<font color=#447700>!***  <a name='1217'></font>
<font color=#447700>!***                   H<a name='1218'></font>
<font color=#447700>!***             1                 2<a name='1219'></font>
<font color=#447700>!***<a name='1220'></font>
<font color=#447700>!***<a name='1221'></font>
<font color=#447700>!***<a name='1222'></font>
<font color=#447700>!***<a name='1223'></font>
<font color=#447700>!***                      3<a name='1224'></font>
<font color=#447700>!***<a name='1225'></font>
<font color=#447700>!***<a name='1226'></font>
<font color=#447700>!***<a name='1227'></font>
<font color=#447700>!***  DL 1-4 ARE THE ANGULAR DISTANCES FROM h TO EACH VERTEX<a name='1228'></font>
      <a name='1229'>
      TLATO=TLATHX(I,J)<a name='1230'>
      TLONO=TLONHX(I,J)<a name='1231'>
      DLM1=TLON-TLONO<a name='1232'>
      DLA1=TLAT-TLATO                                               <font color=#447700>! Q<a name='1233'></font>
<font color=#447700>!     DL1=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM1)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1234'></font>
      DL1=SQRT(DLM1*DLM1+DLA1*DLA1)                                 <font color=#447700>! Q<a name='1235'></font>
<font color=#447700>!<a name='1236'></font>
      TLATO=TLATHX(I,J)                                             <font color=#447700>! redundant computations<a name='1237'></font>
      TLONO=TLONHX(I,J)+2.*DLM<a name='1238'>
      DLM2=TLON-TLONO<a name='1239'>
      DLA2=TLAT-TLATO                                               <font color=#447700>! Q<a name='1240'></font>
<font color=#447700>!     DL2=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM2)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1241'></font>
      DL2=SQRT(DLM2*DLM2+DLA2*DLA2)                                 <font color=#447700>! Q<a name='1242'></font>
<font color=#447700>!<a name='1243'></font>
      TLATO=TLATHX(I,J)-DPH<a name='1244'>
      TLONO=TLONHX(I,J)+DLM<a name='1245'>
      DLM3=TLON-TLONO<a name='1246'>
      DLA3=TLAT-TLATO                                               <font color=#447700>! Q<a name='1247'></font>
<font color=#447700>!     DL3=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM3)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1248'></font>
      DL3=SQRT(DLM3*DLM3+DLA3*DLA3)                                 <font color=#447700>! Q<a name='1249'></font>
<font color=#447700>!<a name='1250'></font>
      TLATO=TLATHX(I,J)+DPH<a name='1251'>
      TLONO=TLONHX(I,J)+DLM<a name='1252'>
      DLM4=TLON-TLONO<a name='1253'>
      DLA4=TLAT-TLATO                                               <font color=#447700>! Q<a name='1254'></font>
<font color=#447700>!     DL4=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM4)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1255'></font>
      DL4=SQRT(DLM4*DLM4+DLA4*DLA4)                                 <font color=#447700>! Q<a name='1256'></font>
<a name='1257'>
<font color=#447700>!     THE BILINEAR WEIGHTS<a name='1258'></font>
<font color=#447700>!***<a name='1259'></font>
      AN3=ATAN2(DLA1,DLM1)                                          <font color=#447700>! Q<a name='1260'></font>
      R1=DL1*SIN(AN2-AN3)/SIN(2.*AN1)<a name='1261'>
      S1=DL1*SIN(2.*PI_2-2*AN1-AN2+AN3)/SIN(2.*AN1)<a name='1262'>
      R1=R1/DS1<a name='1263'>
      S1=S1/DS1<a name='1264'>
      DL1I=(1.-R1)*(1.-S1)<a name='1265'>
      DL2I=R1*S1<a name='1266'>
      DL3I=R1*(1.-S1)<a name='1267'>
      DL4I=(1.-R1)*S1<a name='1268'>
<font color=#447700>!<a name='1269'></font>
      HBWGT1(I,J)=DL1I<a name='1270'>
      HBWGT2(I,J)=DL2I<a name='1271'>
      HBWGT3(I,J)=DL3I<a name='1272'>
      HBWGT4(I,J)=DL4I<a name='1273'>
<font color=#447700>!<a name='1274'></font>
    ENDIF <a name='1275'>
<a name='1276'>
<font color=#447700>!<a name='1277'></font>
<font color=#447700>!***  FINALLY STORE IIH IN TERMS OF E-GRID INDEX<a name='1278'></font>
<font color=#447700>!<a name='1279'></font>
      IIH(I,J)=NINT(0.5*IIH(I,J))<a name='1280'>
<a name='1281'>
      HBWGT1(I,J)=MAX(HBWGT1(I,J),0.0)   <font color=#447700>! all weights must be GE zero (postive def)<a name='1282'></font>
      HBWGT2(I,J)=MAX(HBWGT2(I,J),0.0)   <font color=#447700>! all weights must be GE zero (postive def)<a name='1283'></font>
      HBWGT3(I,J)=MAX(HBWGT3(I,J),0.0)   <font color=#447700>! all weights must be GE zero (postive def)<a name='1284'></font>
      HBWGT4(I,J)=MAX(HBWGT4(I,J),0.0)   <font color=#447700>! all weights must be GE zero (postive def)<a name='1285'></font>
<a name='1286'>
<font color=#447700>!      write(message,105)"H WEIGHTS:",I,J,HBWGT1(I,J),HBWGT2(I,J),HBWGT3(I,J),HBWGT4(I,J), &amp;<a name='1287'></font>
<font color=#447700>!                               HBWGT1(I,J)+HBWGT2(I,J)+HBWGT3(I,J)+HBWGT4(I,J),IIH(i,j),JJH(i,j)<a name='1288'></font>
<font color=#447700>!      CALL wrf_message(trim(message))<a name='1289'></font>
<font color=#447700>! 105  format(a,2i4,5f7.3,2i4)<a name='1290'></font>
<a name='1291'>
   ENDDO<a name='1292'>
  ENDDO<a name='1293'>
<a name='1294'>
<a name='1295'>
  RETURN <a name='1296'>
  END SUBROUTINE G2T2H<a name='1297'>
<font color=#447700>!========================================================================================<a name='1298'></font>
<a name='1299'>
<a name='1300'>
<A NAME='G2T2V'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1301'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>G2T2V</font>( IIV,JJV,                     &amp; <font color=#447700>! output grid index and weights <A href='../../call_to/G2T2V.html' TARGET='index'>1</A>,<A href='../../call_from/G2T2V.html' TARGET='index'>6</A><a name='1302'></font>
                    VBWGT1,VBWGT2,               &amp; <font color=#447700>! output weights in terms of parent grid<a name='1303'></font>
                    VBWGT3,VBWGT4,               &amp;<a name='1304'>
                    VLAT,VLON,                   &amp; <font color=#447700>! target (nest) input lat lon in degrees<a name='1305'></font>
                    DLMD1,DPHD1,WBD1,SBD1,       &amp; <font color=#447700>! parent res, west and south boundaries<a name='1306'></font>
                    CENTRAL_LAT,CENTRAL_LON,     &amp; <font color=#447700>! parent central lat,lon, all in degrees<a name='1307'></font>
                    P_IDE,P_JDE,                 &amp; <font color=#447700>! parent imax and jmax<a name='1308'></font>
                    IDS,IDE,JDS,JDE,KDS,KDE,     &amp; <font color=#447700>! target (nest) dIMEnsions<a name='1309'></font>
                    IMS,IME,JMS,JME,KMS,KME,     &amp;<a name='1310'>
                    ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1311'>
<a name='1312'>
<font color=#447700>!<a name='1313'></font>
<font color=#447700>!***  Tom Black   - Initial Version <a name='1314'></font>
<font color=#447700>!***  Gopal       - Revised Version for WRF (includes coincIDEnt grid points)<a name='1315'></font>
<font color=#447700>!***<a name='1316'></font>
<font color=#447700>!***  GIVEN PARENT CENTRAL LAT-LONS, RESOLUTION AND WESTERN AND SOUTHERN BOUNDARY,<a name='1317'></font>
<font color=#447700>!***  AND THE NESTED GRID LAT-LONS AT V POINTS, THIS ROUTINE FIRST LOCATES THE<a name='1318'></font>
<font color=#447700>!***  INDICES,IIV,JJV, OF THE PARENT DOMAIN'S V POINTS THAT LIES CLOSEST TO THE<a name='1319'></font>
<font color=#447700>!***  V POINTS OF THE NESTED DOMAIN<a name='1320'></font>
<font color=#447700>!<a name='1321'></font>
<font color=#447700>!============================================================================<a name='1322'></font>
<a name='1323'>
 IMPLICIT NONE<a name='1324'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1325'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='1326'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1327'>
 INTEGER,    INTENT(IN   )                            :: P_IDE,P_JDE<a name='1328'>
 REAL,       INTENT(IN   )                            :: DLMD1,DPHD1,WBD1,SBD1<a name='1329'>
 REAL,       INTENT(IN   )                            :: CENTRAL_LAT,CENTRAL_LON<a name='1330'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),   INTENT(IN)    :: VLAT,VLON<a name='1331'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),   INTENT(OUT)   :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='1332'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),   INTENT(OUT)   :: IIV,JJV<a name='1333'>
<a name='1334'>
<font color=#447700>! local<a name='1335'></font>
<a name='1336'>
 INTEGER,PARAMETER :: KNUM=SELECTED_REAL_KIND(13)     <font color=#447700>! (6) single precision<a name='1337'></font>
 INTEGER           :: IMT,JMT,N2R,MK,K,I,J,DSLP0,DSLOPE<a name='1338'>
 INTEGER           :: NROW,NCOL,KROWS<a name='1339'>
 REAL(KIND=KNUM)   :: X,Y,Z,TLAT,TLON<a name='1340'>
 REAL(KIND=KNUM)   :: PI_2,D2R,R2D,GLAT,GLON,DPH,DLM,TPH0,TLM0,WB,SB<a name='1341'>
 REAL(KIND=KNUM)   :: ROW,COL,SLP0,TLATVC,TLONVC,DENOM,SLOPE<a name='1342'>
 REAL(KIND=KNUM)   :: TLAT1,TLAT2,TLON1,TLON2,DLM1,DLM2,DLM3,DLM4,D1,D2<a name='1343'>
 REAL(KIND=KNUM)   :: DLA1,DLA2,DLA3,DLA4,S1,R1,DS1,AN1,AN2,AN3                    <font color=#447700>! Q<a name='1344'></font>
 REAL(KIND=KNUM)   :: DL1,DL2,DL3,DL4,DL1I,DL2I,DL3I,DL4I,SUMDL,TLONO,TLATO<a name='1345'>
 REAL(KIND=KNUM)   :: DTEMP<a name='1346'>
 REAL  , DIMENSION(IMS:IME,JMS:JME)      :: TLATVX,TLONVX<a name='1347'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME)     :: KOUTB<a name='1348'>
<font color=#447700>!-------------------------------------------------------------------------------------<a name='1349'></font>
<a name='1350'>
  IMT=2*P_IDE-2             <font color=#447700>! parent i dIMEnsions<a name='1351'></font>
  JMT=P_JDE/2               <font color=#447700>! parent j dIMEnsions<a name='1352'></font>
  PI_2=ACOS(0.)<a name='1353'>
  D2R=PI_2/90.<a name='1354'>
  R2D=1./D2R<a name='1355'>
  DPH=DPHD1*D2R<a name='1356'>
  DLM=DLMD1*D2R<a name='1357'>
  TPH0= CENTRAL_LAT*D2R<a name='1358'>
  TLM0=-CENTRAL_LON*D2R        <font color=#447700>! NOTE THE MINUS HERE<a name='1359'></font>
  WB=WBD1*D2R                   <font color=#447700>! DEGREES TO RADIANS<a name='1360'></font>
  SB=SBD1*D2R<a name='1361'>
  SLP0=DPHD1/DLMD1<a name='1362'>
  DSLP0=NINT(R2D*ATAN(SLP0))<a name='1363'>
  DS1=SQRT(DPH*DPH+DLM*DLM)    <font color=#447700>! Q<a name='1364'></font>
  AN1=ASIN(DLM/DS1)<a name='1365'>
  AN2=ASIN(DPH/DS1)<a name='1366'>
<a name='1367'>
  DO J =  JTS,MIN(JTE,JDE-1)<a name='1368'>
    DO I = ITS,MIN(ITE,IDE-1)<a name='1369'>
<font color=#447700>!***<a name='1370'></font>
<font color=#447700>!***  LOCATE TARGET V POINTS (VLAT AND VLON) ON THE PARENT DOMAIN AND<a name='1371'></font>
<font color=#447700>!***  DETERMINE THE INDICES IN TERMS OF THE PARENT DOMAIN. FIRST<a name='1372'></font>
<font color=#447700>!***  CONVERT NESTED GRID V POINTS FROM GEODETIC TO TRANSFORMED<a name='1373'></font>
<font color=#447700>!***  COORDINATE ON THE PARENT GRID<a name='1374'></font>
<font color=#447700>!<a name='1375'></font>
<a name='1376'>
      GLAT=VLAT(I,J)*D2R<a name='1377'>
      GLON=(360. - VLON(I,J))*D2R<a name='1378'>
      X=COS(TPH0)*COS(GLAT)*COS(GLON-TLM0)+SIN(TPH0)*SIN(GLAT)<a name='1379'>
      Y=-COS(GLAT)*SIN(GLON-TLM0)<a name='1380'>
      Z=COS(TPH0)*SIN(GLAT)-SIN(TPH0)*COS(GLAT)*COS(GLON-TLM0)<a name='1381'>
      TLAT=R2D*ATAN(Z/SQRT(X*X+Y*Y))<a name='1382'>
      TLON=R2D*ATAN(Y/X)<a name='1383'>
<a name='1384'>
<font color=#447700>!      ROW=TLAT/DPHD1+JMT         ! JMT IS THE CENTRAL ROW OF THE PARENT DOMAIN<a name='1385'></font>
<font color=#447700>!      COL=TLON/DLMD1+P_IDE-1     ! (P_IDE-1) IS THE CENTRAL COLUMN OF THE PARENT DOMAIN<a name='1386'></font>
<a name='1387'>
      ROW=(TLAT-SBD1)/DPHD1+1     <font color=#447700>! Dusan's doing<a name='1388'></font>
      COL=(TLON-WBD1)/DLMD1+1     <font color=#447700>! Dusan's doing<a name='1389'></font>
<a name='1390'>
      NROW=INT(ROW + 0.001)     <font color=#447700>! ROUND-OFF IS AVOIDED WITHOUT USING NINT ON PURPOSE<a name='1391'></font>
      NCOL=INT(COL + 0.001)<a name='1392'>
      TLAT=TLAT*D2R<a name='1393'>
      TLON=TLON*D2R<a name='1394'>
<a name='1395'>
<font color=#447700>!***<a name='1396'></font>
<font color=#447700>!***<a name='1397'></font>
<font color=#447700>!***  FIRST CONSIDER THE SITUATION WHERE THE POINT V IS AT<a name='1398'></font>
<font color=#447700>!***<a name='1399'></font>
<font color=#447700>!***              H      V<a name='1400'></font>
<font color=#447700>!***<a name='1401'></font>
<font color=#447700>!***<a name='1402'></font>
<font color=#447700>!***                 V<a name='1403'></font>
<font color=#447700>!***              V      H<a name='1404'></font>
<font color=#447700>!***<a name='1405'></font>
<font color=#447700>!***  THEN LOCATE THE NEAREST V POINT ON THE PARENT GRID<a name='1406'></font>
<font color=#447700>!***<a name='1407'></font>
<a name='1408'>
      IF(MOD(NROW,2).EQ.0.AND.MOD(NCOL,2).EQ.1.OR.     &amp;<a name='1409'>
         MOD(NROW,2).EQ.1.AND.MOD(NCOL,2).EQ.0)THEN<a name='1410'>
           TLAT1=(NROW-JMT)*DPH<a name='1411'>
           TLAT2=TLAT1+DPH<a name='1412'>
           TLON1=(NCOL-(P_IDE-1))*DLM<a name='1413'>
           TLON2=TLON1+DLM<a name='1414'>
           DLM1=TLON-TLON1<a name='1415'>
           DLM2=TLON-TLON2<a name='1416'>
<font color=#447700>!           D1=ACOS(COS(TLAT)*COS(TLAT1)*COS(DLM1)+SIN(TLAT)*SIN(TLAT1))<a name='1417'></font>
<font color=#447700>!           D2=ACOS(COS(TLAT)*COS(TLAT2)*COS(DLM2)+SIN(TLAT)*SIN(TLAT2))<a name='1418'></font>
           DTEMP=MIN(1.0_KNUM,COS(TLAT)*COS(TLAT1)*COS(DLM1)+SIN(TLAT)*SIN(TLAT1))<a name='1419'>
           D1=ACOS(DTEMP)<a name='1420'>
           DTEMP=MIN(1.0_KNUM,COS(TLAT)*COS(TLAT2)*COS(DLM2)+SIN(TLAT)*SIN(TLAT2))<a name='1421'>
           D2=ACOS(DTEMP)<a name='1422'>
            IF(D1.GT.D2)THEN<a name='1423'>
             NROW=NROW+1                    <font color=#447700>! FIND THE NEAREST V ROW<a name='1424'></font>
             NCOL=NCOL+1                    <font color=#447700>! FIND THE NEAREST V COLUMN<a name='1425'></font>
            ENDIF<a name='1426'>
      ELSE<a name='1427'>
<a name='1428'>
<font color=#447700>!***<a name='1429'></font>
<font color=#447700>!***  NOW CONSIDER THE SITUATION WHERE THE POINT V IS AT<a name='1430'></font>
<font color=#447700>!***<a name='1431'></font>
<font color=#447700>!***              V      H<a name='1432'></font>
<font color=#447700>!***<a name='1433'></font>
<font color=#447700>!***<a name='1434'></font>
<font color=#447700>!***                 V<a name='1435'></font>
<font color=#447700>!***              H      V<a name='1436'></font>
<font color=#447700>!***<a name='1437'></font>
<font color=#447700>!*** THEN LOCATE THE NEAREST V POINT ON THE PARENT GRID<a name='1438'></font>
<font color=#447700>!***<a name='1439'></font>
           TLAT1=(NROW+1-JMT)*DPH<a name='1440'>
           TLAT2=TLAT1-DPH<a name='1441'>
           TLON1=(NCOL-(P_IDE-1))*DLM<a name='1442'>
           TLON2=TLON1+DLM<a name='1443'>
           DLM1=TLON-TLON1<a name='1444'>
           DLM2=TLON-TLON2<a name='1445'>
<font color=#447700>!           D1=ACOS(COS(TLAT)*COS(TLAT1)*COS(DLM1)+SIN(TLAT)*SIN(TLAT1))<a name='1446'></font>
<font color=#447700>!           D2=ACOS(COS(TLAT)*COS(TLAT2)*COS(DLM2)+SIN(TLAT)*SIN(TLAT2))<a name='1447'></font>
           DTEMP=MIN(1.0_KNUM,COS(TLAT)*COS(TLAT1)*COS(DLM1)+SIN(TLAT)*SIN(TLAT1))<a name='1448'>
           D1=ACOS(DTEMP)<a name='1449'>
           DTEMP=MIN(1.0_KNUM,COS(TLAT)*COS(TLAT2)*COS(DLM2)+SIN(TLAT)*SIN(TLAT2))<a name='1450'>
           D2=ACOS(DTEMP)<a name='1451'>
             IF(D1.LT.D2)THEN<a name='1452'>
              NROW=NROW+1                    <font color=#447700>! FIND THE NEAREST H ROW<a name='1453'></font>
             ELSE<a name='1454'>
              NCOL=NCOL+1                    <font color=#447700>! FIND THE NEAREST H COLUMN<a name='1455'></font>
             ENDIF<a name='1456'>
<a name='1457'>
      ENDIF<a name='1458'>
<a name='1459'>
      KROWS=((NROW-1)/2)*IMT<a name='1460'>
      IF(MOD(NROW,2).EQ.1)THEN<a name='1461'>
        K=KROWS+NCOL/2<a name='1462'>
      ELSE<a name='1463'>
        K=KROWS+P_IDE-2+(NCOL+1)/2     <font color=#447700>! check this one should this not be P_IDE-2 ????<a name='1464'></font>
      ENDIF<a name='1465'>
<a name='1466'>
<font color=#447700>!***<a name='1467'></font>
<font color=#447700>!***  WE NOW KNOW THAT THE INNER GRID POINT IN QUESTION IS<a name='1468'></font>
<font color=#447700>!***  NEAREST TO THE CENTER K AS SEEN BELOW.  WE MUST FIND<a name='1469'></font>
<font color=#447700>!***  WHICH OF THE FOUR v-BOXES (OF WHICH THIS V POINT IS<a name='1470'></font>
<font color=#447700>!***  A VERTEX) SURROUNDS THE INNER GRID V POINT IN QUESTION.<a name='1471'></font>
<font color=#447700>!***<a name='1472'></font>
<font color=#447700>!***<a name='1473'></font>
<font color=#447700>!***                  V<a name='1474'></font>
<font color=#447700>!***<a name='1475'></font>
<font color=#447700>!***<a name='1476'></font>
<font color=#447700>!***<a name='1477'></font>
<font color=#447700>!***            V     H     V<a name='1478'></font>
<font color=#447700>!***<a name='1479'></font>
<font color=#447700>!***<a name='1480'></font>
<font color=#447700>!***               V<a name='1481'></font>
<font color=#447700>!***      V     H     V     H     V<a name='1482'></font>
<font color=#447700>!***<a name='1483'></font>
<font color=#447700>!***<a name='1484'></font>
<font color=#447700>!***<a name='1485'></font>
<font color=#447700>!***            V     H     V<a name='1486'></font>
<font color=#447700>!***<a name='1487'></font>
<font color=#447700>!***<a name='1488'></font>
<font color=#447700>!***<a name='1489'></font>
<font color=#447700>!***                  V<a name='1490'></font>
<font color=#447700>!***<a name='1491'></font>
<font color=#447700>!***<a name='1492'></font>
<font color=#447700>!***  FIND THE SLOPE OF THE LINE CONNECTING V AND THE CENTER v.<a name='1493'></font>
<font color=#447700>!***<a name='1494'></font>
      N2R=K/IMT<a name='1495'>
      MK=MOD(K,IMT)<a name='1496'>
<font color=#447700>!<a name='1497'></font>
      IF(MK.EQ.0)THEN<a name='1498'>
        TLATVC=SB+(2*N2R-1)*DPH<a name='1499'>
      ELSE<a name='1500'>
        TLATVC=SB+(2*N2R+MK/(P_IDE-1))*DPH<a name='1501'>
      ENDIF<a name='1502'>
<font color=#447700>!<a name='1503'></font>
      IF(MK.LE.(P_IDE-1)-1)THEN<a name='1504'>
        TLONVC=WB+(2*MK-1)*DLM<a name='1505'>
      ELSE<a name='1506'>
        TLONVC=WB+2*(MK-(P_IDE-1))*DLM<a name='1507'>
      ENDIF<a name='1508'>
<a name='1509'>
<font color=#447700>!<a name='1510'></font>
<font color=#447700>!***  EXECUTE CAUTION IF YOU NEED TO CHANGE THESE CONDITIONS. SINCE WE ARE<a name='1511'></font>
<font color=#447700>!***  DEALING WITH SLOPES TO GENERATE DIAMOND SHAPE V BOXES, WE NEED TO BE<a name='1512'></font>
<font color=#447700>!***  CAREFUL HERE<a name='1513'></font>
<font color=#447700>!<a name='1514'></font>
       IF(ABS(TLON-TLONVC) .LE. 1.E-4)TLONVC=TLON<a name='1515'>
       IF(ABS(TLAT-TLATVC) .LE. 1.E-4)TLATVC=TLAT<a name='1516'>
       DENOM=(TLON-TLONVC)<a name='1517'>
<font color=#447700>!<a name='1518'></font>
<font color=#447700>!***<a name='1519'></font>
<font color=#447700>!***STORE THE LOCATION OF THE WESTERNMOST VERTEX OF THE H-BOX ON<a name='1520'></font>
<font color=#447700>!***THE OUTER GRID THAT SURROUNDS THE h POINT ON THE INNER GRID.<a name='1521'></font>
<font color=#447700>!***<a name='1522'></font>
<font color=#447700>!*** COINCIDENT CONDITIONS<a name='1523'></font>
<a name='1524'>
     IF(DENOM.EQ.0.0)THEN<a name='1525'>
<a name='1526'>
       IF(TLATVC.EQ.TLAT)THEN<a name='1527'>
         KOUTB(I,J)=K<a name='1528'>
         IIV(I,J) = NCOL<a name='1529'>
         JJV(I,J) = NROW<a name='1530'>
         TLATVX(I,J)=TLATVC<a name='1531'>
         TLONVX(I,J)=TLONVC<a name='1532'>
         VBWGT1(I,J)=1.0<a name='1533'>
         VBWGT2(I,J)=0.0<a name='1534'>
         VBWGT3(I,J)=0.0<a name='1535'>
         VBWGT4(I,J)=0.0<a name='1536'>
       ELSE                              <font color=#447700>! SAME LONGITUDE BUT DIFFERENT LATS <a name='1537'></font>
          <a name='1538'>
         IF(TLATVC .GT. TLAT)THEN      <font color=#447700>! NESTED POINT SOUTH OF PARENT<a name='1539'></font>
          KOUTB(I,J)=K-(P_IDE-1)<a name='1540'>
          IIV(I,J) = NCOL-1<a name='1541'>
          JJV(I,J) = NROW-1<a name='1542'>
          TLATVX(I,J)=TLATVC-DPH<a name='1543'>
          TLONVX(I,J)=TLONVC-DLM<a name='1544'>
         ELSE                                   <font color=#447700>! NESTED POINT NORTH OF PARENT<a name='1545'></font>
          KOUTB(I,J)=K+(P_IDE-1)-1<a name='1546'>
          IIV(I,J) = NCOL-1<a name='1547'>
          JJV(I,J) = NROW+1<a name='1548'>
          TLATVX(I,J)=TLATVC+DPH<a name='1549'>
          TLONVX(I,J)=TLONVC-DLM<a name='1550'>
         ENDIF<a name='1551'>
<a name='1552'>
<font color=#447700>!***<a name='1553'></font>
<font color=#447700>!***<a name='1554'></font>
<font color=#447700>!***                  4<a name='1555'></font>
<font color=#447700>!***<a name='1556'></font>
<font color=#447700>!***                  V <a name='1557'></font>
<font color=#447700>!***             1         2<a name='1558'></font>
<font color=#447700>!***<a name='1559'></font>
<font color=#447700>!***                  3<a name='1560'></font>
<font color=#447700>!***  DL 1-4 ARE THE ANGULAR DISTANCES FROM h TO EACH VERTEX<a name='1561'></font>
<a name='1562'>
       TLATO=TLATVX(I,J)<a name='1563'>
       TLONO=TLONVX(I,J)<a name='1564'>
       DLM1=TLON-TLONO<a name='1565'>
       DLA1=TLAT-TLATO                                               <font color=#447700>! Q<a name='1566'></font>
<font color=#447700>!      DL1=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM1)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1567'></font>
       DL1=SQRT(DLM1*DLM1+DLA1*DLA1)                                 <font color=#447700>! Q<a name='1568'></font>
<font color=#447700>!<a name='1569'></font>
       TLATO=TLATVX(I,J)<a name='1570'>
       TLONO=TLONVX(I,J)+2.*DLM<a name='1571'>
       DLM2=TLON-TLONO<a name='1572'>
       DLA2=TLAT-TLATO                                               <font color=#447700>! Q<a name='1573'></font>
<font color=#447700>!      DL2=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM2)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1574'></font>
       DL2=SQRT(DLM2*DLM2+DLA2*DLA2)                                 <font color=#447700>! Q<a name='1575'></font>
<a name='1576'>
       TLATO=TLATVX(I,J)-DPH<a name='1577'>
       TLONO=TLONVX(I,J)+DLM<a name='1578'>
       DLM3=TLON-TLONO<a name='1579'>
       DLA3=TLAT-TLATO                                               <font color=#447700>! Q<a name='1580'></font>
<font color=#447700>!      DL3=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM3)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1581'></font>
       DL3=SQRT(DLM3*DLM3+DLA3*DLA3)                                 <font color=#447700>! Q<a name='1582'></font>
<a name='1583'>
       TLATO=TLATVX(I,J)+DPH<a name='1584'>
       TLONO=TLONVX(I,J)+DLM<a name='1585'>
       DLM4=TLON-TLONO<a name='1586'>
       DLA4=TLAT-TLATO                                               <font color=#447700>! Q<a name='1587'></font>
<font color=#447700>!      DL4=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM4)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1588'></font>
       DL4=SQRT(DLM4*DLM4+DLA4*DLA4)                                 <font color=#447700>! Q<a name='1589'></font>
                 <a name='1590'>
<font color=#447700>!      THE BILINEAR WEIGHTS<a name='1591'></font>
<font color=#447700>!***<a name='1592'></font>
       AN3=ATAN2(DLA1,DLM1)                                          <font color=#447700>! Q<a name='1593'></font>
       R1=DL1*SIN(AN2-AN3)/SIN(2.*AN1)<a name='1594'>
       S1=DL1*SIN(2.*PI_2-2*AN1-AN2+AN3)/SIN(2.*AN1)<a name='1595'>
       R1=R1/DS1<a name='1596'>
       S1=S1/DS1<a name='1597'>
       DL1I=(1.-R1)*(1.-S1)<a name='1598'>
       DL2I=R1*S1<a name='1599'>
       DL3I=R1*(1.-S1)<a name='1600'>
       DL4I=(1.-R1)*S1<a name='1601'>
<font color=#447700>!<a name='1602'></font>
       VBWGT1(I,J)=DL1I<a name='1603'>
       VBWGT2(I,J)=DL2I<a name='1604'>
       VBWGT3(I,J)=DL3I<a name='1605'>
       VBWGT4(I,J)=DL4I      <a name='1606'>
<a name='1607'>
      ENDIF<a name='1608'>
<a name='1609'>
    ELSE<a name='1610'>
<a name='1611'>
<font color=#447700>!<a name='1612'></font>
<font color=#447700>!*** NON-COINCIDENT POINTS<a name='1613'></font>
<font color=#447700>!<a name='1614'></font>
      SLOPE=(TLAT-TLATVC)/DENOM<a name='1615'>
      DSLOPE=NINT(R2D*ATAN(SLOPE))<a name='1616'>
<a name='1617'>
      IF(DSLOPE.LE.DSLP0.AND.DSLOPE.GE.-DSLP0)THEN<a name='1618'>
        IF(TLON.GT.TLONVC)THEN<a name='1619'>
          IF(TLONVC.GE.-WB-DLM)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_121">("1V:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1620'>
          KOUTB(I,J)=K<a name='1621'>
          IIV(I,J)=NCOL<a name='1622'>
          JJV(I,J)=NROW<a name='1623'>
          TLATVX(I,J)=TLATVC<a name='1624'>
          TLONVX(I,J)=TLONVC<a name='1625'>
        ELSE<a name='1626'>
          IF(TLONVC.LE.WB+DLM)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_122">("2V:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1627'>
          KOUTB(I,J)=K-1<a name='1628'>
          IIV(I,J) = NCOL-2<a name='1629'>
          JJV(I,J) = NROW<a name='1630'>
          TLATVX(I,J)=TLATVC<a name='1631'>
          TLONVX(I,J)=TLONVC-2.*DLM<a name='1632'>
        ENDIF<a name='1633'>
 <a name='1634'>
      ELSEIF(DSLOPE.GT.DSLP0)THEN<a name='1635'>
        IF(TLON.GT.TLONVC)THEN<a name='1636'>
          IF(TLATVC.GE.-SB-DPH)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_123">("3V:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1637'>
          KOUTB(I,J)=K+(P_IDE-1)-1<a name='1638'>
          IIV(I,J) = NCOL-1<a name='1639'>
          JJV(I,J) = NROW+1<a name='1640'>
          TLATVX(I,J)=TLATVC+DPH<a name='1641'>
          TLONVX(I,J)=TLONVC-DLM<a name='1642'>
        ELSE<a name='1643'>
          IF(TLATVC.LE.SB+DPH)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_124">("4V:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1644'>
          KOUTB(I,J)=K-(P_IDE-1)<a name='1645'>
          IIV(I,J) = NCOL-1<a name='1646'>
          JJV(I,J) = NROW-1<a name='1647'>
          TLATVX(I,J)=TLATVC-DPH<a name='1648'>
          TLONVX(I,J)=TLONVC-DLM<a name='1649'>
        ENDIF<a name='1650'>
 <a name='1651'>
      ELSEIF(DSLOPE.LT.-DSLP0)THEN<a name='1652'>
        IF(TLON.GT.TLONVC)THEN<a name='1653'>
          IF(TLATVC.LE.SB+DPH)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_125">("5V:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1654'>
          KOUTB(I,J)=K-(P_IDE-1)<a name='1655'>
          IIV(I,J) = NCOL-1<a name='1656'>
          JJV(I,J) = NROW-1<a name='1657'>
          TLATVX(I,J)=TLATVC-DPH<a name='1658'>
          TLONVX(I,J)=TLONVC-DLM<a name='1659'>
        ELSE<a name='1660'>
          IF(TLATVC.GE.-SB-DPH)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_126">("6V:NESTED DOMAIN TOO CLOSE TO THE BOUNDARY OF PARENT")<a name='1661'>
          KOUTB(I,J)=K+(P_IDE-1)-1<a name='1662'>
          IIV(I,J) = NCOL-1<a name='1663'>
          JJV(I,J) = NROW+1<a name='1664'>
          TLATVX(I,J)=TLATVC+DPH<a name='1665'>
          TLONVX(I,J)=TLONVC-DLM<a name='1666'>
        ENDIF<a name='1667'>
      ENDIF<a name='1668'>
<font color=#447700>!<a name='1669'></font>
<font color=#447700>!***  NOW WE WILL MOVE AS FOLLOWS:<a name='1670'></font>
<font color=#447700>!***<a name='1671'></font>
<font color=#447700>!***<a name='1672'></font>
<font color=#447700>!***                      4<a name='1673'></font>
<font color=#447700>!***<a name='1674'></font>
<font color=#447700>!***<a name='1675'></font>
<font color=#447700>!*** <a name='1676'></font>
<font color=#447700>!***                   V <a name='1677'></font>
<font color=#447700>!***             1                 2<a name='1678'></font>
<font color=#447700>!***<a name='1679'></font>
<font color=#447700>!***<a name='1680'></font>
<font color=#447700>!***<a name='1681'></font>
<font color=#447700>!***<a name='1682'></font>
<font color=#447700>!***                      3<a name='1683'></font>
<font color=#447700>!***<a name='1684'></font>
<font color=#447700>!***<a name='1685'></font>
<font color=#447700>!***<a name='1686'></font>
<font color=#447700>!***  DL 1-4 ARE THE ANGULAR DISTANCES FROM V TO EACH VERTEX<a name='1687'></font>
<a name='1688'>
      TLATO=TLATVX(I,J)<a name='1689'>
      TLONO=TLONVX(I,J)<a name='1690'>
      DLM1=TLON-TLONO<a name='1691'>
      DLA1=TLAT-TLATO                                               <font color=#447700>! Q<a name='1692'></font>
<font color=#447700>!     DL1=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM1)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1693'></font>
      DL1=SQRT(DLM1*DLM1+DLA1*DLA1)                                 <font color=#447700>! Q<a name='1694'></font>
<font color=#447700>!<a name='1695'></font>
      TLATO=TLATVX(I,J)<a name='1696'>
      TLONO=TLONVX(I,J)+2.*DLM<a name='1697'>
      DLM2=TLON-TLONO<a name='1698'>
      DLA2=TLAT-TLATO                                               <font color=#447700>! Q<a name='1699'></font>
<font color=#447700>!     DL2=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM2)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1700'></font>
      DL2=SQRT(DLM2*DLM2+DLA2*DLA2)                                 <font color=#447700>! Q<a name='1701'></font>
<font color=#447700>!<a name='1702'></font>
      TLATO=TLATVX(I,J)-DPH<a name='1703'>
      TLONO=TLONVX(I,J)+DLM<a name='1704'>
      DLM3=TLON-TLONO<a name='1705'>
      DLA3=TLAT-TLATO                                               <font color=#447700>! Q<a name='1706'></font>
<font color=#447700>!     DL3=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM3)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1707'></font>
      DL3=SQRT(DLM3*DLM3+DLA3*DLA3)                                 <font color=#447700>! Q<a name='1708'></font>
<font color=#447700>!<a name='1709'></font>
      TLATO=TLATVX(I,J)+DPH<a name='1710'>
      TLONO=TLONVX(I,J)+DLM<a name='1711'>
      DLM4=TLON-TLONO<a name='1712'>
      DLA4=TLAT-TLATO                                               <font color=#447700>! Q<a name='1713'></font>
<font color=#447700>!     DL4=ACOS(COS(TLAT)*COS(TLATO)*COS(DLM4)+SIN(TLAT)*SIN(TLATO)) ! Q<a name='1714'></font>
      DL4=SQRT(DLM4*DLM4+DLA4*DLA4)                                 <font color=#447700>! Q<a name='1715'></font>
 <a name='1716'>
<font color=#447700>!     THE BILINEAR WEIGHTS<a name='1717'></font>
<font color=#447700>!***<a name='1718'></font>
      AN3=ATAN2(DLA1,DLM1)                                          <font color=#447700>! Q<a name='1719'></font>
      R1=DL1*SIN(AN2-AN3)/SIN(2.*AN1)<a name='1720'>
      S1=DL1*SIN(2.*PI_2-2*AN1-AN2+AN3)/SIN(2.*AN1)<a name='1721'>
      R1=R1/DS1<a name='1722'>
      S1=S1/DS1<a name='1723'>
      DL1I=(1.-R1)*(1.-S1)<a name='1724'>
      DL2I=R1*S1<a name='1725'>
      DL3I=R1*(1.-S1)<a name='1726'>
      DL4I=(1.-R1)*S1<a name='1727'>
<font color=#447700>!<a name='1728'></font>
      VBWGT1(I,J)=DL1I<a name='1729'>
      VBWGT2(I,J)=DL2I<a name='1730'>
      VBWGT3(I,J)=DL3I<a name='1731'>
      VBWGT4(I,J)=DL4I<a name='1732'>
<a name='1733'>
     ENDIF<a name='1734'>
<a name='1735'>
<font color=#447700>!<a name='1736'></font>
<font color=#447700>!***  FINALLY STORE IIH IN TERMS OF E-GRID INDEX<a name='1737'></font>
<font color=#447700>!<a name='1738'></font>
      IIV(I,J)=NINT(0.5*IIV(I,J))<a name='1739'>
<a name='1740'>
      VBWGT1(I,J)=MAX(VBWGT1(I,J),0.0)   <font color=#447700>! all weights must be GE zero (postive def)<a name='1741'></font>
      VBWGT2(I,J)=MAX(VBWGT2(I,J),0.0)   <font color=#447700>! all weights must be GE zero (postive def)<a name='1742'></font>
      VBWGT3(I,J)=MAX(VBWGT3(I,J),0.0)   <font color=#447700>! all weights must be GE zero (postive def)<a name='1743'></font>
      VBWGT4(I,J)=MAX(VBWGT4(I,J),0.0)   <font color=#447700>! all weights must be GE zero (postive def)<a name='1744'></font>
<a name='1745'>
    ENDDO<a name='1746'>
  ENDDO<a name='1747'>
<a name='1748'>
 RETURN<a name='1749'>
 END SUBROUTINE G2T2V<a name='1750'>
<a name='1751'>
<font color=#447700>!-----------------------------------------------------------------------------  <a name='1752'></font>
<a name='1753'>
<A NAME='G2T2H_NEW'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1754'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>G2T2H_new</font>( IIH,JJH,                            &amp; <font color=#447700>! output grid index and weights  <A href='../../call_to/G2T2H_NEW.html' TARGET='index'>2</A>,<A href='../../call_from/G2T2H_NEW.html' TARGET='index'>6</A><a name='1755'></font>
                       HBWGT1,HBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='1756'></font>
                       HBWGT3,HBWGT4,                      &amp;<a name='1757'>
                       I_PARENT_START,J_PARENT_START,      &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1758'></font>
                       RATIO,                              &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1759'></font>
                       IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='1760'></font>
                       IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='1761'>
                       ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1762'>
<font color=#447700>!<a name='1763'></font>
<font color=#447700>!*** XUEJIN ZHANG --- Initial version (09/08/2008)<a name='1764'></font>
<font color=#447700>!*** XUEJIN ZHANG --- Modified for parallel purpose (09/10/2009)<a name='1765'></font>
<font color=#447700>!*** XUEJIN ZHANG --- Modified for parallel purpose (09/29/2009)<a name='1766'></font>
<font color=#447700>!Function: Bilnear interpolation weight and indexing for E-grid<a name='1767'></font>
<font color=#447700>!<a name='1768'></font>
 IMPLICIT NONE<a name='1769'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1770'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='1771'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1772'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='1773'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='1774'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='1775'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='1776'>
<font color=#447700>!LOCAL VARIABLES<a name='1777'></font>
 INTEGER                                              :: I,J<a name='1778'>
 INTEGER                                              :: JP<a name='1779'>
<a name='1780'>
<a name='1781'>
<font color=#447700>!*** ARRANGEMENT OF 4 VERTEXES FROM PARENT DOMAIN<a name='1782'></font>
<font color=#447700>!***<a name='1783'></font>
<font color=#447700>!***                  4<a name='1784'></font>
<font color=#447700>!***<a name='1785'></font>
<font color=#447700>!***                  h<a name='1786'></font>
<font color=#447700>!***             1         2<a name='1787'></font>
<font color=#447700>!***<a name='1788'></font>
<font color=#447700>!***<a name='1789'></font>
<font color=#447700>!***                  3<a name='1790'></font>
<font color=#447700>!<a name='1791'></font>
<font color=#447700>!************************************************************* <a name='1792'></font>
<font color=#447700>!***  POINT (i,j) SPANS 9 NESTED POINTS <a name='1793'></font>
<font color=#447700>!***  A VERTEX IN THE NEST DOMAIN AND INDEXING FOR PARENT DOMAIN <a name='1794'></font>
<font color=#447700>!***<a name='1795'></font>
<font color=#447700>!***<a name='1796'></font>
<font color=#447700>!***                  H<a name='1797'></font>
<font color=#447700>!***                <a name='1798'></font>
<font color=#447700>!***               h     h<a name='1799'></font>
<font color=#447700>!***              / \<a name='1800'></font>
<font color=#447700>!***            h     h     h<a name='1801'></font>
<font color=#447700>!***           / \   / \<a name='1802'></font>
<font color=#447700>!***         H     h     h     H  <a name='1803'></font>
<font color=#447700>!***          \   / \   /   <a name='1804'></font>
<font color=#447700>!***            h     h     h<a name='1805'></font>
<font color=#447700>!***             \   /<a name='1806'></font>
<font color=#447700>!***               h     h<a name='1807'></font>
<font color=#447700>!***      <a name='1808'></font>
<font color=#447700>!***                  H<a name='1809'></font>
<font color=#447700>!***                 <a name='1810'></font>
<font color=#447700>!***<a name='1811'></font>
<font color=#447700>!***<a name='1812'></font>
<font color=#447700>!************************************************************* <a name='1813'></font>
<font color=#447700>!*** MOVING NEST ALWAYS STARTING FROM MASS GRID H<a name='1814'></font>
<font color=#447700>!*** PLEASE REFER TO E-GRID ARRANGEMENT FIGURE FOR MASS POINTS<a name='1815'></font>
<a name='1816'>
<a name='1817'>
 DO J=JTS,MIN(JTE,JDE-1)<a name='1818'>
 DO I=ITS,MIN(ITE,IDE-1)<a name='1819'>
    JP = MOD(J,RATIO*2)<a name='1820'>
    SELECT CASE(JP)<a name='1821'>
    CASE ( 1 )<a name='1822'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB1H'>SUB1H</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB1H_1">(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp;<a name='1823'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1824'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1825'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1826'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1827'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1828'>
    CASE ( 2 )<a name='1829'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB2H'>SUB2H</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB2H_1">(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp;    <a name='1830'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1831'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1832'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1833'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1834'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1835'>
    CASE ( 3 )<a name='1836'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB3H'>SUB3H</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB3H_1">(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp;<a name='1837'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1838'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1839'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1840'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1841'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1842'>
    CASE ( 4 )<a name='1843'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB4H'>SUB4H</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB4H_1">(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp;    <a name='1844'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1845'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1846'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1847'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1848'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1849'>
    CASE ( 5 )<a name='1850'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB5H'>SUB5H</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB5H_1">(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp;<a name='1851'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1852'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1853'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1854'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1855'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1856'>
    CASE ( 0 )<a name='1857'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB6H'>SUB6H</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB6H_1">(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp;    <a name='1858'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1859'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1860'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1861'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1862'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1863'>
    END SELECT<a name='1864'>
  105  format(a,4i4,5f7.3)<a name='1865'>
 END DO<a name='1866'>
 END DO<a name='1867'>
<a name='1868'>
 RETURN<a name='1869'>
 END SUBROUTINE G2T2H_new<a name='1870'>
<A NAME='SUB1H'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB1H' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1871'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB1H</font>(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp; <A href='../../call_to/SUB1H.html' TARGET='index'>1</A><a name='1872'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1873'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1874'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1875'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1876'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1877'>
 IMPLICIT NONE<a name='1878'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1879'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='1880'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1881'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='1882'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='1883'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='1884'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='1885'>
<font color=#447700>!LOCAL VARIABLES<a name='1886'></font>
 INTEGER                                              :: I,J<a name='1887'>
 INTEGER                                              :: IP<a name='1888'>
<a name='1889'>
  IP = MOD(I,RATIO)<a name='1890'>
  SELECT CASE(IP)<a name='1891'>
   CASE ( 1 )<a name='1892'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='1893'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='1894'>
    HBWGT1(I,J) = 1.0<a name='1895'>
    HBWGT2(I,J) = 0.0<a name='1896'>
    HBWGT3(I,J) = 0.0<a name='1897'>
    HBWGT4(I,J) = 0.0<a name='1898'>
   CASE ( 2 )<a name='1899'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='1900'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='1901'>
    HBWGT1(I,J) = 4.0/9.0<a name='1902'>
    HBWGT2(I,J) = 1.0/9.0<a name='1903'>
    HBWGT3(I,J) = 2.0/9.0<a name='1904'>
    HBWGT4(I,J) = 2.0/9.0<a name='1905'>
   CASE ( 0 )<a name='1906'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='1907'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='1908'>
    HBWGT1(I,J) = 1.0/9.0<a name='1909'>
    HBWGT2(I,J) = 4.0/9.0<a name='1910'>
    HBWGT3(I,J) = 2.0/9.0<a name='1911'>
    HBWGT4(I,J) = 2.0/9.0<a name='1912'>
   END SELECT<a name='1913'>
 RETURN<a name='1914'>
 END SUBROUTINE SUB1H<a name='1915'>
<A NAME='SUB2H'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB2H' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1916'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB2H</font>(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp; <A href='../../call_to/SUB2H.html' TARGET='index'>1</A><a name='1917'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1918'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1919'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1920'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1921'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1922'>
 IMPLICIT NONE<a name='1923'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1924'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='1925'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1926'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='1927'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='1928'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='1929'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='1930'>
<font color=#447700>!LOCAL VARIABLES<a name='1931'></font>
 INTEGER                                              :: I,J<a name='1932'>
 INTEGER                                              :: IP<a name='1933'>
<a name='1934'>
  IP = MOD(I,RATIO)<a name='1935'>
  SELECT CASE(IP)<a name='1936'>
   CASE ( 1 )<a name='1937'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='1938'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='1939'>
    HBWGT1(I,J) = 2.0/3.0<a name='1940'>
    HBWGT2(I,J) = 0.0<a name='1941'>
    HBWGT3(I,J) = 0.0<a name='1942'>
    HBWGT4(I,J) = 1.0/3.0<a name='1943'>
   CASE ( 2 )<a name='1944'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='1945'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='1946'>
    HBWGT1(I,J) = 2.0/9.0<a name='1947'>
    HBWGT2(I,J) = 2.0/9.0<a name='1948'>
    HBWGT3(I,J) = 1.0/9.0<a name='1949'>
    HBWGT4(I,J) = 4.0/9.0<a name='1950'>
   CASE ( 0 )<a name='1951'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='1952'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)+1<a name='1953'>
    HBWGT1(I,J) = 1.0/3.0<a name='1954'>
    HBWGT2(I,J) = 0.0<a name='1955'>
    HBWGT3(I,J) = 2.0/3.0<a name='1956'>
    HBWGT4(I,J) = 0.0<a name='1957'>
   END SELECT<a name='1958'>
 RETURN<a name='1959'>
 END SUBROUTINE SUB2H<a name='1960'>
<A NAME='SUB3H'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB3H' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1961'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB3H</font>(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp; <A href='../../call_to/SUB3H.html' TARGET='index'>1</A><a name='1962'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1963'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1964'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='1965'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='1966'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1967'>
 IMPLICIT NONE<a name='1968'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1969'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='1970'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1971'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='1972'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='1973'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='1974'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='1975'>
<font color=#447700>!LOCAL VARIABLES<a name='1976'></font>
 INTEGER                                              :: I,J<a name='1977'>
 INTEGER                                              :: IP<a name='1978'>
<a name='1979'>
  IP = MOD(I,RATIO)<a name='1980'>
  SELECT CASE(IP)<a name='1981'>
   CASE ( 1 )<a name='1982'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)-1<a name='1983'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)+1<a name='1984'>
    HBWGT1(I,J) = 2.0/9.0<a name='1985'>
    HBWGT2(I,J) = 2.0/9.0<a name='1986'>
    HBWGT3(I,J) = 4.0/9.0<a name='1987'>
    HBWGT4(I,J) = 1.0/9.0<a name='1988'>
   CASE ( 2 )<a name='1989'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='1990'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='1991'>
    HBWGT1(I,J) = 1.0/3.0<a name='1992'>
    HBWGT2(I,J) = 0.0<a name='1993'>
    HBWGT3(I,J) = 0.0<a name='1994'>
    HBWGT4(I,J) = 2.0/3.0<a name='1995'>
   CASE ( 0 )<a name='1996'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='1997'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)+1<a name='1998'>
    HBWGT1(I,J) = 2.0/3.0<a name='1999'>
    HBWGT2(I,J) = 0.0<a name='2000'>
    HBWGT3(I,J) = 1.0/3.0<a name='2001'>
    HBWGT4(I,J) = 0.0<a name='2002'>
   END SELECT<a name='2003'>
 RETURN<a name='2004'>
 END SUBROUTINE SUB3H<a name='2005'>
<A NAME='SUB4H'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB4H' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2006'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB4H</font>(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp; <A href='../../call_to/SUB4H.html' TARGET='index'>1</A><a name='2007'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2008'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2009'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2010'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2011'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2012'>
 IMPLICIT NONE<a name='2013'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2014'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2015'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2016'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2017'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2018'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='2019'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='2020'>
<font color=#447700>!LOCAL VARIABLES<a name='2021'></font>
 INTEGER                                              :: I,J<a name='2022'>
 INTEGER                                              :: IP<a name='2023'>
<a name='2024'>
  IP = MOD(I,RATIO)<a name='2025'>
  SELECT CASE(IP)<a name='2026'>
   CASE ( 1 )<a name='2027'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)-1<a name='2028'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2029'>
    HBWGT1(I,J) = 1.0/9.0<a name='2030'>
    HBWGT2(I,J) = 4.0/9.0<a name='2031'>
    HBWGT3(I,J) = 2.0/9.0<a name='2032'>
    HBWGT4(I,J) = 2.0/9.0<a name='2033'>
   CASE ( 2 )<a name='2034'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2035'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2036'>
    HBWGT1(I,J) = 1.0<a name='2037'>
    HBWGT2(I,J) = 0.0<a name='2038'>
    HBWGT3(I,J) = 0.0<a name='2039'>
    HBWGT4(I,J) = 0.0<a name='2040'>
   CASE ( 0 )<a name='2041'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2042'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2043'>
    HBWGT1(I,J) = 4.0/9.0<a name='2044'>
    HBWGT2(I,J) = 1.0/9.0<a name='2045'>
    HBWGT3(I,J) = 2.0/9.0<a name='2046'>
    HBWGT4(I,J) = 2.0/9.0<a name='2047'>
   END SELECT<a name='2048'>
 RETURN<a name='2049'>
 END SUBROUTINE SUB4H<a name='2050'>
<A NAME='SUB5H'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB5H' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2051'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB5H</font>(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp; <A href='../../call_to/SUB5H.html' TARGET='index'>1</A><a name='2052'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2053'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2054'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2055'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2056'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2057'>
 IMPLICIT NONE<a name='2058'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2059'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2060'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2061'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2062'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2063'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='2064'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='2065'>
<font color=#447700>!LOCAL VARIABLES<a name='2066'></font>
 INTEGER                                              :: I,J<a name='2067'>
 INTEGER                                              :: IP<a name='2068'>
<a name='2069'>
  IP = MOD(I,RATIO)<a name='2070'>
  SELECT CASE(IP)<a name='2071'>
   CASE ( 1 )<a name='2072'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)-1<a name='2073'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2074'>
    HBWGT1(I,J) = 2.0/9.0<a name='2075'>
    HBWGT2(I,J) = 2.0/9.0<a name='2076'>
    HBWGT3(I,J) = 1.0/9.0<a name='2077'>
    HBWGT4(I,J) = 4.0/9.0<a name='2078'>
   CASE ( 2 )<a name='2079'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2080'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)+1<a name='2081'>
    HBWGT1(I,J) = 1.0/3.0<a name='2082'>
    HBWGT2(I,J) = 0.0<a name='2083'>
    HBWGT3(I,J) = 2.0/3.0<a name='2084'>
    HBWGT4(I,J) = 0.0<a name='2085'>
   CASE ( 0 )<a name='2086'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2087'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2088'>
    HBWGT1(I,J) = 2.0/3.0<a name='2089'>
    HBWGT2(I,J) = 0.0<a name='2090'>
    HBWGT3(I,J) = 0.0<a name='2091'>
    HBWGT4(I,J) = 1.0/3.0<a name='2092'>
   END SELECT<a name='2093'>
 RETURN<a name='2094'>
 END SUBROUTINE SUB5H<a name='2095'>
<A NAME='SUB6H'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB6H' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2096'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB6H</font>(I,J,IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4, &amp; <A href='../../call_to/SUB6H.html' TARGET='index'>1</A><a name='2097'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2098'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2099'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2100'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2101'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2102'>
 IMPLICIT NONE<a name='2103'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2104'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2105'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2106'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2107'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2108'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='2109'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='2110'>
<font color=#447700>!LOCAL VARIABLES<a name='2111'></font>
 INTEGER                                              :: I,J<a name='2112'>
 INTEGER                                              :: IP<a name='2113'>
<a name='2114'>
  IP = MOD(I,RATIO)<a name='2115'>
  SELECT CASE(IP)<a name='2116'>
   CASE ( 1 )<a name='2117'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2118'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO) + 1<a name='2119'>
    HBWGT1(I,J) = 2.0/3.0<a name='2120'>
    HBWGT2(I,J) = 0.0<a name='2121'>
    HBWGT3(I,J) = 1.0/3.0<a name='2122'>
    HBWGT4(I,J) = 0.0<a name='2123'>
   CASE ( 2 )<a name='2124'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2125'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO) + 1<a name='2126'>
    HBWGT1(I,J) = 2.0/9.0<a name='2127'>
    HBWGT2(I,J) = 2.0/9.0<a name='2128'>
    HBWGT3(I,J) = 4.0/9.0<a name='2129'>
    HBWGT4(I,J) = 1.0/9.0<a name='2130'>
   CASE ( 0 )<a name='2131'>
    IIH(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2132'>
    JJH(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2133'>
    HBWGT1(I,J) = 1.0/3.0<a name='2134'>
    HBWGT2(I,J) = 0.0<a name='2135'>
    HBWGT3(I,J) = 0.0<a name='2136'>
    HBWGT4(I,J) = 2.0/3.0<a name='2137'>
   END SELECT<a name='2138'>
 RETURN<a name='2139'>
 END SUBROUTINE SUB6H<a name='2140'>
<a name='2141'>
<font color=#447700>!-----------------------------------------------------------------------------  <a name='2142'></font>
<a name='2143'>
<A NAME='G2T2V_NEW'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2144'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>G2T2V_new</font>( IIV,JJV,                            &amp; <font color=#447700>! output grid index and weights  <A href='../../call_to/G2T2V_NEW.html' TARGET='index'>2</A>,<A href='../../call_from/G2T2V_NEW.html' TARGET='index'>6</A><a name='2145'></font>
                       VBWGT1,VBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='2146'></font>
                       VBWGT3,VBWGT4,                      &amp;<a name='2147'>
                       I_PARENT_START,J_PARENT_START,      &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2148'></font>
                       RATIO,                              &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2149'></font>
                       IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='2150'></font>
                       IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='2151'>
                       ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2152'>
<font color=#447700>!<a name='2153'></font>
<font color=#447700>!*** XUEJIN ZHANG --- Initial version (09/08/2008)<a name='2154'></font>
<font color=#447700>!*** XUEJIN ZHANG --- Modified for parallel purpose (09/10/2009)<a name='2155'></font>
<font color=#447700>!*** XUEJIN ZHANG --- Modified for parallel purpose (09/29/2009)<a name='2156'></font>
<font color=#447700>!Function: Bilnear interpolation weight and indexing for E-grid<a name='2157'></font>
<font color=#447700>!<a name='2158'></font>
 IMPLICIT NONE<a name='2159'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2160'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2161'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2162'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2163'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2164'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='2165'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIV,JJV<a name='2166'>
<font color=#447700>!LOCAL VARIABLES<a name='2167'></font>
 INTEGER                                              :: I,J<a name='2168'>
 INTEGER                                              :: JP<a name='2169'>
<a name='2170'>
<font color=#447700>!*** ARRANGEMENT OF 4 VERTEXES FROM PARENT DOMAIN<a name='2171'></font>
<font color=#447700>!***<a name='2172'></font>
<font color=#447700>!***                  4<a name='2173'></font>
<font color=#447700>!***<a name='2174'></font>
<font color=#447700>!***                  v<a name='2175'></font>
<font color=#447700>!***             1         2<a name='2176'></font>
<font color=#447700>!***<a name='2177'></font>
<font color=#447700>!***<a name='2178'></font>
<font color=#447700>!***                  3<a name='2179'></font>
<font color=#447700>!<a name='2180'></font>
<font color=#447700>!************************************************************* <a name='2181'></font>
<font color=#447700>!***  POINT (i,j) SPANS 9 NESTED POINTS <a name='2182'></font>
<font color=#447700>!***  A VERTEX IN THE NEST DOMAIN AND INDEXING FOR PARENT DOMAIN<a name='2183'></font>
<font color=#447700>!***<a name='2184'></font>
<font color=#447700>!***<a name='2185'></font>
<font color=#447700>!***                  V<a name='2186'></font>
<font color=#447700>!***                <a name='2187'></font>
<font color=#447700>!***               v  h  v<a name='2188'></font>
<font color=#447700>!***              / \<a name='2189'></font>
<font color=#447700>!***            v  h  v  h  v<a name='2190'></font>
<font color=#447700>!***           / \   / \<a name='2191'></font>
<font color=#447700>!***         V  H  v  h  v  h  V  H<a name='2192'></font>
<font color=#447700>!***          \   / \   /   <a name='2193'></font>
<font color=#447700>!***            v  h  v  h  v<a name='2194'></font>
<font color=#447700>!***             \   /<a name='2195'></font>
<font color=#447700>!***               v  h  v<a name='2196'></font>
<font color=#447700>!***      <a name='2197'></font>
<font color=#447700>!***                  V<a name='2198'></font>
<font color=#447700>!***                 <a name='2199'></font>
<font color=#447700>!***<a name='2200'></font>
<font color=#447700>!***<a name='2201'></font>
<font color=#447700>!************************************************************* <a name='2202'></font>
<font color=#447700>!*** MOVING NEST ALWAYS STARTING FROM MASS GRID H<a name='2203'></font>
<font color=#447700>!*** PLEASE REFER TO E-GRID ARRANGEMENT FIGURE FOR WIND POINTS<a name='2204'></font>
<a name='2205'>
 DO J=JTS,MIN(JTE,JDE-1)<a name='2206'>
 DO I=ITS,MIN(ITE,IDE-1)<a name='2207'>
    JP = MOD(J,RATIO*2)<a name='2208'>
    SELECT CASE(JP)<a name='2209'>
    CASE ( 1 )<a name='2210'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB1V'>SUB1V</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB1V_1">(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp;<a name='2211'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2212'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2213'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2214'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2215'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2216'>
    CASE ( 2 )<a name='2217'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB2V'>SUB2V</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB2V_1">(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp;    <a name='2218'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2219'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2220'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2221'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2222'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2223'>
    CASE ( 3 )<a name='2224'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB3V'>SUB3V</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB3V_1">(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp;<a name='2225'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2226'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2227'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2228'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2229'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2230'>
    CASE ( 4 )<a name='2231'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB4V'>SUB4V</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB4V_1">(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp;    <a name='2232'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2233'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2234'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2235'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2236'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2237'>
    CASE ( 5 )<a name='2238'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB5V'>SUB5V</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB5V_1">(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp;<a name='2239'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2240'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2241'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2242'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2243'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2244'>
    CASE ( 0 )<a name='2245'>
      CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB6V'>SUB6V</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUB6V_1">(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp;    <a name='2246'>
                I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2247'></font>
                RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2248'></font>
                IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2249'></font>
                IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2250'>
                ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2251'>
    END SELECT<a name='2252'>
 END DO<a name='2253'>
 END DO<a name='2254'>
<a name='2255'>
 RETURN<a name='2256'>
 END SUBROUTINE G2T2V_new<a name='2257'>
<A NAME='SUB1V'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB1V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2258'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB1V</font>(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp; <A href='../../call_to/SUB1V.html' TARGET='index'>1</A><a name='2259'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2260'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2261'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2262'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2263'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2264'>
 IMPLICIT NONE<a name='2265'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2266'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2267'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2268'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2269'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2270'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='2271'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIV,JJV<a name='2272'>
<font color=#447700>!LOCAL VARIABLES<a name='2273'></font>
 INTEGER                                              :: I,J<a name='2274'>
 INTEGER                                              :: IP<a name='2275'>
  IP = MOD(I,RATIO)<a name='2276'>
  SELECT CASE(IP)<a name='2277'>
   CASE ( 1 )<a name='2278'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO) - 1<a name='2279'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2280'>
    VBWGT1(I,J) = 1.0/9.0<a name='2281'>
    VBWGT2(I,J) = 4.0/9.0<a name='2282'>
    VBWGT3(I,J) = 2.0/9.0<a name='2283'>
    VBWGT4(I,J) = 2.0/9.0<a name='2284'>
   CASE ( 2 )<a name='2285'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO) <a name='2286'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2287'>
    VBWGT1(I,J) = 1.0<a name='2288'>
    VBWGT2(I,J) = 0.0<a name='2289'>
    VBWGT3(I,J) = 0.0<a name='2290'>
    VBWGT4(I,J) = 0.0<a name='2291'>
   CASE ( 0 )<a name='2292'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2293'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2294'>
    VBWGT1(I,J) = 4.0/9.0<a name='2295'>
    VBWGT2(I,J) = 1.0/9.0<a name='2296'>
    VBWGT3(I,J) = 2.0/9.0<a name='2297'>
    VBWGT4(I,J) = 2.0/9.0<a name='2298'>
   END SELECT<a name='2299'>
 RETURN<a name='2300'>
 END SUBROUTINE SUB1V<a name='2301'>
<A NAME='SUB2V'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB2V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2302'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB2V</font>(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp; <A href='../../call_to/SUB2V.html' TARGET='index'>1</A><a name='2303'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2304'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2305'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2306'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2307'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2308'>
 IMPLICIT NONE<a name='2309'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2310'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2311'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2312'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2313'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2314'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='2315'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIV,JJV<a name='2316'>
<font color=#447700>!LOCAL VARIABLES<a name='2317'></font>
 INTEGER                                              :: I,J<a name='2318'>
 INTEGER                                              :: IP<a name='2319'>
  IP = MOD(I,RATIO)<a name='2320'>
  SELECT CASE(IP)<a name='2321'>
   CASE ( 1 )<a name='2322'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO) - 1<a name='2323'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2324'>
    VBWGT1(I,J) = 2.0/9.0<a name='2325'>
    VBWGT2(I,J) = 2.0/9.0<a name='2326'>
    VBWGT3(I,J) = 1.0/9.0<a name='2327'>
    VBWGT4(I,J) = 4.0/9.0<a name='2328'>
   CASE ( 2 )<a name='2329'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2330'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO) + 1<a name='2331'>
    VBWGT1(I,J) = 1.0/3.0<a name='2332'>
    VBWGT2(I,J) = 0.0<a name='2333'>
    VBWGT3(I,J) = 2.0/3.0<a name='2334'>
    VBWGT4(I,J) = 0.0<a name='2335'>
   CASE ( 0 )<a name='2336'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2337'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2338'>
    VBWGT1(I,J) = 2.0/3.0<a name='2339'>
    VBWGT2(I,J) = 0.0<a name='2340'>
    VBWGT3(I,J) = 0.0<a name='2341'>
    VBWGT4(I,J) = 1.0/3.0<a name='2342'>
   END SELECT<a name='2343'>
 RETURN<a name='2344'>
 END SUBROUTINE SUB2V<a name='2345'>
<A NAME='SUB3V'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB3V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2346'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB3V</font>(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp; <A href='../../call_to/SUB3V.html' TARGET='index'>1</A><a name='2347'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2348'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2349'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2350'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2351'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2352'>
 IMPLICIT NONE<a name='2353'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2354'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2355'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2356'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2357'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2358'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='2359'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIV,JJV<a name='2360'>
<font color=#447700>!LOCAL VARIABLES<a name='2361'></font>
 INTEGER                                              :: I,J<a name='2362'>
 INTEGER                                              :: IP<a name='2363'>
  IP = MOD(I,RATIO)<a name='2364'>
  SELECT CASE(IP)<a name='2365'>
   CASE ( 1 )<a name='2366'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2367'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO) + 1<a name='2368'>
    VBWGT1(I,J) = 2.0/3.0<a name='2369'>
    VBWGT2(I,J) = 0.0<a name='2370'>
    VBWGT3(I,J) = 1.0/3.0<a name='2371'>
    VBWGT4(I,J) = 0.0<a name='2372'>
   CASE ( 2 )<a name='2373'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2374'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO) + 1<a name='2375'>
    VBWGT1(I,J) = 2.0/9.0<a name='2376'>
    VBWGT2(I,J) = 2.0/9.0<a name='2377'>
    VBWGT3(I,J) = 4.0/9.0<a name='2378'>
    VBWGT4(I,J) = 1.0/9.0<a name='2379'>
   CASE ( 0 )<a name='2380'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2381'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2382'>
    VBWGT1(I,J) = 1.0/3.0<a name='2383'>
    VBWGT2(I,J) = 0.0<a name='2384'>
    VBWGT3(I,J) = 0.0<a name='2385'>
    VBWGT4(I,J) = 2.0/3.0<a name='2386'>
   END SELECT<a name='2387'>
 RETURN<a name='2388'>
 END SUBROUTINE SUB3V<a name='2389'>
<A NAME='SUB4V'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB4V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2390'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB4V</font>(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp; <A href='../../call_to/SUB4V.html' TARGET='index'>1</A><a name='2391'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2392'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2393'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2394'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2395'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2396'>
 IMPLICIT NONE<a name='2397'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2398'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2399'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2400'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2401'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2402'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='2403'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIV,JJV<a name='2404'>
<font color=#447700>!LOCAL VARIABLES<a name='2405'></font>
 INTEGER                                              :: I,J<a name='2406'>
 INTEGER                                              :: IP<a name='2407'>
  IP = MOD(I,RATIO)<a name='2408'>
  SELECT CASE(IP)<a name='2409'>
   CASE ( 1 )<a name='2410'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2411'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2412'>
    VBWGT1(I,J) = 1.0<a name='2413'>
    VBWGT2(I,J) = 0.0<a name='2414'>
    VBWGT3(I,J) = 0.0<a name='2415'>
    VBWGT4(I,J) = 0.0<a name='2416'>
   CASE ( 2 )<a name='2417'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2418'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2419'>
    VBWGT1(I,J) = 4.0/9.0<a name='2420'>
    VBWGT2(I,J) = 1.0/9.0<a name='2421'>
    VBWGT3(I,J) = 2.0/9.0<a name='2422'>
    VBWGT4(I,J) = 2.0/9.0<a name='2423'>
   CASE ( 0 )<a name='2424'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2425'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2426'>
    VBWGT1(I,J) = 1.0/9.0<a name='2427'>
    VBWGT2(I,J) = 4.0/9.0<a name='2428'>
    VBWGT3(I,J) = 2.0/9.0<a name='2429'>
    VBWGT4(I,J) = 2.0/9.0<a name='2430'>
   END SELECT<a name='2431'>
 RETURN<a name='2432'>
 END SUBROUTINE SUB4V<a name='2433'>
<A NAME='SUB5V'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB5V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2434'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB5V</font>(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp; <A href='../../call_to/SUB5V.html' TARGET='index'>1</A><a name='2435'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2436'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2437'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2438'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2439'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2440'>
 IMPLICIT NONE<a name='2441'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2442'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2443'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2444'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2445'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2446'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='2447'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIV,JJV<a name='2448'>
<font color=#447700>!LOCAL VARIABLES<a name='2449'></font>
 INTEGER                                              :: I,J<a name='2450'>
 INTEGER                                              :: IP<a name='2451'>
  IP = MOD(I,RATIO)<a name='2452'>
  SELECT CASE(IP)<a name='2453'>
   CASE ( 1 )<a name='2454'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2455'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2456'>
    VBWGT1(I,J) = 2.0/3.0<a name='2457'>
    VBWGT2(I,J) = 0.0<a name='2458'>
    VBWGT3(I,J) = 0.0<a name='2459'>
    VBWGT4(I,J) = 1.0/3.0<a name='2460'>
   CASE ( 2 )<a name='2461'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2462'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO)<a name='2463'>
    VBWGT1(I,J) = 2.0/9.0<a name='2464'>
    VBWGT2(I,J) = 2.0/9.0<a name='2465'>
    VBWGT3(I,J) = 1.0/9.0<a name='2466'>
    VBWGT4(I,J) = 4.0/9.0<a name='2467'>
   CASE ( 0 )<a name='2468'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2469'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO) + 1<a name='2470'>
    VBWGT1(I,J) = 1.0/3.0<a name='2471'>
    VBWGT2(I,J) = 0.0<a name='2472'>
    VBWGT3(I,J) = 2.0/3.0<a name='2473'>
    VBWGT4(I,J) = 0.0<a name='2474'>
   END SELECT<a name='2475'>
 RETURN<a name='2476'>
 END SUBROUTINE SUB5V<a name='2477'>
<A NAME='SUB6V'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SUB6V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2478'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>SUB6V</font>(I,J,IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4, &amp; <A href='../../call_to/SUB6V.html' TARGET='index'>1</A><a name='2479'>
                 I_PARENT_START,J_PARENT_START,           &amp; <font color=#447700>! nest start I and J in parent domain  <a name='2480'></font>
                 RATIO,                                   &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='2481'></font>
                 IDS,IDE,JDS,JDE,KDS,KDE,                 &amp; <font color=#447700>! target (nest) dimensions<a name='2482'></font>
                 IMS,IME,JMS,JME,KMS,KME,                 &amp;<a name='2483'>
                 ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2484'>
 IMPLICIT NONE<a name='2485'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2486'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2487'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2488'>
 INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='2489'>
 INTEGER,    INTENT(IN   )                            :: RATIO<a name='2490'>
 REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='2491'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIV,JJV<a name='2492'>
<font color=#447700>!LOCAL VARIABLES<a name='2493'></font>
 INTEGER                                              :: I,J<a name='2494'>
 INTEGER                                              :: IP<a name='2495'>
  IP = MOD(I,RATIO)<a name='2496'>
  SELECT CASE(IP)<a name='2497'>
   CASE ( 1 )<a name='2498'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO) - 1<a name='2499'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO) + 1<a name='2500'>
    VBWGT1(I,J) = 2.0/9.0<a name='2501'>
    VBWGT2(I,J) = 2.0/9.0<a name='2502'>
    VBWGT3(I,J) = 4.0/9.0<a name='2503'>
    VBWGT4(I,J) = 1.0/9.0<a name='2504'>
   CASE ( 2 )<a name='2505'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2506'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO) <a name='2507'>
    VBWGT1(I,J) = 1.0/3.0<a name='2508'>
    VBWGT2(I,J) = 0.0<a name='2509'>
    VBWGT3(I,J) = 0.0<a name='2510'>
    VBWGT4(I,J) = 2.0/3.0<a name='2511'>
   CASE ( 0 )<a name='2512'>
    IIV(I,J)    = I_PARENT_START + INT((I-1)/RATIO)<a name='2513'>
    JJV(I,J)    = J_PARENT_START + INT((J-1)/RATIO) + 1<a name='2514'>
    VBWGT1(I,J) = 2.0/3.0<a name='2515'>
    VBWGT2(I,J) = 0.0<a name='2516'>
    VBWGT3(I,J) = 1.0/3.0<a name='2517'>
    VBWGT4(I,J) = 0.0<a name='2518'>
   END SELECT<a name='2519'>
 RETURN<a name='2520'>
 END SUBROUTINE SUB6V<a name='2521'>
<a name='2522'>
<a name='2523'>
<font color=#447700>!------------------------------------------------------------------------------<a name='2524'></font>
<font color=#447700>!<a name='2525'></font>
<A NAME='WEIGTS_CHECK'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#WEIGTS_CHECK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2526'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>WEIGTS_CHECK</font>(HBWGT1,HBWGT2,HBWGT3,HBWGT4,       &amp;  <A href='../../call_to/WEIGTS_CHECK.html' TARGET='index'>1</A>,<A href='../../call_from/WEIGTS_CHECK.html' TARGET='index'>6</A><a name='2527'>
                        VBWGT1,VBWGT2,VBWGT3,VBWGT4,       &amp;<a name='2528'>
                        IDS,IDE,JDS,JDE,KDS,KDE,           &amp;<a name='2529'>
                        IMS,IME,JMS,JME,KMS,KME,           &amp; <a name='2530'>
                        ITS,ITE,JTS,JTE,KTS,KTE            )<a name='2531'>
<a name='2532'>
  IMPLICIT NONE<a name='2533'>
  INTEGER, INTENT(IN)                                 :: IDS,IDE,JDS,JDE,KDS,KDE,  &amp;<a name='2534'>
                                                         IMS,IME,JMS,JME,KMS,KME,  &amp;<a name='2535'>
                                                         ITS,ITE,JTS,JTE,KTS,KTE<a name='2536'>
  REAL,    DIMENSION(IMS:IME,JMS:JME),   INTENT(IN)   :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='2537'>
  REAL,    DIMENSION(IMS:IME,JMS:JME),   INTENT(IN)   :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='2538'>
<a name='2539'>
<font color=#447700>! local <a name='2540'></font>
<a name='2541'>
  REAL , PARAMETER :: EPSI=1.0E-3<a name='2542'>
  INTEGER          :: I,J<a name='2543'>
  REAL             :: ADDSUM<a name='2544'>
 CHARACTER(LEN=255):: message<a name='2545'>
<a name='2546'>
<font color=#447700>!-------------------------------------------------------------------------------------<a name='2547'></font>
<a name='2548'>
<font color=#447700>! DUE TO THE NEED FOR HALO EXCHANGES IN PARALLEL RUNS ONE HAS TO ENSURE CONSISTENT <a name='2549'></font>
<font color=#447700>! USAGE OF NUMBER OF PROCESSORS BEFORE ANY FURTHER COMPUTATIONS. WE INTRODUCE THIS<a name='2550'></font>
<font color=#447700>! CHECK FIRST<a name='2551'></font>
<a name='2552'>
  IF((ITE-ITS) .LE. 5 .OR. (JTE-JTS) .LE. 5)THEN<a name='2553'>
   WRITE(message,*)'ITE-ITS=',ITE-ITS,'JTE-JTS=',JTE-JTS<a name='2554'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#WEIGTS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_170">(trim(message))<a name='2555'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#WEIGTS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_127"> ('NESTED DOMAIN:PLEASE OPTIMIZE THE NUMBER OF PROCESSES; TRY SQUARES OF NUMBERS') <a name='2556'>
  ENDIF<a name='2557'>
<a name='2558'>
<font color=#447700>!  <a name='2559'></font>
<font color=#447700>! NOW CHECK WEIGHTS<a name='2560'></font>
<font color=#447700>!<a name='2561'></font>
<a name='2562'>
  ADDSUM=0.<a name='2563'>
  DO J = JTS, MIN(JTE,JDE-1)<a name='2564'>
   DO I = ITS, MIN(ITE,IDE-1)<a name='2565'>
      ADDSUM=HBWGT1(I,J)+HBWGT2(I,J)+HBWGT3(I,J)+HBWGT4(I,J)<a name='2566'>
      IF(ABS(1.0-ADDSUM) .GE. EPSI)THEN<a name='2567'>
       WRITE(message,*)'I=',I,'J=',J,'WEIGHTS=',HBWGT1(I,J),HBWGT2(I,J),HBWGT3(I,J),HBWGT4(I,J),1-ADDSUM<a name='2568'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#WEIGTS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_171">(trim(message))<a name='2569'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#WEIGTS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_128"> ('NESTED DOMAIN:SOMETHING IS WRONG WITH WEIGHTS COMPUTATION AT MASS POINTS') <a name='2570'>
      ENDIF<a name='2571'>
   ENDDO<a name='2572'>
  ENDDO<a name='2573'>
<a name='2574'>
  ADDSUM=0.<a name='2575'>
  DO J = JTS, MIN(JTE,JDE-1)<a name='2576'>
   DO I = ITS, MIN(ITE,IDE-1)<a name='2577'>
      ADDSUM=VBWGT1(I,J)+VBWGT2(I,J)+VBWGT3(I,J)+VBWGT4(I,J)<a name='2578'>
      IF(ABS(1.0-ADDSUM) .GE. EPSI)THEN <a name='2579'>
       WRITE(message,*)'I=',I,'J=',J,'WEIGHTS=',VBWGT1(I,J),VBWGT2(I,J),VBWGT3(I,J),VBWGT4(I,J),1-ADDSUM<a name='2580'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#WEIGTS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_172">(trim(message))<a name='2581'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#WEIGTS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_129"> ('NESTED DOMAIN:SOMETHING IS WRONG WITH WEIGHTS COMPUTATION AT VELOCITY POINTS')<a name='2582'>
      ENDIF<a name='2583'>
   ENDDO<a name='2584'>
  ENDDO<a name='2585'>
<a name='2586'>
END SUBROUTINE WEIGTS_CHECK<a name='2587'>
<a name='2588'>
<font color=#447700>!-----------------------------------------------------------------------------------<a name='2589'></font>
<a name='2590'>
<A NAME='BOUNDS_CHECK'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2591'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>BOUNDS_CHECK</font>( IIH,JJH,IIV,JJV,          &amp; <A href='../../call_to/BOUNDS_CHECK.html' TARGET='index'>1</A>,<A href='../../call_from/BOUNDS_CHECK.html' TARGET='index'>7</A><a name='2592'>
                         IPOS,JPOS,SHW,            &amp;<a name='2593'>
                         IDS,IDE,JDS,JDE,KDS,KDE,  &amp; <font color=#447700>!<a name='2594'></font>
                         IMS,IME,JMS,JME,KMS,KME,  &amp; <font color=#447700>! nested grid configuration<a name='2595'></font>
                         ITS,ITE,JTS,JTE,KTS,KTE   )<a name='2596'>
<a name='2597'>
 IMPLICIT NONE<a name='2598'>
 INTEGER, INTENT(IN) :: IPOS,JPOS,SHW,            &amp;<a name='2599'>
                        IDS,IDE,JDS,JDE,KDS,KDE,  &amp; <a name='2600'>
                        IMS,IME,JMS,JME,KMS,KME,  &amp; <a name='2601'>
                        ITS,ITE,JTS,JTE,KTS,KTE   <a name='2602'>
<a name='2603'>
 INTEGER, DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IIH,JJH,IIV,JJV<a name='2604'>
<a name='2605'>
<font color=#447700>! local variables<a name='2606'></font>
<a name='2607'>
 INTEGER :: I,J<a name='2608'>
 CHARACTER(LEN=255)                 :: message<a name='2609'>
<a name='2610'>
<font color=#447700>!***  Gopal       - Initial version <a name='2611'></font>
<font color=#447700>!***<a name='2612'></font>
<font color=#447700>!*** CHECK DOMAIN BOUNDS BEFORE PROCEEDING TO INTERPOLATION<a name='2613'></font>
<font color=#447700>!<a name='2614'></font>
<font color=#447700>!============================================================================<a name='2615'></font>
<a name='2616'>
  IF(IPOS .LE. SHW)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_130">('NESTED DOMAIN TOO CLOSE TO PARENTs X-BOUNDARY')<a name='2617'>
  IF(JPOS .LE. SHW)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_131">('NESTED DOMAIN TOO CLOSE TO PARENTs Y-BOUNDARY')<a name='2618'>
<a name='2619'>
  DO J = JTS, MIN(JTE,JDE-1)<a name='2620'>
   DO I = ITS, MIN(ITE,IDE-1)<a name='2621'>
      IF(IIH(I,J) .EQ. 0)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_132"> ('IIH=0: SOMETHING IS WRONG')<a name='2622'>
      IF(JJH(I,J) .EQ. 0)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_133"> ('JJH=0: SOMETHING IS WRONG')<a name='2623'>
   ENDDO<a name='2624'>
  ENDDO<a name='2625'>
<a name='2626'>
  DO J = JTS, MIN(JTE,JDE-1)<a name='2627'>
   DO I = ITS, MIN(ITE,IDE-1)<a name='2628'>
      IF(IIH(I,J) .LT. (IPOS-SHW) .OR. JJH(I,J) .LT. (JPOS-SHW) .OR.   &amp;<a name='2629'>
         IIV(I,J) .LT. (IPOS-SHW) .OR. JJV(I,J) .LT. (JPOS-SHW))THEN<a name='2630'>
         WRITE(message,*)I,J,IIH(I,J),IPOS,JJH(I,J),JPOS,SHW<a name='2631'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_173">(trim(message))<a name='2632'>
         WRITE(message,*)I,J,IIV(I,J),IPOS,JJV(I,J),JPOS,SHW<a name='2633'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_174">(trim(message))<a name='2634'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BOUNDS_CHECK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_134"> ('CHECK NESTED DOMAIN BOUNDS: TRY INCREASING STENCIL WIDTH') <a name='2635'>
      ENDIF<a name='2636'>
   ENDDO<a name='2637'>
  ENDDO<a name='2638'>
<a name='2639'>
END SUBROUTINE BOUNDS_CHECK<a name='2640'>
<a name='2641'>
<font color=#447700>!==========================================================================================<a name='2642'></font>
<a name='2643'>
<a name='2644'>
<A NAME='BASE_STATE_PARENT'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BASE_STATE_PARENT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2645'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>BASE_STATE_PARENT</font> ( Z3d,Q3d,T3d,PSTD,        &amp;,<A href='../../call_from/BASE_STATE_PARENT.html' TARGET='index'>4</A><a name='2646'>
                               PINT,T,Q,CWM,            &amp;<a name='2647'>
                               FIS,QS,PD,PDTOP,PTOP,    &amp;<a name='2648'>
                               ETA1,ETA2,               &amp;<a name='2649'>
                               DETA1,DETA2,             &amp;<a name='2650'>
                               IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='2651'>
                               IMS,IME,JMS,JME,KMS,KME, &amp;<a name='2652'>
                               ITS,ITE,JTS,JTE,KTS,KTE  )<a name='2653'>
<font color=#447700>!<a name='2654'></font>
<a name='2655'>
 USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BASE_STATE_PARENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_33"><a name='2656'>
 IMPLICIT NONE<a name='2657'>
 INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='2658'>
 INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='2659'>
 INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='2660'>
 REAL,       INTENT(IN   )                            :: PDTOP,PTOP<a name='2661'>
 REAL, DIMENSION(KMS:KME),                 INTENT(IN) :: ETA1,ETA2,DETA1,DETA2<a name='2662'>
 REAL, DIMENSION(IMS:IME,JMS:JME),         INTENT(IN) :: FIS,PD,QS<a name='2663'>
 REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME), INTENT(IN) :: PINT,T,Q,CWM<a name='2664'>
 REAL, DIMENSION(KMS:KME),                 INTENT(OUT):: PSTD<a name='2665'>
 REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME), INTENT(OUT):: Z3d,Q3d,T3d<a name='2666'>
<a name='2667'>
<font color=#447700>! local<a name='2668'></font>
<a name='2669'>
 INTEGER,PARAMETER                                    :: JTB=134<a name='2670'>
 INTEGER                                              :: I,J,K,ILOC,JLOC<a name='2671'>
 REAL, PARAMETER                                      :: LAPSR=6.5E-3, GI=1./G,D608=0.608<a name='2672'>
 REAL, PARAMETER                                      :: COEF3=287.05*GI*LAPSR, COEF2=-1./COEF3<a name='2673'>
 REAL, PARAMETER                                      :: TRG=2.0*R_D*GI,LAPSI=1.0/LAPSR<a name='2674'>
 REAL, PARAMETER                                      :: P_REF=103000.<a name='2675'>
 REAL                                                 :: A,B,APELP,RTOPP,DZ,ZMID<a name='2676'>
 REAL, DIMENSION(IMS:IME,JMS:JME)                     :: SLP,TSFC,ZMSLP<a name='2677'>
 REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME)             :: Z3d_IN<a name='2678'>
 REAL,DIMENSION(JTB)                                  :: PIN,ZIN,Y2,PIO,ZOUT,DUM1,DUM2<a name='2679'>
 REAL,DIMENSION(JTB)                                  :: QIN,QOUT,TIN,TOUT<a name='2680'>
<font color=#447700>!-------------------------------------------------------------------------------------- <a name='2681'></font>
<a name='2682'>
<font color=#447700>!  CLEAN Z3D ARRAY FIRST<a name='2683'></font>
<a name='2684'>
    DO K=KDS,KDE<a name='2685'>
     DO J = JTS, MIN(JTE,JDE-1)<a name='2686'>
      DO I = ITS, MIN(ITE,IDE-1)<a name='2687'>
       Z3d(I,J,K)=0.0<a name='2688'>
       T3d(I,J,K)=0.0<a name='2689'>
       Q3d(I,J,K)=0.0<a name='2690'>
      ENDDO<a name='2691'>
     ENDDO<a name='2692'>
    ENDDO <a name='2693'>
<a name='2694'>
<a name='2695'>
<font color=#447700>!  DETERMINE THE HEIGHTS ON THE PARENT DOMAIN<a name='2696'></font>
<a name='2697'>
    DO J = JTS, MIN(JTE,JDE-1)<a name='2698'>
      DO I = ITS, MIN(ITE,IDE-1)<a name='2699'>
       Z3d_IN(I,J,1)=FIS(I,J)*GI<a name='2700'>
      ENDDO<a name='2701'>
    ENDDO <a name='2702'>
<a name='2703'>
    DO K = KDS,KDE-1<a name='2704'>
     DO J = JTS, MIN(JTE,JDE-1)<a name='2705'>
      DO I = ITS, MIN(ITE,IDE-1)<a name='2706'>
        APELP    = (PINT(I,J,K+1)+PINT(I,J,K))<a name='2707'>
<font color=#447700>!       RTOPP    = TRG*T(I,J,K)*(1.0+Q(I,J,K)*P608-CWM(I,J,K))/APELP<a name='2708'></font>
        RTOPP    = TRG*T(I,J,K)*(1.0+Q(I,J,K)*P608)/APELP<a name='2709'>
        DZ       = RTOPP*(DETA1(K)*PDTOP+DETA2(K)*PD(I,J))   <font color=#447700>! (RTv/P_TOT)*D(P_HYDRO)<a name='2710'></font>
        Z3d_IN(I,J,K+1) = Z3d_IN(I,J,K) + DZ<a name='2711'>
      ENDDO<a name='2712'>
     ENDDO<a name='2713'>
    ENDDO<a name='2714'>
<a name='2715'>
<a name='2716'>
<font color=#447700>!  CONSTRUCT STANDARD ISOBARIC SURFACES <a name='2717'></font>
<a name='2718'>
    DO K=KDS,KDE                         <font color=#447700>! target points in model interface levels (pint)<a name='2719'></font>
       PSTD(K) = ETA1(K)*PDTOP + ETA2(K)*(P_REF -PDTOP - PTOP) + PTOP<a name='2720'>
    ENDDO<a name='2721'>
<a name='2722'>
<font color=#447700>!   DETERMINE THE MSLP USE THAT TO CREATE HEIGHTS AT 1000. mb LEVEL. THESE HEIGHTS  <a name='2723'></font>
<font color=#447700>!   MAY ONLY BE USED IN VERTICAL INTERPOLATION TO ISOBARIC SURFACES WHICH ARE LOCATED<a name='2724'></font>
<font color=#447700>!   BELOW GROUND LEVEL. <a name='2725'></font>
<a name='2726'>
    DO J = JTS, MIN(JTE,JDE-1)<a name='2727'>
      DO I = ITS, MIN(ITE,IDE-1)<a name='2728'>
        TSFC(I,J) = T(I,J,1)*(1.+D608*Q(I,J,1)) + LAPSR*(Z3d_IN(I,J,1)+Z3d_IN(I,J,2))*0.5<a name='2729'>
        A         = LAPSR*Z3d_IN(I,J,1)/TSFC(I,J)<a name='2730'>
        SLP(I,J)  = PINT(I,J,1)*(1-A)**COEF2    <font color=#447700>! sea level pressure <a name='2731'></font>
        B         = (PSTD(1)/SLP(I,J))**COEF3<a name='2732'>
        ZMSLP(I,J)= TSFC(I,J)*LAPSI*(1.0 - B)   <font color=#447700>! Height at 1000. mb level<a name='2733'></font>
      ENDDO<a name='2734'>
    ENDDO<a name='2735'>
<a name='2736'>
<font color=#447700>!   INTERPOLATE Z3d_IN TO STANDARD PRESSURE INTERFACES. FOR LEVELS BELOW<a name='2737'></font>
<font color=#447700>!   GROUND USE ZMSLP(I,J)<a name='2738'></font>
<a name='2739'>
    DO J = JTS, MIN(JTE,JDE-1)<a name='2740'>
      DO I = ITS, MIN(ITE,IDE-1)<a name='2741'>
<font color=#447700>!    <a name='2742'></font>
<font color=#447700>!     clean local array before use of spline<a name='2743'></font>
<a name='2744'>
      PIN=0.;ZIN=0.;Y2=0;PIO=0.;ZOUT=0.;DUM1=0.;DUM2=0.<a name='2745'>
<a name='2746'>
       DO K=KDS,KDE                           <font color=#447700>! inputs at model interfaces <a name='2747'></font>
         PIN(K) = PINT(I,J,KDE-K+1)<a name='2748'>
         ZIN(K) = Z3d_IN(I,J,KDE-K+1)<a name='2749'>
       ENDDO<a name='2750'>
<a name='2751'>
       IF(PINT(I,J,1) .LE. PSTD(1))THEN<a name='2752'>
          PIN(KDE) = PSTD(1)<a name='2753'>
          ZIN(KDE) = ZMSLP(I,J)<a name='2754'>
       ENDIF<a name='2755'>
<font color=#447700>!<a name='2756'></font>
       Y2(1  )=0.<a name='2757'>
       Y2(KDE)=0.<a name='2758'>
<font color=#447700>!<a name='2759'></font>
       DO K=KDS,KDE<a name='2760'>
          PIO(K)=PSTD(K)<a name='2761'>
       ENDDO<a name='2762'>
<font color=#447700>!<a name='2763'></font>
       CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SPLINE1'>SPLINE1</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BASE_STATE_PARENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPLINE1_1">(I,J,JTB,KDE,PIN,ZIN,Y2,KDE,PIO,ZOUT,DUM1,DUM2)  <font color=#447700>! interpolate<a name='2764'></font>
<font color=#447700>!<a name='2765'></font>
<a name='2766'>
       DO K=KDS,KDE                           <font color=#447700>! inputs at model interfaces<a name='2767'></font>
         Z3d(I,J,K)=ZOUT(K)<a name='2768'>
       ENDDO<a name='2769'>
<a name='2770'>
      ENDDO<a name='2771'>
    ENDDO<a name='2772'>
<font color=#447700>!<a name='2773'></font>
<font color=#447700>!   INTERPOLATE TEMPERATURE ONTO THE STANDARD PRESSURE LEVELS. FOR LEVELS BELOW  <a name='2774'></font>
<font color=#447700>!   GROUND USE A LAPSE RATE ATMOSPHERE <a name='2775'></font>
<font color=#447700>!<a name='2776'></font>
    DO J = JTS, MIN(JTE,JDE-1)<a name='2777'>
      DO I = ITS, MIN(ITE,IDE-1)<a name='2778'>
<font color=#447700>!  <a name='2779'></font>
<font color=#447700>!     clean local array before use of spline or linear interpolation<a name='2780'></font>
<font color=#447700>!<a name='2781'></font>
      PIN=0.;TIN=0.;Y2=0;PIO=0.;TOUT=0.;DUM1=0.;DUM2=0.<a name='2782'>
<a name='2783'>
       DO K=KDS+1,KDE                           <font color=#447700>! inputs at model levels<a name='2784'></font>
         PIN(K-1) = EXP((ALOG(PINT(I,J,KDE-K+1))+ALOG(PINT(I,J,KDE-K+2)))*0.5)<a name='2785'>
         TIN(K-1) = T(I,J,KDE-K+1)<a name='2786'>
       ENDDO<a name='2787'>
<a name='2788'>
       IF(PINT(I,J,1) .LE. PSTD(1))THEN<a name='2789'>
         PIN(KDE-1) = EXP((ALOG(PSTD(1))+ALOG(PSTD(2)))*0.5)<a name='2790'>
         ZMID     = 0.5*(Z3d_IN(I,J,1)+Z3d_IN(I,J,2))<a name='2791'>
         TIN(KDE-1) = T(I,J,1) + LAPSR*(ZMID-ZMSLP(I,J))<a name='2792'>
       ENDIF<a name='2793'>
<font color=#447700>!<a name='2794'></font>
       Y2(1    )=0.<a name='2795'>
       Y2(KDE-1)=0.<a name='2796'>
<font color=#447700>!<a name='2797'></font>
       DO K=KDS,KDE-1<a name='2798'>
          PIO(K)=EXP((ALOG(PSTD(K))+ALOG(PSTD(K+1)))*0.5)<a name='2799'>
       ENDDO<a name='2800'>
<a name='2801'>
       CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SPLINE1'>SPLINE1</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BASE_STATE_PARENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPLINE1_2">(I,J,JTB,KDE-1,PIN,TIN,Y2,KDE-1,PIO,TOUT,DUM1,DUM2)  <font color=#447700>! interpolate<a name='2802'></font>
<a name='2803'>
<a name='2804'>
       DO K=KDS,KDE-1                           <font color=#447700>! inputs at model levels<a name='2805'></font>
         T3d(I,J,K)=TOUT(K)<a name='2806'>
       ENDDO<a name='2807'>
<a name='2808'>
      ENDDO<a name='2809'>
    ENDDO<a name='2810'>
<a name='2811'>
<font color=#447700>!<a name='2812'></font>
<font color=#447700>!   INTERPOLATE MOISTURE ONTO THE STANDARD PRESSURE LEVELS. FOR LEVELS BELOW <a name='2813'></font>
<font color=#447700>!   GROUND USE THE SURFACE MOISTURE <a name='2814'></font>
<font color=#447700>!<a name='2815'></font>
    DO J = JTS, MIN(JTE,JDE-1)<a name='2816'>
      DO I = ITS, MIN(ITE,IDE-1)<a name='2817'>
<font color=#447700>!<a name='2818'></font>
<font color=#447700>!     clean local array before use of spline or linear interpolation<a name='2819'></font>
<a name='2820'>
<a name='2821'>
      PIN=0.;QIN=0.;Y2=0;PIO=0.;QOUT=0.;DUM1=0.;DUM2=0.<a name='2822'>
<a name='2823'>
       DO K=KDS+1,KDE                           <font color=#447700>! inputs at model levels<a name='2824'></font>
         PIN(K-1) = EXP((ALOG(PINT(I,J,KDE-K+1))+ALOG(PINT(I,J,KDE-K+2)))*0.5)<a name='2825'>
         QIN(K-1) = Q(I,J,KDE-K+1)<a name='2826'>
       ENDDO<a name='2827'>
<a name='2828'>
       IF(PINT(I,J,1) .LE. PSTD(1))THEN<a name='2829'>
          PIN(KDE-1) = EXP((ALOG(PSTD(1))+ALOG(PSTD(2)))*0.5)<a name='2830'>
<font color=#447700>!         QIN(KDE-1) =  QS(I,J)<a name='2831'></font>
       ENDIF<a name='2832'>
<a name='2833'>
       Y2(1    )=0.<a name='2834'>
       Y2(KDE-1)=0.<a name='2835'>
<font color=#447700>!<a name='2836'></font>
       DO K=KDS,KDE-1<a name='2837'>
          PIO(K)=EXP((ALOG(PSTD(K))+ALOG(PSTD(K+1)))*0.5)<a name='2838'>
       ENDDO<a name='2839'>
<a name='2840'>
       CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SPLINE1'>SPLINE1</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#BASE_STATE_PARENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPLINE1_3">(I,J,JTB,KDE-1,PIN,QIN,Y2,KDE-1,PIO,QOUT,DUM1,DUM2)  <font color=#447700>! interpolate<a name='2841'></font>
<a name='2842'>
       DO K=KDS,KDE-1                          <font color=#447700>! inputs at model levels<a name='2843'></font>
         Q3d(I,J,K)=QOUT(K)<a name='2844'>
       ENDDO<a name='2845'>
<a name='2846'>
      ENDDO<a name='2847'>
    ENDDO<a name='2848'>
<a name='2849'>
END SUBROUTINE BASE_STATE_PARENT<a name='2850'>
<font color=#447700>!=============================================================================<a name='2851'></font>
<A NAME='SPLINE1'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SPLINE1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2852'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SPLINE1</font>(I,J,JTBX,NOLD,XOLD,YOLD,Y2,NNEW,XNEW,YNEW,P,Q) <A href='../../call_to/SPLINE1.html' TARGET='index'>3</A>,<A href='../../call_from/SPLINE1.html' TARGET='index'>3</A><a name='2853'>
<font color=#447700>!<a name='2854'></font>
<font color=#447700>!   ******************************************************************<a name='2855'></font>
<font color=#447700>!   *                                                                *<a name='2856'></font>
<font color=#447700>!   *  THIS IS A ONE-DIMENSIONAL CUBIC SPLINE FITTING ROUTINE        *<a name='2857'></font>
<font color=#447700>!   *  PROGRAMED FOR A SMALL SCALAR MACHINE.                         *<a name='2858'></font>
<font color=#447700>!   *                                                                *<a name='2859'></font>
<font color=#447700>!   *  PROGRAMER Z. JANJIC                                           *<a name='2860'></font>
<font color=#447700>!   *                                                                *<a name='2861'></font>
<font color=#447700>!   *  NOLD - NUMBER OF GIVEN VALUES OF THE FUNCTION.  MUST BE GE 3. *<a name='2862'></font>
<font color=#447700>!   *  XOLD - LOCATIONS OF THE POINTS AT WHICH THE VALUES OF THE     *<a name='2863'></font>
<font color=#447700>!   *         FUNCTION ARE GIVEN.  MUST BE IN ASCENDING ORDER.       *<a name='2864'></font>
<font color=#447700>!   *  YOLD - THE GIVEN VALUES OF THE FUNCTION AT THE POINTS XOLD.   *<a name='2865'></font>
<font color=#447700>!   *  Y2   - THE SECOND DERIVATIVES AT THE POINTS XOLD.  IF NATURAL *<a name='2866'></font>
<font color=#447700>!   *         SPLINE IS FITTED Y2(1)=0. AND Y2(NOLD)=0. MUST BE      *<a name='2867'></font>
<font color=#447700>!   *         SPECIFIED.                                             *<a name='2868'></font>
<font color=#447700>!   *  NNEW - NUMBER OF VALUES OF THE FUNCTION TO BE CALCULATED.     *<a name='2869'></font>
<font color=#447700>!   *  XNEW - LOCATIONS OF THE POINTS AT WHICH THE VALUES OF THE     *<a name='2870'></font>
<font color=#447700>!   *         FUNCTION ARE CALCULATED.  XNEW(K) MUST BE GE XOLD(1)   *<a name='2871'></font>
<font color=#447700>!   *         AND LE XOLD(NOLD).                                     *<a name='2872'></font>
<font color=#447700>!   *  YNEW - THE VALUES OF THE FUNCTION TO BE CALCULATED.           *<a name='2873'></font>
<font color=#447700>!   *  P, Q - AUXILIARY VECTORS OF THE LENGTH NOLD-2.                *<a name='2874'></font>
<font color=#447700>!   *                                                                *<a name='2875'></font>
<font color=#447700>!   ******************************************************************<a name='2876'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2877'></font>
      IMPLICIT NONE<a name='2878'>
<font color=#447700>!---------------------------------------------------------------------<a name='2879'></font>
      INTEGER,INTENT(IN) :: I,J,JTBX,NNEW,NOLD<a name='2880'>
      REAL,DIMENSION(JTBX),INTENT(IN) :: XNEW,XOLD,YOLD<a name='2881'>
      REAL,DIMENSION(JTBX),INTENT(INOUT) :: P,Q,Y2<a name='2882'>
      REAL,DIMENSION(JTBX),INTENT(OUT) :: YNEW<a name='2883'>
<font color=#447700>!<a name='2884'></font>
      INTEGER :: II,JJ,K,K1,K2,KOLD,NOLDM1<a name='2885'>
      REAL :: AK,BK,CK,DEN,DX,DXC,DXL,DXR,DYDXL,DYDXR                 &amp;<a name='2886'>
             ,RDX,RTDXC,X,XK,XSQ,Y2K,Y2KP1<a name='2887'>
      CHARACTER(LEN=255) :: message<a name='2888'>
<font color=#447700>!---------------------------------------------------------------------<a name='2889'></font>
<a name='2890'>
<font color=#447700>!     debug<a name='2891'></font>
<a name='2892'>
      II=9999 <font color=#447700>!67 !35 !50   !4<a name='2893'></font>
      JJ=9999 <font color=#447700>!31 !73 !115  !192<a name='2894'></font>
#if ( HWRF == 1 )<a name='2895'>
      IF(I.eq.II.and.J.eq.JJ)THEN<a name='2896'>
        WRITE(message,*)'DEBUG in SPLINE1:HSO= ',xnew(1:nold)<a name='2897'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SPLINE1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_108">(1,trim(message))<a name='2898'>
        DO K=1,NOLD<a name='2899'>
         WRITE(message,*)'DEBUG in SPLINE1:L,ZETAI,PINTI= ' &amp;<a name='2900'>
                        ,K,YOLD(K),XOLD(K)<a name='2901'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SPLINE1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_109">(1,trim(message))<a name='2902'>
        ENDDO <a name='2903'>
      ENDIF <a name='2904'>
#endif<a name='2905'>
<a name='2906'>
<font color=#447700>!<a name='2907'></font>
      NOLDM1=NOLD-1<a name='2908'>
<font color=#447700>!<a name='2909'></font>
      DXL=XOLD(2)-XOLD(1)<a name='2910'>
      DXR=XOLD(3)-XOLD(2)<a name='2911'>
      DYDXL=(YOLD(2)-YOLD(1))/DXL<a name='2912'>
      DYDXR=(YOLD(3)-YOLD(2))/DXR<a name='2913'>
      RTDXC=0.5/(DXL+DXR)<a name='2914'>
<font color=#447700>!<a name='2915'></font>
      P(1)= RTDXC*(6.*(DYDXR-DYDXL)-DXL*Y2(1))<a name='2916'>
      Q(1)=-RTDXC*DXR<a name='2917'>
<font color=#447700>!<a name='2918'></font>
      IF(NOLD.EQ.3)GO TO 150<a name='2919'>
<font color=#447700>!---------------------------------------------------------------------<a name='2920'></font>
      K=3<a name='2921'>
<font color=#447700>!<a name='2922'></font>
  100 DXL=DXR<a name='2923'>
      DYDXL=DYDXR<a name='2924'>
      DXR=XOLD(K+1)-XOLD(K)<a name='2925'>
      DYDXR=(YOLD(K+1)-YOLD(K))/DXR<a name='2926'>
      DXC=DXL+DXR<a name='2927'>
      DEN=1./(DXL*Q(K-2)+DXC+DXC)<a name='2928'>
<font color=#447700>!<a name='2929'></font>
      P(K-1)= DEN*(6.*(DYDXR-DYDXL)-DXL*P(K-2))<a name='2930'>
      Q(K-1)=-DEN*DXR<a name='2931'>
<font color=#447700>!<a name='2932'></font>
      K=K+1<a name='2933'>
      IF(K.LT.NOLD)GO TO 100<a name='2934'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2935'></font>
  150 K=NOLDM1<a name='2936'>
<font color=#447700>!<a name='2937'></font>
  200 Y2(K)=P(K-1)+Q(K-1)*Y2(K+1)<a name='2938'>
<font color=#447700>!<a name='2939'></font>
      K=K-1<a name='2940'>
      IF(K.GT.1)GO TO 200<a name='2941'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2942'></font>
      K1=1<a name='2943'>
<font color=#447700>!<a name='2944'></font>
  300 XK=XNEW(K1)<a name='2945'>
<font color=#447700>!<a name='2946'></font>
      DO 400 K2=2,NOLD<a name='2947'>
<font color=#447700>!<a name='2948'></font>
      IF(XOLD(K2).GT.XK)THEN<a name='2949'>
        KOLD=K2-1<a name='2950'>
        GO TO 450<a name='2951'>
      ENDIF<a name='2952'>
<font color=#447700>!<a name='2953'></font>
  400 CONTINUE<a name='2954'>
<font color=#447700>!<a name='2955'></font>
      YNEW(K1)=YOLD(NOLD)<a name='2956'>
      GO TO 600<a name='2957'>
<font color=#447700>!<a name='2958'></font>
  450 IF(K1.EQ.1)GO TO 500<a name='2959'>
      IF(K.EQ.KOLD)GO TO 550<a name='2960'>
<font color=#447700>!<a name='2961'></font>
  500 K=KOLD<a name='2962'>
<font color=#447700>!<a name='2963'></font>
      Y2K=Y2(K)<a name='2964'>
      Y2KP1=Y2(K+1)<a name='2965'>
      DX=XOLD(K+1)-XOLD(K)<a name='2966'>
      RDX=1./DX<a name='2967'>
<font color=#447700>!<a name='2968'></font>
      AK=.1666667*RDX*(Y2KP1-Y2K)<a name='2969'>
      BK=0.5*Y2K<a name='2970'>
      CK=RDX*(YOLD(K+1)-YOLD(K))-.1666667*DX*(Y2KP1+Y2K+Y2K)<a name='2971'>
<font color=#447700>!<a name='2972'></font>
  550 X=XK-XOLD(K)<a name='2973'>
      XSQ=X*X<a name='2974'>
<font color=#447700>!<a name='2975'></font>
      YNEW(K1)=AK*XSQ*X+BK*XSQ+CK*X+YOLD(K)<a name='2976'>
<a name='2977'>
<font color=#447700>!  debug<a name='2978'></font>
<a name='2979'>
#if ( HWRF == 1 )<a name='2980'>
      if(i.eq.ii.and.j.eq.jj)then<a name='2981'>
        write(message,*) 'DEBUG:: k1,xnew(k1),ynew(k1): ', k1,xnew(k1),ynew(k1)<a name='2982'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#SPLINE1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_110">(1,trim(message))<a name='2983'>
      endif<a name='2984'>
#endif<a name='2985'>
<a name='2986'>
<font color=#447700>!<a name='2987'></font>
  600 K1=K1+1<a name='2988'>
      IF(K1.LE.NNEW)GO TO 300<a name='2989'>
<a name='2990'>
      RETURN<a name='2991'>
      END SUBROUTINE SPLINE1<a name='2992'>
<font color=#447700>!---------------------------------------------------------------------<a name='2993'></font>
<a name='2994'>
<A NAME='NEST_TERRAIN'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2995'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>NEST_TERRAIN</font> ( nest, config_flags ) <A href='../../call_to/NEST_TERRAIN.html' TARGET='index'>2</A>,<A href='../../call_from/NEST_TERRAIN.html' TARGET='index'>24</A><a name='2996'>
<a name='2997'>
 USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_81"><a name='2998'>
 USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_46"><a name='2999'>
 USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_9"><a name='3000'>
 USE <A href='../../html_code/dyn_nmm/module_TERRAIN.F.html#MODULE_TERRAIN'>module_TERRAIN</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TERRAIN_1"><a name='3001'>
 USE <A href='../../html_code/io_netcdf/module_wrfsi_static.F90.html#WRFSI_STATIC'>wrfsi_static</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRFSI_STATIC_2"><a name='3002'>
 USE <A href='../../html_code/dyn_nmm/module_SMOOTH_TERRAIN.F.html#MODULE_SMOOTH_TERRAIN'>module_SMOOTH_TERRAIN</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SMOOTH_TERRAIN_1"><a name='3003'>
<a name='3004'>
 IMPLICIT NONE<a name='3005'>
<a name='3006'>
 TYPE(domain) , POINTER                        :: nest<a name='3007'>
 TYPE(grid_config_rec_type) , INTENT(IN)       :: config_flags<a name='3008'>
<a name='3009'>
<font color=#447700>!<a name='3010'></font>
<font color=#447700>! Local variables<a name='3011'></font>
<font color=#447700>!<a name='3012'></font>
<a name='3013'>
 LOGICAL, EXTERNAL                 :: wrf_dm_on_monitor<a name='3014'>
 INTEGER                           :: ids,ide,jds,jde,kds,kde<a name='3015'>
 INTEGER                           :: ims,ime,jms,jme,kms,kme<a name='3016'>
 INTEGER                           :: its,ite,jts,jte,kts,kte <a name='3017'>
 INTEGER                           :: i_parent_start, j_parent_start<a name='3018'>
 INTEGER                           :: parent_grid_ratio<a name='3019'>
 INTEGER                           :: n,i,j,ii,jj,nnxp,nnyp<a name='3020'>
 INTEGER                           :: i_start,j_start,level<a name='3021'>
 REAL, DIMENSION(1,1), TARGET      :: nothing<a name='3022'>
 REAL                              :: lah_nest_11, loh_nest_11<a name='3023'>
 INTEGER                           :: im_big, jm_big, i_add<a name='3024'>
 INTEGER                           :: im, jm<a name='3025'>
 CHARACTER(LEN=6)                  :: nestpath<a name='3026'>
<a name='3027'>
 integer                           :: input_type<a name='3028'>
 character(len=128)                :: input_fname<a name='3029'>
 character (len=32)                :: cname<a name='3030'>
 integer                           :: ndim<a name='3031'>
 character (len=3)                 :: memorder<a name='3032'>
 character (len=32)                :: stagger<a name='3033'>
 integer, dimension(3)             :: domain_start, domain_end<a name='3034'>
 integer                           :: wrftype<a name='3035'>
 character (len=128), dimension(3) :: dimnames<a name='3036'>
<a name='3037'>
 integer :: istatus<a name='3038'>
 integer :: handle<a name='3039'>
 integer :: comm_1, comm_2<a name='3040'>
<a name='3041'>
 real, allocatable, dimension(:,:,:) :: real_domain<a name='3042'>
<a name='3043'>
 character (len=10), dimension(24)  :: name = (/ "XLAT_M    ", &amp;<a name='3044'>
                                                "XLONG_M   ", &amp;<a name='3045'>
                                                "XLAT_V    ", &amp;<a name='3046'>
                                                "XLONG_V   ", &amp;<a name='3047'>
                                                "E         ", &amp;<a name='3048'>
                                                "F         ", &amp;<a name='3049'>
                                                "LANDMASK  ", &amp;<a name='3050'>
                                                "LANDUSEF  ", &amp;<a name='3051'>
                                                "LU_INDEX  ", &amp;<a name='3052'>
                                                "HCNVX     ", &amp;<a name='3053'>
                                                "HSTDV     ", &amp;<a name='3054'>
                                                "HASYW     ", &amp;<a name='3055'>
                                                "HASYS     ", &amp;<a name='3056'>
                                                "HASYSW    ", &amp;<a name='3057'>
                                                "HASYNW    ", &amp;<a name='3058'>
                                                "HLENW     ", &amp;<a name='3059'>
                                                "HLENS     ", &amp;<a name='3060'>
                                                "HLENSW    ", &amp;<a name='3061'>
                                                "HLENNW    ", &amp;<a name='3062'>
                                                "HANIS     ", &amp;<a name='3063'>
                                                "HSLOP     ", &amp;<a name='3064'>
                                                "HANGL     ", &amp;<a name='3065'>
                                                "HZMAX     ", &amp; <a name='3066'>
                                                "HGT_M     " /)<a name='3067'>
<a name='3068'>
 integer, parameter :: IO_BIN=1, IO_NET=2<a name='3069'>
<a name='3070'>
 integer :: io_form_auxinput2<a name='3071'>
 integer :: itsok,iteok,jtsok,jteok<a name='3072'>
<a name='3073'>
 CHARACTER(LEN=512) :: message<a name='3074'>
<a name='3075'>
 write(message,'("Nest d",I2," entering nest_terrain")') nest%id<a name='3076'>
 call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_111">(1,trim(message))<a name='3077'>
<a name='3078'>
 call <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>START_TIMING</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_1">()<a name='3079'>
<a name='3080'>
 write(message,*)"in NEST_TERRAIN config_flags%io_form_auxinput2 = ", config_flags%io_form_auxinput2<a name='3081'>
 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_112">(2,trim(message))<a name='3082'>
 write(message,*)"in NEST_TERRAIN config_flags%auxinput2_inname = ", config_flags%auxinput2_inname<a name='3083'>
 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_113">(2,trim(message))<a name='3084'>
<a name='3085'>
 io_form_auxinput2 = config_flags%io_form_auxinput2<a name='3086'>
 <font color=#447700>! NOTE: input_type (WRFSI vs. WPS) triggers based on auxinput1<a name='3087'></font>
 <font color=#447700>! (metgrid) because that is the only way we have of differentiating<a name='3088'></font>
 <font color=#447700>! between WRFSI and WPS<a name='3089'></font>
 if (config_flags%auxinput1_inname(1:7) == "met_nmm") then<a name='3090'>
    input_type = 2<a name='3091'>
 else<a name='3092'>
    input_type = 1<a name='3093'>
 end if<a name='3094'>
<a name='3095'>
<font color=#447700>!----------------------------------------------------------------------------------<a name='3096'></font>
<a name='3097'>
      IDS = nest%sd31<a name='3098'>
      IDE = nest%ed31<a name='3099'>
      JDS = nest%sd32<a name='3100'>
      JDE = nest%ed32<a name='3101'>
      KDS = nest%sd33<a name='3102'>
      KDE = nest%ed33<a name='3103'>
<a name='3104'>
      IMS = nest%sm31<a name='3105'>
      IME = nest%em31<a name='3106'>
      JMS = nest%sm32<a name='3107'>
      JME = nest%em32<a name='3108'>
      KMS = nest%sm33<a name='3109'>
      KME = nest%em33<a name='3110'>
<a name='3111'>
      ITS = nest%sp31<a name='3112'>
      ITE = nest%ep31<a name='3113'>
      JTS = nest%sp32<a name='3114'>
      JTE = nest%ep32<a name='3115'>
      KTS = nest%sp33<a name='3116'>
      KTE = nest%ep33<a name='3117'>
<a name='3118'>
      i_parent_start = nest%i_parent_start<a name='3119'>
      j_parent_start = nest%j_parent_start<a name='3120'>
      parent_grid_ratio = nest%parent_grid_ratio<a name='3121'>
<a name='3122'>
      NNXP=IDE-1<a name='3123'>
      NNYP=JDE-1<a name='3124'>
      im = NNXP<a name='3125'>
      jm = NNYP<a name='3126'>
<a name='3127'>
       <font color=#447700>! Find nesting depth:<a name='3128'></font>
       call <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#FIND_IJSTART_LEVEL'>find_ijstart_level</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_IJSTART_LEVEL_1"> (nest,i_start,j_start,level)<a name='3129'>
       write(message,*)" nest%id =", nest%id , " i_start,j_start,level =", i_start,j_start,level<a name='3130'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_114">(2,trim(message))<a name='3131'>
       if ( level &lt;= 0 ) then<a name='3132'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_135">('this routine NEST_TERRAIN should not be called for top-level domain')<a name='3133'>
       end if<a name='3134'>
<a name='3135'>
      <font color=#447700>! Monitor process stores high-resolution topography:<a name='3136'></font>
      IF ( nest%active_this_task ) THEN<a name='3137'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_1">(nest%id)<a name='3138'>
#ifdef DM_PARALLEL<a name='3139'>
      monitor_only: IF ( wrf_dm_on_monitor() ) THEN<a name='3140'>
#endif<a name='3141'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_115">(1,'NEST_TERRAIN MASTER PROCESS')<a name='3142'>
         call <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER'>MASTER</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MASTER_1">(IDS,IDE,JDS,JDE)<a name='3143'>
#ifdef DM_PARALLEL<a name='3144'>
      ELSE<a name='3145'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_116">(1,'NEST_TERRAIN CLIENT PROCESS')<a name='3146'>
         call <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CLIENT'>CLIENT</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLIENT_1">(IDS,IDE,JDS,JDE)<a name='3147'>
      ENDIF monitor_only<a name='3148'>
#endif<a name='3149'>
<a name='3150'>
      if(config_flags%terrain_smoothing==2) then     <a name='3151'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_117">(1,'Call fast smoother (smooth_terrain)')<a name='3152'>
         call <A href='../../html_code/dyn_nmm/module_SMOOTH_TERRAIN.F.html#SMOOTH_TERRAIN'>smooth_terrain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMOOTH_TERRAIN_1">(nest,12,12, &amp;<a name='3153'>
              IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='3154'>
              IMS,IME,JMS,JME,KMS,KME, &amp;<a name='3155'>
              ITS,ITE,JTS,JTE,KTS,KTE)<a name='3156'>
      elseif(config_flags%terrain_smoothing==1) then<a name='3157'>
         continue <font color=#447700>! already handled this case in the call to MASTER<a name='3158'></font>
      elseif(config_flags%terrain_smoothing==0) then<a name='3159'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_118">(1,'Terrain smoothing is disabled.')<a name='3160'>
      else<a name='3161'>
         write(message,*) 'Invalid option for terrain_smoothing: ',config_flags%terrain_smoothing<a name='3162'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_136">(message)<a name='3163'>
      endif<a name='3164'>
<a name='3165'>
     DO J = jts,jte<a name='3166'>
        DO I = its,ite<a name='3167'>
#ifdef IDEAL_NMM_TC<a name='3168'>
           nest%hres_fis(I,J)= 0.0 <font color=#447700>! idealized<a name='3169'></font>
#else<a name='3170'>
           nest%hres_fis(i,j)=9.81*nest%hres_avc(i,j)<a name='3171'>
#endif<a name='3172'>
        ENDDO<a name='3173'>
     ENDDO<a name='3174'>
<a name='3175'>
     write(message,'("Nest d",I0," nest_terrain")') nest%id<a name='3176'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_1"><a name='3177'>
      ENDIF<a name='3178'>
     call <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>END_TIMING</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_1">(trim(message))<a name='3179'>
<a name='3180'>
#ifdef IDEAL_NMM_TC<a name='3181'>
           return <font color=#447700>! move return after end_timing to prevent cnmax KWON<a name='3182'></font>
#endif<a name='3183'>
<a name='3184'>
CONTAINS<a name='3185'>
#ifdef DM_PARALLEL<a name='3186'>
<A NAME='CLIENT'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CLIENT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3187'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CLIENT</font>(IDS,IDE,JDS,JDE) <A href='../../call_to/CLIENT.html' TARGET='index'>1</A>,<A href='../../call_from/CLIENT.html' TARGET='index'>4</A><a name='3188'>
    IMPLICIT NONE<a name='3189'>
    integer, intent(in) :: IDS,IDE,JDS,JDE<a name='3190'>
    REAL, DIMENSION(1,1) :: avc_nest,lnd_nest<a name='3191'>
<a name='3192'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CLIENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_119">(1,'call wrf_global_to_patch_real in nest_terrain')<a name='3193'>
     call <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_REAL'>wrf_global_to_patch_real</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CLIENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_REAL_2">(avc_nest,nest%hres_avc,nest%domdesc,'z','xy', &amp;<a name='3194'>
                                   ids,   ide-1, jds,   jde-1, 1, 1, &amp;<a name='3195'>
                                   ims,   ime,   jms,   jme,   1, 1, &amp;<a name='3196'>
                                   its,   ite,   jts,   jte,   1, 1)<a name='3197'>
     call <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_REAL'>wrf_global_to_patch_real</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CLIENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_REAL_3">(lnd_nest,nest%hres_lnd,nest%domdesc,'z','xy', &amp;<a name='3198'>
                                   ids,   ide-1, jds,   jde-1, 1, 1, &amp;<a name='3199'>
                                   ims,   ime,   jms,   jme,   1, 1, &amp;<a name='3200'>
                                   its,   ite,   jts,   jte,   1, 1)<a name='3201'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CLIENT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_120">(1,'back from wrf_global_to_patch_real in nest_terrain')<a name='3202'>
<a name='3203'>
<a name='3204'>
  END SUBROUTINE CLIENT<a name='3205'>
#endif<a name='3206'>
<A NAME='MASTER'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3207'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>MASTER</font>(IDS,IDE,JDS,JDE) <A href='../../call_to/MASTER.html' TARGET='index'>1</A>,<A href='../../call_from/MASTER.html' TARGET='index'>13</A><a name='3208'>
    IMPLICIT NONE<a name='3209'>
    integer, intent(in) :: IDS,IDE,JDS,JDE<a name='3210'>
    REAL, DIMENSION(IDS:IDE,JDS:JDE)     :: avc_nest, lnd_nest<a name='3211'>
    type(nmm_terrain), pointer :: tr<a name='3212'>
<a name='3213'>
    nullify(tr)<a name='3214'>
    avc_nest = 0.0<a name='3215'>
    lnd_nest = 0.0<a name='3216'>
    <a name='3217'>
    tr=&gt;terrain_for(level,input_type,io_form_auxinput2)<a name='3218'>
<a name='3219'>
    <font color=#447700>! select subdomain from big fine grid<a name='3220'></font>
    i_add = mod(j_start+1,2) <a name='3221'>
    DO j=jds,jde<a name='3222'>
       DO i=ids,ide<a name='3223'>
          avc_nest(i,j) = tr%avc(i_start+i-1 + mod(j+1,2)*i_add, j_start+j-1)<a name='3224'>
          lnd_nest(i,j) = tr%lnd(i_start+i-1 + mod(j+1,2)*i_add, j_start+j-1)<a name='3225'>
       END DO<a name='3226'>
    END DO<a name='3227'>
<a name='3228'>
    i=1 ; j=1<a name='3229'>
    lah_nest_11 = tr%lah(i_start+i-1 + mod(j+1,2)*i_add, j_start+j-1)<a name='3230'>
    loh_nest_11 = tr%loh(i_start+i-1 + mod(j+1,2)*i_add, j_start+j-1)<a name='3231'>
<a name='3232'>
    IF(ABS(lah_nest_11-nest%HLAT(1,1)) .GE. 0.5 .OR.  &amp; <a name='3233'>
         ABS(loh_nest_11-nest%HLON(1,1)) .GE. 0.5)THEN <a name='3234'>
<a name='3235'>
       WRITE(message,*)'SOME MATCHING TEST i_parent_start, j_parent_start',i_parent_start,j_parent_start<a name='3236'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_175">(trim(message))<a name='3237'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_176">('WRFSI LAT      COMPUTED LAT')<a name='3238'>
       WRITE(message,*)lah_nest_11,nest%HLAT(1,1)<a name='3239'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_177">(trim(message))<a name='3240'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_178">('WRFSI LON      COMPUTED LON')<a name='3241'>
       WRITE(message,*)loh_nest_11,nest%HLON(1,1)<a name='3242'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_179">(trim(message))<a name='3243'>
<a name='3244'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_180">('CHECK WRFSI CONFIGURATION AND INPUT HIGH RESOLUTION TOPOGRAPHY AND/OR GRID RATIO') <a name='3245'>
#ifndef IDEAL_NMM_TC<a name='3246'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_137">('LATLON MISMATCH: ERROR READING static FILE FOR THE NEST')<a name='3247'>
#endif<a name='3248'>
    ENDIF<a name='3249'>
<a name='3250'>
    if(config_flags%terrain_smoothing==1) then<a name='3251'>
       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_121">(1,'Call slow smoother (smdhld).')<a name='3252'>
       call <A href='../../html_code/dyn_nmm/module_SMOOTH_TERRAIN.F.html#SMDHLD'>smdhld</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMDHLD_1">(ids,ide,jds,jde,avc_nest,lnd_nest,12,12)<a name='3253'>
    endif<a name='3254'>
<a name='3255'>
#ifdef DM_PARALLEL<a name='3256'>
    call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_122">(1,'call wrf_global_to_patch_real in nest_terrain')<a name='3257'>
    call <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_REAL'>wrf_global_to_patch_real</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_REAL_4">(avc_nest,nest%hres_avc,nest%domdesc,'z','xy', &amp;<a name='3258'>
                                  ids,   ide-1, jds,   jde-1, 1, 1, &amp;<a name='3259'>
                                  ims,   ime,   jms,   jme,   1, 1, &amp;<a name='3260'>
                                  its,   ite,   jts,   jte,   1, 1)<a name='3261'>
    call <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_REAL'>wrf_global_to_patch_real</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_REAL_5">(lnd_nest,nest%hres_lnd,nest%domdesc,'z','xy', &amp;<a name='3262'>
                                  ids,   ide-1, jds,   jde-1, 1, 1, &amp;<a name='3263'>
                                  ims,   ime,   jms,   jme,   1, 1, &amp;<a name='3264'>
                                  its,   ite,   jts,   jte,   1, 1)<a name='3265'>
    call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MASTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_123">(1,'back from wrf_global_to_patch_real in nest_terrain')<a name='3266'>
#endif<a name='3267'>
  END SUBROUTINE MASTER<a name='3268'>
     <a name='3269'>
END SUBROUTINE NEST_TERRAIN<a name='3270'>
<a name='3271'>
<a name='3272'>
<font color=#447700>!===========================================================================================<a name='3273'></font>
<a name='3274'>
<a name='3275'>
<A NAME='MED_INIT_DOMAIN_CONSTANTS_NMM'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3276'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_init_domain_constants_nmm</font> ( parent, nest)   <font color=#447700>!, config_flags) <A href='../../call_to/MED_INIT_DOMAIN_CONSTANTS_NMM.html' TARGET='index'>3</A>,<A href='../../call_from/MED_INIT_DOMAIN_CONSTANTS_NMM.html' TARGET='index'>8</A><a name='3277'></font>
  <font color=#447700>! Driver layer<a name='3278'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_82"><a name='3279'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_47"><a name='3280'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_10"><a name='3281'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_58">, ONLY : intercomm_active<a name='3282'>
<a name='3283'>
   IMPLICIT NONE<a name='3284'>
   TYPE(domain) , POINTER                     :: parent, nest, grid<a name='3285'>
<font color=#447700>!<a name='3286'></font>
<font color=#447700>!<a name='3287'></font>
   INTERFACE<a name='3288'>
     SUBROUTINE med_initialize_nest_nmm ( grid  &amp;   <a name='3289'>
<font color=#447700>!<a name='3290'></font>
# include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_1"><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3291'>
<font color=#447700>!<a name='3292'></font>
                           )<a name='3293'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_83"><a name='3294'>
        USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_48"><a name='3295'>
        USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_11"><a name='3296'>
        IMPLICIT NONE<a name='3297'>
        TYPE(domain) , POINTER                  :: grid<a name='3298'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_2"><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3299'>
     END SUBROUTINE med_initialize_nest_nmm <a name='3300'>
   END INTERFACE<a name='3301'>
<a name='3302'>
<font color=#447700>!------------------------------------------------------------------------------<a name='3303'></font>
<font color=#447700>!  PURPOSE: <a name='3304'></font>
<font color=#447700>!         - initialize some data, mainly 2D &amp; 3D nmm arrays  very similar to <a name='3305'></font>
<font color=#447700>!           those done in ./dyn_nmm/module_initialize_real.f <a name='3306'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='3307'></font>
<font color=#447700>!<a name='3308'></font>
<a name='3309'>
   grid =&gt; nest<a name='3310'>
<a name='3311'>
   IF ( intercomm_active( grid%id ) ) THEN<a name='3312'>
     CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM'>med_initialize_nest_nmm</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INITIALIZE_NEST_NMM_1">( grid &amp;   <a name='3313'>
<font color=#447700>!<a name='3314'></font>
# include "<A href='../../html_code/include/actual_new_args.inc.html'>actual_new_args.inc</A>"<A NAME="actual_new_args.inc_3"><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3315'>
<font color=#447700>!<a name='3316'></font>
                       )<a name='3317'>
   ENDIF<a name='3318'>
<a name='3319'>
END SUBROUTINE med_init_domain_constants_nmm<a name='3320'>
<a name='3321'>
<A NAME='MED_INITIALIZE_NEST_NMM'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3322'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_initialize_nest_nmm</font>( grid &amp; <A href='../../call_to/MED_INITIALIZE_NEST_NMM.html' TARGET='index'>1</A>,<A href='../../call_from/MED_INITIALIZE_NEST_NMM.html' TARGET='index'>10</A><a name='3323'>
<font color=#447700>!<a name='3324'></font>
# include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_4"><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3325'>
<font color=#447700>!<a name='3326'></font>
                           )<a name='3327'>
<a name='3328'>
 USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_84"><a name='3329'>
 USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_49"><a name='3330'>
 USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_12"><a name='3331'>
 IMPLICIT NONE<a name='3332'>
<a name='3333'>
<font color=#447700>! Local domain indices and counters.<a name='3334'></font>
<a name='3335'>
 INTEGER :: ids, ide, jds, jde, kds, kde, &amp;<a name='3336'>
            ims, ime, jms, jme, kms, kme, &amp;<a name='3337'>
            its, ite, jts, jte, kts, kte, &amp;<a name='3338'>
            i, j, k, nnxp, nnyp <a name='3339'>
<a name='3340'>
 TYPE(domain) , POINTER                     :: grid<a name='3341'>
<a name='3342'>
<font color=#447700>! Local data<a name='3343'></font>
<a name='3344'>
 LOGICAL, EXTERNAL                   :: wrf_dm_on_monitor<a name='3345'>
 INTEGER                             :: KHH,KVH,JAM,JA,IHL, IHH, L<a name='3346'>
 INTEGER                             :: II,JJ,ISRCH,ISUM<a name='3347'>
 INTEGER, ALLOCATABLE, DIMENSION(:)  :: KHL2,KVL2,KHH2,KVH2,KHLA,KHHA,KVLA,KVHA<a name='3348'>
 INTEGER,PARAMETER                   :: KNUM=SELECTED_REAL_KIND(13)<a name='3349'>
<font color=#447700>!<a name='3350'></font>
 REAL(KIND=KNUM)                     :: WB,SB,DLM,DPH,TPH0,STPH0,CTPH0<a name='3351'>
 REAL(KIND=KNUM)                     :: STPH,CTPH,TDLM,TDPH,FP,TPH,TLM,TLM0<a name='3352'>
 REAL                                :: TPH0D,TLM0D,ANBI,TSPH,DTAD,DTCF,DT<a name='3353'>
 REAL                                :: ACDT,CDDAMP,DXP<a name='3354'>
 REAL                                :: WBD,SBD,WBI,SBI,EBI<a name='3355'>
 REAL                                :: DY_NMM0<a name='3356'>
 REAL                                :: RSNOW,SNOFAC<a name='3357'>
 REAL, ALLOCATABLE, DIMENSION(:)     :: DXJ,WPDARJ,CPGFUJ,CURVJ,   &amp;<a name='3358'>
                                        FCPJ,FDIVJ,EMJ,EMTJ,FADJ,  &amp;<a name='3359'>
                                        HDACJ,DDMPUJ,DDMPVJ<a name='3360'>
<font color=#447700>!<a name='3361'></font>
 REAL, PARAMETER:: SALP=2.60<a name='3362'>
 REAL, PARAMETER:: SNUP=0.040<a name='3363'>
 REAL, PARAMETER:: W_NMM=0.08<a name='3364'>
<font color=#447700>! REAL, PARAMETER:: COAC=0.75<a name='3365'></font>
 REAL, PARAMETER:: CODAMP=6.4<a name='3366'>
 REAL, PARAMETER:: TWOM=.00014584<a name='3367'>
 REAL, PARAMETER:: CP=1004.6<a name='3368'>
 REAL, PARAMETER:: DFC=1.0    <a name='3369'>
 REAL, PARAMETER:: DDFC=1.0  <a name='3370'>
 REAL, PARAMETER:: ROI=916.6<a name='3371'>
 REAL, PARAMETER:: R=287.04<a name='3372'>
 REAL, PARAMETER:: CI=2060.0<a name='3373'>
 REAL, PARAMETER:: ROS=1500.<a name='3374'>
 REAL, PARAMETER:: CS=1339.2<a name='3375'>
 REAL, PARAMETER:: DS=0.050<a name='3376'>
 REAL, PARAMETER:: AKS=.0000005<a name='3377'>
 REAL, PARAMETER:: DZG=2.85<a name='3378'>
 REAL, PARAMETER:: DI=.1000<a name='3379'>
 REAL, PARAMETER:: AKI=0.000001075<a name='3380'>
 REAL, PARAMETER:: DZI=2.0<a name='3381'>
 REAL, PARAMETER:: THL=210.<a name='3382'>
 REAL, PARAMETER:: PLQ=70000.<a name='3383'>
 REAL, PARAMETER:: ERAD=6371200.<a name='3384'>
 REAL, PARAMETER:: DTR=0.01745329<a name='3385'>
<a name='3386'>
 REAL :: COAC<a name='3387'>
<a name='3388'>
 CHARACTER(LEN=255) :: message<a name='3389'>
<a name='3390'>
   <font color=#447700>!  Definitions of dummy arguments to solve<a name='3391'></font>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_5"><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3392'>
<a name='3393'>
<font color=#447700>!#define COPY_IN<a name='3394'></font>
<font color=#447700>!#include "scalar_derefs.inc"<a name='3395'></font>
#ifdef DM_PARALLEL<a name='3396'>
#      include "<A href='../../html_code/include/data_calls.inc.html'>data_calls.inc</A>"<A NAME="data_calls.inc_6"><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3397'>
#endif<a name='3398'>
<a name='3399'>
   CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_24"> (  grid ,                           &amp;<a name='3400'>
                             ids, ide, jds, jde, kds, kde,    &amp;<a name='3401'>
                             ims, ime, jms, jme, kms, kme,    &amp;<a name='3402'>
                             its, ite, jts, jte, kts, kte     )<a name='3403'>
<a name='3404'>
<a name='3405'>
<font color=#447700>!=================================================================================<a name='3406'></font>
<font color=#447700>!<a name='3407'></font>
<font color=#447700>!<a name='3408'></font>
<a name='3409'>
   call nl_get_coac(grid%id,coac)<a name='3410'>
<a name='3411'>
    DT=grid%dt         <font color=#447700>!float(TIME_STEP)/parent_time_step_ratio<a name='3412'></font>
    NNXP=min(ITE,IDE-1)<a name='3413'>
    NNYP=min(JTE,JDE-1)<a name='3414'>
    JAM=6+2*((JDE-1)-10)         <font color=#447700>! this should be the fix instead of JAM=6+2*(NNYP-10)<a name='3415'></font>
<a name='3416'>
    WRITE(message,*)'TIME STEP ON DOMAIN',grid%id,'==',dt<a name='3417'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_181">(trim(message))<a name='3418'>
<a name='3419'>
    WRITE(message,*)'IDS,IDE ON DOMAIN',grid%id,'==',ids,ide<a name='3420'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_182">(trim(message))<a name='3421'>
<font color=#447700>!<a name='3422'></font>
IF ( grid%active_this_task ) THEN<a name='3423'>
    ALLOCATE(KHL2(JTS:NNYP),KVL2(JTS:NNYP),KHH2(JTS:NNYP),KVH2(JTS:NNYP))<a name='3424'>
    ALLOCATE(DXJ(JTS:NNYP),WPDARJ(JTS:NNYP),CPGFUJ(JTS:NNYP),CURVJ(JTS:NNYP))<a name='3425'>
    ALLOCATE(FCPJ(JTS:NNYP),FDIVJ(JTS:NNYP),FADJ(JTS:NNYP))<a name='3426'>
    ALLOCATE(HDACJ(JTS:NNYP),DDMPUJ(JTS:NNYP),DDMPVJ(JTS:NNYP))<a name='3427'>
    ALLOCATE(KHLA(JAM),KHHA(JAM))<a name='3428'>
    ALLOCATE(KVLA(JAM),KVHA(JAM))<a name='3429'>
<a name='3430'>
<font color=#447700>!   INITIALIZE SOME LAND/WATER SURFACE DATA ON THE BASIS OF INPUTS: SM, XICE, WEASD, <a name='3431'></font>
<font color=#447700>!   INTERPOLATED FROM MOTHER (WRFSI) DOMAIN. THIS PART OF THE CODE HAS TO BE REVISITED<a name='3432'></font>
<font color=#447700>!   LATER ON<a name='3433'></font>
<a name='3434'>
<font color=#447700>!   Since SM has been changed on parent domain to be 0 over sea ice it can not be used here<a name='3435'></font>
<font color=#447700>!   to find where sea ice is. That's why alogirthm here is slightly different than the<a name='3436'></font>
<font color=#447700>!   one used in module_initalize_real.f<a name='3437'></font>
<a name='3438'>
#if ( HWRF == 1 )<a name='3439'>
<font color=#447700>!zhang's doing: added to AVOID THIS COMPUTATION IF THE NEST IS STARTED USING ANALYSIS FILE<a name='3440'></font>
   IF(.not. grid%analysis)THEN<a name='3441'>
#endif<a name='3442'>
    DO J = JTS, MIN(JTE,JDE-1)<a name='3443'>
     DO I = ITS, MIN(ITE,IDE-1)<a name='3444'>
<a name='3445'>
      IF (grid%sm(I,J).GT.0.9) THEN                              <font color=#447700>! OVER WATER SURFACE<a name='3446'></font>
         grid%epsr(I,J)= 0.97<a name='3447'>
         grid%embck(I,J)= 0.97<a name='3448'>
         grid%gffc(I,J)= 0.<a name='3449'>
         grid%albedo(I,J)=.06<a name='3450'>
         grid%albase(I,J)=.06<a name='3451'>
      ENDIF<a name='3452'>
<a name='3453'>
      IF (grid%sice(I,J).GT.0.9) THEN                            <font color=#447700>! OVER SEA-ICE<a name='3454'></font>
         grid%sm(I,J)=0.<a name='3455'>
         grid%si(I,J)=0.<a name='3456'>
         grid%gffc(I,J)=0.<a name='3457'>
         grid%albedo(I,J)=.60<a name='3458'>
         grid%albase(I,J)=.60<a name='3459'>
      ENDIF<a name='3460'>
<a name='3461'>
      IF (grid%sm(I,J).LT.0.5.AND.grid%sice(I,J).LT.0.5) THEN         <font color=#447700>! OVER LAND SURFACE<a name='3462'></font>
           grid%si(I,J)=5.0*grid%weasd(I,J)/1000. <font color=#447700>! SNOW WATER EQ (mm) OBTAINED FROM PARENT (grid%si) IS INTERPOLATED<a name='3463'></font>
           grid%epsr(I,J)=1.0                <font color=#447700>! EMISSIVITY DEFINED OVER LAND IN THE NESTED DOMAIN<a name='3464'></font>
           grid%embck(I,J)=1.0               <font color=#447700>! EMISSIVITY DEFINED OVER LAND IN THE NESTED DOMAIN<a name='3465'></font>
           grid%gffc(I,J)=0.0                <font color=#447700>! just leave zero as irrelevant<a name='3466'></font>
           grid%sno(I,J)=grid%si(I,J)*.20         <font color=#447700>! LAND-SNOW COVER<a name='3467'></font>
      ENDIF<a name='3468'>
<a name='3469'>
     ENDDO<a name='3470'>
    ENDDO<a name='3471'>
<a name='3472'>
<font color=#447700>!   This may just be a fix and may need some Registry related changes, later on<a name='3473'></font>
<a name='3474'>
    DO J = JTS, MIN(JTE,JDE-1)<a name='3475'>
     DO I = ITS, MIN(ITE,IDE-1)<a name='3476'>
         grid%vegfra(I,J)=grid%vegfrc(I,J)<a name='3477'>
     ENDDO<a name='3478'>
    ENDDO<a name='3479'>
<a name='3480'>
<font color=#447700>!   DETERMINE ALBEDO OVER LAND ON THE BASIS OF INPUTS: SM, ALBASE, MXSNAL &amp; VEGFRA<a name='3481'></font>
<font color=#447700>!   INTERPOLATED FROM MOTHER (WRFSI) DOMAIN<a name='3482'></font>
<a name='3483'>
 <a name='3484'>
    DO J = JTS, MIN(JTE,JDE-1) <a name='3485'>
     DO I = ITS, MIN(ITE,IDE-1)<a name='3486'>
<a name='3487'>
          IF(grid%sm(I,J).LT.0.9.AND.grid%sice(I,J).LT.0.9) THEN<a name='3488'>
<font color=#447700>!<a name='3489'></font>
            IF ( (grid%sno(I,J) .EQ. 0.0) .OR. &amp;            <font color=#447700>! SNOWFREE ALBEDO<a name='3490'></font>
                           (grid%albase(I,J) .GE. grid%mxsnal(I,J) ) ) THEN<a name='3491'>
              grid%albedo(I,J) = grid%albase(I,J)<a name='3492'>
            ELSE<a name='3493'>
              IF (grid%sno(I,J) .LT. SNUP) THEN             <font color=#447700>! MODIFY ALBEDO IF SNOWCOVER:<a name='3494'></font>
                  RSNOW = grid%sno(I,J)/SNUP                <font color=#447700>! BELOW SNOWDEPTH THRESHOLD<a name='3495'></font>
                  SNOFAC = 1. - ( EXP(-SALP*RSNOW) - RSNOW*EXP(-SALP))<a name='3496'>
              ELSE<a name='3497'>
                  SNOFAC = 1.0                         <font color=#447700>! ABOVE SNOWDEPTH THRESHOLD<a name='3498'></font>
              ENDIF<a name='3499'>
              grid%albedo(I,J) = grid%albase(I,J) &amp;<a name='3500'>
                          + (1.0-grid%vegfra(I,J))*SNOFAC*(grid%mxsnal(I,J)-grid%albase(I,J))<a name='3501'>
            ENDIF<a name='3502'>
<font color=#447700>!<a name='3503'></font>
          END IF<a name='3504'>
<a name='3505'>
          grid%si(I,J)=5.0*grid%weasd(I,J)<a name='3506'>
          grid%sno(I,J)=grid%weasd(I,J)<a name='3507'>
<font color=#447700>! this block probably superfluous.  Meant to guarantee land/sea agreement<a name='3508'></font>
<a name='3509'>
        IF (grid%sm(I,J) .gt. 0.5)THEN <a name='3510'>
           grid%landmask(I,J)=0.0<a name='3511'>
        ELSE <a name='3512'>
           grid%landmask(I,J)=1.0<a name='3513'>
        ENDIF <a name='3514'>
<a name='3515'>
        IF (grid%sice(I,J) .eq. 1.0) then <font color=#447700>!!!! change vegtyp and sltyp to fit seaice (desireable??)<a name='3516'></font>
         grid%isltyp(I,J)=16<a name='3517'>
         grid%ivgtyp(I,J)=24<a name='3518'>
        ENDIF <a name='3519'>
<a name='3520'>
     ENDDO<a name='3521'>
    ENDDO<a name='3522'>
<a name='3523'>
<font color=#447700>!  Check land water interface<a name='3524'></font>
<a name='3525'>
<font color=#447700>!     The write(20,*) statements below were very slow on Jet when using<a name='3526'></font>
<font color=#447700>!     the intel compiler (added hours to the runtime).  The fix<a name='3527'></font>
<font color=#447700>!     suggested by Chris Harrop was to send messages to wrf_message<a name='3528'></font>
<font color=#447700>!     instead:<a name='3529'></font>
<a name='3530'>
    DO J = JTS, MIN(JTE,JDE-1)<a name='3531'>
     DO I = ITS,MIN(ITE,IDE-1)<a name='3532'>
      IF(grid%sm(I,J).GT.0.9 .AND. grid%vegfra(I,J) .NE. 0) THEN<a name='3533'>
#if defined(USE_SLOW_INTERFACE_CHECK)<a name='3534'>
        WRITE(20,*)'PROBLEM AT THE LAND-WATER INTERFACE (VEGFRA):', &amp;<a name='3535'>
             I,J,grid%sm(I-1,J),grid%vegfra(I-1,j),grid%sm(I,J),grid%vegfra(I,J)<a name='3536'>
#else<a name='3537'>
        WRITE(message,*)'PROBLEM AT THE LAND-WATER INTERFACE (VEGFRA):', &amp;<a name='3538'>
             I,J,grid%sm(I-1,J),grid%vegfra(I-1,j),grid%sm(I,J),grid%vegfra(I,J)<a name='3539'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_183">(trim(message))<a name='3540'>
#endif<a name='3541'>
      ENDIF<a name='3542'>
<font color=#447700>!<a name='3543'></font>
#if ( HWRF == 1 )<a name='3544'>
      <font color=#447700>! HWRF should not perform the check below because the nmm_tsk is<a name='3545'></font>
      <font color=#447700>! update with the correct skin temperature every timestep (on both<a name='3546'></font>
      <font color=#447700>! land and sea points).<a name='3547'></font>
#else<a name='3548'>
      IF(grid%sm(I,J).GT.0.9 .AND. grid%nmm_tsk(I,J) .NE. 0) THEN<a name='3549'>
#if defined(USE_SLOW_INTERFACE_CHECK)<a name='3550'>
        WRITE(20,*)'PROBLEM AT THE LAND-WATER INTERFACE (NMM_TSK):', &amp;<a name='3551'>
             I,J,grid%sm(I-1,J),grid%nmm_tsk(I-1,J),grid%sm(I,J),grid%nmm_tsk(I,J)<a name='3552'>
#else<a name='3553'>
        WRITE(message,*)'PROBLEM AT THE LAND-WATER INTERFACE (NMM_TSK):', &amp;<a name='3554'>
             I,J,grid%sm(I-1,J),grid%nmm_tsk(I-1,J),grid%sm(I,J),grid%nmm_tsk(I,J)<a name='3555'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_184">(trim(message))<a name='3556'>
#endif<a name='3557'>
      ENDIF<a name='3558'>
#endif<a name='3559'>
     ENDDO<a name='3560'>
    ENDDO<a name='3561'>
<a name='3562'>
<a name='3563'>
<font color=#447700>!   hardwire root depth for time being<a name='3564'></font>
<a name='3565'>
        grid%rtdpth=0.<a name='3566'>
        grid%rtdpth(1)=0.1<a name='3567'>
        grid%rtdpth(2)=0.3<a name='3568'>
        grid%rtdpth(3)=0.6<a name='3569'>
<a name='3570'>
<font color=#447700>!   hardwire soil depth for time being<a name='3571'></font>
<a name='3572'>
        grid%sldpth=0.<a name='3573'>
        grid%sldpth(1)=0.1<a name='3574'>
        grid%sldpth(2)=0.3<a name='3575'>
        grid%sldpth(3)=0.6<a name='3576'>
        grid%sldpth(4)=1.0<a name='3577'>
<a name='3578'>
#if ( HWRF == 1 )<a name='3579'>
<font color=#447700>!zhang's doing: added to AVOID THIS COMPUTATION IF THE NEST IS STARTED USING ANALYSIS FILE<a name='3580'></font>
   ENDIF <font color=#447700>! &lt;------ for analysis set to false<a name='3581'></font>
#endif <a name='3582'>
<font color=#447700>!-----------  END OF LAND SURFACE INITIALIZATION -------------------------------------<a name='3583'></font>
<font color=#447700>!<a name='3584'></font>
    DO J = JTS, MIN(JTE,JDE-1)<a name='3585'>
     DO I = ITS, MIN(ITE,IDE-1)<a name='3586'>
       grid%res(I,J)=1.<a name='3587'>
     ENDDO<a name='3588'>
    ENDDO<a name='3589'>
<a name='3590'>
<font color=#447700>!   INITIALIZE 2D BOUNDARY MASKS<a name='3591'></font>
<a name='3592'>
<font color=#447700>!! grid%hbm2:<a name='3593'></font>
 <a name='3594'>
    grid%hbm2=0.<a name='3595'>
    DO J = JTS, MIN(JTE,JDE-1)<a name='3596'>
      DO I = ITS, MIN(ITE,IDE-1)<a name='3597'>
       IF((J .GE. 3 .and. J .LE. (JDE-1)-2) .AND.   &amp;<a name='3598'>
          (I .GE. 2 .and. I .LE. (IDE-1)-2+MOD(J,2))) THEN<a name='3599'>
          grid%hbm2(I,J)=1.<a name='3600'>
        ENDIF<a name='3601'>
      ENDDO<a name='3602'>
    ENDDO   <a name='3603'>
<a name='3604'>
<font color=#447700>!! grid%hbm3:<a name='3605'></font>
<a name='3606'>
    grid%hbm3=0.<a name='3607'>
    DO J=JTS,MIN(JTE,JDE-1)<a name='3608'>
     grid%ihwg(J)=mod(J+1,2)-1<a name='3609'>
      IF (J .ge. 4 .and. J .le. (JDE-1)-3) THEN<a name='3610'>
        IHL=(IDS+1)-grid%ihwg(J) <a name='3611'>
        IHH=(IDE-1)-2<a name='3612'>
        DO I=ITS,MIN(ITE,IDE-1)<a name='3613'>
           IF (I .ge. IHL  .and. I .le. IHH) grid%hbm3(I,J)=1.<a name='3614'>
        ENDDO <a name='3615'>
      ENDIF<a name='3616'>
    ENDDO <a name='3617'>
   <a name='3618'>
<font color=#447700>!! grid%vbm2<a name='3619'></font>
<a name='3620'>
    grid%vbm2=0.<a name='3621'>
    DO J=JTS,MIN(JTE,JDE-1)<a name='3622'>
     DO I=ITS,MIN(ITE,IDE-1)<a name='3623'>
       IF((J .ge. 3 .and. J .le. (JDE-1)-2)  .AND.  &amp;<a name='3624'>
          (I .ge. 2 .and. I .le. (IDE-1)-1-MOD(J,2))) THEN<a name='3625'>
           grid%vbm2(I,J)=1.<a name='3626'>
       ENDIF<a name='3627'>
     ENDDO<a name='3628'>
    ENDDO<a name='3629'>
<a name='3630'>
<font color=#447700>!! grid%vbm3<a name='3631'></font>
<a name='3632'>
    grid%vbm3=0.<a name='3633'>
    DO J=JTS,MIN(JTE,JDE-1)<a name='3634'>
      DO I=ITS,MIN(ITE,IDE-1)<a name='3635'>
        IF((J .ge. 4 .and. J .le. (JDE-1)-3)  .AND.  &amp;<a name='3636'>
           (I .ge. 3-MOD(J,2) .and. I .le. (IDE-1)-2)) THEN<a name='3637'>
           grid%vbm3(I,J)=1.<a name='3638'>
        ENDIF<a name='3639'>
      ENDDO<a name='3640'>
    ENDDO<a name='3641'>
<a name='3642'>
    TPH0D  = grid%CEN_LAT<a name='3643'>
    TLM0D  = grid%CEN_LON<a name='3644'>
    TPH0   = TPH0D*DTR<a name='3645'>
    WBD    = grid%WBD0   <font color=#447700>! gopal's doing: may use Registry WBD0 now<a name='3646'></font>
    WB     = WBD*DTR<a name='3647'>
    SBD    = grid%SBD0   <font color=#447700>! gopal's doing: may use Registry SBD0 now<a name='3648'></font>
    SB     = SBD*DTR<a name='3649'>
    DLM    = grid%dlmd*DTR  <font color=#447700>! input now from med_nest_egrid_configure<a name='3650'></font>
    DPH    = grid%dphd*DTR  <font color=#447700>! input now from med_nest_egrid_configure<a name='3651'></font>
    TDLM   = DLM+DLM<a name='3652'>
    TDPH   = DPH+DPH<a name='3653'>
    WBI    = WB+TDLM<a name='3654'>
    SBI    = SB+TDPH<a name='3655'>
    EBI    = WB+((ide-1)-2)*TDLM  <font color=#447700>! gopal's doing: check this for nested domain<a name='3656'></font>
    ANBI   = SB+((jde-1)-3)*DPH   <font color=#447700>! gopal's doing: check this for nested domain<a name='3657'></font>
    STPH0  = SIN(TPH0)<a name='3658'>
    CTPH0  = COS(TPH0)<a name='3659'>
    TSPH   = 3600./grid%DT<a name='3660'>
    DTAD   = 1.0<a name='3661'>
    DTCF   = 4.0    <a name='3662'>
    DY_NMM0= grid%dy_nmm <font color=#447700>! ERAD*DPH; input now from med_nest_egrid_configure<a name='3663'></font>
<a name='3664'>
<font color=#447700>!   CORIOLIS PARAMETER  (There appears to be some roundoff in computing TLM &amp; STPH and other terms,<a name='3665'></font>
<font color=#447700>!   in the nested domain. The problem needs to be revisited<a name='3666'></font>
<a name='3667'>
    DO J=JTS,MIN(JTE,JDE-1)<a name='3668'>
      TLM0=WB-TDLM+MOD(J,2)*DLM           <font color=#447700>! remember this is a wind point<a name='3669'></font>
      TPH =SB+float(J-1)*DPH<a name='3670'>
      STPH=SIN(TPH)<a name='3671'>
      CTPH=COS(TPH)<a name='3672'>
      DO I=ITS,MIN(ITE,IDE-1)<a name='3673'>
         TLM=TLM0 + I*TDLM<a name='3674'>
         FP=TWOM*(CTPH0*STPH+STPH0*CTPH*COS(TLM))<a name='3675'>
         grid%f(I,J)=0.5*grid%DT*FP<a name='3676'>
      ENDDO<a name='3677'>
    ENDDO<a name='3678'>
<a name='3679'>
<a name='3680'>
    DO J=JTS,MIN(JTE,JDE-1)<a name='3681'>
      KHL2(J)=(IDE-1)*(J-1)-(J-1)/2+2<a name='3682'>
      KVL2(J)=(IDE-1)*(J-1)-J/2+2<a name='3683'>
      KHH2(J)=(IDE-1)*J-J/2-1<a name='3684'>
      KVH2(J)=(IDE-1)*J-(J+1)/2-1<a name='3685'>
    ENDDO<a name='3686'>
<a name='3687'>
<a name='3688'>
    TPH=SB-DPH<a name='3689'>
    DO J=JTS,MIN(JTE,JDE-1)<a name='3690'>
      TPH=SB+float(J-1)*DPH<a name='3691'>
      DXP=ERAD*DLM*COS(TPH)<a name='3692'>
      DXJ(J)=DXP<a name='3693'>
      WPDARJ(J)=-W_NMM*((ERAD*DLM*AMIN1(COS(ANBI),COS(SBI)))**2+DY_NMM0**2)/  &amp; <a name='3694'>
                (grid%DT*32.*DXP*DY_NMM0)<a name='3695'>
      CPGFUJ(J)=-grid%DT/(48.*DXP)<a name='3696'>
      CURVJ(J)=.5*grid%DT*TAN(TPH)/ERAD<a name='3697'>
      FCPJ(J)=grid%DT/(CP*192.*DXP*DY_NMM0)<a name='3698'>
      FDIVJ(J)=1./(12.*DXP*DY_NMM0)<a name='3699'>
      FADJ(J)=-grid%DT/(48.*DXP*DY_NMM0)*DTAD<a name='3700'>
      ACDT=grid%DT*SQRT((ERAD*DLM*AMIN1(COS(ANBI),COS(SBI)))**2+DY_NMM0**2)<a name='3701'>
      CDDAMP=CODAMP*ACDT<a name='3702'>
      HDACJ(J)=COAC*ACDT/(4.*DXP*DY_NMM0)<a name='3703'>
      DDMPUJ(J)=CDDAMP/DXP<a name='3704'>
      DDMPVJ(J)=CDDAMP/DY_NMM0<a name='3705'>
    ENDDO<a name='3706'>
<a name='3707'>
<font color=#447700>! --------------DERIVED VERTICAL GRID CONSTANTS--------------------------<a name='3708'></font>
<a name='3709'>
     WRITE(message,*)'NEW CHANGE',grid%f4d,grid%ef4t,grid%f4q<a name='3710'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_185">(trim(message))<a name='3711'>
<a name='3712'>
      DO L=KDS,KDE-1<a name='3713'>
        grid%rdeta(L)=1./grid%deta(L)<a name='3714'>
        grid%f4q2(L)=-.25*grid%DT*DTAD/grid%deta(L)<a name='3715'>
      ENDDO<a name='3716'>
<a name='3717'>
       DO J=JTS,MIN(JTE,JDE-1)<a name='3718'>
        DO I=ITS,MIN(ITE,IDE-1)<a name='3719'>
          grid%dx_nmm(I,J)=DXJ(J)<a name='3720'>
          grid%wpdar(I,J)=WPDARJ(J)*grid%hbm2(I,J)<a name='3721'>
          grid%cpgfu(I,J)=CPGFUJ(J)*grid%vbm2(I,J)<a name='3722'>
          grid%curv(I,J)=CURVJ(J)*grid%vbm2(I,J)<a name='3723'>
          grid%fcp(I,J)=FCPJ(J)*grid%hbm2(I,J)<a name='3724'>
          grid%fdiv(I,J)=FDIVJ(J)*grid%hbm2(I,J)<a name='3725'>
          grid%fad(I,J)=FADJ(J)<a name='3726'>
          grid%hdacv(I,J)=HDACJ(J)*grid%vbm2(I,J)<a name='3727'>
          grid%hdac(I,J)=HDACJ(J)*1.25*grid%hbm2(I,J)<a name='3728'>
        ENDDO<a name='3729'>
       ENDDO<a name='3730'>
<a name='3731'>
       DO J=JTS, MIN(JTE,JDE-1)<a name='3732'>
        IF (J.LE.5.OR.J.GE.(JDE-1)-4) THEN<a name='3733'>
          KHH=(IDE-1)-2+MOD(J,2) <font color=#447700>! KHH is global...loop over I that have<a name='3734'></font>
          DO I=ITS,MIN(ITE,IDE-1)<a name='3735'>
             IF (I .ge. 2 .and. I .le. KHH) THEN<a name='3736'>
               grid%hdac(I,J)=grid%hdac(I,J)* DFC<a name='3737'>
             ENDIF<a name='3738'>
          ENDDO<a name='3739'>
        ELSE<a name='3740'>
          KHH=2+MOD(J,2)<a name='3741'>
          DO I=ITS,MIN(ITE,IDE-1)<a name='3742'>
             IF (I .ge. 2 .and. I .le. KHH) THEN<a name='3743'>
               grid%hdac(I,J)=grid%hdac(I,J)* DFC<a name='3744'>
             ENDIF<a name='3745'>
          ENDDO<a name='3746'>
          KHH=(IDE-1)-2+MOD(J,2)<a name='3747'>
<a name='3748'>
          DO I=ITS,MIN(ITE,IDE-1)<a name='3749'>
             IF (I .ge. (IDE-1)-2 .and. I .le. KHH) THEN<a name='3750'>
               grid%hdac(I,J)=grid%hdac(I,J)* DFC<a name='3751'>
             ENDIF<a name='3752'>
          ENDDO<a name='3753'>
        ENDIF<a name='3754'>
      ENDDO<a name='3755'>
<a name='3756'>
      DO J=JTS,min(JTE,JDE-1)<a name='3757'>
      DO I=ITS,min(ITE,IDE-1)<a name='3758'>
        grid%ddmpu(I,J)=DDMPUJ(J)*grid%vbm2(I,J)<a name='3759'>
        grid%ddmpv(I,J)=DDMPVJ(J)*grid%vbm2(I,J)<a name='3760'>
        grid%hdacv(I,J)=grid%hdacv(I,J)*grid%vbm2(I,J)<a name='3761'>
      ENDDO<a name='3762'>
      ENDDO<a name='3763'>
<a name='3764'>
<font color=#447700>! --------------INCREASING DIFFUSION ALONG THE BOUNDARIES----------------<a name='3765'></font>
<a name='3766'>
        DO J=JTS,MIN(JTE,JDE-1)<a name='3767'>
        IF (J.LE.5.OR.J.GE.JDE-1-4) THEN<a name='3768'>
          KVH=(IDE-1)-1-MOD(J,2)<a name='3769'>
          DO I=ITS,MIN(ITE,IDE-1)<a name='3770'>
            IF (I .ge. 2 .and.  I .le. KVH) THEN<a name='3771'>
             grid%ddmpu(I,J)=grid%ddmpu(I,J)*DDFC<a name='3772'>
             grid%ddmpv(I,J)=grid%ddmpv(I,J)*DDFC<a name='3773'>
             grid%hdacv(I,J)=grid%hdacv(I,J)*DFC<a name='3774'>
            ENDIF<a name='3775'>
          ENDDO<a name='3776'>
        ELSE<a name='3777'>
          KVH=3-MOD(J,2)<a name='3778'>
          DO I=ITS,MIN(ITE,IDE-1)<a name='3779'>
           IF (I .ge. 2 .and.  I .le. KVH) THEN<a name='3780'>
            grid%ddmpu(I,J)=grid%ddmpu(I,J)*DDFC<a name='3781'>
            grid%ddmpv(I,J)=grid%ddmpv(I,J)*DDFC<a name='3782'>
            grid%hdacv(I,J)=grid%hdacv(I,J)*DFC<a name='3783'>
           ENDIF<a name='3784'>
          ENDDO<a name='3785'>
          KVH=(IDE-1)-1-MOD(J,2)<a name='3786'>
          DO I=ITS,MIN(ITE,IDE-1)<a name='3787'>
           IF (I .ge. IDE-1-2 .and. I .le. KVH) THEN<a name='3788'>
            grid%ddmpu(I,J)=grid%ddmpu(I,J)*DDFC<a name='3789'>
            grid%ddmpv(I,J)=grid%ddmpv(I,J)*DDFC<a name='3790'>
            grid%hdacv(I,J)=grid%hdacv(I,J)*DFC<a name='3791'>
           ENDIF<a name='3792'>
          ENDDO<a name='3793'>
        ENDIF<a name='3794'>
      ENDDO<a name='3795'>
<a name='3796'>
<font color=#447700>! This one was left over for nested domain<a name='3797'></font>
 <a name='3798'>
     DO J = JTS, MIN(JTE,JDE-1)<a name='3799'>
       DO I = ITS, MIN(ITE,IDE-1)<a name='3800'>
          grid%GLAT(I,J)=grid%HLAT(I,J)*DTR<a name='3801'>
          grid%GLON(I,J)=grid%HLON(I,J)*DTR<a name='3802'>
       ENDDO<a name='3803'>
     ENDDO<a name='3804'>
<a name='3805'>
<font color=#447700>!!   compute EMT, EM on global domain, and only on task 0.<a name='3806'></font>
<a name='3807'>
<font color=#447700>!    IF (wrf_dm_on_monitor()) THEN   !!!! NECESSARY TO LIMIT THIS TO TASK ZERO?<a name='3808'></font>
      <a name='3809'>
     ALLOCATE(EMJ(JDS:JDE-1),EMTJ(JDS:JDE-1))<a name='3810'>
     DO J=JDS,JDE-1<a name='3811'>
       TPH=SB+float(J-1)*DPH<a name='3812'>
       DXP=ERAD*DLM*COS(TPH)<a name='3813'>
       EMJ(J)= grid%DT/( 4.*DXP)*DTAD<a name='3814'>
       EMTJ(J)=grid%DT/(16.*DXP)*DTAD<a name='3815'>
     ENDDO<a name='3816'>
<a name='3817'>
          JA=0<a name='3818'>
          DO 161 J=3,5<a name='3819'>
          JA=JA+1<a name='3820'>
          KHLA(JA)=2<a name='3821'>
          KHHA(JA)=(IDE-1)-1-MOD(J+1,2)<a name='3822'>
 161      grid%emt(JA)=EMTJ(J)<a name='3823'>
          DO 162 J=(JDE-1)-4,(JDE-1)-2<a name='3824'>
          JA=JA+1<a name='3825'>
          KHLA(JA)=2<a name='3826'>
          KHHA(JA)=(IDE-1)-1-MOD(J+1,2)<a name='3827'>
 162      grid%emt(JA)=EMTJ(J)<a name='3828'>
          DO 163 J=6,(JDE-1)-5<a name='3829'>
          JA=JA+1<a name='3830'>
          KHLA(JA)=2<a name='3831'>
          KHHA(JA)=2+MOD(J,2)<a name='3832'>
 163      grid%emt(JA)=EMTJ(J)<a name='3833'>
          DO 164 J=6,(JDE-1)-5<a name='3834'>
          JA=JA+1<a name='3835'>
          KHLA(JA)=(IDE-1)-2<a name='3836'>
          KHHA(JA)=(IDE-1)-1-MOD(J+1,2)<a name='3837'>
 164      grid%emt(JA)=EMTJ(J)<a name='3838'>
<a name='3839'>
<font color=#447700>! --------------SPREADING OF UPSTREAM VELOCITY-POINT ADVECTION FACTOR----<a name='3840'></font>
<a name='3841'>
          JA=0<a name='3842'>
          DO 171 J=3,5<a name='3843'>
          JA=JA+1<a name='3844'>
          KVLA(JA)=2<a name='3845'>
          KVHA(JA)=(IDE-1)-1-MOD(J,2)<a name='3846'>
 171      grid%em(JA)=EMJ(J)<a name='3847'>
          DO 172 J=(JDE-1)-4,(JDE-2)-2<a name='3848'>
          JA=JA+1<a name='3849'>
          KVLA(JA)=2<a name='3850'>
          KVHA(JA)=(IDE-1)-1-MOD(J,2)<a name='3851'>
 172      grid%em(JA)=EMJ(J)<a name='3852'>
          DO 173 J=6,(JDE-1)-5<a name='3853'>
          JA=JA+1<a name='3854'>
          KVLA(JA)=2<a name='3855'>
          KVHA(JA)=2+MOD(J+1,2)<a name='3856'>
 173      grid%em(JA)=EMJ(J)<a name='3857'>
          DO 174 J=6,(JDE-1)-5<a name='3858'>
          JA=JA+1<a name='3859'>
          KVLA(JA)=(IDE-1)-2<a name='3860'>
          KVHA(JA)=(IDE-1)-1-MOD(J,2)<a name='3861'>
 174      grid%em(JA)=EMJ(J)<a name='3862'>
<a name='3863'>
<font color=#447700>!        ENDIF ! wrf_dm_on_monitor<a name='3864'></font>
<a name='3865'>
<font color=#447700>!! must be a better place to put this, but will eliminate "phantom"<a name='3866'></font>
<font color=#447700>!! wind points here (no wind point on eastern boundary of odd numbered rows)<a name='3867'></font>
<font color=#447700>!!<a name='3868'></font>
                                                                <font color=#447700>!   phantom<a name='3869'></font>
        IF (ABS(IDE-1-ITE) .eq. 1 ) THEN                        <font color=#447700>!      | <a name='3870'></font>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INITIALIZE_NEST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_186">('zero phantom winds')                 <font color=#447700>!  H  [x]    H    V<a name='3871'></font>
         DO K=KDS,KDE-1                                         <font color=#447700>!  <a name='3872'></font>
          DO J=JDS,JDE-1,2                                      <font color=#447700>!  V  [H]    V    H<a name='3873'></font>
           IF (J .ge. JTS .and. J .le. JTE) THEN                <font color=#447700>!<a name='3874'></font>
             grid%u(IDE-1,J,K)=0.                                    <font color=#447700>!  H  [x]    H    V<a name='3875'></font>
             grid%v(IDE-1,J,K)=0.                                    <font color=#447700>!  ------    ------  <a name='3876'></font>
           ENDIF                                                <font color=#447700>!   ide-1      ide<a name='3877'></font>
          ENDDO                                                 <font color=#447700>!   NMM/si     WRF<a name='3878'></font>
         ENDDO                                                  <font color=#447700>!   domain    domain<a name='3879'></font>
        ENDIF                                                   <font color=#447700>!             (dummy)   <a name='3880'></font>
<a name='3881'>
<a name='3882'>
<font color=#447700>! just a test for gravity waves<a name='3883'></font>
<a name='3884'>
<font color=#447700>!  PD=62000.<a name='3885'></font>
<font color=#447700>!   grid%u=0.0<a name='3886'></font>
<font color=#447700>!   grid%v=0.0<a name='3887'></font>
<font color=#447700>!   T=300.<a name='3888'></font>
<font color=#447700>!   Q=0.0<a name='3889'></font>
<font color=#447700>!   Q2=0.0<a name='3890'></font>
<font color=#447700>!   CWM=0.0<a name='3891'></font>
<font color=#447700>!   FIS=0.0<a name='3892'></font>
<a name='3893'>
<font color=#447700>! testx<a name='3894'></font>
<font color=#447700>!  DO J = JTS, MIN(JTE,JDE-1)<a name='3895'></font>
<font color=#447700>!   DO K = KTS,KTE<a name='3896'></font>
<font color=#447700>!    DO I = ITS, MIN(ITE,IDE-1)<a name='3897'></font>
<font color=#447700>!      grid%sm(I,J)=I<a name='3898'></font>
<font color=#447700>!       grid%u(I,K,J)=J<a name='3899'></font>
<font color=#447700>!    ENDDO<a name='3900'></font>
<font color=#447700>!   ENDDO<a name='3901'></font>
<font color=#447700>!  ENDDO<a name='3902'></font>
<font color=#447700>!<a name='3903'></font>
<a name='3904'>
<font color=#447700>!   deallocs<a name='3905'></font>
<a name='3906'>
    DEALLOCATE(KHL2,KVL2,KHH2,KVH2)<a name='3907'>
    DEALLOCATE(DXJ,WPDARJ,CPGFUJ,CURVJ)<a name='3908'>
    DEALLOCATE(FCPJ,FDIVJ,FADJ)<a name='3909'>
    DEALLOCATE(HDACJ,DDMPUJ,DDMPVJ)<a name='3910'>
    DEALLOCATE(KHLA,KHHA)<a name='3911'>
    DEALLOCATE(KVLA,KVHA)<a name='3912'>
ENDIF<a name='3913'>
<a name='3914'>
<a name='3915'>
END SUBROUTINE med_initialize_nest_nmm<a name='3916'>
<font color=#447700>!======================================================================<a name='3917'></font>
<a name='3918'>
<font color=#447700>!--------------------------------------------------------------------------------------<a name='3919'></font>
#if 0<a name='3920'>
<A NAME='INITIAL_NEST_PIVOT'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3921'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>initial_nest_pivot</font> ( parent , nest, iloc, jloc ),<A href='../../call_from/INITIAL_NEST_PIVOT.html' TARGET='index'>13</A><a name='3922'>
<a name='3923'>
<font color=#447700>!==========================================================================================<a name='3924'></font>
<font color=#447700>!<a name='3925'></font>
<font color=#447700>! This program produces i_start and j_start for the nested domain depending on the<a name='3926'></font>
<font color=#447700>! central lat-lon of the storm.<a name='3927'></font>
<font color=#447700>!<a name='3928'></font>
<font color=#447700>!==========================================================================================<a name='3929'></font>
<a name='3930'>
 USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_85"><a name='3931'>
 USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_50"><a name='3932'>
 USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_13"><a name='3933'>
 USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_59"> <a name='3934'>
<a name='3935'>
 IMPLICIT NONE<a name='3936'>
 TYPE(domain) , POINTER              :: parent , nest<a name='3937'>
 INTEGER, INTENT(OUT)                :: ILOC,JLOC<a name='3938'>
 INTEGER                             :: IMS,IME,JMS,JME,KMS,KME<a name='3939'>
 INTEGER                             :: IDS,IDE,JDS,JDE,KDS,KDE<a name='3940'>
 INTEGER                             :: IMS,IME,JMS,JME,KMS,KME<a name='3941'>
 INTEGER                             :: ITS,ITE,JTS,JTE,KTS,KTE<a name='3942'>
 INTEGER                             :: NIDE,NJDE              <font color=#447700>! nest dimension<a name='3943'></font>
 INTEGER                             :: I,J,ITER,IDUM,JDUM<a name='3944'>
 REAL                                :: ALAT,ALON,DIFF1,DIFF2,ERR<a name='3945'>
 REAL                                :: parent_CLAT,parent_CLON,parent_SLAT,parent_SLON<a name='3946'>
 REAL                                :: parent_WBD,parent_SBD,parent_DLMD,parent_DPHD <a name='3947'>
<font color=#447700>!========================================================================================<a name='3948'></font>
<a name='3949'>
<font color=#447700>!   First obtain central latitude and longitude for the parent domain<a name='3950'></font>
<a name='3951'>
    CALL nl_get_cen_lat (parent%ID, parent_CLAT)<a name='3952'>
    CALL nl_get_cen_lon (parent%ID, parent_CLON)<a name='3953'>
<font color=#447700>!    CALL nl_get_storm_lat (parent%ID, parent_SLAT)<a name='3954'></font>
<font color=#447700>!    CALL nl_get_storm_lon (parent%ID, parent_SLON)<a name='3955'></font>
<a name='3956'>
<font color=#447700>!   Parent grid configuration, including, western and southern boundary<a name='3957'></font>
<a name='3958'>
    IDS = parent%sd31<a name='3959'>
    IDE = parent%ed31<a name='3960'>
    JDS = parent%sd32<a name='3961'>
    JDE = parent%ed32<a name='3962'>
    KDS = parent%sd33<a name='3963'>
    KDE = parent%ed33<a name='3964'>
<a name='3965'>
    IMS = parent%sm31<a name='3966'>
    IME = parent%em31<a name='3967'>
    JMS = parent%sm32<a name='3968'>
    JME = parent%em32<a name='3969'>
    KMS = parent%sm33<a name='3970'>
    KME = parent%em33<a name='3971'>
<a name='3972'>
    ITS  = parent%sp31<a name='3973'>
    ITE  = parent%ep31<a name='3974'>
    JTS  = parent%sp32<a name='3975'>
    JTE  = parent%ep32<a name='3976'>
    KTS  = parent%sp33<a name='3977'>
    KTE  = parent%ep33<a name='3978'>
<a name='3979'>
    NIDE = nest%ed31<a name='3980'>
    NJDE = nest%ed32<a name='3981'>
<a name='3982'>
    parent_DLMD = parent%dx          <font color=#447700>! DLMD: dlamda in degrees<a name='3983'></font>
    parent_DPHD = parent%dy          <font color=#447700>! DPHD: dphi in degrees<a name='3984'></font>
    parent_WBD  = -(IDE-2)*parent%dx <font color=#447700>! WBD0: in deg;factor 2 takes care of dummy last column <a name='3985'></font>
    parent_SBD  = -((JDE-1)/2)*parent%dy <font color=#447700>! SBD0: in degrees; note that JDE-1 should be odd <a name='3986'></font>
    ALAT  = parent_SLAT - 0.5*(NJDE-2)*parent_DPHD/nest%parent_grid_ratio<a name='3987'>
    ALON  = parent_SLON - 1.0*(NIDE-2)*parent_DLMD/nest%parent_grid_ratio<a name='3988'>
<a name='3989'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#EARTH_LATLON'>EARTH_LATLON</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EARTH_LATLON_5"> ( parent%HLAT,parent%HLON,parent%VLAT,parent%VLON, &amp; <font color=#447700>!output<a name='3990'></font>
                        parent_DLMD,parent_DPHD,parent_WBD,parent_SBD,                   &amp; <font color=#447700>!inputs<a name='3991'></font>
                        parent_CLAT,parent_CLON,                                         &amp;<a name='3992'>
                        IDS,IDE,JDS,JDE,KDS,KDE,                                         &amp;<a name='3993'>
                        IMS,IME,JMS,JME,KMS,KME,                                         &amp;<a name='3994'>
                        ITS,ITE,JTS,JTE,KTS,KTE                          )<a name='3995'>
<a name='3996'>
<font color=#447700>!   start iteration<a name='3997'></font>
<a name='3998'>
      ILOC=-99<a name='3999'>
      JLOC=-99<a name='4000'>
      ERR=0.1<a name='4001'>
      ITER=1<a name='4002'>
100   CONTINUE<a name='4003'>
<a name='4004'>
     DO J = JTS,min(JTE,JDE-1)<a name='4005'>
      DO I = ITS,min(ITE,IDE-1)<a name='4006'>
        DIFF1 = ABS(ALAT - parent%HLAT(I,J))<a name='4007'>
        DIFF2 = ABS(ALON - parent%HLON(I,J))<a name='4008'>
        IF(DIFF1 .LE. ERR .AND. DIFF2 .LE. ERR)THEN<a name='4009'>
         ILOC=I<a name='4010'>
         JLOC=J<a name='4011'>
        ENDIF<a name='4012'>
      ENDDO<a name='4013'>
     ENDDO<a name='4014'>
<a name='4015'>
     CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_INTEGER'>wrf_dm_maxval_integer</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_INTEGER_3"> ( ILOC, idum, jdum )<a name='4016'>
     CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_INTEGER'>wrf_dm_maxval_integer</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_INTEGER_4"> ( JLOC, idum, jdum ) <a name='4017'>
<a name='4018'>
     IF(ILOC .EQ. -99 .AND. JLOC .EQ. -99)THEN<a name='4019'>
       ERR=ERR+0.1<a name='4020'>
       ITER=ITER+1<a name='4021'>
       IF(ITER .LE. 100)GO TO 100<a name='4022'>
     ENDIF<a name='4023'>
<a name='4024'>
     IF(ILOC .NE. -99 .AND. JLOC .NE. -99)THEN<a name='4025'>
       WRITE(message,*)'NOTE: I_PARENT_START AND J_PARENT_START FOUND FOR THE NESTED DOMAIN CONFIGURATION AT ITER=',ITER<a name='4026'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_187">(trim(message))<a name='4027'>
       WRITE(message,*)'istart=',ILOC<a name='4028'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_188">(trim(message))<a name='4029'>
       WRITE(message,*)'jstart=',JLOC<a name='4030'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_189">(trim(message))<a name='4031'>
     ELSE<a name='4032'>
       ILOC=IDE/3<a name='4033'>
       JLOC=JDE/3<a name='4034'>
<font color=#447700>!<a name='4035'></font>
       WRITE(message,*)'WARNING: COULD NOT LOCATE I_PARENT_START AND J_PARENT_START FROM INPUT STORM INFO'<a name='4036'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_190">(trim(message))<a name='4037'>
       WRITE(message,*)'ISTART=',IDE/3<a name='4038'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_191">(trim(message))<a name='4039'>
       WRITE(message,*)'JSTART=',JDE/3<a name='4040'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INITIAL_NEST_PIVOT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_192">(trim(message))<a name='4041'>
     ENDIF<a name='4042'>
<a name='4043'>
     RETURN<a name='4044'>
END SUBROUTINE initial_nest_pivot<a name='4045'>
<a name='4046'>
<font color=#447700>!============================================================================================<a name='4047'></font>
#endif<a name='4048'>
<a name='4049'>
<A NAME='CD_FEEDBACK_MASK_ORIG'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CD_FEEDBACK_MASK_ORIG' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4050'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>cd_feedback_mask_orig</font>( pig, ips_save, ipe_save , pjg, jps_save, jpe_save, xstag, ystag )<a name='4051'>
   INTEGER, INTENT(IN) :: pig, ips_save, ipe_save , pjg, jps_save, jpe_save<a name='4052'>
   LOGICAL, INTENT(IN) :: xstag, ystag<a name='4053'>
<a name='4054'>
   INTEGER ioff, joff<a name='4055'>
<a name='4056'>
   ioff = 0 ; joff = 0<a name='4057'>
   IF ( xstag  ) ioff = 1<a name='4058'>
   IF ( ystag  ) joff = 1<a name='4059'>
<a name='4060'>
   cd_feedback_mask_orig = ( pig .ge. ips_save+2 .and. &amp;<a name='4061'>
                            pjg .ge. jps_save+3 .and. &amp;<a name='4062'>
                            pig .le. ipe_save-2-mod(pjg-jps_save,2) .and. &amp;<a name='4063'>
                            pjg .le. jpe_save-3 )<a name='4064'>
<a name='4065'>
END FUNCTION cd_feedback_mask_orig<a name='4066'>
<a name='4067'>
<A NAME='CD_FEEDBACK_MASK'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CD_FEEDBACK_MASK' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4068'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>cd_feedback_mask</font>( pig, ips_save, ipe_save , pjg, jps_save, jpe_save, xstag, ystag )<a name='4069'>
   INTEGER, INTENT(IN) :: pig, ips_save, ipe_save , pjg, jps_save, jpe_save<a name='4070'>
   LOGICAL, INTENT(IN) :: xstag, ystag<a name='4071'>
<a name='4072'>
   INTEGER ioff, joff<a name='4073'>
<a name='4074'>
   ioff = 0 ; joff = 0<a name='4075'>
   IF ( xstag  ) ioff = 1<a name='4076'>
   IF ( ystag  ) joff = 1<a name='4077'>
<a name='4078'>
   cd_feedback_mask = ( pig .ge. ips_save+1 .and. &amp;<a name='4079'>
                            pjg .ge. jps_save+2 .and. &amp;<a name='4080'>
                            pig .le. ipe_save-1-mod(pjg-jps_save,2) .and. &amp;<a name='4081'>
                            pjg .le. jpe_save-2 )<a name='4082'>
<a name='4083'>
END FUNCTION cd_feedback_mask<a name='4084'>
<a name='4085'>
<A NAME='CD_FEEDBACK_MASK_V'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#CD_FEEDBACK_MASK_V' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4086'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>cd_feedback_mask_v</font>( pig, ips_save, ipe_save , pjg, jps_save, jpe_save, xstag, ystag )<a name='4087'>
   INTEGER, INTENT(IN) :: pig, ips_save, ipe_save , pjg, jps_save, jpe_save<a name='4088'>
   LOGICAL, INTENT(IN) :: xstag, ystag<a name='4089'>
<a name='4090'>
   INTEGER ioff, joff<a name='4091'>
<a name='4092'>
   ioff = 0 ; joff = 0<a name='4093'>
   IF ( xstag  ) ioff = 1<a name='4094'>
   IF ( ystag  ) joff = 1<a name='4095'>
   <a name='4096'>
   cd_feedback_mask_v = ( pig .ge. ips_save+2 .and. &amp;<a name='4097'>
                            pjg .ge. jps_save+3 .and. &amp;<a name='4098'>
                            pig .le. ipe_save-2-mod(pjg-jps_save+1,2) .and. &amp;<a name='4099'>
                            pjg .le. jpe_save-3 )<a name='4100'>
<a name='4101'>
END FUNCTION cd_feedback_mask_v<a name='4102'>
<a name='4103'>
<a name='4104'>
<font color=#447700>!----------------------------------------------------------------------------<a name='4105'></font>
#else<a name='4106'>
<A NAME='STUB_NMM_NEST_STUB'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#STUB_NMM_NEST_STUB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4107'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>stub_nmm_nest_stub</font><a name='4108'>
END SUBROUTINE stub_nmm_nest_stub<a name='4109'>
#endif<a name='4110'>
<a name='4111'>
<A NAME='FIND_IJSTART_LEVEL'><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#FIND_IJSTART_LEVEL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4112'>
RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>find_ijstart_level</font> ( grid, i_start, j_start, level ) <A href='../../call_to/FIND_IJSTART_LEVEL.html' TARGET='index'>2</A>,<A href='../../call_from/FIND_IJSTART_LEVEL.html' TARGET='index'>2</A><a name='4113'>
<a name='4114'>
<font color=#447700>! Dusan Jovic<a name='4115'></font>
<a name='4116'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#FIND_IJSTART_LEVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_86"><a name='4117'>
<a name='4118'>
   IMPLICIT NONE<a name='4119'>
<a name='4120'>
   <font color=#447700>!  Input data.<a name='4121'></font>
<a name='4122'>
   TYPE(domain) :: grid<a name='4123'>
   INTEGER, INTENT (OUT) :: i_start, j_start, level<a name='4124'>
   INTEGER :: iadd<a name='4125'>
<a name='4126'>
      if (grid%parent_id == 0 ) then<a name='4127'>
         i_start = 1<a name='4128'>
         j_start = 1<a name='4129'>
         level = 0<a name='4130'>
      else<a name='4131'>
         call <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#FIND_IJSTART_LEVEL'>find_ijstart_level</A><A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#FIND_IJSTART_LEVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_IJSTART_LEVEL_2"> ( grid%parents(1)%ptr, i_start, j_start, level )<a name='4132'>
         if (level &gt; 0) then<a name='4133'>
             iadd = (i_start-1)*3<a name='4134'>
             if ( mod(j_start,2).ne.0 .and. mod(grid%j_parent_start,2).ne.0 ) iadd = iadd - 1<a name='4135'>
             if ( mod(j_start,2).eq.0 .and. mod(grid%j_parent_start,2).eq.0 ) iadd = iadd + 2<a name='4136'>
         else<a name='4137'>
             iadd = -mod(grid%j_parent_start,2)<a name='4138'>
         end if<a name='4139'>
         i_start = iadd + grid%i_parent_start*3 - 1<a name='4140'>
         j_start = ( (j_start-1) + (grid%j_parent_start-1) ) * 3 + 1<a name='4141'>
         level = level + 1<a name='4142'>
      end if<a name='4143'>
<a name='4144'>
END SUBROUTINE find_ijstart_level<a name='4145'>
</pre></body></html>