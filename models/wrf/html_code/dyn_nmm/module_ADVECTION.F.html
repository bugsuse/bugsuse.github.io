<HTML> <BODY BGCOLOR=#bbeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!#define BIT_FOR_BIT<a name='3'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4'></font>
#include "<A href='../../html_code/include/nmm_loop_basemacros.h.html'>nmm_loop_basemacros.h</A>"<A NAME="nmm_loop_basemacros.h_1"><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#module_ADVECTION.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5'>
#include "<A href='../../html_code/include/nmm_loop_macros.h.html'>nmm_loop_macros.h</A>"<A NAME="nmm_loop_macros.h_2"><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#module_ADVECTION.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6'>
<font color=#447700>!----------------------------------------------------------------------<a name='7'></font>
<font color=#447700>!<a name='8'></font>
<font color=#447700>!NCEP_MESO:MODEL_LAYER: HORIZONTAL AND VERTICAL ADVECTION<a name='9'></font>
<font color=#447700>!<a name='10'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='11'></font>
<font color=#447700>!<a name='12'></font>
<A NAME='MODULE_ADVECTION'><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#MODULE_ADVECTION' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='13'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_ADVECTION</font> <A href='../../call_to/MODULE_ADVECTION.html' TARGET='index'>2</A><a name='14'>
<font color=#447700>!<a name='15'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='16'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#module_ADVECTION.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_21"><a name='17'>
      USE MODULE_EXT_INTERNAL<a name='18'>
<font color=#447700>!----------------------------------------------------------------------<a name='19'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='20'></font>
      INCLUDE "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_3"><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#module_ADVECTION.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='21'>
#endif<a name='22'>
<font color=#447700>!----------------------------------------------------------------------<a name='23'></font>
<font color=#447700>!<a name='24'></font>
      REAL,PARAMETER :: FF2=-0.64813,FF3=0.24520,FF4=-0.12189<a name='25'>
      REAL,PARAMETER :: FFC=1.533,FBC=1.-FFC<a name='26'>
      REAL :: CONSERVE_MIN=0.9,CONSERVE_MAX=1.1<a name='27'>
<font color=#447700>!<a name='28'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='29'></font>
<font color=#447700>!***  CRANK-NICHOLSON OFF-CENTER WEIGHTS FOR CURRENT AND FUTURE<a name='30'></font>
<font color=#447700>!***  TIME LEVELS.<a name='31'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='32'></font>
<font color=#447700>!<a name='33'></font>
      REAL,PARAMETER :: WGT1=0.90<a name='34'>
      REAL,PARAMETER :: WGT2=2.-WGT1<a name='35'>
<font color=#447700>!<a name='36'></font>
<font color=#447700>!***  FOR CRANK_NICHOLSON CHECK ONLY.<a name='37'></font>
<font color=#447700>!<a name='38'></font>
      INTEGER :: ITEST=47,JTEST=70<a name='39'>
      REAL :: ADTP,ADUP,ADVP,TTLO,TTUP,TULO,TUUP,TVLO,TVUP<a name='40'>
<font color=#447700>!<a name='41'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='42'></font>
      CONTAINS<a name='43'>
<font color=#447700>!<a name='44'></font>
<font color=#447700>!*********************************************************************** <a name='45'></font>
<A NAME='ADVE'><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#ADVE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='46'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>ADVE</font>(NTSD,DT,DETA1,DETA2,PDTOP                         &amp; <A href='../../call_to/ADVE.html' TARGET='index'>1</A>,<A href='../../call_from/ADVE.html' TARGET='index'>2</A><a name='47'>
     &amp;               ,CURV,F,FAD,F4D,EM_LOC,EMT_LOC,EN,ENT,DX,DY        &amp;<a name='48'>
     &amp;               ,HBM2,VBM2                                         &amp;<a name='49'>
     &amp;               ,T,U,V,PDSLO,TOLD,UOLD,VOLD                        &amp;<a name='50'>
     &amp;               ,PETDT,UPSTRM                                      &amp;<a name='51'>
     &amp;               ,FEW,FNS,FNE,FSE                                   &amp;<a name='52'>
     &amp;               ,ADT,ADU,ADV                                       &amp;<a name='53'>
     &amp;               ,N_IUP_H,N_IUP_V                                   &amp;<a name='54'>
     &amp;               ,N_IUP_ADH,N_IUP_ADV                               &amp;<a name='55'>
     &amp;               ,IUP_H,IUP_V,IUP_ADH,IUP_ADV                       &amp;<a name='56'>
     &amp;               ,IHE,IHW,IVE,IVW                                   &amp;<a name='57'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='58'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='59'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='60'>
<font color=#447700>!***********************************************************************<a name='61'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='62'></font>
<font color=#447700>!                .      .    .     <a name='63'></font>
<font color=#447700>! SUBPROGRAM:    ADVE        HORIZONTAL AND VERTICAL ADVECTION<a name='64'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 93-10-28       <a name='65'></font>
<font color=#447700>!     <a name='66'></font>
<font color=#447700>! ABSTRACT:<a name='67'></font>
<font color=#447700>!     ADVE CALCULATES THE CONTRIBUTION OF THE HORIZONTAL AND VERTICAL<a name='68'></font>
<font color=#447700>!     ADVECTION TO THE TENDENCIES OF TEMPERATURE AND WIND AND THEN<a name='69'></font>
<font color=#447700>!     UPDATES THOSE VARIABLES.<a name='70'></font>
<font color=#447700>!     THE JANJIC ADVECTION SCHEME FOR THE ARAKAWA E GRID IS USED<a name='71'></font>
<font color=#447700>!     FOR ALL VARIABLES INSIDE THE FIFTH ROW.  AN UPSTREAM SCHEME<a name='72'></font>
<font color=#447700>!     IS USED ON ALL VARIABLES IN THE THIRD, FOURTH, AND FIFTH<a name='73'></font>
<font color=#447700>!     OUTERMOST ROWS.  THE ADAMS-BASHFORTH TIME SCHEME IS USED.<a name='74'></font>
<font color=#447700>!     <a name='75'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='76'></font>
<font color=#447700>!   87-06-??  JANJIC       - ORIGINATOR<a name='77'></font>
<font color=#447700>!   95-03-25  BLACK        - CONVERSION FROM 1-D TO 2-D IN HORIZONTAL<a name='78'></font>
<font color=#447700>!   96-03-28  BLACK        - ADDED EXTERNAL EDGE<a name='79'></font>
<font color=#447700>!   98-10-30  BLACK        - MODIFIED FOR DISTRIBUTED MEMORY<a name='80'></font>
<font color=#447700>!   99-07-    JANJIC       - CONVERTED TO ADAMS-BASHFORTH SCHEME<a name='81'></font>
<font color=#447700>!                            COMBINING HORIZONTAL AND VERTICAL ADVECTION<a name='82'></font>
<font color=#447700>!   02-02-04  BLACK        - ADDED VERTICAL CFL CHECK<a name='83'></font>
<font color=#447700>!   02-02-05  BLACK        - CONVERTED TO WRF FORMAT<a name='84'></font>
<font color=#447700>!   02-08-29  MICHALAKES   - CONDITIONAL COMPILATION OF MPI<a name='85'></font>
<font color=#447700>!                            CONVERT TO GLOBAL INDEXING<a name='86'></font>
<font color=#447700>!   02-09-06  WOLFE        - MORE CONVERSION TO GLOBAL INDEXING<a name='87'></font>
<font color=#447700>!   04-05-29  JANJIC,BLACK - CRANK-NICHOLSON VERTICAL ADVECTION<a name='88'></font>
<font color=#447700>!   04-11-23  BLACK        - THREADED <a name='89'></font>
<font color=#447700>!   05-12-14  BLACK        - CONVERTED FROM IKJ TO IJK<a name='90'></font>
<font color=#447700>!     <a name='91'></font>
<font color=#447700>! USAGE: CALL ADVE FROM SUBROUTINE SOLVE_NMM<a name='92'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='93'></font>
<font color=#447700>!  <a name='94'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST: <a name='95'></font>
<font color=#447700>!     <a name='96'></font>
<font color=#447700>!   OUTPUT FILES:<a name='97'></font>
<font color=#447700>!     NONE<a name='98'></font>
<font color=#447700>!     <a name='99'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='100'></font>
<font color=#447700>!  <a name='101'></font>
<font color=#447700>!     UNIQUE: NONE<a name='102'></font>
<font color=#447700>!  <a name='103'></font>
<font color=#447700>!     LIBRARY: NONE<a name='104'></font>
<font color=#447700>!  <a name='105'></font>
<font color=#447700>! ATTRIBUTES:<a name='106'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='107'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='108'></font>
<font color=#447700>!$$$  <a name='109'></font>
<font color=#447700>!***********************************************************************<a name='110'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='111'></font>
<font color=#447700>!<a name='112'></font>
      IMPLICIT NONE<a name='113'>
<font color=#447700>!<a name='114'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='115'></font>
<font color=#447700>!<a name='116'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='117'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='118'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='119'>
<font color=#447700>!<a name='120'></font>
      INTEGER, DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW         &amp;<a name='121'>
                                               ,N_IUP_H,N_IUP_V         &amp;<a name='122'>
     &amp;                                         ,N_IUP_ADH,N_IUP_ADV<a name='123'>
<font color=#447700>!<a name='124'></font>
      INTEGER, DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IUP_H,IUP_V     &amp;<a name='125'>
     &amp;                                                 ,IUP_ADH,IUP_ADV<a name='126'>
<font color=#447700>!<a name='127'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='128'>
<font color=#447700>!<a name='129'></font>
      REAL,INTENT(IN) :: DT,DY,EN,ENT,F4D,PDTOP<a name='130'>
<font color=#447700>!<a name='131'></font>
      REAL,DIMENSION(NMM_MAX_DIM),INTENT(IN) :: EM_LOC,EMT_LOC<a name='132'>
<font color=#447700>!<a name='133'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: DETA1,DETA2<a name='134'>
<font color=#447700>!<a name='135'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: CURV,DX,F,FAD,HBM2  &amp;<a name='136'>
     &amp;                                             ,PDSLO,VBM2<a name='137'>
<font color=#447700>!<a name='138'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: ADT,ADU,ADV<a name='139'>
<font color=#447700>!<a name='140'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PETDT<a name='141'>
<font color=#447700>!<a name='142'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: T,TOLD   &amp;<a name='143'>
     &amp;                                                        ,U,UOLD   &amp;<a name='144'>
     &amp;                                                        ,V,VOLD<a name='145'>
<font color=#447700>!<a name='146'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(OUT) :: FEW,FNE    &amp;<a name='147'>
     &amp;                                                      ,FNS,FSE<a name='148'>
<font color=#447700>!<a name='149'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='150'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='151'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='152'></font>
<font color=#447700>!<a name='153'></font>
      LOGICAL :: UPSTRM<a name='154'>
<font color=#447700>!<a name='155'></font>
      INTEGER :: I,IEND,IFP,IFQ,II,IPQ,ISP,ISQ,ISTART                   &amp;<a name='156'>
     &amp;          ,IUP_ADH_J,IVH,IVL                                      &amp;<a name='157'>
     &amp;          ,J,J1,JA,JAK,JEND,JGLOBAL,JJ,JKNT,JP2,JSTART            &amp;<a name='158'>
     &amp;          ,K,KNTI_ADH,KSTART,KSTOP                                &amp;<a name='159'>
     &amp;          ,N,N_IUPH_J,N_IUPADH_J,N_IUPADV_J<a name='160'>
<font color=#447700>!<a name='161'></font>
      INTEGER :: MY_IS_GLB,MY_IE_GLB,MY_JS_GLB,MY_JE_GLB<a name='162'>
<font color=#447700>!<a name='163'></font>
      INTEGER,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: ISPA,ISQA<a name='164'>
<font color=#447700>!<a name='165'></font>
      REAL :: ADPDX,ADPDY,ARRAY3_X,CFL,CFT,CFU,CFV,CMT,CMU,CMV          &amp;<a name='166'>
     &amp;       ,DTE,DTQ,F0,F1,F2,F3,FEWP,FNEP,FNSP,FPP,FSEP,HM            &amp;<a name='167'>
     &amp;       ,PDOP,PDOPU,PDOPV,PP                                       &amp;<a name='168'>
     &amp;       ,PVVLO,PVVLOU,PVVLOV,PVVUP,PVVUPU,PVVUPV                   &amp;<a name='169'>
     &amp;       ,QP,RDP,RDPU,RDPV                                          &amp;<a name='170'>
     &amp;       ,TEMPA,TEMPB,TTA,TTB,UDY                                   &amp;<a name='171'>
     &amp;       ,VDX,VM,VVLO,VVLOU,VVLOV,VVUP,VVUPU,VVUPV<a name='172'>
<font color=#447700>!<a name='173'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: ARRAY0,ARRAY1          &amp;<a name='174'>
     &amp;                                          ,ARRAY2,ARRAY3          &amp;<a name='175'>
     &amp;                                          ,DPDE,RDPD,RDPDX,RDPDY  &amp;<a name='176'>
     &amp;                                          ,TEW,TNE,TNS,TSE,TST    &amp;<a name='177'>
     &amp;                                          ,UNE,UNED,UEW,UNS,USE   &amp;<a name='178'>
     &amp;                                          ,USED,UST               &amp;<a name='179'>
     &amp;                                          ,VEW,VNE,VNS,VSE        &amp;<a name='180'>
     &amp;                                          ,VST<a name='181'>
<font color=#447700>!<a name='182'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5,KTS:KTE) :: VAD_TEND_T     &amp;<a name='183'>
     &amp;                                                  ,VAD_TEND_U     &amp;<a name='184'>
     &amp;                                                  ,VAD_TEND_V<a name='185'>
<font color=#447700>!<a name='186'></font>
      REAL,DIMENSION(KTS:KTE) :: CRT,CRU,CRV,DETA1_PDTOP                &amp;<a name='187'>
     &amp;                          ,RCMT,RCMU,RCMV,RSTT,RSTU,RSTV          &amp;<a name='188'>
     &amp;                          ,T_K,TN,U_K,UN,V_K,VN<a name='189'>
<font color=#447700>!<a name='190'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='191'></font>
<font color=#447700>!***********************************************************************<a name='192'></font>
<font color=#447700>!<a name='193'></font>
<font color=#447700>!                         DPDE      -----  3<a name='194'></font>
<font color=#447700>!                          |                      J Increasing<a name='195'></font>
<font color=#447700>!                          |<a name='196'></font>
<font color=#447700>!                          |                            ^<a name='197'></font>
<font color=#447700>!                         FNS       -----  2            |<a name='198'></font>
<font color=#447700>!                          |                            |<a name='199'></font>
<font color=#447700>!                          |                            |<a name='200'></font>
<font color=#447700>!                          |                            |<a name='201'></font>
<font color=#447700>!                         VNS       -----  1            |<a name='202'></font>
<font color=#447700>!                          |<a name='203'></font>
<font color=#447700>!                          |<a name='204'></font>
<font color=#447700>!                          |<a name='205'></font>
<font color=#447700>!                         ADV       -----  0  ------&gt; Current J<a name='206'></font>
<font color=#447700>!                          |<a name='207'></font>
<font color=#447700>!                          |<a name='208'></font>
<font color=#447700>!                          |<a name='209'></font>
<font color=#447700>!                         VNS       ----- -1<a name='210'></font>
<font color=#447700>!                          |<a name='211'></font>
<font color=#447700>!                          |<a name='212'></font>
<font color=#447700>!                          |<a name='213'></font>
<font color=#447700>!                         FNS       ----- -2<a name='214'></font>
<font color=#447700>!                          |<a name='215'></font>
<font color=#447700>!                          |<a name='216'></font>
<font color=#447700>!                          |<a name='217'></font>
<font color=#447700>!                         DPDE      ----- -3<a name='218'></font>
<font color=#447700>!<a name='219'></font>
<font color=#447700>!***********************************************************************<a name='220'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='221'></font>
     DO J=JTS-5,JTE+5<a name='222'>
     DO I=ITS-5,ITE+5<a name='223'>
       ARRAY0(I,J)=0.0<a name='224'>
       ARRAY1(I,J)=0.0<a name='225'>
       ARRAY2(I,J)=0.0<a name='226'>
       ARRAY3(I,J)=0.0<a name='227'>
       DPDE(I,J)=0.0<a name='228'>
       RDPD(I,J)=0.0<a name='229'>
       RDPDX(I,J)=0.0<a name='230'>
       RDPDY(I,J)=0.0<a name='231'>
       TEW(I,J)=0.0<a name='232'>
       TNE(I,J)=0.0<a name='233'>
       TNS(I,J)=0.0<a name='234'>
       TSE(I,J)=0.0<a name='235'>
       TST(I,J)=0.0<a name='236'>
       UNE(I,J)=0.0<a name='237'>
       UNED(I,J)=0.0<a name='238'>
       UEW(I,J)=0.0<a name='239'>
       UNS(I,J)=0.0<a name='240'>
       USE(I,J)=0.0<a name='241'>
<A href='../../html_code/share/dfi.F.html#D'></A><A href='../../html_code/include/adve_orig.h.html#ADVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_1">D(I,J)=0.0<a name='242'>
       UST(I,J)=0.0<a name='243'>
       VEW(I,J)=0.0<a name='244'>
       VNE(I,J)=0.0<a name='245'>
       VNS(I,J)=0.0<a name='246'>
       VSE(I,J)=0.0<a name='247'>
       VST(I,J)=0.0<a name='248'>
     ENDDO<a name='249'>
     ENDDO<a name='250'>
<font color=#447700>!-----------------------------------------------------------------------<a name='251'></font>
<font color=#447700>!<a name='252'></font>
      DTQ=DT*0.25<a name='253'>
      DTE=DT*(0.5*0.25)<a name='254'>
<font color=#447700>!<a name='255'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='256'></font>
<font color=#447700>!***<a name='257'></font>
<font color=#447700>!***  PRECOMPUTE DETA1 TIMES PDTOP.<a name='258'></font>
<font color=#447700>!***<a name='259'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='260'></font>
<font color=#447700>!<a name='261'></font>
      DO K=KTS,KTE<a name='262'>
        DETA1_PDTOP(K)=DETA1(K)*PDTOP<a name='263'>
      ENDDO<a name='264'>
<font color=#447700>!<a name='265'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='266'></font>
<font color=#447700>!***<a name='267'></font>
<font color=#447700>!***  INITIALIZE SOME WORKING ARRAYS TO ZERO<a name='268'></font>
<font color=#447700>!***<a name='269'></font>
<font color=#447700>!<a name='270'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='271'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='272'></font>
<font color=#447700>!<a name='273'></font>
<font color=#447700>!***  COMPUTE VERTICAL ADVECTION TENDENCIES USING CRANK-NICHOLSON.<a name='274'></font>
<font color=#447700>!<a name='275'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='276'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='277'></font>
<font color=#447700>!<a name='278'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='279'></font>
<font color=#447700>!***  FIRST THE TEMPERATURE<a name='280'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='281'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='282'></font>
<font color=#447700>!$omp&amp; private(cft,cfu,cfv,cmt,cmu,cmv,crt,cru,crv,i,k                  &amp;<a name='283'></font>
<font color=#447700>!$omp&amp;        ,pdop,pdopu,pdopv,pvvlo,pvvlou,pvvlov,pvvup,pvvupu,pvvupv &amp;<a name='284'></font>
<font color=#447700>!$omp&amp;        ,rcmt,rcmu,rcmv,rdp,rdpu,rdpv,rstt,rstu,rstv,t_k,tn       &amp;<a name='285'></font>
<font color=#447700>!$omp&amp;        ,u_k,un,v_k,vn,vvlo,vvlou,vvlov,vvup,vvupu,vvupv)<a name='286'></font>
<font color=#447700>!!$omp&amp; private(adtp,adup,advp,ttlo,ttup,tulo,tuup,tvlo,tvup)<a name='287'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='288'></font>
<font color=#447700>!<a name='289'></font>
      main_vertical: DO J=MYJS2,MYJE2<a name='290'>
<font color=#447700>!<a name='291'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='292'></font>
<font color=#447700>!<a name='293'></font>
        iloop_for_t: DO I=MYIS1,MYIE1<a name='294'>
<font color=#447700>!<a name='295'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='296'></font>
<font color=#447700>!***  EXTRACT T FROM THE COLUMN<a name='297'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='298'></font>
<font color=#447700>!<a name='299'></font>
          DO K=KTS,KTE<a name='300'>
            T_K(K)=T(I,J,K)<a name='301'>
          ENDDO<a name='302'>
<font color=#447700>!<a name='303'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='304'></font>
<font color=#447700>!<a name='305'></font>
          PDOP=PDSLO(I,J)<a name='306'>
          PVVLO=PETDT(I,J,KTE-1)*DTQ<a name='307'>
          VVLO=PVVLO/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOP)<a name='308'>
          CMT=-VVLO*WGT2+1.<a name='309'>
          RCMT(KTE)=1./CMT<a name='310'>
          CRT(KTE)=VVLO*WGT2<a name='311'>
          RSTT(KTE)=-VVLO*WGT1*(T_K(KTE-1)-T_K(KTE))+T_K(KTE)<a name='312'>
<font color=#447700>!<a name='313'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='314'></font>
<font color=#447700>!<a name='315'></font>
          DO K=KTE-1,KTS+1,-1<a name='316'>
            RDP=1./(DETA1_PDTOP(K)+DETA2(K)*PDOP)<a name='317'>
            PVVUP=PVVLO<a name='318'>
            PVVLO=PETDT(I,J,K-1)*DTQ<a name='319'>
            VVUP=PVVUP*RDP<a name='320'>
            VVLO=PVVLO*RDP<a name='321'>
            CFT=-VVUP*WGT2*RCMT(K+1)<a name='322'>
            CMT=-CRT(K+1)*CFT+((VVUP-VVLO)*WGT2+1.)<a name='323'>
            RCMT(K)=1./CMT<a name='324'>
            CRT(K)=VVLO*WGT2<a name='325'>
            RSTT(K)=-RSTT(K+1)*CFT+T_K(K)                               &amp;<a name='326'>
       &amp;            -(T_K(K)-T_K(K+1))*VVUP*WGT1                        &amp;<a name='327'>
       &amp;            -(T_K(K-1)-T_K(K))*VVLO*WGT1<a name='328'>
          ENDDO<a name='329'>
<font color=#447700>!<a name='330'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='331'></font>
<font color=#447700>!<a name='332'></font>
          PVVUP=PVVLO<a name='333'>
          VVUP=PVVUP/(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOP)<a name='334'>
          CFT=-VVUP*WGT2*RCMT(KTS+1)<a name='335'>
          CMT=-CRT(KTS+1)*CFT+VVUP*WGT2+1.<a name='336'>
          CRT(KTS)=0.<a name='337'>
          RSTT(KTS)=-(T_K(KTS)-T_K(KTS+1))*VVUP*WGT1                    &amp;<a name='338'>
      &amp;              -RSTT(KTS+1)*CFT+T_K(KTS)<a name='339'>
          TN(KTS)=RSTT(KTS)/CMT<a name='340'>
          VAD_TEND_T(I,J,KTS)=TN(KTS)-T_K(KTS)<a name='341'>
<font color=#447700>!<a name='342'></font>
          DO K=KTS+1,KTE<a name='343'>
            TN(K)=(-CRT(K)*TN(K-1)+RSTT(K))*RCMT(K)<a name='344'>
            VAD_TEND_T(I,J,K)=TN(K)-T_K(K)<a name='345'>
          ENDDO<a name='346'>
<font color=#447700>!<a name='347'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='348'></font>
<font color=#447700>!***  The following section is only for checking the implicit solution<a name='349'></font>
<font color=#447700>!***  using back-substitution.  Remove this section otherwise.<a name='350'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='351'></font>
<font color=#447700>!       if(ntsd&lt;=10.or.ntsd&gt;=6000)then<a name='352'></font>
<font color=#447700>!       IF(I==ITEST.AND.J==JTEST)THEN<a name='353'></font>
<font color=#447700>!!<a name='354'></font>
<font color=#447700>!         PVVLO=PETDT(I,J,KTE-1)*DT*0.25<a name='355'></font>
<font color=#447700>!         VVLO=PVVLO/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOP)<a name='356'></font>
<font color=#447700>!         TTLO=VVLO*(T(I,J,KTE-1)-T(I,J,KTE)                            &amp;<a name='357'></font>
<font color=#447700>!    &amp;              +TN(KTE-1)-TN(KTE))<a name='358'></font>
<font color=#447700>!         ADTP=TTLO+TN(KTE)-T(I,J,KTE)<a name='359'></font>
<font color=#447700>!         WRITE(0,*)' NTSD=',NTSD,' I=',ITEST,' J=',JTEST,' K=',KTE     &amp;<a name='360'></font>
<font color=#447700>!    &amp;,             ' ADTP=',ADTP<a name='361'></font>
<font color=#447700>!         WRITE(0,*)' T=',T(I,J,KTE),' TN=',TN(KTE)                     &amp;<a name='362'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_T=',VAD_TEND_T(I,J,KTE)<a name='363'></font>
<font color=#447700>!         WRITE(0,*)' '<a name='364'></font>
<font color=#447700>!!<a name='365'></font>
<font color=#447700>!         DO K=KTE-1,KTS+1,-1<a name='366'></font>
<font color=#447700>!           RDP=1./(DETA1_PDTOP(K)+DETA2(K)*PDOP)<a name='367'></font>
<font color=#447700>!           PVVUP=PVVLO<a name='368'></font>
<font color=#447700>!           PVVLO=PETDT(I,J,K-1)*DT*0.25<a name='369'></font>
<font color=#447700>!           VVUP=PVVUP*RDP<a name='370'></font>
<font color=#447700>!           VVLO=PVVLO*RDP<a name='371'></font>
<font color=#447700>!           TTUP=VVUP*(T(I,J,K)-T(I,J,K+1)+TN(K)-TN(K+1))<a name='372'></font>
<font color=#447700>!           TTLO=VVLO*(T(I,J,K-1)-T(I,J,K)+TN(K-1)-TN(K))<a name='373'></font>
<font color=#447700>!           ADTP=TTLO+TTUP+TN(K)-T(I,J,K)<a name='374'></font>
<font color=#447700>!           WRITE(0,*)' NTSD=',NTSD,' I=',I,' J=',J,' K=',K             &amp;<a name='375'></font>
<font color=#447700>!    &amp;,               ' ADTP=',ADTP<a name='376'></font>
<font color=#447700>!           WRITE(0,*)' T=',T(I,J,K),' TN=',TN(K)                       &amp;<a name='377'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_T=',VAD_TEND_T(I,J,K)<a name='378'></font>
<font color=#447700>!           WRITE(0,*)' '<a name='379'></font>
<font color=#447700>!         ENDDO<a name='380'></font>
<font color=#447700>!!<a name='381'></font>
<font color=#447700>!         PVVUP=PVVLO<a name='382'></font>
<font color=#447700>!         VVUP=PVVUP/(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOP)<a name='383'></font>
<font color=#447700>!         TTUP=VVUP*(T(I,J,KTS)-T(I,J,KTS+1)+TN(KTS)-TN(KTS+1))<a name='384'></font>
<font color=#447700>!         ADTP=TTUP+TN(KTS)-T(I,J,KTS)<a name='385'></font>
<font color=#447700>!         WRITE(0,*)' NTSD=',NTSD,' I=',I,' J=',J,' K=',KTS             &amp;<a name='386'></font>
<font color=#447700>!    &amp;,             ' ADTP=',ADTP<a name='387'></font>
<font color=#447700>!         WRITE(0,*)' T=',T(I,J,KTS),' TN=',TN(KTS)                     &amp;<a name='388'></font>
<font color=#447700>!    &amp;,             ' VAD_TEND_T=',VAD_TEND_T(I,J,KTS)<a name='389'></font>
<font color=#447700>!         WRITE(0,*)' '<a name='390'></font>
<font color=#447700>!       ENDIF<a name='391'></font>
<font color=#447700>!       endif<a name='392'></font>
<font color=#447700>!<a name='393'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='394'></font>
<font color=#447700>!***  End of check.<a name='395'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='396'></font>
<font color=#447700>!<a name='397'></font>
        ENDDO iloop_for_t<a name='398'>
<font color=#447700>!<a name='399'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='400'></font>
<font color=#447700>!<a name='401'></font>
<font color=#447700>!***  NOW VERTICAL ADVECTION OF WIND COMPONENTS<a name='402'></font>
<font color=#447700>!<a name='403'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='404'></font>
<font color=#447700>!<a name='405'></font>
        iloop_for_uv:  DO I=MYIS1,MYIE1<a name='406'>
<font color=#447700>!<a name='407'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='408'></font>
<font color=#447700>!***  EXTRACT U AND V FROM THE COLUMN<a name='409'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='410'></font>
<font color=#447700>!<a name='411'></font>
          DO K=KTS,KTE<a name='412'>
            U_K(K)=U(I,J,K)<a name='413'>
            V_K(K)=V(I,J,K)<a name='414'>
          ENDDO<a name='415'>
<font color=#447700>!<a name='416'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='417'></font>
<font color=#447700>!<a name='418'></font>
          PDOPU=(PDSLO(I+IVW(J),J)+PDSLO(I+IVE(J),J))*0.5<a name='419'>
          PDOPV=(PDSLO(I,J-1)+PDSLO(I,J+1))*0.5<a name='420'>
          PVVLOU=(PETDT(I+IVW(J),J,KTE-1)+PETDT(I+IVE(J),J,KTE-1))*DTE<a name='421'>
          PVVLOV=(PETDT(I,J-1,KTE-1)+PETDT(I,J+1,KTE-1))*DTE<a name='422'>
          VVLOU=PVVLOU/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOPU)<a name='423'>
          VVLOV=PVVLOV/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOPV)<a name='424'>
          CMU=-VVLOU*WGT2+1.<a name='425'>
          CMV=-VVLOV*WGT2+1.<a name='426'>
          RCMU(KTE)=1./CMU<a name='427'>
          RCMV(KTE)=1./CMV<a name='428'>
          CRU(KTE)=VVLOU*WGT2<a name='429'>
          CRV(KTE)=VVLOV*WGT2<a name='430'>
          RSTU(KTE)=-VVLOU*WGT1*(U_K(KTE-1)-U_K(KTE))+U_K(KTE)<a name='431'>
          RSTV(KTE)=-VVLOV*WGT1*(V_K(KTE-1)-V_K(KTE))+V_K(KTE)<a name='432'>
<font color=#447700>!<a name='433'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='434'></font>
<font color=#447700>!<a name='435'></font>
          DO K=KTE-1,KTS+1,-1<a name='436'>
            RDPU=1./(DETA1_PDTOP(K)+DETA2(K)*PDOPU)<a name='437'>
            RDPV=1./(DETA1_PDTOP(K)+DETA2(K)*PDOPV)<a name='438'>
            PVVUPU=PVVLOU<a name='439'>
            PVVUPV=PVVLOV<a name='440'>
            PVVLOU=(PETDT(I+IVW(J),J,K-1)+PETDT(I+IVE(J),J,K-1))*DTE<a name='441'>
            PVVLOV=(PETDT(I,J-1,K-1)+PETDT(I,J+1,K-1))*DTE<a name='442'>
            VVUPU=PVVUPU*RDPU<a name='443'>
            VVUPV=PVVUPV*RDPV<a name='444'>
            VVLOU=PVVLOU*RDPU<a name='445'>
            VVLOV=PVVLOV*RDPV<a name='446'>
            CFU=-VVUPU*WGT2*RCMU(K+1)<a name='447'>
            CFV=-VVUPV*WGT2*RCMV(K+1)<a name='448'>
            CMU=-CRU(K+1)*CFU+(VVUPU-VVLOU)*WGT2+1.<a name='449'>
            CMV=-CRV(K+1)*CFV+(VVUPV-VVLOV)*WGT2+1.<a name='450'>
            RCMU(K)=1./CMU<a name='451'>
            RCMV(K)=1./CMV<a name='452'>
            CRU(K)=VVLOU*WGT2<a name='453'>
            CRV(K)=VVLOV*WGT2<a name='454'>
            RSTU(K)=-RSTU(K+1)*CFU+U_K(K)                               &amp;<a name='455'>
     &amp;              -(U_K(K)-U_K(K+1))*VVUPU*WGT1                       &amp;<a name='456'>
     &amp;              -(U_K(K-1)-U_K(K))*VVLOU*WGT1<a name='457'>
            RSTV(K)=-RSTV(K+1)*CFV+V_K(K)                               &amp;<a name='458'>
     &amp;              -(V_K(K)-V_K(K+1))*VVUPV*WGT1                       &amp;<a name='459'>
     &amp;              -(V_K(K-1)-V_K(K))*VVLOV*WGT1<a name='460'>
          ENDDO<a name='461'>
<font color=#447700>!<a name='462'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='463'></font>
<font color=#447700>!<a name='464'></font>
          RDPU=1./(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOPU)<a name='465'>
          RDPV=1./(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOPV)<a name='466'>
          PVVUPU=PVVLOU<a name='467'>
          PVVUPV=PVVLOV<a name='468'>
          VVUPU=PVVUPU*RDPU<a name='469'>
          VVUPV=PVVUPV*RDPV<a name='470'>
          CFU=-VVUPU*WGT2*RCMU(KTS+1)<a name='471'>
          CFV=-VVUPV*WGT2*RCMV(KTS+1)<a name='472'>
          CMU=-CRU(KTS+1)*CFU+VVUPU*WGT2+1.<a name='473'>
          CMV=-CRV(KTS+1)*CFV+VVUPV*WGT2+1.<a name='474'>
          CRU(KTS)=0.<a name='475'>
          CRV(KTS)=0.<a name='476'>
          RSTU(KTS)=-(U_K(KTS)-U_K(KTS+1))*VVUPU*WGT1                   &amp;<a name='477'>
       &amp;               -RSTU(KTS+1)*CFU+U_K(KTS)<a name='478'>
          RSTV(KTS)=-(V_K(KTS)-V_K(KTS+1))*VVUPV*WGT1                   &amp;<a name='479'>
       &amp;               -RSTV(KTS+1)*CFV+V_K(KTS)<a name='480'>
          UN(KTS)=RSTU(KTS)/CMU<a name='481'>
          VN(KTS)=RSTV(KTS)/CMV<a name='482'>
          VAD_TEND_U(I,J,KTS)=UN(KTS)-U_K(KTS)<a name='483'>
          VAD_TEND_V(I,J,KTS)=VN(KTS)-V_K(KTS)<a name='484'>
<font color=#447700>!<a name='485'></font>
          DO K=KTS+1,KTE<a name='486'>
            UN(K)=(-CRU(K)*UN(K-1)+RSTU(K))*RCMU(K)<a name='487'>
            VN(K)=(-CRV(K)*VN(K-1)+RSTV(K))*RCMV(K)<a name='488'>
            VAD_TEND_U(I,J,K)=UN(K)-U_K(K)<a name='489'>
            VAD_TEND_V(I,J,K)=VN(K)-V_K(K)<a name='490'>
          ENDDO<a name='491'>
<font color=#447700>!<a name='492'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='493'></font>
<font color=#447700>!***  The following section is only for checking the implicit solution<a name='494'></font>
<font color=#447700>!***  using back-substitution.  Remove this section otherwise.<a name='495'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='496'></font>
<font color=#447700>!<a name='497'></font>
<font color=#447700>!       if(ntsd&lt;=10.or.ntsd&gt;=6000)then<a name='498'></font>
<font color=#447700>!       IF(I==ITEST.AND.J==JTEST)THEN<a name='499'></font>
<font color=#447700>!!<a name='500'></font>
<font color=#447700>!         PDOPU=(PDSLO(I+IVW(J),J)+PDSLO(I+IVE(J),J))*0.5<a name='501'></font>
<font color=#447700>!         PDOPV=(PDSLO(I,J-1)+PDSLO(I,J+1))*0.5<a name='502'></font>
<font color=#447700>!         PVVLOU=(PETDT(I+IVW(J),J,KTE-1)                               &amp;<a name='503'></font>
<font color=#447700>!    &amp;           +PETDT(I+IVE(J),J,KTE-1))*DTE<a name='504'></font>
<font color=#447700>!         PVVLOV=(PETDT(I,J-1,KTE-1)                                    &amp;<a name='505'></font>
<font color=#447700>!    &amp;           +PETDT(I,J+1,KTE-1))*DTE<a name='506'></font>
<font color=#447700>!         VVLOU=PVVLOU/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOPU)<a name='507'></font>
<font color=#447700>!         VVLOV=PVVLOV/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOPV)<a name='508'></font>
<font color=#447700>!         TULO=VVLOU*(U(I,J,KTE-1)-U(I,J,KTE)+UN(KTE-1)-UN(KTE))<a name='509'></font>
<font color=#447700>!         TVLO=VVLOV*(V(I,J,KTE-1)-V(I,J,KTE)+VN(KTE-1)-VN(KTE))<a name='510'></font>
<font color=#447700>!         ADUP=TULO+UN(KTE)-U(I,J,KTE)<a name='511'></font>
<font color=#447700>!         ADVP=TVLO+VN(KTE)-V(I,J,KTE)<a name='512'></font>
<font color=#447700>!         WRITE(0,*)' NTSD=',NTSD,' I=',I,' J=',J,' K=',KTE             &amp;<a name='513'></font>
<font color=#447700>!    &amp;,             ' ADUP=',ADUP,' ADVP=',ADVP<a name='514'></font>
<font color=#447700>!         WRITE(0,*)' U=',U(I,J,KTE),' UN=',UN(KTE)                     &amp;<a name='515'></font>
<font color=#447700>!    &amp;,             ' VAD_TEND_U=',VAD_TEND_U(I,KTE)                    &amp;<a name='516'></font>
<font color=#447700>!    &amp;,             ' V=',V(I,J,KTE),' VN=',VN(KTE)                     &amp;<a name='517'></font>
<font color=#447700>!    &amp;,             ' VAD_TEND_V=',VAD_TEND_V(I,KTE)<a name='518'></font>
<font color=#447700>!         WRITE(0,*)' '<a name='519'></font>
<font color=#447700>!!<a name='520'></font>
<font color=#447700>!         DO K=KTE-1,KTS+1,-1<a name='521'></font>
<font color=#447700>!           RDPU=1./(DETA1_PDTOP(K)+DETA2(K)*PDOPU)<a name='522'></font>
<font color=#447700>!           RDPV=1./(DETA1_PDTOP(K)+DETA2(K)*PDOPV)<a name='523'></font>
<font color=#447700>!           PVVUPU=PVVLOU<a name='524'></font>
<font color=#447700>!           PVVUPV=PVVLOV<a name='525'></font>
<font color=#447700>!           PVVLOU=(PETDT(I+IVW(J),J,K-1)                               &amp;<a name='526'></font>
<font color=#447700>!    &amp;            +PETDT(I+IVE(J),J,K-1))*DTE<a name='527'></font>
<font color=#447700>!           PVVLOV=(PETDT(I,J-1,K-1)+PETDT(I,J+1,K-1))*DTE<a name='528'></font>
<font color=#447700>!           VVUPU=PVVUPU*RDPU<a name='529'></font>
<font color=#447700>!           VVUPV=PVVUPV*RDPV<a name='530'></font>
<font color=#447700>!           VVLOU=PVVLOU*RDPU<a name='531'></font>
<font color=#447700>!           VVLOV=PVVLOV*RDPV<a name='532'></font>
<font color=#447700>!           TUUP=VVUPU*(U(I,J,K)-U(I,J,K+1)+UN(K)-UN(K+1))<a name='533'></font>
<font color=#447700>!           TVUP=VVUPV*(V(I,J,K)-V(I,J,K+1)+VN(K)-VN(K+1))<a name='534'></font>
<font color=#447700>!           TULO=VVLOU*(U(I,J,K-1)-U(I,J,K)+UN(K-1)-UN(K))<a name='535'></font>
<font color=#447700>!           TVLO=VVLOV*(V(I,J,K-1)-V(I,J,K)+VN(K-1)-VN(K))<a name='536'></font>
<font color=#447700>!           ADUP=TUUP+TULO+UN(K)-U(I,J,K)<a name='537'></font>
<font color=#447700>!           ADVP=TVUP+TVLO+VN(K)-V(I,J,K)<a name='538'></font>
<font color=#447700>!           WRITE(0,*)' NTSD=',NTSD,' I=',ITEST,' J=',JTEST,' K=',K     &amp;<a name='539'></font>
<font color=#447700>!    &amp;,               ' ADUP=',ADUP,' ADVP=',ADVP<a name='540'></font>
<font color=#447700>!           WRITE(0,*)' U=',U(I,J,K),' UN=',UN(K)                       &amp;<a name='541'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_U=',VAD_TEND_U(I,K)                    &amp;<a name='542'></font>
<font color=#447700>!    &amp;,               ' V=',V(I,J,K),' VN=',VN(K)                       &amp;<a name='543'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_V=',VAD_TEND_V(I,K)<a name='544'></font>
<font color=#447700>!           WRITE(0,*)' '<a name='545'></font>
<font color=#447700>!         ENDDO<a name='546'></font>
<font color=#447700>!!<a name='547'></font>
<font color=#447700>!         PVVUPU=PVVLOU<a name='548'></font>
<font color=#447700>!         PVVUPV=PVVLOV<a name='549'></font>
<font color=#447700>!         VVUPU=PVVUPU/(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOPU)<a name='550'></font>
<font color=#447700>!         VVUPV=PVVUPV/(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOPV)<a name='551'></font>
<font color=#447700>!         TUUP=VVUPU*(U(I,J,KTS)-U(I,J,KTS+1)+UN(KTS)-UN(KTS+1))<a name='552'></font>
<font color=#447700>!         TVUP=VVUPV*(V(I,J,KTS)-V(I,J,KTS+1)+VN(KTS)-VN(KTS+1))<a name='553'></font>
<font color=#447700>!         ADUP=TUUP+UN(KTS)-U(I,J,KTS)<a name='554'></font>
<font color=#447700>!         ADVP=TVUP+VN(KTS)-V(I,J,KTS)<a name='555'></font>
<font color=#447700>!         WRITE(0,*)' NTSD=',NTSD,' I=',ITEST,' J=',JTEST,' K=',KTS     &amp;<a name='556'></font>
<font color=#447700>!    &amp;,             ' ADUP=',ADUP,' ADVP=',ADVP<a name='557'></font>
<font color=#447700>!         WRITE(0,*)' U=',U(I,J,KTS),' UN=',UN(KTS)                     &amp;<a name='558'></font>
<font color=#447700>!    &amp;,             ' VAD_TEND_U=',VAD_TEND_U(I,KTS)                    &amp;<a name='559'></font>
<font color=#447700>!    &amp;,             ' V=',V(I,J,KTS),' VN=',VN(KTS)                     &amp;<a name='560'></font>
<font color=#447700>!    &amp;,             ' VAD_TEND_V=',VAD_TEND_V(I,KTS)<a name='561'></font>
<font color=#447700>!         WRITE(0,*)' '<a name='562'></font>
<font color=#447700>!       ENDIF<a name='563'></font>
<font color=#447700>!     endif<a name='564'></font>
<font color=#447700>!<a name='565'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='566'></font>
<font color=#447700>!***  End of check.<a name='567'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='568'></font>
<font color=#447700>!<a name='569'></font>
        ENDDO iloop_for_uv<a name='570'>
<font color=#447700>!<a name='571'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='572'></font>
<font color=#447700>!<a name='573'></font>
      ENDDO main_vertical<a name='574'>
<font color=#447700>!<a name='575'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='576'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='577'></font>
<font color=#447700>!<a name='578'></font>
<font color=#447700>!***  COMPUTE HORIZONTAL ADVECTION TENDENCIES.<a name='579'></font>
<font color=#447700>!<a name='580'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='581'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='582'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='583'></font>
<font color=#447700>!$omp&amp; private(adpdx,adpdy,adt,adu,adv,array0,array1,array2,array3      &amp;<a name='584'></font>
<font color=#447700>!$omp&amp;        ,array3_x,dpde,f0,f1,f2,f3,fewp,fnep,fnsp,fpp,fsep,hm     &amp;<a name='585'></font>
<font color=#447700>!$omp&amp;        ,i,ifp,ifq,ii,ipq,isp,ispa,isq,isqa,iup_adh_j,j,k         &amp;<a name='586'></font>
<font color=#447700>!$omp&amp;        ,knti_adh,n_iupadh_j,n_iupadv_j,n_iuph_j,pp,qp            &amp;<a name='587'></font>
<font color=#447700>!$omp&amp;        ,rdpd,rdpdx,rdpdy,tew,tne,tns,tse,tst,tta,ttb             &amp;<a name='588'></font>
<font color=#447700>!$omp&amp;        ,uew,udy,une,uned,uns,use,used,ust                        &amp;<a name='589'></font>
<font color=#447700>!$omp&amp;        ,vdx,vew,vm,vne,vns,vse,vst)<a name='590'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='591'></font>
<font color=#447700>!<a name='592'></font>
      main_horizontal: DO K=KTS,KTE<a name='593'>
<font color=#447700>!<a name='594'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='595'></font>
<font color=#447700>!<a name='596'></font>
        DO J=MYJS_P4,MYJE_P4<a name='597'>
        DO I=MYIS_P4,MYIE_P4<a name='598'>
          DPDE(I,J)=DETA1_PDTOP(K)+DETA2(K)*PDSLO(I,J)<a name='599'>
          RDPD(I,J)=1./DPDE(I,J)<a name='600'>
          TST(I,J)=T(I,J,K)*FFC+TOLD(I,J,K)*FBC<a name='601'>
          UST(I,J)=U(I,J,K)*FFC+UOLD(I,J,K)*FBC<a name='602'>
          VST(I,J)=V(I,J,K)*FFC+VOLD(I,J,K)*FBC<a name='603'>
        ENDDO<a name='604'>
        ENDDO<a name='605'>
<font color=#447700>!<a name='606'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='607'></font>
<font color=#447700>!***  MASS FLUXES AND MASS POINT ADVECTION COMPONENTS<a name='608'></font>
<font color=#447700>!***  THE NS AND EW FLUXES IN THE FOLLOWING LOOP ARE ON V POINTS<a name='609'></font>
<font color=#447700>!***  FOR T.<a name='610'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='611'></font>
<font color=#447700>!<a name='612'></font>
        DO J=MYJS1_P3,MYJE1_P3<a name='613'>
        DO I=MYIS_P3,MYIE_P3<a name='614'>
<font color=#447700>!<a name='615'></font>
          ADPDX=DPDE(I+IVW(J),J)+DPDE(I+IVE(J),J)<a name='616'>
          ADPDY=DPDE(I,J-1)+DPDE(I,J+1)<a name='617'>
          RDPDX(I,J)=1./ADPDX<a name='618'>
          RDPDY(I,J)=1./ADPDY<a name='619'>
<font color=#447700>!<a name='620'></font>
          UDY=U(I,J,K)*DY<a name='621'>
          VDX=V(I,J,K)*DX(I,J)<a name='622'>
<font color=#447700>!<a name='623'></font>
          FEWP=UDY*ADPDX<a name='624'>
          FNSP=VDX*ADPDY<a name='625'>
<font color=#447700>!<a name='626'></font>
          FEW(I,J,K)=FEWP<a name='627'>
          FNS(I,J,K)=FNSP<a name='628'>
<font color=#447700>!<a name='629'></font>
          TEW(I,J)=FEWP*(TST(I+IVE(J),J)-TST(I+IVW(J),J))<a name='630'>
          TNS(I,J)=FNSP*(TST(I,J+1)-TST(I,J-1))<a name='631'>
<font color=#447700>!<a name='632'></font>
          UNED(I,J)=UDY+VDX<a name='633'>
<A href='../../html_code/share/dfi.F.html#D'></A><A href='../../html_code/include/adve_orig.h.html#ADVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_2">D(I,J)=UDY-VDX<a name='634'>
<font color=#447700>!<a name='635'></font>
        ENDDO<a name='636'>
        ENDDO<a name='637'>
<font color=#447700>!<a name='638'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='639'></font>
<font color=#447700>!***  DIAGONAL FLUXES AND DIAGONALLY AVERAGED WIND<a name='640'></font>
<font color=#447700>!***  THE NE AND SE FLUXES ARE ASSOCIATED WITH H POINTS<a name='641'></font>
<font color=#447700>!***  (ACTUALLY JUST TO THE NE AND SE OF EACH H POINT).<a name='642'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='643'></font>
<font color=#447700>!<a name='644'></font>
        DO J=MYJS1_P2,MYJE2_P2<a name='645'>
        DO I=MYIS_P2,MYIE_P2<a name='646'>
          FNEP=(UNED(I+IHE(J),J)+UNED(I       ,J+1))                    &amp;<a name='647'>
     &amp;        *(DPDE(I       ,J)+DPDE(I+IHE(J),J+1))<a name='648'>
          FNE(I,J,K)=FNEP<a name='649'>
          TNE(I,J)=FNEP*(TST(I+IHE(J),J+1)-TST(I,J))<a name='650'>
        ENDDO<a name='651'>
        ENDDO<a name='652'>
<font color=#447700>!<a name='653'></font>
        DO J=MYJS2_P2,MYJE1_P2<a name='654'>
        DO I=MYIS_P2,MYIE_P2<a name='655'>
          FSEP=(USED(I+IHE(J),J)+USED(I       ,J-1))                    &amp;<a name='656'>
     &amp;        *(DPDE(I       ,J)+DPDE(I+IHE(J),J-1))<a name='657'>
          FSE(I,J,K)=FSEP<a name='658'>
          TSE(I,J)=FSEP*(TST(I+IHE(J),J-1)-TST(I,J))<a name='659'>
<font color=#447700>!<a name='660'></font>
        ENDDO<a name='661'>
        ENDDO<a name='662'>
<font color=#447700>!<a name='663'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='664'></font>
<font color=#447700>!***  HORIZONTAL T ADVECTION TENDENCY ADT IS ON H POINTS OF COURSE.<a name='665'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='666'></font>
<font color=#447700>!<a name='667'></font>
        DO J=MYJS5,MYJE5<a name='668'>
        DO I=MYIS2,MYIE2<a name='669'>
          ADT(I,J)=(TEW(I+IHW(J),J)+TEW(I+IHE(J),J)                     &amp;<a name='670'>
     &amp;             +TNS(I,J-1)+TNS(I,J+1)                               &amp;<a name='671'>
     &amp;             +TNE(I+IHW(J),J-1)+TNE(I,J)                          &amp;<a name='672'>
     &amp;             +TSE(I,J)+TSE(I+IHW(J),J+1))                         &amp;<a name='673'>
     &amp;             *RDPD(I,J)*FAD(I,J)<a name='674'>
        ENDDO<a name='675'>
        ENDDO<a name='676'>
<font color=#447700>!<a name='677'></font>
<font color=#447700>!<a name='678'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='679'></font>
<font color=#447700>!***  CALCULATION OF MOMENTUM ADVECTION COMPONENTS.<a name='680'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='681'></font>
<font color=#447700>!<a name='682'></font>
        DO J=MYJS4_P1,MYJE4_P1<a name='683'>
        DO I=MYIS_P1,MYIE_P1<a name='684'>
<font color=#447700>!<a name='685'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='686'></font>
<font color=#447700>!***  THE NS AND EW FLUXES ARE ON H POINTS FOR U AND V.<a name='687'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='688'></font>
<font color=#447700>!<a name='689'></font>
          UEW(I,J)=(FEW(I+IHW(J),J,K)+FEW(I+IHE(J),J,K))                &amp;<a name='690'>
     &amp;            *(UST(I+IHE(J),J)-UST(I+IHW(J),J))<a name='691'>
          UNS(I,J)=(FNS(I+IHW(J),J,K)+FNS(I+IHE(J),J,K))                &amp;<a name='692'>
     &amp;            *(UST(I,J+1)-UST(I,J-1))<a name='693'>
          VEW(I,J)=(FEW(I,J-1,K)+FEW(I,J+1,K))                          &amp;<a name='694'>
     &amp;            *(VST(I+IHE(J),J)-VST(I+IHW(J),J))<a name='695'>
          VNS(I,J)=(FNS(I,J-1,K)+FNS(I,J+1,K))                          &amp;<a name='696'>
     &amp;            *(VST(I,J+1)-VST(I,J-1))<a name='697'>
<font color=#447700>!<a name='698'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='699'></font>
<font color=#447700>!***  THE FOLLOWING NE AND SE FLUXES ARE TIED TO V POINTS AND ARE<a name='700'></font>
<font color=#447700>!***  LOCATED JUST TO THE NE AND SE OF THE GIVEN I,J.<a name='701'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='702'></font>
<font color=#447700>!<a name='703'></font>
          UNE(I,J)=(FNE(I+IVW(J),J,K)+FNE(I+IVE(J),J,K))                &amp;<a name='704'>
     &amp;            *(UST(I+IVE(J),J+1)-UST(I,J))<a name='705'>
          USE(I,J)=(FSE(I+IVW(J),J,K)+FSE(I+IVE(J),J,K))                &amp;<a name='706'>
     &amp;            *(UST(I+IVE(J),J-1)-UST(I,J))<a name='707'>
          VNE(I,J)=(FNE(I,J-1,K)+FNE(I,J+1,K))                          &amp;<a name='708'>
     &amp;            *(VST(I+IVE(J),J+1)-VST(I,J))<a name='709'>
          VSE(I,J)=(FSE(I,J-1,K)+FSE(I,J+1,K))                          &amp;<a name='710'>
     &amp;            *(VST(I+IVE(J),J-1)-VST(I,J))<a name='711'>
<font color=#447700>!<a name='712'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='713'></font>
<font color=#447700>!<a name='714'></font>
        ENDDO<a name='715'>
        ENDDO<a name='716'>
<font color=#447700>!<a name='717'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='718'></font>
<font color=#447700>!***  COMPUTE THE ADVECTION TENDENCIES FOR U AND V.<a name='719'></font>
<font color=#447700>!***  THE AD ARRAYS ARE ON THE VELOCITY POINTS.<a name='720'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='721'></font>
<font color=#447700>!<a name='722'></font>
        DO J=MYJS5,MYJE5<a name='723'>
        DO I=MYIS2,MYIE2<a name='724'>
          ADU(I,J)=(UEW(I+IVW(J),J)+UEW(I+IVE(J),J)                     &amp;<a name='725'>
     &amp;             +UNS(I,J-1)+UNS(I,J+1)                               &amp;<a name='726'>
     &amp;             +UNE(I+IVW(J),J-1)+UNE(I,J)                          &amp;<a name='727'>
     &amp;             +USE(I,J)+USE(I+IVW(J),J+1))                         &amp;<a name='728'>
     &amp;             *RDPDX(I,J)*FAD(I+IVW(J),J)<a name='729'>
<font color=#447700>!<a name='730'></font>
          ADV(I,J)=(VEW(I+IVW(J),J)+VEW(I+IVE(J),J)                     &amp;<a name='731'>
     &amp;             +VNS(I,J-1)+VNS(I,J+1)                               &amp;<a name='732'>
     &amp;             +VNE(I+IVW(J),J-1)+VNE(I,J)                          &amp;<a name='733'>
     &amp;             +VSE(I,J)+VSE(I+IVW(J),J+1))                         &amp;<a name='734'>
     &amp;             *RDPDY(I,J)*FAD(I+IVW(J),J)<a name='735'>
        ENDDO<a name='736'>
        ENDDO<a name='737'>
<font color=#447700>!<a name='738'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='739'></font>
<font color=#447700>!<a name='740'></font>
<font color=#447700>!***  END OF JANJIC HORIZONTAL ADVECTION<a name='741'></font>
<font color=#447700>!<a name='742'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='743'></font>
<font color=#447700>!<a name='744'></font>
<font color=#447700>!***  UPSTREAM ADVECTION OF T<a name='745'></font>
<font color=#447700>!<a name='746'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='747'></font>
<font color=#447700>!<a name='748'></font>
        upstream: IF(UPSTRM)THEN<a name='749'>
<font color=#447700>!<a name='750'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='751'></font>
<font color=#447700>!***<a name='752'></font>
<font color=#447700>!***  COMPUTE UPSTREAM COMPUTATIONS ON THIS TASK'S ROWS.<a name='753'></font>
<font color=#447700>!***<a name='754'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='755'></font>
<font color=#447700>!<a name='756'></font>
          jloop_upstream: DO J=MYJS2,MYJE2<a name='757'>
<font color=#447700>!<a name='758'></font>
            N_IUPH_J=N_IUP_H(J)   <font color=#447700>! See explanation in START_DOMAIN_NMM<a name='759'></font>
            DO II=0,N_IUPH_J-1<a name='760'>
<font color=#447700>!<a name='761'></font>
              I=IUP_H(IMS+II,J)<a name='762'>
              TTA=EMT_LOC(J)*(UST(I,J-1)+UST(I+IHW(J),J)                &amp;<a name='763'>
     &amp;                       +UST(I+IHE(J),J)+UST(I,J+1))<a name='764'>
              TTB=ENT       *(VST(I,J-1)+VST(I+IHW(J),J)                &amp;<a name='765'>
     &amp;                       +VST(I+IHE(J),J)+VST(I,J+1))<a name='766'>
              PP=-TTA-TTB<a name='767'>
              QP= TTA-TTB<a name='768'>
<font color=#447700>!<a name='769'></font>
              IF(PP&lt;0.)THEN<a name='770'>
                ISPA(I,J)=-1<a name='771'>
              ELSE<a name='772'>
                ISPA(I,J)= 1<a name='773'>
              ENDIF<a name='774'>
<font color=#447700>!<a name='775'></font>
              IF(QP&lt;0.)THEN<a name='776'>
                ISQA(I,J)=-1<a name='777'>
              ELSE<a name='778'>
                ISQA(I,J)= 1<a name='779'>
              ENDIF<a name='780'>
<font color=#447700>!<a name='781'></font>
              PP=ABS(PP)<a name='782'>
              QP=ABS(QP)<a name='783'>
              ARRAY3_X=PP*QP<a name='784'>
              ARRAY0(I,J)=ARRAY3_X-PP-QP<a name='785'>
              ARRAY1(I,J)=PP-ARRAY3_X<a name='786'>
              ARRAY2(I,J)=QP-ARRAY3_X<a name='787'>
              ARRAY3(I,J)=ARRAY3_X<a name='788'>
            ENDDO<a name='789'>
<font color=#447700>!<a name='790'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='791'></font>
<font color=#447700>!<a name='792'></font>
            N_IUPADH_J=N_IUP_ADH(J)<a name='793'>
            KNTI_ADH=1<a name='794'>
            IUP_ADH_J=IUP_ADH(IMS,J)<a name='795'>
<font color=#447700>!<a name='796'></font>
            iloop_T: DO II=0,N_IUPH_J-1<a name='797'>
<font color=#447700>!<a name='798'></font>
              I=IUP_H(IMS+II,J)<a name='799'>
<font color=#447700>!<a name='800'></font>
              ISP=ISPA(I,J)<a name='801'>
              ISQ=ISQA(I,J)<a name='802'>
              IFP=(ISP-1)/2<a name='803'>
              IFQ=(-ISQ-1)/2<a name='804'>
              IPQ=(ISP-ISQ)/2<a name='805'>
<font color=#447700>!<a name='806'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='807'></font>
<font color=#447700>!<a name='808'></font>
              IF(I==IUP_ADH_J)THEN  <font color=#447700>! Upstream advection T tendencies<a name='809'></font>
<font color=#447700>!<a name='810'></font>
                ISP=ISPA(I,J)<a name='811'>
                ISQ=ISQA(I,J)<a name='812'>
                IFP=(ISP-1)/2<a name='813'>
                IFQ=(-ISQ-1)/2<a name='814'>
                IPQ=(ISP-ISQ)/2<a name='815'>
<font color=#447700>!<a name='816'></font>
                F0=ARRAY0(I,J)<a name='817'>
                F1=ARRAY1(I,J)<a name='818'>
                F2=ARRAY2(I,J)<a name='819'>
                F3=ARRAY3(I,J)<a name='820'>
<font color=#447700>!<a name='821'></font>
                ADT(I,J)=F0*T(I,J,K)                                    &amp;<a name='822'>
     &amp;                  +F1*T(I+IHE(J)+IFP,J+ISP,K)                     &amp;<a name='823'>
     &amp;                  +F2*T(I+IHE(J)+IFQ,J+ISQ,K)                     &amp;<a name='824'>
                        +F3*T(I+IPQ,J+ISP+ISQ,K)<a name='825'>
<font color=#447700>!<a name='826'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='827'></font>
<font color=#447700>!<a name='828'></font>
                IF(KNTI_ADH&lt;N_IUPADH_J)THEN<a name='829'>
                  IUP_ADH_J=IUP_ADH(IMS+KNTI_ADH,J)<a name='830'>
                  KNTI_ADH=KNTI_ADH+1<a name='831'>
                ENDIF<a name='832'>
<font color=#447700>!<a name='833'></font>
              ENDIF  <font color=#447700>! End of upstream advection T tendency IF block<a name='834'></font>
<font color=#447700>!<a name='835'></font>
            ENDDO iloop_T<a name='836'>
<font color=#447700>!<a name='837'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='838'></font>
<font color=#447700>!<a name='839'></font>
<font color=#447700>!***  UPSTREAM ADVECTION OF VELOCITY COMPONENTS<a name='840'></font>
<font color=#447700>!<a name='841'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='842'></font>
<font color=#447700>!<a name='843'></font>
            N_IUPADV_J=N_IUP_ADV(J)<a name='844'>
<font color=#447700>!<a name='845'></font>
            DO II=0,N_IUPADV_J-1<a name='846'>
              I=IUP_ADV(IMS+II,J)<a name='847'>
<font color=#447700>!<a name='848'></font>
              TTA=EM_LOC(J)*UST(I,J)<a name='849'>
              TTB=EN       *VST(I,J)<a name='850'>
              PP=-TTA-TTB<a name='851'>
              QP=TTA-TTB<a name='852'>
<font color=#447700>!<a name='853'></font>
              IF(PP&lt;0.)THEN<a name='854'>
                ISP=-1<a name='855'>
              ELSE<a name='856'>
                ISP= 1<a name='857'>
              ENDIF<a name='858'>
<font color=#447700>!<a name='859'></font>
              IF(QP&lt;0.)THEN<a name='860'>
                ISQ=-1<a name='861'>
              ELSE<a name='862'>
                ISQ= 1<a name='863'>
              ENDIF<a name='864'>
<font color=#447700>!<a name='865'></font>
              IFP=(ISP-1)/2<a name='866'>
              IFQ=(-ISQ-1)/2<a name='867'>
              IPQ=(ISP-ISQ)/2<a name='868'>
              PP=ABS(PP)<a name='869'>
              QP=ABS(QP)<a name='870'>
              F3=PP*QP<a name='871'>
              F0=F3-PP-QP<a name='872'>
              F1=PP-F3<a name='873'>
              F2=QP-F3<a name='874'>
<font color=#447700>!<a name='875'></font>
              ADU(I,J)=F0*U(I,J,K)                                      &amp;<a name='876'>
     &amp;                +F1*U(I+IVE(J)+IFP,J+ISP,K)                       &amp;<a name='877'>
     &amp;                +F2*U(I+IVE(J)+IFQ,J+ISQ,K)                       &amp;<a name='878'>
     &amp;                +F3*U(I+IPQ,J+ISP+ISQ,K)<a name='879'>
<font color=#447700>!<a name='880'></font>
              ADV(I,J)=F0*V(I,J,K)                                      &amp;<a name='881'>
     &amp;                +F1*V(I+IVE(J)+IFP,J+ISP,K)                       &amp;<a name='882'>
     &amp;                +F2*V(I+IVE(J)+IFQ,J+ISQ,K)                       &amp;<a name='883'>
     &amp;                +F3*V(I+IPQ,J+ISP+ISQ,K)<a name='884'>
<font color=#447700>!<a name='885'></font>
            ENDDO<a name='886'>
<font color=#447700>!<a name='887'></font>
          ENDDO jloop_upstream<a name='888'>
<font color=#447700>!<a name='889'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='890'></font>
<font color=#447700>!<a name='891'></font>
        ENDIF upstream<a name='892'>
<font color=#447700>!<a name='893'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='894'></font>
<font color=#447700>!<a name='895'></font>
<font color=#447700>!***  END OF HORIZONTAL ADVECTION<a name='896'></font>
<font color=#447700>!<a name='897'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='898'></font>
<font color=#447700>!<a name='899'></font>
<font color=#447700>!***  NOW SUM THE VERTICAL AND HORIZONTAL TENDENCIES,<a name='900'></font>
<font color=#447700>!***  CURVATURE AND CORIOLIS TERMS.<a name='901'></font>
<font color=#447700>!<a name='902'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='903'></font>
<font color=#447700>!<a name='904'></font>
        DO J=MYJS2,MYJE2<a name='905'>
        DO I=MYIS1,MYIE1<a name='906'>
          HM=HBM2(I,J)<a name='907'>
          VM=VBM2(I,J)<a name='908'>
          ADT(I,J)=(VAD_TEND_T(I,J,K)+2.*ADT(I,J))*HM<a name='909'>
<font color=#447700>!<a name='910'></font>
          FPP=CURV(I,J)*2.*UST(I,J)+F(I,J)*2.<a name='911'>
          ADU(I,J)=(VAD_TEND_U(I,J,K)+2.*ADU(I,J)+VST(I,J)*FPP)*VM<a name='912'>
          ADV(I,J)=(VAD_TEND_V(I,J,K)+2.*ADV(I,J)-UST(I,J)*FPP)*VM<a name='913'>
        ENDDO<a name='914'>
        ENDDO<a name='915'>
<font color=#447700>!<a name='916'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='917'></font>
<font color=#447700>!***  SAVE THE OLD VALUES FOR TIMESTEPPING<a name='918'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='919'></font>
<font color=#447700>!<a name='920'></font>
        DO J=MYJS_P4,MYJE_P4<a name='921'>
        DO I=MYIS_P4,MYIE_P4<a name='922'>
          TOLD(I,J,K)=T(I,J,K)<a name='923'>
          UOLD(I,J,K)=U(I,J,K)<a name='924'>
          VOLD(I,J,K)=V(I,J,K)<a name='925'>
        ENDDO<a name='926'>
        ENDDO<a name='927'>
<font color=#447700>!<a name='928'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='929'></font>
<font color=#447700>!***  FINALLY UPDATE THE PROGNOSTIC VARIABLES<a name='930'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='931'></font>
<font color=#447700>!<a name='932'></font>
        DO J=MYJS2,MYJE2<a name='933'>
        DO I=MYIS1,MYIE1<a name='934'>
          T(I,J,K)=ADT(I,J)+T(I,J,K)<a name='935'>
          U(I,J,K)=ADU(I,J)+U(I,J,K)<a name='936'>
          V(I,J,K)=ADV(I,J)+V(I,J,K)<a name='937'>
        ENDDO<a name='938'>
        ENDDO<a name='939'>
<font color=#447700>!<a name='940'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='941'></font>
<font color=#447700>!<a name='942'></font>
      ENDDO main_horizontal<a name='943'>
<font color=#447700>!<a name='944'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='945'></font>
<font color=#447700>!<a name='946'></font>
      END SUBROUTINE ADVE<a name='947'>
<font color=#447700>!<a name='948'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='949'></font>
<font color=#447700>!<a name='950'></font>
<font color=#447700>!***********************************************************************<a name='951'></font>
<A NAME='VAD2'><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#VAD2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='952'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VAD2</font>(NTSD,DT,IDTAD,DX,DY                               &amp; <A href='../../call_to/VAD2.html' TARGET='index'>1</A><a name='953'>
     &amp;               ,AETA1,AETA2,DETA1,DETA2,PDSL,PDTOP,HBM2           &amp;<a name='954'>
     &amp;               ,Q,Q2,CWM,PETDT                                    &amp;<a name='955'>
     &amp;               ,N_IUP_H,N_IUP_V                                   &amp;<a name='956'>
     &amp;               ,N_IUP_ADH,N_IUP_ADV                               &amp;<a name='957'>
     &amp;               ,IUP_H,IUP_V,IUP_ADH,IUP_ADV                       &amp;<a name='958'>
     &amp;               ,IHE,IHW,IVE,IVW                                   &amp;<a name='959'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='960'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='961'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='962'>
<font color=#447700>!***********************************************************************<a name='963'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='964'></font>
<font color=#447700>!                .      .    .<a name='965'></font>
<font color=#447700>! SUBPROGRAM:    VAD2        VERTICAL ADVECTION OF H2O SUBSTANCE AND TKE<a name='966'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 96-07-19<a name='967'></font>
<font color=#447700>!<a name='968'></font>
<font color=#447700>! ABSTRACT:<a name='969'></font>
<font color=#447700>!     VAD2 CALCULATES THE CONTRIBUTION OF THE VERTICAL ADVECTION<a name='970'></font>
<font color=#447700>!     TO THE TENDENCIES OF WATER SUBSTANCE AND TKE AND THEN UPDATES<a name='971'></font>
<font color=#447700>!     THOSE VARIABLES.  AN ANTI-FILTERING TECHNIQUE IS USED.<a name='972'></font>
<font color=#447700>!<a name='973'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='974'></font>
<font color=#447700>!   96-07-19  JANJIC   - ORIGINATOR<a name='975'></font>
<font color=#447700>!   98-11-02  BLACK    - MODIFIED FOR DISTRIBUTED MEMORY<a name='976'></font>
<font color=#447700>!   99-03-17  TUCCILLO - INCORPORATED MPI_ALLREDUCE FOR GLOBAL SUM<a name='977'></font>
<font color=#447700>!   02-02-06  BLACK    - CONVERTED TO WRF FORMAT<a name='978'></font>
<font color=#447700>!   02-09-06  WOLFE    - MORE CONVERSION TO GLOBAL INDEXING<a name='979'></font>
<font color=#447700>!   04-11-23  BLACK    - THREADED<a name='980'></font>
<font color=#447700>!   05-12-14  BLACK    - CONVERTED FROM IKJ TO IJK<a name='981'></font>
<font color=#447700>!   07-08-14  janjic   - bc &amp; no conservation in the advection step<a name='982'></font>
<font color=#447700>!<a name='983'></font>
<font color=#447700>! USAGE: CALL VAD2 FROM SUBROUTINE SOLVE_NMM<a name='984'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='985'></font>
<font color=#447700>!<a name='986'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST<a name='987'></font>
<font color=#447700>!<a name='988'></font>
<font color=#447700>!   OUTPUT FILES:<a name='989'></font>
<font color=#447700>!       NONE<a name='990'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='991'></font>
<font color=#447700>!<a name='992'></font>
<font color=#447700>!     UNIQUE: NONE<a name='993'></font>
<font color=#447700>!<a name='994'></font>
<font color=#447700>!     LIBRARY: NONE<a name='995'></font>
<font color=#447700>!<a name='996'></font>
<font color=#447700>! ATTRIBUTES:<a name='997'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='998'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='999'></font>
<font color=#447700>!$$$<a name='1000'></font>
<font color=#447700>!***********************************************************************<a name='1001'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1002'></font>
<font color=#447700>!<a name='1003'></font>
      IMPLICIT NONE<a name='1004'>
<font color=#447700>!<a name='1005'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1006'></font>
<font color=#447700>!<a name='1007'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='1008'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='1009'>
                           ,ITS,ITE,JTS,JTE,KTS,KTE<a name='1010'>
<font color=#447700>!<a name='1011'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='1012'>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: N_IUP_H,N_IUP_V          &amp;<a name='1013'>
     &amp;                                        ,N_IUP_ADH,N_IUP_ADV<a name='1014'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IUP_H,IUP_V      &amp;<a name='1015'>
     &amp;                                                ,IUP_ADH,IUP_ADV<a name='1016'>
<font color=#447700>!<a name='1017'></font>
      INTEGER,INTENT(IN) :: IDTAD,NTSD<a name='1018'>
<font color=#447700>!<a name='1019'></font>
      REAL,INTENT(IN) :: DT,DY,PDTOP<a name='1020'>
<font color=#447700>!<a name='1021'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: AETA1,AETA2,DETA1,DETA2<a name='1022'>
<font color=#447700>!<a name='1023'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DX,HBM2,PDSL<a name='1024'>
<font color=#447700>!<a name='1025'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PETDT<a name='1026'>
<font color=#447700>!<a name='1027'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: CWM,Q,Q2<a name='1028'>
<font color=#447700>!<a name='1029'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1030'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1031'></font>
<font color=#447700>!<a name='1032'></font>
      REAL,PARAMETER :: FF1=0.500<a name='1033'>
<font color=#447700>!<a name='1034'></font>
      LOGICAL,SAVE :: TRADITIONAL=.TRUE.<a name='1035'>
<font color=#447700>!<a name='1036'></font>
      INTEGER :: I,IRECV,J,JFP,JFQ,K,LAP,LLAP<a name='1037'>
<font color=#447700>!<a name='1038'></font>
      INTEGER,DIMENSION(KTS:KTE) :: LA<a name='1039'>
<font color=#447700>!<a name='1040'></font>
      REAL*8 :: ADDT,AFRP,D2PQE,D2PQQ,D2PQW,DEP,DETAP,DQP               &amp;<a name='1041'>
     &amp;       ,DWP,E00,E4P,EP,EP0,HADDT,HBM2IJ                           &amp;<a name='1042'>
     &amp;       ,Q00,Q4P,QP,QP0                                            &amp;<a name='1043'>
     &amp;       ,rdpdn,rdpup,sfacek,sfacqk,sfacwk,RFC,RR                   &amp;<a name='1044'>
     &amp;       ,SUMNE,SUMNQ,SUMNW,SUMPE,SUMPQ,SUMPW                       &amp;<a name='1045'>
     &amp;       ,W00,W4P,WP,WP0<a name='1046'>
<font color=#447700>!<a name='1047'></font>
      REAL,DIMENSION(KTS:KTE) :: AFR,DEL,DQL,DWL,E3,E4,PETDTK           &amp;<a name='1048'>
     &amp;                          ,RFACE,RFACQ,RFACW,Q3,Q4,W3,W4<a name='1049'>
<font color=#447700>!<a name='1050'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1051'></font>
<font color=#447700>!***********************************************************************<a name='1052'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1053'></font>
<font color=#447700>!<a name='1054'></font>
      ADDT=REAL(IDTAD)*DT<a name='1055'>
<font color=#447700>!<a name='1056'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1057'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1058'></font>
<font color=#447700>!$omp&amp; private(afr,afrp,bot,d2pqe,d2pqq,d2pqw,del,dep,detap,dpdn,dpup   &amp;<a name='1059'></font>
<font color=#447700>!$omp&amp;        ,dql,dqp,dwl,dwp,e00,e3,e4,e4p,ep,ep0,haddt,i,j,k         &amp;<a name='1060'></font>
<font color=#447700>!$omp&amp;        ,la,lap,llap,petdtk,q00,q3,q4,q4p,qp,qp0,rfacek,rfacqk    &amp;<a name='1061'></font>
<font color=#447700>!$omp&amp;        ,rfacwk,rfc,rr,sumne,sumnq,sumnw,sumpe,sumpq,sumpw,top    &amp;<a name='1062'></font>
<font color=#447700>!$omp&amp;        ,w00,w3,w4,w4p,wp,wp0)<a name='1063'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1064'></font>
<font color=#447700>!<a name='1065'></font>
      main_integration: DO J=MYJS2,MYJE2<a name='1066'>
<font color=#447700>!<a name='1067'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1068'></font>
<font color=#447700>!<a name='1069'></font>
        main_iloop: DO I=MYIS1_P1,MYIE1_P1<a name='1070'>
<font color=#447700>!<a name='1071'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1072'></font>
<font color=#447700>!<a name='1073'></font>
          E3(KTE)=Q2(I,J,KTE)*0.5<a name='1074'>
<font color=#447700>!<a name='1075'></font>
          DO K=KTE-1,KTS,-1<a name='1076'>
            E3(K)=MAX((Q2(I,J,K+1)+Q2(I,J,K))*0.5,EPSQ2)<a name='1077'>
          ENDDO<a name='1078'>
<font color=#447700>!<a name='1079'></font>
          DO K=KTS,KTE<a name='1080'>
            Q3(K)=MAX(Q(I,J,K),EPSQ)<a name='1081'>
            W3(K)=MAX(CWM(I,J,K),CLIMIT)<a name='1082'>
            E4(K)=E3(K)<a name='1083'>
            Q4(K)=Q3(K)<a name='1084'>
            W4(K)=W3(K)<a name='1085'>
          ENDDO<a name='1086'>
<font color=#447700>!<a name='1087'></font>
          IF(TRADITIONAL)THEN<a name='1088'>
            PETDTK(KTE)=PETDT(I,J,KTE-1)*0.5<a name='1089'>
<font color=#447700>!<a name='1090'></font>
            DO K=KTE-1,KTS+1,-1<a name='1091'>
              PETDTK(K)=(PETDT(I,J,K)+PETDT(I,J,K-1))*0.5<a name='1092'>
            ENDDO<a name='1093'>
<font color=#447700>!<a name='1094'></font>
            PETDTK(KTS)=PETDT(I,J,KTS)*0.5<a name='1095'>
<font color=#447700>!<a name='1096'></font>
          ELSE<a name='1097'>
<font color=#447700>!<a name='1098'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1099'></font>
<font color=#447700>!***    PERFORM HORIZONTAL AVERAGING OF VERTICAL VELOCITY<a name='1100'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1101'></font>
<font color=#447700>!<a name='1102'></font>
            PETDTK(KTE)=(PETDT(I+IHW(J-1),J-1,KTE-1)                    &amp;<a name='1103'>
     &amp;                  +PETDT(I+IHE(J-1),J-1,KTE-1)                    &amp;<a name='1104'>
     &amp;                  +PETDT(I+IHW(J+1),J+1,KTE-1)                    &amp;<a name='1105'>
     &amp;                  +PETDT(I+IHE(J+1),J+1,KTE-1)                    &amp;<a name='1106'>
     &amp;                  +PETDT(I,J,KTE-1)*4.        )*0.0625<a name='1107'>
<font color=#447700>!<a name='1108'></font>
            DO K=KTE-1,KTS+1,-1<a name='1109'>
              PETDTK(K)=(PETDT(I+IHW(J-1),J-1,K-1)                      &amp;<a name='1110'>
                        +PETDT(I+IHE(J-1),J-1,K-1)                      &amp;<a name='1111'>
     &amp;                  +PETDT(I+IHW(J+1),J+1,K-1)                      &amp;<a name='1112'>
     &amp;                  +PETDT(I+IHE(J+1),J+1,K-1)                      &amp;<a name='1113'>
     &amp;                  +PETDT(I+IHW(J-1),J-1,K  )                      &amp;<a name='1114'>
     &amp;                  +PETDT(I+IHE(J-1),J-1,K  )                      &amp;<a name='1115'>
     &amp;                  +PETDT(I+IHW(J+1),J+1,K  )                      &amp;<a name='1116'>
     &amp;                  +PETDT(I+IHE(J+1),J+1,K  )                      &amp;<a name='1117'>
     &amp;                  +(PETDT(I,J,K-1)+PETDT(I,J,K))*4.               &amp;<a name='1118'>
     &amp;                                                   )*0.0625<a name='1119'>
            ENDDO<a name='1120'>
<font color=#447700>!<a name='1121'></font>
            PETDTK(KTS)=(PETDT(I+IHW(J-1),J-1,KTS)                      &amp;<a name='1122'>
     &amp;                  +PETDT(I+IHE(J-1),J-1,KTS)                      &amp;<a name='1123'>
     &amp;                  +PETDT(I+IHW(J+1),J+1,KTS)                      &amp;<a name='1124'>
     &amp;                  +PETDT(I+IHE(J+1),J+1,KTS)                      &amp;<a name='1125'>
     &amp;                  +PETDT(I,J,KTS)*4.        )*0.0625<a name='1126'>
<a name='1127'>
          ENDIF<a name='1128'>
<font color=#447700>!<a name='1129'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1130'></font>
<font color=#447700>!<a name='1131'></font>
          HADDT=-ADDT*HBM2(I,J)<a name='1132'>
<font color=#447700>!<a name='1133'></font>
          DO K=KTE,KTS,-1<a name='1134'>
            RR=PETDTK(K)*HADDT<a name='1135'>
<font color=#447700>!<a name='1136'></font>
            IF(RR&lt;0.)THEN<a name='1137'>
              LAP=1<a name='1138'>
            ELSE<a name='1139'>
              LAP=-1<a name='1140'>
            ENDIF<a name='1141'>
<font color=#447700>!<a name='1142'></font>
            LA(K)=LAP<a name='1143'>
            LLAP=K+LAP<a name='1144'>
<font color=#447700>!<a name='1145'></font>
            if(llap.gt.kts-1.and.llap.lt.kte+1) then <font color=#447700>! internal and outflow pts.<a name='1146'></font>
              rr=abs(rr &amp;<a name='1147'>
     &amp;          /((aeta1(llap)-aeta1(k))*pdtop &amp;<a name='1148'>
     &amp;           +(aeta2(llap)-aeta2(k))*pdsl(i,j)))<a name='1149'>
              if(rr.gt.0.999) rr=0.999   <a name='1150'>
<font color=#447700>!<a name='1151'></font>
              AFR(K)=(((FF4*RR+FF3)*RR+FF2)*RR+FF1)*RR<a name='1152'>
              dql(k)=(q3(llap)-q3(k))*rr<a name='1153'>
              dwl(k)=(w3(llap)-w3(k))*rr<a name='1154'>
              del(k)=(e3(llap)-e3(k))*rr<a name='1155'>
            elseif(llap.eq.kts-1) then<a name='1156'>
<font color=#447700>!<a name='1157'></font>
<font color=#447700>!chem              rr=abs(rr &amp;<a name='1158'></font>
<font color=#447700>!chem                /((1.-aeta2(kts))*pdsl(i,j)))<a name='1159'></font>
<font color=#447700>!chem              afr(kts)=0.<a name='1160'></font>
<font color=#447700>!chem              dql(kts)=(epsq  -q3(kts))*rr<a name='1161'></font>
<font color=#447700>!chem              dwl(kts)=(climit-w3(kts))*rr<a name='1162'></font>
<font color=#447700>!chem              del(kts)=(epsq2 -e3(kts))*rr<a name='1163'></font>
<font color=#447700>!<a name='1164'></font>
              rr=0.<a name='1165'>
              afr(kts)=0.<a name='1166'>
              dql(kts)=0.<a name='1167'>
              dwl(kts)=0.<a name='1168'>
              del(kts)=0.<a name='1169'>
            else<a name='1170'>
              rr=abs(rr &amp;<a name='1171'>
                /(aeta1(kte)*pdtop))<a name='1172'>
              afr(kte)=0.<a name='1173'>
              dql(kte)=(epsq  -q3(kte))*rr<a name='1174'>
              dwl(kte)=(climit-w3(kte))*rr<a name='1175'>
              del(kte)=(epsq2 -e3(kte))*rr<a name='1176'>
            endif<a name='1177'>
          ENDDO<a name='1178'>
<font color=#447700>!<a name='1179'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1180'></font>
<font color=#447700>!<a name='1181'></font>
          DO K=KTS,KTE<a name='1182'>
            Q4(K)=Q3(K)+DQL(K)<a name='1183'>
            W4(K)=W3(K)+DWL(K)<a name='1184'>
            E4(K)=E3(K)+DEL(K)<a name='1185'>
          ENDDO<a name='1186'>
<font color=#447700>!<a name='1187'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1188'></font>
<font color=#447700>!***  ANTI-FILTERING STEP<a name='1189'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1190'></font>
<font color=#447700>!<a name='1191'></font>
          SUMPQ=0.<a name='1192'>
          SUMNQ=0.<a name='1193'>
          SUMPW=0.<a name='1194'>
          SUMNW=0.<a name='1195'>
          SUMPE=0.<a name='1196'>
          SUMNE=0.<a name='1197'>
<font color=#447700>!<a name='1198'></font>
<font color=#447700>!***  ANTI-FILTERING LIMITERS<a name='1199'></font>
<font color=#447700>!<a name='1200'></font>
          antifilter: DO K=KTE-1,KTS+1,-1<a name='1201'>
<font color=#447700>!<a name='1202'></font>
            DETAP=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='1203'>
<font color=#447700>!<a name='1204'></font>
            DQL(K)=0.<a name='1205'>
            DWL(K)=0.<a name='1206'>
            DEL(K)=0.<a name='1207'>
<font color=#447700>!<a name='1208'></font>
            Q4P=Q4(K)<a name='1209'>
            W4P=W4(K)<a name='1210'>
            E4P=E4(K)<a name='1211'>
<font color=#447700>!<a name='1212'></font>
            LAP=LA(K)<a name='1213'>
<font color=#447700>!<a name='1214'></font>
            if(lap.ne.0)then<a name='1215'>
              rdpdn=1./((aeta1(k+lap)-aeta1(k))*pdtop &amp;<a name='1216'>
     &amp;                 +(aeta2(k+lap)-aeta2(k))*pdsl(i,j))<a name='1217'>
              rdpup=1./((aeta1(k)-aeta1(k-lap))*pdtop &amp;<a name='1218'>
     &amp;                 +(aeta2(k)-aeta2(k-lap))*pdsl(i,j))<a name='1219'>
<font color=#447700>!<a name='1220'></font>
              afrp=afr(k)*detap<a name='1221'>
<font color=#447700>!<a name='1222'></font>
              d2pqq=((q4(k+lap)-q4p)*rdpdn &amp;<a name='1223'>
     &amp;              -(q4p-q4(k-lap))*rdpup)*afrp<a name='1224'>
              d2pqw=((w4(k+lap)-w4p)*rdpdn &amp;<a name='1225'>
     &amp;              -(w4p-w4(k-lap))*rdpup)*afrp<a name='1226'>
              d2pqe=((e4(k+lap)-e4p)*rdpdn &amp;<a name='1227'>
     &amp;              -(e4p-e4(k-lap))*rdpup)*afrp<a name='1228'>
            ELSE<a name='1229'>
              D2PQQ=0.<a name='1230'>
              D2PQW=0.<a name='1231'>
              D2PQE=0.<a name='1232'>
            ENDIF<a name='1233'>
<font color=#447700>!<a name='1234'></font>
            QP=Q4P-D2PQQ<a name='1235'>
            WP=W4P-D2PQW<a name='1236'>
            EP=E4P-D2PQE<a name='1237'>
<font color=#447700>!<a name='1238'></font>
            Q00=Q3(K)<a name='1239'>
            QP0=Q3(K+LAP)<a name='1240'>
<font color=#447700>!<a name='1241'></font>
            W00=W3(K)<a name='1242'>
            WP0=W3(K+LAP)<a name='1243'>
<font color=#447700>!<a name='1244'></font>
            E00=E3(K)<a name='1245'>
            EP0=E3(K+LAP)<a name='1246'>
<font color=#447700>!<a name='1247'></font>
            IF(LAP/=0)THEN<a name='1248'>
              QP=MAX(QP,MIN(Q00,QP0))<a name='1249'>
              QP=MIN(QP,MAX(Q00,QP0))<a name='1250'>
              WP=MAX(WP,MIN(W00,WP0))<a name='1251'>
              WP=MIN(WP,MAX(W00,WP0))<a name='1252'>
              EP=MAX(EP,MIN(E00,EP0))<a name='1253'>
              EP=MIN(EP,MAX(E00,EP0))<a name='1254'>
            ENDIF<a name='1255'>
<font color=#447700>!<a name='1256'></font>
            dqp=qp-q4p<a name='1257'>
            dwp=wp-w4p<a name='1258'>
            dep=ep-e4p<a name='1259'>
<font color=#447700>!<a name='1260'></font>
            DQL(K)=DQP<a name='1261'>
            DWL(K)=DWP<a name='1262'>
            DEL(K)=DEP<a name='1263'>
<font color=#447700>!<a name='1264'></font>
            DQP=DQP*DETAP<a name='1265'>
            DWP=DWP*DETAP<a name='1266'>
            DEP=DEP*DETAP<a name='1267'>
<font color=#447700>!<a name='1268'></font>
            IF(DQP&gt;0.)THEN<a name='1269'>
              SUMPQ=SUMPQ+DQP<a name='1270'>
            ELSE<a name='1271'>
              SUMNQ=SUMNQ+DQP<a name='1272'>
            ENDIF<a name='1273'>
<font color=#447700>!<a name='1274'></font>
            IF(DWP&gt;0.)THEN<a name='1275'>
              SUMPW=SUMPW+DWP<a name='1276'>
            ELSE<a name='1277'>
              SUMNW=SUMNW+DWP<a name='1278'>
            ENDIF<a name='1279'>
<font color=#447700>!<a name='1280'></font>
            IF(DEP&gt;0.)THEN<a name='1281'>
              SUMPE=SUMPE+DEP<a name='1282'>
            ELSE<a name='1283'>
              SUMNE=SUMNE+DEP<a name='1284'>
            ENDIF<a name='1285'>
<font color=#447700>!<a name='1286'></font>
          ENDDO antifilter<a name='1287'>
<font color=#447700>!<a name='1288'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1289'></font>
<font color=#447700>!<a name='1290'></font>
          DQL(KTS)=0.<a name='1291'>
          DWL(KTS)=0.<a name='1292'>
          DEL(KTS)=0.<a name='1293'>
<font color=#447700>!<a name='1294'></font>
          DQL(KTE)=0.<a name='1295'>
          DWL(KTE)=0.<a name='1296'>
          DEL(KTE)=0.<a name='1297'>
<font color=#447700>!<a name='1298'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1299'></font>
<font color=#447700>!***  FIRST MOMENT CONSERVING FACTOR<a name='1300'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1301'></font>
<font color=#447700>!<a name='1302'></font>
          if(sumpq*(-sumnq).gt.1.e-9) then<a name='1303'>
            sfacqk=-sumnq/sumpq<a name='1304'>
          else<a name='1305'>
            sfacqk=0.<a name='1306'>
          endif<a name='1307'>
<font color=#447700>!<a name='1308'></font>
          if(sumpw*(-sumnw).gt.1.e-9) then<a name='1309'>
            sfacwk=-sumnw/sumpw<a name='1310'>
          else<a name='1311'>
            sfacwk=0.<a name='1312'>
          endif<a name='1313'>
<font color=#447700>!<a name='1314'></font>
          if(sumpe*(-sumne).gt.1.e-9) then<a name='1315'>
            sfacek=-sumne/sumpe<a name='1316'>
          else<a name='1317'>
            sfacek=0.<a name='1318'>
          endif<a name='1319'>
<font color=#447700>!<a name='1320'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1321'></font>
<font color=#447700>!***  IMPOSE CONSERVATION ON ANTI-FILTERING<a name='1322'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1323'></font>
<font color=#447700>!<a name='1324'></font>
          DO K=KTE,KTS,-1<a name='1325'>
<font color=#447700>!<a name='1326'></font>
            dqp=dql(k)<a name='1327'>
            if(sfacqk.gt.0.) then<a name='1328'>
              if(sfacqk.ge.1.) then<a name='1329'>
                if(dqp.lt.0.) dqp=dqp/sfacqk<a name='1330'>
              else<a name='1331'>
                if(dqp.gt.0.) dqp=dqp*sfacqk<a name='1332'>
              endif<a name='1333'>
            else<a name='1334'>
              dqp=0.<a name='1335'>
            endif<a name='1336'>
            q  (i,j,k)=q4(k)+dqp<a name='1337'>
<font color=#447700>!<a name='1338'></font>
            dwp=dwl(k)<a name='1339'>
            if(sfacwk.gt.0.) then<a name='1340'>
              if(sfacwk.ge.1.) then<a name='1341'>
                if(dwp.lt.0.) dwp=dwp/sfacwk<a name='1342'>
              else<a name='1343'>
                if(dwp.gt.0.) dwp=dwp*sfacwk<a name='1344'>
              endif<a name='1345'>
            else<a name='1346'>
              dwp=0.<a name='1347'>
            endif<a name='1348'>
            cwm(i,j,k)=w4(k)+dwp<a name='1349'>
<font color=#447700>!<a name='1350'></font>
            dep=del(k)<a name='1351'>
            if(sfacek.gt.0.) then<a name='1352'>
              if(sfacek.ge.1.) then<a name='1353'>
                if(dep.lt.0.) dep=dep/sfacek<a name='1354'>
              else<a name='1355'>
                if(dep.gt.0.) dep=dep*sfacek<a name='1356'>
              endif<a name='1357'>
            else<a name='1358'>
              dep=0.<a name='1359'>
            endif<a name='1360'>
            e3 (    k)=e4(k)+dep<a name='1361'>
<font color=#447700>!<a name='1362'></font>
          ENDDO<a name='1363'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1364'></font>
          HBM2IJ=HBM2(I,J)<a name='1365'>
          Q2(I,J,KTE)=MAX(E3(KTE)+E3(KTE)-EPSQ2,EPSQ2)*HBM2IJ           &amp;<a name='1366'>
       &amp;             +Q2(I,J,KTE)*(1.-HBM2IJ)<a name='1367'>
          DO K=KTE-1,KTS+1,-1<a name='1368'>
            Q2(I,J,K)=MAX(E3(K)+E3(K)-Q2(I,J,K+1),EPSQ2)*HBM2IJ         &amp;<a name='1369'>
       &amp;             +Q2(I,J,K)*(1.-HBM2IJ)<a name='1370'>
          ENDDO<a name='1371'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1372'></font>
<font color=#447700>!<a name='1373'></font>
        ENDDO main_iloop<a name='1374'>
<font color=#447700>!<a name='1375'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1376'></font>
<font color=#447700>!<a name='1377'></font>
      ENDDO main_integration<a name='1378'>
<font color=#447700>!<a name='1379'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1380'></font>
<font color=#447700>!<a name='1381'></font>
      END SUBROUTINE VAD2<a name='1382'>
<font color=#447700>!<a name='1383'></font>
<a name='1384'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1385'></font>
<font color=#447700>!<a name='1386'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1387'></font>
<font color=#447700>!***********************************************************************<a name='1388'></font>
<A NAME='HAD2'><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1389'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HAD2</font>(                                                  &amp; <A href='../../call_to/HAD2.html' TARGET='index'>1</A>,<A href='../../call_from/HAD2.html' TARGET='index'>3</A><a name='1390'>
#if defined(DM_PARALLEL)<a name='1391'>
     &amp;                domdesc ,                                         &amp;<a name='1392'>
#endif<a name='1393'>
     &amp;                NTSD,DT,IDTAD,DX,DY                               &amp;<a name='1394'>
     &amp;               ,AETA1,AETA2,DETA1,DETA2,PDSL,PDTOP                &amp;<a name='1395'>
     &amp;               ,HBM2,HBM3                                         &amp;<a name='1396'>
     &amp;               ,Q,Q2,CWM,U,V,Z,HYDRO                              &amp;<a name='1397'>
     &amp;               ,N_IUP_H,N_IUP_V                                   &amp;<a name='1398'>
     &amp;               ,N_IUP_ADH,N_IUP_ADV                               &amp;<a name='1399'>
     &amp;               ,IUP_H,IUP_V,IUP_ADH,IUP_ADV                       &amp;<a name='1400'>
     &amp;               ,IHE,IHW,IVE,IVW                                   &amp;<a name='1401'>
     &amp;               ,advect_Q2                                         &amp;<a name='1402'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='1403'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='1404'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1405'>
<font color=#447700>!***********************************************************************<a name='1406'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='1407'></font>
<font color=#447700>!                .      .    .<a name='1408'></font>
<font color=#447700>! SUBPROGRAM:    HAD2        HORIZONTAL ADVECTION OF H2O AND TKE<a name='1409'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 96-07-19<a name='1410'></font>
<font color=#447700>!<a name='1411'></font>
<font color=#447700>! ABSTRACT:<a name='1412'></font>
<font color=#447700>!     HAD2 CALCULATES THE CONTRIBUTION OF THE HORIZONTAL ADVECTION<a name='1413'></font>
<font color=#447700>!     TO THE TENDENCIES OF WATER SUBSTANCE AND TKE AND THEN<a name='1414'></font>
<font color=#447700>!     UPDATES THOSE VARIABLES.  AN ANTI-FILTERING TECHNIQUE IS USED.<a name='1415'></font>
<font color=#447700>!<a name='1416'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='1417'></font>
<font color=#447700>!   96-07-19  JANJIC   - ORIGINATOR<a name='1418'></font>
<font color=#447700>!   98-11-02  BLACK    - MODIFIED FOR DISTRIBUTED MEMORY<a name='1419'></font>
<font color=#447700>!   99-03-17  TUCCILLO - INCORPORATED MPI_ALLREDUCE FOR GLOBAL SUM<a name='1420'></font>
<font color=#447700>!   02-02-06  BLACK    - CONVERTED TO WRF FORMAT<a name='1421'></font>
<font color=#447700>!   02-09-06  WOLFE    - MORE CONVERSION TO GLOBAL INDEXING<a name='1422'></font>
<font color=#447700>!   03-05-23  JANJIC   - ADDED SLOPE FACTOR<a name='1423'></font>
<font color=#447700>!   04-11-23  BLACK    - THREADED<a name='1424'></font>
<font color=#447700>!   05-12-14  BLACK    - CONVERTED FROM IKJ TO IJK<a name='1425'></font>
<font color=#447700>!   07-08-14  janjic   - no conservation in advection step<a name='1426'></font>
<font color=#447700>!<a name='1427'></font>
<font color=#447700>! USAGE: CALL HAD2 FROM SUBROUTINE SOLVE_NMM<a name='1428'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='1429'></font>
<font color=#447700>!<a name='1430'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST<a name='1431'></font>
<font color=#447700>!<a name='1432'></font>
<font color=#447700>!   OUTPUT FILES:<a name='1433'></font>
<font color=#447700>!       NONE<a name='1434'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='1435'></font>
<font color=#447700>!<a name='1436'></font>
<font color=#447700>!     UNIQUE: NONE<a name='1437'></font>
<font color=#447700>!<a name='1438'></font>
<font color=#447700>!     LIBRARY: NONE<a name='1439'></font>
<font color=#447700>!<a name='1440'></font>
<font color=#447700>! ATTRIBUTES:<a name='1441'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='1442'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='1443'></font>
<font color=#447700>!$$$<a name='1444'></font>
<font color=#447700>!***********************************************************************<a name='1445'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1446'></font>
<font color=#447700>!<a name='1447'></font>
      IMPLICIT NONE<a name='1448'>
<font color=#447700>!<a name='1449'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1450'></font>
<font color=#447700>!<a name='1451'></font>
      LOGICAL, INTENT(IN) :: advect_Q2<a name='1452'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='1453'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='1454'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='1455'>
<font color=#447700>!<a name='1456'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='1457'>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: N_IUP_H,N_IUP_V          &amp;<a name='1458'>
     &amp;                                        ,N_IUP_ADH,N_IUP_ADV<a name='1459'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IUP_H,IUP_V      &amp;<a name='1460'>
     &amp;                                                ,IUP_ADH,IUP_ADV<a name='1461'>
<font color=#447700>!<a name='1462'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1463'></font>
<font color=#447700>!<a name='1464'></font>
      INTEGER,INTENT(IN) :: IDTAD,NTSD<a name='1465'>
<font color=#447700>!<a name='1466'></font>
      REAL,INTENT(IN) :: DT,DY,PDTOP<a name='1467'>
<font color=#447700>!<a name='1468'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: AETA1,AETA2,DETA1,DETA2<a name='1469'>
<font color=#447700>!<a name='1470'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DX,HBM2,HBM3,PDSL<a name='1471'>
<font color=#447700>!<a name='1472'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: U,V,Z<a name='1473'>
<font color=#447700>!<a name='1474'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: CWM,Q,Q2<a name='1475'>
<font color=#447700>!<a name='1476'></font>
      LOGICAL,INTENT(IN) :: HYDRO<a name='1477'>
<font color=#447700>!<a name='1478'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1479'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='1480'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1481'></font>
<font color=#447700>!<a name='1482'></font>
      REAL,PARAMETER :: FF1=0.530<a name='1483'>
<font color=#447700>!<a name='1484'></font>
#ifdef DM_PARALLEL<a name='1485'>
      INTEGER :: DOMDESC<a name='1486'>
#endif<a name='1487'>
<font color=#447700>!<a name='1488'></font>
#if defined(BIT_FOR_BIT) &amp;&amp; defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='1489'></font>
      LOGICAL,EXTERNAL :: WRF_DM_ON_MONITOR<a name='1490'>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,6) :: XSUMS_L<a name='1491'>
      REAL,DIMENSION(IDS:IDE,JDS:JDE,KDS:KDE,6) :: XSUMS_G<a name='1492'>
#endif<a name='1493'>
<font color=#447700>!<a name='1494'></font>
      LOGICAL :: BOT,TOP<a name='1495'>
<font color=#447700>!<a name='1496'></font>
      INTEGER :: I,IRECV,J,JFP,JFQ,K,LAP,LLAP,MPI_COMM_COMP<a name='1497'>
      INTEGER :: N<a name='1498'>
<font color=#447700>!<a name='1499'></font>
      INTEGER,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5,KTS:KTE) :: IFPA,IFPF   &amp;<a name='1500'>
     &amp;                                                     ,IFQA,IFQF   &amp;<a name='1501'>
     &amp;                                                     ,JFPA,JFPF   &amp;<a name='1502'>
     &amp;                                                     ,JFQA,JFQF<a name='1503'>
<font color=#447700>!<a name='1504'></font>
      REAL :: ADDT,AFRP,CRIT,D2PQE,D2PQQ,D2PQW,DEP,DESTIJ,DQP,DQSTIJ    &amp;<a name='1505'>
     &amp;       ,DVOLP,DWP,DWSTIJ,DZA,DZB,E00,E0Q,E1X,E2IJ,E4P,ENH,EP,EP0  &amp;<a name='1506'>
     &amp;       ,ESTIJ,FPQ,HAFP,HAFQ,HBM2IJ,HM,PP,PPQ00,Q00,Q0Q            &amp;<a name='1507'>
     &amp;       ,Q1IJ,Q4P,QP,QP0,QSTIJ,RDY,RFACE,RFACQ,RFACW,RFC           &amp;<a name='1508'>
     &amp;       ,RFEIJ,RFQIJ,RFWIJ,RR,SLOPAC,SPP,SQP,SSA,SSB,SUMNE,SUMNQ   &amp;<a name='1509'>
     &amp;       ,SUMNW,SUMPE,SUMPQ,SUMPW,TTA,TTB,W00,W0Q,W1IJ,W4P,WP,WP0   &amp;<a name='1510'>
     &amp;       ,WSTIJ<a name='1511'>
<font color=#447700>!<a name='1512'></font>
      DOUBLE PRECISION,DIMENSION(6,KTS:KTE) :: GSUMS,XSUMS<a name='1513'>
<font color=#447700>!<a name='1514'></font>
      REAL,DIMENSION(KTS:KTE) :: AFR,DEL,DQL,DWL,E3,E4                  &amp;<a name='1515'>
     &amp;                          ,Q3,Q4,W3,W4<a name='1516'>
<font color=#447700>!<a name='1517'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: DARE,EMH<a name='1518'>
<font color=#447700>!<a name='1519'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5,KTS:KTE) :: AFP,AFQ,DEST   &amp;<a name='1520'>
     &amp;                                                  ,DQST,DVOL,DWST &amp;<a name='1521'>
     &amp;                                                  ,E1,E2,Q1,W1<a name='1522'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1523'></font>
      integer :: nunit,ier<a name='1524'>
      save nunit<a name='1525'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1526'></font>
<font color=#447700>!***********************************************************************<a name='1527'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1528'></font>
<font color=#447700>!<a name='1529'></font>
      RDY=1./DY<a name='1530'>
      SLOPAC=SLOPHT*SQRT(2.)*0.5*50.<a name='1531'>
      CRIT=SLOPAC*REAL(IDTAD)*DT*RDY*1000.<a name='1532'>
<font color=#447700>!<a name='1533'></font>
      ADDT=REAL(IDTAD)*DT<a name='1534'>
      ENH=ADDT/(08.*DY)<a name='1535'>
<font color=#447700>!<a name='1536'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1537'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1538'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1539'></font>
      DO J=MYJS_P3,MYJE_P3<a name='1540'>
      DO I=MYIS_P2,MYIE_P2<a name='1541'>
        EMH (I,J)=ADDT/(08.*DX(I,J))<a name='1542'>
        DARE(I,J)=HBM3(I,J)*DX(I,J)*DY<a name='1543'>
      ENDDO<a name='1544'>
      ENDDO<a name='1545'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1546'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1547'></font>
      if(advect_Q2) then<a name='1548'>
        DO J=MYJS_P3,MYJE_P3<a name='1549'>
        DO I=MYIS_P2,MYIE_P2<a name='1550'>
          E1(I,J,KTE)=MAX(Q2(I,J,KTE)*0.5,EPSQ2)<a name='1551'>
          E2(I,J,KTE)=E1(I,J,KTE)<a name='1552'>
        ENDDO<a name='1553'>
        ENDDO<a name='1554'>
      endif<a name='1555'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1556'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1557'></font>
<font color=#447700>!$omp&amp; private(dza,dzb,e1x,fpq,hm,i,j,jfp,jfq,k,pp,qp,ssa,ssb,spp,sqp   &amp;<a name='1558'></font>
<font color=#447700>!$omp&amp;        ,tta,ttb)<a name='1559'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1560'></font>
<font color=#447700>!<a name='1561'></font>
      vertical_1: DO K=KTS,KTE<a name='1562'>
<font color=#447700>!<a name='1563'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1564'></font>
<font color=#447700>!<a name='1565'></font>
        DO J=MYJS_P3,MYJE_P3<a name='1566'>
        DO I=MYIS_P2,MYIE_P2<a name='1567'>
          DVOL(I,J,K)=DARE(I,J)*(DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J))<a name='1568'>
          Q  (I,J,K)=MAX(Q  (I,J,K),EPSQ)<a name='1569'>
          CWM(I,J,K)=MAX(CWM(I,J,K),CLIMIT)<a name='1570'>
          Q1 (I,J,K)=Q  (I,J,K)<a name='1571'>
          W1 (I,J,K)=CWM(I,J,K)<a name='1572'>
        ENDDO<a name='1573'>
        ENDDO<a name='1574'>
<font color=#447700>!<a name='1575'></font>
        if(advect_Q2) then<a name='1576'>
          IF(K&lt;KTE)THEN<a name='1577'>
            DO J=MYJS_P3,MYJE_P3<a name='1578'>
            DO I=MYIS_P2,MYIE_P2<a name='1579'>
              E1X=(Q2(I,J,K+1)+Q2(I,J,K))*0.5<a name='1580'>
              E1(I,J,K)=MAX(E1X,EPSQ2)<a name='1581'>
              E2(I,J,K)=E1(I,J,K)<a name='1582'>
            ENDDO<a name='1583'>
            ENDDO<a name='1584'>
          ENDIF<a name='1585'>
        endif<a name='1586'>
<font color=#447700>!<a name='1587'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1588'></font>
<font color=#447700>!<a name='1589'></font>
        DO J=MYJS2_P1,MYJE2_P1<a name='1590'>
        DO I=MYIS1_P1,MYIE1_P1<a name='1591'>
<font color=#447700>!<a name='1592'></font>
          HM=HBM2(I,J)<a name='1593'>
          TTA=(U(I,J-1,K)+U(I+IHW(J),J,K)+U(I+IHE(J),J,K)+U(I,J+1,K))   &amp;<a name='1594'>
     &amp;        *EMH(I,J)*HM<a name='1595'>
          TTB=(V(I,J-1,K)+V(I+IHW(J),J,K)+V(I+IHE(J),J,K)+V(I,J+1,K))   &amp;<a name='1596'>
     &amp;        *ENH*HBM2(I,J)<a name='1597'>
<font color=#447700>!<a name='1598'></font>
          SPP=-TTA-TTB<a name='1599'>
          SQP= TTA-TTB<a name='1600'>
<font color=#447700>!<a name='1601'></font>
          IF(SPP&lt;0.)THEN<a name='1602'>
            JFP=-1<a name='1603'>
          ELSE<a name='1604'>
            JFP=1<a name='1605'>
          ENDIF<a name='1606'>
          IF(SQP&lt;0.)THEN<a name='1607'>
            JFQ=-1<a name='1608'>
          ELSE<a name='1609'>
            JFQ=1<a name='1610'>
          ENDIF<a name='1611'>
<font color=#447700>!<a name='1612'></font>
          IFPA(I,J,K)=IHE(J)+I+( JFP-1)/2<a name='1613'>
          IFQA(I,J,K)=IHE(J)+I+(-JFQ-1)/2<a name='1614'>
<font color=#447700>!<a name='1615'></font>
          JFPA(I,J,K)=J+JFP<a name='1616'>
          JFQA(I,J,K)=J+JFQ<a name='1617'>
<font color=#447700>!<a name='1618'></font>
          IFPF(I,J,K)=IHE(J)+I+(-JFP-1)/2<a name='1619'>
          IFQF(I,J,K)=IHE(J)+I+( JFQ-1)/2<a name='1620'>
<font color=#447700>!<a name='1621'></font>
          JFPF(I,J,K)=J-JFP<a name='1622'>
          JFQF(I,J,K)=J-JFQ<a name='1623'>
<font color=#447700>!     if(i==111.and.j==438.and.k==1)then<a name='1624'></font>
<font color=#447700>!     endif<a name='1625'></font>
<font color=#447700>!<a name='1626'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1627'></font>
          IF(.NOT.HYDRO)THEN <font color=#447700>! z currently not available for hydro=.true.<a name='1628'></font>
            DZA=(Z(IFPA(I,J,K),JFPA(I,J,K),K)-Z(I,J,K))*RDY<a name='1629'>
            DZB=(Z(IFQA(I,J,K),JFQA(I,J,K),K)-Z(I,J,K))*RDY<a name='1630'>
<font color=#447700>!<a name='1631'></font>
            IF(ABS(DZA)&gt;SLOPAC)THEN<a name='1632'>
              SSA=DZA*SPP<a name='1633'>
              IF(SSA&gt;CRIT)THEN<a name='1634'>
                SPP=0. <font color=#447700>!spp*.1<a name='1635'></font>
              ENDIF<a name='1636'>
            ENDIF<a name='1637'>
<font color=#447700>!<a name='1638'></font>
            IF(ABS(DZB)&gt;SLOPAC)THEN<a name='1639'>
              SSB=DZB*SQP<a name='1640'>
              IF(SSB&gt;CRIT)THEN<a name='1641'>
                SQP=0. <font color=#447700>!sqp*.1<a name='1642'></font>
              ENDIF<a name='1643'>
            ENDIF<a name='1644'>
<font color=#447700>!<a name='1645'></font>
          ENDIF<a name='1646'>
<font color=#447700>!<a name='1647'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1648'></font>
<font color=#447700>!<a name='1649'></font>
          FPQ=SPP*SQP*0.25<a name='1650'>
          PP=ABS(SPP)<a name='1651'>
          QP=ABS(SQP)<a name='1652'>
<font color=#447700>!<a name='1653'></font>
          AFP(I,J,K)=(((FF4*PP+FF3)*PP+FF2)*PP+FF1)*PP<a name='1654'>
          AFQ(I,J,K)=(((FF4*QP+FF3)*QP+FF2)*QP+FF1)*QP<a name='1655'>
<font color=#447700>!<a name='1656'></font>
          Q1(I,J,K)=(Q  (IFPA(I,J,K),JFPA(I,J,K),K)-Q  (I,J,K))*PP        &amp;<a name='1657'>
       &amp;           +(Q  (IFQA(I,J,K),JFQA(I,J,K),K)-Q  (I,J,K))*QP        &amp;<a name='1658'>
       &amp;           +(Q  (I,J-2,K)+Q  (I,J+2,K)                            &amp;<a name='1659'>
       &amp;            -Q  (I-1,J,K)-Q  (I+1,J,K))*FPQ                       &amp;<a name='1660'>
       &amp;           +Q(I,J,K)<a name='1661'>
<font color=#447700>!<a name='1662'></font>
          W1(I,J,K)=(CWM(IFPA(I,J,K),JFPA(I,J,K),K)-CWM(I,J,K))*PP        &amp;<a name='1663'>
       &amp;           +(CWM(IFQA(I,J,K),JFQA(I,J,K),K)-CWM(I,J,K))*QP        &amp;<a name='1664'>
       &amp;           +(CWM(I,J-2,K)+CWM(I,J+2,K)                            &amp;<a name='1665'>
       &amp;            -CWM(I-1,J,K)-CWM(I+1,J,K))*FPQ                       &amp;<a name='1666'>
       &amp;           +CWM(I,J,K)<a name='1667'>
<font color=#447700>!<a name='1668'></font>
         if(advect_Q2) then<a name='1669'>
          E2(I,J,K)=(E1 (IFPA(I,J,K),JFPA(I,J,K),K)-E1 (I,J,K))*PP        &amp;<a name='1670'>
       &amp;           +(E1 (IFQA(I,J,K),JFQA(I,J,K),K)-E1 (I,J,K))*QP        &amp;<a name='1671'>
       &amp;           +(E1 (I,J-2,K)+E1 (I,J+2,K)                            &amp;<a name='1672'>
       &amp;            -E1 (I-1,J,K)-E1 (I+1,J,K))*FPQ                       &amp;<a name='1673'>
       &amp;           +E1(I,J,K)<a name='1674'>
         endif<a name='1675'>
        ENDDO<a name='1676'>
        ENDDO<a name='1677'>
<font color=#447700>!<a name='1678'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1679'></font>
<font color=#447700>!<a name='1680'></font>
      ENDDO vertical_1<a name='1681'>
<font color=#447700>!<a name='1682'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1683'></font>
<font color=#447700>!***  ANTI-FILTERING STEP<a name='1684'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1685'></font>
<font color=#447700>!<a name='1686'></font>
      DO K=KTS,KTE<a name='1687'>
        XSUMS(1,K)=0.<a name='1688'>
        XSUMS(2,K)=0.<a name='1689'>
        XSUMS(3,K)=0.<a name='1690'>
        XSUMS(4,K)=0.<a name='1691'>
        XSUMS(5,K)=0.<a name='1692'>
        XSUMS(6,K)=0.<a name='1693'>
      ENDDO<a name='1694'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1695'></font>
<font color=#447700>!<a name='1696'></font>
<font color=#447700>!***  ANTI-FILTERING LIMITERS<a name='1697'></font>
<font color=#447700>!<a name='1698'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1699'></font>
#if defined(BIT_FOR_BIT) &amp;&amp; defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='1700'></font>
      DO N=1,6<a name='1701'>
<font color=#447700>!<a name='1702'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1703'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1704'></font>
        DO K=KMS,KME <a name='1705'>
        DO J=JMS,JME <a name='1706'>
        DO I=IMS,IME <a name='1707'>
          XSUMS_L(I,J,K,N)=0.<a name='1708'>
        ENDDO<a name='1709'>
        ENDDO<a name='1710'>
        ENDDO<a name='1711'>
<font color=#447700>!<a name='1712'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1713'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1714'></font>
        DO K=KDS,KDE <a name='1715'>
        DO J=JDS,JDE <a name='1716'>
        DO I=IDS,IDE <a name='1717'>
          XSUMS_G(I,J,K,N)=0.<a name='1718'>
        ENDDO<a name='1719'>
        ENDDO<a name='1720'>
        ENDDO<a name='1721'>
<font color=#447700>!<a name='1722'></font>
      ENDDO<a name='1723'>
<font color=#447700>!<a name='1724'></font>
#endif<a name='1725'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1726'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1727'></font>
<font color=#447700>!$omp&amp; private(d2pqe,d2pqq,d2pqw,destij,dqstij,dvolp,dwstij             &amp;<a name='1728'></font>
<font color=#447700>!$omp&amp;        ,e00,e0q,e2ij,ep0,estij,hafp,hafq,i,j,k                   &amp;<a name='1729'></font>
<font color=#447700>!$omp&amp;        ,q00,q0q,q1ij,qp0,qstij,w00,w0q,w1ij,wp0,wstij)<a name='1730'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1731'></font>
<font color=#447700>!<a name='1732'></font>
      vertical_2: DO K=KTS,KTE<a name='1733'>
<font color=#447700>!<a name='1734'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1735'></font>
<font color=#447700>!<a name='1736'></font>
        DO J=MYJS2,MYJE2<a name='1737'>
        DO I=MYIS1,MYIE1<a name='1738'>
<font color=#447700>!<a name='1739'></font>
          DVOLP=DVOL(I,J,K)<a name='1740'>
          Q1IJ =Q1(I,J,K)<a name='1741'>
          W1IJ =W1(I,J,K)<a name='1742'>
          E2IJ =E2(I,J,K)<a name='1743'>
<font color=#447700>!<a name='1744'></font>
          HAFP=AFP(I,J,K)<a name='1745'>
          HAFQ=AFQ(I,J,K)<a name='1746'>
<font color=#447700>!<a name='1747'></font>
          D2PQQ=(Q1(IFPA(I,J,K),JFPA(I,J,K),K)-Q1IJ                     &amp;<a name='1748'>
     &amp;          -Q1IJ+Q1(IFPF(I,J,K),JFPF(I,J,K),K))                    &amp;<a name='1749'>
     &amp;          *HAFP                                                   &amp;<a name='1750'>
     &amp;         +(Q1(IFQA(I,J,K),JFQA(I,J,K),K)-Q1IJ                     &amp;<a name='1751'>
     &amp;          -Q1IJ+Q1(IFQF(I,J,K),JFQF(I,J,K),K))                    &amp;<a name='1752'>
     &amp;          *HAFQ<a name='1753'>
<font color=#447700>!<a name='1754'></font>
          D2PQW=(W1(IFPA(I,J,K),JFPA(I,J,K),K)-W1IJ                     &amp;<a name='1755'>
     &amp;          -W1IJ+W1(IFPF(I,J,K),JFPF(I,J,K),K))                    &amp;<a name='1756'>
     &amp;          *HAFP                                                   &amp;<a name='1757'>
     &amp;         +(W1(IFQA(I,J,K),JFQA(I,J,K),K)-W1IJ                     &amp;<a name='1758'>
     &amp;          -W1IJ+W1(IFQF(I,J,K),JFQF(I,J,K),K))                    &amp;<a name='1759'>
     &amp;          *HAFQ<a name='1760'>
<font color=#447700>!<a name='1761'></font>
         if( advect_Q2) then<a name='1762'>
          D2PQE=(E2(IFPA(I,J,K),JFPA(I,J,K),K)-E2IJ                     &amp;<a name='1763'>
     &amp;          -E2IJ+E2(IFPF(I,J,K),JFPF(I,J,K),K))                    &amp;<a name='1764'>
     &amp;          *HAFP                                                   &amp;<a name='1765'>
     &amp;         +(E2(IFQA(I,J,K),JFQA(I,J,K),K)-E2IJ                     &amp;<a name='1766'>
     &amp;          -E2IJ+E2(IFQF(I,J,K),JFQF(I,J,K),K))                    &amp;<a name='1767'>
     &amp;          *HAFQ<a name='1768'>
         endif<a name='1769'>
<font color=#447700>!<a name='1770'></font>
          QSTIJ=Q1IJ-D2PQQ<a name='1771'>
          WSTIJ=W1IJ-D2PQW<a name='1772'>
          if(advect_q2) ESTIJ=E2IJ-D2PQE<a name='1773'>
<font color=#447700>!<a name='1774'></font>
          Q00=Q  (I          ,J          ,K)<a name='1775'>
          QP0=Q  (IFPA(I,J,K),JFPA(I,J,K),K)<a name='1776'>
          Q0Q=Q  (IFQA(I,J,K),JFQA(I,J,K),K)<a name='1777'>
<font color=#447700>!<a name='1778'></font>
          W00=CWM(I          ,J          ,K)<a name='1779'>
          WP0=CWM(IFPA(I,J,K),JFPA(I,J,K),K)<a name='1780'>
          W0Q=CWM(IFQA(I,J,K),JFQA(I,J,K),K)<a name='1781'>
<font color=#447700>!<a name='1782'></font>
         if(advect_Q2) then<a name='1783'>
          E00=E1 (I          ,J          ,K)<a name='1784'>
          EP0=E1 (IFPA(I,J,K),JFPA(I,J,K),K)<a name='1785'>
          E0Q=E1 (IFQA(I,J,K),JFQA(I,J,K),K)<a name='1786'>
         endif<a name='1787'>
<font color=#447700>!<a name='1788'></font>
          QSTIJ=MAX(QSTIJ,MIN(Q00,QP0,Q0Q))<a name='1789'>
          QSTIJ=MIN(QSTIJ,MAX(Q00,QP0,Q0Q))<a name='1790'>
          WSTIJ=MAX(WSTIJ,MIN(W00,WP0,W0Q))<a name='1791'>
          WSTIJ=MIN(WSTIJ,MAX(W00,WP0,W0Q))<a name='1792'>
         if(advect_Q2) then<a name='1793'>
          ESTIJ=MAX(ESTIJ,MIN(E00,EP0,E0Q))<a name='1794'>
          ESTIJ=MIN(ESTIJ,MAX(E00,EP0,E0Q))<a name='1795'>
         endif<a name='1796'>
<font color=#447700>!<a name='1797'></font>
<font color=#447700>!          DQSTIJ=QSTIJ-Q(I,J,K)<a name='1798'></font>
<font color=#447700>!          DWSTIJ=WSTIJ-CWM(I,J,K)<a name='1799'></font>
<font color=#447700>!          DESTIJ=ESTIJ-E1(I,J,K)<a name='1800'></font>
<font color=#447700>!<a name='1801'></font>
          dqstij=qstij-q1(i,j,k)<a name='1802'>
          dwstij=wstij-w1(i,j,k)<a name='1803'>
          if(advect_Q2) destij=estij-e2(i,j,k)<a name='1804'>
<font color=#447700>!<a name='1805'></font>
          DQST(I,J,K)=DQSTIJ<a name='1806'>
          DWST(I,J,K)=DWSTIJ<a name='1807'>
          if(advect_Q2) DEST(I,J,K)=DESTIJ<a name='1808'>
<font color=#447700>!<a name='1809'></font>
          DQSTIJ=DQSTIJ*DVOLP<a name='1810'>
          DWSTIJ=DWSTIJ*DVOLP<a name='1811'>
          if(advect_Q2) DESTIJ=DESTIJ*DVOLP<a name='1812'>
<font color=#447700>!<a name='1813'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1814'></font>
#if defined(BIT_FOR_BIT) &amp;&amp; defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='1815'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1816'></font>
          DO N=1,6<a name='1817'>
            XSUMS_L(I,J,K,N)=0.<a name='1818'>
          ENDDO<a name='1819'>
<font color=#447700>!<a name='1820'></font>
          IF(DQSTIJ&gt;0.)THEN<a name='1821'>
            XSUMS_L(I,J,K,1)=DQSTIJ<a name='1822'>
          ELSE<a name='1823'>
            XSUMS_L(I,J,K,2)=DQSTIJ<a name='1824'>
          ENDIF<a name='1825'>
<font color=#447700>!<a name='1826'></font>
          IF(DWSTIJ&gt;0.)THEN<a name='1827'>
            XSUMS_L(I,J,K,3)=DWSTIJ<a name='1828'>
          ELSE<a name='1829'>
            XSUMS_L(I,J,K,4)=DWSTIJ<a name='1830'>
          ENDIF<a name='1831'>
<font color=#447700>!<a name='1832'></font>
          if(advect_q2) then<a name='1833'>
             IF(DESTIJ&gt;0.)THEN<a name='1834'>
                XSUMS_L(I,J,K,5)=DESTIJ<a name='1835'>
             ELSE<a name='1836'>
                XSUMS_L(I,J,K,6)=DESTIJ<a name='1837'>
             ENDIF<a name='1838'>
          endif<a name='1839'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1840'></font>
#else<a name='1841'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1842'></font>
          IF(DQSTIJ&gt;0.)THEN<a name='1843'>
            XSUMS(1,K)=XSUMS(1,K)+DQSTIJ<a name='1844'>
          ELSE<a name='1845'>
            XSUMS(2,K)=XSUMS(2,K)+DQSTIJ<a name='1846'>
          ENDIF<a name='1847'>
<font color=#447700>!<a name='1848'></font>
          IF(DWSTIJ&gt;0.)THEN<a name='1849'>
            XSUMS(3,K)=XSUMS(3,K)+DWSTIJ<a name='1850'>
          ELSE<a name='1851'>
            XSUMS(4,K)=XSUMS(4,K)+DWSTIJ<a name='1852'>
          ENDIF<a name='1853'>
<font color=#447700>!<a name='1854'></font>
          if(advect_q2) then<a name='1855'>
             IF(DESTIJ&gt;0.)THEN<a name='1856'>
                XSUMS(5,K)=XSUMS(5,K)+DESTIJ<a name='1857'>
             ELSE<a name='1858'>
                XSUMS(6,K)=XSUMS(6,K)+DESTIJ<a name='1859'>
             ENDIF<a name='1860'>
          endif<a name='1861'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1862'></font>
#endif<a name='1863'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1864'></font>
<font color=#447700>!<a name='1865'></font>
        ENDDO<a name='1866'>
        ENDDO<a name='1867'>
<font color=#447700>!<a name='1868'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1869'></font>
<font color=#447700>!<a name='1870'></font>
      ENDDO vertical_2<a name='1871'>
<font color=#447700>!<a name='1872'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1873'></font>
#if defined(BIT_FOR_BIT) &amp;&amp; defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='1874'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1875'></font>
      DO N=1,6<a name='1876'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>WRF_PATCH_TO_GLOBAL_REAL</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_5">(XSUMS_L(IMS,JMS,KMS,N)            &amp;<a name='1877'>
     &amp;,                               XSUMS_G(1,1,1,N),DOMDESC          &amp; <a name='1878'>
     &amp;,                              'xyz','xyz'                        &amp;<a name='1879'>
     &amp;,                               IDS,IDE,JDS,JDE,KDS,KDE           &amp;    <a name='1880'>
     &amp;,                               IMS,IME,JMS,JME,KMS,KME           &amp;<a name='1881'>
     &amp;,                               ITS,ITE,JTS,JTE,KTS,KTE)<a name='1882'>
      ENDDO<a name='1883'>
<font color=#447700>!<a name='1884'></font>
      DO K=KTS,KTE<a name='1885'>
        DO N=1,6<a name='1886'>
          GSUMS(N,K)=0.<a name='1887'>
        ENDDO<a name='1888'>
      ENDDO<a name='1889'>
<font color=#447700>!<a name='1890'></font>
      IF(WRF_DM_ON_MONITOR())THEN<a name='1891'>
        DO N=1,6<a name='1892'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1893'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1894'></font>
          DO K=KTS,KTE<a name='1895'>
          DO J=JDS,JDE<a name='1896'>
          DO I=IDS,IDE<a name='1897'>
            GSUMS(N,K)=GSUMS(N,K)+XSUMS_G(I,J,K,N)<a name='1898'>
          ENDDO<a name='1899'>
          ENDDO<a name='1900'>
          ENDDO<a name='1901'>
        ENDDO<a name='1902'>
      ENDIF<a name='1903'>
<a name='1904'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>WRF_DM_BCAST_BYTES</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_3">(GSUMS,2*RWORDSIZE*6*(KTE-KTS+1) )<a name='1905'>
<a name='1906'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1907'></font>
#else<a name='1908'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1909'></font>
<font color=#447700>!<a name='1910'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1911'></font>
<font color=#447700>!***  GLOBAL REDUCTION<a name='1912'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1913'></font>
<font color=#447700>!<a name='1914'></font>
# if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='1915'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>WRF_GET_DM_COMMUNICATOR</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_2">(MPI_COMM_COMP)<a name='1916'>
      CALL MPI_ALLREDUCE(XSUMS,GSUMS,6*(KTE-KTS+1)                      &amp;<a name='1917'>
     &amp;                  ,MPI_DOUBLE_PRECISION,MPI_SUM                   &amp;<a name='1918'>
     &amp;                  ,MPI_COMM_COMP,IRECV)<a name='1919'>
# else<a name='1920'>
      DO K=KTS,KTE<a name='1921'>
        DO N=1,6<a name='1922'>
          GSUMS(N,K)=XSUMS(N,K)<a name='1923'>
        ENDDO<a name='1924'>
      ENDDO<a name='1925'>
# endif<a name='1926'>
<font color=#447700>!<a name='1927'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1928'></font>
#endif<a name='1929'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1930'></font>
<font color=#447700>!<a name='1931'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1932'></font>
<font color=#447700>!***  END OF GLOBAL REDUCTION<a name='1933'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1934'></font>
<font color=#447700>!<a name='1935'></font>
<font color=#447700>!     if(mype==0)then<a name='1936'></font>
<font color=#447700>!!!     if(ntsd==0)then<a name='1937'></font>
<font color=#447700>!!!       call int_get_fresh_handle(nunit)<a name='1938'></font>
<font color=#447700>!!!       close(nunit)<a name='1939'></font>
<font color=#447700>!         nunit=56<a name='1940'></font>
<font color=#447700>!!!       open(unit=nunit,file='gsums',form='unformatted',iostat=ier)<a name='1941'></font>
<font color=#447700>!!!     endif<a name='1942'></font>
<font color=#447700>!     endif<a name='1943'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1944'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1945'></font>
<font color=#447700>!$omp&amp; private(destij,dqstij,dwstij,i,j,k,rface,rfacq,rfacw             &amp;<a name='1946'></font>
<font color=#447700>!$omp&amp;        ,rfeij,rfqij,rfwij,sumne,sumnq,sumnw,sumpe,sumpq,sumpw)<a name='1947'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1948'></font>
<font color=#447700>!<a name='1949'></font>
      vertical_3: DO K=KTS,KTE<a name='1950'>
<font color=#447700>!<a name='1951'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1952'></font>
<font color=#447700>!       if(mype==0)then<a name='1953'></font>
<font color=#447700>!         write(nunit)(gsums(i,k),i=1,6)<a name='1954'></font>
<font color=#447700>!       endif<a name='1955'></font>
<font color=#447700>!!!     read(nunit)(gsums(i,k),i=1,6)<a name='1956'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1957'></font>
<font color=#447700>!<a name='1958'></font>
        SUMPQ=GSUMS(1,K)<a name='1959'>
        SUMNQ=GSUMS(2,K)<a name='1960'>
        SUMPW=GSUMS(3,K)<a name='1961'>
        SUMNW=GSUMS(4,K)<a name='1962'>
        SUMPE=GSUMS(5,K)<a name='1963'>
        SUMNE=GSUMS(6,K)<a name='1964'>
<font color=#447700>!<a name='1965'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1966'></font>
<font color=#447700>!***  FIRST MOMENT CONSERVING FACTOR<a name='1967'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1968'></font>
<font color=#447700>!<a name='1969'></font>
        IF(SUMPQ&gt;1.)THEN<a name='1970'>
          RFACQ=-SUMNQ/SUMPQ<a name='1971'>
        ELSE<a name='1972'>
          RFACQ=1.<a name='1973'>
        ENDIF<a name='1974'>
<font color=#447700>!<a name='1975'></font>
        IF(SUMPW&gt;1.)THEN<a name='1976'>
          RFACW=-SUMNW/SUMPW<a name='1977'>
        ELSE<a name='1978'>
          RFACW=1.<a name='1979'>
        ENDIF<a name='1980'>
<font color=#447700>!<a name='1981'></font>
        IF(SUMPE&gt;1.)THEN<a name='1982'>
          RFACE=-SUMNE/SUMPE<a name='1983'>
        ELSE<a name='1984'>
          RFACE=1.<a name='1985'>
        ENDIF<a name='1986'>
<font color=#447700>!<a name='1987'></font>
        IF(RFACQ&lt;CONSERVE_MIN.OR.RFACQ&gt;CONSERVE_MAX)RFACQ=1.<a name='1988'>
        IF(RFACW&lt;CONSERVE_MIN.OR.RFACW&gt;CONSERVE_MAX)RFACW=1.<a name='1989'>
        IF(RFACE&lt;CONSERVE_MIN.OR.RFACE&gt;CONSERVE_MAX)RFACE=1.<a name='1990'>
<font color=#447700>!<a name='1991'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1992'></font>
<font color=#447700>!       if(mype==0.and.ntsd==181)close(nunit)<a name='1993'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1994'></font>
<font color=#447700>!<a name='1995'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1996'></font>
<font color=#447700>!***  IMPOSE CONSERVATION ON ANTI-FILTERING<a name='1997'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1998'></font>
<font color=#447700>!<a name='1999'></font>
        if(rfacq&lt;1.)then<a name='2000'>
          do j=MYJS2,MYJE2<a name='2001'>
            DO I=MYIS1,MYIE1<a name='2002'>
              DQSTIJ=DQST(I,J,K)<a name='2003'>
              RFQIJ=HBM2(I,J)*(RFACQ-1.)+1.<a name='2004'>
              IF(DQSTIJ&gt;=0.)DQSTIJ=DQSTIJ*RFQIJ<a name='2005'>
              q(i,j,k)=q1(i,j,k)+dqstij<a name='2006'>
            ENDDO<a name='2007'>
          enddo<a name='2008'>
        else<a name='2009'>
          do j=MYJS2,MYJE2<a name='2010'>
            DO I=MYIS1,MYIE1<a name='2011'>
              DQSTIJ=DQST(I,J,K)<a name='2012'>
              RFQIJ=HBM2(I,J)*(RFACQ-1.)+1.<a name='2013'>
              IF(DQSTIJ&lt;0.)DQSTIJ=DQSTIJ/RFQIJ<a name='2014'>
              q(i,j,k)=q1(i,j,k)+dqstij<a name='2015'>
            ENDDO<a name='2016'>
          enddo<a name='2017'>
        endif<a name='2018'>
<font color=#447700>!<a name='2019'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2020'></font>
<font color=#447700>!<a name='2021'></font>
        if(rfacw&lt;1.)then<a name='2022'>
          do j=MYJS2,MYJE2<a name='2023'>
            DO I=MYIS1,MYIE1<a name='2024'>
              DWSTIJ=DWST(I,J,K)<a name='2025'>
              RFWIJ=HBM2(I,J)*(RFACW-1.)+1.<a name='2026'>
              IF(DWSTIJ&gt;=0.)DWSTIJ=DWSTIJ*RFWIJ<a name='2027'>
              cwm(i,j,k)=w1(i,j,k)+dwstij<a name='2028'>
            ENDDO<a name='2029'>
          enddo<a name='2030'>
        else<a name='2031'>
          do j=MYJS2,MYJE2<a name='2032'>
            DO I=MYIS1,MYIE1<a name='2033'>
              DWSTIJ=DWST(I,J,K)<a name='2034'>
              RFWIJ=HBM2(I,J)*(RFACW-1.)+1.<a name='2035'>
              IF(DWSTIJ&lt;0.)DWSTIJ=DWSTIJ/RFWIJ<a name='2036'>
              cwm(i,j,k)=w1(i,j,k)+dwstij<a name='2037'>
            ENDDO<a name='2038'>
          enddo<a name='2039'>
        endif<a name='2040'>
<a name='2041'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2042'></font>
<font color=#447700>!<a name='2043'></font>
       if(advect_Q2) then<a name='2044'>
        if(rface&lt;1.)then<a name='2045'>
          do j=MYJS2,MYJE2<a name='2046'>
            DO I=MYIS1,MYIE1<a name='2047'>
              DESTIJ=DEST(I,J,K)<a name='2048'>
              RFEIJ=HBM2(I,J)*(RFACE-1.)+1.<a name='2049'>
              IF(DESTIJ&gt;=0.)DESTIJ=DESTIJ*RFEIJ<a name='2050'>
              e1(i,j,k)=e2(i,j,k)+destij<a name='2051'>
            ENDDO<a name='2052'>
          enddo<a name='2053'>
        else<a name='2054'>
          do j=MYJS2,MYJE2<a name='2055'>
            DO I=MYIS1,MYIE1<a name='2056'>
              DESTIJ=DEST(I,J,K)<a name='2057'>
              RFEIJ=HBM2(I,J)*(RFACE-1.)+1.<a name='2058'>
              IF(DESTIJ&lt;0.)DESTIJ=DESTIJ/RFEIJ<a name='2059'>
              e1(i,j,k)=e2(i,j,k)+destij<a name='2060'>
            ENDDO<a name='2061'>
          enddo<a name='2062'>
        endif<a name='2063'>
       endif<a name='2064'>
<font color=#447700>!<a name='2065'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2066'></font>
<font color=#447700>!<a name='2067'></font>
        DO J=MYJS,MYJE<a name='2068'>
        DO I=MYIS,MYIE<a name='2069'>
          Q  (I,J,K)=MAX(Q  (I,J,K),EPSQ)<a name='2070'>
          CWM(I,J,K)=MAX(CWM(I,J,K),CLIMIT)<a name='2071'>
        ENDDO<a name='2072'>
        ENDDO<a name='2073'>
<font color=#447700>!<a name='2074'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2075'></font>
<font color=#447700>!<a name='2076'></font>
      ENDDO vertical_3<a name='2077'>
<font color=#447700>!<a name='2078'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2079'></font>
<font color=#447700>!<a name='2080'></font>
    if(advect_Q2) then<a name='2081'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2082'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='2083'></font>
      DO J=MYJS,MYJE<a name='2084'>
      DO I=MYIS,MYIE<a name='2085'>
        Q2(I,J,KTE)=MAX(E1(I,J,KTE)+E1(I,J,KTE)-EPSQ2,EPSQ2)<a name='2086'>
      ENDDO<a name='2087'>
      ENDDO<a name='2088'>
<font color=#447700>!<a name='2089'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2090'></font>
<font color=#447700>!<a name='2091'></font>
      DO K=KTE-1,KTS+1,-1<a name='2092'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2093'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='2094'></font>
        DO J=MYJS,MYJE<a name='2095'>
        DO I=MYIS,MYIE<a name='2096'>
          IF(K&gt;KTS)THEN<a name='2097'>
            Q2(I,J,K)=MAX(E1(I,J,K)+E1(I,J,K)-Q2(I,J,K+1),EPSQ2)<a name='2098'>
          ELSE<a name='2099'>
            Q2(I,J,K)=Q2(I,J,K+1)<a name='2100'>
          ENDIF<a name='2101'>
        ENDDO<a name='2102'>
        ENDDO<a name='2103'>
      ENDDO<a name='2104'>
     endif<a name='2105'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2106'></font>
<font color=#447700>!<a name='2107'></font>
      END SUBROUTINE HAD2<a name='2108'>
<font color=#447700>!<a name='2109'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2110'></font>
<font color=#447700>!***********************************************************************<a name='2111'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2112'></font>
<font color=#447700>! New routines added by Georg Grell to handle advection more like ARW<a name='2113'></font>
<font color=#447700>! core.  Instead of VAD2/HAD2 that advect TKE, specific humidity, and<a name='2114'></font>
<font color=#447700>! condensed water species all in one routine, we call VAD2/HAD2_SCAL<a name='2115'></font>
<font color=#447700>! with multidimensioned arrays to advect each variable.  For purposes<a name='2116'></font>
<font color=#447700>! here, solve_nmm.F calls this routine once for TKE, then again for<a name='2117'></font>
<font color=#447700>! all the species held in the moist array (qv, qc, qi, qr, qs, qg),<a name='2118'></font>
<font color=#447700>! then call again for number concentrations held in scalar array (qni).<a name='2119'></font>
<font color=#447700>! The dummy argument lstart is the starting index of the multidimensioned<a name='2120'></font>
<font color=#447700>! array for starting the advection since the 1st index of moist and<a name='2121'></font>
<font color=#447700>! scalar are actually empty placeholders (and the 2nd element is vapor,<a name='2122'></font>
<font color=#447700>! then qc, etc.)  When calling with single 3D array (like TKE), just<a name='2123'></font>
<font color=#447700>! set NUM_SCAL=1 and lstart=1.  The variable to advect is called SCAL<a name='2124'></font>
<font color=#447700>! herein.<a name='2125'></font>
<font color=#447700>!***********************************************************************<a name='2126'></font>
<A NAME='VAD2_SCAL'><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#VAD2_SCAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2127'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VAD2_SCAL</font>(NTSD,DT,IDTAD,DX,DY                          &amp; <A href='../../call_to/VAD2_SCAL.html' TARGET='index'>3</A><a name='2128'>
     &amp;               ,AETA1,AETA2,DETA1,DETA2,PDSL,PDTOP                &amp;<a name='2129'>
     &amp;               ,HBM2                                              &amp;<a name='2130'>
     &amp;               ,SCAL,PETDT                                        &amp;<a name='2131'>
     &amp;               ,N_IUP_H,N_IUP_V                                   &amp;<a name='2132'>
     &amp;               ,N_IUP_ADH,N_IUP_ADV                               &amp;<a name='2133'>
     &amp;               ,IUP_H,IUP_V,IUP_ADH,IUP_ADV                       &amp;<a name='2134'>
     &amp;               ,IHE,IHW,IVE,IVW                                   &amp;<a name='2135'>
     &amp;               ,NUM_SCAL,LSTART                                   &amp;<a name='2136'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='2137'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='2138'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2139'>
<font color=#447700>!***********************************************************************<a name='2140'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='2141'></font>
<font color=#447700>!                .      .    .<a name='2142'></font>
<font color=#447700>! SUBPROGRAM:    VAD2_SCAL   VERTICAL ADVECTION OF SCALARS<a name='2143'></font>
<font color=#447700>!<a name='2144'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 96-07-19<a name='2145'></font>
<font color=#447700>!            GRELL,PECKHAM   ORG: NOAA/FSL   DATE: 05-02-03<a name='2146'></font>
<font color=#447700>!     <a name='2147'></font>
<font color=#447700>! ABSTRACT:          <a name='2148'></font>
<font color=#447700>!     VAD2_SCAL CALCULATES THE CONTRIBUTION OF THE VERTICAL ADVECTION   <a name='2149'></font>
<font color=#447700>!     TO THE TENDENCIES OF SCALAR SUBSTANCES AND THEN UPDATES           <a name='2150'></font>
<font color=#447700>!     THOSE VARIABLES.  AN ANTI-FILTERING TECHNIQUE IS USED.            <a name='2151'></font>
<font color=#447700>!    <a name='2152'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='2153'></font>
<font color=#447700>!   96-07-19  JANJIC           - ORIGINATOR<a name='2154'></font>
<font color=#447700>!   05-02-03  GRELL,PECKHAM    - MODIFIED FOR SCALARS                   <a name='2155'></font>
<font color=#447700>!    <a name='2156'></font>
<font color=#447700>! USAGE: CALL VAD2_SCAL FROM SUBROUTINE SOLVE_NMM                       <a name='2157'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='2158'></font>
<font color=#447700>!<a name='2159'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST<a name='2160'></font>
<font color=#447700>!                <a name='2161'></font>
<font color=#447700>!   OUTPUT FILES:<a name='2162'></font>
<font color=#447700>!       NONE<a name='2163'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:      <a name='2164'></font>
<font color=#447700>!<a name='2165'></font>
<font color=#447700>!     UNIQUE: NONE<a name='2166'></font>
<font color=#447700>!<a name='2167'></font>
<font color=#447700>!     LIBRARY: NONE<a name='2168'></font>
<font color=#447700>!<a name='2169'></font>
<font color=#447700>! ATTRIBUTES:<a name='2170'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='2171'></font>
<font color=#447700>!   MACHINE : IBM <a name='2172'></font>
<font color=#447700>!$$$<a name='2173'></font>
<font color=#447700>!***********************************************************************<a name='2174'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2175'></font>
<font color=#447700>!<a name='2176'></font>
      IMPLICIT NONE<a name='2177'>
<font color=#447700>!<a name='2178'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2179'></font>
<font color=#447700>!<a name='2180'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='2181'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='2182'>
                           ,ITS,ITE,JTS,JTE,KTS,KTE<a name='2183'>
<font color=#447700>!<a name='2184'></font>
      INTEGER,INTENT(IN) :: LSTART,NUM_SCAL<a name='2185'>
<font color=#447700>!<a name='2186'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='2187'>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: N_IUP_H,N_IUP_V          &amp;<a name='2188'>
     &amp;                                        ,N_IUP_ADH,N_IUP_ADV<a name='2189'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IUP_H,IUP_V      &amp;<a name='2190'>
     &amp;                                                ,IUP_ADH,IUP_ADV<a name='2191'>
<font color=#447700>!<a name='2192'></font>
      INTEGER,INTENT(IN) :: IDTAD,NTSD<a name='2193'>
<font color=#447700>!<a name='2194'></font>
      REAL,INTENT(IN) :: DT,DY,PDTOP<a name='2195'>
<font color=#447700>!<a name='2196'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: AETA1,AETA2,DETA1,DETA2<a name='2197'>
<font color=#447700>!<a name='2198'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DX,HBM2,PDSL<a name='2199'>
<font color=#447700>!<a name='2200'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PETDT<a name='2201'>
<font color=#447700>!<a name='2202'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,1:NUM_SCAL)               &amp;<a name='2203'>
                                                 ,INTENT(INOUT) :: SCAL<a name='2204'>
<font color=#447700>!<a name='2205'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2206'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='2207'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2208'></font>
<font color=#447700>!<a name='2209'></font>
      REAL,PARAMETER :: FF1=0.500<a name='2210'>
<font color=#447700>!<a name='2211'></font>
      LOGICAL,SAVE :: TRADITIONAL=.TRUE.<a name='2212'>
<font color=#447700>!<a name='2213'></font>
      INTEGER :: I,IRECV,J,JFP,JFQ,K,L,LAP,LLAP<a name='2214'>
<font color=#447700>!<a name='2215'></font>
      INTEGER,DIMENSION(KTS:KTE) :: LA<a name='2216'>
<font color=#447700>!<a name='2217'></font>
      REAL*8 :: ADDT,AFRP,D2PQQ,DETAP,DPDN,DPUP,DQP                     &amp;<a name='2218'>
     &amp;         ,HADDT,HBM2IJ                                            &amp;<a name='2219'>
     &amp;         ,Q00,Q4P,QP,QP0                                          &amp;<a name='2220'>
     &amp;         ,RFACQK,RFC,RR                                           &amp;<a name='2221'>
     &amp;         ,SUMNQ,SUMPQ<a name='2222'>
<font color=#447700>!<a name='2223'></font>
      REAL :: SFACQK<a name='2224'>
<font color=#447700>!<a name='2225'></font>
      REAL,DIMENSION(KTS:KTE) :: AFR,DEL,DQL,DWL,E3,E4,PETDTK           &amp;<a name='2226'>
     &amp;                          ,RFACE,RFACQ,RFACW,Q3,Q4,W3,W4<a name='2227'>
<font color=#447700>!<a name='2228'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2229'></font>
<font color=#447700>!***********************************************************************<a name='2230'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2231'></font>
<font color=#447700>!<a name='2232'></font>
      ADDT=REAL(IDTAD)*DT<a name='2233'>
<font color=#447700>!<a name='2234'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2235'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2236'></font>
<font color=#447700>!$omp&amp; private(afr,afrp,d2pqq,detap,dpdn,dpup                           &amp;<a name='2237'></font>
<font color=#447700>!$omp&amp;        ,dql,dqp,haddt,i,j,k                                      &amp;<a name='2238'></font>
<font color=#447700>!$omp&amp;        ,la,lap,llap,petdtk,q00,q3,q4,q4p,qp,qp0,rfacqk           &amp;<a name='2239'></font>
<font color=#447700>!$omp&amp;        ,rfc,rr,sfacqk,sumnq,sumpq)<a name='2240'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2241'></font>
<font color=#447700>!<a name='2242'></font>
      scalar_loop: DO L=LSTART,NUM_SCAL<a name='2243'>
<font color=#447700>!<a name='2244'></font>
      main_integration: DO J=MYJS2,MYJE2<a name='2245'>
<font color=#447700>!<a name='2246'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2247'></font>
<font color=#447700>!<a name='2248'></font>
        main_iloop: DO I=MYIS1_P1,MYIE1_P1<a name='2249'>
<font color=#447700>!<a name='2250'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2251'></font>
<font color=#447700>!<a name='2252'></font>
          DO K=KTS,KTE<a name='2253'>
            Q3(K)=SCAL(I,J,K,L)<a name='2254'>
            Q4(K)=Q3(K)<a name='2255'>
          ENDDO<a name='2256'>
<font color=#447700>!<a name='2257'></font>
          IF(TRADITIONAL)THEN<a name='2258'>
            PETDTK(KTE)=PETDT(I,J,KTE-1)*0.5<a name='2259'>
<font color=#447700>!<a name='2260'></font>
            DO K=KTE-1,KTS+1,-1<a name='2261'>
              PETDTK(K)=(PETDT(I,J,K)+PETDT(I,J,K-1))*0.5<a name='2262'>
            ENDDO<a name='2263'>
<font color=#447700>!<a name='2264'></font>
            PETDTK(KTS)=PETDT(I,J,KTS)*0.5<a name='2265'>
<font color=#447700>!<a name='2266'></font>
          ELSE<a name='2267'>
<font color=#447700>!<a name='2268'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2269'></font>
<font color=#447700>!***    PERFORM HORIZONTAL AVERAGING OF VERTICAL VELOCITY<a name='2270'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2271'></font>
<font color=#447700>!<a name='2272'></font>
            PETDTK(KTE)=(PETDT(I+IHW(J-1),J-1,KTE-1)                    &amp;<a name='2273'>
     &amp;                  +PETDT(I+IHE(J-1),J-1,KTE-1)                    &amp;<a name='2274'>
     &amp;                  +PETDT(I+IHW(J+1),J+1,KTE-1)                    &amp;<a name='2275'>
     &amp;                  +PETDT(I+IHE(J+1),J+1,KTE-1)                    &amp;<a name='2276'>
     &amp;                  +PETDT(I,J,KTE-1)*4.        )*0.0625<a name='2277'>
<font color=#447700>!<a name='2278'></font>
            DO K=KTE-1,KTS+1,-1<a name='2279'>
              PETDTK(K)=(PETDT(I+IHW(J-1),J-1,K-1)                      &amp;<a name='2280'>
                        +PETDT(I+IHE(J-1),J-1,K-1)                      &amp;<a name='2281'>
     &amp;                  +PETDT(I+IHW(J+1),J+1,K-1)                      &amp;<a name='2282'>
     &amp;                  +PETDT(I+IHE(J+1),J+1,K-1)                      &amp;<a name='2283'>
     &amp;                  +PETDT(I+IHW(J-1),J-1,K  )                      &amp;<a name='2284'>
     &amp;                  +PETDT(I+IHE(J-1),J-1,K  )                      &amp;<a name='2285'>
     &amp;                  +PETDT(I+IHW(J+1),J+1,K  )                      &amp;<a name='2286'>
     &amp;                  +PETDT(I+IHE(J+1),J+1,K  )                      &amp;<a name='2287'>
     &amp;                  +(PETDT(I,J,K-1)+PETDT(I,J,K))*4.               &amp;<a name='2288'>
     &amp;                                                   )*0.0625<a name='2289'>
            ENDDO<a name='2290'>
<font color=#447700>!<a name='2291'></font>
            PETDTK(KTS)=(PETDT(I+IHW(J-1),J-1,KTS)                      &amp;<a name='2292'>
     &amp;                  +PETDT(I+IHE(J-1),J-1,KTS)                      &amp;<a name='2293'>
     &amp;                  +PETDT(I+IHW(J+1),J+1,KTS)                      &amp;<a name='2294'>
     &amp;                  +PETDT(I+IHE(J+1),J+1,KTS)                      &amp;<a name='2295'>
     &amp;                  +PETDT(I,J,KTS)*4.        )*0.0625<a name='2296'>
 <a name='2297'>
          ENDIF<a name='2298'>
<font color=#447700>!<a name='2299'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2300'></font>
<font color=#447700>!<a name='2301'></font>
          HADDT=-ADDT*HBM2(I,J)<a name='2302'>
<font color=#447700>!<a name='2303'></font>
          DO K=KTE,KTS,-1<a name='2304'>
            RR=PETDTK(K)*HADDT<a name='2305'>
<font color=#447700>!<a name='2306'></font>
            IF(RR&lt;0.)THEN<a name='2307'>
              LAP=1<a name='2308'>
            ELSE<a name='2309'>
              LAP=-1<a name='2310'>
            ENDIF<a name='2311'>
<font color=#447700>!<a name='2312'></font>
            LA(K)=LAP<a name='2313'>
            LLAP=K+LAP<a name='2314'>
<font color=#447700>!<a name='2315'></font>
            IF(LLAP&gt;KTS-1.AND.LLAP&lt;KTE+1)THEN<a name='2316'>
              RR=ABS(RR/((AETA1(LLAP)-AETA1(K))*PDTOP                   &amp;<a name='2317'>
     &amp;                  +(AETA2(LLAP)-AETA2(K))*PDSL(I,J)))<a name='2318'>
              IF(RR&gt;0.9)RR=0.9<a name='2319'>
<font color=#447700>!<a name='2320'></font>
              AFR(K)=(((FF4*RR+FF3)*RR+FF2)*RR+FF1)*RR<a name='2321'>
              DQP=(Q3(LLAP)-Q3(K))*RR<a name='2322'>
              DQL(K)=DQP<a name='2323'>
            ELSE<a name='2324'>
              RR=0.<a name='2325'>
              AFR(K)=0.<a name='2326'>
              DQL(K)=0.<a name='2327'>
            ENDIF<a name='2328'>
          ENDDO<a name='2329'>
<font color=#447700>!<a name='2330'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2331'></font>
<font color=#447700>!<a name='2332'></font>
          IF(LA(KTE-1)&gt;0)THEN<a name='2333'>
            RFC=(DETA1(KTE-1)*PDTOP+DETA2(KTE-1)*PDSL(I,J))             &amp;<a name='2334'>
     &amp;         /(DETA1(KTE  )*PDTOP+DETA2(KTE  )*PDSL(I,J))<a name='2335'>
            DQL(KTE)=-DQL(KTE-1)*RFC<a name='2336'>
          ENDIF<a name='2337'>
<font color=#447700>!<a name='2338'></font>
          IF(LA(KTS+1)&lt;0)THEN<a name='2339'>
            RFC=(DETA1(KTS+1)*PDTOP+DETA2(KTS+1)*PDSL(I,J))           &amp;<a name='2340'>
     &amp;         /(DETA1(KTS  )*PDTOP+DETA2(KTS  )*PDSL(I,J))<a name='2341'>
            DQL(KTS)=-DQL(KTS+1)*RFC<a name='2342'>
          ENDIF<a name='2343'>
<font color=#447700>!<a name='2344'></font>
          DO K=KTS,KTE<a name='2345'>
            Q4(K)=Q3(K)+DQL(K)<a name='2346'>
          ENDDO<a name='2347'>
<font color=#447700>!<a name='2348'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2349'></font>
<font color=#447700>!***  ANTI-FILTERING STEP<a name='2350'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2351'></font>
<font color=#447700>!<a name='2352'></font>
          SUMPQ=0.<a name='2353'>
          SUMNQ=0.<a name='2354'>
<font color=#447700>!<a name='2355'></font>
<font color=#447700>!***  ANTI-FILTERING LIMITERS<a name='2356'></font>
<font color=#447700>!<a name='2357'></font>
          antifilter: DO K=KTE-1,KTS+1,-1<a name='2358'>
<font color=#447700>!<a name='2359'></font>
            DETAP=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='2360'>
<font color=#447700>!<a name='2361'></font>
            Q4P=Q4(K)<a name='2362'>
<font color=#447700>!<a name='2363'></font>
            LAP=LA(K)<a name='2364'>
<font color=#447700>!<a name='2365'></font>
            DPDN=(AETA1(K+LAP)-AETA1(K))*PDTOP                          &amp;<a name='2366'>
     &amp;          +(AETA2(K+LAP)-AETA2(K))*PDSL(I,J)<a name='2367'>
            DPUP=(AETA1(K)-AETA1(K-LAP))*PDTOP                          &amp;<a name='2368'>
     &amp;          +(AETA2(K)-AETA2(K-LAP))*PDSL(I,J)<a name='2369'>
<font color=#447700>!<a name='2370'></font>
            AFRP=2.*AFR(K)*DPDN*DPDN/(DPDN+DPUP)<a name='2371'>
            D2PQQ=((Q4(K+LAP)-Q4P)/DPDN                                 &amp;<a name='2372'>
     &amp;            -(Q4P-Q4(K-LAP))/DPUP)*AFRP<a name='2373'>
<font color=#447700>!<a name='2374'></font>
            QP=Q4P-D2PQQ<a name='2375'>
<font color=#447700>!<a name='2376'></font>
            Q00=Q3(K)<a name='2377'>
            QP0=Q3(K+LAP)<a name='2378'>
<font color=#447700>!<a name='2379'></font>
            QP=MAX(QP,MIN(Q00,QP0))<a name='2380'>
            QP=MIN(QP,MAX(Q00,QP0))<a name='2381'>
<font color=#447700>!<a name='2382'></font>
            DQP=QP-Q00<a name='2383'>
<font color=#447700>!<a name='2384'></font>
            DQL(K)=DQP<a name='2385'>
<font color=#447700>!<a name='2386'></font>
          ENDDO antifilter<a name='2387'>
<font color=#447700>!<a name='2388'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2389'></font>
<font color=#447700>!<a name='2390'></font>
          IF(LA(KTE-1)&gt;0)THEN<a name='2391'>
            RFC=(DETA1(KTE-1)*PDTOP+DETA2(KTE-1)*PDSL(I,J))             &amp;<a name='2392'>
     &amp;         /(DETA1(KTE  )*PDTOP+DETA2(KTE  )*PDSL(I,J))<a name='2393'>
            DQL(KTE)=-DQL(KTE-1)*RFC+DQL(KTE)<a name='2394'>
          ENDIF<a name='2395'>
<font color=#447700>!<a name='2396'></font>
          IF(LA(KTS+1)&lt;0)THEN<a name='2397'>
            RFC=(DETA1(KTS+1)*PDTOP+DETA2(KTS+1)*PDSL(I,J))             &amp;<a name='2398'>
     &amp;         /(DETA1(KTS  )*PDTOP+DETA2(KTS  )*PDSL(I,J))<a name='2399'>
            DQL(KTS)=-DQL(KTS+1)*RFC+DQL(KTS)<a name='2400'>
          ENDIF<a name='2401'>
<font color=#447700>!<a name='2402'></font>
          DO K=KTS,KTE<a name='2403'>
            DETAP=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='2404'>
            DQP=DQL(K)*DETAP<a name='2405'>
<font color=#447700>!<a name='2406'></font>
            IF(DQP&gt;0.)THEN<a name='2407'>
              SUMPQ=SUMPQ+DQP<a name='2408'>
            ELSE<a name='2409'>
              SUMNQ=SUMNQ+DQP<a name='2410'>
            ENDIF<a name='2411'>
          ENDDO<a name='2412'>
<font color=#447700>!<a name='2413'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2414'></font>
<font color=#447700>!***  FIRST MOMENT CONSERVING FACTOR<a name='2415'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2416'></font>
<font color=#447700>!<a name='2417'></font>
          IF(SUMPQ&gt;1.E-9)THEN<a name='2418'>
            SFACQK=-SUMNQ/SUMPQ<a name='2419'>
          ELSE<a name='2420'>
            SFACQK=1.<a name='2421'>
          ENDIF<a name='2422'>
<font color=#447700>!<a name='2423'></font>
          IF(SFACQK&lt;CONSERVE_MIN.OR.SFACQK&gt;CONSERVE_MAX)SFACQK=1.<a name='2424'>
<font color=#447700>!<a name='2425'></font>
          RFACQK=1./SFACQK<a name='2426'>
<font color=#447700>!<a name='2427'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2428'></font>
<font color=#447700>!***  IMPOSE CONSERVATION ON ANTI-FILTERING<a name='2429'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2430'></font>
<font color=#447700>!<a name='2431'></font>
          DO K=KTE,KTS,-1<a name='2432'>
            DQP=DQL(K)<a name='2433'>
            IF(SFACQK&gt;=1.)THEN<a name='2434'>
              IF(DQP&lt;0.)DQP=DQP*RFACQK<a name='2435'>
            ELSE<a name='2436'>
              IF(DQP&gt;0.)DQP=DQP*SFACQK<a name='2437'>
            ENDIF<a name='2438'>
            SCAL(I,J,K,L)=Q3(K)+DQP<a name='2439'>
          ENDDO<a name='2440'>
<font color=#447700>!<a name='2441'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2442'></font>
<font color=#447700>!<a name='2443'></font>
        ENDDO main_iloop<a name='2444'>
<font color=#447700>!<a name='2445'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2446'></font>
<font color=#447700>!<a name='2447'></font>
      ENDDO main_integration<a name='2448'>
<font color=#447700>!<a name='2449'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2450'></font>
<font color=#447700>!<a name='2451'></font>
      ENDDO scalar_loop<a name='2452'>
<font color=#447700>!<a name='2453'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2454'></font>
<font color=#447700>!<a name='2455'></font>
      END SUBROUTINE VAD2_SCAL<a name='2456'>
<font color=#447700>!<a name='2457'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2458'></font>
<font color=#447700>!         <a name='2459'></font>
<font color=#447700>!***********************************************************************<a name='2460'></font>
<A NAME='HAD2_SCAL'><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2_SCAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2461'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>HAD2_SCAL</font>(                                             &amp; <A href='../../call_to/HAD2_SCAL.html' TARGET='index'>3</A>,<A href='../../call_from/HAD2_SCAL.html' TARGET='index'>3</A><a name='2462'>
#if defined(DM_PARALLEL)<a name='2463'>
     &amp;                DOMDESC ,                                         &amp;<a name='2464'>
#endif  <a name='2465'>
     &amp;                NTSD,DT,IDTAD,DX,DY                               &amp;<a name='2466'>
     &amp;               ,AETA1,AETA2,DETA1,DETA2,PDSL,PDTOP                &amp;<a name='2467'>
     &amp;               ,HBM2,HBM3                                         &amp;<a name='2468'>
     &amp;               ,SCAL,U,V,Z,HYDRO                                  &amp;<a name='2469'>
     &amp;               ,N_IUP_H,N_IUP_V                                   &amp;<a name='2470'>
     &amp;               ,N_IUP_ADH,N_IUP_ADV                               &amp;<a name='2471'>
     &amp;               ,IUP_H,IUP_V,IUP_ADH,IUP_ADV                       &amp;<a name='2472'>
     &amp;               ,IHE,IHW,IVE,IVW                                   &amp;<a name='2473'>
     &amp;               ,NUM_SCAL,LSTART                                   &amp;<a name='2474'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='2475'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='2476'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2477'>
<font color=#447700>!***********************************************************************<a name='2478'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='2479'></font>
<font color=#447700>!                .      .    .<a name='2480'></font>
<font color=#447700>! SUBPROGRAM:    HAD2_SCAL   HORIZONTAL ADVECTION OF SCALAR<a name='2481'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 96-07-19<a name='2482'></font>
<font color=#447700>!            GRELL,PECKHAM   ORG: NOAA/FSL   DATE: 05-02-03<a name='2483'></font>
<font color=#447700>!<a name='2484'></font>
<font color=#447700>! ABSTRACT:<a name='2485'></font>
<font color=#447700>!     HAD2_SCAL CALCULATES THE CONTRIBUTION OF THE HORIZONTAL ADVECTION<a name='2486'></font>
<font color=#447700>!     TO THE TENDENCIES OF SCALAR SUBSTANCES AND THEN<a name='2487'></font>
<font color=#447700>!     UPDATES THOSE VARIABLES.  AN ANTI-FILTERING TECHNIQUE IS USED.<a name='2488'></font>
<font color=#447700>!<a name='2489'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='2490'></font>
<font color=#447700>!   96-07-19  JANJIC           - ORIGINATOR<a name='2491'></font>
<font color=#447700>!   05-01-03  GRELL,PECKHAM    - MODIFIED FOR SCALAR<a name='2492'></font>
<font color=#447700>!<a name='2493'></font>
<font color=#447700>! USAGE: CALL HAD2_SCAL FROM SUBROUTINE SOLVE_NMM<a name='2494'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='2495'></font>
<font color=#447700>!<a name='2496'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST<a name='2497'></font>
<font color=#447700>!<a name='2498'></font>
<font color=#447700>!   OUTPUT FILES:<a name='2499'></font>
<font color=#447700>!       NONE<a name='2500'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='2501'></font>
<font color=#447700>!<a name='2502'></font>
<font color=#447700>!     UNIQUE: NONE<a name='2503'></font>
<font color=#447700>!<a name='2504'></font>
<font color=#447700>!     LIBRARY: NONE<a name='2505'></font>
<font color=#447700>!<a name='2506'></font>
<font color=#447700>! ATTRIBUTES:<a name='2507'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='2508'></font>
<font color=#447700>!   MACHINE : IBM <a name='2509'></font>
<font color=#447700>!$$$<a name='2510'></font>
<font color=#447700>!***********************************************************************<a name='2511'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2512'></font>
<font color=#447700>!    <a name='2513'></font>
      IMPLICIT NONE  <a name='2514'>
<font color=#447700>!    <a name='2515'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2516'></font>
<font color=#447700>!    <a name='2517'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='2518'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='2519'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='2520'>
<font color=#447700>!<a name='2521'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='2522'>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: N_IUP_H,N_IUP_V          &amp;<a name='2523'>
     &amp;                                        ,N_IUP_ADH,N_IUP_ADV<a name='2524'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IUP_H,IUP_V      &amp;<a name='2525'>
     &amp;                                                ,IUP_ADH,IUP_ADV<a name='2526'>
<font color=#447700>!<a name='2527'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2528'></font>
<font color=#447700>!<a name='2529'></font>
      INTEGER,INTENT(IN) :: IDTAD,LSTART,NTSD,NUM_SCAL<a name='2530'>
<font color=#447700>!<a name='2531'></font>
      REAL,INTENT(IN) :: DT,DY,PDTOP<a name='2532'>
<font color=#447700>!<a name='2533'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: AETA1,AETA2,DETA1,DETA2<a name='2534'>
<font color=#447700>!<a name='2535'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DX,HBM2,HBM3,PDSL<a name='2536'>
<font color=#447700>!<a name='2537'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: U,V,Z<a name='2538'>
<font color=#447700>!<a name='2539'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,1:NUM_SCAL)                &amp;<a name='2540'>
                                                  ,INTENT(INOUT) :: SCAL<a name='2541'>
<font color=#447700>!<a name='2542'></font>
      LOGICAL,INTENT(IN) :: HYDRO<a name='2543'>
<font color=#447700>!<a name='2544'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2545'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='2546'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2547'></font>
<font color=#447700>!<a name='2548'></font>
      REAL,PARAMETER :: FF1=0.530<a name='2549'>
<font color=#447700>!<a name='2550'></font>
#ifdef DM_PARALLEL<a name='2551'>
      INTEGER :: DOMDESC<a name='2552'>
#endif<a name='2553'>
<font color=#447700>!<a name='2554'></font>
#if defined(BIT_FOR_BIT) &amp;&amp; defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2555'></font>
      LOGICAL,EXTERNAL :: WRF_DM_ON_MONITOR<a name='2556'>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,2) :: XSUMS_L<a name='2557'>
      REAL,DIMENSION(IDS:IDE,JDS:JDE,KDS:KDE,2) :: XSUMS_G<a name='2558'>
#endif<a name='2559'>
<font color=#447700>!<a name='2560'></font>
      LOGICAL :: BOT,TOP<a name='2561'>
<font color=#447700>!<a name='2562'></font>
      INTEGER :: I,IRECV,J,JFP,JFQ,K,L,LAP,LLAP,MPI_COMM_COMP<a name='2563'>
      INTEGER :: N<a name='2564'>
<font color=#447700>!<a name='2565'></font>
      INTEGER,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5,KTS:KTE) :: IFPA,IFPF   &amp;<a name='2566'>
     &amp;                                                     ,IFQA,IFQF   &amp;<a name='2567'>
     &amp;                                                     ,JFPA,JFPF   &amp;<a name='2568'>
     &amp;                                                     ,JFQA,JFQF<a name='2569'>
<font color=#447700>!<a name='2570'></font>
      REAL :: ADDT,AFRP,CRIT,D2PQE,D2PQQ,D2PQW,DEP,DESTIJ,DQP,DQSTIJ    &amp;<a name='2571'>
     &amp;       ,DVOLP,DWP,DWSTIJ,DZA,DZB,E00,E0Q,E1X,E2IJ,E4P,ENH,EP,EP0  &amp;<a name='2572'>
     &amp;       ,ESTIJ,FPQ,HAFP,HAFQ,HBM2IJ,HM,PP,PPQ00,Q00,Q0Q            &amp;<a name='2573'>
     &amp;       ,Q1IJ,Q4P,QP,QP0,QSTIJ,RDY,RFACE,RFACQ,RFACW,RFC           &amp;<a name='2574'>
     &amp;       ,RFEIJ,RFQIJ,RFWIJ,RR,SLOPAC,SPP,SQP,SSA,SSB,SUMNQ,SUMPQ   &amp;<a name='2575'>
     &amp;       ,TTA,TTB,W00,W0Q,W1IJ,W4P,WP,WP0,WSTIJ<a name='2576'>
<font color=#447700>!<a name='2577'></font>
      DOUBLE PRECISION,DIMENSION(2,KTS:KTE) :: GSUMS,XSUMS<a name='2578'>
<font color=#447700>!<a name='2579'></font>
      REAL,DIMENSION(KTS:KTE) :: AFR,DEL,DQL,DWL,Q3,Q4<a name='2580'>
<font color=#447700>!<a name='2581'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: DARE,EMH<a name='2582'>
<font color=#447700>!<a name='2583'></font>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5,KTS:KTE) :: AFP,AFQ,DEST   &amp;<a name='2584'>
     &amp;                                                  ,DQST,DVOL,DWST &amp;<a name='2585'>
     &amp;                                                  ,Q1<a name='2586'>
<font color=#447700>!<a name='2587'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME) :: Q<a name='2588'>
<font color=#447700>!<a name='2589'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2590'></font>
      integer :: nunit,ier<a name='2591'>
      save nunit<a name='2592'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2593'></font>
<font color=#447700>!***********************************************************************<a name='2594'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2595'></font>
<font color=#447700>!<a name='2596'></font>
      RDY=1./DY<a name='2597'>
      SLOPAC=SLOPHT*SQRT(2.)*0.5*50.<a name='2598'>
      CRIT=SLOPAC*REAL(IDTAD)*DT*RDY*1000.<a name='2599'>
<font color=#447700>!<a name='2600'></font>
      ADDT=REAL(IDTAD)*DT<a name='2601'>
      ENH=ADDT/(08.*DY)<a name='2602'>
<font color=#447700>!<a name='2603'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2604'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2605'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='2606'></font>
      DO J=MYJS_P3,MYJE_P3<a name='2607'>
      DO I=MYIS_P2,MYIE_P2<a name='2608'>
        EMH (I,J)=ADDT/(08.*DX(I,J))<a name='2609'>
        DARE(I,J)=HBM3(I,J)*DX(I,J)*DY<a name='2610'>
      ENDDO<a name='2611'>
      ENDDO<a name='2612'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2613'></font>
<font color=#447700>!<a name='2614'></font>
      scalar_loop: DO L=LSTART,NUM_SCAL<a name='2615'>
<font color=#447700>!<a name='2616'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2617'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2618'></font>
<font color=#447700>!$omp&amp; private(dza,dzb,e1x,fpq,hm,i,j,jfp,jfq,k,pp,qp,ssa,ssb,spp,sqp   &amp;<a name='2619'></font>
<font color=#447700>!$omp&amp;        ,tta,ttb)<a name='2620'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2621'></font>
<font color=#447700>!<a name='2622'></font>
      vertical_1: DO K=KTS,KTE<a name='2623'>
<font color=#447700>!<a name='2624'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2625'></font>
<font color=#447700>!<a name='2626'></font>
        DO J=MYJS_P3,MYJE_P3<a name='2627'>
        DO I=MYIS_P2,MYIE_P2<a name='2628'>
          DVOL(I,J,K)=DARE(I,J)*(DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J))<a name='2629'>
          Q (I,J,K)=SCAL(I,J,K,L)<a name='2630'>
          Q1(I,J,K)=Q(I,J,K)<a name='2631'>
        ENDDO<a name='2632'>
        ENDDO<a name='2633'>
<font color=#447700>!<a name='2634'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2635'></font>
<font color=#447700>!<a name='2636'></font>
        DO J=MYJS2_P1,MYJE2_P1<a name='2637'>
        DO I=MYIS1_P1,MYIE1_P1<a name='2638'>
<font color=#447700>!<a name='2639'></font>
          HM=HBM2(I,J)<a name='2640'>
          TTA=(U(I,J-1,K)+U(I+IHW(J),J,K)+U(I+IHE(J),J,K)+U(I,J+1,K))   &amp;<a name='2641'>
     &amp;        *EMH(I,J)*HM<a name='2642'>
          TTB=(V(I,J-1,K)+V(I+IHW(J),J,K)+V(I+IHE(J),J,K)+V(I,J+1,K))   &amp;<a name='2643'>
     &amp;        *ENH*HBM2(I,J)<a name='2644'>
<font color=#447700>!<a name='2645'></font>
          SPP=-TTA-TTB<a name='2646'>
          SQP= TTA-TTB<a name='2647'>
<font color=#447700>!<a name='2648'></font>
          IF(SPP&lt;0.)THEN<a name='2649'>
            JFP=-1<a name='2650'>
          ELSE<a name='2651'>
            JFP=1<a name='2652'>
          ENDIF<a name='2653'>
          IF(SQP&lt;0.)THEN<a name='2654'>
            JFQ=-1<a name='2655'>
          ELSE<a name='2656'>
            JFQ=1<a name='2657'>
          ENDIF<a name='2658'>
<font color=#447700>!<a name='2659'></font>
          IFPA(I,J,K)=IHE(J)+I+( JFP-1)/2<a name='2660'>
          IFQA(I,J,K)=IHE(J)+I+(-JFQ-1)/2<a name='2661'>
<font color=#447700>!<a name='2662'></font>
          JFPA(I,J,K)=J+JFP<a name='2663'>
          JFQA(I,J,K)=J+JFQ<a name='2664'>
<font color=#447700>!<a name='2665'></font>
          IFPF(I,J,K)=IHE(J)+I+(-JFP-1)/2<a name='2666'>
          IFQF(I,J,K)=IHE(J)+I+( JFQ-1)/2<a name='2667'>
<font color=#447700>!<a name='2668'></font>
          JFPF(I,J,K)=J-JFP<a name='2669'>
          JFQF(I,J,K)=J-JFQ<a name='2670'>
<font color=#447700>!<a name='2671'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2672'></font>
          IF(.NOT.HYDRO)THEN <font color=#447700>! z currently not available for hydro=.true.<a name='2673'></font>
            DZA=(Z(IFPA(I,J,K),JFPA(I,J,K),K)-Z(I,J,K))*RDY<a name='2674'>
            DZB=(Z(IFQA(I,J,K),JFQA(I,J,K),K)-Z(I,J,K))*RDY<a name='2675'>
<font color=#447700>!<a name='2676'></font>
            IF(ABS(DZA)&gt;SLOPAC)THEN<a name='2677'>
              SSA=DZA*SPP<a name='2678'>
              IF(SSA&gt;CRIT)THEN<a name='2679'>
                SPP=0. <font color=#447700>!spp*.1<a name='2680'></font>
              ENDIF<a name='2681'>
            ENDIF<a name='2682'>
<font color=#447700>!<a name='2683'></font>
            IF(ABS(DZB)&gt;SLOPAC)THEN<a name='2684'>
              SSB=DZB*SQP<a name='2685'>
              IF(SSB&gt;CRIT)THEN<a name='2686'>
                SQP=0. <font color=#447700>!sqp*.1<a name='2687'></font>
              ENDIF<a name='2688'>
            ENDIF<a name='2689'>
<font color=#447700>!<a name='2690'></font>
          ENDIF<a name='2691'>
<font color=#447700>!<a name='2692'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2693'></font>
<font color=#447700>!<a name='2694'></font>
          FPQ=SPP*SQP*0.25<a name='2695'>
          PP=ABS(SPP)<a name='2696'>
          QP=ABS(SQP)<a name='2697'>
<font color=#447700>!<a name='2698'></font>
          AFP(I,J,K)=(((FF4*PP+FF3)*PP+FF2)*PP+FF1)*PP<a name='2699'>
          AFQ(I,J,K)=(((FF4*QP+FF3)*QP+FF2)*QP+FF1)*QP<a name='2700'>
<font color=#447700>!<a name='2701'></font>
          Q1(I,J,K)=(Q  (IFPA(I,J,K),JFPA(I,J,K),K)-Q  (I,J,K))*PP        &amp;<a name='2702'>
       &amp;           +(Q  (IFQA(I,J,K),JFQA(I,J,K),K)-Q  (I,J,K))*QP        &amp;<a name='2703'>
       &amp;           +(Q  (I,J-2,K)+Q  (I,J+2,K)                            &amp;<a name='2704'>
       &amp;            -Q  (I-1,J,K)-Q  (I+1,J,K))*FPQ                       &amp;<a name='2705'>
       &amp;           +Q(I,J,K)<a name='2706'>
<font color=#447700>!<a name='2707'></font>
        ENDDO<a name='2708'>
        ENDDO<a name='2709'>
<font color=#447700>!<a name='2710'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2711'></font>
<font color=#447700>!<a name='2712'></font>
      ENDDO vertical_1<a name='2713'>
<font color=#447700>!<a name='2714'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2715'></font>
<font color=#447700>!***  ANTI-FILTERING STEP<a name='2716'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2717'></font>
<font color=#447700>!<a name='2718'></font>
      DO K=KTS,KTE<a name='2719'>
        XSUMS(1,K)=0.<a name='2720'>
        XSUMS(2,K)=0.<a name='2721'>
      ENDDO<a name='2722'>
<font color=#447700>!<a name='2723'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2724'></font>
<font color=#447700>!<a name='2725'></font>
<font color=#447700>!***  ANTI-FILTERING LIMITERS<a name='2726'></font>
<font color=#447700>!<a name='2727'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2728'></font>
#if defined(BIT_FOR_BIT) &amp;&amp; defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2729'></font>
      DO N=1,2<a name='2730'>
<font color=#447700>!<a name='2731'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2732'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2733'></font>
        DO K=KMS,KME <a name='2734'>
        DO J=JMS,JME <a name='2735'>
        DO I=IMS,IME <a name='2736'>
          XSUMS_L(I,J,K,N)=0.<a name='2737'>
        ENDDO<a name='2738'>
        ENDDO<a name='2739'>
        ENDDO<a name='2740'>
<font color=#447700>!<a name='2741'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2742'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2743'></font>
        DO K=KDS,KDE <a name='2744'>
        DO J=JDS,JDE <a name='2745'>
        DO I=IDS,IDE <a name='2746'>
          XSUMS_G(I,J,K,N)=0.<a name='2747'>
        ENDDO<a name='2748'>
        ENDDO<a name='2749'>
        ENDDO<a name='2750'>
<font color=#447700>!<a name='2751'></font>
      ENDDO<a name='2752'>
<font color=#447700>!<a name='2753'></font>
#endif<a name='2754'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2755'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2756'></font>
<font color=#447700>!$omp&amp; private(d2pqe,d2pqq,d2pqw,destij,dqstij,dvolp,dwstij             &amp;<a name='2757'></font>
<font color=#447700>!$omp&amp;        ,e00,e0q,ep0,estij,hafp,hafq,i,j,k                        &amp;<a name='2758'></font>
<font color=#447700>!$omp&amp;        ,q00,q0q,q1ij,qp0,qstij,w00,w0q,wp0,wstij)<a name='2759'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2760'></font>
<font color=#447700>!<a name='2761'></font>
      vertical_2: DO K=KTS,KTE<a name='2762'>
<font color=#447700>!<a name='2763'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2764'></font>
<font color=#447700>!<a name='2765'></font>
        DO J=MYJS2,MYJE2<a name='2766'>
        DO I=MYIS1,MYIE1<a name='2767'>
<font color=#447700>!<a name='2768'></font>
          DVOLP=DVOL(I,J,K)<a name='2769'>
          Q1IJ =Q1(I,J,K)<a name='2770'>
<font color=#447700>!<a name='2771'></font>
          HAFP=AFP(I,J,K)<a name='2772'>
          HAFQ=AFQ(I,J,K)<a name='2773'>
<font color=#447700>!<a name='2774'></font>
          D2PQQ=(Q1(IFPA(I,J,K),JFPA(I,J,K),K)-Q1IJ                     &amp;<a name='2775'>
     &amp;          -Q1IJ+Q1(IFPF(I,J,K),JFPF(I,J,K),K))                    &amp;<a name='2776'>
     &amp;          *HAFP                                                   &amp;<a name='2777'>
     &amp;         +(Q1(IFQA(I,J,K),JFQA(I,J,K),K)-Q1IJ                     &amp;<a name='2778'>
     &amp;          -Q1IJ+Q1(IFQF(I,J,K),JFQF(I,J,K),K))                    &amp;<a name='2779'>
     &amp;          *HAFQ<a name='2780'>
<font color=#447700>!<a name='2781'></font>
          QSTIJ=Q1IJ-D2PQQ<a name='2782'>
<font color=#447700>!<a name='2783'></font>
          Q00=Q  (I          ,J          ,K)<a name='2784'>
          QP0=Q  (IFPA(I,J,K),JFPA(I,J,K),K)<a name='2785'>
          Q0Q=Q  (IFQA(I,J,K),JFQA(I,J,K),K)<a name='2786'>
<font color=#447700>!<a name='2787'></font>
          QSTIJ=MAX(QSTIJ,MIN(Q00,QP0,Q0Q))<a name='2788'>
          QSTIJ=MIN(QSTIJ,MAX(Q00,QP0,Q0Q))<a name='2789'>
<font color=#447700>!<a name='2790'></font>
          DQSTIJ=QSTIJ-Q(I,J,K)<a name='2791'>
<font color=#447700>!<a name='2792'></font>
          DQST(I,J,K)=DQSTIJ<a name='2793'>
<font color=#447700>!<a name='2794'></font>
          DQSTIJ=DQSTIJ*DVOLP<a name='2795'>
<font color=#447700>!<a name='2796'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2797'></font>
#if defined(BIT_FOR_BIT) &amp;&amp; defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2798'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2799'></font>
          DO N=1,2<a name='2800'>
            XSUMS_L(I,J,K,N)=0.<a name='2801'>
          ENDDO<a name='2802'>
<font color=#447700>!<a name='2803'></font>
          IF(DQSTIJ&gt;0.)THEN<a name='2804'>
            XSUMS_L(I,J,K,1)=DQSTIJ<a name='2805'>
          ELSE<a name='2806'>
            XSUMS_L(I,J,K,2)=DQSTIJ<a name='2807'>
          ENDIF<a name='2808'>
<font color=#447700>!<a name='2809'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2810'></font>
#else<a name='2811'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2812'></font>
          IF(DQSTIJ&gt;0.)THEN<a name='2813'>
            XSUMS(1,K)=XSUMS(1,K)+DQSTIJ<a name='2814'>
          ELSE<a name='2815'>
            XSUMS(2,K)=XSUMS(2,K)+DQSTIJ<a name='2816'>
          ENDIF<a name='2817'>
<font color=#447700>!<a name='2818'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2819'></font>
#endif<a name='2820'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2821'></font>
<font color=#447700>!<a name='2822'></font>
        ENDDO<a name='2823'>
        ENDDO<a name='2824'>
<font color=#447700>!<a name='2825'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2826'></font>
<font color=#447700>!<a name='2827'></font>
      ENDDO vertical_2<a name='2828'>
<font color=#447700>!<a name='2829'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2830'></font>
#if defined(BIT_FOR_BIT) &amp;&amp; defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2831'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2832'></font>
      DO N=1,2<a name='2833'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>WRF_PATCH_TO_GLOBAL_REAL</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2_SCAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_6">(XSUMS_L(IMS,JMS,KMS,N)            &amp;<a name='2834'>
     &amp;,                               XSUMS_G(1,1,1,N),DOMDESC          &amp; <a name='2835'>
     &amp;,                              'xyz','xzy'                        &amp;<a name='2836'>
     &amp;,                               IDS,IDE,KDS,KDE,JDS,JDE           &amp;    <a name='2837'>
     &amp;,                               IMS,IME,KMS,KME,JMS,JME           &amp;<a name='2838'>
     &amp;,                               ITS,ITE,KTS,KTE,JTS,JTE)<a name='2839'>
      ENDDO<a name='2840'>
<font color=#447700>!<a name='2841'></font>
      DO K=KTS,KTE<a name='2842'>
        DO N=1,2<a name='2843'>
          GSUMS(N,K)=0.<a name='2844'>
        ENDDO<a name='2845'>
      ENDDO<a name='2846'>
<font color=#447700>!<a name='2847'></font>
      IF(WRF_DM_ON_MONITOR())THEN<a name='2848'>
        DO N=1,2<a name='2849'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2850'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2851'></font>
          DO K=KDS,KDE<a name='2852'>
          DO J=JDS,JDE<a name='2853'>
          DO I=IDS,IDE<a name='2854'>
            GSUMS(N,K)=GSUMS(N,K)+XSUMS_G(I,J,K,N)<a name='2855'>
          ENDDO<a name='2856'>
          ENDDO<a name='2857'>
          ENDDO<a name='2858'>
        ENDDO<a name='2859'>
      ENDIF<a name='2860'>
<a name='2861'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>WRF_DM_BCAST_BYTES</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2_SCAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_4">(GSUMS,2*RWORDSIZE*2*(KDE-KDS+1) )<a name='2862'>
<a name='2863'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2864'></font>
#else<a name='2865'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2866'></font>
<font color=#447700>!<a name='2867'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2868'></font>
<font color=#447700>!***  GLOBAL REDUCTION<a name='2869'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2870'></font>
<font color=#447700>!<a name='2871'></font>
# if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2872'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>WRF_GET_DM_COMMUNICATOR</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2_SCAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_3">(MPI_COMM_COMP)<a name='2873'>
      CALL MPI_ALLREDUCE(XSUMS,GSUMS,2*(KTE-KTS+1)                      &amp;<a name='2874'>
     &amp;                  ,MPI_DOUBLE_PRECISION,MPI_SUM                   &amp;<a name='2875'>
     &amp;                  ,MPI_COMM_COMP,IRECV)<a name='2876'>
# else<a name='2877'>
      DO K=KTS,KTE<a name='2878'>
        DO N=1,2<a name='2879'>
          GSUMS(N,K)=XSUMS(N,K)<a name='2880'>
        ENDDO<a name='2881'>
      ENDDO<a name='2882'>
# endif<a name='2883'>
<font color=#447700>!<a name='2884'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2885'></font>
#endif<a name='2886'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2887'></font>
<font color=#447700>!<a name='2888'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2889'></font>
<font color=#447700>!***  END OF GLOBAL REDUCTION<a name='2890'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2891'></font>
<font color=#447700>!<a name='2892'></font>
<font color=#447700>!     if(mype==0)then<a name='2893'></font>
<font color=#447700>!!!     if(ntsd==0)then<a name='2894'></font>
<font color=#447700>!!!       call int_get_fresh_handle(nunit)<a name='2895'></font>
<font color=#447700>!!!       close(nunit)<a name='2896'></font>
<font color=#447700>!         nunit=56<a name='2897'></font>
<font color=#447700>!!!       open(unit=nunit,file='gsums',form='unformatted',iostat=ier)<a name='2898'></font>
<font color=#447700>!!!     endif<a name='2899'></font>
<font color=#447700>!     endif<a name='2900'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2901'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2902'></font>
<font color=#447700>!$omp&amp; private(destij,dqstij,dwstij,i,j,k,rface,rfacq,rfacw             &amp;<a name='2903'></font>
<font color=#447700>!$omp&amp;        ,rfeij,rfqij,rfwij,sumnq,sumpq)<a name='2904'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2905'></font>
<font color=#447700>!<a name='2906'></font>
      vertical_3: DO K=KTS,KTE<a name='2907'>
<font color=#447700>!<a name='2908'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2909'></font>
<font color=#447700>!       if(mype==0)then<a name='2910'></font>
<font color=#447700>!         write(nunit)(gsums(i,k),i=1,6)<a name='2911'></font>
<font color=#447700>!       endif<a name='2912'></font>
<font color=#447700>!!!     read(nunit)(gsums(i,k),i=1,6)<a name='2913'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2914'></font>
<font color=#447700>!<a name='2915'></font>
        SUMPQ=GSUMS(1,K)<a name='2916'>
        SUMNQ=GSUMS(2,K)<a name='2917'>
<font color=#447700>!<a name='2918'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2919'></font>
<font color=#447700>!***  FIRST MOMENT CONSERVING FACTOR<a name='2920'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2921'></font>
<font color=#447700>!<a name='2922'></font>
        IF(SUMPQ&gt;1.)THEN<a name='2923'>
          RFACQ=-SUMNQ/SUMPQ<a name='2924'>
        ELSE<a name='2925'>
          RFACQ=1.<a name='2926'>
        ENDIF<a name='2927'>
<font color=#447700>!<a name='2928'></font>
        IF(RFACQ&lt;CONSERVE_MIN.OR.RFACQ&gt;CONSERVE_MAX)RFACQ=1.<a name='2929'>
<font color=#447700>!<a name='2930'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2931'></font>
<font color=#447700>!       if(mype==0.and.ntsd==181)close(nunit)<a name='2932'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2933'></font>
<font color=#447700>!<a name='2934'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2935'></font>
<font color=#447700>!***  IMPOSE CONSERVATION ON ANTI-FILTERING<a name='2936'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2937'></font>
<font color=#447700>!<a name='2938'></font>
        DO J=MYJS2,MYJE2<a name='2939'>
          IF(RFACQ&lt;1.)THEN<a name='2940'>
            DO I=MYIS1,MYIE1<a name='2941'>
              DQSTIJ=DQST(I,J,K)<a name='2942'>
              RFQIJ=HBM2(I,J)*(RFACQ-1.)+1.<a name='2943'>
              IF(DQSTIJ&gt;=0.)DQSTIJ=DQSTIJ*RFQIJ<a name='2944'>
              Q(I,J,K)=Q(I,J,K)+DQSTIJ<a name='2945'>
            ENDDO<a name='2946'>
          ELSE<a name='2947'>
            DO I=MYIS1,MYIE1<a name='2948'>
              DQSTIJ=DQST(I,J,K)<a name='2949'>
              RFQIJ=HBM2(I,J)*(RFACQ-1.)+1.<a name='2950'>
              IF(DQSTIJ&lt;0.)DQSTIJ=DQSTIJ/RFQIJ<a name='2951'>
              Q(I,J,K)=Q(I,J,K)+DQSTIJ<a name='2952'>
            ENDDO<a name='2953'>
          ENDIF<a name='2954'>
        ENDDO<a name='2955'>
<font color=#447700>!<a name='2956'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2957'></font>
<font color=#447700>!<a name='2958'></font>
        DO J=MYJS,MYJE<a name='2959'>
        DO I=MYIS,MYIE<a name='2960'>
          SCAL(I,J,K,L)=Q(I,J,K)<a name='2961'>
        ENDDO<a name='2962'>
        ENDDO<a name='2963'>
<font color=#447700>!<a name='2964'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2965'></font>
<font color=#447700>!<a name='2966'></font>
      ENDDO vertical_3<a name='2967'>
<font color=#447700>!<a name='2968'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2969'></font>
<font color=#447700>!<a name='2970'></font>
      ENDDO scalar_loop<a name='2971'>
<font color=#447700>!<a name='2972'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2973'></font>
<font color=#447700>!<a name='2974'></font>
      END SUBROUTINE HAD2_SCAL<a name='2975'>
<font color=#447700>!<a name='2976'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2977'></font>
<font color=#447700>!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<a name='2978'></font>
<A NAME='ADV2'><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#ADV2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2979'>
                        <font color=#993300>subroutine </font><font color=#cc0000>adv2</font> &amp; <A href='../../call_to/ADV2.html' TARGET='index'>1</A><a name='2980'>
(UPSTRM &amp;<a name='2981'>
,mype,kss,kse &amp;<a name='2982'>
,ids,ide,jds,jde,kds,kde &amp;<a name='2983'>
,ims,ime,jms,jme,kms,kme &amp;<a name='2984'>
,its,ite,jts,jte,kts,kte &amp;<a name='2985'>
,N_IUP_H &amp;<a name='2986'>
,N_IUP_ADH &amp;<a name='2987'>
,IUP_H,IUP_ADH &amp;<a name='2988'>
,ENT &amp;<a name='2989'>
,idtad &amp;<a name='2990'>
,dt,pdtop &amp;<a name='2991'>
,ihe,ihw,ive,ivw &amp;<a name='2992'>
,deta1,deta2 &amp;<a name='2993'>
,EMT_LOC &amp;<a name='2994'>
,fad,hbm2,pdsl,pdslo &amp;<a name='2995'>
,petdt &amp;<a name='2996'>
,UOLD,VOLD &amp;<a name='2997'>
,s,sp &amp;<a name='2998'>
<font color=#447700>!---temporary arguments-------------------------------------------------<a name='2999'></font>
,fne,fse,few,fns,s1,tcs)<a name='3000'>
<font color=#447700>!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<a name='3001'></font>
implicit none<a name='3002'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3003'></font>
real,parameter:: &amp;<a name='3004'>
 cfc=1.533 &amp;                 <font color=#447700>! adams-bashforth positioning in time<a name='3005'></font>
,bfc=1.-cfc &amp;                <font color=#447700>! adams bashforth positioning in time<a name='3006'></font>
,cflc=9.005 &amp;                <font color=#447700>!<a name='3007'></font>
,epsq=1.e-20 &amp;               <font color=#447700>! floor value for specific humidity<a name='3008'></font>
,epsq2=0.2 &amp;                 <font color=#447700>! floor value for 2tke<a name='3009'></font>
,epscm=2.e-6 &amp;               <font color=#447700>! a floor value (not used)<a name='3010'></font>
,w1=1.0 &amp;                    <font color=#447700>! crank-nicholson uncentering<a name='3011'></font>
<font color=#447700>!,w1=-1.00 &amp;                  ! crank-nicholson uncentering<a name='3012'></font>
,w2=2.-w1                    <font color=#447700>! crank-nicholson uncentering<a name='3013'></font>
<a name='3014'>
logical,intent(in):: &amp;<a name='3015'>
 upstrm<a name='3016'>
<a name='3017'>
integer,intent(in):: &amp;<a name='3018'>
 idtad &amp;                     <font color=#447700>! time step multiplier<a name='3019'></font>
,kse &amp;                       <font color=#447700>! terminal species index<a name='3020'></font>
,kss &amp;                       <font color=#447700>! initial species index<a name='3021'></font>
,mype &amp;                      <font color=#447700>!<a name='3022'></font>
,ids,ide,jds,jde,kds,kde &amp;<a name='3023'>
,ims,ime,jms,jme,kms,kme &amp;<a name='3024'>
,its,ite,jts,jte,kts,kte<a name='3025'>
<a name='3026'>
real,intent(in):: &amp;<a name='3027'>
 ent &amp;                       <font color=#447700>!<a name='3028'></font>
,dt &amp;                        <font color=#447700>! dynamics time step<a name='3029'></font>
,pdtop                       <font color=#447700>!<a name='3030'></font>
<a name='3031'>
real,dimension(kts:kte),intent(in):: &amp;<a name='3032'>
 deta1 &amp;                     <font color=#447700>! delta sigmas<a name='3033'></font>
,deta2                       <font color=#447700>! delta pressures<a name='3034'></font>
<a name='3035'>
integer,dimension(jms:jme),intent(in):: &amp;<a name='3036'>
 ihe,ihw,ive,ivw &amp;<a name='3037'>
,n_iup_adh,n_iup_h<a name='3038'>
<a name='3039'>
integer,dimension(ims:ime,jms:jme),intent(in):: &amp;<a name='3040'>
 iup_h,iup_adh<a name='3041'>
<a name='3042'>
real,dimension(2600),intent(in):: &amp; <font color=#447700>!!!zj see nmm_max_dim in adve !!!zj<a name='3043'></font>
 emt_loc<a name='3044'>
<a name='3045'>
real,dimension(ims:ime,jms:jme),intent(in):: &amp;<a name='3046'>
 fad &amp;                       <font color=#447700>!<a name='3047'></font>
,hbm2 &amp;                      <font color=#447700>!<a name='3048'></font>
,pdsl &amp;                      <font color=#447700>! sigma range pressure difference<a name='3049'></font>
,pdslo                       <font color=#447700>! sigma range pressure difference<a name='3050'></font>
<a name='3051'>
real,dimension(ims:ime,jms:jme,kms:kme),intent(in):: &amp;<a name='3052'>
 petdt &amp;                     <font color=#447700>! vertical mass flux<a name='3053'></font>
,uold,vold<a name='3054'>
<a name='3055'>
real,dimension(ims:ime,jms:jme,kms:kme,kss:kse),intent(inout):: &amp;<a name='3056'>
 s                           <font color=#447700>! tracers<a name='3057'></font>
<a name='3058'>
real,dimension(ims:ime,jms:jme,kms:kme,kss:kse),intent(inout):: &amp;<a name='3059'>
 sp                          <font color=#447700>! s at previous time level<a name='3060'></font>
<a name='3061'>
<font color=#447700>!---temporary arguments-------------------------------------------------<a name='3062'></font>
real,dimension(ims:ime,jms:jme,kms:kme),intent(in):: &amp;<a name='3063'>
 fne &amp;                       <font color=#447700>! mass flux, ne direction<a name='3064'></font>
,fse &amp;                       <font color=#447700>! mass flux, se direction<a name='3065'></font>
,few &amp;                       <font color=#447700>! mass flux, x direction<a name='3066'></font>
,fns                         <font color=#447700>! mass flux, y direction<a name='3067'></font>
<a name='3068'>
real,dimension(ims:ime,jms:jme,kms:kme,kss:kse),intent(inout):: &amp;<a name='3069'>
 s1 &amp;                        <font color=#447700>! intermediate value of s<a name='3070'></font>
,tcs                         <font color=#447700>! timechange of s<a name='3071'></font>
<a name='3072'>
<font color=#447700>!--local variables------------------------------------------------------<a name='3073'></font>
integer:: &amp;<a name='3074'>
 i &amp;                         <font color=#447700>!<a name='3075'></font>
,j &amp;                         <font color=#447700>!<a name='3076'></font>
,k &amp;                         <font color=#447700>!<a name='3077'></font>
,ks                          <font color=#447700>!<a name='3078'></font>
<a name='3079'>
      INTEGER :: IEND,IFP,IFQ,II,IPQ,ISP,ISQ,ISTART &amp;<a name='3080'>
     &amp;          ,IUP_ADH_J &amp;<a name='3081'>
     &amp;          ,J1,JA,JAK,JEND,JGLOBAL,JJ,JKNT,JP2,JSTART &amp;<a name='3082'>
     &amp;          ,KNTI_ADH,KSTART,KSTOP &amp;<a name='3083'>
     &amp;          ,N,N_IUPH_J,N_IUPADH_J,N_IUPADV_J<a name='3084'>
<a name='3085'>
      INTEGER :: MY_IS_GLB,MY_IE_GLB,MY_JS_GLB,MY_JE_GLB<a name='3086'>
<a name='3087'>
real:: &amp;<a name='3088'>
 cf &amp;                        <font color=#447700>! temporary<a name='3089'></font>
,cms &amp;                       <font color=#447700>! temporary<a name='3090'></font>
,dtq &amp;                       <font color=#447700>! dt/4<a name='3091'></font>
,fahp &amp;                      <font color=#447700>! temporary grid factor<a name='3092'></font>
,sn &amp;                        <font color=#447700>!<a name='3093'></font>
,rdp &amp;                       <font color=#447700>! 1/deltap<a name='3094'></font>
,vvlo &amp;                      <font color=#447700>! vertical velocity, lower interface<a name='3095'></font>
,vvup &amp;                      <font color=#447700>! vertical velocity, upper interface<a name='3096'></font>
,pvvup                       <font color=#447700>! vertical mass flux, upper interface<a name='3097'></font>
<a name='3098'>
      REAL :: ARRAY3_X &amp;<a name='3099'>
     &amp;       ,F0,F1,F2,F3 &amp;<a name='3100'>
     &amp;       ,PP &amp;<a name='3101'>
     &amp;       ,QP &amp;<a name='3102'>
     &amp;       ,TEMPA,TEMPB,TTA,TTB<a name='3103'>
<a name='3104'>
real,dimension(kts:kte):: &amp;<a name='3105'>
 deta1_pdtop                 <font color=#447700>!<a name='3106'></font>
<a name='3107'>
      INTEGER,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: ISPA,ISQA<a name='3108'>
<a name='3109'>
real,dimension(its-5:ite+5,jts-5:jte+5):: &amp;<a name='3110'>
 pdop &amp;                      <font color=#447700>! hydrostatic pressure difference at h points<a name='3111'></font>
,pvvlo &amp;                     <font color=#447700>! vertical mass flux, lower interface<a name='3112'></font>
,ss1 &amp;                       <font color=#447700>! extrapolated species between time levels<a name='3113'></font>
,ssne &amp;                      <font color=#447700>! flux, ne direction<a name='3114'></font>
,ssse &amp;                      <font color=#447700>! flux, nw direction<a name='3115'></font>
,ssx &amp;                       <font color=#447700>! flux, x direction<a name='3116'></font>
,ssy                         <font color=#447700>! flux, y direction<a name='3117'></font>
<a name='3118'>
      REAL,DIMENSION(ITS-5:ITE+5,JTS-5:JTE+5) :: ARRAY0,ARRAY1 &amp;<a name='3119'>
     &amp;                                          ,ARRAY2,ARRAY3<a name='3120'>
<a name='3121'>
real,dimension(its-5:ite+5,jts-5:jte+5,kts:kte):: &amp;<a name='3122'>
 crs &amp;                       <font color=#447700>! vertical advection temporary<a name='3123'></font>
,rcms                        <font color=#447700>! vertical advection temporary<a name='3124'></font>
<a name='3125'>
real,dimension(its-5:ite+5,jts-5:jte+5,kts:kte,kss:kse):: &amp;<a name='3126'>
 rsts                        <font color=#447700>! vertical advection temporary<a name='3127'></font>
<font color=#447700>!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<a name='3128'></font>
      DO J=JTS-5,JTE+5<a name='3129'>
        DO I=ITS-5,ITE+5<a name='3130'>
          pdop (i,j)=0.<a name='3131'>
          pvvlo(i,j)=0.<a name='3132'>
          ss1  (i,j)=0.<a name='3133'>
          ssne (i,j)=0.<a name='3134'>
          ssse (i,j)=0.<a name='3135'>
        enddo<a name='3136'>
      enddo<a name='3137'>
<font color=#447700>!<a name='3138'></font>
      DO K=KTS,KTE<a name='3139'>
        DO J=JTS-5,JTE+5<a name='3140'>
          DO I=ITS-5,ITE+5<a name='3141'>
            crs (i,j,k)=0.<a name='3142'>
            rcms(i,j,k)=0.<a name='3143'>
          enddo<a name='3144'>
        enddo<a name='3145'>
      enddo<a name='3146'>
<font color=#447700>!<a name='3147'></font>
      do ks=kss,kse<a name='3148'>
        DO K=KTS,KTE<a name='3149'>
          DO J=JTS-5,JTE+5<a name='3150'>
            DO I=ITS-5,ITE+5<a name='3151'>
              rsts(i,j,k,ks)=0.<a name='3152'>
            enddo<a name='3153'>
          enddo<a name='3154'>
        enddo<a name='3155'>
      enddo<a name='3156'>
<font color=#447700>!<a name='3157'></font>
      do ks=kss,kse<a name='3158'>
        DO K=KMS,KME<a name='3159'>
          DO J=JMS,JME<a name='3160'>
            DO I=IMS,IME<a name='3161'>
              s1 (i,j,k,ks)=0.<a name='3162'>
              tcs(i,j,k,ks)=0.<a name='3163'>
            enddo<a name='3164'>
          enddo<a name='3165'>
        enddo<a name='3166'>
      enddo<a name='3167'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3168'></font>
      do k=kts,kte<a name='3169'>
        deta1_pdtop(k)=deta1(k)*pdtop<a name='3170'>
      enddo<a name='3171'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3172'></font>
      do ks=kss,kse <font color=#447700>! loop by species<a name='3173'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3174'></font>
        DO K=KTS,KTE<a name='3175'>
          DO J=MYJS_P4,MYJE_P4<a name='3176'>
            DO I=MYIS_P4,MYIE_P4<a name='3177'>
              s1(i,j,k,ks)=sqrt(s(i,j,k,ks))<a name='3178'>
            enddo<a name='3179'>
          enddo<a name='3180'>
        enddo<a name='3181'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3182'></font>
      enddo <font color=#447700>! end of the loop by species<a name='3183'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3184'></font>
      DO J=MYJS_P4,MYJE_P4<a name='3185'>
        DO I=MYIS_P4,MYIE_P4<a name='3186'>
          pdop(i,j)=(pdslo(i,j)+pdsl(i,j))*0.5<a name='3187'>
        enddo<a name='3188'>
      enddo<a name='3189'>
<font color=#447700>!---crank-nicholson vertical advection----------------------------------<a name='3190'></font>
      dtq=dt*idtad*0.25<a name='3191'>
<a name='3192'>
      DO J=MYJS2,MYJE2<a name='3193'>
        DO I=MYIS1,MYIE1<a name='3194'>
          pvvlo(i,j)=petdt(i,j,kte-1)*dtq<a name='3195'>
          vvlo=pvvlo(i,j)/(deta2(kte)*pdop(i,j)+deta1_pdtop(kte))<a name='3196'>
<font color=#447700>!<a name='3197'></font>
          cms=-vvlo*w2+1.<a name='3198'>
          rcms(i,j,kte)=1./cms<a name='3199'>
          crs(i,j,kte)=vvlo*w2<a name='3200'>
<font color=#447700>!<a name='3201'></font>
          do ks=kss,kse<a name='3202'>
            rsts(i,j,kte,ks)=(-vvlo*w1) &amp;<a name='3203'>
                            *(s1(i,j,kte-1,ks)-s1(i,j,kte,ks)) &amp;<a name='3204'>
                            +s1(i,j,kte,ks)<a name='3205'>
          enddo<a name='3206'>
        enddo<a name='3207'>
      enddo<a name='3208'>
      DO K=KTE-1,KTS+1,-1<a name='3209'>
        DO J=MYJS2,MYJE2<a name='3210'>
          DO I=MYIS1,MYIE1<a name='3211'>
            rdp=1./(deta2(k)*pdop(i,j)+deta1_pdtop(k))<a name='3212'>
            pvvup=pvvlo(i,j)<a name='3213'>
            pvvlo(i,j)=petdt(i,j,k-1)*dtq<a name='3214'>
<font color=#447700>!<a name='3215'></font>
            vvup=pvvup*rdp<a name='3216'>
            vvlo=pvvlo(i,j)*rdp<a name='3217'>
<font color=#447700>!<a name='3218'></font>
<font color=#447700>!            if(abs(vvlo).gt.cflc) then<a name='3219'></font>
<font color=#447700>!              if(vvlo.lt.0.) then<a name='3220'></font>
<font color=#447700>!                vvlo=-cflc<a name='3221'></font>
<font color=#447700>!              else<a name='3222'></font>
<font color=#447700>!                vvlo= cflc<a name='3223'></font>
<font color=#447700>!              endif<a name='3224'></font>
<font color=#447700>!            endif<a name='3225'></font>
<font color=#447700>!<a name='3226'></font>
            cf=-vvup*w2*rcms(i,j,k+1)<a name='3227'>
            cms=-crs(i,j,k+1)*cf+((vvup-vvlo)*w2+1.)<a name='3228'>
            rcms(i,j,k)=1./cms<a name='3229'>
            crs(i,j,k)=vvlo*w2<a name='3230'>
<font color=#447700>!<a name='3231'></font>
            do ks=kss,kse<a name='3232'>
              rsts(i,j,k,ks)=-rsts(i,j,k+1,ks)*cf+s1(i,j,k,ks) &amp;<a name='3233'>
                             -(s1(i,j,k  ,ks)-s1(i,j,k+1,ks))*vvup*w1 &amp;<a name='3234'>
                             -(s1(i,j,k-1,ks)-s1(i,j,k  ,ks))*vvlo*w1<a name='3235'>
            enddo<a name='3236'>
          enddo<a name='3237'>
        enddo<a name='3238'>
      enddo<a name='3239'>
      DO J=MYJS2,MYJE2<a name='3240'>
        DO I=MYIS1,MYIE1<a name='3241'>
          pvvup=pvvlo(i,j)<a name='3242'>
          vvup=pvvup/(deta2(kts)*pdop(i,j)+deta1_pdtop(kts))<a name='3243'>
<font color=#447700>!<a name='3244'></font>
          cf=-vvup*w2*rcms(i,j,kts+1)<a name='3245'>
          cms=-crs(i,j,kts+1)*cf+(vvup*w2+1.)<a name='3246'>
          rcms(i,j,kts)=1./cms<a name='3247'>
          crs(i,j,kts)=0.<a name='3248'>
<font color=#447700>!<a name='3249'></font>
          do ks=kss,kse<a name='3250'>
            rsts(i,j,kts,ks)=-rsts(i,j,kts+1,ks)*cf+s1(i,j,kts,ks) &amp;<a name='3251'>
                             -(s1(i,j,kts,ks)-s1(i,j,kts+1,ks))*vvup*w1<a name='3252'>
<font color=#447700>!<a name='3253'></font>
            tcs(i,j,kts,ks)=rsts(i,j,kts,ks)*rcms(i,j,kts)-s1(i,j,kts,ks)<a name='3254'>
          enddo<a name='3255'>
        enddo<a name='3256'>
      enddo<a name='3257'>
      do ks=kss,kse<a name='3258'>
        DO K=KTS+1,KTE<a name='3259'>
          DO J=MYJS2,MYJE2<a name='3260'>
            DO I=MYIS1,MYIE1<a name='3261'>
              tcs(i,j,k,ks)=(-crs(i,j,k)*(s1(i,j,k-1,ks)+tcs(i,j,k-1,ks)) &amp;<a name='3262'>
                             +rsts(i,j,k,ks)) &amp;<a name='3263'>
                           *rcms(i,j,k)-s1(i,j,k,ks)<a name='3264'>
            enddo<a name='3265'>
          enddo<a name='3266'>
        enddo<a name='3267'>
      enddo<a name='3268'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3269'></font>
      do ks=kss,kse <font color=#447700>! loop by species<a name='3270'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3271'></font>
        DO K=KTS,KTE<a name='3272'>
          DO J=MYJS_P5,MYJE_P5<a name='3273'>
            DO I=MYIS_P5,MYIE_P5<a name='3274'>
              ss1(i,j)=s1(i,j,k,ks)*cfc+sp(i,j,k,ks)*bfc<a name='3275'>
              sp(i,j,k,ks)=s1(i,j,k,ks)<a name='3276'>
            enddo<a name='3277'>
          enddo<a name='3278'>
<font color=#447700>!---fluxes--------------------------------------------------------------<a name='3279'></font>
          DO J=MYJS1_P2,MYJE1_P2<a name='3280'>
            DO I=MYIS_P2,MYIE_P3<a name='3281'>
              ssx(i,j)=(ss1(i+ive(j),j  )-ss1(i+ivw(j),j  ))*few(i,j,k) &amp;<a name='3282'>
                      *hbm2(i,j)<a name='3283'>
              ssy(i,j)=(ss1(i       ,j+1)-ss1(i       ,j-1))*fns(i,j,k) &amp;<a name='3284'>
                      *hbm2(i,j)<a name='3285'>
            enddo<a name='3286'>
          enddo<a name='3287'>
          DO J=MYJS1_P2,MYJE2_P2<a name='3288'>
            DO I=MYIS_P2,MYIE_P2<a name='3289'>
              ssne(i,j)=(ss1(i+ihe(j),j+1)-ss1(i,j))*fne(i,j,k)*hbm2(i,j)<a name='3290'>
            enddo<a name='3291'>
          enddo<a name='3292'>
          DO J=MYJS2_P2,MYJE1_P2<a name='3293'>
            DO I=MYIS_P2,MYIE_P2<a name='3294'>
              ssse(i,j)=(ss1(i+ihe(j),j-1)-ss1(i,j))*fse(i,j,k)*hbm2(i,j)<a name='3295'>
            enddo<a name='3296'>
          enddo<a name='3297'>
<font color=#447700>!---advection of species------------------------------------------------<a name='3298'></font>
          DO J=MYJS5,MYJE5<a name='3299'>
            DO I=MYIS2,MYIE2<a name='3300'>
              tcs(i,j,k,ks)=((ssx (i+ihw(j),j  )+ssx (i+ihe(j),j  ) &amp;<a name='3301'>
                             +ssy (i       ,j-1)+ssy (i       ,j+1) &amp;<a name='3302'>
                             +ssne(i+ihw(j),j-1)+ssne(i       ,j  ) &amp;<a name='3303'>
                             +ssse(i       ,j  )+ssse(i+ihw(j),j+1)) &amp;<a name='3304'>
                            *fad(i,j)*2.0*idtad &amp;   <font color=#447700>!! 2.0 compensates for fad<a name='3305'></font>
                            /(deta2(k)*pdop(i,j)+deta1_pdtop(k)) &amp;<a name='3306'>
                           +tcs(i,j,k,ks))*hbm2(i,j)<a name='3307'>
            enddo<a name='3308'>
          enddo<a name='3309'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3310'></font>
<font color=#447700>!<a name='3311'></font>
<font color=#447700>!***  upstream advection<a name='3312'></font>
<font color=#447700>!<a name='3313'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3314'></font>
<font color=#447700>!<a name='3315'></font>
          upstream: IF(UPSTRM)THEN<a name='3316'>
<font color=#447700>!<a name='3317'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3318'></font>
<font color=#447700>!***<a name='3319'></font>
<font color=#447700>!***  COMPUTE UPSTREAM COMPUTATIONS ON THIS TASK'S ROWS.<a name='3320'></font>
<font color=#447700>!***<a name='3321'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3322'></font>
<font color=#447700>!<a name='3323'></font>
            jloop_upstream: DO J=MYJS2,MYJE2<a name='3324'>
<font color=#447700>!<a name='3325'></font>
              N_IUPH_J=N_IUP_H(J)   <font color=#447700>! See explanation in START_DOMAIN_NMM<a name='3326'></font>
              DO II=0,N_IUPH_J-1<a name='3327'>
<font color=#447700>!<a name='3328'></font>
                I=IUP_H(IMS+II,J)<a name='3329'>
                tta=emt_loc(j) &amp;<a name='3330'>
                   *(uold(i       ,j-1,k)+uold(i+ihw(j),j  ,k) &amp;<a name='3331'>
                    +uold(i+ihe(j),j  ,k)+uold(i       ,j+1,k))<a name='3332'>
                ttb=ent &amp;<a name='3333'>
                   *(vold(i       ,j-1,k)+vold(i+ihw(j),j  ,k) &amp;<a name='3334'>
                    +vold(i+ihe(j),j  ,k)+vold(i       ,j+1,k))<a name='3335'>
                PP=-TTA-TTB<a name='3336'>
                QP= TTA-TTB<a name='3337'>
<font color=#447700>!<a name='3338'></font>
                IF(PP&lt;0.)THEN<a name='3339'>
                  ISPA(I,J)=-1<a name='3340'>
                ELSE<a name='3341'>
                  ISPA(I,J)= 1<a name='3342'>
                ENDIF<a name='3343'>
<font color=#447700>!<a name='3344'></font>
                IF(QP&lt;0.)THEN<a name='3345'>
                  ISQA(I,J)=-1<a name='3346'>
                ELSE<a name='3347'>
                  ISQA(I,J)= 1<a name='3348'>
                ENDIF<a name='3349'>
<font color=#447700>!<a name='3350'></font>
                PP=ABS(PP)<a name='3351'>
                QP=ABS(QP)<a name='3352'>
                ARRAY3_X=PP*QP<a name='3353'>
                ARRAY0(I,J)=ARRAY3_X-PP-QP<a name='3354'>
                ARRAY1(I,J)=PP-ARRAY3_X<a name='3355'>
                ARRAY2(I,J)=QP-ARRAY3_X<a name='3356'>
                ARRAY3(I,J)=ARRAY3_X<a name='3357'>
              ENDDO<a name='3358'>
<font color=#447700>!<a name='3359'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3360'></font>
<font color=#447700>!<a name='3361'></font>
              N_IUPADH_J=N_IUP_ADH(J)<a name='3362'>
              KNTI_ADH=1<a name='3363'>
              IUP_ADH_J=IUP_ADH(IMS,J)<a name='3364'>
<font color=#447700>!<a name='3365'></font>
              iloop_T: DO II=0,N_IUPH_J-1<a name='3366'>
<font color=#447700>!<a name='3367'></font>
                I=IUP_H(IMS+II,J)<a name='3368'>
<font color=#447700>!<a name='3369'></font>
                ISP=ISPA(I,J)<a name='3370'>
                ISQ=ISQA(I,J)<a name='3371'>
                IFP=(ISP-1)/2<a name='3372'>
                IFQ=(-ISQ-1)/2<a name='3373'>
                IPQ=(ISP-ISQ)/2<a name='3374'>
<font color=#447700>!<a name='3375'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3376'></font>
<font color=#447700>!<a name='3377'></font>
                IF(I==IUP_ADH_J)THEN  <font color=#447700>! Upstream advection T tendencies<a name='3378'></font>
<font color=#447700>!<a name='3379'></font>
                  ISP=ISPA(I,J)<a name='3380'>
                  ISQ=ISQA(I,J)<a name='3381'>
                  IFP=(ISP-1)/2<a name='3382'>
                  IFQ=(-ISQ-1)/2<a name='3383'>
                  IPQ=(ISP-ISQ)/2<a name='3384'>
<font color=#447700>!<a name='3385'></font>
                  F0=ARRAY0(I,J)<a name='3386'>
                  F1=ARRAY1(I,J)<a name='3387'>
                  F2=ARRAY2(I,J)<a name='3388'>
                  F3=ARRAY3(I,J)<a name='3389'>
<font color=#447700>!<a name='3390'></font>
                  tcs(i,j,k,ks)=(f0*s1(i,j,k,ks) &amp;<a name='3391'>
     &amp;                          +f1*s1(i+ihe(j)+ifp,j+isp,k,ks) &amp;<a name='3392'>
     &amp;                          +f2*s1(i+ihe(j)+ifq,j+isq,k,ks) &amp;<a name='3393'>
     &amp;                          +f3*s1(i+ipq,j+isp+isq,k,ks))*2.0 &amp;<a name='3394'>
     &amp;                          *idtad &amp;<a name='3395'>
     &amp;                         +tcs(i,j,k,ks)*hbm2(i,j)<a name='3396'>
<font color=#447700>!<a name='3397'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3398'></font>
<font color=#447700>!<a name='3399'></font>
                  IF(KNTI_ADH&lt;N_IUPADH_J)THEN<a name='3400'>
                    IUP_ADH_J=IUP_ADH(IMS+KNTI_ADH,J)<a name='3401'>
                    KNTI_ADH=KNTI_ADH+1<a name='3402'>
                  ENDIF<a name='3403'>
<font color=#447700>!<a name='3404'></font>
                ENDIF  <font color=#447700>! End of upstream advection tendency IF block<a name='3405'></font>
<font color=#447700>!<a name='3406'></font>
              ENDDO iloop_T<a name='3407'>
<font color=#447700>!<a name='3408'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3409'></font>
            enddo jloop_upstream<a name='3410'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3411'></font>
          endif upstream<a name='3412'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3413'></font>
        enddo <font color=#447700>! kts,kte<a name='3414'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3415'></font>
      enddo <font color=#447700>! end of the loop by the species<a name='3416'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3417'></font>
                        endsubroutine adv2<a name='3418'>
<font color=#447700>!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<a name='3419'></font>
<A NAME='MONO'><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#MONO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3420'>
                        <font color=#993300>subroutine </font><font color=#cc0000>mono</font> &amp; <A href='../../call_to/MONO.html' TARGET='index'>1</A>,<A href='../../call_from/MONO.html' TARGET='index'>3</A><a name='3421'>
( &amp;<a name='3422'>
#if defined(DM_PARALLEL)<a name='3423'>
 domdesc, &amp;<a name='3424'>
#endif<a name='3425'>
 mype,ntsd,hours,kss,kse &amp;<a name='3426'>
,ids,ide,jds,jde,kds,kde &amp;<a name='3427'>
,ims,ime,jms,jme,kms,kme &amp;<a name='3428'>
,its,ite,jts,jte,kts,kte &amp;<a name='3429'>
,idtad &amp;<a name='3430'>
,dy,pdtop &amp;<a name='3431'>
,sumdrrw &amp;<a name='3432'>
,ihe,ihw &amp;<a name='3433'>
,deta1,deta2 &amp;<a name='3434'>
,dx,hbm2,pd &amp;<a name='3435'>
,s &amp;<a name='3436'>
<font color=#447700>!---temporary arguments-------------------------------------------------<a name='3437'></font>
,s1,tcs)<a name='3438'>
<font color=#447700>!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<a name='3439'></font>
implicit none<a name='3440'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3441'></font>
real,parameter:: &amp;<a name='3442'>
 epsq=1.e-20 &amp;               <font color=#447700>! floor value for specific humidity<a name='3443'></font>
,epsq2=0.02                  <font color=#447700>! floor value for 2tke<a name='3444'></font>
<a name='3445'>
#ifdef DM_PARALLEL<a name='3446'>
      INTEGER :: DOMDESC<a name='3447'>
#endif<a name='3448'>
<a name='3449'>
integer,intent(in):: &amp;<a name='3450'>
 idtad &amp;                     <font color=#447700>! time step multiplier<a name='3451'></font>
,kse &amp;                       <font color=#447700>! terminal species index<a name='3452'></font>
,kss &amp;                       <font color=#447700>! initial species index<a name='3453'></font>
,mype &amp;                      <font color=#447700>!<a name='3454'></font>
,ntsd &amp;                      <font color=#447700>!<a name='3455'></font>
,ids,ide,jds,jde,kds,kde &amp;<a name='3456'>
,ims,ime,jms,jme,kms,kme &amp;<a name='3457'>
,its,ite,jts,jte,kts,kte<a name='3458'>
<a name='3459'>
real,intent(in):: &amp;<a name='3460'>
 dy &amp;                        <font color=#447700>!<a name='3461'></font>
,pdtop &amp;                     <font color=#447700>!<a name='3462'></font>
,hours                       <font color=#447700>!<a name='3463'></font>
<a name='3464'>
real,intent(inout):: &amp;<a name='3465'>
 sumdrrw<a name='3466'>
<a name='3467'>
integer,dimension(jms:jme),intent(in):: &amp;<a name='3468'>
 ihe,ihw<a name='3469'>
<a name='3470'>
real,dimension(kts:kte),intent(in):: &amp;<a name='3471'>
 deta1 &amp;                     <font color=#447700>! delta sigmas<a name='3472'></font>
,deta2                       <font color=#447700>! delta sigmas<a name='3473'></font>
<a name='3474'>
real,dimension(ims:ime,jms:jme),intent(in):: &amp;<a name='3475'>
 dx &amp;                        <font color=#447700>!<a name='3476'></font>
,hbm2 &amp;                      <font color=#447700>!<a name='3477'></font>
,pd                          <font color=#447700>! sigma range pressure difference<a name='3478'></font>
<a name='3479'>
real,dimension(ims:ime,jms:jme,kms:kme,kss:kse),intent(in):: &amp;<a name='3480'>
 s                           <font color=#447700>! s<a name='3481'></font>
<font color=#447700>!---temporary arguments-------------------------------------------------<a name='3482'></font>
real,dimension(ims:ime,jms:jme,kms:kme,kss:kse),intent(inout):: &amp;<a name='3483'>
 s1 &amp;                        <font color=#447700>! intermediate value of s<a name='3484'></font>
,tcs                         <font color=#447700>! timechange of s<a name='3485'></font>
<font color=#447700>!--local variables------------------------------------------------------<a name='3486'></font>
integer:: &amp;<a name='3487'>
 i &amp;                         <font color=#447700>!<a name='3488'></font>
,ierr &amp;                      <font color=#447700>!<a name='3489'></font>
,irecv &amp;                     <font color=#447700>!<a name='3490'></font>
,j &amp;                         <font color=#447700>!<a name='3491'></font>
,k &amp;                         <font color=#447700>!<a name='3492'></font>
,ks &amp;                        <font color=#447700>!<a name='3493'></font>
,lngth &amp;                     <font color=#447700>!<a name='3494'></font>
,mpi_comm_comp               <font color=#447700>!<a name='3495'></font>
<a name='3496'>
real:: &amp;<a name='3497'>
 dsks &amp;                      <font color=#447700>!<a name='3498'></font>
,dvolp &amp;                     <font color=#447700>!<a name='3499'></font>
,rfacs &amp;                     <font color=#447700>!<a name='3500'></font>
,s1p &amp;                       <font color=#447700>!<a name='3501'></font>
,sfacs &amp;                     <font color=#447700>!<a name='3502'></font>
,smax &amp;                      <font color=#447700>! local maximum<a name='3503'></font>
,smin &amp;                      <font color=#447700>! local minimum<a name='3504'></font>
,smaxh &amp;                     <font color=#447700>! horizontal local maximum<a name='3505'></font>
,sminh &amp;                     <font color=#447700>! horizontal local minimum<a name='3506'></font>
,smaxv &amp;                     <font color=#447700>! vertical local maximum<a name='3507'></font>
,sminv &amp;                     <font color=#447700>! vertical local minimum<a name='3508'></font>
,sn &amp;                        <font color=#447700>!<a name='3509'></font>
,sumns &amp;                     <font color=#447700>!<a name='3510'></font>
,sumps &amp;                     <font color=#447700>!<a name='3511'></font>
,steep<a name='3512'>
<a name='3513'>
double precision:: &amp;<a name='3514'>
 xsmp,gsmp<a name='3515'>
<a name='3516'>
double precision,dimension(2*kss-1:2*kse):: &amp;<a name='3517'>
 vgsms<a name='3518'>
<a name='3519'>
real,dimension(kts:kte):: &amp;<a name='3520'>
 deta1_pdtop                 <font color=#447700>!<a name='3521'></font>
<a name='3522'>
real,dimension(2*kss-1:2*kse,kts:kte):: &amp;<a name='3523'>
 gsms_single                 <font color=#447700>!<a name='3524'></font>
<a name='3525'>
double precision,dimension(2*kss-1:2*kse,kts:kte):: &amp;<a name='3526'>
 gsms &amp;                      <font color=#447700>! sum of neg/pos changes all global fields<a name='3527'></font>
,xsms                        <font color=#447700>! sum of neg/pos changes all local fields<a name='3528'></font>
<a name='3529'>
double precision,dimension(2*kss-1:2*kse):: &amp;<a name='3530'>
 vgsums                      <font color=#447700>!<a name='3531'></font>
<a name='3532'>
real,dimension(its-5:ite+5,jts-5:jte+5,kts:kte):: &amp;<a name='3533'>
 dvol &amp;                      <font color=#447700>! grid box volume<a name='3534'></font>
,rdvol                       <font color=#447700>! 1./grid box volume<a name='3535'></font>
<a name='3536'>
logical, save :: first=.true.<a name='3537'>
real, save :: sumrrw_first, summass_first<a name='3538'>
real :: summass<a name='3539'>
double precision, save :: gsmp_first<a name='3540'>
<font color=#447700>!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<a name='3541'></font>
<a name='3542'>
<font color=#447700>!     steep=1.-0.040*idtad<a name='3543'></font>
      steep=1.<a name='3544'>
<a name='3545'>
      DO K=KTS,KTE<a name='3546'>
        deta1_pdtop(k)=deta1(k)*pdtop<a name='3547'>
      enddo<a name='3548'>
<font color=#447700>!<a name='3549'></font>
      DO K=KTS,KTE<a name='3550'>
        DO J=MYJS2,MYJE2<a name='3551'>
          DO I=MYIS1,MYIE1<a name='3552'>
            dvolp=(deta2(k)*pd(i,j)+deta1_pdtop(k))*dx(i,j)*dy<a name='3553'>
            rdvol(i,j,k)=hbm2(i,j)/dvolp<a name='3554'>
            dvol (i,j,k)=hbm2(i,j)*dvolp<a name='3555'>
          enddo<a name='3556'>
        enddo<a name='3557'>
      enddo<a name='3558'>
<a name='3559'>
<font color=#447700>!      go to 109<a name='3560'></font>
<font color=#447700>!---monotonization------------------------------------------------------<a name='3561'></font>
      do ks=kss,kse <font color=#447700>! loop by species<a name='3562'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3563'></font>
        DO K=KTS,KTE<a name='3564'>
          xsms(2*ks-1,k)=0.<a name='3565'>
          xsms(2*ks  ,k)=0.<a name='3566'>
          gsms(2*ks-1,k)=0.<a name='3567'>
          gsms(2*ks  ,k)=0.<a name='3568'>
<font color=#447700>!<a name='3569'></font>
          DO J=MYJS2,MYJE2<a name='3570'>
            DO I=MYIS1,MYIE1<a name='3571'>
<font color=#447700>!<a name='3572'></font>
              s1p=(s1(i,j,k,ks)+tcs(i,j,k,ks))**2<a name='3573'>
              tcs(i,j,k,ks)=s1p-s(i,j,k,ks)<a name='3574'>
<font color=#447700>!<a name='3575'></font>
              sminh=min(s(i       ,j-2,k,ks) &amp;<a name='3576'>
                       ,s(i+ihw(j),j-1,k,ks) &amp;<a name='3577'>
                       ,s(i+ihe(j),j-1,k,ks) &amp;<a name='3578'>
                       ,s(i-1     ,j  ,k,ks) &amp;<a name='3579'>
                       ,s(i       ,j  ,k,ks) &amp;<a name='3580'>
                       ,s(i+1     ,j  ,k,ks) &amp;<a name='3581'>
                       ,s(i+ihw(j),j+1,k,ks) &amp;<a name='3582'>
                       ,s(i+ihe(j),j+1,k,ks) &amp;<a name='3583'>
                       ,s(i       ,j+2,k,ks))<a name='3584'>
              smaxh=max(s(i       ,j-2,k,ks) &amp;<a name='3585'>
                       ,s(i+ihw(j),j-1,k,ks) &amp;<a name='3586'>
                       ,s(i+ihe(j),j-1,k,ks) &amp;<a name='3587'>
                       ,s(i-1     ,j  ,k,ks) &amp;<a name='3588'>
                       ,s(i       ,j  ,k,ks) &amp;<a name='3589'>
                       ,s(i+1     ,j  ,k,ks) &amp;<a name='3590'>
                       ,s(i+ihw(j),j+1,k,ks) &amp;<a name='3591'>
                       ,s(i+ihe(j),j+1,k,ks) &amp;<a name='3592'>
                       ,s(i       ,j+2,k,ks))<a name='3593'>
<font color=#447700>!<a name='3594'></font>
              if(k.gt.kts.and.k.lt.kte) then<a name='3595'>
                sminv=min(s(i,j,k-1,ks),s(i,j,k  ,ks),s(i,j,k+1,ks))<a name='3596'>
                smaxv=max(s(i,j,k-1,ks),s(i,j,k  ,ks),s(i,j,k+1,ks))<a name='3597'>
              elseif(k.eq.kts) then<a name='3598'>
                sminv=min(s(i,j,k  ,ks),s(i,j,k+1,ks))<a name='3599'>
                smaxv=max(s(i,j,k  ,ks),s(i,j,k+1,ks))<a name='3600'>
              elseif(k.eq.kte) then<a name='3601'>
                sminv=min(s(i,j,k-1,ks),s(i,j,k  ,ks))<a name='3602'>
                smaxv=max(s(i,j,k-1,ks),s(i,j,k  ,ks))<a name='3603'>
              endif<a name='3604'>
<font color=#447700>!<a name='3605'></font>
              smin=min(sminh,sminv)<a name='3606'>
              smax=max(smaxh,smaxv)<a name='3607'>
<font color=#447700>!<a name='3608'></font>
              sn=s1p<a name='3609'>
              if(sn.gt.steep*smax) sn=smax<a name='3610'>
              if(sn.lt.      smin) sn=smin<a name='3611'>
<font color=#447700>!<a name='3612'></font>
              dsks=(sn-s1p)*dvol(i,j,k)<a name='3613'>
              s1(i,j,k,ks)=dsks<a name='3614'>
              if(dsks.gt.0.) then<a name='3615'>
                xsms(2*ks-1,k)=xsms(2*ks-1,k)+dsks<a name='3616'>
              else<a name='3617'>
                xsms(2*ks  ,k)=xsms(2*ks  ,k)+dsks<a name='3618'>
              endif<a name='3619'>
<font color=#447700>!<a name='3620'></font>
            enddo<a name='3621'>
          enddo<a name='3622'>
        enddo<a name='3623'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3624'></font>
      enddo <font color=#447700>! end of the loop by species<a name='3625'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3626'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3627'></font>
<font color=#447700>!***  GLOBAL REDUCTION<a name='3628'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3629'></font>
<font color=#447700>!<a name='3630'></font>
# if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3631'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>WRF_GET_DM_COMMUNICATOR</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#MONO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_4">(MPI_COMM_COMP)<a name='3632'>
      lngth=(2*kse-2*kss+2)*(KTE-KTS+1)<a name='3633'>
      CALL MPI_ALLREDUCE(XSMS,GSMS,lngth                              &amp;<a name='3634'>
     &amp;                  ,MPI_DOUBLE_PRECISION,MPI_SUM                   &amp;<a name='3635'>
     &amp;                  ,MPI_COMM_COMP,IRECV)<a name='3636'>
# else<a name='3637'>
      DO K=KTS,KTE<a name='3638'>
        do ks=kss,kse<a name='3639'>
          gsms(2*ks-1,k)=xsms(2*ks-1,k)<a name='3640'>
          gsms(2*ks  ,k)=xsms(2*ks  ,k)<a name='3641'>
        enddo<a name='3642'>
      enddo<a name='3643'>
# endif<a name='3644'>
<font color=#447700>!<a name='3645'></font>
      DO K=KTS,KTE<a name='3646'>
        do ks=kss,kse<a name='3647'>
          gsms_single(2*ks-1,k)=gsms(2*ks-1,k)<a name='3648'>
          gsms_single(2*ks  ,k)=gsms(2*ks  ,k)<a name='3649'>
        enddo<a name='3650'>
      enddo<a name='3651'>
<font color=#447700>!<a name='3652'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3653'></font>
<font color=#447700>!***  END OF GLOBAL REDUCTION<a name='3654'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3655'></font>
<font color=#447700>!<a name='3656'></font>
<font color=#447700>!dusan!---forced conservation after monotonization----------------------------<a name='3657'></font>
<font color=#447700>!dusan      do ks=kss,kse<a name='3658'></font>
<font color=#447700>!dusan        DO K=KTS,KTE<a name='3659'></font>
<font color=#447700>!dusan          sumps=gsms_single(2*ks-1,k)<a name='3660'></font>
<font color=#447700>!dusan          sumns=gsms_single(2*ks  ,k)<a name='3661'></font>
<font color=#447700>!dusan!<a name='3662'></font>
<font color=#447700>!dusan          if(sumps*(-sumns).gt.1.) then<a name='3663'></font>
<font color=#447700>!dusan            sfacs=-sumns/sumps<a name='3664'></font>
<font color=#447700>!dusan            rfacs=1./sfacs<a name='3665'></font>
<font color=#447700>!dusan          else<a name='3666'></font>
<font color=#447700>!dusan            sfacs=0.<a name='3667'></font>
<font color=#447700>!dusan            rfacs=0.<a name='3668'></font>
<font color=#447700>!dusan          endif<a name='3669'></font>
<font color=#447700>!dusan!<a name='3670'></font>
<font color=#447700>!dusan          DO J=MYJS2,MYJE2<a name='3671'></font>
<font color=#447700>!dusan            DO I=MYIS1,MYIE1<a name='3672'></font>
<font color=#447700>!dusan              dsks=s1(i,j,k,ks)*rdvol(i,j,k)<a name='3673'></font>
<font color=#447700>!dusan              if(sfacs.gt.1.) then<a name='3674'></font>
<font color=#447700>!dusan                if(dsks.lt.0.) dsks=dsks*rfacs<a name='3675'></font>
<font color=#447700>!dusan!zjtest                if(dsks.lt.0.) dsks=dsks<a name='3676'></font>
<font color=#447700>!dusan              else<a name='3677'></font>
<font color=#447700>!dusan                if(dsks.ge.0.) dsks=dsks*sfacs<a name='3678'></font>
<font color=#447700>!dusan              endif<a name='3679'></font>
<font color=#447700>!dusan              tcs(i,j,k,ks)=tcs(i,j,k,ks)+dsks<a name='3680'></font>
<font color=#447700>!dusan            enddo<a name='3681'></font>
<font color=#447700>!dusan          enddo<a name='3682'></font>
<font color=#447700>!dusan        enddo<a name='3683'></font>
<font color=#447700>!dusan!-----------------------------------------------------------------------<a name='3684'></font>
<font color=#447700>!dusan      enddo ! end of the loop by species<a name='3685'></font>
<a name='3686'>
<font color=#447700>!---forced conservation after monotonization----------------------------<a name='3687'></font>
      do ks=kss,kse<a name='3688'>
        vgsums(2*ks-1)=0.<a name='3689'>
        vgsums(2*ks  )=0.<a name='3690'>
        DO K=KTS,KTE<a name='3691'>
          vgsums(2*ks-1)=gsms(2*ks-1,k)+vgsums(2*ks-1)<a name='3692'>
          vgsums(2*ks  )=gsms(2*ks  ,k)+vgsums(2*ks  )<a name='3693'>
        enddo<a name='3694'>
      enddo<a name='3695'>
<a name='3696'>
      do ks=kss,kse<a name='3697'>
        sumps=vgsums(2*ks-1)<a name='3698'>
        sumns=vgsums(2*ks  )<a name='3699'>
<font color=#447700>!<a name='3700'></font>
        if(sumps*(-sumns).gt.1.) then<a name='3701'>
          sfacs=-sumns/sumps<a name='3702'>
          rfacs=1./sfacs<a name='3703'>
        else<a name='3704'>
          sfacs=0.<a name='3705'>
          rfacs=0.<a name='3706'>
        endif<a name='3707'>
<font color=#447700>!<a name='3708'></font>
        DO K=KTS,KTE<a name='3709'>
          DO J=MYJS2,MYJE2<a name='3710'>
            DO I=MYIS1,MYIE1<a name='3711'>
              dsks=s1(i,j,k,ks)*rdvol(i,j,k)<a name='3712'>
              if(sfacs.lt.1.) then<a name='3713'>
                if(dsks.gt.0.) dsks=dsks*sfacs<a name='3714'>
              endif<a name='3715'>
              tcs(i,j,k,ks)=tcs(i,j,k,ks)+dsks<a name='3716'>
            enddo<a name='3717'>
          enddo<a name='3718'>
        enddo<a name='3719'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3720'></font>
      enddo <font color=#447700>! end of the loop by species<a name='3721'></font>
109   continue<a name='3722'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3723'></font>
<font color=#447700>!zjwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww<a name='3724'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3725'></font>
      do ks=kss,kse <font color=#447700>! loop by species<a name='3726'></font>
        DO K=KTS,KTE<a name='3727'>
          xsms(2*ks-1,k)=0.<a name='3728'>
          xsms(2*ks  ,k)=0.<a name='3729'>
          gsms(2*ks-1,k)=0.<a name='3730'>
          gsms(2*ks  ,k)=0.<a name='3731'>
<font color=#447700>!<a name='3732'></font>
          DO J=MYJS2,MYJE2<a name='3733'>
            DO I=MYIS1,MYIE1<a name='3734'>
              xsms(2*ks-1,k)=xsms(2*ks-1,k)+s  (i,j,k,ks)*dvol(i,j,k)<a name='3735'>
              xsms(2*ks  ,k)=xsms(2*ks  ,k)+tcs(i,j,k,ks)*dvol(i,j,k)<a name='3736'>
            enddo<a name='3737'>
          enddo<a name='3738'>
        enddo<a name='3739'>
      enddo<a name='3740'>
<font color=#447700>!<a name='3741'></font>
      xsmp=0.<a name='3742'>
      DO J=MYJS2,MYJE2<a name='3743'>
        DO I=MYIS1,MYIE1<a name='3744'>
          xsmp=pd(i,j)*dx(i,j)*dy*hbm2(i,j)+xsmp<a name='3745'>
        enddo<a name='3746'>
      enddo<a name='3747'>
<font color=#447700>!<a name='3748'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3749'></font>
<font color=#447700>!***  GLOBAL REDUCTION<a name='3750'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3751'></font>
<font color=#447700>!<a name='3752'></font>
# if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3753'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>WRF_GET_DM_COMMUNICATOR</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#MONO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_5">(MPI_COMM_COMP)<a name='3754'>
      lngth=1<a name='3755'>
      CALL MPI_ALLREDUCE(xsmp,gsmp,lngth                                &amp;<a name='3756'>
     &amp;                  ,MPI_DOUBLE_PRECISION,MPI_SUM                   &amp;<a name='3757'>
     &amp;                  ,MPI_COMM_COMP,IRECV)<a name='3758'>
# else<a name='3759'>
      gsmp=xsmp<a name='3760'>
# endif<a name='3761'>
<font color=#447700>!<a name='3762'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3763'></font>
<font color=#447700>!***  END OF GLOBAL REDUCTION<a name='3764'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3765'></font>
<font color=#447700>!<a name='3766'></font>
<font color=#447700>!<a name='3767'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3768'></font>
<font color=#447700>!***  GLOBAL REDUCTION<a name='3769'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3770'></font>
<font color=#447700>!<a name='3771'></font>
# if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3772'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>WRF_GET_DM_COMMUNICATOR</A><A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#MONO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_6">(MPI_COMM_COMP)<a name='3773'>
      lngth=(2*kse-2*kss+2)*(KTE-KTS+1)<a name='3774'>
      CALL MPI_ALLREDUCE(XSMS,GSMS,lngth                                &amp;<a name='3775'>
     &amp;                  ,MPI_DOUBLE_PRECISION,MPI_SUM                   &amp;<a name='3776'>
     &amp;                  ,MPI_COMM_COMP,IRECV)<a name='3777'>
# else<a name='3778'>
      DO K=KTS,KTE<a name='3779'>
        do ks=kss,kse<a name='3780'>
          gsms(2*ks-1,k)=xsms(2*ks-1,k)<a name='3781'>
          gsms(2*ks  ,k)=xsms(2*ks  ,k)<a name='3782'>
        enddo<a name='3783'>
      enddo<a name='3784'>
# endif<a name='3785'>
<font color=#447700>!<a name='3786'></font>
      DO K=KTS,KTE<a name='3787'>
        do ks=kss,kse<a name='3788'>
          gsms_single(2*ks-1,k)=gsms(2*ks-1,k)<a name='3789'>
          gsms_single(2*ks  ,k)=gsms(2*ks  ,k)<a name='3790'>
        enddo<a name='3791'>
      enddo<a name='3792'>
<font color=#447700>!<a name='3793'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3794'></font>
<font color=#447700>!***  END OF GLOBAL REDUCTION<a name='3795'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3796'></font>
<font color=#447700>!<a name='3797'></font>
<a name='3798'>
      do ks=kss,kse<a name='3799'>
        vgsms(2*ks-1)=0.<a name='3800'>
        vgsms(2*ks  )=0.<a name='3801'>
      enddo<a name='3802'>
<font color=#447700>!<a name='3803'></font>
      do ks=kss,kse<a name='3804'>
        DO K=KTS,KTE<a name='3805'>
          vgsms(2*ks-1)=gsms(2*ks-1,k)+vgsms(2*ks-1)<a name='3806'>
          vgsms(2*ks  )=gsms(2*ks  ,k)+vgsms(2*ks  )<a name='3807'>
        enddo<a name='3808'>
      enddo<a name='3809'>
<font color=#447700>!<a name='3810'></font>
      sumdrrw=vgsms(6)+sumdrrw<a name='3811'>
<font color=#447700>!<a name='3812'></font>
      summass=0.0<a name='3813'>
      DO K=KTS,KTE<a name='3814'>
        DO J=MYJS2,MYJE2<a name='3815'>
          DO I=MYIS1,MYIE1<a name='3816'>
            summass=summass+dvol(i,j,k)<a name='3817'>
          ENDDO<a name='3818'>
        ENDDO<a name='3819'>
      ENDDO<a name='3820'>
<font color=#447700>!<a name='3821'></font>
      if (first) then<a name='3822'>
         sumrrw_first = vgsms(5)<a name='3823'>
         gsmp_first = gsmp<a name='3824'>
         summass_first = summass<a name='3825'>
         first=.false.<a name='3826'>
      end if<a name='3827'>
<font color=#447700>!<a name='3828'></font>
<font color=#447700>!     write(0,1000) ntsd,hours, &amp;                                       ! 4,5<a name='3829'></font>
<font color=#447700>!                   (vgsms(ks),ks=2*kss-1,2*kse), &amp;                     ! 6-13<a name='3830'></font>
<font color=#447700>!                   gsmp,gsmp_first,gsmp/gsmp_first, &amp;                  ! 14-16<a name='3831'></font>
<font color=#447700>!                   sumdrrw, &amp;                                          ! 17<a name='3832'></font>
<font color=#447700>!                   vgsms(5)/sumrrw_first,sumrrw_first, &amp;               ! 18-19<a name='3833'></font>
<font color=#447700>!                   summass,summass_first,summass/summass_first         ! 20-22<a name='3834'></font>
 1000 format('global vol sums ',i6,f8.3,30d13.5)<a name='3835'>
<font color=#447700>!zjmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm<a name='3836'></font>
                        endsubroutine mono<a name='3837'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3838'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3839'></font>
<font color=#447700>!<a name='3840'></font>
      END MODULE MODULE_ADVECTION<a name='3841'>
<font color=#447700>!<a name='3842'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3843'></font>
</pre></body></html>