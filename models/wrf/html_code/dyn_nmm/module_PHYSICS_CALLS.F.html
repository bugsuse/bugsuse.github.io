<HTML> <BODY BGCOLOR=#bbeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!NCEP_MESO:MODEL_LAYER: PHYSICS<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6'></font>
#include "<A href='../../html_code/include/nmm_loop_basemacros.h.html'>nmm_loop_basemacros.h</A>"<A NAME="nmm_loop_basemacros.h_1"><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='7'>
#include "<A href='../../html_code/include/nmm_loop_macros.h.html'>nmm_loop_macros.h</A>"<A NAME="nmm_loop_macros.h_2"><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='8'>
<font color=#447700>!-----------------------------------------------------------------------<a name='9'></font>
<font color=#447700>!<a name='10'></font>
<A NAME='MODULE_PHYSICS_CALLS'><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#MODULE_PHYSICS_CALLS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='11'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_PHYSICS_CALLS</font> <A href='../../call_to/MODULE_PHYSICS_CALLS.html' TARGET='index'>1</A><a name='12'>
<font color=#447700>!<a name='13'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='14'></font>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>MODULE_DOMAIN</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_42"><a name='15'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>MODULE_DM</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_35"><a name='16'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>MODULE_CONFIGURE</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_27"><a name='17'>
      USE <A href='../../html_code/frame/module_tiles.F.html#MODULE_TILES'>MODULE_TILES</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TILES_8"><a name='18'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>MODULE_STATE_DESCRIPTION</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_24">,ONLY : P_QV,P_QC,P_QR,P_QI,P_QS,P_QG,P_QNI,P_QNR<a name='19'>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_29"><a name='20'>
      USE <A href='../../html_code/phys/module_ra_gfdleta.F.html#MODULE_RA_GFDLETA'>MODULE_RA_GFDLETA</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_GFDLETA_1">,ONLY : CAL_MON_DAY,ZENITH<a name='21'>
      USE <A href='../../html_code/phys/module_radiation_driver.F.html#MODULE_RADIATION_DRIVER'>MODULE_RADIATION_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RADIATION_DRIVER_2"><a name='22'>
      USE <A href='../../html_code/phys/module_sf_myjsfc.F.html#MODULE_SF_MYJSFC'>MODULE_SF_MYJSFC</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_MYJSFC_1"><a name='23'>
      USE <A href='../../html_code/phys/module_surface_driver.F.html#MODULE_SURFACE_DRIVER'>MODULE_SURFACE_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SURFACE_DRIVER_2"><a name='24'>
      USE <A href='../../html_code/phys/module_pbl_driver.F.html#MODULE_PBL_DRIVER'>MODULE_PBL_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PBL_DRIVER_2"><a name='25'>
      USE <A href='../../html_code/dyn_nmm/module_GWD.F.html#MODULE_GWD'>MODULE_GWD</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GWD_1"><a name='26'>
      USE <A href='../../html_code/phys/module_cu_bmj.F.html#MODULE_CU_BMJ'>MODULE_CU_BMJ</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CU_BMJ_1"><a name='27'>
      USE <A href='../../html_code/phys/module_cumulus_driver.F.html#MODULE_CUMULUS_DRIVER'>MODULE_CUMULUS_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CUMULUS_DRIVER_2"><a name='28'>
      USE <A href='../../html_code/phys/module_mp_etanew.F.html#MODULE_MP_ETANEW'>MODULE_MP_ETANEW</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_ETANEW_2"><a name='29'>
      USE <A href='../../html_code/phys/module_microphysics_driver.F.html#MODULE_MICROPHYSICS_DRIVER'>MODULE_MICROPHYSICS_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MICROPHYSICS_DRIVER_2"><a name='30'>
      USE <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MODULE_MICROPHYSICS_ZERO_OUT'>MODULE_MICROPHYSICS_ZERO_OUT</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#module_PHYSICS_CALLS.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MICROPHYSICS_ZERO_OUT_2"><a name='31'>
<font color=#447700>!-----------------------------------------------------------------------<a name='32'></font>
<font color=#447700>!<a name='33'></font>
      CONTAINS<a name='34'>
<font color=#447700>!<a name='35'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='36'></font>
<font color=#447700>!***********************************************************************<a name='37'></font>
<A NAME='QITEND_FER_HIRES_ADVECT'><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#QITEND_FER_HIRES_ADVECT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='38'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>QITEND_FER_HIRES_ADVECT</font>(QI,QRIMEF,QITEND) <A href='../../call_to/QITEND_FER_HIRES_ADVECT.html' TARGET='index'>2</A><a name='39'>
        IMPLICIT NONE<a name='40'>
        REAL, INTENT(INOUT) :: QI, QRIMEF<a name='41'>
        REAL, INTENT(IN) :: QITEND<a name='42'>
        REAL :: F_RIMEF<a name='43'>
        real, parameter :: max_f_rimef = 60.0, min_f_rimef=1.0<a name='44'>
<a name='45'>
        <font color=#447700>! For the advected Ferrier-Aligo, we have to handle the QRIMEF<a name='46'></font>
        <font color=#447700>! during tendency updates.<a name='47'></font>
<a name='48'>
        <font color=#447700>! Determine old rime factor from old QI and old QRIMEF:<a name='49'></font>
        IF(QI&lt;EPSQ) THEN<a name='50'>
           F_RIMEF=1.<a name='51'>
        ELSE<a name='52'>
           F_RIMEF=max(min_f_rimef,min(max_f_rimef,QRIMEF/QI))<a name='53'>
        ENDIF<a name='54'>
<a name='55'>
        <font color=#447700>! Decide new QI and new QRIMEF based on QC and RQIBLTEN:<a name='56'></font>
        QI=QI+QITEND<a name='57'>
        IF(QI&lt;EPSQ) THEN<a name='58'>
           QRIMEF=QI<a name='59'>
        ELSE<a name='60'>
           QRIMEF=QI*F_RIMEF<a name='61'>
        ENDIF<a name='62'>
      END SUBROUTINE QITEND_FER_HIRES_ADVECT<a name='63'>
<a name='64'>
<font color=#447700>!***********************************************************************<a name='65'></font>
<a name='66'>
<A NAME='RADIATION'><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#RADIATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='67'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>RADIATION</font>(NTSD,DT,JULDAY,JULYR,XTIME,JULIAN            &amp; <A href='../../call_to/RADIATION.html' TARGET='index'>2</A>,<A href='../../call_from/RADIATION.html' TARGET='index'>6</A><a name='68'>
     &amp;                    ,IHRST,NPHS,GLAT,GLON                         &amp;<a name='69'>
     &amp;                    ,NRADS,NRADL                                  &amp;<a name='70'>
     &amp;                    ,DETA1,DETA2,AETA1,AETA2,ETA1,ETA2,PDTOP,PT   &amp;<a name='71'>
     &amp;                    ,PD,RES,PINT,T,Q,MOIST,THS,ALBEDO,EPSR        &amp;<a name='72'>
     &amp;                    ,F_ICE,F_RAIN                                 &amp;<a name='73'>
     &amp;                    ,GD_CLOUD,GD_CLOUD2                           &amp;<a name='74'>
     &amp;                    ,SM,HBM2,CLDFRA,N_MOIST,RESTRT                &amp;<a name='75'>
     &amp;                    ,RLWTT,RSWTT,RLWIN,RSWIN,RSWINC,RSWOUT        &amp;<a name='76'>
     &amp;                    ,RLWTOA,RSWTOA,CZMEAN                         &amp;<a name='77'>
     &amp;                    ,CFRACL,CFRACM,CFRACH,SIGT4                   &amp;<a name='78'>
     &amp;                    ,ACFRST,NCFRST,ACFRCV,NCFRCV                  &amp;<a name='79'>
     &amp;                    ,CUPPT,VEGFRC,SNOW,HTOP,HBOT                  &amp;<a name='80'>
     &amp;                    ,Z,SICE,NUM_AEROSOLC,NUM_OZMIXM,OZMIXM,PIN    &amp;<a name='81'>
     &amp;                    ,LEVSIZ,GRID,CONFIG_FLAGS                     &amp;<a name='82'>
     &amp;                    ,RTHRATEN                                     &amp;<a name='83'>
     &amp;                    ,re_cloud,re_ice,re_snow                      &amp; <font color=#447700>! G. Thompson<a name='84'></font>
     &amp;                    ,has_reqc,has_reqi,has_reqs                   &amp; <font color=#447700>! G. Thompson<a name='85'></font>
     &amp;                    ,SWUPT,SWUPTC,SWDNT,SWDNTC                    &amp;<a name='86'>
     &amp;                    ,SWUPB,SWUPBC,SWDNB,SWDNBC                    &amp;<a name='87'>
     &amp;                    ,LWUPT,LWUPTC,LWDNT,LWDNTC                    &amp;<a name='88'>
     &amp;                    ,LWUPB,LWUPBC,LWDNB,LWDNBC                    &amp;<a name='89'>
     &amp;                    ,ACSWUPT,ACSWUPTC,ACSWDNT,ACSWDNTC            &amp;<a name='90'>
     &amp;                    ,ACSWUPB,ACSWUPBC,ACSWDNB,ACSWDNBC            &amp;<a name='91'>
     &amp;                    ,ACLWUPT,ACLWUPTC,ACLWDNT,ACLWDNTC            &amp;<a name='92'>
     &amp;                    ,ACLWUPB,ACLWUPBC,ACLWDNB,ACLWDNBC            &amp;<a name='93'>
     &amp;                    ,SWVISDIR ,SWVISDIF                           &amp;  <font color=#447700>!ssib<a name='94'></font>
     &amp;                    ,SWNIRDIR, SWNIRDIF &amp;                            <font color=#447700>!ssib<a name='95'></font>
     &amp;                    ,IDS,IDE,JDS,JDE,KDS,KDE                      &amp;<a name='96'>
     &amp;                    ,IMS,IME,JMS,JME,KMS,KME                      &amp;<a name='97'>
     &amp;                    ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='98'>
<font color=#447700>!***  NOTE ***<a name='99'></font>
<font color=#447700>! RLWIN  - downward longwave at the surface (=TOTLWDN, now a local array)<a name='100'></font>
<font color=#447700>! RSWIN  - downward shortwave at the surface (=TOTSWDN, now a local array)<a name='101'></font>
<font color=#447700>! RSWINC - CLEAR-SKY downward shortwave at the surface (=TOTSWDNC, new for AQ)<a name='102'></font>
<font color=#447700>!***********************************************************************<a name='103'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='104'></font>
<font color=#447700>!                .      .    .<a name='105'></font>
<font color=#447700>! SUBPROGRAM:    RADIATION   RADIATION OUTER DRIVER<a name='106'></font>
<font color=#447700>!   PRGRMMR: BLACK           ORG: W/NP22     DATE: 2002-06-04<a name='107'></font>
<font color=#447700>!<a name='108'></font>
<font color=#447700>! ABSTRACT:<a name='109'></font>
<font color=#447700>!     RADIATION SERVES AS THE INTERFACE BETWEEN THE NCEP NONHYDROSTATIC<a name='110'></font>
<font color=#447700>!     MESOSCALE MODEL AND THE WRF RADIATION DRIVER.<a name='111'></font>
<font color=#447700>!<a name='112'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='113'></font>
<font color=#447700>!   02-06-04  BLACK      - ORIGINATOR<a name='114'></font>
<font color=#447700>!   02-09-09  WOLFE      - CONVERTING TO GLOBAL INDEXING<a name='115'></font>
<font color=#447700>!   04-11-18  BLACK      - THREADED<a name='116'></font>
<font color=#447700>!   05-12-15  BLACK      - CONVERTED FROM IKJ TO IJK<a name='117'></font>
<font color=#447700>!<a name='118'></font>
<font color=#447700>! USAGE: CALL RADIATION FROM SOLVE_NMM<a name='119'></font>
<font color=#447700>!<a name='120'></font>
<font color=#447700>! ATTRIBUTES:<a name='121'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='122'></font>
<font color=#447700>!   MACHINE : IBM<a name='123'></font>
<font color=#447700>!$$$<a name='124'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='125'></font>
<font color=#447700>!<a name='126'></font>
      IMPLICIT NONE<a name='127'>
<font color=#447700>!<a name='128'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='129'></font>
<font color=#447700>!<a name='130'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='131'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='132'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='133'>
     &amp;                     ,IHRST,JULDAY,JULYR                          &amp;<a name='134'>
     &amp;                     ,N_MOIST,NPHS,NRADL,NRADS,NTSD               &amp;<a name='135'>
     &amp;                     ,NUM_AEROSOLC,NUM_OZMIXM,LEVSIZ<a name='136'>
      REAL, INTENT(IN) :: OZMIXM(ims:ime,LEVSIZ,jms:jme,num_ozmixm), PIN(LEVSIZ)<a name='137'>
<font color=#447700>!<a name='138'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: NCFRCV,NCFRST<a name='139'>
<font color=#447700>!<a name='140'></font>
      REAL,INTENT(IN) :: DT,PDTOP,PT,XTIME,JULIAN<a name='141'>
<font color=#447700>!<a name='142'></font>
      REAL,DIMENSION(KMS:KME-1),INTENT(IN) :: AETA1,AETA2,DETA1,DETA2<a name='143'>
<font color=#447700>!<a name='144'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: ETA1,ETA2<a name='145'>
<font color=#447700>!<a name='146'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: ALBEDO              &amp;<a name='147'>
     &amp;                                             ,EPSR,GLAT,GLON      &amp;<a name='148'>
     &amp;                                             ,HBM2                &amp;<a name='149'>
     &amp;                                             ,PD,RES,SICE,SM      &amp;<a name='150'>
     &amp;                                             ,SNOW,THS,VEGFRC<a name='151'>
<font color=#447700>!<a name='152'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: CUPPT<a name='153'>
<a name='154'>
<font color=#447700>!<a name='155'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: Q,T,Z<a name='156'>
<font color=#447700>!<a name='157'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: F_ICE       &amp;   <font color=#447700>!&lt;--- Used only with physics (IKJ)<a name='158'></font>
     &amp;                                                     ,F_RAIN<a name='159'>
<font color=#447700>!<a name='160'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: RTHRATEN     <font color=#447700>!&lt;--- Used only with physics (IKJ)<a name='161'></font>
<font color=#447700>!<a name='162'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,N_MOIST)                   &amp;<a name='163'>
                                                 ,INTENT(INOUT) :: MOIST<a name='164'>
<font color=#447700>!<a name='165'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: ACFRCV,ACFRST    &amp;<a name='166'>
     &amp;                                                ,HBOT,HTOP        &amp;<a name='167'>
     &amp;                                                ,RLWIN,RLWTOA     &amp;<a name='168'>
     &amp;                                                ,RSWIN,RSWOUT     &amp;<a name='169'>
     &amp;                                                ,RSWINC,RSWTOA<a name='170'>
<font color=#447700>!<a name='171'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: PINT     &amp;<a name='172'>
     &amp;                                                        ,RLWTT    &amp;<a name='173'>
     &amp;                                                        ,RSWTT<a name='174'>
<font color=#447700>!<a name='175'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: CFRACH,CFRACL    &amp;<a name='176'>
     &amp;                                                ,CFRACM,CZMEAN    &amp;<a name='177'>
     &amp;                                                ,SIGT4<a name='178'>
<a name='179'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME ),INTENT(IN) ::            &amp;   <font color=#447700>!&lt;--- Used only with physics (IKJ)<a name='180'></font>
     &amp;                              GD_CLOUD,GD_CLOUD2                  <a name='181'>
<font color=#447700>!<a name='182'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: CLDFRA<a name='183'>
<a name='184'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) ::          &amp;<a name='185'>
                      ACSWUPT,ACSWUPTC,ACSWDNT,ACSWDNTC,          &amp;<a name='186'>
                      ACSWUPB,ACSWUPBC,ACSWDNB,ACSWDNBC,          &amp;<a name='187'>
                      ACLWUPT,ACLWUPTC,ACLWDNT,ACLWDNTC,          &amp;<a name='188'>
                      ACLWUPB,ACLWUPBC,ACLWDNB,ACLWDNBC<a name='189'>
<a name='190'>
<font color=#447700>! TOA and surface, upward and downward, total and clear fluxes<a name='191'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) ::          &amp;<a name='192'>
                        SWUPT,  SWUPTC,  SWDNT,  SWDNTC,          &amp;<a name='193'>
                        SWUPB,  SWUPBC,  SWDNB,  SWDNBC,          &amp;<a name='194'>
                        LWUPT,  LWUPTC,  LWDNT,  LWDNTC,          &amp;<a name='195'>
                        LWUPB,  LWUPBC,  LWDNB,  LWDNBC<a name='196'>
<a name='197'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='198'>
         INTENT(OUT  )  ::                              SWVISDIR, &amp;<a name='199'>
                                                        SWVISDIF, &amp;<a name='200'>
                                                        SWNIRDIR, &amp;<a name='201'>
                                                        SWNIRDIF<a name='202'>
<a name='203'>
<font color=#447700>!<a name='204'></font>
<font color=#447700>!..Additions for coupling cloud physics effective radii and radiation.  G. Thompson<a name='205'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN):: re_cloud, re_ice, re_snow<a name='206'>
      INTEGER, INTENT(IN):: has_reqc, has_reqi, has_reqs<a name='207'>
<font color=#447700>!<a name='208'></font>
      LOGICAL,INTENT(IN) :: RESTRT<a name='209'>
<font color=#447700>!<a name='210'></font>
      TYPE(DOMAIN),TARGET :: GRID<a name='211'>
<font color=#447700>!<a name='212'></font>
      TYPE(GRID_CONFIG_REC_TYPE),INTENT(IN) :: CONFIG_FLAGS<a name='213'>
<font color=#447700>!<a name='214'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='215'></font>
<font color=#447700>!***<a name='216'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='217'></font>
<font color=#447700>!***<a name='218'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='219'></font>
      INTEGER :: I,IENDX,II,ISTAT,J,JDAY,JMONTH,K,KMNTH,N,NRAD<a name='220'>
<font color=#447700>!<a name='221'></font>
      INTEGER,DIMENSION(3) :: IDAT<a name='222'>
      INTEGER,DIMENSION(12) :: MONTH=(/31,28,31,30,31,30,31,31          &amp;<a name='223'>
     &amp;                                ,30,31,30,31/)<a name='224'>
<font color=#447700>!<a name='225'></font>
      REAL :: CAPA,DAYI,DPL,FICE,FRAIN,GMT,HOUR,PLYR,PSFC               &amp;<a name='226'>
     &amp;       ,QI,QR,QW,RADT,TIMES,WC,TDUM<a name='227'>
<font color=#447700>!<a name='228'></font>
      REAL,DIMENSION(KMS:KME-1) :: QL,TL<a name='229'>
<font color=#447700>!<a name='230'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME) :: CUPPTR,CZEN,HBOTR,HTOPR        &amp;<a name='231'>
     &amp;                                  ,SWCF, LWCF                     &amp;<a name='232'>
     &amp;                                  ,PDSL,REXNSFC,SWNETDN           &amp;<a name='233'>
     &amp;                                  ,TOT,TOTLWDN,TOTSWDN,TOTSWDNC   &amp;<a name='234'>
     &amp;                                  ,TSFC,XLAND,XLAT,XLON, HT<a name='235'>
<font color=#447700>!<a name='236'></font>
<font color=#447700>!<a name='237'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME) :: CLFR,DZ                &amp;   <font color=#447700>!&lt;--- Used only with physics (IKJ)<a name='238'></font>
     &amp;                                          ,P8W,P_PHY,PI_PHY       &amp;<a name='239'>
     &amp;                                          ,RR,T8W                 &amp;<a name='240'>
     &amp;                                          ,THRATENLW,THRATENSW    &amp;<a name='241'>
     &amp;                                          ,TH_PHY,T_PHY,Z_PHY<a name='242'>
<font color=#447700>!<a name='243'></font>
      REAL,DIMENSION(:,:,:,:),ALLOCATABLE :: MOIST_TRANS<a name='244'>
<font color=#447700>!<a name='245'></font>
      LOGICAL :: WARM_RAIN<a name='246'>
      LOGICAL :: IS_CAMMGMP_USED=.FALSE.<a name='247'>
<a name='248'>
      REAL :: DXKM, DYKM<a name='249'>
<a name='250'>
<font color=#447700>!<a name='251'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='252'></font>
<font color=#447700>!***********************************************************************<a name='253'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='254'></font>
<font color=#447700>!*****<a name='255'></font>
<font color=#447700>!***** NOTE: THIS IS HARDWIRED FOR CALLS TO LONGWAVE AND SHORTWAVE<a name='256'></font>
<font color=#447700>!*****       AT EQUAL INTERVALS<a name='257'></font>
<font color=#447700>!*****<a name='258'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='259'></font>
<font color=#447700>!<a name='260'></font>
      NRAD=NRADS<a name='261'>
      RADT=DT*NRADS/60.<a name='262'>
<font color=#447700>!<a name='263'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='264'></font>
<font color=#447700>!<a name='265'></font>
      ALLOCATE(MOIST_TRANS(IMS:IME,KMS:KME,JMS:JME,N_MOIST),STAT=ISTAT)<a name='266'>
<font color=#447700>!<a name='267'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='268'></font>
<font color=#447700>!<a name='269'></font>
      CAPA=R_D/CP<a name='270'>
<a name='271'>
      DXKM=grid%dlmd*0.01745329*6371200. <font color=#447700>! numbers from module_initialize_real.F<a name='272'></font>
      DYKM=grid%dy_nmm<a name='273'>
<font color=#447700>!<a name='274'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='275'></font>
<font color=#447700>!<a name='276'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='277'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='278'></font>
      DO J=MYJS2,MYJE2<a name='279'>
      DO I=MYIS1,MYIE1<a name='280'>
<font color=#447700>!<a name='281'></font>
        PDSL(I,J)=PD(I,J)*RES(I,J)<a name='282'>
        P8W(I,KTE+1,J)=PT<a name='283'>
        XLAND(I,J)=SM(I,J)+1.<a name='284'>
        PSFC=PD(I,J)+PDTOP+PT<a name='285'>
        REXNSFC(I,J)=(PSFC*1.E-5)**CAPA<a name='286'>
        TSFC(I,J)=THS(I,J)*REXNSFC(I,J)<a name='287'>
        T8W(I,KTS,J)=TSFC(I,J)<a name='288'>
        P8W(I,KTS,J)=ETA1(KTS)*PDTOP+ETA2(KTS)*PDSL(I,J)+PT<a name='289'>
        Z_PHY(I,KTS,J)=Z(I,J,KTS)<a name='290'>
        HT(I,J)=Z(I,J,KTS)<a name='291'>
      ENDDO<a name='292'>
      ENDDO<a name='293'>
<font color=#447700>!<a name='294'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='295'></font>
<font color=#447700>!***  FILL THE SINGLE-COLUMN INPUT<a name='296'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='297'></font>
<font color=#447700>!<a name='298'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='299'></font>
<font color=#447700>!$omp&amp; private(dpl,i,j,k,plyr,ql,qr,tl)<a name='300'></font>
      DO J=MYJS2,MYJE2<a name='301'>
      DO I=MYIS1,MYIE1<a name='302'>
        DO K=KTS,KTE<a name='303'>
          DPL=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='304'>
          QL(K)=MAX(Q(I,J,K),EPSQ)<a name='305'>
          PLYR=AETA1(K)*PDTOP+AETA2(K)*PDSL(I,J)+PT<a name='306'>
          TL(K)=T(I,J,K)<a name='307'>
<font color=#447700>!<a name='308'></font>
          RR(I,K,J)=PLYR/(R_D*TL(K)*(1.+P608*QL(K)))<a name='309'>
          T_PHY(I,K,J)=TL(K)<a name='310'>
          TH_PHY(I,K,J)=TL(K)*(1.E5/PLYR)**CAPA<a name='311'>
          P8W(I,K+1,J)=ETA1(K+1)*PDTOP+ETA2(K+1)*PDSL(I,J)+PT<a name='312'>
          P_PHY(I,K,J)=PLYR<a name='313'>
          PI_PHY(I,K,J)=(PLYR*1.E-5)**CAPA<a name='314'>
          DZ(I,K,J)=TL(K)*(P608*QL(K)+1.)*R_D                           &amp;<a name='315'>
     &amp;                 *(P8W(I,K,J)-P8W(I,K+1,J))                       &amp;<a name='316'>
     &amp;                 /(P_PHY(I,K,J)*G)<a name='317'>
<font color=#447700>!<a name='318'></font>
          RTHRATEN(I,K,J)=0.<a name='319'>
          THRATENLW(I,K,J)=0.<a name='320'>
          THRATENSW(I,K,J)=0.<a name='321'>
<font color=#447700>!         PM2_5_DRY(I,K,J)=0.<a name='322'></font>
<font color=#447700>!         PM2_5_WATER(I,K,J)=0.<a name='323'></font>
<a name='324'>
        ENDDO<a name='325'>
<font color=#447700>!<a name='326'></font>
        DO K=KTS+1,KTE<a name='327'>
          T8W(I,K,J)=0.5*(TL(K-1)+TL(K))<a name='328'>
        ENDDO<a name='329'>
<font color=#447700>!        T8W(I,KTE+1,J)=-1.E20 <a name='330'></font>
<font color=#447700>! For RRTM <a name='331'></font>
        T8W(I,KTE+1,J)=T8W(I,KTE,J) + 0.5*(T8W(I,KTE,J)-T8W(I,KTE-1,J))<a name='332'>
<font color=#447700>!<a name='333'></font>
      ENDDO<a name='334'>
      ENDDO<a name='335'>
<font color=#447700>!<a name='336'></font>
      GMT=REAL(IHRST)<a name='337'>
<font color=#447700>!<a name='338'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='339'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='340'></font>
      DO K=KMS,KME<a name='341'>
        DO J=JMS,JME<a name='342'>
        DO I=IMS,IME<a name='343'>
          CLDFRA(I,J,K)=0.<a name='344'>
        ENDDO<a name='345'>
        ENDDO<a name='346'>
      ENDDO<a name='347'>
<font color=#447700>!<a name='348'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='349'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='350'></font>
      DO J=JMS,JME<a name='351'>
        DO I=IMS,IME<a name='352'>
          CFRACH(I,J)=0.<a name='353'>
          CFRACL(I,J)=0.<a name='354'>
          CFRACM(I,J)=0.<a name='355'>
          CZMEAN(I,J)=0.<a name='356'>
          SIGT4(I,J)=0.<a name='357'>
          TOTSWDN(I,J)=0.   <font color=#447700>! TOTAL (clear+cloudy sky) shortwave down at the surface<a name='358'></font>
          TOTSWDNC(I,J)=0.  <font color=#447700>! CLEAR SKY shortwave down at the surface<a name='359'></font>
          SWNETDN(I,J)=0.   <font color=#447700>! Net (down - up) total (clear+cloudy sky) shortwave at the surface<a name='360'></font>
          TOTLWDN(I,J)=0.   <font color=#447700>! Total longwave down at the surface<a name='361'></font>
          CUPPTR(I,J)=CUPPT(I,J)   <font color=#447700>! Temporary array set to zero in radiation<a name='362'></font>
          HTOPR(I,J) =0.<a name='363'>
          HBOTR(I,J) =0.<a name='364'>
          SWCF(I,J) =0.<a name='365'>
          LWCF(I,J) =0.<a name='366'>
<font color=#447700>!<a name='367'></font>
<font color=#447700>!-- NOTE:  HBOTR, HTOPR are passed into radiation and set equal to HBOT, HTOP.  HBOT, HTOP are<a name='368'></font>
<font color=#447700>!          reset to clear sky values to be used by the ARW.  At the bottom of this subroutine,<a name='369'></font>
<font color=#447700>!          HBOT, HTOP are re-defined again to values stored in HBOTR, HTOPR.  HBOT, HTOP are<a name='370'></font>
<font color=#447700>!          reset to clear sky values after the call to radiation and after the top of the hour<a name='371'></font>
<font color=#447700>!          in subroutine CUCNVC below.<a name='372'></font>
<font color=#447700>!<a name='373'></font>
        ENDDO<a name='374'>
      ENDDO<a name='375'>
<font color=#447700>!<a name='376'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='377'></font>
<font color=#447700>!***  TRANSPOSE THE MOIST ARRAY (IJK) FOR THE PHYSICS (IKJ).<a name='378'></font>
<font color=#447700>!***  REMEMBER THAT MOIST AND MOIST_TRANS ARE ONLY USED WITH<a name='379'></font>
<font color=#447700>!***  THE PHYSICS AND THUS THE P_QV SLOT (=2) IS MIXING RATIO,<a name='380'></font>
<font color=#447700>!***  NOT SPECIFIC HUMIDITY.<a name='381'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='382'></font>
<font color=#447700>!<a name='383'></font>
      DO N=1,N_MOIST<a name='384'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='385'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='386'></font>
        DO K=KMS,KME<a name='387'>
        DO J=JMS,JME<a name='388'>
        DO I=IMS,IME<a name='389'>
          MOIST_TRANS(I,K,J,N)=MOIST(I,J,K,N)<a name='390'>
        ENDDO<a name='391'>
        ENDDO<a name='392'>
        ENDDO<a name='393'>
      ENDDO<a name='394'>
<font color=#447700>!<a name='395'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='396'></font>
<font color=#447700>!<a name='397'></font>
<font color=#447700>!***  CALL THE INNER DRIVER.<a name='398'></font>
<font color=#447700>!<a name='399'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='400'></font>
<font color=#447700>!<a name='401'></font>
      CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>SET_TILES</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_5">(GRID,IDS+1,IDE-1,JDS+2,JDE-2,ITS,ITE,JTS,JTE)<a name='402'>
<font color=#447700>!<a name='403'></font>
      CALL <A href='../../html_code/phys/module_radiation_driver.F.html#RADIATION_DRIVER'>RADIATION_DRIVER</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_DRIVER_2">(                                            &amp;<a name='404'>
     &amp;                  IDS=IDS,IDE=IDE,JDS=JDS,JDE=JDE,KDS=KDS,KDE=KDE &amp;<a name='405'>
     &amp;                 ,IMS=IMS,IME=IME,JMS=JMS,JME=JME,KMS=KMS,KME=KME &amp;<a name='406'>
     &amp;                 ,I_START=GRID%I_START,I_END=GRID%I_END           &amp;<a name='407'>
     &amp;                 ,J_START=GRID%J_START,J_END=GRID%J_END           &amp;<a name='408'>
     &amp;                 ,KTS=KTS,KTE=KTE,NUM_TILES=GRID%NUM_TILES        &amp;<a name='409'>
     &amp;                 ,ITIMESTEP=NTSD,DT=DT                            &amp;<a name='410'>
     &amp;                 ,ICLOUD_CU=config_flags%ICLOUD_CU                &amp;<a name='411'>
     &amp;                 ,QC_CU=GRID%QC_CU,QI_CU=GRID%QI_CU               &amp;<a name='412'>
     &amp;                 ,DX=DXKM,DY=DYKM          &amp;<a name='413'>
     &amp;                 ,DXKM=dxkm                                       &amp;<a name='414'>
<font color=#447700>! WRF-Solar variables<a name='415'></font>
                       ,swint_opt=config_flags%swint_opt                &amp;   <a name='416'>
     &amp;       ,SWDDIR=grid%swddir,SWDDNI=grid%swddni,SWDDIF=grid%swddif     &amp; <font color=#447700>! jararias<a name='417'></font>
     &amp;       ,Gx=grid%Gx,Bx=grid%Bx,gg=grid%gg,bb=grid%bb                  &amp; <font color=#447700>! for sza-interpolation<a name='418'></font>
     &amp;       ,swdown_ref=grid%swdown_ref,swddir_ref=grid%swddir_ref        &amp; <font color=#447700>!<a name='419'></font>
     &amp;       ,coszen_ref=grid%coszen_ref                                   &amp; <a name='420'>
     &amp;       ,coszen=grid%coszen                                   &amp; <a name='421'>
     &amp;       ,hrang=grid%hrang                                   &amp; <a name='422'>
     &amp;       ,ht=ht                                   &amp; <a name='423'>
     &amp;       ,aer_type=config_flags%aer_type                                                        &amp;<a name='424'>
     &amp;       ,aer_aod550_opt=config_flags%aer_aod550_opt,aer_aod550_val=config_flags%aer_aod550_val &amp;<a name='425'>
     &amp;       ,aer_angexp_opt=config_flags%aer_angexp_opt,aer_angexp_val=config_flags%aer_angexp_val &amp;<a name='426'>
     &amp;       ,aer_ssa_opt=config_flags%aer_ssa_opt,aer_ssa_val=config_flags%aer_ssa_val             &amp;<a name='427'>
     &amp;       ,aer_asy_opt=config_flags%aer_asy_opt,aer_asy_val=config_flags%aer_asy_val             &amp;<a name='428'>
     &amp;                 ,RTHRATENLW=THRATENLW,RTHRATENSW=THRATENSW       &amp;<a name='429'>
     &amp;                 ,RTHRATEN=RTHRATEN                               &amp;<a name='430'>
     &amp;                 ,CEN_LAT=grid%cen_lat                            &amp;<a name='431'>
     &amp;                 ,GLW=TOTLWDN,GSW=SWNETDN,SWDOWN=TOTSWDN          &amp;<a name='432'>
     &amp;                 ,XLAT=grid%HLAT,XLONG=grid%HLON,ALBEDO=ALBEDO,EMISS=EPSR   &amp;<a name='433'>
     &amp;                 ,XICE=SICE,XLAND=XLAND,Z=Z,TSK=TSFC              &amp;<a name='434'>
     &amp;                 ,N_AEROSOLC=NUM_AEROSOLC,PAERLEV=GRID%PAERLEV    &amp;<a name='435'>
     &amp;                 ,ID=grid%id                                      &amp;<a name='436'>
     &amp;                 ,CAM_ABS_DIM1=GRID%CAM_ABS_DIM1                  &amp;<a name='437'>
     &amp;                 ,CAM_ABS_DIM2=GRID%CAM_ABS_DIM2                  &amp;<a name='438'>
     &amp;                 ,CAM_ABS_FREQ_S=GRID%CAM_ABS_FREQ_S              &amp;<a name='439'>
     &amp;                 ,ALEVSIZ=grid%alevsiz,no_src_types=grid%no_src_types   &amp;<a name='440'>
     &amp;                 ,LEVSIZ=LEVSIZ,N_OZMIXM=NUM_OZMIXM               &amp;<a name='441'>
     &amp;                 ,OZMIXM=OZMIXM,PIN=PIN                           &amp;<a name='442'>
     &amp;                 ,HTOP=HTOP,HBOT=HBOT,CUPPT=CUPPTR                &amp;<a name='443'>
     &amp;                 ,HTOPR=HTOPR,HBOTR=HBOTR                         &amp;<a name='444'>
     &amp;                 ,VEGFRA=VEGFRC,SNOW=SNOW                         &amp;<a name='445'>
     &amp;                 ,RHO=RR,P8W=P8W,P=P_PHY,PI=PI_PHY                &amp;<a name='446'>
     &amp;                 ,DZ8W=DZ,T=T_PHY,T8W=T8W,GMT=GMT                 &amp;<a name='447'>
     &amp;                 ,JULDAY=JULDAY,JULYR=JULYR,NPHS=NPHS             &amp;<a name='448'>
     &amp;                 ,JULIAN=JULIAN,XTIME=XTIME                       &amp;<a name='449'>
     &amp;                 ,YR=JULYR                                        &amp;<a name='450'>
     &amp;                 ,LW_PHYSICS=CONFIG_FLAGS%RA_LW_PHYSICS           &amp;<a name='451'>
     &amp;                 ,SW_PHYSICS=CONFIG_FLAGS%RA_SW_PHYSICS           &amp;<a name='452'>
     &amp;                 ,RADT=RADT,RA_CALL_OFFSET=GRID%RA_CALL_OFFSET    &amp;<a name='453'>
     &amp;                 ,STEPRA=NRAD,ICLOUD=config_flags%ICLOUD          &amp;<a name='454'>
     &amp;                 ,WARM_RAIN=WARM_RAIN                             &amp;<a name='455'>
     &amp;                 ,SWDOWNC=TOTSWDNC,CLDFRA=CLFR                    &amp;<a name='456'>
     &amp;                 ,SWUPT=SWUPT                                     &amp;<a name='457'>
     &amp;                 ,SWUPTC=SWUPTC                                   &amp;<a name='458'>
     &amp;                 ,SWDNT=SWDNT                                     &amp;<a name='459'>
     &amp;                 ,SWDNTC=SWDNTC                                   &amp;<a name='460'>
     &amp;                 ,SWUPB=SWUPB                                     &amp;<a name='461'>
     &amp;                 ,SWUPBC=SWUPBC                                   &amp;<a name='462'>
     &amp;                 ,SWDNB=SWDNB                                     &amp;<a name='463'>
     &amp;                 ,SWDNBC=SWDNBC                                   &amp;<a name='464'>
     &amp;                 ,LWUPT=LWUPT                                     &amp;<a name='465'>
     &amp;                 ,LWUPTC=LWUPTC                                   &amp;<a name='466'>
     &amp;                 ,LWDNT=LWDNT                                     &amp;<a name='467'>
     &amp;                 ,LWDNTC=LWDNTC                                   &amp;<a name='468'>
     &amp;                 ,LWUPB=LWUPB                                     &amp;<a name='469'>
     &amp;                 ,LWUPBC=LWUPBC                                   &amp;<a name='470'>
     &amp;                 ,LWDNB=LWDNB                                     &amp;<a name='471'>
     &amp;                 ,LWDNBC=LWDNBC                                   &amp;<a name='472'>
     &amp;                 ,ACSWUPT=ACSWUPT                                 &amp;<a name='473'>
     &amp;                 ,ACSWUPTC=ACSWUPTC                               &amp;<a name='474'>
     &amp;                 ,ACSWDNT=ACSWDNT                                 &amp;<a name='475'>
     &amp;                 ,ACSWDNTC=ACSWDNTC                               &amp;<a name='476'>
     &amp;                 ,ACSWUPB=ACSWUPB                                 &amp;<a name='477'>
     &amp;                 ,ACSWUPBC=ACSWUPBC                               &amp;<a name='478'>
     &amp;                 ,ACSWDNB=ACSWDNB                                 &amp;<a name='479'>
     &amp;                 ,ACSWDNBC=ACSWDNBC                               &amp;<a name='480'>
     &amp;                 ,ACLWUPT=ACLWUPT                                 &amp;<a name='481'>
     &amp;                 ,ACLWUPTC=ACLWUPTC                               &amp;<a name='482'>
     &amp;                 ,ACLWDNT=ACLWDNT                                 &amp;<a name='483'>
     &amp;                 ,ACLWDNTC=ACLWDNTC                               &amp;<a name='484'>
     &amp;                 ,ACLWUPB=ACLWUPB                                 &amp;<a name='485'>
     &amp;                 ,ACLWUPBC=ACLWUPBC                               &amp;<a name='486'>
     &amp;                 ,ACLWDNB=ACLWDNB                                 &amp;<a name='487'>
     &amp;                 ,ACLWDNBC=ACLWDNBC                               &amp;<a name='488'>
     &amp;        ,SWVISDIR=swvisdir ,SWVISDIF=swvisdif                     &amp;  <font color=#447700>!ssib<a name='489'></font>
     &amp;        ,SWNIRDIR=swnirdir ,SWNIRDIF=swnirdif                     &amp;  <font color=#447700>!ssib<a name='490'></font>
     &amp;                 ,re_cloud=grid%re_cloud                          &amp; <font color=#447700>! G. Thompson<a name='491'></font>
     &amp;                 ,re_ice=grid%re_ice                              &amp; <font color=#447700>! G. Thompson<a name='492'></font>
     &amp;                 ,re_snow=grid%re_snow                            &amp; <font color=#447700>! G. Thompson<a name='493'></font>
     &amp;                 ,has_reqc=has_reqc                               &amp; <font color=#447700>! G. Thompson<a name='494'></font>
     &amp;                 ,has_reqi=has_reqi                               &amp; <font color=#447700>! G. Thompson<a name='495'></font>
     &amp;                 ,has_reqs=has_reqs                               &amp; <font color=#447700>! G. Thompson<a name='496'></font>
     &amp;                 ,RSWTOA=RSWTOA,RLWTOA=RLWTOA                     &amp;<a name='497'>
     &amp;                 ,CZMEAN=CZMEAN,CFRACL=CFRACL                     &amp;<a name='498'>
     &amp;                 ,CFRACM=CFRACM,CFRACH=CFRACH                     &amp;<a name='499'>
     &amp;                 ,ACFRST=ACFRST,NCFRST=NCFRST                     &amp;<a name='500'>
     &amp;                 ,ACFRCV=ACFRCV,NCFRCV=NCFRCV                     &amp;<a name='501'>
     &amp;                 ,F_ICE_PHY=F_ICE,F_RAIN_PHY=F_RAIN               &amp;<a name='502'>
     &amp;                 ,LWCF=LWCF,SWCF=SWCF                             &amp;<a name='503'>
     &amp; ,O3INPUT=config_flags%O3INPUT,AER_OPT=config_flags%AER_OPT,O3RAD=grid%o3rad  &amp;<a name='504'>
     &amp;                 ,SF_SURFACE_PHYSICS=CONFIG_FLAGS%SF_SURFACE_PHYSICS &amp;<a name='505'>
     &amp;                 ,QV=MOIST_TRANS(IMS,KMS,JMS,P_QV),F_QV=F_QV      &amp;<a name='506'>
     &amp;                 ,QC=MOIST_TRANS(IMS,KMS,JMS,P_QC),F_QC=F_QC      &amp;<a name='507'>
     &amp;                 ,QR=MOIST_TRANS(IMS,KMS,JMS,P_QR),F_QR=F_QR      &amp;<a name='508'>
     &amp;                 ,QI=MOIST_TRANS(IMS,KMS,JMS,P_QI),F_QI=F_QI      &amp;<a name='509'>
     &amp;                 ,QS=MOIST_TRANS(IMS,KMS,JMS,P_QS),F_QS=F_QS      &amp;<a name='510'>
     &amp;                 ,QG=MOIST_TRANS(IMS,KMS,JMS,P_QG),F_QG=F_QG      &amp;<a name='511'>
     &amp;                 ,IS_CAMMGMP_USED=IS_CAMMGMP_USED                 &amp;<a name='512'>
     &amp;                 ,EXPLICIT_CONVECTION=config_flags%cu_physics==0  &amp;<a name='513'>
     &amp;                 ,CU_PHYSICS=config_flags%cu_physics              &amp;<a name='514'>
     &amp;                 ,MP_PHYSICS=CONFIG_FLAGS%MP_PHYSICS)<a name='515'>
<a name='516'>
<a name='517'>
<font color=#447700>!<a name='518'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='519'></font>
<font color=#447700>!<a name='520'></font>
<font color=#447700>!***  UPDATE FLUXES AND TEMPERATURE TENDENCIES.<a name='521'></font>
<font color=#447700>!<a name='522'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='523'></font>
<font color=#447700>!***  SHORTWAVE<a name='524'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='525'></font>
<font color=#447700>!<a name='526'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='527'></font>
      nrads_block: IF(MOD(NTSD,NRADS)==0)THEN<a name='528'>
<font color=#447700>!-----------------------------------------------------------------------<a name='529'></font>
<font color=#447700>!<a name='530'></font>
        IF(CONFIG_FLAGS%RA_SW_PHYSICS/=GFDLSWSCHEME)THEN<a name='531'>
<font color=#447700>!<a name='532'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='533'></font>
<font color=#447700>!***  COMPUTE CZMEAN FOR NON-GFDL SHORTWAVE<a name='534'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='535'></font>
<font color=#447700>!<a name='536'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='537'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='538'></font>
          DO J=MYJS,MYJE<a name='539'>
          DO I=MYIS,MYIE<a name='540'>
            CZMEAN(I,J)=0.<a name='541'>
            TOT(I,J)=0.<a name='542'>
          ENDDO<a name='543'>
          ENDDO<a name='544'>
<font color=#447700>!<a name='545'></font>
          CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>CAL_MON_DAY</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_1">(JULDAY,JULYR,JMONTH,JDAY)<a name='546'>
          IDAT(1)=JMONTH<a name='547'>
          IDAT(2)=JDAY<a name='548'>
          IDAT(3)=JULYR<a name='549'>
<font color=#447700>!<a name='550'></font>
          DO II=0,NRADS,NPHS<a name='551'>
            TIMES=NTSD*DT+II*DT<a name='552'>
            CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#ZENITH'>ZENITH</A><A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZENITH_1">(TIMES,DAYI,HOUR,IDAT,IHRST,GLON,GLAT,CZEN       &amp;<a name='553'>
     &amp;                 ,MYIS,MYIE,MYJS,MYJE                             &amp;<a name='554'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                         &amp;<a name='555'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                         &amp;<a name='556'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='557'>
<font color=#447700>!<a name='558'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='559'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='560'></font>
            DO J=MYJS,MYJE<a name='561'>
            DO I=MYIS,MYIE<a name='562'>
              IF(CZEN(I,J)&gt;0.)THEN<a name='563'>
                CZMEAN(I,J)=CZMEAN(I,J)+CZEN(I,J)<a name='564'>
                TOT(I,J)=TOT(I,J)+1.<a name='565'>
              ENDIF<a name='566'>
            ENDDO<a name='567'>
            ENDDO<a name='568'>
<font color=#447700>!<a name='569'></font>
          ENDDO<a name='570'>
<font color=#447700>!<a name='571'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='572'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='573'></font>
          DO J=MYJS,MYJE<a name='574'>
          DO I=MYIS,MYIE<a name='575'>
            IF(TOT(I,J)&gt;0.)CZMEAN(I,J)=CZMEAN(I,J)/TOT(I,J)<a name='576'>
          ENDDO<a name='577'>
          ENDDO<a name='578'>
<font color=#447700>!<a name='579'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='580'></font>
<font color=#447700>!***  COMPUTE TOTAL SFC SHORTWAVE DOWN FOR NON-GFDL SCHEMES<a name='581'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='582'></font>
<font color=#447700>!<a name='583'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='584'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='585'></font>
          DO J=MYJS2,MYJE2<a name='586'>
          DO I=MYIS1,MYIE1<a name='587'>
<font color=#447700>!<a name='588'></font>
            IF(HBM2(I,J)&gt;0.5)THEN<a name='589'>
              TOTSWDN(I,J)=SWNETDN(I,J)/(1.-ALBEDO(I,J))<a name='590'>
<font color=#447700>!<a name='591'></font>
<font color=#447700>!--- No value currently available for clear-sky solar fluxes from<a name='592'></font>
<font color=#447700>!    non GFDL schemes, though it's needed for air quality forecasts.<a name='593'></font>
<font color=#447700>!    For the time being, set to the total downward solar fluxes.<a name='594'></font>
<font color=#447700>!<a name='595'></font>
              TOTSWDNC(I,J)=TOTSWDN(I,J)<a name='596'>
            ENDIF<a name='597'>
<font color=#447700>!<a name='598'></font>
          ENDDO<a name='599'>
          ENDDO<a name='600'>
<font color=#447700>!<a name='601'></font>
        ENDIF   <font color=#447700>!End non-GFDL block<a name='602'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='603'></font>
<font color=#447700>!<a name='604'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='605'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j)<a name='606'></font>
        DO J=MYJS2,MYJE2<a name='607'>
          IENDX=MYIE1<a name='608'>
          IF(MOD(J,2)==0.AND.ITE==IDE)IENDX=IENDX-1<a name='609'>
          DO I=MYIS1,IENDX<a name='610'>
<font color=#447700>!<a name='611'></font>
            RSWIN(I,J)=TOTSWDN(I,J)<a name='612'>
            RSWINC(I,J)=TOTSWDNC(I,J)<a name='613'>
            RSWOUT(I,J)=TOTSWDN(I,J)-SWNETDN(I,J)<a name='614'>
<font color=#447700>!<a name='615'></font>
          ENDDO<a name='616'>
        ENDDO<a name='617'>
<font color=#447700>!<a name='618'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='619'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j,k)<a name='620'></font>
        DO J=MYJS2,MYJE2<a name='621'>
          IENDX=MYIE1<a name='622'>
          IF(MOD(J,2)==0.AND.ITE==IDE)IENDX=IENDX-1<a name='623'>
          DO I=MYIS1,IENDX<a name='624'>
            DO K=KTS,KTE<a name='625'>
              RSWTT(I,J,K)=THRATENSW(I,K,J)*PI_PHY(I,K,J)<a name='626'>
            ENDDO<a name='627'>
<font color=#447700>!<a name='628'></font>
          ENDDO<a name='629'>
        ENDDO<a name='630'>
<font color=#447700>!<a name='631'></font>
      ENDIF nrads_block<a name='632'>
<font color=#447700>!<a name='633'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='634'></font>
<font color=#447700>!***  LONGWAVE<a name='635'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='636'></font>
<font color=#447700>!<a name='637'></font>
      nradl_block: IF(MOD(NTSD,NRADL)==0)THEN<a name='638'>
<font color=#447700>!<a name='639'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='640'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j)<a name='641'></font>
        DO J=MYJS2,MYJE2<a name='642'>
          IENDX=MYIE1<a name='643'>
          IF(MOD(J,2)==0.AND.ITE==IDE)IENDX=IENDX-1<a name='644'>
          DO I=MYIS1,IENDX<a name='645'>
<font color=#447700>!<a name='646'></font>
            IF(HBM2(I,J)&gt;0.5)THEN<a name='647'>
              TDUM=T(I,J,KTS)<a name='648'>
              SIGT4(I,J)=STBOLT*TDUM*TDUM*TDUM*TDUM<a name='649'>
              RLWIN(I,J)=TOTLWDN(I,J)<a name='650'>
            ENDIF<a name='651'>
<font color=#447700>!<a name='652'></font>
          ENDDO<a name='653'>
        ENDDO<a name='654'>
<font color=#447700>!<a name='655'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='656'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j,k)<a name='657'></font>
        DO J=MYJS2,MYJE2<a name='658'>
          IENDX=MYIE1<a name='659'>
          IF(MOD(J,2)==0.AND.ITE==IDE)IENDX=IENDX-1<a name='660'>
<font color=#447700>!<a name='661'></font>
          DO K=KTS,KTE<a name='662'>
          DO I=MYIS1,IENDX<a name='663'>
            IF(HBM2(I,J)&gt;0.5)THEN<a name='664'>
                RLWTT(I,J,K)=THRATENLW(I,K,J)*PI_PHY(I,K,J)<a name='665'>
            ENDIF<a name='666'>
          ENDDO<a name='667'>
          ENDDO<a name='668'>
<font color=#447700>!<a name='669'></font>
        ENDDO<a name='670'>
<font color=#447700>!<a name='671'></font>
      ENDIF nradl_block<a name='672'>
<font color=#447700>!<a name='673'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='674'></font>
<font color=#447700>!***  STORE 3D CLOUD FRACTIONS.<a name='675'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='676'></font>
<font color=#447700>!<a name='677'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='678'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j,k)<a name='679'></font>
      DO K=KTS,KTE<a name='680'>
        DO J=MYJS2,MYJE2<a name='681'>
          IENDX=MYIE1<a name='682'>
          IF(MOD(J,2)==0.AND.ITE==IDE)IENDX=IENDX-1<a name='683'>
          DO I=MYIS1,IENDX<a name='684'>
            CLDFRA(I,J,K)=CLFR(I,K,J)<a name='685'>
          ENDDO<a name='686'>
        ENDDO<a name='687'>
      ENDDO<a name='688'>
<font color=#447700>!<a name='689'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='690'></font>
<font color=#447700>!***  RESET THE DIAGNOSTIC CONVECTIVE CLOUD TOPS/BOTTOMS AFTER<a name='691'></font>
<font color=#447700>!***  EACH RADIATION CALL.<a name='692'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='693'></font>
<font color=#447700>!<a name='694'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='695'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j)<a name='696'></font>
<font color=#447700>!if (config_flags%ra_sw_physics/=hwrfswscheme.and.config_flags%ra_lw_physics/=hwrflwscheme)then<a name='697'></font>
      DO J=MYJS2,MYJE2<a name='698'>
        IENDX=MYIE1<a name='699'>
        IF(MOD(J,2)==0.AND.ITE==IDE)IENDX=IENDX-1<a name='700'>
        DO I=MYIS1,IENDX<a name='701'>
          HBOT(I,J)=HBOTR(I,J)<a name='702'>
          HTOP(I,J)=HTOPR(I,J)<a name='703'>
          CUPPT(I,J)=CUPPTR(I,J)<a name='704'>
        ENDDO<a name='705'>
      ENDDO<a name='706'>
<font color=#447700>!endif<a name='707'></font>
<font color=#447700>!<a name='708'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='709'></font>
<font color=#447700>!***  ZERO OUT BOUNDARY ROWS.<a name='710'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='711'></font>
<font color=#447700>!<a name='712'></font>
      DO J=JTS,JTE<a name='713'>
      DO I=ITS,ITE<a name='714'>
        IF(HBM2(I,J)&lt;0.5)THEN<a name='715'>
          ACFRST(I,J)=0.<a name='716'>
          ACFRCV(I,J)=0.<a name='717'>
          CFRACL(I,J)=0.<a name='718'>
          CFRACM(I,J)=0.<a name='719'>
          CFRACH(I,J)=0.<a name='720'>
          RSWTOA(I,J)=0.<a name='721'>
          RLWTOA(I,J)=0.<a name='722'>
        ENDIF<a name='723'>
      ENDDO<a name='724'>
      ENDDO<a name='725'>
<font color=#447700>!<a name='726'></font>
<font color=#447700>!<a name='727'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='728'></font>
<font color=#447700>!***  UPDATE THE PROGNOSTIC MOIST ARRAY.<a name='729'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='730'></font>
<font color=#447700>!<a name='731'></font>
      DO N=2,N_MOIST<a name='732'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='733'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='734'></font>
        DO J=JMS,JME<a name='735'>
        DO K=KMS,KME<a name='736'>
        DO I=IMS,IME<a name='737'>
          MOIST(I,J,K,N)=MOIST_TRANS(I,K,J,N)<a name='738'>
        ENDDO<a name='739'>
        ENDDO<a name='740'>
        ENDDO<a name='741'>
      ENDDO<a name='742'>
<font color=#447700>!<a name='743'></font>
      DEALLOCATE(MOIST_TRANS,STAT=ISTAT)<a name='744'>
<font color=#447700>!<a name='745'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='746'></font>
<font color=#447700>!<a name='747'></font>
      END SUBROUTINE RADIATION<a name='748'>
<font color=#447700>!<a name='749'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='750'></font>
<font color=#447700>!***********************************************************************<a name='751'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='752'></font>
<A NAME='TURBL'><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='753'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TURBL</font>(NTSD,DT,NPHS,RESTRT                              &amp; <A href='../../call_to/TURBL.html' TARGET='index'>1</A>,<A href='../../call_from/TURBL.html' TARGET='index'>16</A><a name='754'>
     &amp;                ,N_MOIST,N_SCALAR,NSOIL,SLDPTH,DZSOIL             &amp;<a name='755'>
     &amp;                ,DETA1,DETA2,AETA1,AETA2,ETA1,ETA2,PDTOP,PT       &amp;<a name='756'>
     &amp;                ,SM,HBM2,VBM2,DX_ARRAY,DFRLG                      &amp;<a name='757'>
     &amp;                ,CZEN,CZMEAN,SIGT4,RLWIN,RSWIN,RADOT              &amp;<a name='758'>
<font color=#447700>!- RLWIN/RSWIN - downward longwave/shortwave at the surface (also TOTLWDN/TOTSWDN in RADIATION)<a name='759'></font>
     &amp;                ,PD,RES,PINT,T,Q,CWM,F_ICE,F_RAIN,SR              &amp;<a name='760'>
     &amp;                ,Q2,U,V,THS,TSFC,SST,PREC,SNO                     &amp;<a name='761'>
     &amp;                ,SCURX,SCURY                                      &amp;<a name='762'>
     &amp;                ,FIS,Z0,MZ0,Z0BASE,USTAR,MIXHT,PBLH,LPBL,EL_MYJ   &amp;   <font color=#447700>!MZ0: MOMENTUM Z0 (KWON)<a name='763'></font>
     &amp;                ,MOIST,SCALAR,RMOL,MOL                            &amp;<a name='764'>
     &amp;                ,EXCH_H,EXCH_M,F,AKHS,AKMS,AKHS_OUT,AKMS_OUT      &amp;<a name='765'>
     &amp;                ,THZ0,QZ0,UZ0,VZ0,QS,MAVAIL                       &amp;<a name='766'>
     &amp;                ,STC,SMC,CMC,SMSTAV,SMSTOT,SSROFF,BGROFF          &amp;<a name='767'>
     &amp;                ,IVGTYP,ISLTYP,VEGFRC,SHDMIN,SHDMAX,GRNFLX        &amp;<a name='768'>
     &amp;                ,SNOTIME                                          &amp;<a name='769'>
     &amp;                ,SFCEXC,ACSNOW,ACSNOM,SNOPCX,SICE,TG,SOILTB       &amp;<a name='770'>
     &amp;                ,ALBSI,ICEDEPTH,SNOWSI                            &amp;<a name='771'>
     &amp;                ,ALBASE,MXSNAL,ALBEDO,SH2O,SI,EPSR,EMBCK          &amp;<a name='772'>
     &amp;                ,U10,V10,UOCE,VOCE,TH10,Q10,TSHLTR,QSHLTR,PSHLTR  &amp;<a name='773'>
     &amp;                ,T2,QSG,QVG,QCG,SOILT1,TSNAV,SMFR3D,KEEPFR3DFLAG  &amp;<a name='774'>
     &amp;                ,TWBS,QWBS,TAUX,TAUY,SFCSHX,SFCLHX,SFCEVP,RTHRATEN&amp;<a name='775'>
     &amp;                ,POTEVP,POTFLX,SUBSHX                             &amp;<a name='776'>
     &amp;                ,APHTIM,ARDSW,ARDLW,ASRFC                         &amp;<a name='777'>
     &amp;                ,RSWOUT,RSWTOA,RLWTOA                             &amp;<a name='778'>
     &amp;                ,ASWIN,ASWOUT,ASWTOA,ALWIN,ALWOUT,ALWTOA          &amp;<a name='779'>
     &amp;                ,UZ0H,VZ0H,DUDT,DVDT,UGWDsfc,VGWDsfc,SFENTH       &amp; <font color=#447700>! GWD<a name='780'></font>
     &amp;                ,RTHBLTEN,RQVBLTEN                                &amp;<a name='781'>
     &amp;                ,PCPFLG,DDATA                                     &amp; <font color=#447700>! PRECIP ASSIM<a name='782'></font>
     &amp;                ,HSTDV,HCNVX,HASYW,HASYS,HASYSW,HASYNW,HLENW      &amp; <font color=#447700>! GWD<a name='783'></font>
     &amp;                ,HLENS,HLENSW,HLENNW,HANGL,HANIS,HSLOP,HZMAX      &amp; <font color=#447700>! GWD<a name='784'></font>
     &amp;                ,CROT,SROT                                        &amp; <font color=#447700>! GWD<a name='785'></font>
     &amp;                ,DEW                                              &amp; <font color=#447700>! RUC LSM<a name='786'></font>
     &amp;                ,RC_MF                                            &amp; <font color=#447700>! QNSE<a name='787'></font>
     &amp;                ,GRID,CONFIG_FLAGS                                &amp;<a name='788'>
     &amp;                ,IHE,IHW,IVE,IVW                                  &amp;<a name='789'>
     &amp;                ,DISHEAT,DKU3D,DKT3D                              &amp;<a name='790'>
     &amp;                ,HPBL2D, EVAP2D, HEAT2D,RC2D                      &amp;  <font color=#447700>!Kwon S&amp;P<a name='791'></font>
     &amp;                ,SFCHEADRT,INFXSRT,SOLDRAIN                       &amp;  <font color=#447700>!Hydrology, no-op right now<a name='792'></font>
     &amp;                ,cd_out,ch_out                                    &amp;<a name='793'>
     &amp;                ,ulowl, vlowl                                     &amp;<a name='794'>
     &amp;                ,zkmax, ribn                                      &amp;<a name='795'>
     &amp;                ,charn, msang                                     &amp;<a name='796'>
     &amp;                ,DUBLDT,DVBLDT,DTHBLDT,DQVBLDT                    &amp; <font color=#447700>!wang added PBL tendency output<a name='797'></font>
     &amp;                ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='798'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='799'>
     &amp;                ,IPS,IPE,JPS,JPE,KPS,KPE                          &amp;<a name='800'>
     &amp;                ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='801'>
<font color=#447700>!***********************************************************************<a name='802'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='803'></font>
<font color=#447700>!                .      .    .<a name='804'></font>
<font color=#447700>! SUBPROGRAM:    TURBL       TURBULENCE OUTER DRIVER<a name='805'></font>
<font color=#447700>!   PRGRMMR: BLACK           ORG: W/NP22     DATE: 02-04-19<a name='806'></font>
<font color=#447700>!<a name='807'></font>
<font color=#447700>! ABSTRACT:<a name='808'></font>
<font color=#447700>!     TURBL DRIVES THE TURBULENCE SCHEMES<a name='809'></font>
<font color=#447700>!<a name='810'></font>
<font color=#447700>! PROGRAM HISTORY LOG (with changes to called routines) :<a name='811'></font>
<font color=#447700>!   95-03-15  JANJIC     - ORIGINATOR OF THE SUBROUTINES CALLED<a name='812'></font>
<font color=#447700>!   BLACK &amp; JANJIC       - ORIGINATORS OF THE DRIVER<a name='813'></font>
<font color=#447700>!   95-03-28  BLACK      - CONVERSION FROM 1-D TO 2-D IN HORIZONTAL<a name='814'></font>
<font color=#447700>!   96-03-29  BLACK      - ADDED EXTERNAL EDGE; REMOVED SCRCH COMMON<a name='815'></font>
<font color=#447700>!   96-07-19  MESINGER   - ADDED Z0 EFFECTIVE<a name='816'></font>
<font color=#447700>!   98-??-??  TUCCILLO   - MODIFIED FOR CLASS VIII PARALLELISM<a name='817'></font>
<font color=#447700>!   98-10-27  BLACK      - PARALLEL CHANGES INTO MOST RECENT CODE<a name='818'></font>
<font color=#447700>!   02-01-10  JANJIC     - MOIST TURBULENCE (DRIVER, MIXLEN, VDIFH)<a name='819'></font>
<font color=#447700>!   02-01-10  JANJIC     - VERT. DIF OF Q2 INCREASED (Grenier &amp; Bretherton)<a name='820'></font>
<font color=#447700>!   02-02-02  JANJIC     - NEW SFCDIF<a name='821'></font>
<font color=#447700>!   02-04-19  BLACK      - ORIGINATOR OF THIS OUTER DRIVER FOR WRF<a name='822'></font>
<font color=#447700>!   02-05-03  JANJIC     - REMOVAL OF SUPERSATURATION AT 2m AND 10m<a name='823'></font>
<font color=#447700>!   04-11-18  BLACK      - THREADED<a name='824'></font>
<font color=#447700>!   05-12-15  BLACK      - CONVERTED FROM IKJ TO IJK<a name='825'></font>
<font color=#447700>!   07-05-15  FERRIER    - ADDED GRAVITY WAVE DRAG (GWD) &amp; MOUNTAIN BLOCKING<a name='826'></font>
<font color=#447700>!<a name='827'></font>
<font color=#447700>! USAGE: CALL TURBL FROM SOLVE_NMM<a name='828'></font>
<font color=#447700>!<a name='829'></font>
<font color=#447700>! ATTRIBUTES:<a name='830'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='831'></font>
<font color=#447700>!   MACHINE : IBM<a name='832'></font>
<font color=#447700>!$$$<a name='833'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='834'></font>
<font color=#447700>!<a name='835'></font>
      IMPLICIT NONE<a name='836'>
<font color=#447700>!<a name='837'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='838'></font>
<font color=#447700>!<a name='839'></font>
#if (NMM_CORE==1)    <a name='840'>
      LOGICAL,INTENT(IN) ::  DISHEAT                       <font color=#447700>!  hwrf's doing<a name='841'></font>
#endif<a name='842'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='843'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='844'>
     &amp;                     ,IPS,IPE,JPS,JPE,KPS,KPE                     &amp;<a name='845'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='846'>
     &amp;                     ,N_MOIST,NPHS,NSOIL,NTSD,N_SCALAR<a name='847'>
<font color=#447700>!<a name='848'></font>
      INTEGER, DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='849'>
<font color=#447700>!<a name='850'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: ISLTYP,IVGTYP<a name='851'>
<font color=#447700>!<a name='852'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) ::  HPBL2D, EVAP2D, HEAT2D , RC2D   <font color=#447700>!Kwon S&amp;P<a name='853'></font>
<font color=#447700>!<a name='854'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: LPBL<a name='855'>
<font color=#447700>!<a name='856'></font>
      REAL,INTENT(IN) :: DT,PDTOP,PT<a name='857'>
<font color=#447700>!<a name='858'></font>
      REAL,INTENT(IN) :: SFENTH<a name='859'>
      REAL,INTENT(INOUT) :: APHTIM,ARDSW,ARDLW,ASRFC<a name='860'>
<font color=#447700>!<a name='861'></font>
      REAL,DIMENSION(KMS:KME-1),INTENT(IN) :: AETA1,AETA2,DETA1,DETA2<a name='862'>
<font color=#447700>!<a name='863'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: RTHRATEN     <font color=#447700>!Kwon S&amp;P<a name='864'></font>
<font color=#447700>!<a name='865'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: DFRLG,ETA1,ETA2<a name='866'>
<font color=#447700>!<a name='867'></font>
      REAL,DIMENSION(NSOIL),INTENT(IN) :: DZSOIL,SLDPTH<a name='868'>
<font color=#447700>!<a name='869'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: CZEN,CZMEAN         &amp;<a name='870'>
     &amp;                                             ,DX_ARRAY            &amp;<a name='871'>
     &amp;                                             ,F,FIS,HBM2          &amp;<a name='872'>
     &amp;                                             ,PD,RES              &amp;<a name='873'>
     &amp;                                             ,RLWIN,RLWTOA        &amp;<a name='874'>
     &amp;                                             ,RSWIN,RSWOUT,RSWTOA &amp;<a name='875'>
     &amp;                                             ,SHDMIN,SHDMAX       &amp;<a name='876'>
<font color=#447700>!    &amp;                                             ,SICE,SIGT4,SM,SR    &amp; !Bandaid<a name='877'></font>
     &amp;                                             ,SIGT4               &amp;<a name='878'>
     &amp;                ,HSTDV,HCNVX,HASYW,HASYS,HASYSW,HASYNW,HLENW      &amp; <font color=#447700>! GWD<a name='879'></font>
     &amp;                ,HLENS,HLENSW,HLENNW,HANGL,HANIS,HSLOP,HZMAX      &amp; <font color=#447700>! GWD<a name='880'></font>
     &amp;                ,CROT,SROT                                        &amp; <font color=#447700>! GWD<a name='881'></font>
     &amp;                                             ,VBM2,VEGFRC<a name='882'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: SST<a name='883'>
      REAL,DIMENSION(IMS:IME,JMS:JME)               :: ALBSI<a name='884'>
      REAL,DIMENSION(IMS:IME,JMS:JME)               :: ICEDEPTH<a name='885'>
      REAL,DIMENSION(IMS:IME,JMS:JME)               :: SNOWSI<a name='886'>
<font color=#447700>!<a name='887'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: SM,EPSR,SR       &amp; <font color=#447700>!Bandaid<a name='888'></font>
                                                      ,TG,SICE          &amp;<a name='889'>
                                                      ,EMBCK<a name='890'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: ALBASE,MXSNAL<a name='891'>
<font color=#447700>!<a name='892'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: ACSNOM,ACSNOW    &amp;<a name='893'>
     &amp;                                                ,SNOTIME          &amp;<a name='894'>
     &amp;                                                ,AKHS,AKMS        &amp;<a name='895'>
     &amp;                                                ,ALBEDO           &amp;<a name='896'>
     &amp;                                                ,BGROFF,CMC       &amp;<a name='897'>
     &amp;                                                ,MAVAIL,MOL       &amp;<a name='898'>
     &amp;                                                ,MIXHT            &amp;<a name='899'>
     &amp;                                                ,PBLH,POTEVP      &amp;<a name='900'>
     &amp;                                                ,POTFLX,PREC      &amp;<a name='901'>
     &amp;                                                ,QCG,QS,QSG       &amp;<a name='902'>
     &amp;                                                ,QVG,QZ0          &amp;<a name='903'>
     &amp;                                                ,RMOL             &amp;<a name='904'>
     &amp;                                                ,SFCEVP           &amp;<a name='905'>
     &amp;                                                ,SFCLHX,SFCSHX    &amp;<a name='906'>
     &amp;                                                ,SI,SMSTOT        &amp;<a name='907'>
     &amp;                                                ,SNO,SNOPCX       &amp;<a name='908'>
     &amp;                                                ,SOILT1           &amp;<a name='909'>
     &amp;                                                ,SSROFF,SUBSHX    &amp;<a name='910'>
     &amp;                                                ,T2,THS,THZ0      &amp;<a name='911'>
     &amp;                                                ,TSFC,TSNAV       &amp;<a name='912'>
     &amp;                                                ,USTAR,UZ0,UZ0H   &amp;<a name='913'>
     &amp;                                                ,VZ0,VZ0H         &amp;<a name='914'>
     &amp;                                                ,DEW              &amp; <font color=#447700>!RUC LSM<a name='915'></font>
     &amp;                                                ,Z0,MZ0,Z0BASE      <font color=#447700>!MZ0 (KWON)<a name='916'></font>
<font color=#447700>!<a name='917'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: AKHS_OUT,AKMS_OUT  &amp;<a name='918'>
     &amp;                                              ,ALWIN,ALWOUT       &amp;<a name='919'>
     &amp;                                              ,ALWTOA,ASWIN       &amp;<a name='920'>
     &amp;                                              ,ASWOUT,ASWTOA      &amp;<a name='921'>
     &amp;                                              ,PSHLTR,Q10,QSHLTR  &amp;<a name='922'>
     &amp;                                              ,TH10,TSHLTR        &amp;<a name='923'>
     &amp;                                              ,U10,V10            &amp; <font color=#447700>! GWD<a name='924'></font>
     &amp;                                              ,UOCE,VOCE          &amp;<a name='925'>
     &amp;                                              ,UGWDsfc,VGWDsfc      <font color=#447700>! GWD<a name='926'></font>
<font color=#447700>!<a name='927'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: GRNFLX,QWBS,RADOT  &amp;<a name='928'>
                                                    ,SFCEXC,SMSTAV      &amp;<a name='929'>
                                                    ,SOILTB,TWBS<a name='930'>
<font color=#447700>!<a name='931'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN)  :: scurx, scury<a name='932'>
<a name='933'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: cd_out,ch_out<a name='934'>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: &amp;<a name='935'>
                                                       DTHBLDT         &amp;<a name='936'>
                                                      ,DQVBLDT         &amp;<a name='937'>
                                                      ,DUBLDT          &amp;<a name='938'>
                                                      ,DVBLDT<a name='939'>
<a name='940'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: taux, tauy<a name='941'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: zkmax, ribn<a name='942'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: charn, msang<a name='943'>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PINT<a name='944'>
<font color=#447700>!<a name='945'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: CWM      &amp;<a name='946'>
     &amp;                                                        ,DUDT     &amp;<a name='947'>
     &amp;                                                        ,DVDT     &amp;<a name='948'>
     &amp;                                                        ,Q,Q2     &amp;<a name='949'>
     &amp;                                                        ,T,U,V<a name='950'>
<font color=#447700>!<a name='951'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: F_ICE    &amp;   <font color=#447700>!&lt;--- Used only in physics (IKJ)<a name='952'></font>
     &amp;                                                        ,F_RAIN   &amp;<a name='953'>
     &amp;                                                        ,RQVBLTEN &amp;<a name='954'>
     &amp;                                                        ,RTHBLTEN<a name='955'>
<font color=#447700>!<a name='956'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: EL_MYJ     &amp;   <font color=#447700>!&lt;--- Used only in physics (IKJ)<a name='957'></font>
     &amp;                                                      ,EXCH_H     &amp;<a name='958'>
     &amp;                                                      ,EXCH_M<a name='959'>
<font color=#447700>!<a name='960'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(OUT) :: DKU3D,DKT3D   <font color=#447700>! KWON<a name='961'></font>
      REAL,DIMENSION(IMS:IME,NSOIL,JMS:JME),INTENT(INOUT) :: KEEPFR3DFLAG &amp; <font color=#447700>!&lt;--- Used only in physics (IKJ)<a name='962'></font>
     &amp;                                                      ,SH2O,SMC     &amp;<a name='963'>
     &amp;                                                      ,SMFR3D,STC<a name='964'>
<a name='965'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: RC_MF        <font color=#447700>! QNSE only<a name='966'></font>
<font color=#447700>!<a name='967'></font>
      REAL,DIMENSION(IMS:IME,NSOIL,JMS:JME)               :: SMCREL<a name='968'>
<font color=#447700>!<a name='969'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,N_MOIST)                   &amp;<a name='970'>
     &amp;                                           ,INTENT(INOUT) :: MOIST<a name='971'>
<font color=#447700>!<a name='972'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,N_SCALAR)                  &amp;<a name='973'>
     &amp;                                           ,INTENT(INOUT) :: SCALAR<a name='974'>
<font color=#447700>!<a name='975'></font>
      LOGICAL,INTENT(IN) :: RESTRT<a name='976'>
<font color=#447700>!<a name='977'></font>
      TYPE(DOMAIN),TARGET :: GRID<a name='978'>
<font color=#447700>!<a name='979'></font>
      TYPE(GRID_CONFIG_REC_TYPE),INTENT(IN) :: CONFIG_FLAGS<a name='980'>
<font color=#447700>!<a name='981'></font>
<font color=#447700>!  For precip assimilation:<a name='982'></font>
      LOGICAL,INTENT(IN) :: PCPFLG<a name='983'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DDATA<a name='984'>
<a name='985'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT)  :: SFCHEADRT         <font color=#447700>! Hydrology, no-op right now<a name='986'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: INFXSRT,SOLDRAIN  <font color=#447700>! Hydrology, no-op right now<a name='987'></font>
<font color=#447700>!<a name='988'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='989'></font>
<font color=#447700>!***<a name='990'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='991'></font>
<font color=#447700>!***<a name='992'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='993'></font>
      INTEGER :: I,I_M,IDUMMY,IEND,ISFFLX,ISTAT,ISTR,J,K,KOUNT_ALL      &amp;<a name='994'>
     &amp;          ,LENGTH_ROW,LLIJ,LLYR,N,SST_UPDATE,SF_URBAN_PHYSICS,NUM_URBAN_LAYERS<a name='995'>
      INTEGER :: FASDAS<a name='996'>
<font color=#447700>!<a name='997'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME) :: KPBL,LOWLYR<a name='998'>
<font color=#447700>!<a name='999'></font>
      REAL :: TRESH=0.95<a name='1000'>
<font color=#447700>!<a name='1001'></font>
      REAL :: ALTITUDE,CWML,DQDT,DTDT,DTPHS,DX,DZHALF,FACTR,FACTRL      &amp;<a name='1002'>
     &amp;       ,G_INV,PLYR,PSFC,QI,QL,QOLD,QR,QW,RATIOMX,RDTPHS,DY        &amp;<a name='1003'>
     &amp;       ,ROG,RWMSK,SDEPTH,SNO_FACTR,TL,TLMH,TLMH4,TNEW,TSFC2       &amp;<a name='1004'>
     &amp;       ,U_FRAME,V_FRAME,XLVRW<a name='1005'>
<font color=#447700>!<a name='1006'></font>
      REAL :: APES,CAPA,CKLQ,EXNER,FACTOR,FFS,PQ0X,Q2SAT,QFC1,QLOWX     &amp;<a name='1007'>
     &amp;       ,RLIVWV,THBOT,DPL<a name='1008'>
<font color=#447700>!<a name='1009'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME) :: BR,CHKLOWQ,CT,CWMLOW,ELFLX     &amp;<a name='1010'>
     &amp;                                  ,EXNSFC,FACTRS,FLHC,FLQC,GZ1OZ0 &amp;<a name='1011'>
     &amp;                                  ,FH,FM,ZOL                      &amp;<a name='1012'>
     &amp;                                  ,ONE,PDSL,PLM,PSFC_OUT,PSIH     &amp;<a name='1013'>
     &amp;                                  ,PSIM,Q2X,QLOW,RAIN,RAINBL      &amp;<a name='1014'>
     &amp;                                  ,RLW_DN_SFC,RSW_NET_SFC         &amp;<a name='1015'>
     &amp;                                  ,RSW_DN_SFC                     &amp;<a name='1016'>
     &amp;                                  ,SFCEVPX,SFCZ,SNOW,SNOWC,SNOWH  &amp;<a name='1017'>
     &amp;                                  ,TH2X,THLOW,TLOW,VGFRCK         &amp;<a name='1018'>
     &amp;                                  ,WSPD,XLAND,REGIME,HOL<a name='1019'>
<font color=#447700>!<a name='1020'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME) :: DUDT_PHY,DVDT_PHY,DZ   &amp;<a name='1021'>
     &amp;                                          ,P_PHY,P8W,PI_PHY       &amp;<a name='1022'>
     &amp;                                          ,RQCBLTEN,RQIBLTEN      &amp;<a name='1023'>
<font color=#447700>!BSF &amp;                                     ,RQSBLTEN,RQRBLTEN,RQGBLTEN  &amp;<a name='1024'></font>
     &amp;                                          ,RR,DELP                &amp; <font color=#447700>! GWD<a name='1025'></font>
     &amp;                                          ,T_PHY,TH_PHY,TKE       &amp;<a name='1026'>
     &amp;                                          ,DUDT_GWD,DVDT_GWD      &amp; <font color=#447700>! GWD<a name='1027'></font>
     &amp;                                          ,U_PHY,V_PHY,Z<a name='1028'>
<font color=#447700>!<a name='1029'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME), INTENT(OUT) :: ULOWL, VLOWL<a name='1030'>
<font color=#447700>!<a name='1031'></font>
      REAL,DIMENSION(:,:,:,:),ALLOCATABLE :: MOIST_TRANS<a name='1032'>
<font color=#447700>!<a name='1033'></font>
      REAL,DIMENSION(IMS:IME,NSOIL,JMS:JME) :: ZERO_SOIL<a name='1034'>
<font color=#447700>!<a name='1035'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME) :: wstar_ysu, delta_ysu<a name='1036'>
<font color=#447700>!<a name='1037'></font>
      LOGICAL :: E_BDY,WARM_RAIN<a name='1038'>
      LOGICAL :: IS_CAMMGMP_USED=.FALSE.<a name='1039'>
<font color=#447700>!<a name='1040'></font>
      INTEGER :: NUM_ROOF_LAYERS,NUM_WALL_LAYERS,NUM_ROAD_LAYERS   <font color=#447700>! urban<a name='1041'></font>
      INTEGER :: FRACTIONAL_SEAICE<a name='1042'>
      INTEGER :: SEAICE_ALBEDO_OPT<a name='1043'>
      REAL    :: SEAICE_ALBEDO_DEFAULT<a name='1044'>
      INTEGER :: SEAICE_THICKNESS_OPT<a name='1045'>
      REAL    :: SEAICE_THICKNESS_DEFAULT<a name='1046'>
      INTEGER :: SEAICE_SNOWDEPTH_OPT<a name='1047'>
      REAL    :: SEAICE_SNOWDEPTH_MAX<a name='1048'>
      REAL    :: SEAICE_SNOWDEPTH_MIN<a name='1049'>
      INTEGER :: IFNDALBSI<a name='1050'>
      INTEGER :: IFNDICEDEPTH<a name='1051'>
      INTEGER :: IFNDSNOWSI<a name='1052'>
      REAL    :: WIND<a name='1053'>
      INTEGER :: IGS,IGE,JGS,JGE, PQ_I   <font color=#447700>!BSF<a name='1054'></font>
      LOGICAL :: FQ_I, ETAMP_PHYSICS,ETAMP_Regional            <font color=#447700>!BSF<a name='1055'></font>
<a name='1056'>
      CHARACTER(len=255) :: message<a name='1057'>
#if HWRF==1<a name='1058'>
<font color=#447700>!dbg integer :: kpblmin,kpblmax,lpblmin,lpblmax    !dbg<a name='1059'></font>
#endif<a name='1060'>
<font color=#447700>!<a name='1061'></font>
<font color=#447700>!<a name='1062'></font>
    TYPE(WRFU_Time)                :: currentTime<a name='1063'>
    INTEGER                         :: yr, month, day, hr, minute, sec, rc<a name='1064'>
    CHARACTER*80                    :: mesg<a name='1065'>
<a name='1066'>
    INTEGER  :: isurban<a name='1067'>
    CHARACTER(len=256) :: MMINLU<a name='1068'>
    REAL :: VAR_RIC,coef_ric_s,coef_ric_l                             <font color=#447700>!KWON for variable Ric (=1)<a name='1069'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1070'></font>
<font color=#447700>!***********************************************************************<a name='1071'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1072'></font>
<font color=#447700>!<a name='1073'></font>
      ALLOCATE(MOIST_TRANS(IMS:IME,KMS:KME,JMS:JME,N_MOIST),STAT=ISTAT)<a name='1074'>
<font color=#447700>!<a name='1075'></font>
      SF_URBAN_PHYSICS=CONFIG_FLAGS%SF_URBAN_PHYSICS<a name='1076'>
      FASDAS=0<a name='1077'>
<a name='1078'>
      if ( config_flags%bl_pbl_physics == BOULACSCHEME ) then<a name='1079'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_88">("Cannot use BOULAC PBL with NMM")<a name='1080'>
      endif<a name='1081'>
      <a name='1082'>
      FRACTIONAL_SEAICE = CONFIG_FLAGS%FRACTIONAL_SEAICE<a name='1083'>
      IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='1084'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_89">("NMM cannot use FRACTIONAL_SEAICE = 1.")<a name='1085'>
      ENDIF<a name='1086'>
<a name='1087'>
      SEAICE_ALBEDO_OPT = CONFIG_FLAGS%SEAICE_ALBEDO_OPT<a name='1088'>
      IF ( SEAICE_ALBEDO_OPT /= 0 ) THEN<a name='1089'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_90">("NMM must use SEAICE_ALBEDO_OPT = 0")<a name='1090'>
      ENDIF<a name='1091'>
<a name='1092'>
      IFNDALBSI = 0<a name='1093'>
      IFNDSNOWSI = 0<a name='1094'>
      IFNDICEDEPTH = 0<a name='1095'>
      BR=10<a name='1096'>
<a name='1097'>
      SEAICE_ALBEDO_DEFAULT = CONFIG_FLAGS%SEAICE_ALBEDO_DEFAULT<a name='1098'>
      SEAICE_THICKNESS_OPT = CONFIG_FLAGS%SEAICE_THICKNESS_OPT<a name='1099'>
      SEAICE_THICKNESS_DEFAULT = CONFIG_FLAGS%SEAICE_THICKNESS_DEFAULT<a name='1100'>
      SEAICE_SNOWDEPTH_OPT = CONFIG_FLAGS%SEAICE_SNOWDEPTH_OPT<a name='1101'>
      SEAICE_SNOWDEPTH_MAX = CONFIG_FLAGS%SEAICE_SNOWDEPTH_MAX<a name='1102'>
      SEAICE_SNOWDEPTH_MIN = CONFIG_FLAGS%SEAICE_SNOWDEPTH_MIN<a name='1103'>
<font color=#447700>!<a name='1104'></font>
      DTPHS=NPHS*DT<a name='1105'>
      RDTPHS=1./DTPHS<a name='1106'>
      G_INV=1./G<a name='1107'>
      ROG=R_D*G_INV<a name='1108'>
      FACTOR=-XLV*RHOWATER/DTPHS<a name='1109'>
      CAPA=R_D/CP<a name='1110'>
<font color=#447700>!<a name='1111'></font>
      U_FRAME=0.<a name='1112'>
      V_FRAME=0.<a name='1113'>
<font color=#447700>!<a name='1114'></font>
      IDUMMY=0<a name='1115'>
      ISFFLX=1<a name='1116'>
      DX=0.<a name='1117'>
      DY=0.<a name='1118'>
      SST_UPDATE=config_flags%SST_UPDATE<a name='1119'>
<font color=#447700>!<a name='1120'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1121'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1122'></font>
      DO J=JMS,JME<a name='1123'>
      DO I=IMS,IME<a name='1124'>
        UZ0H(I,J)=0.<a name='1125'>
        VZ0H(I,J)=0.<a name='1126'>
        ONE(I,J)=1.<a name='1127'>
        RMOL(I,J)=0.     <font color=#447700>!Reciprocal of Monin-Obukhov length<a name='1128'></font>
        SFCEVPX(I,J)=0.  <font color=#447700>!Dummy for accumulated latent energy, not flux<a name='1129'></font>
        ZOL(I,J)=0.<a name='1130'>
      ENDDO<a name='1131'>
      ENDDO<a name='1132'>
<font color=#447700>!<a name='1133'></font>
      IF(MODEL_CONFIG_REC%SF_SURFACE_PHYSICS(GRID%ID)==99)THEN<a name='1134'>
        SNO_FACTR=1.<a name='1135'>
      ELSE<a name='1136'>
        SNO_FACTR=0.001<a name='1137'>
      ENDIF<a name='1138'>
<font color=#447700>!<a name='1139'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1140'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1141'></font>
      DO J=MYJS,MYJE<a name='1142'>
      DO I=MYIS,MYIE<a name='1143'>
        LOWLYR(I,J)=1<a name='1144'>
        VGFRCK(I,J)=100.*VEGFRC(I,J)<a name='1145'>
        SNOW(I,J)=SNO(I,J)<a name='1146'>
        SNOWH(I,J)=SI(I,J)*SNO_FACTR<a name='1147'>
        XLAND(I,J)=SM(I,J)+1.<a name='1148'>
        T2(I,J)=TSFC(I,J)<a name='1149'>
      ENDDO<a name='1150'>
      ENDDO<a name='1151'>
<font color=#447700>!<a name='1152'></font>
      IF(NTSD==0)THEN<a name='1153'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1154'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1155'></font>
        DO J=MYJS,MYJE<a name='1156'>
        DO I=MYIS,MYIE<a name='1157'>
          Z0BASE(I,J)=Z0(I,J)<a name='1158'>
          IF(SM(I,J)&gt;0.5.AND.SICE(I,J)&gt;0.5)THEN  <font color=#447700>!Bandaid<a name='1159'></font>
            SM(I,J)=0.<a name='1160'>
          ENDIF<a name='1161'>
        ENDDO<a name='1162'>
        ENDDO<a name='1163'>
      ENDIF<a name='1164'>
<font color=#447700>!<a name='1165'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1166'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1167'></font>
      DO J=MYJS,MYJE<a name='1168'>
      DO K=KTS,KTE+1<a name='1169'>
      DO I=MYIS,MYIE<a name='1170'>
        Z(I,K,J)=0.<a name='1171'>
        DZ(I,K,J)=0.<a name='1172'>
        EXCH_H(I,K,J)=0.<a name='1173'>
        EXCH_M(I,K,J)=0.<a name='1174'>
      ENDDO<a name='1175'>
      ENDDO<a name='1176'>
      ENDDO<a name='1177'>
<font color=#447700>!<a name='1178'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1179'></font>
<font color=#447700>!<a name='1180'></font>
<font color=#447700>!***  PREPARE NEEDED ARRAYS FOR CALLING THE INNER DRIVER.<a name='1181'></font>
<font color=#447700>!<a name='1182'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1183'></font>
<font color=#447700>!<a name='1184'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1185'></font>
<font color=#447700>!$omp&amp; private(factrl,i,j,llij,tlmh)<a name='1186'></font>
      DO J=MYJS,MYJE<a name='1187'>
      DO I=MYIS,MYIE<a name='1188'>
<font color=#447700>!<a name='1189'></font>
        PDSL(I,J)=PD(I,J)*RES(I,J)<a name='1190'>
<font color=#447700>!!!     PSFC=PD(I,J)+PDTOP+PT<a name='1191'></font>
<font color=#447700>!!!     P8W(I,KTS,J)=PSFC<a name='1192'></font>
        P8W(I,KTS,J)=PINT(I,J,KTS)<a name='1193'>
        PSFC=PINT(I,J,KTS)<a name='1194'>
        LOWLYR(I,J)=KTS     <font color=#447700>!&lt;----  The lowest model layer counted from the bottom.<a name='1195'></font>
        EXNSFC(I,J)=(1.E5/PSFC)**CAPA<a name='1196'>
        THS(I,J)=(SST(I,J)*EXNSFC(I,J))*SM(I,J)+THS(I,J)*(1.-SM(I,J))<a name='1197'>
        TSFC(I,J)=THS(I,J)/EXNSFC(I,J)<a name='1198'>
        SFCZ(I,J)=FIS(I,J)*G_INV<a name='1199'>
<font color=#447700>!YL     RAIN(I,J)=PREC(I,J)*RHOWATER<a name='1200'></font>
        IF (PCPFLG.AND.DDATA(I,J)&lt;100.)THEN<a name='1201'>
          RAIN(I,J)=DDATA(I,J)*RHOWATER<a name='1202'>
        ELSE<a name='1203'>
          RAIN(I,J)=PREC(I,J)*RHOWATER<a name='1204'>
        ENDIF<a name='1205'>
<font color=#447700>!YL<a name='1206'></font>
        RAINBL(I,J)=0.<a name='1207'>
        IF(SNO(I,J)&gt;0.)SNOWC(I,J)=1.<a name='1208'>
        LLIJ=LOWLYR(I,J)<a name='1209'>
        PLM(I,J)=(PINT(I,J,LLIJ)+PINT(I,J,LLIJ+1))*0.5<a name='1210'>
        TH2X(I,J)=T(I,J,LLIJ)*(1.E5/PLM(I,J))**CAPA<a name='1211'>
        Q2X(I,J)=Q(I,J,LLIJ)<a name='1212'>
<font color=#447700>!<a name='1213'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1214'></font>
<font color=#447700>!*** LONG AND SHORTWAVE FLUX AT GROUND SURFACE<a name='1215'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1216'></font>
<font color=#447700>!<a name='1217'></font>
        IF(CZMEAN(I,J)&gt;0.)THEN<a name='1218'>
          FACTRS(I,J)=CZEN(I,J)/CZMEAN(I,J)<a name='1219'>
        ELSE<a name='1220'>
          FACTRS(I,J)=0.<a name='1221'>
        ENDIF<a name='1222'>
<font color=#447700>!<a name='1223'></font>
        IF(SIGT4(I,J)&gt;0.)THEN<a name='1224'>
          TLMH=T(I,J,LLIJ)<a name='1225'>
          FACTRL=STBOLT*TLMH*TLMH*TLMH*TLMH/SIGT4(I,J)<a name='1226'>
        ELSE<a name='1227'>
          FACTRL=0.<a name='1228'>
        ENDIF<a name='1229'>
<font color=#447700>!<a name='1230'></font>
<font color=#447700>!- RLWIN/RSWIN - downward longwave/shortwave at the surface<a name='1231'></font>
<font color=#447700>!<a name='1232'></font>
        RLW_DN_SFC(I,J)=RLWIN(I,J)*HBM2(I,J)*FACTRL<a name='1233'>
        RSW_NET_SFC(I,J)=(RSWIN(I,J)-RSWOUT(I,J))*HBM2(I,J)*FACTRS(I,J)<a name='1234'>
<font color=#447700>!<a name='1235'></font>
<font color=#447700>!- Instant downward solar for nmm_lsm<a name='1236'></font>
<font color=#447700>!<a name='1237'></font>
        RSW_DN_SFC(I,J)=RSWIN(I,J)*HBM2(I,J)*FACTRS(I,J)<a name='1238'>
<font color=#447700>!<a name='1239'></font>
        Z(I,KTS,J)=SFCZ(I,J)<a name='1240'>
<font color=#447700>!<a name='1241'></font>
      ENDDO<a name='1242'>
      ENDDO<a name='1243'>
<font color=#447700>!<a name='1244'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1245'></font>
<font color=#447700>!***  FILL THE ARRAYS FOR CALLING THE INNER DRIVER.<a name='1246'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1247'></font>
<font color=#447700>!<a name='1248'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1249'></font>
<font color=#447700>!$omp&amp; private(cwml,i,j,k,plyr,qi,ql,qr,qw,tl)<a name='1250'></font>
      DO J=MYJS,MYJE<a name='1251'>
        DO K=KTS,KTE<a name='1252'>
        DO I=MYIS,MYIE<a name='1253'>
          Q2(I,J,K)=MAX(Q2(I,J,K)*HBM2(I,J),EPSQ2)<a name='1254'>
          QL=MAX(Q(I,J,K),EPSQ)<a name='1255'>
          PLYR=(PINT(I,J,K)+PINT(I,J,K+1))*0.5<a name='1256'>
<font color=#447700>!!!       PLYR=AETA1(K)*PDTOP+AETA2(K)*PDSL(I,J)+PT<a name='1257'></font>
          TL=T(I,J,K)<a name='1258'>
          CWML=CWM(I,J,K)<a name='1259'>
<font color=#447700>!<a name='1260'></font>
          RR(I,K,J)=PLYR/(R_D*TL)<a name='1261'>
          T_PHY(I,K,J)=TL<a name='1262'>
<font color=#447700>!<a name='1263'></font>
          EXNER=(1.E5/PLYR)**CAPA<a name='1264'>
          PI_PHY(I,K,J)=1./EXNER<a name='1265'>
          TH_PHY(I,K,J)=TL*EXNER<a name='1266'>
          P8W(I,K+1,J)=PINT(I,J,K+1)<a name='1267'>
<font color=#447700>!!!       P8W(I,K+1,J)=ETA1(K+1)*PDTOP+ETA2(K+1)*PDSL(I,J)+PT<a name='1268'></font>
          P_PHY(I,K,J)=PLYR<a name='1269'>
          TKE(I,K,J)=0.5*Q2(I,J,K)<a name='1270'>
<font color=#447700>!<a name='1271'></font>
          RTHBLTEN(I,K,J)=0.<a name='1272'>
          RQVBLTEN(I,K,J)=0.<a name='1273'>
          RQCBLTEN(I,K,J)=0.<a name='1274'>
          RQIBLTEN(I,K,J)=0.<a name='1275'>
<font color=#447700>!BSF          RQSBLTEN(I,K,J)=0.<a name='1276'></font>
<font color=#447700>!BSF          RQRBLTEN(I,K,J)=0.<a name='1277'></font>
<font color=#447700>!BSF          RQGBLTEN(I,K,J)=0.<a name='1278'></font>
<font color=#447700>!<a name='1279'></font>
<font color=#447700>!-- Next 3 lines modified for GWD<a name='1280'></font>
<font color=#447700>!<a name='1281'></font>
          DPL=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='1282'>
          Z(I,K+1,J)=Z(I,K,J)+TL/PLYR*DPL*ROG*(Q(I,J,K)*P608-CWML+1.)<a name='1283'>
          DELP(I,K,J)=DPL<a name='1284'>
          DZ(I,K,J)=Z(I,K+1,J)-Z(I,K,J)<a name='1285'>
        ENDDO<a name='1286'>
      ENDDO<a name='1287'>
      ENDDO<a name='1288'>
<font color=#447700>!<a name='1289'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1290'></font>
<font color=#447700>!$omp&amp; private(i,j,llyr,qlowx)<a name='1291'></font>
      DO J=MYJS,MYJE<a name='1292'>
      DO I=MYIS,MYIE<a name='1293'>
        TWBS(I,J)=0.<a name='1294'>
        QWBS(I,J)=0.<a name='1295'>
        LLYR=LOWLYR(I,J)<a name='1296'>
        THLOW(I,J)=TH_PHY(I,LLYR,J)<a name='1297'>
        TLOW(I,J)=T_PHY(I,LLYR,J)<a name='1298'>
        QLOW(I,J)=MAX(Q(I,J,LLYR),EPSQ)<a name='1299'>
        QLOWX=QLOW(I,J)/(1.-QLOW(I,J))<a name='1300'>
        QLOW(I,J)=QLOWX/(1.+QLOWX)<a name='1301'>
        CWMLOW(I,J)=CWM(I,J,LLYR)<a name='1302'>
        PBLH(I,J)=MAX(PBLH(I,J),0.)<a name='1303'>
        PBLH(I,J)=MIN(PBLH(I,J),Z(I,KTE,J))<a name='1304'>
      ENDDO<a name='1305'>
      ENDDO<a name='1306'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1307'></font>
<font color=#447700>!<a name='1308'></font>
<font color=#447700>!***  COMPUTE VELOCITY COMPONENTS AT MASS POINTS<a name='1309'></font>
<font color=#447700>!<a name='1310'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1311'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1312'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1313'></font>
      DO K=KTS,KTE<a name='1314'>
        DO J=MYJS1_P1,MYJE1_P1<a name='1315'>
          DO I=MYIS_P1,MYIE_P1<a name='1316'>
            U_PHY(I,K,J)=(U(I+IHE(J),J,K)+U(I+IHW(J),J,K)               &amp;<a name='1317'>
     &amp;                   +U(I,J+1,K)+U(I,J-1,K))                        &amp;<a name='1318'>
     &amp;                   *0.25<a name='1319'>
            V_PHY(I,K,J)=(V(I+IHE(J),J,K)+V(I+IHW(J),J,K)               &amp;<a name='1320'>
     &amp;                   +V(I,J+1,K)+V(I,J-1,K))                        &amp;<a name='1321'>
     &amp;                   *0.25<a name='1322'>
          IF ( K == KTS ) THEN<a name='1323'>
             ULOWL(I,J) = U_PHY(I,K,J)<a name='1324'>
             VLOWL(I,J) = V_PHY(I,K,J)<a name='1325'>
          ENDIF<a name='1326'>
          ENDDO<a name='1327'>
        ENDDO<a name='1328'>
      ENDDO<a name='1329'>
<font color=#447700>!<a name='1330'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1331'></font>
<font color=#447700>!$omp&amp; private(i,iend,istr,j)<a name='1332'></font>
      DO J=MYJS1_P1,MYJE1_P1<a name='1333'>
        IF(MOD(J,2)==0)THEN<a name='1334'>
          ISTR=MYIS_P1<a name='1335'>
          IEND=MIN(MYIE_P1,IDE-1)<a name='1336'>
        ELSE<a name='1337'>
          ISTR=MAX(MYIS_P1,IDS+1)<a name='1338'>
          IEND=MIN(MYIE_P1,IDE-1)<a name='1339'>
        ENDIF<a name='1340'>
<font color=#447700>!<a name='1341'></font>
        DO I=ISTR,IEND<a name='1342'>
          UZ0H(I,J)=(UZ0(I+IHE(J),J)+UZ0(I+IHW(J),J)                    &amp;<a name='1343'>
     &amp;              +UZ0(I,J+1)+UZ0(I,J-1))*0.25<a name='1344'>
<font color=#447700>!!!  &amp;              +UZ0(I,J+1)+UZ0(I,J-1))*HBM2(I,J)*0.25<a name='1345'></font>
          VZ0H(I,J)=(VZ0(I+IHE(J),J)+VZ0(I+IHW(J),J)                    &amp;<a name='1346'>
     &amp;              +VZ0(I,J+1)+VZ0(I,J-1))*0.25<a name='1347'>
<font color=#447700>!!!  &amp;              +VZ0(I,J+1)+VZ0(I,J-1))*HBM2(I,J)*0.25<a name='1348'></font>
        ENDDO<a name='1349'>
      ENDDO<a name='1350'>
<font color=#447700>!<a name='1351'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1352'></font>
<font color=#447700>!***  SET MAVAIL EQUAL TO 1. ONLY FOR NMM LSM<a name='1353'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1354'></font>
<font color=#447700>!<a name='1355'></font>
      DO J=JTS,JTE<a name='1356'>
      DO I=ITS,ITE<a name='1357'>
        IF(MODEL_CONFIG_REC%SF_SURFACE_PHYSICS(GRID%ID)==2.OR.          &amp;<a name='1358'>
           MODEL_CONFIG_REC%SF_SURFACE_PHYSICS(GRID%ID)==99)THEN<a name='1359'>
          ONE(I,J)=1.<a name='1360'>
        ELSE<a name='1361'>
<font color=#447700>!***  MAVAIL should not be equal to 1. for other LSMs<a name='1362'></font>
          ONE(I,J)=MAVAIL(I,J)<a name='1363'>
        ENDIF<a name='1364'>
      ENDDO<a name='1365'>
      ENDDO<a name='1366'>
<font color=#447700>!<a name='1367'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1368'></font>
<font color=#447700>!***  TRANSPOSE THE MOIST ARRAY (IJK) FOR THE PHYSICS (IKJ).<a name='1369'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1370'></font>
<font color=#447700>!<a name='1371'></font>
      DO N=1,N_MOIST<a name='1372'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1373'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1374'></font>
        DO K=KMS,KME<a name='1375'>
        DO J=JMS,JME<a name='1376'>
        DO I=IMS,IME<a name='1377'>
          MOIST_TRANS(I,K,J,N)=MOIST(I,J,K,N)<a name='1378'>
        ENDDO<a name='1379'>
        ENDDO<a name='1380'>
        ENDDO<a name='1381'>
      ENDDO<a name='1382'>
<font color=#447700>!<a name='1383'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1384'></font>
<font color=#447700>!***  URBAN RELATED VARIABLES ARE ADDED TO ARGUMENTS OF SURFACE_DRIVER<a name='1385'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1386'></font>
<font color=#447700>!<a name='1387'></font>
      NUM_ROOF_LAYERS=GRID%NUM_SOIL_LAYERS   <font color=#447700>!urban<a name='1388'></font>
      NUM_WALL_LAYERS=GRID%NUM_SOIL_LAYERS   <font color=#447700>!urban<a name='1389'></font>
      NUM_ROAD_LAYERS=GRID%NUM_SOIL_LAYERS   <font color=#447700>!urban<a name='1390'></font>
      CALL nl_get_isurban(grid%id, isurban)<a name='1391'>
      call nl_get_mminlu(grid%id, mminlu)<a name='1392'>
<a name='1393'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_7">( grid, current_time=currentTime, &amp;<a name='1394'>
                            current_timestr=mesg )<a name='1395'>
     CALL WRFU_TimeGet( currentTime, YY=yr, dayOfYear=day, H=hr, M=minute, S=sec, rc=rc)<a name='1396'>
         IF( rc/= WRFU_SUCCESS)THEN<a name='1397'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_91">('WRFU_TimeGet failed')<a name='1398'>
         ENDIF<a name='1399'>
<a name='1400'>
<a name='1401'>
<font color=#447700>!<a name='1402'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1403'></font>
<font color=#447700>!<a name='1404'></font>
<font color=#447700>!***  CALL SURFACE LAYER AND LAND SURFACE PHYSICS<a name='1405'></font>
<font color=#447700>!<a name='1406'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1407'></font>
<font color=#447700>!<a name='1408'></font>
      CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>SET_TILES</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_6">(GRID,IDS,IDE-1,JDS+1,JDE-1,ITS,ITE,JTS,JTE)<a name='1409'>
<a name='1410'>
<font color=#447700>!<a name='1411'></font>
      CALL <A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER'>SURFACE_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_DRIVER_2">(                                              &amp;<a name='1412'>
     &amp;           HYDRO_dt=-1.0,  SFCHEADRT=SFCHEADRT,                   &amp;<a name='1413'>
     &amp;           INFXSRT=INFXSRT,  SOLDRAIN=SOLDRAIN,                   &amp;<a name='1414'>
     &amp;           JULIAN_IN=grid%julian,                                 &amp;<a name='1415'>
     &amp;           ACSNOM=ACSNOM,ACSNOW=ACSNOW,AKHS=AKHS,AKMS=AKMS        &amp;<a name='1416'>
     &amp;          ,ALBEDO=ALBEDO,BR=BR,CANWAT=CMC,CHKLOWQ=CHKLOWQ         &amp;<a name='1417'>
     &amp;          ,DT=DT,DX=DX,DZ8W=DZ,DZS=DZSOIL,GLW=RLW_DN_SFC          &amp;<a name='1418'>
     &amp;          ,GRDFLX=GRNFLX,GSW=RSW_NET_SFC,SWDOWN=RSW_DN_SFC        &amp;<a name='1419'>
     &amp;          ,GZ1OZ0=GZ1OZ0,HFX=TWBS                                 &amp;<a name='1420'>
     &amp;          ,HT=SFCZ,IFSNOW=IDUMMY,ISFFLX=ISFFLX                    &amp;<a name='1421'>
     &amp;          ,FRACTIONAL_SEAICE=FRACTIONAL_SEAICE                    &amp;<a name='1422'>
     &amp;          ,SEAICE_ALBEDO_OPT=SEAICE_ALBEDO_OPT                    &amp;<a name='1423'>
     &amp;          ,SEAICE_ALBEDO_DEFAULT=SEAICE_ALBEDO_DEFAULT            &amp;<a name='1424'>
     &amp;          ,SEAICE_THICKNESS_OPT=SEAICE_THICKNESS_OPT              &amp;<a name='1425'>
     &amp;          ,SEAICE_THICKNESS_DEFAULT=SEAICE_THICKNESS_DEFAULT      &amp;<a name='1426'>
     &amp;          ,SEAICE_SNOWDEPTH_OPT=SEAICE_SNOWDEPTH_OPT              &amp;<a name='1427'>
     &amp;          ,SEAICE_SNOWDEPTH_MAX=SEAICE_SNOWDEPTH_MAX              &amp;<a name='1428'>
     &amp;          ,SEAICE_SNOWDEPTH_MIN=SEAICE_SNOWDEPTH_MIN              &amp;<a name='1429'>
     &amp;          ,TICE2TSK_IF2COLD=CONFIG_FLAGS%TICE2TSK_IF2COLD         &amp;<a name='1430'>
     &amp;          ,IFNDALBSI=IFNDALBSI,IFNDICEDEPTH=IFNDICEDEPTH          &amp;<a name='1431'>
     &amp;          ,IFNDSNOWSI=IFNDSNOWSI                                  &amp;<a name='1432'>
     &amp;          ,ISLTYP=ISLTYP                                          &amp;<a name='1433'>
     &amp;          ,ITIMESTEP=NTSD,IVGTYP=IVGTYP,LOWLYR=LOWLYR             &amp;<a name='1434'>
     &amp;          ,MAVAIL=ONE,RMOL=RMOL,MOL=MOL                           &amp;<a name='1435'>
     &amp;          ,NUM_SOIL_LAYERS=NSOIL,P8W=P8W                          &amp;<a name='1436'>
     &amp;          ,PBLH=PBLH,PI_PHY=PI_PHY,PSHLTR=PSHLTR,PSIH=PSIH        &amp;<a name='1437'>
     &amp;          ,PSIM=PSIM,P_PHY=P_PHY,Q10=Q10,Q2=Q2X,QFX=QWBS,TAUX=TAUX,TAUY=TAUY,QSFC=QS  &amp;<a name='1438'>
     &amp;          ,QSHLTR=QSHLTR,QZ0=QZ0                                  &amp;<a name='1439'>
     &amp;          ,ICOEF_SF=CONFIG_FLAGS%ICOEF_SF                         &amp;<a name='1440'>
     &amp;          ,LCURR_SF=CONFIG_FLAGS%LCURR_SF                         &amp;<font color=#447700>!for gfdl-sf drag<a name='1441'></font>
     &amp;          ,ZKMAX=ZKMAX,RIBN=RIBN                                  &amp;<a name='1442'>
     &amp;          ,CHARN=CHARN,MSANG=MSANG,SCURX=SCURX,SCURY=SCURY        &amp;<a name='1443'>
     &amp;          ,IWAVECPL=CONFIG_FLAGS%IWAVECPL                         &amp;<a name='1444'>
#if (HWRF==1)<a name='1445'>
     &amp;          ,pert_Cd=config_flags%pert_Cd                           &amp;<a name='1446'>
     &amp;          ,ens_random_seed=config_flags%ens_random_seed           &amp;<a name='1447'>
     &amp;          ,ens_Cdamp=config_flags%ens_Cdamp                       &amp;<a name='1448'>
#endif<a name='1449'>
     &amp;          ,cd_out=grid%cd_out,ch_out=grid%ch_out                  &amp;<a name='1450'>
     &amp;          ,RAINCV=RAIN                                            &amp;<a name='1451'>
     &amp;          ,RHO=RR,SFCEVP=SFCEVPX,SFCEXC=SFCEXC,SFCRUNOFF=SSROFF   &amp;<a name='1452'>
     &amp;          ,SMOIS=SMC,SMSTAV=SMSTAV,SMSTOT=SMSTOT,SNOALB=MXSNAL    &amp;<a name='1453'>
     &amp;          ,SNOW=SNOW,SNOWC=SNOWC,SNOWH=SNOWH,STEPBL=NPHS          &amp;<a name='1454'>
     &amp;          ,SMCREL=SMCREL                                          &amp;<a name='1455'>
     &amp;          ,SST=SST,SST_UPDATE=SST_UPDATE,MAX_EDOM=-1              &amp;<a name='1456'>
     &amp;          ,TH10=TH10,TH2=TH2X,T2=T2,THZ0=THZ0,TH_PHY=TH_PHY       &amp;<a name='1457'>
     &amp;          ,TMN=TG,TSHLTR=TSHLTR,TSK=TSFC,TSLB=STC,T_PHY=T_PHY     &amp;<a name='1458'>
     &amp;          ,U10=U10,UDRUNOFF=BGROFF,UST=USTAR,UZ0=UZ0H             &amp;<a name='1459'>
     &amp;          ,U_FRAME=U_FRAME,U_PHY=U_PHY,V10=V10,VEGFRA=VGFRCK      &amp;<a name='1460'>
     &amp;          ,UOCE=UOCE,VOCE=VOCE                                    &amp;<a name='1461'>
     &amp;          ,VZ0=VZ0H,V_FRAME=V_FRAME,V_PHY=V_PHY                   &amp;<a name='1462'>
     &amp;          ,WARM_RAIN=WARM_RAIN,WSPD=WSPD,XICE=SICE,XICEM=SICE     &amp;<a name='1463'>
     &amp;          ,ALBSI=albsi,ICEDEPTH=icedepth,SNOWSI=snowsi            &amp;<a name='1464'>
     &amp;          ,ISICE=GRID%LANDUSE_ISICE,ISWATER=GRID%ISWATER          &amp;<a name='1465'>
     &amp;          ,XLAND=XLAND,Z=Z,ZNT=Z0                                 &amp;<a name='1466'>
#if ( HWRF == 1 )<a name='1467'>
     &amp;          ,MZNT=MZ0                                               &amp;<a name='1468'>
#endif<a name='1469'>
     &amp;          ,ZS=SLDPTH,CT=CT,TKE_PBL=TKE,SFENTH=SFENTH              &amp;   <font color=#447700>!KWON<a name='1470'></font>
     &amp;          ,ALBBCK=ALBASE,LH=ELFLX,SH2O=SH2O,SHDMAX=SHDMAX         &amp;<a name='1471'>
     &amp;          ,SHDMIN=SHDMIN,Z0=Z0BASE,FLQC=FLQC,FLHC=FLHC            &amp;<a name='1472'>
     &amp;          ,FM=FM,FHH=FH,ZOL=ZOL                                   &amp;<a name='1473'>
     &amp;          ,PSFC=PSFC_OUT,EMISS=EPSR,EMBCK=EMBCK                   &amp;<a name='1474'>
     &amp;          ,SF_SFCLAY_PHYSICS=CONFIG_FLAGS%SF_SFCLAY_PHYSICS       &amp;<a name='1475'>
     &amp;          ,SF_SURFACE_PHYSICS=CONFIG_FLAGS%SF_SURFACE_PHYSICS     &amp;<a name='1476'>
     &amp;          ,RA_LW_PHYSICS=CONFIG_FLAGS%RA_LW_PHYSICS               &amp;<a name='1477'>
     &amp;          ,RA_SW_PHYSICS=CONFIG_FLAGS%RA_SW_PHYSICS               &amp;<a name='1478'>
     &amp;          ,LAI=GRID%LAI,IZ0TLND=CONFIG_FLAGS%IZ0TLND              &amp;<a name='1479'>
     &amp;          ,SF_URBAN_PHYSICS=SF_URBAN_PHYSICS                      &amp;<a name='1480'>
<font color=#447700>!     &amp;          ,GMT=GMT,XLAT=XLAT,XLONG=XLONG,JULDAY=JULDAY            &amp;<a name='1481'></font>
     &amp;          ,NUM_URBAN_LAYERS=NUM_URBAN_LAYERS                      &amp;<a name='1482'>
     &amp;          ,NUM_URBAN_HI=config_flags%num_urban_hi                 &amp; <font color=#447700>!multi-layer urban<a name='1483'></font>
     &amp;          ,IDS=IDS,IDE=IDE,JDS=JDS,JDE=JDE,KDS=KDS,KDE=KDE        &amp;<a name='1484'>
     &amp;          ,IMS=IMS,IME=IME,JMS=JMS,JME=JME,KMS=KMS,KME=KME        &amp;<a name='1485'>
     &amp;          ,IPS=ips,IPE=ipe, JPS=jps,JPE=jpe, KPS=kps,KPE=kpe      &amp; <a name='1486'>
     &amp;          ,I_START=GRID%I_START,I_END=GRID%I_END                  &amp;<a name='1487'>
     &amp;          ,J_START=GRID%J_START,J_END=GRID%J_END                  &amp;<a name='1488'>
     &amp;          ,KTS=KTS,KTE=KTE,NUM_TILES=GRID%NUM_TILES               &amp;<a name='1489'>
           <font color=#447700>! Optional args<a name='1490'></font>
     &amp;          ,QV_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QV),F_QV=F_QV        &amp;<a name='1491'>
     &amp;          ,QC_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QC),F_QC=F_QC        &amp;<a name='1492'>
     &amp;          ,QR_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QR),F_QR=F_QR        &amp;<a name='1493'>
     &amp;          ,QI_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QI),F_QI=F_QI        &amp;<a name='1494'>
     &amp;          ,QS_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QS),F_QS=F_QS        &amp;<a name='1495'>
     &amp;          ,QG_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QG),F_QG=F_QG        &amp;<a name='1496'>
     &amp;          ,RAINBL=RAINBL                                          &amp;<a name='1497'>
     &amp;          ,LAGDAY=1                                               &amp; <font color=#447700>! tmn_update<a name='1498'></font>
<font color=#447700>! for RUCLSM<a name='1499'></font>
     &amp;          ,QSG=QSG,QVG=QVG,QCG=QCG,SOILT1=SOILT1                  &amp;<a name='1500'>
     &amp;          ,TSNAV=TSNAV,SMFR3D=SMFR3D,KEEPFR3DFLAG=KEEPFR3DFLAG    &amp;<a name='1501'>
     &amp;          ,POTEVP=POTEVP,SNOPCX=SNOPCX,SOILTB=SOILTB,SR=SR        &amp;<a name='1502'>
     &amp;          ,DEW=DEW,ACRUNOFF=grid%ACRUNOFF                         &amp;<a name='1503'>
     &amp;          ,MOSAIC_LU=CONFIG_FLAGS%MOSAIC_LU                       &amp;<a name='1504'>
     &amp;          ,MOSAIC_SOIL=CONFIG_FLAGS%MOSAIC_SOIL                   &amp;<a name='1505'>
     &amp;          ,LANDUSEF=grid%landusef                                 &amp;<a name='1506'>
     &amp;          ,SOILCTOP=grid%soilctop                                 &amp;<a name='1507'>
     &amp;          ,rhosnf=grid%rhosnf,precipfr=grid%precipfr              &amp;<a name='1508'>
     &amp;          ,snowfallac=grid%snowfallac                             &amp;<a name='1509'>
<font color=#447700>! for URBAN<a name='1510'></font>
     &amp;          ,NUM_ROOF_LAYERS=NUM_ROOF_LAYERS                        &amp; <font color=#447700>! urban<a name='1511'></font>
     &amp;          ,NUM_WALL_LAYERS=NUM_WALL_LAYERS                        &amp; <font color=#447700>! urban<a name='1512'></font>
     &amp;          ,NUM_ROAD_LAYERS=NUM_ROAD_LAYERS                        &amp; <font color=#447700>! urban<a name='1513'></font>
<font color=#447700>! for YSU<a name='1514'></font>
     &amp;          ,REGIME=REGIME                                          &amp;<a name='1515'>
<font color=#447700>! for PX LSM<a name='1516'></font>
     &amp;          ,NLCAT=grid%num_land_cat,  NSCAT=grid%num_soil_cat      &amp; <font color=#447700>! P-X LSM<a name='1517'></font>
     &amp;        ,ISURBAN=isurban, MMINLU=TRIM(mminlu)                       &amp;<a name='1518'>
     &amp;        ,SNOTIME = grid%SNOTIME &amp;<a name='1519'>
     &amp;        ,RDLAI2D=config_flags%rdlai2d                                   &amp;<a name='1520'>
     &amp;        ,usemonalb=config_flags%usemonalb                           &amp;<a name='1521'>
     &amp;        ,NOAHRES=grid%noahres                                       &amp;<a name='1522'>
     &amp;        ,opt_thcnd=config_flags%opt_thcnd       &amp;<a name='1523'>
<font color=#447700>! for Noah UA changes<a name='1524'></font>
     &amp;        ,ua_phys=config_flags%ua_phys,flx4=grid%flx4,fvb=grid%fvb       &amp;<a name='1525'>
     &amp;        ,fbur=grid%fbur,fgsn=grid%fgsn                                  &amp;<a name='1526'>
<font color=#447700>! vertical dimensions for ocean model, not used for NMM<a name='1527'></font>
     &amp;        ,okms = 1, okme=2                                          &amp;<a name='1528'>
<font color=#447700>! for NOAH-MP LSM<a name='1529'></font>
     &amp;        ,YR=yr                                       &amp;<a name='1530'>
     &amp;        ,idveg=config_flags%dveg,         iopt_crs=config_flags%opt_crs &amp;<a name='1531'>
     &amp;        ,iopt_btr=config_flags%opt_btr,   iopt_run=config_flags%opt_run &amp;<a name='1532'>
     &amp;        ,iopt_sfc=config_flags%opt_sfc,   iopt_frz=config_flags%opt_frz &amp;<a name='1533'>
     &amp;        ,iopt_inf=config_flags%opt_inf,   iopt_rad=config_flags%opt_rad &amp;<a name='1534'>
     &amp;        ,iopt_alb=config_flags%opt_alb,   iopt_snf=config_flags%opt_snf &amp;<a name='1535'>
     &amp;        ,iopt_tbot=config_flags%opt_tbot, iopt_stc=config_flags%opt_stc &amp; <a name='1536'>
     &amp;        ,iopt_gla=config_flags%opt_gla,   iopt_rsf=config_flags%opt_rsf &amp; <a name='1537'>
     &amp;        , isnowxy=grid%isnowxy  ,    tvxy=grid%tvxy    ,    tgxy=grid%tgxy     &amp;<a name='1538'>
     &amp;        ,canicexy=grid%canicexy ,canliqxy=grid%canliqxy,   eahxy=grid%eahxy    &amp;<a name='1539'>
     &amp;        ,   tahxy=grid%tahxy    ,    cmxy=grid%cmxy    ,    chxy=grid%chxy     &amp;<a name='1540'>
     &amp;        ,  fwetxy=grid%fwetxy   ,sneqvoxy=grid%sneqvoxy,alboldxy=grid%alboldxy &amp;<a name='1541'>
     &amp;        , qsnowxy=grid%qsnowxy  ,wslakexy=grid%wslakexy,   zwtxy=grid%zwtxy    &amp;<a name='1542'>
     &amp;        ,    waxy=grid%waxy     ,    wtxy=grid%wtxy    ,  tsnoxy=grid%tsnoxy   &amp;<a name='1543'>
     &amp;        , zsnsoxy=grid%zsnsoxy  , snicexy=grid%snicexy , snliqxy=grid%snliqxy  &amp;<a name='1544'>
     &amp;        ,lfmassxy=grid%lfmassxy ,rtmassxy=grid%rtmassxy,stmassxy=grid%stmassxy &amp;<a name='1545'>
     &amp;        ,  woodxy=grid%woodxy   ,stblcpxy=grid%stblcpxy,fastcpxy=grid%fastcpxy &amp;<a name='1546'>
     &amp;        , grainxy=grid%grainxy  ,   gddxy=grid%gddxy   ,   pgsxy=grid%pgsxy    &amp;<a name='1547'>
     &amp;        , cropcat=grid%cropcat                                                 &amp;<a name='1548'>
     &amp;        ,planting=grid%planting , harvest=grid%harvest ,season_gdd=grid%season_gdd  &amp;<a name='1549'>
     &amp;        ,  xsaixy=grid%xsaixy   , taussxy=grid%taussxy                         &amp;<a name='1550'>
     &amp;        ,  t2mvxy=grid%t2mvxy   ,  t2mbxy=grid%t2mbxy                          &amp;<a name='1551'>
     &amp;        ,  q2mvxy=grid%q2mvxy   ,  q2mbxy=grid%q2mbxy                          &amp; <a name='1552'>
     &amp;        ,  tradxy=grid%tradxy   ,   neexy=grid%neexy   ,   gppxy=grid%gppxy    &amp;<a name='1553'>
     &amp;        ,   nppxy=grid%nppxy    ,  fvegxy=grid%fvegxy  , runsfxy=grid%runsfxy  &amp;<a name='1554'>
     &amp;        , runsbxy=grid%runsbxy  ,  ecanxy=grid%ecanxy  ,  edirxy=grid%edirxy   &amp;<a name='1555'>
     &amp;        , etranxy=grid%etranxy  ,   fsaxy=grid%fsaxy   ,  firaxy=grid%firaxy   &amp;<a name='1556'>
     &amp;        ,  aparxy=grid%aparxy   ,   psnxy=grid%psnxy   ,   savxy=grid%savxy    &amp;<a name='1557'>
     &amp;        ,   sagxy=grid%sagxy    , rssunxy=grid%rssunxy , rsshaxy=grid%rsshaxy  &amp;<a name='1558'>
     &amp;        ,  bgapxy=grid%bgapxy   ,  wgapxy=grid%wgapxy  ,   tgvxy=grid%tgvxy    &amp;<a name='1559'>
     &amp;        ,   tgbxy=grid%tgbxy    ,   chvxy=grid%chvxy   ,   chbxy=grid%chbxy    &amp;<a name='1560'>
     &amp;        ,   shgxy=grid%shgxy    ,   shcxy=grid%shcxy   ,   shbxy=grid%shbxy    &amp;<a name='1561'>
     &amp;        ,   evgxy=grid%evgxy    ,   evbxy=grid%evbxy   ,   ghvxy=grid%ghvxy    &amp;<a name='1562'>
     &amp;        ,   ghbxy=grid%ghbxy    ,   irgxy=grid%irgxy   ,   ircxy=grid%ircxy    &amp;<a name='1563'>
     &amp;        ,   irbxy=grid%irbxy    ,    trxy=grid%trxy    ,   evcxy=grid%evcxy    &amp;<a name='1564'>
     &amp;        ,chleafxy=grid%chleafxy ,  chucxy=grid%chucxy                          &amp;                       <a name='1565'>
     &amp;        ,  chv2xy=grid%chv2xy   ,  chb2xy=grid%chb2xy , chstarxy=grid%chstarxy &amp;                       <a name='1566'>
     &amp;        ,  smoiseq=grid%smoiseq, smcwtdxy=grid%smcwtdxy, rechxy=grid%rechxy    &amp;                       <a name='1567'>
     &amp;        ,  deeprechxy=grid%deeprechxy                                          &amp;                       <a name='1568'>
     &amp;        ,coszen=grid%czen,xlat_urb2d=grid%hlat                                 &amp;<a name='1569'>
<a name='1570'>
<font color=#447700>! mosaic tiling for Noah<a name='1571'></font>
     &amp;        ,sf_surface_mosaic=config_flags%sf_surface_mosaic,  mosaic_cat=config_flags%mosaic_cat      &amp;<a name='1572'>
<font color=#447700>! lake module<a name='1573'></font>
     &amp;        ,lakedepth2d=grid%lakedepth2d, savedtke12d=grid%savedtke12d, snowdp2d=grid%snowdp2d, h2osno2d=grid%h2osno2d    &amp;<a name='1574'>
     &amp;        ,snl2d=grid%snl2d, t_grnd2d=grid%t_grnd2d, t_lake3d=grid%t_lake3d,   lake_icefrac3d=grid%lake_icefrac3d        &amp;<a name='1575'>
     &amp;        ,z_lake3d=grid%z_lake3d, dz_lake3d=grid%dz_lake3d, t_soisno3d=grid%t_soisno3d, h2osoi_ice3d=grid%h2osoi_ice3d  &amp;<a name='1576'>
     &amp;        ,h2osoi_liq3d=grid%h2osoi_liq3d, h2osoi_vol3d=grid%h2osoi_vol3d, z3d=grid%z3d, dz3d=grid%dz3d                  &amp;<a name='1577'>
     &amp;        ,zi3d=grid%zi3d, watsat3d=grid%watsat3d, csol3d=grid%csol3d, tkmg3d=grid%tkmg3d                                &amp;<a name='1578'>
     &amp;        ,tkdry3d=grid%tkdry3d,tksatu3d=grid%tksatu3d, LakeModel=grid%sf_lake_physics,  lake_min_elev=grid%lake_min_elev  &amp;<a name='1579'>
<font color=#447700>! end lake module<a name='1580'></font>
     &amp;        ,maxpatch=1,inest=1,history_interval=config_flags%history_interval  &amp; <font color=#447700>!clm<a name='1581'></font>
     &amp;        ,fasdas=fasdas<a name='1582'>
     &amp;                                                          )<a name='1583'>
<font color=#447700>!<a name='1584'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1585'></font>
<font color=#447700>!<a name='1586'></font>
<font color=#447700>!***  CALL FREE ATMOSPHERE TURBULENCE<a name='1587'></font>
<font color=#447700>!<a name='1588'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1589'></font>
<font color=#447700>!<a name='1590'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1591'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1592'></font>
      DO J=JMS,JME<a name='1593'>
      DO K=KMS,KME<a name='1594'>
      DO I=IMS,IME<a name='1595'>
        DUDT_PHY(I,K,J)=0.<a name='1596'>
        DVDT_PHY(I,K,J)=0.<a name='1597'>
      ENDDO<a name='1598'>
      ENDDO<a name='1599'>
      ENDDO<a name='1600'>
<font color=#447700>!<a name='1601'></font>
<font color=#447700>!***  THE SURFACE EXCHANGE COEFFICIENTS AKHS AND AKMS ARE ACTUALLY<a name='1602'></font>
<font color=#447700>!***  MULTIPLIED BY HALF THE DEPTH OF THE LOWEST LAYER.  WE MUST RETAIN<a name='1603'></font>
<font color=#447700>!***  THOSE VALUES FOR THE NEXT TIMESTEP SO USE AUXILLIARY ARRAYS FOR<a name='1604'></font>
<font color=#447700>!***  THE OUTPUT.<a name='1605'></font>
<font color=#447700>!<a name='1606'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1607'></font>
<font color=#447700>!$omp&amp; private(dzhalf,i,j)<a name='1608'></font>
      DO J=JTS,JTE<a name='1609'>
      DO I=ITS,ITE<a name='1610'>
        DZHALF=0.5*DZ(I,KTS,J)<a name='1611'>
        AKHS_OUT(I,J)=AKHS(I,J)*DZHALF<a name='1612'>
        AKMS_OUT(I,J)=AKMS(I,J)*DZHALF<a name='1613'>
      ENDDO<a name='1614'>
      ENDDO<a name='1615'>
<font color=#447700>!<a name='1616'></font>
<font color=#447700>!-- ETAMP_Regional logical is true for regional NAM (ETAMPNEW) or HRW (ETAMPNEW) microphysics<a name='1617'></font>
<font color=#447700>!<a name='1618'></font>
      ETAMP_Regional=.FALSE.<a name='1619'>
      IF (CONFIG_FLAGS%MP_PHYSICS==ETAMPNEW .OR.                        &amp;<a name='1620'>
     &amp;    CONFIG_FLAGS%MP_PHYSICS==FER_MP_HIRES) ETAMP_Regional=.TRUE.<a name='1621'>
<font color=#447700>!<a name='1622'></font>
      IF(ETAMP_Regional) THEN<a name='1623'>
<font color=#447700>!-- Logical FQ_I and index PQ_I are set to values associated with snow<a name='1624'></font>
<font color=#447700>!   for the regional (NAM, HWRF) versions of the microphysics<a name='1625'></font>
         FQ_I=F_QS<a name='1626'>
         PQ_I=P_QS<a name='1627'>
      ELSE<a name='1628'>
         FQ_I=F_QI<a name='1629'>
         PQ_I=P_QI<a name='1630'>
      ENDIF<a name='1631'>
#if HWRF==1<a name='1632'>
      CALL nl_get_var_ric(1, var_ric)<a name='1633'>
      CALL nl_get_coef_ric_s(1, coef_ric_s)<a name='1634'>
      CALL nl_get_coef_ric_l(1, coef_ric_l)<a name='1635'>
<font color=#447700>!      write(0,*) 'var_ric &amp; coef_ric_s l from namelist Kwon  ',var_ric,coef_ric_s,coef_ric_l<a name='1636'></font>
#endif<a name='1637'>
<font color=#447700>!<a name='1638'></font>
      CALL <A href='../../html_code/phys/module_pbl_driver.F.html#PBL_DRIVER'>PBL_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PBL_DRIVER_2">(                                                &amp;<a name='1639'>
     &amp;                ITIMESTEP=NTSD,DT=DT                            &amp;<a name='1640'>
     &amp;               ,U_FRAME=U_FRAME,V_FRAME=V_FRAME                 &amp;<a name='1641'>
     &amp;               ,RUBLTEN=DUDT_PHY,RVBLTEN=DVDT_PHY               &amp;<a name='1642'>
     &amp;               ,RTHBLTEN=RTHBLTEN,RQVBLTEN=RQVBLTEN             &amp; <font color=#447700>!BSF<a name='1643'></font>
     &amp;               ,RQCBLTEN=RQCBLTEN,RQIBLTEN=RQIBLTEN             &amp; <font color=#447700>!BSF<a name='1644'></font>
<font color=#447700>!BSF &amp;               ,RQRBLTEN=RQRBLTEN,RQSBLTEN=RQSBLTEN             &amp; !BSF<a name='1645'></font>
<font color=#447700>!BSF &amp;               ,RQGBLTEN=RQGBLTEN                               &amp; !BSF<a name='1646'></font>
     &amp;               ,TSK=TSFC,XLAND=XLAND,ZNT=Z0                     &amp;<a name='1647'>
#if ( HWRF == 1 )<a name='1648'>
     &amp;               ,MSANG=MSANG,SCURX=SCURX,SCURY=SCURY             &amp;<a name='1649'>
     &amp;               ,IWAVECPL=CONFIG_FLAGS%IWAVECPL                  &amp;<a name='1650'>
     &amp;               ,LCURR_SF=CONFIG_FLAGS%LCURR_SF                  &amp;<a name='1651'>
<a name='1652'>
     &amp;               ,MZNT=MZ0                                        &amp;<a name='1653'>
#endif<a name='1654'>
     &amp;               ,HT=SFCZ                                         &amp;   <font color=#447700>!KWON<a name='1655'></font>
     &amp;               ,UST=USTAR,MIXHT=MIXHT,PBLH=PBLH                 &amp;<a name='1656'>
     &amp;               ,HFX=TWBS,QFX=QWBS,GRDFLX=GRNFLX                 &amp;<a name='1657'>
     &amp;               ,U_PHY=U_PHY,V_PHY=V_PHY,TH_PHY=TH_PHY,RHO=RR    &amp;<a name='1658'>
     &amp;               ,P_PHY=P_PHY,PI_PHY=PI_PHY,P8W=P8W,T_PHY=T_PHY   &amp;<a name='1659'>
     &amp;               ,DZ8W=DZ,Z=Z,TKE_PBL=TKE,EL_PBL=EL_MYJ,F=F       &amp;<a name='1660'>
     &amp;               ,EXCH_H=EXCH_H,EXCH_M=EXCH_M,AKHS=AKHS,AKMS=AKMS &amp;<a name='1661'>
     &amp;               ,FM=FM,FHH=FH                                    &amp;<a name='1662'>
     &amp;               ,YSU_TOPDOWN_PBLMIX=CONFIG_FLAGS%YSU_TOPDOWN_PBLMIX &amp;<a name='1663'>
     &amp;               ,SHINHONG_TKE_DIAG=CONFIG_FLAGS%SHINHONG_TKE_DIAG &amp;<a name='1664'>
     &amp;               ,THZ0=THZ0,QZ0=QZ0,UZ0=UZ0H,VZ0=VZ0H             &amp;<a name='1665'>
     &amp;               ,QSFC=QS,LOWLYR=LOWLYR                           &amp;<a name='1666'>
     &amp;               ,PSIM=PSIM,PSIH=PSIH,GZ1OZ0=GZ1OZ0               &amp;<a name='1667'>
     &amp;               ,U10=U10,V10=V10,UOCE=UOCE,VOCE=VOCE,T2=T2,WSPD=WSPD,BR=BR,CHKLOWQ=CHKLOWQ &amp;   <a name='1668'>
     &amp;               ,DX=DX,DY=DY,STEPBL=NPHS,WARM_RAIN=WARM_RAIN     &amp;<a name='1669'>
     &amp;               ,KPBL=KPBL,CT=CT,LH=ELFLX,SNOW=SNOW,XICE=SICE    &amp;<a name='1670'>
     &amp;               ,BL_PBL_PHYSICS=config_flags%bl_pbl_physics      &amp;<a name='1671'>
     &amp;               ,RA_LW_PHYSICS=config_flags%ra_lw_physics        &amp;<a name='1672'>
     &amp;               ,MFSHCONV=config_flags%mfshconv                  &amp;  <font color=#447700>! work with QNSE PBL<a name='1673'></font>
     &amp;               ,rc_mf=rc_mf                                     &amp;  <font color=#447700>! QNSE<a name='1674'></font>
     &amp;               ,IDS=IDS,IDE=IDE,JDS=JDS,JDE=JDE,KDS=KDS,KDE=KDE &amp;<a name='1675'>
     &amp;               ,IMS=IMS,IME=IME,JMS=JMS,JME=JME,KMS=KMS,KME=KME &amp;<a name='1676'>
     &amp;               ,I_START=GRID%I_START,I_END=GRID%I_END           &amp;<a name='1677'>
     &amp;               ,J_START=GRID%J_START,J_END=GRID%J_END           &amp;<a name='1678'>
     &amp;               ,KTS=KTS,KTE=KTE,NUM_TILES=GRID%NUM_TILES        &amp;<a name='1679'>
     &amp;               ,CTOPO=grid%ctopo,CTOPO2=grid%ctopo2             &amp;<a name='1680'>
     &amp;               ,WINDFARM_OPT=config_flags%windfarm_opt          &amp;<a name='1681'>
     &amp;               ,POWER=grid%POWER                                &amp;<a name='1682'>
     &amp;               ,NUM_SCALAR=1, NUM_TRACER=1                      &amp;  <font color=#447700>! parameters not used by NMM<a name='1683'></font>
#if (NMM_CORE==1)<a name='1684'>
     &amp;               ,DISHEAT=DISHEAT                                 &amp;<a name='1685'>
#endif<a name='1686'>
                <font color=#447700>! Optional args<a name='1687'></font>
     &amp;               ,RTHRATEN=RTHRATEN                               &amp;<a name='1688'>
#if (HWRF==1)<a name='1689'>
     &amp;               ,GFS_ALPHA=GRID%GFS_ALPHA                        &amp;<a name='1690'>
#endif<a name='1691'>
     &amp;               ,HPBL2D=HPBL2D, EVAP2D=EVAP2D, HEAT2D=HEAT2D     &amp;    <font color=#447700>!Kwon S&amp;P<a name='1692'></font>
     &amp;               ,RC2D=RC2D                                       &amp;    <font color=#447700>!KWON<a name='1693'></font>
#if HWRF==1<a name='1694'>
     &amp;               ,VAR_RIC=VAR_RIC                                 &amp;    <font color=#447700>!Kwon Ric<a name='1695'></font>
#endif<a name='1696'>
     &amp;               ,DKU3D=DKU3D,DKT3D=DKT3D <a name='1697'>
#if HWRF==1<a name='1698'>
     &amp;               ,coef_ric_l=coef_ric_l,coef_ric_s=coef_ric_s     &amp;    <font color=#447700>!Kwon for Ric<a name='1699'></font>
     &amp;          ,pert_pbl=config_flags%pert_pbl                       &amp;<a name='1700'>
     &amp;          ,ens_random_seed=config_flags%ens_random_seed         &amp;<a name='1701'>
     &amp;          ,ens_pblamp=config_flags%ens_pblamp                   &amp;<a name='1702'>
#endif<a name='1703'>
     &amp;               ,QV_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QV),F_QV=F_QV &amp;<a name='1704'>
     &amp;               ,QC_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QC),F_QC=F_QC &amp;<a name='1705'>
     &amp;               ,QI_CURR=MOIST_TRANS(IMS,KMS,JMS,PQ_I),F_QI=FQ_I &amp;<a name='1706'>
     &amp;               ,QR_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QR),F_QR=F_QR &amp;<a name='1707'>
     &amp;               ,QS_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QS),F_QS=F_QS &amp;<a name='1708'>
     &amp;               ,QG_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QG),F_QG=F_QG &amp;<a name='1709'>
     &amp;               ,HOL=HOL,sf_sfclay_physics=CONFIG_FLAGS%SF_SFCLAY_PHYSICS &amp;<a name='1710'>
     &amp;               ,IS_CAMMGMP_USED=IS_CAMMGMP_USED                 &amp;<a name='1711'>
     &amp;               ,wstar=wstar_ysu,delta=delta_ysu                 &amp;<a name='1712'>
     &amp;               ,fasdas=fasdas                                   &amp;<a name='1713'>
     &amp;               ,sf_urban_physics=CONFIG_FLAGS%SF_URBAN_PHYSICS)<a name='1714'>
<font color=#447700>!<a name='1715'></font>
<font color=#447700>!output PBL tendency<a name='1716'></font>
<font color=#447700>!<a name='1717'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1718'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='1719'></font>
      DO J=JMS,JME<a name='1720'>
      DO K=KMS,KME<a name='1721'>
      DO I=IMS,IME<a name='1722'>
        DUBLDT(I,J,K)=DUDT_PHY(I,K,J)<a name='1723'>
        DVBLDT(I,J,K)=DVDT_PHY(I,K,J)<a name='1724'>
        DTHBLDT(I,J,K)=RTHBLTEN(I,K,J)<a name='1725'>
        DQVBLDT(I,J,K)=RQVBLTEN(I,K,J)<a name='1726'>
      ENDDO<a name='1727'>
      ENDDO<a name='1728'>
      ENDDO<a name='1729'>
<font color=#447700>!<a name='1730'></font>
<a name='1731'>
<font color=#447700>!***  NOTE THAT THE EXCHANGE COEFFICIENTS FOR HEAT EXCH_H COMING OUT OF<a name='1732'></font>
<font color=#447700>!***  PBL_DRIVER ARE DEFINED AT THE TOPS OF THE LAYERS KTS TO KTE-1<a name='1733'></font>
<font color=#447700>!***  IF MODULE_BL_MYJPBL WAS INVOKED.<a name='1734'></font>
<font color=#447700>!<a name='1735'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1736'></font>
<font color=#447700>! UNCOMPUTED LOCATIONS MUST BE FILLED IN FOR THE POST-PROCESSOR<a name='1737'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1738'></font>
<font color=#447700>!<a name='1739'></font>
<font color=#447700>!***  EASTERN GLOBAL BOUNDARY<a name='1740'></font>
<font color=#447700>!<a name='1741'></font>
      IF(MYIE==IDE)THEN<a name='1742'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1743'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1744'></font>
        DO J=JDS,JDE<a name='1745'>
        IF (J&gt;=MYJS.AND.J&lt;=MYJE)THEN<a name='1746'>
          TH10(MYIE,J)=TH10(MYIE-1,J)<a name='1747'>
          Q10(MYIE,J)=Q10(MYIE-1,J)<a name='1748'>
          U10(MYIE,J)=U10(MYIE-1,J)<a name='1749'>
          V10(MYIE,J)=V10(MYIE-1,J)<a name='1750'>
          TSHLTR(MYIE,J)=TSHLTR(MYIE-1,J)<a name='1751'>
          QSHLTR(MYIE,J)=QSHLTR(MYIE-1,J)<a name='1752'>
        ENDIF<a name='1753'>
        ENDDO<a name='1754'>
      ENDIF<a name='1755'>
<font color=#447700>!<a name='1756'></font>
<font color=#447700>!***  SOUTHERN GLOBAL BOUNDARY<a name='1757'></font>
<font color=#447700>!<a name='1758'></font>
<a name='1759'>
      IF(MYJS==JDS)THEN<a name='1760'>
        DO J=JDS,JDS+1<a name='1761'>
        DO I=IDS,IDE<a name='1762'>
          IF (I&gt;=MYIS.AND.I&lt;=MYIE) THEN<a name='1763'>
            TH10(I,J)=TH10(I,MYJS+2)<a name='1764'>
            Q10(I,J)=Q10(I,MYJS+2)<a name='1765'>
            U10(I,J)=U10(I,MYJS+2)<a name='1766'>
            V10(I,J)=V10(I,MYJS+2)<a name='1767'>
            TSHLTR(I,J)=TSHLTR(I,MYJS+2)<a name='1768'>
            QSHLTR(I,J)=QSHLTR(I,MYJS+2)<a name='1769'>
          ENDIF<a name='1770'>
        ENDDO<a name='1771'>
        ENDDO<a name='1772'>
      ENDIF<a name='1773'>
<font color=#447700>!<a name='1774'></font>
<font color=#447700>!***  NORTHERN GLOBAL BOUNDARY<a name='1775'></font>
<font color=#447700>!<a name='1776'></font>
      IF(MYJE==JDE)THEN<a name='1777'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1778'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1779'></font>
        DO J=MYJE-1,MYJE<a name='1780'>
        DO I=IDS,IDE<a name='1781'>
          IF (I&gt;=MYIS.AND.I&lt;=MYIE) THEN<a name='1782'>
            TH10(I,J)=TH10(I,MYJE-2)<a name='1783'>
            Q10(I,J)=Q10(I,MYJE-2)<a name='1784'>
            U10(I,J)=U10(I,MYJE-2)<a name='1785'>
            V10(I,J)=V10(I,MYJE-2)<a name='1786'>
            TSHLTR(I,J)=TSHLTR(I,MYJE-2)<a name='1787'>
            QSHLTR(I,J)=QSHLTR(I,MYJE-2)<a name='1788'>
          ENDIF<a name='1789'>
        ENDDO<a name='1790'>
        ENDDO<a name='1791'>
      ENDIF<a name='1792'>
<font color=#447700>!<a name='1793'></font>
#if ( HWRF == 1 )<a name='1794'>
      if(size(grid%windsq_swath)&gt;1) then<a name='1795'>
         do j=max(jts,jds),min(jte,jde-1)<a name='1796'>
            do i=max(its,ids),min(ite,ide-1)<a name='1797'>
               if(grid%interesting(i,j)==0) cycle<a name='1798'>
               wind=u10(i,j)**2 + v10(i,j)**2<a name='1799'>
               if(wind&gt;grid%windsq_swath(i,j)) grid%windsq_swath(i,j)=wind<a name='1800'>
            enddo<a name='1801'>
         enddo<a name='1802'>
      endif<a name='1803'>
#endif<a name='1804'>
<a name='1805'>
      IF(CONFIG_FLAGS%SF_SFCLAY_PHYSICS==1)THEN <font color=#447700>! non-NMM package<a name='1806'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1807'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1808'></font>
        DO J=MYJS1,MYJE1<a name='1809'>
        DO I=MYIS,MYIE1<a name='1810'>
<font color=#447700>!         TSHLTR(I,J)=TSHLTR(I,J)*(1.E5/PSHLTR(I,J))**RCP<a name='1811'></font>
          IF(TSHLTR(I,J)&lt;200..OR.TSHLTR(I,J)&gt;350.)THEN<a name='1812'>
            WRITE(message,*)'Troublesome TSHLTR...I,J,TSHLTR,PSHLTR: '        &amp;<a name='1813'>
                      ,I,J,TSHLTR(I,J),PSHLTR(I,J)<a name='1814'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_109">(trim(message))<a name='1815'>
          ENDIF<a name='1816'>
	ENDDO<a name='1817'>
	ENDDO<a name='1818'>
      ENDIF<a name='1819'>
<font color=#447700>!<a name='1820'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1821'></font>
<font color=#447700>!***  COMPUTE MODEL LAYER CONTAINING THE TOP OF THE BOUNDARY LAYER<a name='1822'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1823'></font>
<font color=#447700>!<a name='1824'></font>
      IF(CONFIG_FLAGS%BL_PBL_PHYSICS/=MYJPBLSCHEME)THEN<a name='1825'>
        LENGTH_ROW=MYIE1-MYIS1+1<a name='1826'>
        DO J=MYJS2,MYJE2<a name='1827'>
        DO I=MYIS1,MYIE1<a name='1828'>
          KPBL(I,J)=-1000<a name='1829'>
        ENDDO<a name='1830'>
        ENDDO<a name='1831'>
<font color=#447700>!<a name='1832'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1833'></font>
<font color=#447700>!$omp&amp; private(altitude,i,j,k,kount_all)<a name='1834'></font>
        DO J=MYJS2,MYJE2<a name='1835'>
          KOUNT_ALL=0<a name='1836'>
          find_kpbl : DO K=KTS,KTE<a name='1837'>
          DO I=MYIS1,MYIE1<a name='1838'>
            ALTITUDE=Z(I,K+1,J)-SFCZ(I,J)<a name='1839'>
            IF(PBLH(I,J)&lt;=ALTITUDE.AND.KPBL(I,J)&lt;0)THEN<a name='1840'>
              KPBL(I,J)=K<a name='1841'>
              KOUNT_ALL=KOUNT_ALL+1<a name='1842'>
            ENDIF<a name='1843'>
            IF(KOUNT_ALL==LENGTH_ROW)EXIT find_kpbl<a name='1844'>
          ENDDO<a name='1845'>
          ENDDO find_kpbl<a name='1846'>
        ENDDO<a name='1847'>
      ENDIF<a name='1848'>
<font color=#447700>!<a name='1849'></font>
      IF(MODEL_CONFIG_REC%SF_SURFACE_PHYSICS(GRID%ID)==99)THEN<a name='1850'>
        SNO_FACTR=1.<a name='1851'>
      ELSE<a name='1852'>
        SNO_FACTR=1000.<a name='1853'>
      ENDIF<a name='1854'>
<font color=#447700>!<a name='1855'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1856'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='1857'></font>
      DO J=MYJS2,MYJE2<a name='1858'>
      DO I=MYIS1,MYIE1<a name='1859'>
        SNO(I,J)=SNOW(I,J)<a name='1860'>
        SI(I,J)=SNOWH(I,J)*SNO_FACTR<a name='1861'>
        LPBL(I,J)=KTE-KPBL(I,J)+1<a name='1862'>
      ENDDO<a name='1863'>
      ENDDO<a name='1864'>
<font color=#447700>!<a name='1865'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1866'></font>
<font color=#447700>!***  DIAGNOSTIC RADIATION ACCUMULATION<a name='1867'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1868'></font>
<font color=#447700>!<a name='1869'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='1870'></font>
<font color=#447700>!$omp&amp; private(i,j,tsfc2)<a name='1871'></font>
      DO J=MYJS2,MYJE2<a name='1872'>
      DO I=MYIS,MYIE<a name='1873'>
        ASWIN (I,J)=ASWIN (I,J)+RSWIN(I,J)*HBM2(I,J)*FACTRS(I,J)<a name='1874'>
        ASWOUT(I,J)=ASWOUT(I,J)-RSWOUT(I,J)*HBM2(I,J)*FACTRS(I,J)<a name='1875'>
        ASWTOA(I,J)=ASWTOA(I,J)+RSWTOA(I,J)*HBM2(I,J)*FACTRS(I,J)<a name='1876'>
        ALWIN (I,J)=ALWIN (I,J)+RLW_DN_SFC(I,J)<a name='1877'>
        ALWOUT(I,J)=ALWOUT(I,J)-RADOT (I,J)*HBM2(I,J)<a name='1878'>
        ALWTOA(I,J)=ALWTOA(I,J)+RLWTOA(I,J)*HBM2(I,J)<a name='1879'>
<font color=#447700>!<a name='1880'></font>
        TSFC2=TSFC(I,J)*TSFC(I,J)<a name='1881'>
        RADOT(I,J)=HBM2(I,J)*EPSR(I,J)*STBOLT*TSFC2*TSFC2<a name='1882'>
        THS(I,J)=TSFC(I,J)*EXNSFC(I,J)<a name='1883'>
        PREC(I,J)=0.<a name='1884'>
      ENDDO<a name='1885'>
      ENDDO<a name='1886'>
<font color=#447700>!<a name='1887'></font>
<font color=#447700>!=======================================================================<a name='1888'></font>
<font color=#447700>!===  Begin gravity wave drag (GWD) and mountain blocking (MB)  ========<a name='1889'></font>
<font color=#447700>!=======================================================================<a name='1890'></font>
<font color=#447700>!<a name='1891'></font>
      IGS=MYIS1<a name='1892'>
      IGE=MYIE1<a name='1893'>
      JGS=MYJS2<a name='1894'>
      JGE=MYJE2<a name='1895'>
<font color=#447700>!dbg !dbg<a name='1896'></font>
<font color=#447700>!dbg kpblmin=100<a name='1897'></font>
<font color=#447700>!dbg kpblmax=-100<a name='1898'></font>
<font color=#447700>!dbg DO J=JGS,JGE<a name='1899'></font>
<font color=#447700>!dbg   DO I=IGS,IGE<a name='1900'></font>
<font color=#447700>!dbg     kpblmin=min(kpblmin,kpbl(i,j))<a name='1901'></font>
<font color=#447700>!dbg     kpblmax=max(kpblmax,kpbl(i,j))<a name='1902'></font>
<font color=#447700>!dbg   enddo<a name='1903'></font>
<font color=#447700>!dbg enddo<a name='1904'></font>
<font color=#447700>!dbg print *,'TURBL: IGS,IGE,JGS,JGE,kpblmin,kpblmax=',IGS,IGE,JGS,JGE,kpblmin,kpblmax<a name='1905'></font>
<font color=#447700>!dbg<a name='1906'></font>
<a name='1907'>
<font color=#447700>!      print *,'grid%id  gwd_opt at module_PHYSICS ',grid%id, grid%gwd_opt<a name='1908'></font>
<font color=#447700>!      WRITE(0,*)'grid%id  gwd_opt at module_PHYSICS ',grid%id, grid%gwd_opt<a name='1909'></font>
<font color=#447700>!      WRITE(MESSAGE,125)grid%gwd_opt<a name='1910'></font>
<font color=#447700>!125   FORMAT(1X,'grid%id  module_PHYSICS.F :  gwd_opt  ',I2,2X,I2)<a name='1911'></font>
<a name='1912'>
<a name='1913'>
#if ( HWRF == 1 )<a name='1914'>
      IF (grid%gwd_opt .eq. 2 .AND. grid%id.eq.1) THEN                                        <font color=#447700>!Kwon's doing for parent only now<a name='1915'></font>
#else<a name='1916'>
      IF (grid%gwd_opt .eq. 2) THEN<a name='1917'>
#endif<a name='1918'>
<font color=#447700>!      print *,'==grid%id  gwd_opt at module_PHYSICS inside gwd ',grid%id, grid%gwd_opt        !because there is no data for nest domain<a name='1919'></font>
<a name='1920'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_110">("GWD usage currently may be problematic for some cases - use at own risk")<a name='1921'>
<a name='1922'>
      CALL <A href='../../html_code/dyn_nmm/module_GWD.F.html#GWD_DRIVER'>GWD_driver</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GWD_DRIVER_1">(U=U_PHY,V=V_PHY,T=T_PHY                           &amp;<a name='1923'>
     &amp;               ,Q=MOIST_TRANS(IMS,KMS,JMS,P_QV)                   &amp;<a name='1924'>
     &amp;               ,Z=Z,DP=DELP,PINT=P8W,PMID=P_PHY,EXNR=PI_PHY       &amp;<a name='1925'>
     &amp;               ,KPBL=KPBL,ITIME=NTSD                              &amp;<a name='1926'>
     &amp;               ,HSTDV=HSTDV,HCNVX=HCNVX,HASYW=HASYW,HASYS=HASYS   &amp;<a name='1927'>
     &amp;               ,HASYSW=HASYSW,HASYNW=HASYNW,HLENW=HLENW           &amp;<a name='1928'>
     &amp;               ,HLENS=HLENS,HLENSW=HLENSW,HLENNW=HLENNW           &amp;<a name='1929'>
     &amp;               ,HANGL=HANGL,HANIS=HANIS,HSLOP=HSLOP,HZMAX=HZMAX   &amp;<a name='1930'>
     &amp;               ,CROT=CROT,SROT=SROT                               &amp;<a name='1931'>
     &amp;               ,DUDT=DUDT_GWD,DVDT=DVDT_GWD                       &amp;<a name='1932'>
     &amp;               ,UGWDsfc=UGWDsfc,VGWDsfc=VGWDsfc,XLAND=XLAND       &amp;    <font color=#447700>!ADDED BY KWON FOR OCEAN<a name='1933'></font>
     &amp;               ,IDS=IDS,IDE=IDE,JDS=JDS,JDE=JDE,KDS=KDS,KDE=KDE   &amp;<a name='1934'>
     &amp;               ,IMS=IMS,IME=IME,JMS=JMS,JME=JME,KMS=KMS,KME=KME   &amp;<a name='1935'>
     &amp;               ,ITS=IGS,ITE=IGE,JTS=JGS,JTE=JGE,KTS=KTS,KTE=KTE )<a name='1936'>
<a name='1937'>
<font color=#447700>!=======================================================================<a name='1938'></font>
<font color=#447700>!=====  End gravity wave drag (GWD) and mountain blocking (MB)  ========<a name='1939'></font>
<font color=#447700>!=======================================================================<a name='1940'></font>
<font color=#447700>!<a name='1941'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1942'></font>
<font color=#447700>!***  TRANSFER THE WIND TENDENCIES.<a name='1943'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1944'></font>
<font color=#447700>!<a name='1945'></font>
      DO K=KTS,KTE<a name='1946'>
      DO J=JTS,JTE<a name='1947'>
      DO I=ITS,ITE<a name='1948'>
<a name='1949'>
<a name='1950'>
<font color=#447700>!mp     temporary bandaid limiting GWD/MB wind tendencies<a name='1951'></font>
<a name='1952'>
        IF (DUDT_GWD(I,K,J) .gt. 1.6) then<a name='1953'>
        write(message,*) 'BIG DUDT_GWD:: ', I,K,J, DUDT_GWD(I,K,J)<a name='1954'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_111">(message)<a name='1955'>
        DUDT_GWD(I,K,J)=1.6<a name='1956'>
        ENDIF<a name='1957'>
<a name='1958'>
        IF (DUDT_GWD(I,K,J) .lt. -1.6) then<a name='1959'>
        write(message,*) 'BIG DUDT_GWD:: ', I,K,J, DUDT_GWD(I,K,J)<a name='1960'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_112">(message)<a name='1961'>
        DUDT_GWD(I,K,J)=-1.6<a name='1962'>
        ENDIF<a name='1963'>
<a name='1964'>
        IF (DVDT_GWD(I,K,J) .gt. 1.6) then<a name='1965'>
        write(message,*) 'BIG DVDT_GWD:: ', I,K,J, DVDT_GWD(I,K,J)<a name='1966'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_113">(message)<a name='1967'>
        DVDT_GWD(I,K,J)=1.6<a name='1968'>
        ENDIF<a name='1969'>
<a name='1970'>
        IF (DVDT_GWD(I,K,J) .lt. -1.6) then<a name='1971'>
        write(message,*) 'BIG DVDT_GWD:: ', I,K,J, DVDT_GWD(I,K,J)<a name='1972'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_114">(message)<a name='1973'>
        DVDT_GWD(I,K,J)=-1.6<a name='1974'>
        ENDIF<a name='1975'>
<a name='1976'>
<font color=#447700>!mp     end temporary bandaid<a name='1977'></font>
<a name='1978'>
        DUDT(I,J,K)=DUDT_PHY(I,K,J)+DUDT_GWD(I,K,J)<a name='1979'>
        DVDT(I,J,K)=DVDT_PHY(I,K,J)+DVDT_GWD(I,K,J)<a name='1980'>
<a name='1981'>
      ENDDO<a name='1982'>
      ENDDO<a name='1983'>
      ENDDO<a name='1984'>
<a name='1985'>
      ELSE  <font color=#447700>! no GWD<a name='1986'></font>
<a name='1987'>
      DO K=KTS,KTE<a name='1988'>
      DO J=JTS,JTE<a name='1989'>
      DO I=ITS,ITE<a name='1990'>
        DUDT(I,J,K)=DUDT_PHY(I,K,J)<a name='1991'>
        DVDT(I,J,K)=DVDT_PHY(I,K,J)<a name='1992'>
      ENDDO<a name='1993'>
      ENDDO<a name='1994'>
      ENDDO<a name='1995'>
<a name='1996'>
      ENDIF <font color=#447700>! gwd_opt<a name='1997'></font>
<font color=#447700>!<a name='1998'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1999'></font>
<font color=#447700>!***  TRANSPOSE THE MOIST_TRANS ARRAY BACK TO THE PROGNOSTIC MOIST ARRAY.<a name='2000'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2001'></font>
<font color=#447700>!<a name='2002'></font>
      DO N=1,N_MOIST<a name='2003'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2004'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2005'></font>
        DO J=JMS,JME<a name='2006'>
        DO K=KMS,KME<a name='2007'>
        DO I=IMS,IME<a name='2008'>
          MOIST(I,J,K,N)=MOIST_TRANS(I,K,J,N)<a name='2009'>
        ENDDO<a name='2010'>
        ENDDO<a name='2011'>
        ENDDO<a name='2012'>
      ENDDO<a name='2013'>
<font color=#447700>!<a name='2014'></font>
      DEALLOCATE(MOIST_TRANS,STAT=ISTAT)<a name='2015'>
<font color=#447700>!<a name='2016'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2017'></font>
<font color=#447700>!***  UPDATE TEMPERATURE, SPECIFIC HUMIDITY, CLOUD, AND TKE.<a name='2018'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2019'></font>
<font color=#447700>!<a name='2020'></font>
      E_BDY=(ITE&gt;=IDE)<a name='2021'>
<font color=#447700>!<a name='2022'></font>
      ETAMP_PHYSICS=ETAMP_Regional<a name='2023'>
      IF (CONFIG_FLAGS%MP_PHYSICS==ETAMP_HWRF) ETAMP_PHYSICS=.TRUE.<a name='2024'>
<font color=#447700>!<a name='2025'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2026'></font>
<font color=#447700>!$omp&amp; private(dqdt,dtdt,i,iend,j,k,qi,qold,qr,qw,ratiomx,i_m)<a name='2027'></font>
      DO K=KTS,KTE<a name='2028'>
      DO J=MYJS2,MYJE2<a name='2029'>
        IEND=MYIE1<a name='2030'>
        IF(E_BDY.AND.MOD(J,2)==0)IEND=IEND-1<a name='2031'>
<font color=#447700>!<a name='2032'></font>
        DO I=MYIS1,IEND<a name='2033'>
          DTDT=RTHBLTEN(I,K,J)*PI_PHY(I,K,J)<a name='2034'>
          DQDT=RQVBLTEN(I,K,J)         <font color=#447700>!Mixing ratio tendency<a name='2035'></font>
          T(I,J,K)=T(I,J,K)+DTDT*DTPHS<a name='2036'>
          QOLD=Q(I,J,K)<a name='2037'>
          RATIOMX=QOLD/(1.-QOLD)+DQDT*DTPHS<a name='2038'>
          Q(I,J,K)=RATIOMX/(1.+RATIOMX)<a name='2039'>
<font color=#447700>!         Q(I,J,K)=MAX(Q(I,J,K),EPSQ)<a name='2040'></font>
          MOIST(I,J,K,P_QV)=MAX(EPSQ,(MOIST(I,J,K,P_QV)+RQVBLTEN(I,K,J)*DTPHS) )<a name='2041'>
          CWM(I,J,K)=0.<a name='2042'>
<font color=#447700>!<a name='2043'></font>
          pbl_check1:  IF(config_flags%mp_physics==fer_mp_hires_advect) then<a name='2044'>
             <font color=#447700>! Update QI and QRIMEF:<a name='2045'></font>
             call <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#QITEND_FER_HIRES_ADVECT'>QITEND_FER_HIRES_ADVECT</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QITEND_FER_HIRES_ADVECT_1">( &amp;<a name='2046'>
                  MOIST(I,J,K,P_QI), &amp;<a name='2047'>
                  SCALAR(I,J,K,P_QRIMEF), &amp;<a name='2048'>
                  RQIBLTEN(I,K,J)*DTPHS)<a name='2049'>
<a name='2050'>
             <font color=#447700>! Update QC:<a name='2051'></font>
             MOIST(I,J,K,P_QC)=MAX(EPSQ,(MOIST(I,J,K,P_QC)+RQCBLTEN(I,K,J)*DTPHS))<a name='2052'>
          ELSEIF (.NOT.ETAMP_PHYSICS) THEN<a name='2053'>
<a name='2054'>
            DO I_M=1,N_MOIST<a name='2055'>
              IF(I_M==P_QC) THEN<a name='2056'>
                MOIST(I,J,K,I_M)=MAX(EPSQ,(MOIST(I,J,K,I_M)+RQCBLTEN(I,K,J)*DTPHS) )<a name='2057'>
              ELSE IF(I_M==P_QI) THEN<a name='2058'>
                MOIST(I,J,K,I_M)=MAX(EPSQ,(MOIST(I,J,K,I_M)+RQIBLTEN(I,K,J)*DTPHS) )<a name='2059'>
              ENDIF<a name='2060'>
              IF(I_M/=P_QV) CWM(I,J,K)=CWM(I,J,K)+MOIST(I,J,K,I_M)<a name='2061'>
            ENDDO<a name='2062'>
          ELSE pbl_check1<a name='2063'>
<font color=#447700>!<a name='2064'></font>
<font color=#447700>!-- Allow vertical mixing to modify cloud ice + snow for ETAMPNEW<a name='2065'></font>
<font color=#447700>!<a name='2066'></font>
            QW=MAX(0.,MOIST(I,J,K,P_QC)+RQCBLTEN(I,K,J)*DTPHS )<a name='2067'>
            pbl_check2:  IF (ETAMP_Regional) THEN<a name='2068'>
              QI=MAX(0.,MOIST(I,J,K,P_QS)+RQIBLTEN(I,K,J)*DTPHS )  <font color=#447700>!-- Total ice<a name='2069'></font>
<font color=#447700>!BSF              QR=MAX(0.,MOIST(I,J,K,P_QR)+RQRBLTEN(I,K,J)*DTPHS )<a name='2070'></font>
              QR=MAX(0.,MOIST(I,J,K,P_QR) )<a name='2071'>
              MOIST(I,J,K,P_QC)=QW<a name='2072'>
              MOIST(I,J,K,P_QS)=QI<a name='2073'>
              MOIST(I,J,K,P_QR)=QR<a name='2074'>
            ELSE IF (CONFIG_FLAGS%MP_PHYSICS==ETAMP_HWRF) THEN    <font color=#447700>!-- pbl_check2<a name='2075'></font>
              QI=MAX(0.,MOIST(I,J,K,P_QI)+RQIBLTEN(I,K,J)*DTPHS )  <font color=#447700>!-- Total ice<a name='2076'></font>
<font color=#447700>!BSF              QR=MAX(0.,MOIST(I,J,K,P_QR)+RQRBLTEN(I,K,J)*DTPHS )<a name='2077'></font>
              QR=MAX(0.,MOIST(I,J,K,P_QR) )<a name='2078'>
              MOIST(I,J,K,P_QC)=QW<a name='2079'>
              MOIST(I,J,K,P_QI)=QI<a name='2080'>
              MOIST(I,J,K,P_QR)=QR<a name='2081'>
            ENDIF pbl_check2<a name='2082'>
            CWM(I,J,K)=QW+QI+QR<a name='2083'>
<font color=#447700>!<a name='2084'></font>
            IF(QI&lt;=EPSQ)THEN<a name='2085'>
              F_ICE(I,K,J)=0.<a name='2086'>
            ELSE<a name='2087'>
              F_ICE(I,K,J)=MAX(0.,MIN(1.,QI/CWM(I,J,K)))<a name='2088'>
            ENDIF<a name='2089'>
<font color=#447700>!<a name='2090'></font>
            IF(QR&lt;=EPSQ)THEN<a name='2091'>
              F_RAIN(I,K,J)=0.<a name='2092'>
            ELSE<a name='2093'>
              F_RAIN(I,K,J)=QR/(QW+QR)<a name='2094'>
            ENDIF<a name='2095'>
<font color=#447700>!<a name='2096'></font>
          ENDIF pbl_check1<a name='2097'>
<font color=#447700>!<a name='2098'></font>
          Q2(I,J,K)=2.*TKE(I,K,J)<a name='2099'>
        ENDDO<a name='2100'>
        ENDDO<a name='2101'>
<font color=#447700>!<a name='2102'></font>
      ENDDO<a name='2103'>
<font color=#447700>!<a name='2104'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2105'></font>
<font color=#447700>!***<a name='2106'></font>
<font color=#447700>!***  SAVE SURFACE-RELATED FIELDS.<a name='2107'></font>
<font color=#447700>!***<a name='2108'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2109'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2110'></font>
<font color=#447700>!$omp&amp; private(i,j,llij,xlvrw)<a name='2111'></font>
      DO J=MYJS2,MYJE2<a name='2112'>
      DO I=MYIS1,MYIE1<a name='2113'>
        LLIJ=LOWLYR(I,J)<a name='2114'>
<font color=#447700>!<a name='2115'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2116'></font>
<font color=#447700>!***  INSTANTANEOUS SENSIBLE AND LATENT HEAT FLUX<a name='2117'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2118'></font>
<font color=#447700>!<a name='2119'></font>
        TWBS(I,J)=-TWBS(I,J)<a name='2120'>
        QWBS(I,J)=-QWBS(I,J)*XLV*CHKLOWQ(I,J)<a name='2121'>
<font color=#447700>!<a name='2122'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2123'></font>
<font color=#447700>!***  ACCUMULATED QUANTITIES.<a name='2124'></font>
<font color=#447700>!***  IN OPNL LSM, SFCEVP APPEARS TO BE IN UNITS OF<a name='2125'></font>
<font color=#447700>!***  METERS OF LIQUID WATER.  IT IS COMING FROM<a name='2126'></font>
<font color=#447700>!***  WRF MODULE AS KG/M**2.<a name='2127'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2128'></font>
<font color=#447700>!<a name='2129'></font>
        SFCSHX(I,J)=SFCSHX(I,J)+TWBS(I,J)<a name='2130'>
        SFCLHX(I,J)=SFCLHX(I,J)+QWBS(I,J)<a name='2131'>
        XLVRW=DTPHS/(XLV*RHOWATER)<a name='2132'>
        SFCEVP(I,J)=SFCEVP(I,J)-QWBS(I,J)*XLVRW<a name='2133'>
        POTEVP(I,J)=POTEVP(I,J)-QWBS(I,J)*SM(I,J)*XLVRW<a name='2134'>
        POTFLX(I,J)=POTEVP(I,J)*FACTOR<a name='2135'>
        SUBSHX(I,J)=SUBSHX(I,J)+GRNFLX(I,J)<a name='2136'>
      ENDDO<a name='2137'>
      ENDDO<a name='2138'>
<font color=#447700>!<a name='2139'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2140'></font>
<font color=#447700>!***  COUNTERS<a name='2141'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2142'></font>
<font color=#447700>!<a name='2143'></font>
      APHTIM=APHTIM+1.<a name='2144'>
      ARDSW =ARDSW +1.<a name='2145'>
      ARDLW =ARDLW +1.<a name='2146'>
      ASRFC =ASRFC +1.<a name='2147'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2148'></font>
<font color=#447700>!<a name='2149'></font>
      END SUBROUTINE TURBL<a name='2150'>
<font color=#447700>!<a name='2151'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2152'></font>
<font color=#447700>!***********************************************************************<a name='2153'></font>
<A NAME='UV_H_TO_V'><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#UV_H_TO_V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2154'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>UV_H_TO_V</font>(NTSD,DT,NPHS,UZ0H,VZ0H,UZ0,VZ0               &amp; <A href='../../call_to/UV_H_TO_V.html' TARGET='index'>2</A><a name='2155'>
     &amp;                    ,DUDT,DVDT,U,V,HBM2,IVE,IVW                   &amp;<a name='2156'>
     &amp;                    ,IDS,IDE,JDS,JDE,KDS,KDE                      &amp;<a name='2157'>
     &amp;                    ,IMS,IME,JMS,JME,KMS,KME                      &amp;<a name='2158'>
     &amp;                    ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2159'>
<font color=#447700>!***********************************************************************<a name='2160'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='2161'></font>
<font color=#447700>!                .      .    .<a name='2162'></font>
<font color=#447700>! SUBPROGRAM:    UV_H_TO_V   INTERPOLATE WINDS FROM H TO V POINTS<a name='2163'></font>
<font color=#447700>!   PRGRMMR: BLACK           ORG: W/NP22     DATE: 05-02-22<a name='2164'></font>
<font color=#447700>!<a name='2165'></font>
<font color=#447700>! ABSTRACT:<a name='2166'></font>
<font color=#447700>!     INTERPOLATE WINDS BACK TO V POINTS AFTER TURBULENCE<a name='2167'></font>
<font color=#447700>!<a name='2168'></font>
<font color=#447700>! PROGRAM HISTORY LOG :<a name='2169'></font>
<font color=#447700>!   05-02-22  BLACK      - ORIGINATOR<a name='2170'></font>
<font color=#447700>!   05-12-12  BLACK      - CONVERTED FROM IKJ TO IJK<a name='2171'></font>
<font color=#447700>!<a name='2172'></font>
<font color=#447700>! USAGE: CALL TURBL FROM SOLVE_NMM<a name='2173'></font>
<font color=#447700>!<a name='2174'></font>
<font color=#447700>! ATTRIBUTES:<a name='2175'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='2176'></font>
<font color=#447700>!   MACHINE : IBM<a name='2177'></font>
<font color=#447700>!$$$<a name='2178'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2179'></font>
<font color=#447700>!<a name='2180'></font>
      IMPLICIT NONE<a name='2181'>
<font color=#447700>!<a name='2182'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2183'></font>
<font color=#447700>!<a name='2184'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='2185'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='2186'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='2187'>
     &amp;                     ,NPHS,NTSD<a name='2188'>
<font color=#447700>!<a name='2189'></font>
      INTEGER, DIMENSION(JMS:JME),INTENT(IN) :: IVE,IVW<a name='2190'>
<font color=#447700>!<a name='2191'></font>
      REAL,INTENT(IN) :: DT<a name='2192'>
<font color=#447700>!<a name='2193'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: HBM2,UZ0H,VZ0H<a name='2194'>
<font color=#447700>!<a name='2195'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: DUDT,DVDT<a name='2196'>
<font color=#447700>!<a name='2197'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: UZ0,VZ0<a name='2198'>
<font color=#447700>!<a name='2199'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: U,V<a name='2200'>
<font color=#447700>!<a name='2201'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2202'></font>
<font color=#447700>!***<a name='2203'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='2204'></font>
<font color=#447700>!***<a name='2205'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2206'></font>
<font color=#447700>!<a name='2207'></font>
      INTEGER :: I,IEND,J,K<a name='2208'>
<font color=#447700>!<a name='2209'></font>
      REAL :: DTPHS<a name='2210'>
<font color=#447700>!<a name='2211'></font>
      LOGICAL :: E_BDY<a name='2212'>
<font color=#447700>!<a name='2213'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2214'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2215'></font>
<font color=#447700>!<a name='2216'></font>
      DTPHS=NPHS*DT<a name='2217'>
      E_BDY=(ITE&gt;=IDE)<a name='2218'>
<font color=#447700>!<a name='2219'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2220'></font>
<font color=#447700>!***  RECONSTRUCT UZ0 AND VZ0 ON VELOCITY POINTS.<a name='2221'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2222'></font>
<font color=#447700>!<a name='2223'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2224'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='2225'></font>
      DO J=MYJS2,MYJE2<a name='2226'>
      DO I=MYIS,MYIE<a name='2227'>
        UZ0(I,J)=(UZ0H(I+IVE(J),J)*HBM2(I+IVE(J),J)                     &amp;<a name='2228'>
     &amp;           +UZ0H(I+IVW(J),J)*HBM2(I+IVW(J),J)                     &amp;<a name='2229'>
     &amp;           +UZ0H(I,J+1)*HBM2(I,J+1)+UZ0H(I,J-1)*HBM2(I,J-1))*0.25<a name='2230'>
        VZ0(I,J)=(VZ0H(I+IVE(J),J)*HBM2(I+IVE(J),J)                     &amp;<a name='2231'>
     &amp;           +VZ0H(I+IVW(J),J)*HBM2(I+IVW(J),J)                     &amp;<a name='2232'>
     &amp;           +VZ0H(I,J+1)*HBM2(I,J+1)+VZ0H(I,J-1)*HBM2(I,J-1))*0.25<a name='2233'>
      ENDDO<a name='2234'>
      ENDDO<a name='2235'>
<font color=#447700>!<a name='2236'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2237'></font>
<font color=#447700>!***  INTERPOLATE WIND TENDENCIES TO VELOCITY POINTS AND UPDATE WINDS.<a name='2238'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2239'></font>
<font color=#447700>!<a name='2240'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2241'></font>
<font color=#447700>!$omp&amp; private(i,iend,j,k)<a name='2242'></font>
      DO K=KTS,KTE<a name='2243'>
        DO J=MYJS2,MYJE2<a name='2244'>
          IEND=MYIE1<a name='2245'>
          IF(E_BDY.AND.MOD(J,2)==1)IEND=IEND-1<a name='2246'>
<font color=#447700>!<a name='2247'></font>
          DO I=MYIS1,IEND<a name='2248'>
            U(I,J,K)=(DUDT(I+IVE(J),J,K)+DUDT(I+IVW(J),J,K)             &amp;<a name='2249'>
     &amp;               +DUDT(I,J+1,K)+DUDT(I,J-1,K))*0.25*DTPHS           &amp;<a name='2250'>
     &amp;               +U(I,J,K)<a name='2251'>
            V(I,J,K)=(DVDT(I+IVE(J),J,K)+DVDT(I+IVW(J),J,K)             &amp;<a name='2252'>
     &amp;               +DVDT(I,J+1,K)+DVDT(I,J-1,K))*0.25*DTPHS           &amp;<a name='2253'>
     &amp;               +V(I,J,K)<a name='2254'>
          ENDDO<a name='2255'>
        ENDDO<a name='2256'>
      ENDDO<a name='2257'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2258'></font>
<font color=#447700>!<a name='2259'></font>
      END SUBROUTINE UV_H_TO_V<a name='2260'>
<font color=#447700>!<a name='2261'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2262'></font>
<font color=#447700>!***********************************************************************<a name='2263'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2264'></font>
<A NAME='CUCNVC'><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#CUCNVC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2265'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CUCNVC</font>(NTSD,DT,NCNVC,NRADS,NRADL                       &amp; <A href='../../call_to/CUCNVC.html' TARGET='index'>1</A>,<A href='../../call_from/CUCNVC.html' TARGET='index'>4</A><a name='2266'>
     &amp;                 ,GPS,RESTRT,HYDRO                                &amp;<a name='2267'>
     &amp;                 ,CLDEFI,N_MOIST,N_SCALAR,ENSDIM                  &amp;<a name='2268'>
     &amp;                 ,MOIST,SCALAR                                    &amp;<a name='2269'>
     &amp;                 ,DETA1,DETA2,AETA1,AETA2,ETA1,ETA2               &amp;<a name='2270'>
     &amp;                 ,F_ICE,F_RAIN                                    &amp;<a name='2271'>
<font color=#447700>!***  Changes for other cu-schemes, most for gd scheme<a name='2272'></font>
     &amp;                 ,APR_GR,APR_W,APR_MC,TTEN,QTEN                   &amp;<a name='2273'>
     &amp;                 ,APR_ST,APR_AS,APR_CAPMA                         &amp;<a name='2274'>
     &amp;                 ,APR_CAPME          ,APR_CAPMI                   &amp;<a name='2275'>
     &amp;                 ,MASS_FLUX         ,XF_ENS                       &amp;<a name='2276'>
     &amp;                 ,PR_ENS,GSW                                      &amp;<a name='2277'>
     &amp;                 ,GD_CLOUD,GD_CLOUD2,KTOP_DEEP                    &amp;<a name='2278'>
     &amp;                 ,PDTOP,PT,PD,RES,PINT,T,Q,CWM,TCUCN              &amp;<a name='2279'>
     &amp;                 ,OMGALF,U,V,W,Z,FIS,W0AVG                        &amp;<a name='2280'>
     &amp;                 ,PREC,ACPREC,CUPREC,CUPPT,CPRATE                 &amp;<a name='2281'>
     &amp;                 ,SM,HBM2,PBLH,LPBL,CNVBOT,CNVTOP                 &amp;<a name='2282'>
     &amp;                 ,HTOP,HBOT,HTOPD,HBOTD,HTOPS,HBOTS               &amp;<a name='2283'>
     &amp;                 ,RTHBLTEN,RQVBLTEN,RTHRATEN                      &amp;<a name='2284'>
#if (NMM_CORE==1)    <a name='2285'>
     &amp;                 ,TWBS,QWBS                                       &amp;<a name='2286'>
     &amp;                 ,DUCUDT, DVCUDT, MOMMIX, store_rand              &amp;                  <a name='2287'>
     &amp;                 ,DTHCUDT,DQVCUDT,DQRCUDT,DQCCUDT,DQICUDT         &amp;<font color=#447700>! added output CU tendency<a name='2288'></font>
     &amp;                 ,DQSCUDT                                         &amp;<font color=#447700>! added output CU tendency<a name='2289'></font>
<a name='2290'>
#endif<a name='2291'>
     &amp;                 ,HPBL2D,EVAP2D,HEAT2D                            &amp;     <font color=#447700>!Kwon S&amp;P<a name='2292'></font>
     &amp;                 ,DX2D,DYNMM                                      &amp; <font color=#447700>! Scale-aware sas<a name='2293'></font>
     &amp;                 ,SCALEFUN, SCALEFUN1                             &amp; <font color=#447700>!scale functions<a name='2294'></font>
     &amp;                 ,SIGMU, SIGMU1                                   &amp; <font color=#447700>!updraft fraction<a name='2295'></font>
     &amp;                 ,AVCNVC,ACUTIM,IHE,IHW                           &amp;<a name='2296'>
     &amp;                 ,GRID,CONFIG_FLAGS                               &amp;<a name='2297'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                         &amp;<a name='2298'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                         &amp;<a name='2299'>
     &amp;                 ,IPS,IPE,JPS,JPE,KPS,KPE                         &amp;<a name='2300'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2301'>
<font color=#447700>!***********************************************************************<a name='2302'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='2303'></font>
<font color=#447700>!                .      .    .<a name='2304'></font>
<font color=#447700>! SUBPROGRAM:    CUCNVC      CONVECTIVE PRECIPITATION OUTER DRIVER<a name='2305'></font>
<font color=#447700>!   PRGRMMR: BLACK           ORG: W/NP22     DATE: 02-03-21<a name='2306'></font>
<font color=#447700>!<a name='2307'></font>
<font color=#447700>! ABSTRACT:<a name='2308'></font>
<font color=#447700>!     CUCVNC DRIVES THE WRF CONVECTION SCHEMES<a name='2309'></font>
<font color=#447700>!<a name='2310'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='2311'></font>
<font color=#447700>!   02-03-21  BLACK      - ORIGINATOR<a name='2312'></font>
<font color=#447700>!   04-11-18  BLACK      - THREADED<a name='2313'></font>
<font color=#447700>!   05-12-15  BLACK      - CONVERTED FROM IKJ TO IJK<a name='2314'></font>
<font color=#447700>!<a name='2315'></font>
<font color=#447700>! USAGE: CALL CUCNVC FROM SOLVE_NMM<a name='2316'></font>
<font color=#447700>!<a name='2317'></font>
<font color=#447700>! ATTRIBUTES:<a name='2318'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='2319'></font>
<font color=#447700>!   MACHINE : IBM<a name='2320'></font>
<font color=#447700>!$$$<a name='2321'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2322'></font>
<font color=#447700>!<a name='2323'></font>
      IMPLICIT NONE<a name='2324'>
<font color=#447700>!<a name='2325'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2326'></font>
<font color=#447700>!<a name='2327'></font>
      INTEGER,INTENT(IN) :: ENSDIM                                      &amp;<a name='2328'>
     &amp;                     ,IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='2329'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='2330'>
     &amp;                     ,IPS,IPE,JPS,JPE,KPS,KPE                     &amp;<a name='2331'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='2332'>
     &amp;                     ,N_MOIST,NCNVC,NTSD,NRADS,NRADL,N_SCALAR<a name='2333'>
<font color=#447700>!<a name='2334'></font>
      INTEGER, DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW<a name='2335'>
<font color=#447700>!<a name='2336'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: LPBL<a name='2337'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: DX2D <font color=#447700>! scale-sware sas<a name='2338'></font>
      REAL,INTENT(IN) :: DYNMM                           <font color=#447700>! Delt_Y <a name='2339'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: SCALEFUN,SCALEFUN1 <font color=#447700>!  scale-sware sas<a name='2340'></font>
                                                                     <font color=#447700>! scale functions<a name='2341'></font>
       REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: SIGMU,SIGMU1 <font color=#447700>! updraft fractional area<a name='2342'></font>
<a name='2343'>
<font color=#447700>!<a name='2344'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: HPBL2D,EVAP2D,HEAT2D     <font color=#447700>!Kwon S&amp;P<a name='2345'></font>
<a name='2346'>
      REAL,DIMENSION(IMS:IME,JMS:JME)               :: SHALL<a name='2347'>
<font color=#447700>! <a name='2348'></font>
      REAL,INTENT(IN) :: DT,GPS,PDTOP,PT<a name='2349'>
<font color=#447700>!<a name='2350'></font>
      REAL,INTENT(INOUT) :: ACUTIM,AVCNVC<a name='2351'>
<font color=#447700>!<a name='2352'></font>
      REAL,DIMENSION(KMS:KME-1),INTENT(IN) :: AETA1,AETA2,DETA1,DETA2<a name='2353'>
      REAL,DIMENSION(KMS:KME  ),INTENT(IN) :: ETA1,ETA2<a name='2354'>
<font color=#447700>!<a name='2355'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: FIS,HBM2,PD,RES,SM<a name='2356'>
<font color=#447700>!<a name='2357'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: ACPREC,CLDEFI    &amp;<a name='2358'>
     &amp;                                                ,CNVBOT,CNVTOP    &amp;<a name='2359'>
     &amp;                                                ,CUPPT,CUPREC     &amp;<a name='2360'>
     &amp;                                                ,HBOT,HTOP        &amp;<a name='2361'>
     &amp;                                                ,HBOTD,HTOPD      &amp;<a name='2362'>
     &amp;                                                ,HBOTS,HTOPS      &amp;<a name='2363'>
     &amp;                                                ,PREC,CPRATE      &amp;<a name='2364'>
     &amp;                 ,APR_GR,APR_W,APR_MC                             &amp;<a name='2365'>
     &amp;                 ,APR_ST,APR_AS,APR_CAPMA                         &amp;<a name='2366'>
     &amp;                 ,APR_CAPME,APR_CAPMI                             &amp;<a name='2367'>
     &amp;                 ,GSW,MASS_FLUX<a name='2368'>
#if (NMM_CORE==1)<a name='2369'>
     REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: store_rand <a name='2370'>
#endif<a name='2371'>
<font color=#447700>!Biswas<a name='2372'></font>
       REAL,DIMENSION(IMS:IME,JMS:JME) :: HFX,QFX,PBLH<a name='2373'>
       REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: TWBS,QWBS<a name='2374'>
       REAL,DIMENSION(KMS:KME) :: ZNU<a name='2375'>
       REAL, DIMENSION(IMS:IME, KMS:KME, JMS:JME) ::                    &amp;<a name='2376'>
                                        RUCUTEN,                        &amp;<a name='2377'>
                                        RVCUTEN,RQVFTEN<a name='2378'>
<a name='2379'>
<a name='2380'>
<a name='2381'>
<font color=#447700>!<a name='2382'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: F_ICE       &amp;<a name='2383'>
     &amp;                                                     ,F_RAIN<a name='2384'>
<font color=#447700>!<a name='2385'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: QTEN     &amp;<a name='2386'>
     &amp;                                                        ,RQVBLTEN &amp;<a name='2387'>
     &amp;                                                        ,RTHBLTEN &amp;<a name='2388'>
     &amp;                                                        ,RTHRATEN &amp;<a name='2389'>
     &amp;                                                        ,TTEN<a name='2390'>
<font color=#447700>!<a name='2391'></font>
#if (NMM_CORE==1)<a name='2392'>
      REAL, INTENT(INOUT)::MOMMIX<a name='2393'>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT):: DUCUDT, DVCUDT <a name='2394'>
<font color=#447700>! 2015-12-14 added output tendency from CU<a name='2395'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT):: DTHCUDT   &amp;<a name='2396'>
     &amp;                                                      , DQVCUDT   &amp;<a name='2397'>
     &amp;                                                      , DQRCUDT   &amp;<a name='2398'>
     &amp;                                                      , DQCCUDT   &amp;<a name='2399'>
     &amp;                                                      , DQICUDT   &amp;<a name='2400'>
     &amp;                                                      , DQSCUDT<a name='2401'>
<font color=#447700>!<a name='2402'></font>
      REAL,DIMENSION(IDS:IDE,JDS:JDE)               :: DATA1 <a name='2403'>
      LOGICAL, EXTERNAL::wrf_dm_on_monitor<a name='2404'>
#endif<a name='2405'>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: CWM      &amp;<a name='2406'>
     &amp;                                                        ,OMGALF   &amp;<a name='2407'>
     &amp;                                                        ,Q,T      &amp;<a name='2408'>
     &amp;                                                        ,TCUCN    &amp;<a name='2409'>
     &amp;                                                        ,U,V      &amp;<a name='2410'>
     &amp;                                                        ,W,Z<a name='2411'>
<font color=#447700>!<a name='2412'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PINT<a name='2413'>
<font color=#447700>!<a name='2414'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: W0AVG<a name='2415'>
<font color=#447700>!<a name='2416'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,1:ENSDIM),INTENT(INOUT) :: PR_ENS  &amp;<a name='2417'>
     &amp;                                                         ,XF_ENS<a name='2418'>
<font color=#447700>!<a name='2419'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,N_MOIST)                   &amp;<a name='2420'>
     &amp;                                           ,INTENT(INOUT) :: MOIST<a name='2421'>
<font color=#447700>!<a name='2422'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,N_SCALAR)                  &amp;<a name='2423'>
     &amp;                                           ,INTENT(INOUT) :: SCALAR<a name='2424'>
<font color=#447700>!<a name='2425'></font>
<a name='2426'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: GD_CLOUD &amp;<a name='2427'>
     &amp;                                                        ,GD_CLOUD2<a name='2428'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: KTOP_DEEP<a name='2429'>
<font color=#447700>!<a name='2430'></font>
      LOGICAL,INTENT(IN) :: HYDRO,RESTRT<a name='2431'>
      LOGICAL :: IS_CAMMGMP_USED=.FALSE.<a name='2432'>
<font color=#447700>!<a name='2433'></font>
      TYPE(DOMAIN),TARGET :: GRID<a name='2434'>
<font color=#447700>!<a name='2435'></font>
      TYPE(GRID_CONFIG_REC_TYPE),INTENT(IN) :: CONFIG_FLAGS<a name='2436'>
<font color=#447700>!<a name='2437'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2438'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='2439'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2440'></font>
<font color=#447700>!<a name='2441'></font>
      INTEGER :: I,ICLDCK,IENDX,ISTAT,J,K,MNTO,N,N_TIMSTPS_OUTPUT       &amp;<a name='2442'>
     &amp;          ,NCUBOT,NCUTOP,NSTEP_CNV<a name='2443'>
<font color=#447700>!<a name='2444'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME) :: KPBL,LBOT,LOWLYR,LTOP<a name='2445'>
<font color=#447700>!<a name='2446'></font>
      REAL :: CAPA,CF_HI,DPL,DQDT,DTCNVC,DTDT,FICE,FRAIN,G_INV          &amp;<a name='2447'>
     &amp;       ,PCPCOL,PLYR,QI,QL_K,QR,QW,RDTCNVC,TL_K,WC,WMID,PLYRB<a name='2448'>
<a name='2449'>
<font color=#447700>!<a name='2450'></font>
      REAL,DIMENSION(KMS:KME-1) :: QL,TL<a name='2451'>
<font color=#447700>!<a name='2452'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME) :: CUBOT,CUTOP,NCA,PDSL           &amp;<a name='2453'>
     &amp;                                  ,RAINC,SFCZ,XLAND<a name='2454'>
      REAL,DIMENSION(IMS:IME,JMS:JME) :: RAINCV<a name='2455'>
<font color=#447700>!<a name='2456'></font>
      REAL,DIMENSION(ITS:ITE,JTS:JTE) :: WMID_L<a name='2457'>
<font color=#447700>!<a name='2458'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME) :: DZ,P8W,P_PHY,PI_PHY    &amp;<a name='2459'>
     &amp;                                          ,RQCCUTEN,RQRCUTEN      &amp;<a name='2460'>
     &amp;                                          ,RQICUTEN,RQSCUTEN      &amp;<a name='2461'>
     &amp;                                          ,RQVCUTEN,RR,RTHCUTEN   &amp;<a name='2462'>
     &amp;                                          ,T_PHY,TH_PHY           &amp;<a name='2463'>
     &amp;                                          ,U_PHY,V_PHY,WINT<a name='2464'>
<font color=#447700>!<a name='2465'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,ENSDIM) :: ZERO_GD<a name='2466'>
<font color=#447700>!<a name='2467'></font>
      REAL,DIMENSION(:,:,:,:),ALLOCATABLE :: MOIST_TRANS<a name='2468'>
<font color=#447700>!<a name='2469'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME) :: CLDFRA_DP, CLDFRA_SH<a name='2470'>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME) :: QC_CU, QI_CU<a name='2471'>
<font color=#447700>!<a name='2472'></font>
      LOGICAL :: RESTART,WARM_RAIN,ETAMP_Regional, have_tg_tp, have_swath<a name='2473'>
      LOGICAL,DIMENSION(IMS:IME,JMS:JME) :: CU_ACT_FLAG<a name='2474'>
<font color=#447700>!<a name='2475'></font>
      CHARACTER(LEN=255) :: message<a name='2476'>
<font color=#447700>!<a name='2477'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2478'></font>
<font color=#447700>!***  FOR TEMPERATURE CHANGE CHECK ONLY.<a name='2479'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2480'></font>
      INTEGER :: DTEMP_CHECK=2.0<a name='2481'>
      REAL :: TCHANGE<a name='2482'>
<font color=#447700>!  random number restart<a name='2483'></font>
      INTEGER, SAVE  :: nfirst<a name='2484'>
      data nfirst /0/<a name='2485'>
#if (NMM_CORE==1)<a name='2486'>
      INTEGER                    :: IDT                <a name='2487'>
      REAL,   DIMENSION(2)       :: RND1 <a name='2488'>
#endif<a name='2489'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2490'></font>
<font color=#447700>!***********************************************************************<a name='2491'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2492'></font>
<font color=#447700>!<a name='2493'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2494'></font>
<font color=#447700>!***  RESET THE HBOT/HTOP CONVECTIVE CLOUD BOTTOM (BASE) AND TOP ARRAYS<a name='2495'></font>
<font color=#447700>!***  USED IN RADIATION.  THEY STORE THE MAXIMUM VERTICAL LIMITS OF<a name='2496'></font>
<font color=#447700>!***  CONVECTIVE CLOUD BETWEEN RADIATION CALLS.  CUPPT IS THE ACCUMULATED<a name='2497'></font>
<font color=#447700>!***  CONVECTIVE PRECIPITATION BETWEEN RADIATION CALLS.<a name='2498'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2499'></font>
<font color=#447700>!<a name='2500'></font>
<font color=#447700>! Biswas's doing<a name='2501'></font>
       DO J=MYJS,MYJE<a name='2502'>
       DO I=MYIS,MYIE<a name='2503'>
<font color=#447700>!       DO J=JMS,JME<a name='2504'></font>
<font color=#447700>!       DO I=IMS,IME<a name='2505'></font>
         HFX(I,J)=0.<a name='2506'>
         QFX(I,J)=0.<a name='2507'>
       ENDDO<a name='2508'>
       ENDDO<a name='2509'>
<font color=#447700>!End<a name='2510'></font>
<a name='2511'>
      IF(MOD(NTSD,NRADS)==0.OR.MOD(NTSD,NRADL)==0)THEN<a name='2512'>
         DO J=JMS,JME<a name='2513'>
         DO I=IMS,IME<a name='2514'>
           HTOP(I,J)=0.<a name='2515'>
           HBOT(I,J)=REAL(KTE+1)<a name='2516'>
           CUTOP(I,J)=0.<a name='2517'>
           CUBOT(I,J)=REAL(KTE+1)<a name='2518'>
           CUPPT(I,J)=0.<a name='2519'>
         ENDDO<a name='2520'>
         ENDDO<a name='2521'>
      ENDIF<a name='2522'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2523'></font>
      IF(MOD(NTSD,NCNVC)/=0.AND.                                      &amp;<a name='2524'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS==BMJSCHEME)RETURN<a name='2525'>
      IF(MOD(NTSD,NCNVC)/=0.AND.                                      &amp;<a name='2526'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS==NSASSCHEME)RETURN<a name='2527'>
      IF(MOD(NTSD,NCNVC)/=0.AND.                                      &amp;<a name='2528'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS==TIEDTKESCHEME)RETURN<a name='2529'>
      IF(MOD(NTSD,NCNVC)/=0.AND.                                      &amp;<a name='2530'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS==OSASSCHEME)RETURN<a name='2531'>
      IF(MOD(NTSD,NCNVC)/=0.AND.                                      &amp;<a name='2532'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS==SASSCHEME)RETURN<a name='2533'>
      IF(MOD(NTSD,NCNVC)/=0.AND.                                      &amp;<a name='2534'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS==SCALESASSCHEME)RETURN <a name='2535'>
      <a name='2536'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2537'></font>
      NSTEP_CNV=NCNVC<a name='2538'>
<font color=#447700>!<a name='2539'></font>
      RESTART=RESTRT<a name='2540'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2541'></font>
      IF(CONFIG_FLAGS%CU_PHYSICS==KFETASCHEME)THEN<a name='2542'>
<font color=#447700>!<a name='2543'></font>
        IF(.NOT.RESTART.AND.NTSD==0)THEN<a name='2544'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2545'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2546'></font>
          DO J=JTS,JTE<a name='2547'>
          DO K=KTS,KTE<a name='2548'>
          DO I=ITS,ITE<a name='2549'>
            W0AVG(I,K,J)=0.<a name='2550'>
          ENDDO<a name='2551'>
          ENDDO<a name='2552'>
          ENDDO<a name='2553'>
        ENDIF<a name='2554'>
<font color=#447700>!<a name='2555'></font>
      ENDIF<a name='2556'>
<font color=#447700>!<a name='2557'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2558'></font>
<font color=#447700>!***  GENERAL PREPARATION<a name='2559'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2560'></font>
<font color=#447700>!<a name='2561'></font>
      AVCNVC=AVCNVC+1.<a name='2562'>
      ACUTIM=ACUTIM+1.<a name='2563'>
<font color=#447700>!<a name='2564'></font>
      DTCNVC=NCNVC*DT<a name='2565'>
      RDTCNVC=1./DTCNVC<a name='2566'>
      CAPA=R_D/CP<a name='2567'>
      G_INV=1./G<a name='2568'>
<font color=#447700>!<a name='2569'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2570'></font>
<font color=#447700>!$omp&amp; private(I,J)<a name='2571'></font>
      DO J=MYJS2,MYJE2<a name='2572'>
      DO I=MYIS1,MYIE1<a name='2573'>
<font color=#447700>!<a name='2574'></font>
        PDSL(I,J)=PD(I,J)*RES(I,J)<a name='2575'>
        RAINCV(I,J)=0.<a name='2576'>
        RAINC(I,J)=0.<a name='2577'>
        P8W(I,KTS,J)=PD(I,J)+PDTOP+PT<a name='2578'>
        LOWLYR(I,J)=KTS        <font color=#447700>!&lt;----  The lowest model layer counted from the bottom.<a name='2579'></font>
        XLAND(I,J)=SM(I,J)+1.<a name='2580'>
        NCA(I,J)=0.<a name='2581'>
        SFCZ(I,J)=FIS(I,J)*G_INV<a name='2582'>
<font color=#447700>!<a name='2583'></font>
<font color=#447700>!Biswas's doing<a name='2584'></font>
         HFX(I,J)=-TWBS(I,J)<a name='2585'>
         QFX(I,J)=-QWBS(I,J)/XLV<a name='2586'>
<font color=#447700>!End<a name='2587'></font>
<a name='2588'>
        CUTOP(I,J)=HTOP(I,J)<a name='2589'>
        CUBOT(I,J)=HBOT(I,J)<a name='2590'>
<font color=#447700>!<a name='2591'></font>
<font color=#447700>!***  LPBL IS THE MODEL LAYER CONTAINING THE PBL TOP<a name='2592'></font>
<font color=#447700>!***  COUNTING DOWNWARD FROM THE TOP OF THE DOMAIN<a name='2593'></font>
<font color=#447700>!***  SO KPBL IS THE SAME LAYER COUNTING UPWARD FROM<a name='2594'></font>
<font color=#447700>!***  THE GROUND.<a name='2595'></font>
<font color=#447700>!<a name='2596'></font>
        KPBL(I,J)=KTE-LPBL(I,J)+1<a name='2597'>
      ENDDO<a name='2598'>
      ENDDO<a name='2599'>
<font color=#447700>!<a name='2600'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2601'></font>
<font color=#447700>!$omp&amp; private(dpl,fice,frain,i,j,k,plyr,qi,ql,qr,qw,wc)<a name='2602'></font>
      DO J=MYJS2,MYJE2<a name='2603'>
        DO K=KTS,KTE<a name='2604'>
        DO I=MYIS1,MYIE1<a name='2605'>
          DPL=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='2606'>
          QL(K)=MAX(Q(I,J,K),EPSQ)<a name='2607'>
          PLYR=AETA1(K)*PDTOP+AETA2(K)*PDSL(I,J)+PT<a name='2608'>
          PLYRB=AETA1(K)*PDTOP+AETA2(K)*(1.E5-PDTOP)+PT<a name='2609'>
          ZNU(K)=(PLYRB-PT)/1.E5<a name='2610'>
          TL(K)=T(I,J,K)<a name='2611'>
<font color=#447700>!<a name='2612'></font>
          RR(I,K,J)=PLYR/(R_D*TL(K)*(P608*QL(K)+1.))<a name='2613'>
          T_PHY(I,K,J)=TL(K)<a name='2614'>
<a name='2615'>
          TH_PHY(I,K,J)=TL(K)*(1.E5/PLYR)**CAPA<a name='2616'>
<font color=#447700>!!!       P8W(I,KFLIP,J)=PINT(I,J,K+1)<a name='2617'></font>
          P8W(I,K+1,J)=ETA1(K+1)*PDTOP+ETA2(K+1)*PDSL(I,J)+PT<a name='2618'>
          P_PHY(I,K,J)=PLYR<a name='2619'>
          PI_PHY(I,K,J)=(PLYR*1.E-5)**CAPA<a name='2620'>
<font color=#447700>!<a name='2621'></font>
        ENDDO<a name='2622'>
<font color=#447700>!<a name='2623'></font>
      ENDDO<a name='2624'>
      ENDDO<a name='2625'>
<a name='2626'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2627'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2628'></font>
      DO J=JTS,JTE<a name='2629'>
        DO K=KTS,KTE<a name='2630'>
        DO I=ITS,ITE<a name='2631'>
          RTHCUTEN(I,K,J)=0.<a name='2632'>
          RQVCUTEN(I,K,J)=0.<a name='2633'>
          RQCCUTEN(I,K,J)=0.<a name='2634'>
          RQRCUTEN(I,K,J)=0.<a name='2635'>
          RQICUTEN(I,K,J)=0.<a name='2636'>
          RQSCUTEN(I,K,J)=0.<a name='2637'>
        ENDDO<a name='2638'>
      ENDDO<a name='2639'>
      ENDDO<a name='2640'>
<font color=#447700>!<a name='2641'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2642'></font>
<font color=#447700>!<a name='2643'></font>
<a name='2644'>
      IF(.NOT.HYDRO)THEN<a name='2645'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2646'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2647'></font>
        DO K=KTS,KTE<a name='2648'>
        DO J=MYJS2,MYJE2<a name='2649'>
        DO I=MYIS1,MYIE1<a name='2650'>
          DZ(I,K,J)=Z(I,J,K+1)-Z(I,J,K)<a name='2651'>
        ENDDO<a name='2652'>
        ENDDO<a name='2653'>
        ENDDO<a name='2654'>
<font color=#447700>!<a name='2655'></font>
        IF(NTSD==0)THEN<a name='2656'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2657'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2658'></font>
          DO J=MYJS2,MYJE2<a name='2659'>
          DO K=KTS,KTE+1   <font color=#447700>! zero for all interfaces<a name='2660'></font>
          DO I=MYIS1,MYIE1<a name='2661'>
            WINT(I,K,J)=0.<a name='2662'>
          ENDDO<a name='2663'>
          ENDDO<a name='2664'>
          ENDDO<a name='2665'>
<a name='2666'>
	ELSE  <font color=#447700>! not NTSD=0<a name='2667'></font>
<a name='2668'>
         DO J=MYJS2,MYJE2<a name='2669'>
           DO I=MYIS1,MYIE1<a name='2670'>
             WINT(I,KTS,J)=0.<a name='2671'>
             WINT(I,KTE+1,J)=0.<a name='2672'>
           ENDDO<a name='2673'>
         ENDDO<a name='2674'>
<a name='2675'>
         DO J=MYJS2,MYJE2<a name='2676'>
          DO K=KTS+1,KTE<a name='2677'>
           DO I=MYIS1,MYIE1<a name='2678'>
             WINT(I,K,J)=0.5*(W(I,J,K)+W(I,J,K-1))<a name='2679'>
           ENDDO<a name='2680'>
          ENDDO<a name='2681'>
         ENDDO<a name='2682'>
<a name='2683'>
        ENDIF<a name='2684'>
	<a name='2685'>
      ELSE   <font color=#447700>! hydrostatic<a name='2686'></font>
<a name='2687'>
        DO J=MYJS2,MYJE2<a name='2688'>
        DO I=MYIS1,MYIE1<a name='2689'>
          WINT(I,KTS,J)=0.<a name='2690'>
          WINT(I,KTE+1,J)=0.<a name='2691'>
        ENDDO<a name='2692'>
        ENDDO<a name='2693'>
<font color=#447700>!<a name='2694'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2695'></font>
<font color=#447700>!$omp&amp; private(i,j,k,plyr)<a name='2696'></font>
        DO J=MYJS2,MYJE2<a name='2697'>
          DO I=MYIS1,MYIE1<a name='2698'>
            WMID_L(I,J)=-OMGALF(I,J,KTS)*CP/(G*DT)<a name='2699'>
            PDSL(I,J)=PD(I,J)*RES(I,J)<a name='2700'>
            PLYR=AETA1(KTS)*PDTOP+AETA2(KTS)*PDSL(I,J)+PT<a name='2701'>
            DZ(I,KTS,J)=T(I,J,KTS)*(P608*Q(I,J,KTS)+1.)*R_D             &amp;<a name='2702'>
     &amp;                 *(P8W(I,KTS,J)-P8W(I,KTS+1,J))                   &amp;<a name='2703'>
     &amp;                 /(PLYR*G)<a name='2704'>
          ENDDO<a name='2705'>
        ENDDO<a name='2706'>
<font color=#447700>!<a name='2707'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2708'></font>
<font color=#447700>!$omp&amp; private(i,j,k,ql_k,tl_k,wmid)<a name='2709'></font>
        DO J=MYJS2,MYJE2<a name='2710'>
          DO K=KTS+1,KTE<a name='2711'>
          DO I=MYIS1,MYIE1<a name='2712'>
            TL_K=T_PHY(I,K,J)<a name='2713'>
            QL_K=MAX(Q(I,J,K),EPSQ)<a name='2714'>
            WMID=-OMGALF(I,J,K)*CP/(G*DT)<a name='2715'>
            WINT(I,K,J)=0.5*(WMID_L(I,J)+WMID)<a name='2716'>
            WMID_L(I,J)=WMID<a name='2717'>
            DZ(I,K,J)=TL_K*(P608*QL_K+1.)*R_D                           &amp;<a name='2718'>
     &amp;               *(P8W(I,K,J)-P8W(I,K+1,J))                         &amp;<a name='2719'>
     &amp;               /(P_PHY(I,K,J)*G)<a name='2720'>
          ENDDO<a name='2721'>
          ENDDO<a name='2722'>
        ENDDO<a name='2723'>
<font color=#447700>!<a name='2724'></font>
      ENDIF<a name='2725'>
<font color=#447700>!<a name='2726'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2727'></font>
<font color=#447700>!***  COMPUTE VELOCITY COMPONENTS AT MASS POINTS<a name='2728'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2729'></font>
<font color=#447700>!<a name='2730'></font>
      IF(CONFIG_FLAGS%CU_PHYSICS/=BMJSCHEME)THEN<a name='2731'>
<font color=#447700>!<a name='2732'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2733'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2734'></font>
        DO K=KTS,KTE<a name='2735'>
<font color=#447700>!<a name='2736'></font>
          DO J=MYJS1_P1,MYJE1_P1<a name='2737'>
          DO I=MYIS_P1,MYIE_P1<a name='2738'>
            U_PHY(I,K,J)=(U(I+IHE(J),J,K)+U(I+IHW(J),J,K)               &amp;<a name='2739'>
     &amp;                   +U(I,J+1,K)+U(I,J-1,K))                        &amp;<a name='2740'>
     &amp;                   *0.25<a name='2741'>
            V_PHY(I,K,J)=(V(I+IHE(J),J,K)+V(I+IHW(J),J,K)               &amp;<a name='2742'>
     &amp;                   +V(I,J+1,K)+V(I,J-1,K))                        &amp;<a name='2743'>
     &amp;                   *0.25<a name='2744'>
          ENDDO<a name='2745'>
          ENDDO<a name='2746'>
<font color=#447700>!<a name='2747'></font>
        ENDDO<a name='2748'>
<font color=#447700>!<a name='2749'></font>
      ENDIF<a name='2750'>
<font color=#447700>!<a name='2751'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2752'></font>
<font color=#447700>!***  TRANSPOSE THE MOIST ARRAY (IJK) FOR THE PHYSICS (IKJ).<a name='2753'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2754'></font>
<font color=#447700>!<a name='2755'></font>
      IF(.NOT.ALLOCATED(MOIST_TRANS))THEN<a name='2756'>
        ALLOCATE(MOIST_TRANS(IMS:IME,KMS:KME,JMS:JME,N_MOIST),STAT=ISTAT)<a name='2757'>
      ENDIF<a name='2758'>
<font color=#447700>!<a name='2759'></font>
      DO N=1,N_MOIST<a name='2760'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2761'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2762'></font>
        DO K=KMS,KME<a name='2763'>
        DO J=JMS,JME<a name='2764'>
        DO I=IMS,IME<a name='2765'>
          MOIST_TRANS(I,K,J,N)=MOIST(I,J,K,N)<a name='2766'>
        ENDDO<a name='2767'>
        ENDDO<a name='2768'>
        ENDDO<a name='2769'>
      ENDDO<a name='2770'>
<a name='2771'>
<a name='2772'>
      CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>SET_TILES</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#CUCNVC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_7">(GRID,IDS+1,IDE-1,JDS+2,JDE-2,ITS,ITE,JTS,JTE)<a name='2773'>
#if (NMM_CORE==1)<a name='2774'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2775'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2776'></font>
        DO K=KMS,KME<a name='2777'>
        DO J=JMS,JME<a name='2778'>
        DO I=IMS,IME<a name='2779'>
           DUCUDT(i,j,k)=0.0<a name='2780'>
           DVCUDT(i,j,k)=0.0<a name='2781'>
           DTHCUDT(i,j,k)=0.0<a name='2782'>
           DQVCUDT(i,j,k)=0.0<a name='2783'>
           DQRCUDT(i,j,k)=0.0<a name='2784'>
           DQCCUDT(i,j,k)=0.0<a name='2785'>
           DQICUDT(i,j,k)=0.0<a name='2786'>
           DQSCUDT(i,j,k)=0.0<a name='2787'>
        ENDDO<a name='2788'>
        ENDDO<a name='2789'>
        ENDDO<a name='2790'>
#endif<a name='2791'>
      CALL <A href='../../html_code/phys/module_cumulus_driver.F.html#CUMULUS_DRIVER'>CUMULUS_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#CUCNVC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUMULUS_DRIVER_2">(GRID                                          &amp;<a name='2792'>
     &amp;                 ,IDS=IDS,IDE=IDE,JDS=JDS,JDE=JDE,KDS=KDS,KDE=KDE &amp;<a name='2793'>
     &amp;                 ,IMS=IMS,IME=IME,JMS=JMS,JME=JME,KMS=KMS,KME=KME &amp;<a name='2794'>
     &amp;                 ,IPS=ips,IPE=ipe,JPS=jps,JPE=jpe,KPS=kps,KPE=kpe &amp;<a name='2795'>
     &amp;                 ,I_START=GRID%I_START,I_END=GRID%I_END           &amp;<a name='2796'>
     &amp;                 ,J_START=GRID%J_START,J_END=GRID%J_END           &amp;<a name='2797'>
     &amp;                 ,KTS=KTS,KTE=KTE,NUM_TILES=GRID%NUM_TILES        &amp;<a name='2798'>
                  <font color=#447700>! Prognostic<a name='2799'></font>
     &amp;                 ,U=U_PHY,V=V_PHY,TH=TH_PHY,T=T_PHY,W=WINT        &amp;<a name='2800'>
     &amp;                 ,P=P_PHY,PI=PI_PHY,RHO=RR,W0AVG=W0AVG            &amp;<a name='2801'>
                  <font color=#447700>! Others<a name='2802'></font>
     &amp;                 ,ITIMESTEP=NTSD,DT=DT,DX=GPS                     &amp;<a name='2803'>
     &amp;                 ,RAINC=RAINC,RAINCV=RAINCV,NCA=NCA               &amp;<a name='2804'>
     &amp;                 ,CLDFRA_DP=CLDFRA_DP,CLDFRA_SH=CLDFRA_SH         &amp;<a name='2805'>
     &amp;                 ,QC_CU=QC_CU, QI_CU=QI_CU                        &amp;<a name='2806'>
     &amp;                 ,DZ8W=DZ,P8W=P8W,FORCET=TTEN,FORCEQ=QTEN         &amp;<a name='2807'>
     &amp;                 ,CLDEFI=CLDEFI,LOWLYR=LOWLYR,XLAND=XLAND         &amp;<a name='2808'>
     &amp;                 ,CU_ACT_FLAG=CU_ACT_FLAG,WARM_RAIN=WARM_RAIN     &amp;<a name='2809'>
<font color=#447700>! kf_edrates<a name='2810'></font>
     &amp;                 ,UDR_KF=grid%udr_kf,DDR_KF=grid%ddr_kf           &amp;<a name='2811'>
     &amp;                 ,UER_KF=grid%uer_kf,DER_KF=grid%der_kf           &amp;<a name='2812'>
     &amp;                 ,TIMEC_KF=grid%timec_kf                          &amp;<a name='2813'>
     &amp;                 ,KF_EDRATES=config_flags%kf_edrates              &amp;<a name='2814'>
<font color=#447700>!Biswas<a name='2815'></font>
     &amp;                 ,HFX=HFX,QFX=QFX,PBLH=PBLH                       &amp;<a name='2816'>
     &amp;                 ,ZNU=ZNU                                         &amp;<a name='2817'>
     &amp;                 ,STEPCU=NSTEP_CNV,GSW=GSW                        &amp;<a name='2818'>
     &amp;                 ,PERIODIC_X=.FALSE.,PERIODIC_Y=.FALSE.           &amp;<a name='2819'>
     &amp;                 ,HTOP=CUTOP,HBOT=CUBOT,KPBL=KPBL,HT=SFCZ,Z=Z     &amp;<a name='2820'>
     &amp;                 ,APR_GR=APR_GR,APR_W=APR_W,APR_MC=APR_MC         &amp;<a name='2821'>
     &amp;                 ,APR_ST=APR_ST,APR_AS=APR_AS,APR_CAPMA=APR_CAPMA &amp;<a name='2822'>
     &amp;                 ,APR_CAPME=APR_CAPME,APR_CAPMI=APR_CAPMI         &amp;<a name='2823'>
     &amp;                 ,MASS_FLUX=MASS_FLUX,XF_ENS=XF_ENS               &amp;<a name='2824'>
     &amp;                 ,PR_ENS=PR_ENS                                   &amp;<a name='2825'>
     &amp;                 ,GD_CLOUD=GD_CLOUD,GD_CLOUD2=GD_CLOUD2           &amp;<a name='2826'>
     &amp;                 ,KTOP_DEEP=KTOP_DEEP                             &amp;<a name='2827'>
     &amp;                 ,ENSDIM=ENSDIM,MAXIENS=1,MAXENS=3                &amp;<a name='2828'>
     &amp;                 ,MAXENS2=3,MAXENS3=16                            &amp;<a name='2829'>
     &amp;                 ,RTHCUTEN=RTHCUTEN,RQVCUTEN=RQVCUTEN             &amp;<a name='2830'>
     &amp;                 ,RQCCUTEN=RQCCUTEN,RQRCUTEN=RQRCUTEN             &amp;<a name='2831'>
     &amp;                 ,RQICUTEN=RQICUTEN,RQSCUTEN=RQSCUTEN             &amp;<a name='2832'>
     &amp;                 ,RTHBLTEN=RTHBLTEN,RQVBLTEN=RQVBLTEN             &amp;<a name='2833'>
     &amp;                 ,RTHRATEN=RTHRATEN                               &amp;<a name='2834'>
#if (NMM_CORE==1)<a name='2835'>
     &amp;                 ,RUCUTEN=DUCUDT, RVCUTEN=DVCUDT, MOMMIX=MOMMIX   &amp;<a name='2836'>
                       ,store_rand=store_rand                           &amp;<a name='2837'>
#if (HWRF==1)<a name='2838'>
     &amp;                 ,pert_sas=config_flags%pert_sas                  &amp;<a name='2839'>
     &amp;                 ,ens_random_seed=config_flags%ens_random_seed    &amp;<a name='2840'>
     &amp;                 ,ens_sasamp=config_flags%ens_sasamp              &amp;<a name='2841'>
#endif<a name='2842'>
#endif<a name='2843'>
     &amp;                 ,SHALL=grid%shall                                &amp;<a name='2844'>
     &amp;                 ,HPBL2D=HPBL2D,EVAP2D=EVAP2D,HEAT2D=HEAT2D       &amp; <a name='2845'>
     &amp;                 ,DX2D=DX2D,DYNMM=DYNMM                           &amp; <font color=#447700>! scale-sware SAS <a name='2846'></font>
     &amp;                 ,SCALEFUN=SCALEFUN, SCALEFUN1=SCALEFUN1          &amp; <font color=#447700>!  scale function<a name='2847'></font>
     &amp;                 ,SIGMU=SIGMU, SIGMU1=SIGMU1                      &amp; <font color=#447700>!  updraft fraction<a name='2848'></font>
<a name='2849'>
     &amp;                 ,pgcon=config_flags%sas_pgcon                    &amp;<a name='2850'>
     &amp;                 ,sas_mass_flux=config_flags%sas_mass_flux        &amp;<a name='2851'>
     &amp;                 ,shalconv=config_flags%sas_shal_conv             &amp;<a name='2852'>
     &amp;                 ,shal_pgcon=config_flags%sas_shal_pgcon          &amp;<a name='2853'>
     &amp;                 ,IS_CAMMGMP_USED=IS_CAMMGMP_USED                 &amp;<a name='2854'>
                  <font color=#447700>! Selection argument<a name='2855'></font>
     &amp;                 ,CU_PHYSICS=CONFIG_FLAGS%CU_PHYSICS              &amp;<a name='2856'>
     &amp;                 ,MP_PHYSICS=CONFIG_FLAGS%MP_PHYSICS              &amp;<a name='2857'>
                  <font color=#447700>! Moisture tracer arguments<a name='2858'></font>
     &amp;                 ,QV_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QV),F_QV=F_QV &amp;<a name='2859'>
     &amp;                 ,QC_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QC),F_QC=F_QC &amp;<a name='2860'>
     &amp;                 ,QR_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QR),F_QR=F_QR &amp;<a name='2861'>
     &amp;                 ,QI_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QI),F_QI=F_QI &amp;<a name='2862'>
     &amp;                 ,QS_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QS),F_QS=F_QS &amp;<a name='2863'>
     &amp;                 ,QG_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QG),F_QG=F_QG)<a name='2864'>
<font color=#447700>!<a name='2865'></font>
#if (NMM_CORE==1)<a name='2866'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2867'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='2868'></font>
        DO K=KMS,KME<a name='2869'>
        DO J=JMS,JME<a name='2870'>
        DO I=IMS,IME<a name='2871'>
           DTHCUDT(i,j,k)=RTHCUTEN(i,k,j)<a name='2872'>
           DQVCUDT(i,j,k)=RQVCUTEN(i,k,j)<a name='2873'>
           DQRCUDT(i,j,k)=RQRCUTEN(i,k,j)<a name='2874'>
           DQCCUDT(i,j,k)=RQCCUTEN(i,k,j)<a name='2875'>
           DQICUDT(i,j,k)=RQICUTEN(i,k,j)<a name='2876'>
           DQSCUDT(i,j,k)=RQSCUTEN(i,k,j)<a name='2877'>
        ENDDO<a name='2878'>
        ENDDO<a name='2879'>
        ENDDO<a name='2880'>
#endif<a name='2881'>
<a name='2882'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2883'></font>
<font color=#447700>!<a name='2884'></font>
<font color=#447700>!***  CNVTOP/CNVBOT HOLD THE MAXIMUM VERTICAL LIMITS OF CONVECTIVE CLOUD<a name='2885'></font>
<font color=#447700>!***  BETWEEN HISTORY OUTPUT TIMES.  HBOTS/HTOPS STORE SIMILIAR INFORMATION<a name='2886'></font>
<font color=#447700>!***  FOR SHALLOW (NONPRECIPITATING) CONVECTION, AND HBOTD/HTOPD ARE FOR<a name='2887'></font>
<font color=#447700>!***  DEEP (PRECIPITATING) CONVECTION.<a name='2888'></font>
<font color=#447700>!<a name='2889'></font>
      CF_HI=CONFIG_FLAGS%HISTORY_INTERVAL<a name='2890'>
<a name='2891'>
      if(CF_HI&lt;1e-5) then<a name='2892'>
         CF_HI = config_flags%history_interval_s/60.   &amp;<a name='2893'>
               + config_flags%history_interval_m       &amp;<a name='2894'>
               + config_flags%history_interval_h*3600. &amp;<a name='2895'>
               + config_flags%history_interval_d*3600.*24.<a name='2896'>
      endif<a name='2897'>
<a name='2898'>
      N_TIMSTPS_OUTPUT=NINT(60.*CF_HI/DT)<a name='2899'>
      MNTO=MOD(NTSD,max(1,N_TIMSTPS_OUTPUT))<a name='2900'>
<font color=#447700>!<a name='2901'></font>
      IF(MNTO&gt;0.AND.MNTO&lt;=NCNVC)THEN<a name='2902'>
        DO J=MYJS2,MYJE2<a name='2903'>
        IENDX=MYIE1<a name='2904'>
        IF(MOD(J,2)==0.AND.ITE==IDE-1)IENDX=IENDX-1<a name='2905'>
        DO I=MYIS1,IENDX<a name='2906'>
          CNVBOT(I,J)=REAL(KTE+1.)<a name='2907'>
          CNVTOP(I,J)=0.<a name='2908'>
          HBOTD(I,J)=REAL(KTE+1.)<a name='2909'>
          HTOPD(I,J)=0.<a name='2910'>
          HBOTS(I,J)=REAL(KTE+1.)<a name='2911'>
          HTOPS(I,J)=0.<a name='2912'>
        ENDDO<a name='2913'>
        ENDDO<a name='2914'>
      ENDIF<a name='2915'>
<font color=#447700>!<a name='2916'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2917'></font>
<font color=#447700>!<a name='2918'></font>
<a name='2919'>
      have_tg_tp = .false.<a name='2920'>
      have_swath = .false.<a name='2921'>
      have_tg_tp = (size(grid%tg_total_precip)&gt;1)<a name='2922'>
#if ( HWRF == 1 )<a name='2923'>
      have_swath = ( size(grid%precip_swath)&gt;1 )<a name='2924'>
#endif<a name='2925'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='2926'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j,ncubot,ncutop,pcpcol)<a name='2927'></font>
      pcp_cloud: DO J=MYJS2,MYJE2<a name='2928'>
        IENDX=MYIE1<a name='2929'>
        IF(MOD(J,2)==0.AND.ITE==IDE-1)IENDX=IENDX-1<a name='2930'>
        DO I=MYIS1,IENDX<a name='2931'>
<font color=#447700>!<a name='2932'></font>
<font color=#447700>!***  UPDATE PRECIPITATION<a name='2933'></font>
<font color=#447700>!<a name='2934'></font>
          PCPCOL=RAINCV(I,J)*1.E-3*NSTEP_CNV<a name='2935'>
          PREC(I,J)=PREC(I,J)+PCPCOL<a name='2936'>
          ACPREC(I,J)=ACPREC(I,J)+PCPCOL<a name='2937'>
          CUPREC(I,J)=CUPREC(I,J)+PCPCOL<a name='2938'>
          CUPPT(I,J)=CUPPT(I,J)+PCPCOL<a name='2939'>
          CPRATE(I,J)=PCPCOL<a name='2940'>
          if(have_tg_tp) then<a name='2941'>
             grid%tg_total_precip(i,j) = grid%tg_total_precip(i,j) + PCPCOL<a name='2942'>
          endif<a name='2943'>
#if ( HWRF == 1 )<a name='2944'>
          if(have_swath) then<a name='2945'>
             if(grid%interesting(i,j)/=0) then<a name='2946'>
                grid%precip_swath(i,j) = grid%precip_swath(i,j) + PCPCOL<a name='2947'>
                if(size(grid%cuprecip_swath)&gt;0) then<a name='2948'>
                   grid%cuprecip_swath(i,j) = grid%cuprecip_swath(i,j) + PCPCOL<a name='2949'>
                endif<a name='2950'>
             endif<a name='2951'>
          endif<a name='2952'>
#endif<a name='2953'>
<font color=#447700>!<a name='2954'></font>
<font color=#447700>!***  SAVE CLOUD TOP AND BOTTOM FOR RADIATION (HTOP/HBOT) AND<a name='2955'></font>
<font color=#447700>!***  FOR OUTPUT (CNVTOP/CNVBOT, HTOPS/HBOTS, HTOPD/HBOTD) ARRAYS.<a name='2956'></font>
<font color=#447700>!***  THEY MUST BE TREATED SEPARATELY FROM EACH OTHER.<a name='2957'></font>
<font color=#447700>!<a name='2958'></font>
          CUTOP(I,J)=MIN(CUTOP(I,J),REAL(KDE))<a name='2959'>
          CUTOP(I,J)=MAX(CUTOP(I,J),0.0)<a name='2960'>
          CUBOT(I,J)=MIN(CUBOT(I,J),REAL(KDE))<a name='2961'>
          CUBOT(I,J)=MAX(CUBOT(I,J),0.0)<a name='2962'>
<a name='2963'>
          NCUTOP=NINT(CUTOP(I,J))<a name='2964'>
          NCUBOT=NINT(CUBOT(I,J))<a name='2965'>
<font color=#447700>!<a name='2966'></font>
          IF(NCUTOP&gt;1.AND.NCUTOP&lt;KDE)THEN<a name='2967'>
            HTOP(I,J)=MAX(CUTOP(I,J),HTOP(I,J))<a name='2968'>
            CNVTOP(I,J)=MAX(CUTOP(I,J),CNVTOP(I,J))<a name='2969'>
            IF(PCPCOL&gt;0.)THEN<a name='2970'>
              HTOPD(I,J)=MAX(CUTOP(I,J),HTOPD(I,J))<a name='2971'>
            ELSE<a name='2972'>
              HTOPS(I,J)=MAX(CUTOP(I,J),HTOPS(I,J))<a name='2973'>
            ENDIF<a name='2974'>
          ENDIF<a name='2975'>
<font color=#447700>!<a name='2976'></font>
          IF(NCUBOT&gt;0.AND.NCUBOT&lt;KDE)THEN<a name='2977'>
            HBOT(I,J)=MIN(CUBOT(I,J),HBOT(I,J))<a name='2978'>
            CNVBOT(I,J)=MIN(CUBOT(I,J),CNVBOT(I,J))<a name='2979'>
            IF(PCPCOL&gt;0.)THEN<a name='2980'>
              HBOTD(I,J)=MIN(CUBOT(I,J),HBOTD(I,J))<a name='2981'>
            ELSE<a name='2982'>
              HBOTS(I,J)=MIN(CUBOT(I,J),HBOTS(I,J))<a name='2983'>
            ENDIF<a name='2984'>
          ENDIF<a name='2985'>
<font color=#447700>!<a name='2986'></font>
        ENDDO<a name='2987'>
      ENDDO pcp_cloud<a name='2988'>
<font color=#447700>!<a name='2989'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2990'></font>
<font color=#447700>!***  UPDATE TEMPERATURE, SPECIFIC HUMIDITY, AND HEATING.<a name='2991'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2992'></font>
<font color=#447700>!<a name='2993'></font>
<font color=#447700>!-- ETAMP_Regional logical is true for regional NAM (ETAMPNEW) or HRW (ETAMPNEW) microphysics<a name='2994'></font>
<font color=#447700>!<a name='2995'></font>
      ETAMP_Regional=.FALSE.<a name='2996'>
      IF (CONFIG_FLAGS%MP_PHYSICS==ETAMPNEW .OR.                        &amp;<a name='2997'>
     &amp;    CONFIG_FLAGS%MP_PHYSICS==FER_MP_HIRES) ETAMP_Regional=.TRUE.<a name='2998'>
<font color=#447700>!<a name='2999'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3000'></font>
<font color=#447700>!$omp&amp; private(dqdt,dtdt,i,iendx,j,k,tchange)<a name='3001'></font>
      DO K=KTS,KTE<a name='3002'>
      DO J=MYJS2,MYJE2<a name='3003'>
        IENDX=MYIE1<a name='3004'>
        IF(MOD(J,2)==0.AND.ITE==IDE-1)IENDX=IENDX-1<a name='3005'>
        DO I=MYIS1,IENDX<a name='3006'>
<font color=#447700>!<a name='3007'></font>
<font color=#447700>!***  RQVCUTEN IN BMJDRV IS THE MIXING RATIO TENDENCY,<a name='3008'></font>
<font color=#447700>!***  SO RETRIEVE DQDT BY CONVERTING TO SPECIFIC HUMIDITY.<a name='3009'></font>
<font color=#447700>!<a name='3010'></font>
          DQDT=RQVCUTEN(I,K,J)/(1.+MOIST_TRANS(I,K,J,P_QV))**2<a name='3011'>
<font color=#447700>!<a name='3012'></font>
<font color=#447700>!***  RTHCUTEN IN BMJDRV IS DTDT OVER PI.<a name='3013'></font>
<font color=#447700>!<a name='3014'></font>
          DTDT=RTHCUTEN(I,K,J)*PI_PHY(I,K,J)<a name='3015'>
          T(I,J,K)=T(I,J,K)+DTDT*DTCNVC<a name='3016'>
          Q(I,J,K)=Q(I,J,K)+DQDT*DTCNVC<a name='3017'>
          TCUCN(I,J,K)=TCUCN(I,J,K)+DTDT<a name='3018'>
          MOIST_TRANS(I,K,J,P_QV)=Q(I,J,K)/(1.-Q(I,J,K))       <font color=#447700>!Convert to mixing ratio<a name='3019'></font>
<font color=#447700>!<a name='3020'></font>
          cps_select: SELECT CASE(config_flags%cu_physics)<a name='3021'>
<font color=#447700>!<a name='3022'></font>
          CASE (KFSCHEME,KFETASCHEME,GDSCHEME,SASSCHEME,SCALESASSCHEME,OSASSCHEME,NSASSCHEME,TIEDTKESCHEME)<a name='3023'>
           IF(config_flags%mp_physics==fer_mp_hires_advect) THEN<a name='3024'>
             <font color=#447700>! Update QI and QRIMEF:<a name='3025'></font>
             call <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#QITEND_FER_HIRES_ADVECT'>QITEND_FER_HIRES_ADVECT</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#CUCNVC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QITEND_FER_HIRES_ADVECT_2">( &amp;<a name='3026'>
                  MOIST_TRANS(I,K,J,P_QI), &amp;<a name='3027'>
                  SCALAR(I,J,K,P_QRIMEF), &amp;<a name='3028'>
                  RQICUTEN(I,K,J)*DTCNVC)<a name='3029'>
            ELSEIF (ETAMP_Regional) THEN<a name='3030'>
              MOIST_TRANS(I,K,J,P_QS)=MAX(0.,MOIST_TRANS(I,K,J,P_QS)+RQICUTEN(I,K,J)*DTCNVC+RQSCUTEN(I,K,J)*DTCNVC)<a name='3031'>
            ELSE<a name='3032'>
              MOIST_TRANS(I,K,J,P_QI)=MAX(0.,MOIST_TRANS(I,K,J,P_QI)+RQICUTEN(I,K,J)*DTCNVC)<a name='3033'>
              MOIST_TRANS(I,K,J,P_QS)=MAX(0.,MOIST_TRANS(I,K,J,P_QS)+RQSCUTEN(I,K,J)*DTCNVC)<a name='3034'>
            ENDIF<a name='3035'>
            MOIST_TRANS(I,K,J,P_QR)=MAX(0.,MOIST_TRANS(I,K,J,P_QR)+RQRCUTEN(I,K,J)*DTCNVC)<a name='3036'>
            MOIST_TRANS(I,K,J,P_QC)=MAX(0.,MOIST_TRANS(I,K,J,P_QC)+RQCCUTEN(I,K,J)*DTCNVC)<a name='3037'>
          END SELECT cps_select<a name='3038'>
<font color=#447700>!<a name='3039'></font>
          TCHANGE=DTDT*DTCNVC<a name='3040'>
	  IF(ABS(TCHANGE)&gt;DTEMP_CHECK)THEN<a name='3041'>
            WRITE(message,*)'BIG T CHANGE BY CONVECTION=',TCHANGE             &amp;<a name='3042'>
                     ,' AT (',I,',',J,',',K,') FOR NTSD=',NTSD<a name='3043'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#CUCNVC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_115">(trim(message))<a name='3044'>
	  ENDIF<a name='3045'>
<font color=#447700>!<a name='3046'></font>
        ENDDO<a name='3047'>
      ENDDO<a name='3048'>
      ENDDO<a name='3049'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3050'></font>
<font color=#447700>!***  REFILL THE MOIST ARRAY.<a name='3051'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3052'></font>
<font color=#447700>!<a name='3053'></font>
      DO N=1,N_MOIST<a name='3054'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3055'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='3056'></font>
        DO J=JMS,JME<a name='3057'>
        DO K=KMS,KME<a name='3058'>
        DO I=IMS,IME<a name='3059'>
          MOIST(I,J,K,N)=MOIST_TRANS(I,K,J,N)<a name='3060'>
        ENDDO<a name='3061'>
        ENDDO<a name='3062'>
        ENDDO<a name='3063'>
      ENDDO<a name='3064'>
<font color=#447700>!<a name='3065'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3066'></font>
<font color=#447700>!<a name='3067'></font>
      DEALLOCATE(MOIST_TRANS,STAT=ISTAT)<a name='3068'>
<font color=#447700>!<a name='3069'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3070'></font>
<font color=#447700>!<a name='3071'></font>
      END SUBROUTINE CUCNVC<a name='3072'>
<font color=#447700>!<a name='3073'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3074'></font>
<font color=#447700>!***********************************************************************<a name='3075'></font>
<A NAME='GSMDRIVE'><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#GSMDRIVE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3076'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>GSMDRIVE</font>(NTSD,DT,NPHS,N_MOIST                          &amp; <A href='../../call_to/GSMDRIVE.html' TARGET='index'>1</A>,<A href='../../call_from/GSMDRIVE.html' TARGET='index'>3</A><a name='3077'>
     &amp;                   ,DX,DY,SM,HBM2,FIS                             &amp;<a name='3078'>
     &amp;                   ,DETA1,DETA2,AETA1,AETA2,ETA1,ETA2             &amp;<a name='3079'>
     &amp;                   ,PDTOP,PT,PD,RES,PINT,T,Q,CWM,TRAIN            &amp;<a name='3080'>
     &amp;                   ,MOIST,SCALAR,N_SCALAR                         &amp;<a name='3081'>
     &amp;                   ,F_ICE,F_RAIN,F_RIMEF,SR                       &amp;<a name='3082'>
     &amp;                   ,PREC,ACPREC,AVRAIN                            &amp;<a name='3083'>
     &amp;                   ,MP_RESTART_STATE                              &amp;<a name='3084'>
     &amp;                   ,TBPVS_STATE                                   &amp;<a name='3085'>
     &amp;                   ,TBPVS0_STATE                                  &amp;<a name='3086'>
     &amp;                   ,GRID,CONFIG_FLAGS                             &amp;<a name='3087'>
     &amp;                   ,re_cloud,re_ice,re_snow                       &amp; <font color=#447700>! G. Thompson<a name='3088'></font>
     &amp;                   ,has_reqc,has_reqi,has_reqs                    &amp; <font color=#447700>! G. Thompson<a name='3089'></font>
     &amp;                   ,diag_flag                                     &amp; <a name='3090'>
     &amp;                   ,IDS,IDE,JDS,JDE,KDS,KDE                       &amp;<a name='3091'>
     &amp;                   ,IMS,IME,JMS,JME,KMS,KME                       &amp;<a name='3092'>
     &amp;                   ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='3093'>
<font color=#447700>!***********************************************************************<a name='3094'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='3095'></font>
<font color=#447700>!                .      .    .<a name='3096'></font>
<font color=#447700>! SUBPROGRAM:    GSMDRIVE    MICROPHYSICS OUTER DRIVER<a name='3097'></font>
<font color=#447700>!   PRGRMMR: BLACK           ORG: W/NP22     DATE: 02-03-26<a name='3098'></font>
<font color=#447700>!<a name='3099'></font>
<font color=#447700>! ABSTRACT:<a name='3100'></font>
<font color=#447700>!     GSMDRIVE DRIVES THE MICROPHYSICS SCHEMES<a name='3101'></font>
<font color=#447700>!<a name='3102'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='3103'></font>
<font color=#447700>!   02-03-26  BLACK      - ORIGINATOR<a name='3104'></font>
<font color=#447700>!   04-11-18  BLACK      - THREADED<a name='3105'></font>
<font color=#447700>!   05-12-19  BLACK      - CONVERTED FROM IKJ TO IJK<a name='3106'></font>
<font color=#447700>!<a name='3107'></font>
<font color=#447700>! USAGE: CALL GSMDRIVE FROM SOLVE_NMM<a name='3108'></font>
<font color=#447700>!<a name='3109'></font>
<font color=#447700>! ATTRIBUTES:<a name='3110'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='3111'></font>
<font color=#447700>!   MACHINE : IBM<a name='3112'></font>
<font color=#447700>!$$$<a name='3113'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3114'></font>
<font color=#447700>!<a name='3115'></font>
      IMPLICIT NONE<a name='3116'>
<font color=#447700>!<a name='3117'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3118'></font>
<font color=#447700>!<a name='3119'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='3120'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='3121'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='3122'>
     &amp;                     ,N_MOIST,N_SCALAR,NPHS,NTSD<a name='3123'>
<font color=#447700>!<a name='3124'></font>
      REAL,INTENT(IN) :: DT,DX,DY,PDTOP,PT<a name='3125'>
<font color=#447700>!<a name='3126'></font>
      REAL,INTENT(INOUT) :: AVRAIN<a name='3127'>
<font color=#447700>!<a name='3128'></font>
      REAL,DIMENSION(KMS:KME-1),INTENT(IN) :: AETA1,AETA2,DETA1,DETA2<a name='3129'>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: ETA1,ETA2<a name='3130'>
<font color=#447700>!<a name='3131'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: FIS,HBM2,PD,RES,SM<a name='3132'>
<font color=#447700>!<a name='3133'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: PINT<a name='3134'>
<font color=#447700>!<a name='3135'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: ACPREC,PREC<a name='3136'>
<font color=#447700>!<a name='3137'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT) :: CWM,Q    &amp;<a name='3138'>
     &amp;                                                        ,T,TRAIN<a name='3139'>
<font color=#447700>!<a name='3140'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: F_ICE    &amp;   <font color=#447700>!&lt;--- Used only with physics (IKJ)<a name='3141'></font>
     &amp;                                                        ,F_RAIN   &amp;<a name='3142'>
     &amp;                                                        ,F_RIMEF<a name='3143'>
<a name='3144'>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,N_MOIST)                   &amp;<a name='3145'>
     &amp;                                           ,INTENT(INOUT) :: MOIST<a name='3146'>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,N_SCALAR)                  &amp;<a name='3147'>
     &amp;                                          ,INTENT(INOUT) :: SCALAR<a name='3148'>
<font color=#447700>!<a name='3149'></font>
<font color=#447700>!***  State var for etampnew microphysics (JM, 2005 05 02)<a name='3150'></font>
<font color=#447700>!<a name='3151'></font>
      REAL,DIMENSION(:),INTENT(INOUT) :: MP_RESTART_STATE               &amp;<a name='3152'>
     &amp;                                  ,TBPVS_STATE,TBPVS0_STATE<a name='3153'>
<font color=#447700>!<a name='3154'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: SR<a name='3155'>
<font color=#447700>!<a name='3156'></font>
<font color=#447700>!..Additions for coupling cloud physics effective radii and radiation.  G. Thompson<a name='3157'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(INOUT):: re_cloud, re_ice, re_snow<a name='3158'>
      INTEGER, INTENT(IN):: has_reqc, has_reqi, has_reqs<a name='3159'>
<font color=#447700>!<a name='3160'></font>
      TYPE(DOMAIN),TARGET :: GRID<a name='3161'>
<font color=#447700>!<a name='3162'></font>
      TYPE(GRID_CONFIG_REC_TYPE),INTENT(IN) :: CONFIG_FLAGS<a name='3163'>
<font color=#447700>!<a name='3164'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3165'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='3166'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3167'></font>
<font color=#447700>!<a name='3168'></font>
      INTEGER :: I,IENDX,IJ,ISTAT,J,K,N<a name='3169'>
<font color=#447700>!<a name='3170'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME) :: LOWLYR<a name='3171'>
<font color=#447700>!<a name='3172'></font>
      REAL :: CAPA,DPL,DTPHS,PCPCOL,PLYR,RDTPHS,RG,TNEW<a name='3173'>
<font color=#447700>!<a name='3174'></font>
      REAL,DIMENSION(KMS:KME-1) :: QL,TL<a name='3175'>
<font color=#447700>!<a name='3176'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME) :: CUBOT,CUTOP,PDSL               &amp;<a name='3177'>
     &amp;                                  ,RAINNC,RAINNCV,XLAND<a name='3178'>
<font color=#447700>!<a name='3179'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME) :: CWM_PHY,DZ             &amp;<a name='3180'>
     &amp;                                          ,P8W,P_PHY,PI_PHY       &amp;<a name='3181'>
     &amp;                                          ,RR,T_PHY,TH_PHY<a name='3182'>
<font color=#447700>!<a name='3183'></font>
      REAL,DIMENSION(:,:,:,:),ALLOCATABLE :: MOIST_TRANS<a name='3184'>
      REAL,DIMENSION(:,:,:,:),ALLOCATABLE :: SCALAR_TRANS<a name='3185'>
      REAL,DIMENSION(:,:,:),  ALLOCATABLE :: W_TRANS<a name='3186'>
<font color=#447700>!<a name='3187'></font>
      LOGICAL                        :: diag_flag<a name='3188'>
      LOGICAL :: E_BDY,F_QT,QT_PRESENT,WARM_RAIN, have_tg_tp, have_swath<a name='3189'>
<font color=#447700>!<a name='3190'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3191'></font>
<font color=#447700>!***********************************************************************<a name='3192'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3193'></font>
<font color=#447700>!<a name='3194'></font>
      ALLOCATE(MOIST_TRANS(IMS:IME,KMS:KME,JMS:JME,N_MOIST),STAT=ISTAT)<a name='3195'>
      ALLOCATE(SCALAR_TRANS(IMS:IME,KMS:KME,JMS:JME,N_SCALAR),STAT=ISTAT)<a name='3196'>
      ALLOCATE(W_TRANS(IMS:IME,KMS:KME,JMS:JME))<a name='3197'>
<font color=#447700>!<a name='3198'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3199'></font>
<font color=#447700>!***  TRANSPOSE THE MOIST ARRAY (IJK) FOR THE PHYSICS (IKJ).<a name='3200'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3201'></font>
<font color=#447700>!<a name='3202'></font>
      DO N=2,N_MOIST<a name='3203'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3204'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='3205'></font>
        DO K=KMS,KME<a name='3206'>
        DO J=JMS,JME<a name='3207'>
        DO I=IMS,IME<a name='3208'>
          MOIST_TRANS(I,K,J,N)=MOIST(I,J,K,N)<a name='3209'>
        ENDDO<a name='3210'>
        ENDDO<a name='3211'>
        ENDDO<a name='3212'>
      ENDDO<a name='3213'>
      do k=kts,kte<a name='3214'>
      do j=jts,jte<a name='3215'>
      do i=its,ite<a name='3216'>
         w_trans(i,k,j)=max(grid%w(i,j,k),grid%w_tot(i,j,k))<a name='3217'>
      enddo<a name='3218'>
      enddo<a name='3219'>
      enddo<a name='3220'>
<font color=#447700>!<a name='3221'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3222'></font>
<font color=#447700>!<a name='3223'></font>
<font color=#447700>!-- QT_PRESENT logical is true for regional NAM (ETAMPNEW), HRW (ETAMPNEW),<a name='3224'></font>
<font color=#447700>!   or HWRF (ETAMP_HWRF) microphysics<a name='3225'></font>
<font color=#447700>!<a name='3226'></font>
      QT_PRESENT=.FALSE.<a name='3227'>
      IF (CONFIG_FLAGS%MP_PHYSICS==ETAMPNEW .OR.                        &amp;<a name='3228'>
     &amp;    CONFIG_FLAGS%MP_PHYSICS==FER_MP_HIRES .OR.                        &amp;<a name='3229'>
     &amp;    CONFIG_FLAGS%MP_PHYSICS==ETAMP_HWRF) QT_PRESENT=.TRUE.<a name='3230'>
<font color=#447700>!<a name='3231'></font>
      micro_check1: IF(.NOT.QT_PRESENT) THEN<a name='3232'>
        DO N=2,N_SCALAR<a name='3233'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3234'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='3235'></font>
          DO K=KMS,KME<a name='3236'>
          DO J=JMS,JME<a name='3237'>
          DO I=IMS,IME<a name='3238'>
            SCALAR_TRANS(I,K,J,N)=SCALAR(I,J,K,N)<a name='3239'>
          ENDDO<a name='3240'>
          ENDDO<a name='3241'>
          ENDDO<a name='3242'>
        ENDDO<a name='3243'>
      ENDIF micro_check1<a name='3244'>
<font color=#447700>!<a name='3245'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3246'></font>
<font color=#447700>!<a name='3247'></font>
      DTPHS=NPHS*DT<a name='3248'>
      RDTPHS=1./DTPHS<a name='3249'>
      CAPA=R_D/CP<a name='3250'>
      RG=1./G<a name='3251'>
      AVRAIN=AVRAIN+1.<a name='3252'>
<font color=#447700>!<a name='3253'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3254'></font>
<font color=#447700>!<a name='3255'></font>
<font color=#447700>!***  PREPARE NEEDED ARRAYS<a name='3256'></font>
<font color=#447700>!<a name='3257'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3258'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3259'></font>
<font color=#447700>!$omp&amp; private(i,j)<a name='3260'></font>
      DO J=MYJS2,MYJE2<a name='3261'>
      DO I=MYIS1,MYIE1<a name='3262'>
<font color=#447700>!<a name='3263'></font>
        PDSL(I,J)=PD(I,J)*RES(I,J)<a name='3264'>
        P8W(I,KTE+1,J)=PT<a name='3265'>
        LOWLYR(I,J)=KTS        <font color=#447700>!&lt;----  The lowest model layer counted from the bottom.<a name='3266'></font>
        XLAND(I,J)=SM(I,J)+1.<a name='3267'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3268'></font>
<font color=#447700>!***  FILL RAINNC WITH ZERO (NORMALLY CONTAINS THE NONCONVECTIVE<a name='3269'></font>
<font color=#447700>!***  ACCUMULATED RAIN BUT NOT YET USED BY NMM).<a name='3270'></font>
<font color=#447700>!***  CAN BE OBTAINED FROM ACPREC AND CUPREC (ACPREC-CUPREC).<a name='3271'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3272'></font>
        RAINNC(I,J)=0.<a name='3273'>
<font color=#447700>!<a name='3274'></font>
      ENDDO<a name='3275'>
      ENDDO<a name='3276'>
<font color=#447700>!<a name='3277'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3278'></font>
<font color=#447700>!***  FILL THE SINGLE-COLUMN INPUT<a name='3279'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3280'></font>
<font color=#447700>!<a name='3281'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3282'></font>
<font color=#447700>!$omp&amp; private(dpl,i,j,k,plyr,ql,tl)<a name='3283'></font>
      DO J=MYJS2,MYJE2<a name='3284'>
        DO K=KTS,KTE<a name='3285'>
        DO I=MYIS1,MYIE1<a name='3286'>
          DPL=DETA1(K)*PDTOP+DETA2(K)*PDSL(I,J)<a name='3287'>
          QL(K)=MAX(Q(I,J,K),EPSQ)<a name='3288'>
<font color=#447700>!!!       PLYR=AETA1(K)*PDTOP+AETA2(K)*PDSL(I,J)+PT<a name='3289'></font>
          PLYR=(PINT(I,J,K)+PINT(I,J,K+1))*0.5<a name='3290'>
          TL(K)=T(I,J,K)<a name='3291'>
<font color=#447700>!<a name='3292'></font>
          RR(I,K,J)=PLYR/(R_D*TL(K)*(P608*QL(K)+1.))<a name='3293'>
          T_PHY(I,K,J)=TL(K)<a name='3294'>
          PI_PHY(I,K,J)=(PLYR*1.E-5)**CAPA<a name='3295'>
          TH_PHY(I,K,J)=TL(K)/PI_PHY(I,K,J)<a name='3296'>
<font color=#447700>!!!       P8W(I,KFLIP,J)=PINT(I,J,K+1)<a name='3297'></font>
          P8W(I,K,J)=ETA1(K)*PDTOP+ETA2(K)*PDSL(I,J)+PT<a name='3298'>
          P_PHY(I,K,J)=PLYR<a name='3299'>
          DZ(I,K,J)=DPL*RG/RR(I,K,J)<a name='3300'>
          CWM_PHY(I,K,J)=CWM(I,J,K)<a name='3301'>
        ENDDO<a name='3302'>
<font color=#447700>!<a name='3303'></font>
      ENDDO<a name='3304'>
      ENDDO<a name='3305'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3306'></font>
<font color=#447700>!<a name='3307'></font>
<font color=#447700>!***  CALL MICROPHYSICS<a name='3308'></font>
<font color=#447700>!<a name='3309'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3310'></font>
<font color=#447700>!<a name='3311'></font>
      CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>SET_TILES</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#GSMDRIVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_8">(GRID,IDS+1,IDE-1,JDS+2,JDE-2,ITS,ITE,JTS,JTE)<a name='3312'>
<font color=#447700>!<a name='3313'></font>
      CALL <A href='../../html_code/phys/module_microphysics_driver.F.html#MICROPHYSICS_DRIVER'>MICROPHYSICS_DRIVER</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#GSMDRIVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_DRIVER_2">(                                         &amp;<a name='3314'>
     &amp;                  TH=TH_PHY,RHO=RR,PI_PHY=PI_PHY,P=P_PHY          &amp;<a name='3315'>
     &amp;                 ,RAINNC=RAINNC,RAINNCV=RAINNCV                   &amp;<a name='3316'>
     &amp;                 ,DZ8W=DZ,P8W=P8W,DT=DTPHS,DX=DX,DY=DY            &amp;<a name='3317'>
     &amp;                 ,W=w_trans                                       &amp;<a name='3318'>
     &amp;                 ,MP_PHYSICS=CONFIG_FLAGS%MP_PHYSICS              &amp;<a name='3319'>
     &amp;                 ,SPECIFIED=CONFIG_FLAGS%SPECIFIED                &amp;<a name='3320'>
     &amp;                        .OR.CONFIG_FLAGS%NESTED                   &amp;<a name='3321'>
     &amp;                 ,SPEC_ZONE=0,WARM_RAIN=WARM_RAIN                 &amp;<a name='3322'>
     &amp;                 ,XLAND=XLAND,ITIMESTEP=NTSD-1                    &amp;<a name='3323'>
     &amp;                 ,F_ICE_PHY=F_ICE,F_RAIN_PHY=F_RAIN               &amp;<a name='3324'>
     &amp;                 ,F_RIMEF_PHY=F_RIMEF                             &amp;<a name='3325'>
     &amp;                 ,LOWLYR=LOWLYR,SR=SR                             &amp;<a name='3326'>
     &amp;                 ,QV_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QV),F_QV=F_QV &amp;<a name='3327'>
     &amp;                 ,QC_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QC),F_QC=F_QC &amp;<a name='3328'>
     &amp;                 ,QR_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QR),F_QR=F_QR &amp;<a name='3329'>
     &amp;                 ,QI_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QI),F_QI=F_QI &amp;<a name='3330'>
     &amp;                 ,QS_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QS),F_QS=F_QS &amp;<a name='3331'>
     &amp;                 ,QG_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QG),F_QG=F_QG &amp;<a name='3332'>
     &amp;                 ,QH_CURR=MOIST_TRANS(IMS,KMS,JMS,P_QH),F_QH=F_QH &amp;<a name='3333'>
     &amp;        , QNN_CURR=SCALAR_TRANS(ims,kms,jms,P_QNN), F_QNN=F_QNN          &amp;<a name='3334'>
     &amp;        , QNDROP_CURR=SCALAR_TRANS(ims,kms,jms,P_QNDROP), F_QNDROP=F_QNDROP &amp;<a name='3335'>
     &amp;        , QNI_CURR=SCALAR_TRANS(ims,kms,jms,P_QNI), F_QNI=F_QNI          &amp;<a name='3336'>
     &amp;        , QNC_CURR=SCALAR_TRANS(ims,kms,jms,P_QNC), F_QNC=F_QNC          &amp;<a name='3337'>
     &amp;        , QNR_CURR=SCALAR_TRANS(ims,kms,jms,P_QNR), F_QNR=F_QNR          &amp;<a name='3338'>
     &amp;        , QNS_CURR=SCALAR_TRANS(ims,kms,jms,P_QNS), F_QNS=F_QNS          &amp;<a name='3339'>
     &amp;        , QNG_CURR=SCALAR_TRANS(ims,kms,jms,P_QNG), F_QNG=F_QNG          &amp;<a name='3340'>
     &amp;        , QNH_CURR=SCALAR_TRANS(ims,kms,jms,P_QNH), F_QNH=F_QNH          &amp; <font color=#447700>! for milbrandt2mom and nssl_2mom<a name='3341'></font>
     &amp;        , QVOLG_CURR=SCALAR_TRANS(ims,kms,jms,P_QVOLG), F_QVOLG=F_QVOLG    &amp; <font color=#447700>! for nssl_2mom<a name='3342'></font>
     &amp;        , QVOLH_CURR=SCALAR_TRANS(ims,kms,jms,P_QVOLH), F_QVOLH=F_QVOLH    &amp; <font color=#447700>! for nssl_2mom<a name='3343'></font>
     &amp;                 ,QRIMEF_CURR=SCALAR_TRANS(IMS,KMS,JMS,P_QRIMEF),F_QRIMEF=F_QRIMEF &amp;<a name='3344'>
     &amp;                 ,QT_CURR=CWM_PHY,F_QT=QT_PRESENT                 &amp;<a name='3345'>
     &amp;                 ,MP_RESTART_STATE=MP_RESTART_STATE               &amp;<a name='3346'>
     &amp;                 ,TBPVS_STATE=TBPVS_STATE                         &amp;<a name='3347'>
     &amp;                 ,TBPVS0_STATE=TBPVS0_STATE                       &amp;<a name='3348'>
     &amp;                 ,IDS=IDS,IDE=IDE,JDS=JDS,JDE=JDE,KDS=KDS,KDE=KDE &amp;<a name='3349'>
     &amp;                 ,IMS=IMS,IME=IME,JMS=JMS,JME=JME,KMS=KMS,KME=KME &amp;<a name='3350'>
     &amp;                 ,I_START=GRID%I_START,I_END=GRID%I_END           &amp;<a name='3351'>
     &amp;                 ,J_START=GRID%J_START,J_END=GRID%J_END           &amp;<a name='3352'>
     &amp;                 ,KTS=KTS,KTE=KTE,NUM_TILES=GRID%NUM_TILES        &amp;<a name='3353'>
     &amp;                 ,DO_RADAR_REF=config_flags%do_radar_ref          &amp;<a name='3354'>
     &amp;                 ,DIAGFLAG=diag_flag                              &amp;<a name='3355'>
     &amp;                 ,ID=grid%id                                      &amp;<a name='3356'>
     &amp;                 ,num_scalar=1                                      &amp;  <font color=#447700>!mchen temporary<a name='3357'></font>
     &amp;                 ,refl_10cm=grid%refl_10cm &amp; <font color=#447700>! to calc. radar reflectivity<a name='3358'></font>
     &amp;                 ,re_cloud=grid%re_cloud                          &amp; <font color=#447700>! G. Thompson<a name='3359'></font>
     &amp;                 ,re_ice=grid%re_ice                              &amp; <font color=#447700>! G. Thompson<a name='3360'></font>
     &amp;                 ,re_snow=grid%re_snow                            &amp; <font color=#447700>! G. Thompson<a name='3361'></font>
     &amp;                 ,has_reqc=has_reqc                               &amp; <font color=#447700>! G. Thompson<a name='3362'></font>
     &amp;                 ,has_reqi=has_reqi                               &amp; <font color=#447700>! G. Thompson<a name='3363'></font>
     &amp;                 ,has_reqs=has_reqs                               &amp; <font color=#447700>! G. Thompson<a name='3364'></font>
     &amp;                 ,ccn_conc=config_flags%ccn_conc                  &amp;<a name='3365'>
                                                                        )<a name='3366'>
<a name='3367'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3368'></font>
<font color=#447700>!$omp&amp; private(ij)<a name='3369'></font>
      DO IJ=1,GRID%NUM_TILES<a name='3370'>
        CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTA'>MICROPHYSICS_ZERO_OUTA</A><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#GSMDRIVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTA_5">(                                    &amp;<a name='3371'>
                     MOIST_TRANS,N_MOIST,CONFIG_FLAGS                   &amp;<a name='3372'>
                    ,IDS,IDE,JDS,JDE,KDS,KDE                            &amp;<a name='3373'>
                    ,IMS,IME,JMS,JME,KMS,KME                            &amp;<a name='3374'>
                    ,GRID%I_START(IJ),GRID%I_END(IJ)                    &amp;<a name='3375'>
                    ,GRID%J_START(IJ),GRID%J_END(IJ)                    &amp;<a name='3376'>
                    ,KTS,KTE                                       )<a name='3377'>
      ENDDO<a name='3378'>
<a name='3379'>
<a name='3380'>
<a name='3381'>
<font color=#447700>!<a name='3382'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3383'></font>
<font color=#447700>!<a name='3384'></font>
      E_BDY=(ITE&gt;=IDE)<a name='3385'>
<font color=#447700>!<a name='3386'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3387'></font>
<font color=#447700>!***  UPDATE TEMPERATURE, SPECIFIC HUMIDITY, CLOUD WATER, AND HEATING.<a name='3388'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3389'></font>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3390'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j,k,tnew)<a name='3391'></font>
      DO K=KTS,KTE<a name='3392'>
        DO J=MYJS2,MYJE2<a name='3393'>
          IENDX=MYIE1<a name='3394'>
          IF(E_BDY.AND.MOD(J,2)==0)IENDX=IENDX-1<a name='3395'>
          DO I=MYIS1,IENDX<a name='3396'>
            TNEW=TH_PHY(I,K,J)*PI_PHY(I,K,J)<a name='3397'>
            TRAIN(I,J,K)=TRAIN(I,J,K)+(TNEW-T(I,J,K))*RDTPHS<a name='3398'>
            T(I,J,K)=TNEW<a name='3399'>
            Q(I,J,K)=MOIST_TRANS(I,K,J,P_QV)/(1.+MOIST_TRANS(I,K,J,P_QV))<a name='3400'>
            CWM(I,J,K)=CWM_PHY(I,K,J)<a name='3401'>
          ENDDO<a name='3402'>
        ENDDO<a name='3403'>
      ENDDO<a name='3404'>
<font color=#447700>!<a name='3405'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3406'></font>
<font color=#447700>!***  UPDATE PRECIPITATION.<a name='3407'></font>
<font color=#447700>!***  NOTE: RAINNC IS ACCUMULATED INSIDE MICROPHYSICS BUT NMM ZEROES IT<a name='3408'></font>
<font color=#447700>!***  OUT ABOVE SINCE IT IS ONLY A LOCAL ARRAY FOR NOW.<a name='3409'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3410'></font>
<font color=#447700>!<a name='3411'></font>
#if ( HWRF == 1 )<a name='3412'>
      have_swath = ( size(grid%precip_swath)&gt;1 )<a name='3413'>
#endif<a name='3414'>
      have_tg_tp = (size(grid%tg_total_precip)&gt;1)<a name='3415'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3416'></font>
<font color=#447700>!$omp&amp; private(i,iendx,j,pcpcol)<a name='3417'></font>
      DO J=MYJS2,MYJE2<a name='3418'>
        IENDX=MYIE1<a name='3419'>
        IF(E_BDY.AND.MOD(J,2)==0)IENDX=IENDX-1<a name='3420'>
        DO I=MYIS1,IENDX<a name='3421'>
          PCPCOL=RAINNCV(I,J)*1.E-3<a name='3422'>
          PREC(I,J)=PREC(I,J)+PCPCOL<a name='3423'>
          ACPREC(I,J)=ACPREC(I,J)+PCPCOL<a name='3424'>
          if(have_tg_tp) then<a name='3425'>
             grid%tg_total_precip(i,j) = grid%tg_total_precip(i,j) + PCPCOL<a name='3426'>
          endif<a name='3427'>
#if ( HWRF == 1 )<a name='3428'>
          if(have_swath) then<a name='3429'>
             if(grid%interesting(i,j)/=0) &amp;<a name='3430'>
                  grid%precip_swath(i,j) = grid%precip_swath(i,j) + PCPCOL<a name='3431'>
          endif<a name='3432'>
#endif<a name='3433'>
        ENDDO<a name='3434'>
      ENDDO<a name='3435'>
<font color=#447700>!<a name='3436'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3437'></font>
<font color=#447700>!***  REFILL THE MOIST ARRAY.<a name='3438'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3439'></font>
<font color=#447700>!<a name='3440'></font>
      DO N=2,N_MOIST<a name='3441'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3442'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='3443'></font>
        DO J=JMS,JME<a name='3444'>
        DO K=KMS,KME<a name='3445'>
        DO I=IMS,IME<a name='3446'>
          MOIST(I,J,K,N)=MOIST_TRANS(I,K,J,N)<a name='3447'>
        ENDDO<a name='3448'>
        ENDDO<a name='3449'>
        ENDDO<a name='3450'>
      ENDDO<a name='3451'>
<font color=#447700>!<a name='3452'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3453'></font>
<font color=#447700>!<a name='3454'></font>
      micro_check2: IF (.NOT.QT_PRESENT) THEN<a name='3455'>
        DO N=2,N_SCALAR<a name='3456'>
<font color=#447700>!$omp parallel do                                                       &amp;<a name='3457'></font>
<font color=#447700>!$omp&amp; private(i,j,k)<a name='3458'></font>
          DO J=JMS,JME<a name='3459'>
          DO K=KMS,KME<a name='3460'>
          DO I=IMS,IME<a name='3461'>
            SCALAR(I,J,K,N)=SCALAR_TRANS(I,K,J,N)<a name='3462'>
          ENDDO<a name='3463'>
          ENDDO<a name='3464'>
          ENDDO<a name='3465'>
        ENDDO<a name='3466'>
      ENDIF micro_check2<a name='3467'>
<font color=#447700>!<a name='3468'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3469'></font>
<font color=#447700>!<a name='3470'></font>
      DEALLOCATE(MOIST_TRANS,STAT=ISTAT)<a name='3471'>
      DEALLOCATE(SCALAR_TRANS,STAT=ISTAT)<a name='3472'>
<font color=#447700>!<a name='3473'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3474'></font>
<font color=#447700>!<a name='3475'></font>
      END SUBROUTINE GSMDRIVE<a name='3476'>
<font color=#447700>!<a name='3477'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3478'></font>
<font color=#447700>!***********************************************************************<a name='3479'></font>
<A NAME='UPDATE_MOIST'><A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#UPDATE_MOIST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3480'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>UPDATE_MOIST</font>(MOIST,Q,CWM,F_ICE,F_RAIN,N_MOIST          &amp; <A href='../../call_to/UPDATE_MOIST.html' TARGET='index'>3</A><a name='3481'>
     &amp;                       ,IDS,IDE,JDS,JDE,KDS,KDE                   &amp;<a name='3482'>
     &amp;                       ,IMS,IME,JMS,JME,KMS,KME                   &amp;<a name='3483'>
     &amp;                       ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='3484'>
<font color=#447700>!***********************************************************************<a name='3485'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3486'></font>
<font color=#447700>!<a name='3487'></font>
      IMPLICIT NONE<a name='3488'>
<font color=#447700>!<a name='3489'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3490'></font>
<font color=#447700>!<a name='3491'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='3492'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='3493'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                     &amp;<a name='3494'>
     &amp;                     ,N_MOIST<a name='3495'>
<font color=#447700>!<a name='3496'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: CWM,Q<a name='3497'>
<font color=#447700>!<a name='3498'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: F_ICE       &amp;   <font color=#447700>!&lt;--- Used only with physics (IKJ)<a name='3499'></font>
     &amp;                                                     ,F_RAIN<a name='3500'>
<font color=#447700>!<a name='3501'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME,N_MOIST),INTENT(OUT) :: MOIST<a name='3502'>
<font color=#447700>!<a name='3503'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3504'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='3505'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3506'></font>
<font color=#447700>!<a name='3507'></font>
      INTEGER :: I,J,K<a name='3508'>
<font color=#447700>!<a name='3509'></font>
      REAL :: FICE,FRAIN,QI,QR,QW,WC<a name='3510'>
<font color=#447700>!<a name='3511'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3512'></font>
<font color=#447700>!***********************************************************************<a name='3513'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3514'></font>
<font color=#447700>!<a name='3515'></font>
      DO K=KTS,KTE<a name='3516'>
      DO J=MYJS,MYJE<a name='3517'>
      DO I=MYIS,MYIE<a name='3518'>
        MOIST(I,J,K,P_QV)=Q(I,J,K)/(1.-Q(I,J,K))<a name='3519'>
        WC=CWM(I,J,K)<a name='3520'>
        QI=0.<a name='3521'>
        QR=0.<a name='3522'>
        QW=0.<a name='3523'>
        FICE=F_ICE(I,K,J)<a name='3524'>
        FRAIN=F_RAIN(I,K,J)<a name='3525'>
<font color=#447700>!<a name='3526'></font>
        IF(FICE&gt;=1.)THEN<a name='3527'>
          QI=WC<a name='3528'>
        ELSEIF(FICE&lt;=0.)THEN<a name='3529'>
          QW=WC<a name='3530'>
        ELSE<a name='3531'>
          QI=FICE*WC<a name='3532'>
          QW=WC-QI<a name='3533'>
        ENDIF<a name='3534'>
<font color=#447700>!<a name='3535'></font>
        IF(QW&gt;0..AND.FRAIN&gt;0.)THEN<a name='3536'>
          IF(FRAIN&gt;=1.)THEN<a name='3537'>
            QR=QW<a name='3538'>
            QW=0.<a name='3539'>
          ELSE<a name='3540'>
            QR=FRAIN*QW<a name='3541'>
            QW=QW-QR<a name='3542'>
          ENDIF<a name='3543'>
        ENDIF<a name='3544'>
<font color=#447700>!<a name='3545'></font>
        MOIST(I,J,K,P_QC)=QW<a name='3546'>
        MOIST(I,J,K,P_QR)=QR<a name='3547'>
        MOIST(I,J,K,P_QI)=0.<a name='3548'>
        MOIST(I,J,K,P_QS)=QI<a name='3549'>
        MOIST(I,J,K,P_QG)=0.<a name='3550'>
      ENDDO<a name='3551'>
      ENDDO<a name='3552'>
      ENDDO<a name='3553'>
<font color=#447700>!<a name='3554'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3555'></font>
<font color=#447700>!<a name='3556'></font>
      END SUBROUTINE UPDATE_MOIST<a name='3557'>
<font color=#447700>!<a name='3558'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3559'></font>
<font color=#447700>!***********************************************************************<a name='3560'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3561'></font>
<font color=#447700>!<a name='3562'></font>
      END MODULE MODULE_PHYSICS_CALLS<a name='3563'>
<font color=#447700>!<a name='3564'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='3565'></font>
</pre></body></html>