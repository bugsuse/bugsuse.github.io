<HTML> <BODY BGCOLOR=#bbeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#define HRD_MULTIPLE_STORMS<a name='2'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>!NCEP_MESO:MEDIATION_LAYER:SOLVER<a name='5'></font>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7'></font>
#include "<A href='../../html_code/include/nmm_loop_basemacros.h.html'>nmm_loop_basemacros.h</A>"<A NAME="nmm_loop_basemacros.h_1"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#solve_nmm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='8'>
#include "<A href='../../html_code/include/nmm_loop_macros.h.html'>nmm_loop_macros.h</A>"<A NAME="nmm_loop_macros.h_2"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#solve_nmm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='9'>
<font color=#447700>!-----------------------------------------------------------------------<a name='10'></font>
<font color=#447700>!<a name='11'></font>
<A NAME='SOLVE_NMM'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOLVE_NMM</font>(GRID,CONFIG_FLAGS                            &amp; <A href='../../call_to/SOLVE_NMM.html' TARGET='index'>1</A>,<A href='../../call_from/SOLVE_NMM.html' TARGET='index'>261</A><a name='13'>
<font color=#447700>!<a name='14'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_3"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='15'>
<font color=#447700>!<a name='16'></font>
     &amp;           )<a name='17'>
<font color=#447700>!-----------------------------------------------------------------------<a name='18'></font>
        use <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_16"><a name='19'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>MODULE_DOMAIN</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_88">,                ONLY : DOMAIN, GET_IJK_FROM_GRID &amp;<a name='20'>
                                              ,domain_clock_get,is_alarm_tstep_nphs<a name='21'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>MODULE_CONFIGURE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_52">,             ONLY : GRID_CONFIG_REC_TYPE<a name='22'>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_34"><a name='23'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>MODULE_STATE_DESCRIPTION</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_31"><a name='24'>
      USE <A href='../../html_code/dyn_nmm/module_CTLBLK.F.html#MODULE_CTLBLK'>MODULE_CTLBLK</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CTLBLK_1"><a name='25'>
      use <A href='../../html_code/share/module_random.F.html#MODULE_RANDOM'>MODULE_RANDOM</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RANDOM_1">,                ONLY : rand_grid_r4<a name='26'>
#ifdef DM_PARALLEL<a name='27'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>MODULE_DM</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_61">,                    ONLY : LOCAL_COMMUNICATOR       &amp;<a name='28'>
                                              ,MYTASK,NTASKS,NTASKS_X   &amp;<a name='29'>
                                              ,NTASKS_Y<a name='30'>
      USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>MODULE_COMM_DM</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_22"><a name='31'>
#endif<a name='32'>
#if ( HWRF == 1 )<a name='33'>
      USE <A href='../../html_code/dyn_nmm/module_swath.F.html#MODULE_SWATH'>MODULE_SWATH</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SWATH_1">,                 ONLY : UPDATE_INTEREST, SUSTAINED_WIND, CHECK_FOR_KID_MOVE<a name='34'>
      USE <A href='../../html_code/dyn_nmm/module_HIFREQ.F.html#MODULE_HIFREQ'>MODULE_HIFREQ</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_HIFREQ_1">,                ONLY: HIFREQ_WRITE, HIFREQ_OPEN<a name='35'>
#endif<a name='36'>
      USE <A href='../../html_code/dyn_nmm/module_tornado_genesis.F.html#MODULE_TORNADO_GENESIS'>MODULE_TORNADO_GENESIS</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TORNADO_GENESIS_2">,       ONLY: CALC_TORNADO_GENESIS, RESET_TORNADO_GENESIS<a name='37'>
      USE <A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#MODULE_IGWAVE_ADJUST'>MODULE_IGWAVE_ADJUST</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IGWAVE_ADJUST_1">,         ONLY: PDTE,PFDHT,DDAMP,VTOA<a name='38'>
      USE <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#MODULE_ADVECTION'>MODULE_ADVECTION</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_ADVECTION_1">,             ONLY: ADVE,VAD2,HAD2            &amp;<a name='39'>
                                             ,ADV2,MONO                 &amp;<a name='40'>
                                             ,VAD2_SCAL,HAD2_SCAL<a name='41'>
      USE <A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#MODULE_NONHY_DYNAM'>MODULE_NONHY_DYNAM</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_NONHY_DYNAM_1">,           ONLY: EPS,VADZ,HADZ<a name='42'>
      USE <A href='../../html_code/dyn_nmm/module_DIFFUSION_NMM.F.html#MODULE_DIFFUSION_NMM'>MODULE_DIFFUSION_NMM</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIFFUSION_NMM_1">,         ONLY: HDIFF<a name='43'>
      USE <A href='../../html_code/dyn_nmm/module_BNDRY_COND.F.html#MODULE_BNDRY_COND'>MODULE_BNDRY_COND</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BNDRY_COND_1">,            ONLY: &amp;<a name='44'>
           BOCOV, MASS_BOUNDARY, MP_BULK_BOUNDARY, MP_SPECIES_BDY<a name='45'>
      USE <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#MODULE_PHYSICS_CALLS'>MODULE_PHYSICS_CALLS</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PHYSICS_CALLS_1"><a name='46'>
      USE MODULE_EXT_INTERNAL<a name='47'>
      USE <A href='../../html_code/dyn_nmm/module_PRECIP_ADJUST.F.html#MODULE_PRECIP_ADJUST'>MODULE_PRECIP_ADJUST</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PRECIP_ADJUST_1"><a name='48'>
      USE <A href='../../html_code/dyn_nmm/module_NEST_UTIL.F.html#MODULE_NEST_UTIL'>MODULE_NEST_UTIL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_NEST_UTIL_2">     <font color=#447700>! USEs module_MPP (contains MYPE,NPES,MPI_COMM_COMP)<a name='49'></font>
#ifdef MOVE_NESTS<a name='50'>
      USE <A href='../../html_code/dyn_nmm/module_STATS_FOR_MOVE.F.html#MODULE_STATS_FOR_MOVE'>MODULE_STATS_FOR_MOVE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATS_FOR_MOVE_1">,        ONLY: STATS_FOR_MOVE<a name='51'>
#endif<a name='52'>
      USE <A href='../../html_code/phys/module_diag_refl.F.html#MODULE_DIAG_REFL'>MODULE_DIAG_REFL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIAG_REFL_1"><a name='53'>
<a name='54'>
<a name='55'>
<font color=#447700>!-----------------------------------------------------------------------<a name='56'></font>
<font color=#447700>!<a name='57'></font>
      IMPLICIT NONE<a name='58'>
<font color=#447700>!<a name='59'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='60'></font>
<font color=#447700>!<a name='61'></font>
<font color=#447700>!***  INPUT DATA<a name='62'></font>
<font color=#447700>!<a name='63'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='64'></font>
<font color=#447700>!<a name='65'></font>
      TYPE(DOMAIN),TARGET :: GRID<a name='66'>
<font color=#447700>!<a name='67'></font>
<font color=#447700>!***  DEFINITIONS OF DUMMY ARGUMENTS TO THIS ROUTINE (GENERATED FROM REGISTRY)<a name='68'></font>
<font color=#447700>!<a name='69'></font>
<font color=#447700>! NOTE, REGISTRY NO LONGER GENERATES DUMMY ARGUMENTS OR DUMMY ARGUMENT<a name='70'></font>
<font color=#447700>! DECLARATIONS FOR RCONFIG ENTRIES. THEY ARE STILL PART OF STATE. ACCESS<a name='71'></font>
<font color=#447700>! TO THESE VARIABLES IS NOW THROUGH GRID STRUCTURE, AS MODIFIED BELOW.<a name='72'></font>
<font color=#447700>! AFFECTED VARIABLES: SIGMA, DT, NPHS, IDTAD, NRADS, NRADL, JULDAY,<a name='73'></font>
<font color=#447700>! JULYR, NUM_SOIL_LAYERS, NCNVC, ENSDIM, DY, AND SPEC_BDY_WIDTH.<a name='74'></font>
<font color=#447700>! JM, 20050819<a name='75'></font>
<font color=#447700>!<a name='76'></font>
<font color=#447700>!----------------------------<a name='77'></font>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_4"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='78'>
<font color=#447700>!----------------------------<a name='79'></font>
<font color=#447700>!<a name='80'></font>
<font color=#447700>!***  STRUCTURE THAT CONTAINS RUN-TIME CONFIGURATION (NAMELIST) DATA FOR DOMAIN<a name='81'></font>
<font color=#447700>!<a name='82'></font>
      TYPE(GRID_CONFIG_REC_TYPE),INTENT(IN) :: CONFIG_FLAGS<a name='83'>
<font color=#447700>!<a name='84'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='85'></font>
<font color=#447700>!<a name='86'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='87'></font>
<font color=#447700>!<a name='88'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='89'></font>
<font color=#447700>!<a name='90'></font>
      INTEGER :: IDS,IDE,JDS,JDE,KDS,KDE                                &amp;<a name='91'>
     &amp;          ,IMS,IME,JMS,JME,KMS,KME                                &amp; <a name='92'>
     &amp;          ,IPS,IPE,JPS,JPE,KPS,KPE                                &amp;<a name='93'>
     &amp;          ,ITS,ITE,JTS,JTE,KTS,KTE<a name='94'>
<font color=#447700>!<a name='95'></font>
      LOGICAL :: advect_q2<a name='96'>
      INTEGER :: I,ICLTEND,IDF,IRTN,J,JC,JDF,K,KDF,LB,N_MOIST &amp;<a name='97'>
     &amp;          ,NTSD_current,L<a name='98'>
#if ( HWRF == 1 )<a name='99'>
#ifdef HRD_MULTIPLE_STORMS<a name='100'>
<font color=#447700>!XUEJIN's doing<a name='101'></font>
      INTEGER, PARAMETER                    :: max_simulation_domains=11 <font color=#447700>!The max number of domains in the HWRF simulation. Currently hard-coded to 5 storms. This should eventually be replaced with CONFIG_FLAGS%MAX_DOM.<a name='102'></font>
      INTEGER                               :: kid1<a name='103'>
      INTEGER,SAVE,DIMENSION(max_simulation_domains)       :: NTSD_restart1<a name='104'>
#else<a name='105'>
<font color=#447700>!zhang's doing<a name='106'></font>
      INTEGER,SAVE :: NTSD_restart1,NTSD_restart2,NTSD_restart3<a name='107'>
#endif<a name='108'>
      LOGICAL :: multi_storm, no_ocean<a name='109'>
#endif<a name='110'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='111'>
      integer, save :: cpu<a name='112'>
      integer :: newcpu<a name='113'>
#endif<a name='114'>
      integer :: ierr,nrand,idt<a name='115'>
      INTEGER,SAVE :: NTSD_restart<a name='116'>
<font color=#447700>!     INTEGER :: MPI_COMM_COMP,MYPE,MYPROC,NPES<a name='117'></font>
      INTEGER :: MYPROC,imid,jmid<a name='118'>
      INTEGER :: KVH,NTSD_rad,RC<a name='119'>
      INTEGER :: NUM_AEROSOLC<a name='120'>
<font color=#447700>!<a name='121'></font>
      REAL :: DT_INV,FICE,FRAIN,GPS,QI,QR,QW,WC,WP<a name='122'>
      REAL :: dwdt_damping_lev<a name='123'>
<font color=#447700>!<a name='124'></font>
      LOGICAL :: LAST_TIME,OPERATIONAL_PHYSICS,ETAMP_PHYSICS<a name='125'>
<font color=#447700>!<a name='126'></font>
      CHARACTER(80) :: MESSAGE<a name='127'>
<font color=#447700>!<a name='128'></font>
<font color=#447700>!***  For precip assimilation:<a name='129'></font>
      INTEGER :: ISTAT,DOM,one<a name='130'>
      LOGICAL :: HF<a name='131'>
      REAL,ALLOCATABLE,SAVE,DIMENSION(:,:,:) :: PPTDAT<a name='132'>
<font color=#447700>!<a name='133'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='134'></font>
<font color=#447700>!***  For physics compatibility with other packages<a name='135'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='136'></font>
<font color=#447700>!<a name='137'></font>
      REAL,ALLOCATABLE,DIMENSION(:,:,:) :: TTEN,QTEN<a name='138'>
      REAL,ALLOCATABLE,DIMENSION(:,:,:) :: RTHRATEN,RTHBLTEN,RQVBLTEN<a name='139'>
<font color=#447700>!<a name='140'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='141'></font>
<font color=#447700>!<a name='142'></font>
      LOGICAL wrf_dm_on_monitor<a name='143'>
      EXTERNAL wrf_dm_on_monitor<a name='144'>
<font color=#447700>!<a name='145'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='146'></font>
<font color=#447700>!***  TIMING VARIABLES<a name='147'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='148'></font>
      real,save :: solve_tim,exch_tim,pdte_tim,adve_tim,vtoa_tim        &amp;<a name='149'>
     &amp;,            vadz_tim,hadz_tim,eps_tim,vad2_tim,had2_tim          &amp;<a name='150'>
     &amp;,            radiation_tim,rdtemp_tim,turbl_tim,cltend_tim        &amp;<a name='151'>
     &amp;,            cucnvc_tim,gsmdrive_tim,hdiff_tim,bocoh_tim          &amp;<a name='152'>
     &amp;,            pfdht_tim,ddamp_tim,bocov_tim,uv_htov_tim,sum_tim    &amp;<a name='153'>
#if ( HWRF == 1 )<a name='154'>
     &amp;,            sst_tim,flux_tim,hifreq_tim,wav_tim,cplstep_tim      &amp;<a name='155'>
#endif<a name='156'>
     &amp;,            diag_tim,adjppt_tim,tornado_tim                      <a name='157'>
<a name='158'>
<font color=#447700>! Flag for producing diagnostic fields (e.g., radar reflectivity) <a name='159'></font>
      LOGICAL                        :: diag_flag<a name='160'>
<a name='161'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='162'>
      real,save :: loadimbal_tim,previmbal_tim<a name='163'>
#endif<a name='164'>
      real,save :: exch_tim_max<a name='165'>
      real :: ttim,btimx<a name='166'>
      real :: et_max,this_tim<a name='167'>
      integer :: n_print_time<a name='168'>
<font color=#447700>!!BEGIN: LSM changes for LANDFALL: Subashini 7/27/2016<a name='169'></font>
      integer :: move_land_time<a name='170'>
      integer :: SOIL_ID, VEG_ID, DIRN<a name='171'>
      real :: land_albedo, land_emiss, land_vgfrac, land_smc, land_z0<a name='172'>
      NAMELIST/param_land/SOIL_ID, VEG_ID, DIRN, land_albedo, land_emiss, land_vgfrac, land_smc,land_z0<a name='173'>
<font color=#447700>!! END: LSM changes for LANDFALL : Subashini 7/27/2016<a name='174'></font>
<a name='175'>
<font color=#447700>!<a name='176'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='177'></font>
<font color=#447700>!<a name='178'></font>
<font color=#447700>!#ifdef DEREF_KLUDGE<a name='179'></font>
<font color=#447700>!! SEE http://www.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='180'></font>
<font color=#447700>!      INTEGER :: SM31,EM31,SM32,EM32,SM33,EM33 <a name='181'></font>
<font color=#447700>!      INTEGER :: SM31X,EM31X,SM32X,EM32X,SM33X,EM33X<a name='182'></font>
<font color=#447700>!      INTEGER :: SM31Y,EM31Y,SM32Y,EM32Y,SM33Y,EM33Y<a name='183'></font>
<font color=#447700>!#endif<a name='184'></font>
<font color=#447700>!<a name='185'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='186'></font>
<font color=#447700>!***  Passive substance variables<a name='187'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='188'></font>
<font color=#447700>!<a name='189'></font>
      LOGICAL :: EULER<a name='190'>
      INTEGER :: IDTADT <a name='191'>
      INTEGER :: IDTADC<a name='192'>
      INTEGER :: KS                                                        <font color=#447700>! species index in 4d tracer array<a name='193'></font>
<font color=#447700>!<a name='194'></font>
      REAL,SAVE :: SUMDRRW<a name='195'>
<font color=#447700>!<a name='196'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='197'></font>
<font color=#447700>!<a name='198'></font>
<font color=#447700>! LIMIT THE NUMBER OF ARGUMENTS IF COMPILED WITH -DLIMIT_ARGS BY COPYING<a name='199'></font>
<font color=#447700>! SCALAR (NON-ARRAY) ARGUMENTS OUT OF THE GRID DATA STRUCTURE INTO LOCALLY<a name='200'></font>
<font color=#447700>! DEFINED COPIES (DEFINED IN EM_DUMMY_DECL.INC, ABOVE, AS THEY ARE IF THEY<a name='201'></font>
<font color=#447700>! ARE ARGUMENTS).  AN EQUIVALENT INCLUDE OF EM_SCALAR_DEREFS.INC APPEARS<a name='202'></font>
<font color=#447700>! AT THE END OF THE ROUTINE TO COPY BACK ANY CHNAGED NON-ARRAY VALUES.<a name='203'></font>
<font color=#447700>! THE DEFINITION OF COPY_IN OR COPY_OUT BEFORE THE INCLUDE DEFINES THE<a name='204'></font>
<font color=#447700>! DIRECTION OF THE COPY.  NMM_SCALAR_DEREFS IS GENERATED FROM REGISTRY.<a name='205'></font>
<font color=#447700>!<a name='206'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='207'></font>
<font color=#447700>!#define COPY_IN<a name='208'></font>
<font color=#447700>!#include "scalar_derefs.inc"<a name='209'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='210'></font>
<font color=#447700>!<a name='211'></font>
<font color=#447700>! TRICK PROBLEMATIC COMPILERS INTO NOT PERFORMING COPY-IN/COPY-OUT BY ADDING<a name='212'></font>
<font color=#447700>! INDICES TO ARRAY ARGUMENTS IN THE CALL STATEMENTS IN THIS ROUTINE.<a name='213'></font>
<font color=#447700>! IT HAS THE EFFECT OF PASSING ONLY THE FIRST ELEMENT OF THE ARRAY, RATHER<a name='214'></font>
<font color=#447700>! THAN THE ENTIRE ARRAY.  SEE:<a name='215'></font>
<font color=#447700>! http://www.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='216'></font>
<font color=#447700>!<a name='217'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='218'></font>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_5"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='219'>
<font color=#447700>!-----------------------------------------------------------------------<a name='220'></font>
<font color=#447700>!<a name='221'></font>
<font color=#447700>! NEEDED BY SOME COMM LAYERS, E.G. RSL.  IF NEEDED, nmm_data_calls.inc IS<a name='222'></font>
<font color=#447700>! GENERATED FROM THE REGISTRY.  THE DEFINITION OF REGISTER_I1 ALLOWS<a name='223'></font>
<font color=#447700>! I1 DATA TO BE COMMUNICATED IN THIS ROUTINE IF NECESSARY.<a name='224'></font>
<font color=#447700>!<a name='225'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='226'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='227'></font>
<font color=#447700>!***********************************************************************<a name='228'></font>
<font color=#447700>!***<a name='229'></font>
<font color=#447700>!***               THE MAIN TIME INTEGRATION LOOP<a name='230'></font>
<font color=#447700>!***<a name='231'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='232'></font>
<font color=#447700>!<a name='233'></font>
<font color=#447700>!***  ntsd IS THE TIMESTEP COUNTER (Number of Time Steps Done)<a name='234'></font>
<font color=#447700>!<a name='235'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='236'></font>
<font color=#447700>!***<a name='237'></font>
<font color=#447700>!***  ADVANCE_count STARTS AT ZERO FOR ALL RUNS (REGULAR AND RESTART).<a name='238'></font>
<font color=#447700>!***<a name='239'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='240'></font>
<font color=#447700>!<a name='241'></font>
      ttim=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_1">() <font color=#447700>! used to calculate total time spent in solver<a name='242'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>DOMAIN_CLOCK_GET</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_9">(GRID,ADVANCEcOUNT=NTSD_current)<a name='243'>
<font color=#447700>!<a name='244'></font>
      IF(NTSD_current==0)THEN<a name='245'>
        IF(GRID%RESTART.AND.GRID%TSTART&gt;0.)THEN<a name='246'>
#if ( HWRF == 1 )<a name='247'>
#ifdef HRD_MULTIPLE_STORMS<a name='248'>
<font color=#447700>!XUEJIN's doing<a name='249'></font>
          do kid1=1,max_simulation_domains<a name='250'>
          if( grid%id .eq. kid1 ) NTSD_restart1(kid1)=INT(grid%TSTART*3600./GRID%DT+0.5)<a name='251'>
          end do<a name='252'>
#else<a name='253'>
<font color=#447700>!zhang's doing: temporarily hardwired for two domains<a name='254'></font>
          if( grid%id .eq. 1 ) NTSD_restart1=INT(grid%TSTART*3600./GRID%DT+0.5)<a name='255'>
          if( grid%id .eq. 2 ) NTSD_restart2=INT(grid%TSTART*3600./GRID%DT+0.5)<a name='256'>
          if( grid%id .eq. 3 ) NTSD_restart3=INT(grid%TSTART*3600./GRID%DT+0.5)<a name='257'>
#endif<a name='258'>
#endif<a name='259'>
          IHRST=grid%nstart_hour<a name='260'>
          NTSD_restart=grid%ntsd<a name='261'>
        ELSE<a name='262'>
          IHRST=GRID%GMT<a name='263'>
          grid%nstart_hour=IHRST<a name='264'>
#if ( HWRF == 1 )<a name='265'>
#ifdef HRD_MULTIPLE_STORMS<a name='266'>
<font color=#447700>!XUEJIN's doing<a name='267'></font>
          NTSD_restart1=0<a name='268'>
#else<a name='269'>
<font color=#447700>!zhang's doing<a name='270'></font>
          NTSD_restart1=0<a name='271'>
          NTSD_restart2=0<a name='272'>
          NTSD_restart3=0<a name='273'>
#endif<a name='274'>
#else<a name='275'>
          NTSD_restart=0<a name='276'>
#endif<a name='277'>
        ENDIF<a name='278'>
      ENDIF<a name='279'>
#if ( HWRF == 1 )<a name='280'>
#ifdef HRD_MULTIPLE_STORMS<a name='281'>
<font color=#447700>!XUEJIN's doing<a name='282'></font>
      do kid1=1,max_simulation_domains<a name='283'>
      if( grid%id .eq. kid1 ) grid%ntsd=NTSD_restart1(kid1)+NTSD_current<a name='284'>
      end do<a name='285'>
#else<a name='286'>
<font color=#447700>!zhang's doing<a name='287'></font>
      if( grid%id .eq. 1 ) grid%ntsd=NTSD_restart1+NTSD_current<a name='288'>
      if( grid%id .eq. 2 ) grid%ntsd=NTSD_restart2+NTSD_current<a name='289'>
      if( grid%id .eq. 3 ) grid%ntsd=NTSD_restart3+NTSD_current<a name='290'>
#endif<a name='291'>
#else<a name='292'>
      grid%ntsd=NTSD_restart+NTSD_current<a name='293'>
#endif<a name='294'>
      LAST_TIME=<A href='../../html_code/frame/module_domain.F.html#DOMAIN_LAST_TIME_STEP'>domain_last_time_step</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_LAST_TIME_STEP_1">(GRID)<a name='295'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='296'></font>
<font color=#447700>!<a name='297'></font>
<font color=#447700>! Set diagnostic flag value at history output time<a name='298'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='299'></font>
<a name='300'>
      diag_flag = &amp;<a name='301'>
           is_alarm_tstep_nphs(grid%domain_clock, grid%alarms(HISTORY_ALARM), grid%nphs) &amp;<a name='302'>
           .or. &amp;<a name='303'>
           is_alarm_tstep_nphs(grid%domain_clock, grid%alarms(AUXHIST1_ALARM), grid%nphs) &amp;<a name='304'>
           .or. &amp;<a name='305'>
           is_alarm_tstep_nphs(grid%domain_clock, grid%alarms(AUXHIST2_ALARM), grid%nphs) &amp;<a name='306'>
           .or. &amp;<a name='307'>
           is_alarm_tstep_nphs(grid%domain_clock, grid%alarms(AUXHIST3_ALARM), grid%nphs)<a name='308'>
<a name='309'>
<font color=#447700>!<a name='310'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='311'></font>
<font color=#447700>!<a name='312'></font>
<font color=#447700>!!!!! IF(WRF_DM_ON_MONITOR() )THEN<a name='313'></font>
        WRITE(MESSAGE,125)grid%id,grid%ntsd,grid%ntsd*GRID%DT/3600.<a name='314'>
  125   FORMAT(' SOLVE_NMM: ',I3,' TIMESTEP IS ',I5,'   TIME IS ',F7.3,' HOURS')<a name='315'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_194">(TRIM(MESSAGE))<a name='316'>
<font color=#447700>!!!!  ENDIF<a name='317'></font>
<font color=#447700>!<a name='318'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='319'></font>
<font color=#447700>!<a name='320'></font>
      EULER=model_config_rec%EULER_ADV<a name='321'>
      IDTADT=model_config_rec%IDTADT<a name='322'>
      IDTADC=model_config_rec%IDTADC<a name='323'>
      WP=model_config_rec%WP(grid%id)<a name='324'>
      dwdt_damping_lev=model_config_rec%dwdt_damping_lev(grid%id)<a name='325'>
<font color=#447700>!<a name='326'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='327'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>WRF_GET_DM_COMMUNICATOR</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_8">(MPI_COMM_COMP)<a name='328'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>WRF_GET_NPROC</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_3">(NPES)<a name='329'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>WRF_GET_MYPROC</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_9">(MYPROC)<a name='330'>
      MYPE=MYPROC<a name='331'>
<font color=#447700>!-----------------------------------------------------------------------<a name='332'></font>
<font color=#447700>!<a name='333'></font>
<font color=#447700>!***  OBTAIN DIMENSION INFORMATION STORED IN THE GRID DATA STRUCTURE.<a name='334'></font>
<font color=#447700>!<a name='335'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>GET_IJK_FROM_GRID</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_26">(GRID                                       &amp;<a name='336'>
     &amp;                      ,IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='337'>
     &amp;                      ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='338'>
     &amp;                      ,IPS,IPE,JPS,JPE,KPS,KPE )<a name='339'>
<font color=#447700>!-----------------------------------------------------------------------<a name='340'></font>
<font color=#447700>!<a name='341'></font>
<font color=#447700>!***  COMPUTE THESE STARTING AND STOPPING LOCATIONS FOR EACH TILE AND<a name='342'></font>
<font color=#447700>!***  NUMBER OF TILES.<a name='343'></font>
<font color=#447700>!***  SEE: http://www.mmm.ucar.edu/wrf/WG2/topics/settiles<a name='344'></font>
<font color=#447700>!<a name='345'></font>
      CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>SET_TILES</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_9">(GRID,IDS,IDE,JDS,JDE,IPS,IPE,JPS,JPE)<a name='346'>
<font color=#447700>!<a name='347'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='348'></font>
<font color=#447700>!***  SET FLAG FOR NAM, HRW, or HWRF (Ferrier-based) microphysics<a name='349'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='350'></font>
<font color=#447700>!<a name='351'></font>
      ETAMP_PHYSICS=.FALSE.<a name='352'>
<font color=#447700>!<a name='353'></font>
      IF (CONFIG_FLAGS%MP_PHYSICS == ETAMPNEW .OR.                 &amp;<a name='354'>
     &amp;    CONFIG_FLAGS%MP_PHYSICS == FER_MP_HIRES .OR.                 &amp;<a name='355'>
     &amp;    CONFIG_FLAGS%MP_PHYSICS == ETAMP_HWRF ) THEN<a name='356'>
<font color=#447700>!<a name='357'></font>
         ETAMP_PHYSICS=.TRUE.<a name='358'>
<font color=#447700>!<a name='359'></font>
      ENDIF<a name='360'>
<a name='361'>
      ADVECT_Q2=.TRUE.<a name='362'>
      if(CONFIG_FLAGS%BL_PBL_PHYSICS == GFSSCHEME .OR. &amp;<a name='363'>
         CONFIG_FLAGS%BL_PBL_PHYSICS == GFSEDMFSCHEME) THEN<a name='364'>
         ADVECT_Q2=.FALSE.<a name='365'>
      endif<a name='366'>
<a name='367'>
<font color=#447700>!<a name='368'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='369'></font>
<font color=#447700>!***  SET FLAG FOR THE OPERATIONAL PHYSICS SUITE.<a name='370'></font>
<font color=#447700>!***  THIS WILL BE USED TO SAVE CLOCKTIME BY SKIPPING<a name='371'></font>
<font color=#447700>!***  FREQUENT UPDATES OF THE MOIST ARRAY AND INSTEAD<a name='372'></font>
<font color=#447700>!***  UPDATE IT ONLY WHEN IT IS NEEDED FOR PHYSICS.<a name='373'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='374'></font>
<font color=#447700>!<a name='375'></font>
      OPERATIONAL_PHYSICS=.FALSE.<a name='376'>
<font color=#447700>!<a name='377'></font>
      IF(CONFIG_FLAGS%RA_SW_PHYSICS    ==GFDLSWSCHEME.AND.              &amp;<a name='378'>
     &amp;   CONFIG_FLAGS%RA_LW_PHYSICS    ==GFDLLWSCHEME.AND.              &amp;<a name='379'>
     &amp;   CONFIG_FLAGS%SF_SFCLAY_PHYSICS==MYJSFCSCHEME.AND.              &amp;<a name='380'>
     &amp;   CONFIG_FLAGS%BL_PBL_PHYSICS   ==MYJPBLSCHEME.AND.              &amp;<a name='381'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS       ==BMJSCHEME.AND.                 &amp;<a name='382'>
     &amp;   ETAMP_PHYSICS ) THEN<a name='383'>
<a name='384'>
<font color=#447700>!<a name='385'></font>
        OPERATIONAL_PHYSICS=.TRUE.<a name='386'>
<font color=#447700>!<a name='387'></font>
      ENDIF<a name='388'>
<font color=#447700>!<a name='389'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='390'></font>
<font color=#447700>!<a name='391'></font>
<font color=#447700>!***  TTEN, QTEN are used by GD convection scheme<a name='392'></font>
<font color=#447700>!<a name='393'></font>
      ALLOCATE(TTEN(IMS:IME,KMS:KME,JMS:JME),STAT=ISTAT)<a name='394'>
      ALLOCATE(QTEN(IMS:IME,KMS:KME,JMS:JME),STAT=ISTAT)<a name='395'>
      ALLOCATE(RTHBLTEN(IMS:IME,KMS:KME,JMS:JME),STAT=ISTAT)<a name='396'>
      ALLOCATE(RQVBLTEN(IMS:IME,KMS:KME,JMS:JME),STAT=ISTAT)<a name='397'>
      ALLOCATE(RTHRATEN(IMS:IME,KMS:KME,JMS:JME),STAT=ISTAT)<a name='398'>
<font color=#447700>!<a name='399'></font>
        IF(CONFIG_FLAGS%CU_PHYSICS==GDSCHEME.OR.                        &amp;<a name='400'>
     &amp;  CONFIG_FLAGS%CU_PHYSICS==TIEDTKESCHEME.OR.                      &amp;<a name='401'>
     &amp;  CONFIG_FLAGS%CU_PHYSICS==KFETASCHEME)THEN<a name='402'>
<a name='403'>
        DO J=JMS,JME<a name='404'>
        DO K=KMS,KME<a name='405'>
        DO I=IMS,IME<a name='406'>
          TTEN(I,K,J)=grid%t(I,J,K)<a name='407'>
          QTEN(I,K,J)=grid%q(I,J,K)<a name='408'>
        ENDDO<a name='409'>
        ENDDO<a name='410'>
        ENDDO<a name='411'>
      ENDIF<a name='412'>
<font color=#447700>!<a name='413'></font>
      GRID%SIGMA=1 <a name='414'>
<a name='415'>
      IF (config_flags%non_hydrostatic) THEN<a name='416'>
        grid%hydro=.FALSE.<a name='417'>
      ELSE<a name='418'>
        grid%hydro=.TRUE.<a name='419'>
      ENDIF<a name='420'>
<font color=#447700>!<a name='421'></font>
      IDF=IDE-1<a name='422'>
      JDF=JDE-1<a name='423'>
      KDF=KDE-1<a name='424'>
<font color=#447700>!<a name='425'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='426'></font>
<font color=#447700>!<a name='427'></font>
<font color=#447700>!***  FOR NOW SET CONTROLS FOR TILES TO PATCHES<a name='428'></font>
<font color=#447700>!<a name='429'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='430'></font>
      ITS=IPS<a name='431'>
      ITE=MIN(IPE,IDF)<a name='432'>
      JTS=JPS<a name='433'>
      JTE=MIN(JPE,JDF)<a name='434'>
      KTS=KPS<a name='435'>
      KTE=MIN(KPE,KDF)<a name='436'>
<font color=#447700>!-----------------------------------------------------------------------<a name='437'></font>
<font color=#447700>!<a name='438'></font>
      if(grid%ntsd==0)then<a name='439'>
        write(message,*)' its=',its,' ite=',ite<a name='440'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_195">(trim(message))<a name='441'>
        write(message,*)' jts=',jts,' jte=',jte<a name='442'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_196">(trim(message))<a name='443'>
        write(message,*)' kts=',kts,' kte=',kte<a name='444'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_197">(trim(message))<a name='445'>
<font color=#447700>!<a name='446'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='447'></font>
      endif<a name='448'>
<font color=#447700>!-----------------------------------------------------------------------<a name='449'></font>
<font color=#447700>!***  SET TIMING VARIABLES TO ZERO AT START OF FORECAST.<a name='450'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='451'></font>
      if(grid%ntsd==0)then<a name='452'>
        sum_tim=0.<a name='453'>
        solve_tim=0.<a name='454'>
        exch_tim=0.<a name='455'>
        pdte_tim=0.<a name='456'>
        adve_tim=0.<a name='457'>
        vtoa_tim=0.<a name='458'>
        vadz_tim=0.<a name='459'>
        hadz_tim=0.<a name='460'>
        eps_tim=0.<a name='461'>
        vad2_tim=0.<a name='462'>
        had2_tim=0.<a name='463'>
        radiation_tim=0.<a name='464'>
        rdtemp_tim=0.<a name='465'>
        turbl_tim=0.<a name='466'>
        cltend_tim=0.<a name='467'>
        cucnvc_tim=0.<a name='468'>
        gsmdrive_tim=0.<a name='469'>
        hdiff_tim=0.<a name='470'>
        bocoh_tim=0.<a name='471'>
        pfdht_tim=0.<a name='472'>
        ddamp_tim=0.<a name='473'>
        bocov_tim=0.<a name='474'>
        uv_htov_tim=0.<a name='475'>
        exch_tim_max=0.<a name='476'>
        adjppt_tim=0.<a name='477'>
        diag_tim=0.<a name='478'>
        tornado_tim=0.<a name='479'>
#if ( HWRF == 1 )<a name='480'>
        sst_tim=0.<a name='481'>
        cplstep_tim=0.<a name='482'>
        wav_tim=0.<a name='483'>
        flux_tim=0.<a name='484'>
        hifreq_tim=0.<a name='485'>
#endif<a name='486'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='487'>
        previmbal_tim=0.<a name='488'>
        loadimbal_tim=0.<a name='489'>
        call nmm_get_cpu(cpu,ierr)<a name='490'>
#endif<a name='491'>
      endif<a name='492'>
<font color=#447700>!-----------------------------------------------------------------------<a name='493'></font>
      N_MOIST=NUM_MOIST<a name='494'>
<a name='495'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='496'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_1">(previmbal_tim,'top of solve_nmm')<a name='497'>
      call nmm_get_cpu(newcpu,ierr)<a name='498'>
      if(cpu/=newcpu) then<a name='499'>
3011     format('warning: CPU changed from ',I0,' to ',I0)<a name='500'>
         write(message,3011) cpu,newcpu<a name='501'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_198">(message)<a name='502'>
         cpu=newcpu<a name='503'>
      endif<a name='504'>
#endif<a name='505'>
<font color=#447700>!<a name='506'></font>
      DO J=MYJS_P4,MYJE_P4<a name='507'>
        grid%iheg(J)=MOD(J+1,2)<a name='508'>
        grid%ihwg(J)=grid%iheg(J)-1<a name='509'>
        grid%iveg(J)=MOD(J,2)<a name='510'>
        grid%ivwg(J)=grid%iveg(J)-1<a name='511'>
      ENDDO<a name='512'>
<a name='513'>
      DO J=MYJS_P4,MYJE_P4<a name='514'>
        grid%ivw(J)=grid%ivwg(J)<a name='515'>
        grid%ive(J)=grid%iveg(J)<a name='516'>
        grid%ihe(J)=grid%iheg(J)<a name='517'>
        grid%ihw(J)=grid%ihwg(J)<a name='518'>
      ENDDO<a name='519'>
<font color=#447700>!<a name='520'></font>
<font color=#447700>!***  LATERAL POINTS IN THE BOUNDARY ARRAYS<a name='521'></font>
<font color=#447700>!<a name='522'></font>
      LB=2*(IDF-IDS+1)+(JDF-JDS+1)-3<a name='523'>
<font color=#447700>!<a name='524'></font>
<font color=#447700>!***  APPROXIMATE GRIDPOINT SPACING (METERS)<a name='525'></font>
<font color=#447700>!<a name='526'></font>
      JC=jps+(jpe-jps)/2<a name='527'>
      GPS=SQRT(grid%dx_nmm(ips,JC)**2+grid%dy_nmm**2)<a name='528'>
<font color=#447700>!<a name='529'></font>
<font color=#447700>!***  TIMESTEPS PER HOUR<a name='530'></font>
<font color=#447700>!<a name='531'></font>
      TSPH=3600./GRID%DT<a name='532'>
<font color=#447700>!<a name='533'></font>
      n_print_time=nint(3600./grid%dt)   <font color=#447700>! Print stats once per hour<a name='534'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='535'></font>
<font color=#447700>!<a name='536'></font>
      NBOCO=0<a name='537'>
<font color=#447700>!<a name='538'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='539'></font>
<font color=#447700>!<a name='540'></font>
#if (NMM_NEST == 1)<a name='541'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='542'></font>
<font color=#447700>!***  PATCHING NESTED BOUNDARIES.<a name='543'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='544'></font>
<font color=#447700>!<a name='545'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_124"> ( 100 , 'nmm: in patch' )<a name='546'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='547'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_2">(loadimbal_tim,'after alloc and init')<a name='548'>
#endif<a name='549'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_2">()<a name='550'>
<font color=#447700>!#ifdef DM_PARALLEL<a name='551'></font>
<font color=#447700>!#    include "HALO_NMM_ZZ.inc"<a name='552'></font>
<font color=#447700>!#endif<a name='553'></font>
<a name='554'>
      IF(GRID%ID/=1)THEN<a name='555'>
<font color=#447700>!<a name='556'></font>
#ifdef MOVE_NESTS<a name='557'>
<a name='558'>
        IF(GRID%ID/=1.AND.MOD(grid%ntsd,1)==0.AND.GRID%NUM_MOVES==-99)THEN<a name='559'>
          grid%XLOC_1=(IDE-1)/2     <font color=#447700>! This maneuvers the storm to the center of the nest quickly<a name='560'></font>
          grid%YLOC_1=(JDE-1)/2     <font color=#447700>! This maneuvers the storm to the center of the nest quickly<a name='561'></font>
        ENDIF<a name='562'>
<a name='563'>
        <font color=#447700>! If we have any nests, check to see if they moved so we know<a name='564'></font>
        <font color=#447700>! if we need to update the nest-centric area of interest:<a name='565'></font>
        IF(grid%ntsd&gt;1 .and. MOD(grid%ntsd,grid%nphs)==0) THEN<a name='566'>
           grid%update_interest = grid%update_interest .or. &amp;<a name='567'>
                check_for_kid_move(grid,config_flags)<a name='568'>
        ENDIF<a name='569'>
<a name='570'>
#endif<a name='571'>
<a name='572'>
      ENDIF<a name='573'>
#endif<a name='574'>
<font color=#447700>!<a name='575'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='576'></font>
<font color=#447700>!***  ALLOCATE PPTDAT ARRAY (PRECIP ASSIM):<a name='577'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='578'></font>
<font color=#447700>!<a name='579'></font>
      IF(GRID%PCPFLG.AND..NOT.ALLOCATED(PPTDAT))THEN<a name='580'>
        ALLOCATE(PPTDAT(IMS:IME,JMS:JME,3),STAT=ISTAT)<a name='581'>
      ENDIF<a name='582'>
<font color=#447700>!<a name='583'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='584'></font>
<font color=#447700>!***<a name='585'></font>
<font color=#447700>!***      Call READPCP to<a name='586'></font>
<font color=#447700>!***            1) READ IN PRECIPITATION FOR HOURS 1, 2 and 3;<a name='587'></font>
<font color=#447700>!***            2) Initialize grid%ddata to 999. (this is the amount<a name='588'></font>
<font color=#447700>!***               of input precip allocated to each physics time step<a name='589'></font>
<font color=#447700>!***               in ADJPPT; TURBL/SURFCE, which uses grid%ddata, is called<a name='590'></font>
<font color=#447700>!***               before ADJPPT)<a name='591'></font>
<font color=#447700>!***            3) Initialize grid%lspa to zero<a name='592'></font>
<font color=#447700>!***<a name='593'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='594'></font>
<a name='595'>
      IF (grid%ntsd==0) THEN<a name='596'>
        IF (GRID%PCPFLG) THEN<a name='597'>
          CALL <A href='../../html_code/dyn_nmm/module_PRECIP_ADJUST.F.html#READPCP'>READPCP</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READPCP_1">(PPTDAT,grid%ddata,grid%lspa                                &amp;<a name='598'>
     &amp;      ,IDS,IDE,JDS,JDE,KDS,KDE                                    &amp;<a name='599'>
     &amp;      ,IMS,IME,JMS,JME,KMS,KME                                    &amp;<a name='600'>
     &amp;      ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='601'>
        ENDIF<a name='602'>
      ENDIF<a name='603'>
<font color=#447700>!-----------------------------------------------------------------------<a name='604'></font>
<font color=#447700>!<a name='605'></font>
<font color=#447700>!<a name='606'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='607'></font>
<font color=#447700>!***  UPDATE RANDOM NUMBERS IF REQUIRED<a name='608'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='609'></font>
<a name='610'>
      randif: IF(in_use_for_config(grid%id,'random')) THEN<a name='611'>
<font color=#447700>!<a name='612'></font>
         nrand=config_flags%nrand<a name='613'>
         if(nrand==0) nrand=grid%ncnvc<a name='614'>
         if(nrand==0) nrand=1<a name='615'>
         IDT=MOD(grid%NTSD,nrand)<a name='616'>
 <a name='617'>
         IF(IDT.EQ.0 .OR. grid%NTSD .EQ. 0)THEN<a name='618'>
            call <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_2"><a name='619'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_199">('Update random numbers...')<a name='620'>
            one=1<a name='621'>
<a name='622'>
            imid=(its+ite)/2   ;   jmid=(jts+jte)/2<a name='623'>
<a name='624'>
            write(message,'(A,": random(",I0,",",I0,") = ",E15.10)') 'before call',imid,jmid,grid%random(imid,jmid)<a name='625'>
            call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_125">(3,message)<a name='626'>
<a name='627'>
            call <A href='../../html_code/share/module_random.F.html#RAND_GRID_R4'>rand_grid_r4</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RAND_GRID_R4_1">(grid%randstate1,grid%randstate2, &amp;<a name='628'>
                              grid%randstate3,grid%randstate4, &amp;<a name='629'>
                              grid%random, &amp;<a name='630'>
                              IDS,IDE,JDS,JDE,one,one, &amp;<a name='631'>
                              IMS,IME,JMS,JME,one,one, &amp;<a name='632'>
                              ITS,ITE,JTS,JTE,one,one)<a name='633'>
<a name='634'>
            write(message,'(A,": random(",I0,",",I0,") = ",E15.10)') 'after call',imid,jmid,grid%random(imid,jmid)<a name='635'>
            call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_126">(3,message)<a name='636'>
<a name='637'>
            call <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_2">('Updating random numbers')<a name='638'>
         ENDIF    <font color=#447700>! for IF(IDT.EQ.0 .OR. NTSD .EQ. 0)<a name='639'></font>
      ENDIF randif<a name='640'>
<font color=#447700>!-----------------------------------------------------------------------<a name='641'></font>
<font color=#447700>!***  RESET TORNADO GENESIS ACCUMULATORS WHEN NEEDED.<a name='642'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='643'></font>
     IF(grid%tg_want_reset/=0) THEN<a name='644'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_3">()<a name='645'>
        CALL <A href='../../html_code/dyn_nmm/module_tornado_genesis.F.html#RESET_TORNADO_GENESIS'>RESET_TORNADO_GENESIS</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RESET_TORNADO_GENESIS_1">(GRID,CONFIG_FLAGS)<a name='646'>
        tornado_tim=tornado_tim+now_time()-btimx<a name='647'>
     ENDIF<a name='648'>
<font color=#447700>!-----------------------------------------------------------------------<a name='649'></font>
<font color=#447700>!***  UPDATE AREA OF INTEREST<a name='650'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='651'></font>
#if ( HWRF == 1 )<a name='652'>
     if(size(grid%precip_swath)&gt;1 .and. grid%update_interest) then<a name='653'>
        call <A href='../../html_code/dyn_nmm/module_swath.F.html#UPDATE_INTEREST'>update_interest</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_INTEREST_1">(grid,config_flags)<a name='654'>
        grid%update_interest=.false.<a name='655'>
     endif<a name='656'>
#endif<a name='657'>
<font color=#447700>!-----------------------------------------------------------------------<a name='658'></font>
<font color=#447700>!***  ZERO OUT ACCUMULATED QUANTITIES WHEN NEEDED.<a name='659'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='660'></font>
<font color=#447700>!<a name='661'></font>
      CALL <A href='../../html_code/dyn_nmm/BUCKETS.F.html#BUCKETS'>BUCKETS</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BUCKETS_1">(grid%ntsd,grid%nprec,grid%nsrfc,grid%nrdsw,grid%nrdlw                         &amp;<a name='662'>
     &amp;            ,GRID%RESTART,GRID%TSTART                             &amp;<a name='663'>
     &amp;            ,grid%nclod,grid%nheat,GRID%NPHS,TSPH                           &amp;<a name='664'>
     &amp;            ,grid%acprec,grid%cuprec,grid%acsnow,grid%acsnom,grid%ssroff,grid%bgroff            &amp;<a name='665'>
     &amp;            ,grid%sfcevp,grid%potevp,grid%sfcshx,grid%sfclhx,grid%subshx,grid%snopcx            &amp;<a name='666'>
     &amp;            ,grid%sfcuvx,grid%potflx                                        &amp;<a name='667'>
     &amp;            ,grid%ardsw,grid%aswin,grid%aswout,grid%aswtoa                            &amp;<a name='668'>
     &amp;            ,grid%ardlw,grid%alwin,grid%alwout,grid%alwtoa                            &amp;<a name='669'>
     &amp;            ,grid%acfrst,grid%ncfrst,grid%acfrcv,grid%ncfrcv                          &amp;<a name='670'>
     &amp;            ,grid%avcnvc,grid%avrain,grid%tcucn,grid%train                            &amp;<a name='671'>
     &amp;            ,grid%asrfc                                                &amp;<a name='672'>
     &amp;            ,grid%t,grid%tlmax,grid%tlmin,grid%tshltr,grid%pshltr,grid%qshltr                   &amp;<a name='673'>
     &amp;            ,grid%t02_max,grid%t02_min,grid%rh02_max,grid%rh02_min                    &amp;<a name='674'>
     &amp;            ,IDS,IDE,JDS,JDE,KDS,KDE                              &amp;<a name='675'>
     &amp;            ,IMS,IME,JMS,JME,KMS,KME                              &amp;<a name='676'>
     &amp;            ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='677'>
<font color=#447700>!-----------------------------------------------------------------------<a name='678'></font>
<font color=#447700>!<a name='679'></font>
<font color=#447700>!!#if ( HWRF == 1 )<a name='680'></font>
<font color=#447700>!!!zhang<a name='681'></font>
<font color=#447700>!!      IF(NTSD_current==0)THEN<a name='682'></font>
<font color=#447700>!!#else<a name='683'></font>
      IF(grid%ntsd==0)THEN<a name='684'>
<font color=#447700>!!#endif<a name='685'></font>
        FIRST=.TRUE.<a name='686'>
<font color=#447700>!       call hpm_init()<a name='687'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='688'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_3">(loadimbal_tim,'before halo &amp; init stuff')<a name='689'>
#endif<a name='690'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_4">()<a name='691'>
<font color=#447700>!emc_2010_bugfix_h50<a name='692'></font>
        grid%mommix=amin1(grid%mommix,1.0)<a name='693'>
<font color=#447700>!emc_2010_bugfix_h50<a name='694'></font>
<font color=#447700>!<a name='695'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='696'></font>
<font color=#447700>!***  FIRST STEP INITIALIZATION OF PASSIVE SUBSTANCE VARIABLES<a name='697'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='698'></font>
<font color=#447700>!<a name='699'></font>
      IF(EULER) THEN<a name='700'>
        SUMDRRW=0.<a name='701'>
<font color=#447700>!<a name='702'></font>
        DO K=KTS,KTE<a name='703'>
          DO J=JMS,JME<a name='704'>
            DO I=IMS,IME<a name='705'>
              grid%rrw(I,J,K)=0.<a name='706'>
<font color=#447700>!<a name='707'></font>
              IF(I&gt;=IDE/2-6.AND.I&lt;=IDE/2+6.AND.   &amp;<a name='708'>
                 J&gt;=JDE/2-6.AND.J&lt;=JDE/2+6     ) THEN<a name='709'>
                grid%rrw(I,J,K)=10.0 <font color=#447700>!youhua<a name='710'></font>
<font color=#447700>!               grid%rrw(I,J,K)=0.9  !zj<a name='711'></font>
              ENDIF<a name='712'>
<font color=#447700>!<a name='713'></font>
            ENDDO<a name='714'>
          ENDDO<a name='715'>
        ENDDO<a name='716'>
<font color=#447700>!<a name='717'></font>
        DO KS=PARAM_FIRST_SCALAR,NUM_SZJ<a name='718'>
          DO K=KMS,KME<a name='719'>
            DO J=JMS,JME<a name='720'>
              DO I=IMS,IME<a name='721'>
                SZJ(I,J,K,KS)=0.<a name='722'>
                S1Z(I,J,K,KS)=0.<a name='723'>
                SPZ(I,J,K,KS)=0.<a name='724'>
                TCS(I,J,K,KS)=0.<a name='725'>
              ENDDO<a name='726'>
            ENDDO<a name='727'>
          ENDDO<a name='728'>
        ENDDO<a name='729'>
<font color=#447700>!<a name='730'></font>
      ENDIF<a name='731'>
<font color=#447700>!<a name='732'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='733'></font>
<font color=#447700>!<a name='734'></font>
<font color=#447700>!!#ifdef DM_PARALLEL<a name='735'></font>
<font color=#447700>!!#    include "HALO_NMM_A.inc"<a name='736'></font>
<font color=#447700>!!#endif<a name='737'></font>
<font color=#447700>!<a name='738'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='739'></font>
<font color=#447700>!!#ifdef DM_PARALLEL<a name='740'></font>
<font color=#447700>!!      IF (.NOT.ETAMP_PHYSICS) THEN<a name='741'></font>
<font color=#447700>!!#    include "HALO_NMM_A_3.inc"<a name='742'></font>
<font color=#447700>!!      ENDIF<a name='743'></font>
<font color=#447700>!!#endif<a name='744'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='745'></font>
<font color=#447700>!***  FIRST STEP INITIALIZATION OF PASSIVE SUBSTANCE VARIABLES<a name='746'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='747'></font>
<font color=#447700>!<a name='748'></font>
      IF(EULER) THEN<a name='749'>
<font color=#447700>!<a name='750'></font>
        DO K=KTS,KTE<a name='751'>
          DO J=JMS,JME<a name='752'>
            DO I=IMS,IME<a name='753'>
              SPZ(I,J,K,P_SPZ1)=SQRT(MAX(grid%q  (I,J,K),EPSQ))<a name='754'>
              SPZ(I,J,K,P_SPZ2)=SQRT(MAX(grid%cwm(I,J,K),EPSQ))<a name='755'>
              SPZ(I,J,K,P_SPZ4)=SQRT(MAX(grid%rrw(I,J,K),0.  ))<a name='756'>
            ENDDO<a name='757'>
          ENDDO<a name='758'>
        ENDDO<a name='759'>
<font color=#447700>!<a name='760'></font>
        DO J=JMS,JME<a name='761'>
          DO I=IMS,IME<a name='762'>
            SPZ(I,J,KTE,P_SPZ3)=SQRT(MAX((grid%q2(I,J,KTE)+EPSQ2)*0.5,EPSQ2))<a name='763'>
          ENDDO<a name='764'>
        ENDDO<a name='765'>
<font color=#447700>!<a name='766'></font>
        DO K=KTE-1,KTS,-1<a name='767'>
          DO J=JMS,JME<a name='768'>
            DO I=IMS,IME<a name='769'>
              SPZ(I,J,K,P_SPZ3)=SQRT(MAX((grid%q2(I,J,K)+grid%q2(I,J,K+1))*0.5,EPSQ2))<a name='770'>
            ENDDO<a name='771'>
          ENDDO<a name='772'>
        ENDDO<a name='773'>
<font color=#447700>!<a name='774'></font>
      ENDIF<a name='775'>
<font color=#447700>!<a name='776'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='777'></font>
<font color=#447700>!***  USE THE FOLLOWING VARIABLES TO KEEP TRACK OF EXCHANGE TIMES.<a name='778'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='779'></font>
        exch_tim=exch_tim+now_time()-btimx<a name='780'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='781'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_4">(loadimbal_tim,'after halo and init stuff')<a name='782'>
#endif<a name='783'>
<font color=#447700>!       this_tim=now_time()-btimx<a name='784'></font>
<font color=#447700>!       call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max           &amp;<a name='785'></font>
<font color=#447700>!    &amp;                    ,mpi_comm_comp,irtn)<a name='786'></font>
<font color=#447700>!       exch_tim_max=exch_tim_max+et_max<a name='787'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='788'></font>
<font color=#447700>!<a name='789'></font>
#if ( HWRF == 1 )<a name='790'>
<font color=#447700>!zhang's doing<a name='791'></font>
       if(GRID%RESTART) then<a name='792'>
       FIRST=.FALSE.<a name='793'>
       else<a name='794'>
       GO TO 2003<a name='795'>
       endif<a name='796'>
<font color=#447700>!end of zhang's doing<a name='797'></font>
#else<a name='798'>
        GO TO 2003<a name='799'>
#endif<a name='800'>
      ENDIF<a name='801'>
<font color=#447700>!<a name='802'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='803'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='804'></font>
 2000 CONTINUE<a name='805'>
<font color=#447700>!-----------------------------------------------------------------------<a name='806'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='807'></font>
#if ( HWRF == 1 )<a name='808'>
      CALL nl_get_multi_storm(1,multi_storm)<a name='809'>
      CALL nl_get_no_ocean(1,no_ocean)<a name='810'>
      IF ( .NOT. multi_storm .OR. no_ocean) THEN<a name='811'>
        write(message,*)' No Ocean Coupling Run'<a name='812'>
        call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_127">(1,trim(message))<a name='813'>
<font color=#447700>! Coupling insertion:-&gt;<a name='814'></font>
      ELSE<a name='815'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_5">()<a name='816'>
        call ATM_TSTEP_INIT(NTSD_current,grid%NPHS,GRID%ID,grid%NPHS*grid%dt, &amp;<a name='817'>
        ids,idf,jds,jdf,its,ite,jts,jte,ims,ime,jms,jme,           &amp;<a name='818'>
                         kds,kde,kts,kte,kms,kme,                  &amp;<a name='819'>
                         grid%HLON,grid%HLAT,grid%VLON,grid%VLAT,grid%sm,                   &amp;<a name='820'>
                         grid%i_parent_start,grid%j_parent_start,  &amp;<a name='821'>
                         grid%guessdtc,grid%dtc)<a name='822'>
        cplstep_tim=cplstep_tim+now_time()-btimx<a name='823'>
      ENDIF<a name='824'>
<font color=#447700>!&lt;-:coupling insertion<a name='825'></font>
<font color=#447700>!<a name='826'></font>
<a name='827'>
#endif<a name='828'>
<font color=#447700>!-----------------------------------------------------------------------<a name='829'></font>
<font color=#447700>!***  PRESSURE TENDENCY, SIGMA DOT, VERTICAL PART OF OMEGA-ALPHA<a name='830'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='831'></font>
<font color=#447700>!<a name='832'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='833'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_5">(loadimbal_tim,'after atm_tstep_init')<a name='834'>
#endif<a name='835'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_6">()<a name='836'>
<font color=#447700>!-----------------<a name='837'></font>
<font color=#447700>!!#ifdef DM_PARALLEL<a name='838'></font>
<font color=#447700>!!#    include "HALO_NMM_D.inc"<a name='839'></font>
<font color=#447700>!!#endif<a name='840'></font>
<font color=#447700>!-----------------<a name='841'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='842'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='843'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_6">(loadimbal_tim,'after halo d')<a name='844'>
#endif<a name='845'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='846'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max             &amp;<a name='847'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='848'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='849'></font>
<font color=#447700>!<a name='850'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_7">()<a name='851'>
<font color=#447700>!<a name='852'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_1">(grid,config_flags,'before PDTE', &amp;<a name='853'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='854'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='855'>
            its,ite,jts,jte,kts,kte)<a name='856'>
      CALL <A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PDTE'>PDTE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PDTE_1">(                                                        &amp;<a name='857'>
#ifdef DM_PARALLEL<a name='858'>
     &amp;            GRID,MYPE,MPI_COMM_COMP,                              &amp;<a name='859'>
#endif<a name='860'>
     &amp;            grid%ntsd,GRID%DT,grid%pt,grid%eta2,grid%res,grid%hydro,grid%hbm2                   &amp;<a name='861'>
     &amp;           ,grid%pd,grid%pdsl,grid%pdslo                                         &amp;<a name='862'>
     &amp;           ,grid%petdt,grid%div,grid%psdt                                        &amp;<a name='863'>
     &amp;           ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                       &amp;<a name='864'>
     &amp;           ,IDS,IDF,JDS,JDF,KDS,KDE                               &amp;<a name='865'>
     &amp;           ,IMS,IME,JMS,JME,KMS,KME                               &amp;<a name='866'>
     &amp;           ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='867'>
<a name='868'>
<a name='869'>
      pdte_tim=pdte_tim+now_time()-btimx<a name='870'>
<font color=#447700>!<a name='871'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='872'></font>
<font color=#447700>!***  ADVECTION OF grid%t, grid%u, AND grid%v<a name='873'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='874'></font>
<font color=#447700>!<a name='875'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='876'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_7">(loadimbal_tim,'after pdte')<a name='877'>
#endif<a name='878'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_8">()<a name='879'>
<font color=#447700>!-----------------<a name='880'></font>
#ifdef DM_PARALLEL<a name='881'>
#    include "<A href='../../html_code/include/HALO_NMM_F.inc.html'>HALO_NMM_F.inc</A>"<A NAME="HALO_NMM_F.inc_6"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='882'>
#    include "<A href='../../html_code/include/HALO_NMM_F1.inc.html'>HALO_NMM_F1.inc</A>"<A NAME="HALO_NMM_F1.inc_7"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='883'>
#endif<a name='884'>
<font color=#447700>!-----------------<a name='885'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='886'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='887'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_8">(loadimbal_tim,'after halo F &amp; F1')<a name='888'>
#endif<a name='889'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='890'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max             &amp;<a name='891'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='892'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='893'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_9">()<a name='894'>
<font color=#447700>!<a name='895'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_2">(grid,config_flags,'before ADVE', &amp;<a name='896'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='897'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='898'>
            its,ite,jts,jte,kts,kte)<a name='899'>
      CALL <A href='../../html_code/include/adve_orig.h.html#ADVE'>ADVE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVE_1">(grid%ntsd,GRID%DT,grid%deta1,grid%deta2,grid%pdtop                          &amp;<a name='900'>
     &amp;         ,grid%curv,grid%f,grid%fad,grid%f4d,grid%em_loc,grid%emt_loc,grid%en,grid%ent,grid%dx_nmm,grid%dy_nmm      &amp;<a name='901'>
     &amp;         ,grid%hbm2,grid%vbm2                                               &amp;<a name='902'>
     &amp;         ,grid%t,grid%u,grid%v,grid%pdslo,grid%told,grid%uold,grid%vold                              &amp;<a name='903'>
     &amp;         ,grid%petdt,grid%upstrm                                            &amp;<a name='904'>
     &amp;         ,grid%few,grid%fns,grid%fne,grid%fse                                         &amp;<a name='905'>
     &amp;         ,grid%adt,grid%adu,grid%adv                                             &amp; <a name='906'>
     &amp;         ,grid%n_iup_h,grid%n_iup_v                                         &amp;<a name='907'>
     &amp;         ,grid%n_iup_adh,grid%n_iup_adv                                     &amp;<a name='908'>
     &amp;         ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                             &amp;<a name='909'>
     &amp;         ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                         &amp;<a name='910'>
     &amp;         ,IDS,IDF,JDS,JDF,KDS,KDE                                 &amp;<a name='911'>
     &amp;         ,IMS,IME,JMS,JME,KMS,KME                                 &amp;<a name='912'>
     &amp;         ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='913'>
<font color=#447700>!<a name='914'></font>
      adve_tim=adve_tim+now_time()-btimx<a name='915'>
<font color=#447700>!<a name='916'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='917'></font>
<font color=#447700>!***  PASSIVE SUBSTANCE WORKING PART<a name='918'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='919'></font>
<font color=#447700>!<a name='920'></font>
      eulerian: IF(EULER) THEN    <font color=#447700>! Eulerian advection for model tracers<a name='921'></font>
<font color=#447700>!<a name='922'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='923'></font>
<font color=#447700>!<a name='924'></font>
<font color=#447700>!mp - allow for it to be applied in the no-physics realm<a name='925'></font>
        IF(.NOT.ETAMP_PHYSICS.and.CONFIG_FLAGS%MP_PHYSICS/=0) THEN<a name='926'>
          WRITE( wrf_err_message , * ) 'EULER advection works only with ETAMPNEW microphysics.'<a name='927'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_138"> ( wrf_err_message )<a name='928'>
        ENDIF<a name='929'>
<font color=#447700>!<a name='930'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='931'></font>
        idtadt_block: IF(MOD(grid%ntsd,IDTADT)==0) THEN<a name='932'>
<font color=#447700>!-----------------------------------------------------------------------<a name='933'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='934'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_9">(loadimbal_tim,'after adve')<a name='935'>
#endif<a name='936'>
          btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_10">()<a name='937'>
<font color=#447700>!!#ifdef DM_PARALLEL<a name='938'></font>
<font color=#447700>!!#    include "HALO_NMM_I.inc"<a name='939'></font>
<font color=#447700>!!#endif<a name='940'></font>
          exch_tim=exch_tim+now_time()-btimx<a name='941'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='942'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_10">(loadimbal_tim,'after halo I')<a name='943'>
#endif<a name='944'>
<font color=#447700>!<a name='945'></font>
          btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_11">()<a name='946'>
<font color=#447700>!<a name='947'></font>
          DO K=KTS,KTE<a name='948'>
            DO J=JMS,JME<a name='949'>
              DO I=IMS,IME<a name='950'>
                SZJ(I,J,K,P_SPZ1)=MAX(grid%q  (I,J,K),EPSQ)<a name='951'>
                SZJ(I,J,K,P_SPZ2)=MAX(grid%cwm(I,J,K),EPSQ)<a name='952'>
                SZJ(I,J,K,P_SPZ4)=MAX(grid%rrw(I,J,K),0.  )<a name='953'>
              ENDDO<a name='954'>
            ENDDO<a name='955'>
          ENDDO<a name='956'>
<font color=#447700>!<a name='957'></font>
          DO J=JMS,JME<a name='958'>
            DO I=IMS,IME<a name='959'>
              SZJ(I,J,KTE,P_SPZ3)=MAX((grid%q2 (I,J,KTE)+EPSQ2)*0.5,EPSQ2)<a name='960'>
            ENDDO<a name='961'>
          ENDDO<a name='962'>
<font color=#447700>!<a name='963'></font>
          DO K=KTE-1,KTS,-1<a name='964'>
            DO J=JMS,JME<a name='965'>
              DO I=IMS,IME<a name='966'>
                SZJ(I,J,K,P_SPZ3)=MAX((grid%q2 (I,J,K)+grid%q2 (I,J,K+1))*0.5,EPSQ2)<a name='967'>
              ENDDO<a name='968'>
            ENDDO<a name='969'>
          ENDDO<a name='970'>
<font color=#447700>!<a name='971'></font>
#ifdef DM_PARALLEL<a name='972'>
#    include "<A href='../../html_code/include/HALO_TRACERS.inc.html'>HALO_TRACERS.inc</A>"<A NAME="HALO_TRACERS.inc_8"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='973'>
#endif<a name='974'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_3">(grid,config_flags,'before ADV2', &amp;<a name='975'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='976'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='977'>
            its,ite,jts,jte,kts,kte)<a name='978'>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#ADV2'>ADV2</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADV2_1">                &amp;<a name='979'>
          (grid%upstrm                  &amp;<a name='980'>
          ,MYPE,PARAM_FIRST_SCALAR,NUM_SZJ &amp;<a name='981'>
          ,IDS,IDE,JDS,JDE,KDS,KDE &amp;<a name='982'>
          ,IMS,IME,JMS,JME,KMS,KME &amp;<a name='983'>
          ,ITS,ITE,JTS,JTE,KTS,KTE &amp;<a name='984'>
          ,grid%n_iup_h                 &amp;<a name='985'>
          ,grid%n_iup_adh               &amp;<a name='986'>
          ,grid%iup_h,grid%iup_adh           &amp;<a name='987'>
          ,grid%ent                     &amp;<a name='988'>
          ,IDTADT                  &amp;<a name='989'>
          ,grid%DT,grid%pdtop           &amp;<a name='990'>
          ,grid%ihe,grid%ihw,grid%ive,grid%ivw         &amp;<a name='991'>
          ,grid%deta1,grid%deta2             &amp;<a name='992'>
          ,grid%emt_loc                 &amp;<a name='993'>
          ,grid%fad,grid%hbm2,grid%pdsl,grid%pdslo     &amp;<a name='994'>
          ,grid%petdt                   &amp;<a name='995'>
          ,grid%uold,grid%vold               &amp;<a name='996'>
          ,SZJ,SPZ                 &amp;<a name='997'>
          <font color=#447700>!temporary arguments<a name='998'></font>
          ,grid%fne,grid%fse,grid%few,grid%fns,S1Z,TCS)<a name='999'>
<font color=#447700>!<a name='1000'></font>
#ifdef DM_PARALLEL<a name='1001'>
#    include "<A href='../../html_code/include/HALO_TRACERS.inc.html'>HALO_TRACERS.inc</A>"<A NAME="HALO_TRACERS.inc_9"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1002'>
#endif<a name='1003'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_4">(grid,config_flags,'before MONO', &amp;<a name='1004'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1005'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1006'>
            its,ite,jts,jte,kts,kte)<a name='1007'>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#MONO'>MONO</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MONO_1"> &amp;<a name='1008'>
          (         &amp;<a name='1009'>
#if defined(DM_PARALLEL)<a name='1010'>
           GRID%DOMDESC, &amp;<a name='1011'>
#endif<a name='1012'>
           MYPE,grid%ntsd,grid%ntsd*GRID%DT/3600.,PARAM_FIRST_SCALAR,NUM_SZJ &amp;<a name='1013'>
          ,IDS,IDE,JDS,JDE,KDS,KDE              &amp;<a name='1014'>
          ,IMS,IME,JMS,JME,KMS,KME              &amp;<a name='1015'>
          ,ITS,ITE,JTS,JTE,KTS,KTE              &amp;<a name='1016'>
          ,IDTADT                               &amp;<a name='1017'>
          ,grid%dy_nmm,grid%pdtop                         &amp;<a name='1018'>
          ,SUMDRRW                              &amp;<a name='1019'>
          ,grid%ihe,grid%ihw                              &amp;<a name='1020'>
          ,grid%deta1,grid%deta2                          &amp;<a name='1021'>
          ,grid%dx_nmm,grid%hbm2,grid%pdsl                     &amp;<a name='1022'>
          ,SZJ                                  &amp;<a name='1023'>
          <font color=#447700>!temporary arguments<a name='1024'></font>
          ,S1Z,TCS)<a name='1025'>
<font color=#447700>!<a name='1026'></font>
          DO KS=PARAM_FIRST_SCALAR,NUM_SZJ <font color=#447700>! loop by species<a name='1027'></font>
            DO K=KTS,KTE<a name='1028'>
              DO J=MYJS2,MYJE2<a name='1029'>
                DO I=MYIS1,MYIE1<a name='1030'>
                  SZJ(I,J,K,KS)=SZJ(I,J,K,KS)+TCS(I,J,K,KS)<a name='1031'>
                ENDDO<a name='1032'>
              ENDDO<a name='1033'>
            ENDDO<a name='1034'>
          ENDDO         <font color=#447700>! end of the loop by the species<a name='1035'></font>
<font color=#447700>!<a name='1036'></font>
          DO K=KTS,KTE<a name='1037'>
            DO J=MYJS2,MYJE2<a name='1038'>
              DO I=MYIS1,MYIE1<a name='1039'>
                grid%q  (I,J,K)=SZJ(I,J,K,P_SZJ1)<a name='1040'>
                grid%cwm(I,J,K)=SZJ(I,J,K,P_SZJ2)<a name='1041'>
                grid%rrw(I,J,K)=SZJ(I,J,K,P_SZJ4)<a name='1042'>
              ENDDO<a name='1043'>
            ENDDO<a name='1044'>
          ENDDO<a name='1045'>
<font color=#447700>!<a name='1046'></font>
          DO J=MYJS2,MYJE2<a name='1047'>
            DO I=MYIS1,MYIE1<a name='1048'>
              grid%q2(I,J,KTE)=MAX(SZJ(I,J,KTE,P_SZJ3)+SZJ(I,J,KTE,P_SZJ3)-EPSQ2 &amp;<a name='1049'>
                             ,EPSQ2)<a name='1050'>
            ENDDO<a name='1051'>
          ENDDO<a name='1052'>
<font color=#447700>!<a name='1053'></font>
          DO K=KTE-1,KTS+1,-1<a name='1054'>
            DO J=MYJS2,MYJE2<a name='1055'>
              DO I=MYIS1,MYIE1<a name='1056'>
                IF(K&gt;KTS)THEN<a name='1057'>
                  grid%q2(I,J,K)=MAX(SZJ(I,J,K,P_SZJ3)+SZJ(I,J,K,P_SZJ3)-grid%q2(I,J,K+1) &amp;<a name='1058'>
                               ,EPSQ2)<a name='1059'>
                ELSE<a name='1060'>
                  grid%q2(I,J,K)=grid%q2(I,J,K+1)<a name='1061'>
                ENDIF<a name='1062'>
              ENDDO<a name='1063'>
            ENDDO<a name='1064'>
          ENDDO<a name='1065'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1066'></font>
<a name='1067'>
<font color=#447700>!<a name='1068'></font>
<font color=#447700>!***  UPDATE MOIST ARRAY.<a name='1069'></font>
<font color=#447700>!***  REMEMBER THAT MOIST IS ONLY USED WITH THE PHYSICS AND THUS<a name='1070'></font>
<font color=#447700>!***  THE P_QV SLOT (=2) IS MIXING RATIO, NOT SPECIFIC HUMIDITY.<a name='1071'></font>
<font color=#447700>!***  ALTHOUGH MOIST IS ONLY USED FOR PHYSICS IN OPERATIONS, IT IS<a name='1072'></font>
<font color=#447700>!***  UPDATED HERE FROM grid%q EVERY ADVECTION TIMESTEP FOR NON-OPERATIONAL<a name='1073'></font>
<font color=#447700>!***  CONFIGURATIONS WHERE IT MAY BE USED OUTSIDE OF THE PHYSICS.<a name='1074'></font>
<font color=#447700>!<a name='1075'></font>
        IF(.NOT.OPERATIONAL_PHYSICS)THEN<a name='1076'>
           call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#ETAMP_TO_MOIST'>ETAMP_TO_MOIST</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ETAMP_TO_MOIST_1">()<a name='1077'>
        ENDIF<a name='1078'>
<font color=#447700>!<a name='1079'></font>
        had2_tim=had2_tim+now_time()-btimx<a name='1080'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1081'></font>
<font color=#447700>!<a name='1082'></font>
        ENDIF idtadt_block<a name='1083'>
<font color=#447700>!<a name='1084'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1085'></font>
<font color=#447700>!<a name='1086'></font>
      ENDIF eulerian  <font color=#447700>! eulerian advection for model tracers<a name='1087'></font>
<font color=#447700>!<a name='1088'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1089'></font>
<font color=#447700>!<a name='1090'></font>
<font color=#447700>!<a name='1091'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1092'></font>
<font color=#447700>!***  PRESSURE TENDENCY, ETA/SIGMADOT, VERTICAL PART OF OMEGA-ALPHA TERM<a name='1093'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1094'></font>
<font color=#447700>!<a name='1095'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_12">()<a name='1096'>
<font color=#447700>!<a name='1097'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_5">(grid,config_flags,'before VTOA', &amp;<a name='1098'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1099'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1100'>
            its,ite,jts,jte,kts,kte)<a name='1101'>
      CALL <A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#VTOA'>VTOA</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VTOA_1">(                                                        &amp;<a name='1102'>
     &amp;          grid%ntsd,GRID%DT,grid%pt,grid%eta2                                    &amp;<a name='1103'>
     &amp;         ,grid%hbm2,grid%ef4t                                               &amp;<a name='1104'>
     &amp;         ,grid%t,grid%dwdt,grid%rtop,grid%omgalf                                      &amp;<a name='1105'>
     &amp;         ,grid%pint,grid%div,grid%psdt,grid%res                                       &amp;<a name='1106'>
     &amp;         ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                         &amp;<a name='1107'>
     &amp;         ,IDS,IDF,JDS,JDF,KDS,KDE                                 &amp;<a name='1108'>
     &amp;         ,IMS,IME,JMS,JME,KMS,KME                                 &amp;<a name='1109'>
     &amp;         ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1110'>
<font color=#447700>!<a name='1111'></font>
      vtoa_tim=vtoa_tim+now_time()-btimx<a name='1112'>
<font color=#447700>!<a name='1113'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1114'></font>
<font color=#447700>!***  VERTICAL ADVECTION OF HEIGHT<a name='1115'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1116'></font>
<font color=#447700>!<a name='1117'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_13">()<a name='1118'>
<font color=#447700>!<a name='1119'></font>
<a name='1120'>
<a name='1121'>
<a name='1122'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_6">(grid,config_flags,'before VADZ', &amp;<a name='1123'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1124'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1125'>
            its,ite,jts,jte,kts,kte)<a name='1126'>
      CALL <A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#VADZ'>VADZ</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VADZ_1">(grid%ntsd,GRID%DT,grid%fis,GRID%SIGMA,grid%dfl,grid%hbm2                    &amp;<a name='1127'>
     &amp;         ,grid%deta1,grid%deta2,grid%pdtop                                       &amp;<a name='1128'>
     &amp;         ,grid%pint,grid%pdsl,grid%pdslo,grid%petdt                                   &amp;<a name='1129'>
     &amp;         ,grid%rtop,grid%t,grid%q,grid%cwm,grid%z,grid%w,grid%dwdt,grid%pdwdt                             &amp;<a name='1130'>
     &amp;         ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                         &amp;<a name='1131'>
     &amp;         ,IDS,IDF,JDS,JDF,KDS,KDE                                 &amp;<a name='1132'>
     &amp;         ,IMS,IME,JMS,JME,KMS,KME                                 &amp;<a name='1133'>
     &amp;         ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1134'>
<a name='1135'>
      vadz_tim=vadz_tim+now_time()-btimx<a name='1136'>
<font color=#447700>!<a name='1137'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1138'></font>
<font color=#447700>!***  HORIZONTAL ADVECTION OF HEIGHT<a name='1139'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1140'></font>
<font color=#447700>!<a name='1141'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1142'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_11">(loadimbal_tim,'after vadz')<a name='1143'>
#endif<a name='1144'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_14">()<a name='1145'>
<font color=#447700>!-----------------<a name='1146'></font>
#ifdef DM_PARALLEL<a name='1147'>
#    include "<A href='../../html_code/include/HALO_NMM_G.inc.html'>HALO_NMM_G.inc</A>"<A NAME="HALO_NMM_G.inc_10"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1148'>
#endif<a name='1149'>
<font color=#447700>!-----------------<a name='1150'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='1151'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1152'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_12">(loadimbal_tim,'after halo G')<a name='1153'>
#endif<a name='1154'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='1155'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max             &amp;<a name='1156'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='1157'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='1158'></font>
<font color=#447700>!<a name='1159'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_15">()<a name='1160'>
<font color=#447700>!<a name='1161'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_7">(grid,config_flags,'before HADZ', &amp;<a name='1162'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1163'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1164'>
            its,ite,jts,jte,kts,kte)<a name='1165'>
      CALL <A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#HADZ'>HADZ</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HADZ_1">(grid%ntsd,GRID%DT,grid%hydro,grid%hbm2,grid%deta1,grid%deta2,grid%pdtop               &amp;<a name='1166'>
     &amp;         ,grid%dx_nmm,grid%dy_nmm,grid%fad                                       &amp;<a name='1167'>
     &amp;         ,grid%few,grid%fns,grid%fne,grid%fse                                         &amp;<a name='1168'>
     &amp;         ,grid%pdsl,grid%u,grid%v,grid%w,grid%z,WP,grid%BARO                          &amp;<a name='1169'>
     &amp;         ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                         &amp;<a name='1170'>
     &amp;         ,IDS,IDF,JDS,JDF,KDS,KDE                                 &amp;<a name='1171'>
     &amp;         ,IMS,IME,JMS,JME,KMS,KME                                 &amp;<a name='1172'>
     &amp;         ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1173'>
<font color=#447700>!<a name='1174'></font>
      hadz_tim=hadz_tim+now_time()-btimx<a name='1175'>
<font color=#447700>!<a name='1176'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1177'></font>
<font color=#447700>!***  ADVECTION OF grid%w<a name='1178'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1179'></font>
<font color=#447700>!<a name='1180'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1181'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_13">(loadimbal_tim,'after hadz')<a name='1182'>
#endif<a name='1183'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_16">()<a name='1184'>
<font color=#447700>!-----------------<a name='1185'></font>
#ifdef DM_PARALLEL<a name='1186'>
#    include "<A href='../../html_code/include/HALO_NMM_H.inc.html'>HALO_NMM_H.inc</A>"<A NAME="HALO_NMM_H.inc_11"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1187'>
#endif<a name='1188'>
<font color=#447700>!-----------------<a name='1189'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='1190'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1191'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_14">(loadimbal_tim,'after halo H')<a name='1192'>
#endif<a name='1193'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='1194'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max             &amp;<a name='1195'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='1196'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='1197'></font>
<font color=#447700>!<a name='1198'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_17">()<a name='1199'>
<font color=#447700>!<a name='1200'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_8">(grid,config_flags,'before EPS', &amp;<a name='1201'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1202'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1203'>
            its,ite,jts,jte,kts,kte)<a name='1204'>
<a name='1205'>
      CALL <A href='../../html_code/dyn_nmm/module_NONHY_DYNAM.F.html#EPS'>EPS</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EPS_1">(grid%ntsd,GRID%DT,grid%hydro,grid%dx_nmm,grid%dy_nmm,grid%fad  &amp;<a name='1206'>
     &amp;        ,grid%aeta1,grid%deta1,grid%deta2,grid%pdtop,grid%pt      &amp;<a name='1207'>
     &amp;        ,grid%hbm2,grid%hbm3                                      &amp;<a name='1208'>
     &amp;        ,grid%pdsl,grid%pdslo,grid%pint,grid%rtop,grid%petdt,grid%pdwdt &amp;<a name='1209'>
     &amp;        ,grid%dwdt,grid%dwdtmn,grid%dwdtmx                        &amp;<a name='1210'>
     &amp;        ,grid%fns,grid%few,grid%fne,grid%fse                      &amp;<a name='1211'>
     &amp;        ,grid%t,grid%u,grid%v,grid%w,grid%w_tot,grid%q,grid%cwm   &amp;<a name='1212'>
     &amp;        ,grid%def3d,grid%hdac,grid%baro                           &amp;<a name='1213'>
     &amp;        ,WP,dwdt_damping_lev                                      &amp;<a name='1214'>
     &amp;        ,grid%ihe,grid%ihw,grid%ive,grid%ivw                      &amp;<a name='1215'>
     &amp;        ,IDS,IDF,JDS,JDF,KDS,KDE                                  &amp;<a name='1216'>
     &amp;        ,IMS,IME,JMS,JME,KMS,KME                                  &amp;<a name='1217'>
     &amp;        ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1218'>
<font color=#447700>!<a name='1219'></font>
      eps_tim=eps_tim+now_time()-btimx<a name='1220'>
<font color=#447700>!<a name='1221'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1222'></font>
<font color=#447700>!<a name='1223'></font>
      not_euler: IF(.NOT.EULER) THEN <font color=#447700>! Lagrangian model tracer advection<a name='1224'></font>
<font color=#447700>!<a name='1225'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1226'></font>
<font color=#447700>!***  VERTICAL ADVECTION OF grid%q, TKE, AND CLOUD WATER<a name='1227'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1228'></font>
<font color=#447700>!<a name='1229'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_9">(grid,config_flags,'before VAD2', &amp;<a name='1230'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1231'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1232'>
            its,ite,jts,jte,kts,kte)<a name='1233'>
      IF(MOD(grid%ntsd,GRID%IDTAD)==0)THEN<a name='1234'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_18">()<a name='1235'>
<font color=#447700>!<a name='1236'></font>
        vad2_micro_check: IF (ETAMP_PHYSICS) THEN<a name='1237'>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#VAD2'>VAD2</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VAD2_1">(grid%ntsd,GRID%DT,GRID%IDTAD,grid%dx_nmm,grid%dy_nmm               &amp;<a name='1238'>
     &amp;             ,grid%aeta1,grid%aeta2,grid%deta1,grid%deta2,grid%pdsl,grid%pdtop,grid%hbm2             &amp;<a name='1239'>
     &amp;             ,grid%q,grid%q2,grid%cwm,grid%petdt                                      &amp;<a name='1240'>
     &amp;             ,grid%n_iup_h,grid%n_iup_v                                     &amp;<a name='1241'>
     &amp;             ,grid%n_iup_adh,grid%n_iup_adv                                 &amp;<a name='1242'>
     &amp;             ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                         &amp;<a name='1243'>
     &amp;             ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                     &amp;<a name='1244'>
     &amp;             ,IDS,IDF,JDS,JDF,KDS,KDE                             &amp;<a name='1245'>
     &amp;             ,IMS,IME,JMS,JME,KMS,KME                             &amp;<a name='1246'>
     &amp;             ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1247'>
<font color=#447700>!<a name='1248'></font>
        ELSE vad2_micro_check<a name='1249'>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#VAD2_SCAL'>VAD2_SCAL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VAD2_SCAL_1">(grid%ntsd,GRID%DT,GRID%IDTAD,grid%dx_nmm,grid%dy_nmm          &amp;<a name='1250'>
     &amp;                  ,grid%aeta1,grid%aeta2,grid%deta1,grid%deta2,grid%pdsl,grid%pdtop             &amp;<a name='1251'>
     &amp;                  ,grid%hbm2                                           &amp;<a name='1252'>
     &amp;                  ,grid%q2,grid%petdt                                       &amp;<a name='1253'>
     &amp;                  ,grid%n_iup_h,grid%n_iup_v                                &amp;<a name='1254'>
     &amp;                  ,grid%n_iup_adh,grid%n_iup_adv                            &amp;<a name='1255'>
     &amp;                  ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                    &amp;<a name='1256'>
     &amp;                  ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                &amp;<a name='1257'>
     &amp;                  ,1,1                                            &amp;<a name='1258'>
     &amp;                  ,IDS,IDF,JDS,JDF,KDS,KDE                        &amp;<a name='1259'>
     &amp;                  ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='1260'>
     &amp;                  ,ITS,ITE,JTS,JTE,KTS,KTE)                              <a name='1261'>
     <a name='1262'>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#VAD2_SCAL'>VAD2_SCAL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VAD2_SCAL_2">(grid%ntsd,GRID%DT,GRID%IDTAD,grid%dx_nmm,grid%dy_nmm          &amp;<a name='1263'>
     &amp;                  ,grid%aeta1,grid%aeta2,grid%deta1,grid%deta2,grid%pdsl,grid%pdtop             &amp;<a name='1264'>
     &amp;                  ,grid%hbm2                                           &amp;<a name='1265'>
     &amp;                  ,MOIST,grid%petdt                                    &amp;<a name='1266'>
     &amp;                  ,grid%n_iup_h,grid%n_iup_v                                &amp;<a name='1267'>
     &amp;                  ,grid%n_iup_adh,grid%n_iup_adv                            &amp;<a name='1268'>
     &amp;                  ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                    &amp;<a name='1269'>
     &amp;                  ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                &amp;<a name='1270'>
     &amp;                  ,NUM_MOIST,2                                    &amp;<a name='1271'>
     &amp;                  ,IDS,IDF,JDS,JDF,KDS,KDE                        &amp;<a name='1272'>
     &amp;                  ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='1273'>
     &amp;                  ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1274'>
<font color=#447700>!<a name='1275'></font>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#VAD2_SCAL'>VAD2_SCAL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VAD2_SCAL_3">(grid%ntsd,GRID%DT,GRID%IDTAD,grid%dx_nmm,grid%dy_nmm          &amp;<a name='1276'>
     &amp;                  ,grid%aeta1,grid%aeta2,grid%deta1,grid%deta2,grid%pdsl,grid%pdtop             &amp;<a name='1277'>
     &amp;                  ,grid%hbm2                                           &amp;<a name='1278'>
     &amp;                  ,SCALAR,grid%petdt                                   &amp;<a name='1279'>
     &amp;                  ,grid%n_iup_h,grid%n_iup_v                                &amp;<a name='1280'>
     &amp;                  ,grid%n_iup_adh,grid%n_iup_adv                            &amp;<a name='1281'>
     &amp;                  ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                    &amp;<a name='1282'>
     &amp;                  ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                &amp;<a name='1283'>
     &amp;                  ,NUM_SCALAR,2                                   &amp;<a name='1284'>
     &amp;                  ,IDS,IDF,JDS,JDF,KDS,KDE                        &amp;<a name='1285'>
     &amp;                  ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='1286'>
     &amp;                  ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1287'>
<font color=#447700>!<a name='1288'></font>
<a name='1289'>
          DO K=KTS,KTE<a name='1290'>
          DO J=MYJS,MYJE<a name='1291'>
          DO I=MYIS,MYIE<a name='1292'>
            grid%q(I,J,K)=MOIST(I,J,K,P_QV)/(1.+MOIST(I,J,K,P_QV))<a name='1293'>
          ENDDO<a name='1294'>
          ENDDO   <a name='1295'>
          ENDDO   <a name='1296'>
<font color=#447700>!<a name='1297'></font>
        ENDIF vad2_micro_check<a name='1298'>
<font color=#447700>!<a name='1299'></font>
        vad2_tim=vad2_tim+now_time()-btimx<a name='1300'>
<font color=#447700>!<a name='1301'></font>
      ENDIF<a name='1302'>
<font color=#447700>!    <a name='1303'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1304'></font>
<font color=#447700>!***  HORIZONTAL ADVECTION OF grid%q, TKE, AND CLOUD WATER<a name='1305'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1306'></font>
<font color=#447700>!<a name='1307'></font>
      idtad_block: IF(MOD(grid%ntsd,GRID%IDTAD)==0)THEN<a name='1308'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1309'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_15">(loadimbal_tim,'after vad2')<a name='1310'>
#endif<a name='1311'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_19">()<a name='1312'>
<font color=#447700>!-----------------<a name='1313'></font>
#ifdef DM_PARALLEL<a name='1314'>
#    include "<A href='../../html_code/include/HALO_NMM_I.inc.html'>HALO_NMM_I.inc</A>"<A NAME="HALO_NMM_I.inc_12"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1315'>
#endif<a name='1316'>
<font color=#447700>!<a name='1317'></font>
#ifdef DM_PARALLEL<a name='1318'>
        IF (.NOT.ETAMP_PHYSICS) THEN<a name='1319'>
#    include "<A href='../../html_code/include/HALO_NMM_I_3.inc.html'>HALO_NMM_I_3.inc</A>"<A NAME="HALO_NMM_I_3.inc_13"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1320'>
        ENDIF<a name='1321'>
#endif<a name='1322'>
<font color=#447700>!<a name='1323'></font>
<font color=#447700>!-----------------<a name='1324'></font>
        exch_tim=exch_tim+now_time()-btimx<a name='1325'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1326'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_16">(loadimbal_tim,'after halo I &amp; I3')<a name='1327'>
#endif<a name='1328'>
<font color=#447700>!       this_tim=now_time()-btimx<a name='1329'></font>
<font color=#447700>!       call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max           &amp;<a name='1330'></font>
<font color=#447700>!    &amp;                    ,mpi_comm_comp,irtn)<a name='1331'></font>
<font color=#447700>!       exch_tim_max=exch_tim_max+et_max<a name='1332'></font>
<font color=#447700>!<a name='1333'></font>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_20">()<a name='1334'>
<font color=#447700>!<a name='1335'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1336'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_10">(grid,config_flags,'before HAD2', &amp;<a name='1337'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1338'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1339'>
            its,ite,jts,jte,kts,kte)<a name='1340'>
        had2_micro_check: IF (ETAMP_PHYSICS) THEN<a name='1341'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1342'></font>
<font color=#447700>!<a name='1343'></font>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2'>HAD2</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HAD2_1">(                                                   &amp;<a name='1344'>
#if defined(DM_PARALLEL)<a name='1345'>
     &amp;              GRID%DOMDESC,                                      &amp;<a name='1346'>
#endif<a name='1347'>
     &amp;              grid%ntsd,GRID%DT,GRID%IDTAD,grid%dx_nmm,grid%dy_nmm              &amp;<a name='1348'>
     &amp;             ,grid%aeta1,grid%aeta2,grid%deta1,grid%deta2,grid%pdsl,grid%pdtop                 &amp;<a name='1349'>
     &amp;             ,grid%hbm2,grid%hbm3                                          &amp;<a name='1350'>
     &amp;             ,grid%q,grid%q2,grid%cwm,grid%u,grid%v,grid%z,grid%hydro                               &amp;<a name='1351'>
     &amp;             ,grid%n_iup_h,grid%n_iup_v                                    &amp;<a name='1352'>
     &amp;             ,grid%n_iup_adh,grid%n_iup_adv                                &amp;<a name='1353'>
     &amp;             ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                        &amp;<a name='1354'>
     &amp;             ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                    &amp;<a name='1355'>
     &amp;             ,advect_Q2 &amp;<a name='1356'>
     &amp;             ,IDS,IDF,JDS,JDF,KDS,KDE                            &amp;<a name='1357'>
     &amp;             ,IMS,IME,JMS,JME,KMS,KME                            &amp;<a name='1358'>
     &amp;             ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1359'>
<font color=#447700>!<a name='1360'></font>
<font color=#447700>!***  UPDATE MOIST ARRAY.<a name='1361'></font>
<font color=#447700>!***  REMEMBER THAT MOIST IS ONLY USED WITH THE PHYSICS AND THUS<a name='1362'></font>
<font color=#447700>!***  THE P_QV SLOT (=2) IS MIXING RATIO, NOT SPECIFIC HUMIDITY.<a name='1363'></font>
<font color=#447700>!***  ALTHOUGH MOIST IS ONLY USED FOR PHYSICS IN OPERATIONS, IT IS <a name='1364'></font>
<font color=#447700>!***  UPDATED HERE FROM grid%q EVERY ADVECTION TIMESTEP FOR NON-OPERATIONAL<a name='1365'></font>
<font color=#447700>!***  CONFIGURATIONS WHERE IT MAY BE USED OUTSIDE OF THE PHYSICS.<a name='1366'></font>
<font color=#447700>!<a name='1367'></font>
          IF(.NOT.OPERATIONAL_PHYSICS)THEN<a name='1368'>
             call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#ETAMP_TO_MOIST'>ETAMP_TO_MOIST</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ETAMP_TO_MOIST_2">()<a name='1369'>
          ENDIF<a name='1370'>
<font color=#447700>!<a name='1371'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1372'></font>
        ELSE had2_micro_check<a name='1373'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1374'></font>
<font color=#447700>!<a name='1375'></font>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2_SCAL'>HAD2_SCAL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HAD2_SCAL_1">(                                              &amp;<a name='1376'>
#if defined(DM_PARALLEL)<a name='1377'>
     &amp;                   GRID%DOMDESC,                                 &amp;<a name='1378'>
#endif        <a name='1379'>
     &amp;                   grid%ntsd,GRID%DT,GRID%IDTAD,grid%dx_nmm,grid%dy_nmm         &amp;<a name='1380'>
     &amp;                  ,grid%aeta1,grid%aeta2,grid%deta1,grid%deta2,grid%pdsl,grid%pdtop            &amp;<a name='1381'>
     &amp;                  ,grid%hbm2,grid%hbm3                                     &amp;<a name='1382'>
     &amp;                  ,grid%q2,grid%u,grid%v,grid%z,grid%hydro                                &amp;<a name='1383'>
     &amp;                  ,grid%n_iup_h,grid%n_iup_v                               &amp;<a name='1384'>
     &amp;                  ,grid%n_iup_adh,grid%n_iup_adv                           &amp;<a name='1385'>
     &amp;                  ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                   &amp;<a name='1386'>
     &amp;                  ,grid%ihe,grid%ihw,grid%ive,grid%ivw                               &amp;<a name='1387'>
     &amp;                  ,1,1                                           &amp;<a name='1388'>
     &amp;                  ,IDS,IDF,JDS,JDF,KDS,KDE                       &amp;<a name='1389'>
     &amp;                  ,IMS,IME,JMS,JME,KMS,KME                       &amp;<a name='1390'>
     &amp;                  ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1391'>
<font color=#447700>!        <a name='1392'></font>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2_SCAL'>HAD2_SCAL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HAD2_SCAL_2">(                                              &amp;<a name='1393'>
#if defined(DM_PARALLEL)<a name='1394'>
     &amp;                   GRID%DOMDESC,                                 &amp;<a name='1395'>
#endif<a name='1396'>
     &amp;                   grid%ntsd,GRID%DT,GRID%IDTAD,grid%dx_nmm,grid%dy_nmm         &amp;<a name='1397'>
     &amp;                  ,grid%aeta1,grid%aeta2,grid%deta1,grid%deta2,grid%pdsl,grid%pdtop            &amp;<a name='1398'>
     &amp;                  ,grid%hbm2,grid%hbm3                                     &amp;<a name='1399'>
     &amp;                  ,MOIST,grid%u,grid%v,grid%z,grid%hydro                             &amp;<a name='1400'>
     &amp;                  ,grid%n_iup_h,grid%n_iup_v                               &amp;<a name='1401'>
     &amp;                  ,grid%n_iup_adh,grid%n_iup_adv                           &amp;<a name='1402'>
     &amp;                  ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                   &amp;<a name='1403'>
     &amp;                  ,grid%ihe,grid%ihw,grid%ive,grid%ivw                               &amp;<a name='1404'>
     &amp;                  ,NUM_MOIST,2                                   &amp;<a name='1405'>
     &amp;                  ,IDS,IDF,JDS,JDF,KDS,KDE                       &amp;<a name='1406'>
     &amp;                  ,IMS,IME,JMS,JME,KMS,KME                       &amp;<a name='1407'>
     &amp;                  ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1408'>
<font color=#447700>!<a name='1409'></font>
          CALL <A href='../../html_code/dyn_nmm/module_ADVECTION.F.html#HAD2_SCAL'>HAD2_SCAL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HAD2_SCAL_3">(                                              &amp;<a name='1410'>
#if defined(DM_PARALLEL)<a name='1411'>
     &amp;                   GRID%DOMDESC,                                 &amp;<a name='1412'>
#endif<a name='1413'>
     &amp;                   grid%ntsd,GRID%DT,GRID%IDTAD,grid%dx_nmm,grid%dy_nmm         &amp;<a name='1414'>
     &amp;                  ,grid%aeta1,grid%aeta2,grid%deta1,grid%deta2,grid%pdsl,grid%pdtop            &amp;<a name='1415'>
     &amp;                  ,grid%hbm2,grid%hbm3                                     &amp;<a name='1416'>
     &amp;                  ,SCALAR,grid%u,grid%v,grid%z,grid%hydro                            &amp;<a name='1417'>
     &amp;                  ,grid%n_iup_h,grid%n_iup_v                               &amp;<a name='1418'>
     &amp;                  ,grid%n_iup_adh,grid%n_iup_adv                           &amp;<a name='1419'>
     &amp;                  ,grid%iup_h,grid%iup_v,grid%iup_adh,grid%iup_adv                   &amp;<a name='1420'>
     &amp;                  ,grid%ihe,grid%ihw,grid%ive,grid%ivw                               &amp;<a name='1421'>
     &amp;                  ,NUM_SCALAR,2                                  &amp;<a name='1422'>
     &amp;                  ,IDS,IDF,JDS,JDF,KDS,KDE                       &amp;<a name='1423'>
     &amp;                  ,IMS,IME,JMS,JME,KMS,KME                       &amp;<a name='1424'>
     &amp;                  ,ITS,ITE,JTS,JTE,KTS,KTE)                             <a name='1425'>
<font color=#447700>!    <a name='1426'></font>
          DO K=KTS,KTE <a name='1427'>
          DO J=MYJS,MYJE<a name='1428'>
          DO I=MYIS,MYIE<a name='1429'>
            grid%q(I,J,K)=MOIST(I,J,K,P_QV)/(1.+MOIST(I,J,K,P_QV))           <a name='1430'>
          ENDDO<a name='1431'>
          ENDDO    <a name='1432'>
          ENDDO   <a name='1433'>
<font color=#447700>!<a name='1434'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1435'></font>
        ENDIF had2_micro_check<a name='1436'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1437'></font>
        had2_tim=had2_tim+now_time()-btimx<a name='1438'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1439'></font>
<font color=#447700>!<a name='1440'></font>
      ENDIF idtad_block<a name='1441'>
<font color=#447700>!<a name='1442'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1443'></font>
<font color=#447700>!<a name='1444'></font>
      ENDIF not_euler  <font color=#447700>! Lagrangian model tracer advection<a name='1445'></font>
<font color=#447700>!<a name='1446'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1447'></font>
<font color=#447700>!***  RADIATION<a name='1448'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1449'></font>
<font color=#447700>!<a name='1450'></font>
<font color=#447700>!***  When allocating CAM radiation 4d arrays (ozmixm, aerosolc), <a name='1451'></font>
<font color=#447700>!***  the following two scalars are not needed.<a name='1452'></font>
<font color=#447700>!<a name='1453'></font>
      NUM_AEROSOLC=1<a name='1454'>
<font color=#447700>!<a name='1455'></font>
      IF(grid%ntsd&lt;=0)THEN<a name='1456'>
        NTSD_rad=grid%ntsd<a name='1457'>
      ELSE<a name='1458'>
<font color=#447700>!<a name='1459'></font>
<font color=#447700>!***  Call radiation just BEFORE the top of the hour<a name='1460'></font>
<font color=#447700>!***  so that updated fields are written to history files.<a name='1461'></font>
<font color=#447700>!<a name='1462'></font>
        NTSD_rad=grid%ntsd+1<a name='1463'>
      ENDIF<a name='1464'>
<font color=#447700>!<a name='1465'></font>
#if ( HWRF == 1 )<a name='1466'>
<font color=#447700>!emc_2010_bugfix_h50<a name='1467'></font>
<font color=#447700>! remove this - not needed for V3.2<a name='1468'></font>
<font color=#447700>!      call nl_get_start_hour(1,IHRST)<a name='1469'></font>
<font color=#447700>!emc_2010_bugfix_h50<a name='1470'></font>
#endif<a name='1471'>
<a name='1472'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_11">(grid,config_flags,'before RADIATION', &amp;<a name='1473'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1474'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1475'>
            its,ite,jts,jte,kts,kte)<a name='1476'>
      IF(MOD(NTSD_rad,GRID%NRADS)==0.OR.                               &amp;<a name='1477'>
     &amp;   MOD(NTSD_rad,GRID%NRADL)==0)THEN<a name='1478'>
<font color=#447700>!<a name='1479'></font>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_21">()<a name='1480'>
        IF(OPERATIONAL_PHYSICS)THEN<a name='1481'>
          CALL <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#UPDATE_MOIST'>UPDATE_MOIST</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_MOIST_1">(MOIST,grid%q,grid%cwm,grid%f_ice,grid%f_rain,N_MOIST           &amp;<a name='1482'>
     &amp;                     ,IDS,IDF,JDS,JDF,KDS,KDE                    &amp;<a name='1483'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1484'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1485'>
        ENDIF<a name='1486'>
<font color=#447700>!<a name='1487'></font>
        CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#RADIATION'>RADIATION</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_1">(NTSD_rad,GRID%DT,GRID%JULDAY,GRID%JULYR         &amp;<a name='1488'>
     &amp;                ,GRID%XTIME,GRID%JULIAN                          &amp;<a name='1489'>
     &amp;                ,IHRST,GRID%NPHS                                 &amp;<a name='1490'>
     &amp;                ,grid%glat,grid%glon,GRID%NRADS,GRID%NRADL                 &amp;<a name='1491'>
     &amp;                ,grid%deta1,grid%deta2,grid%aeta1,grid%aeta2,grid%eta1,grid%eta2,grid%pdtop,grid%pt      &amp;<a name='1492'>
     &amp;                ,grid%pd,grid%res,grid%pint,grid%t,grid%q,MOIST,grid%ths,grid%albedo,grid%epsr           &amp;<a name='1493'>
     &amp;                ,grid%f_ice,grid%f_rain                                    &amp;<a name='1494'>
     &amp;                ,grid%GD_CLOUD,grid%GD_CLOUD2                              &amp;<a name='1495'>
     &amp;                ,grid%sm,grid%hbm2,grid%cldfra,N_MOIST,RESTRT                   &amp;<a name='1496'>
     &amp;                ,grid%rlwtt,grid%rswtt,grid%rlwin,grid%rswin,grid%rswinc,grid%rswout           &amp;<a name='1497'>
     &amp;                ,grid%rlwtoa,grid%rswtoa,grid%czmean                            &amp;<a name='1498'>
     &amp;                ,grid%cfracl,grid%cfracm,grid%cfrach,grid%sigt4                      &amp;<a name='1499'>
     &amp;                ,grid%acfrst,grid%ncfrst,grid%acfrcv,grid%ncfrcv                     &amp;<a name='1500'>
     &amp;                ,grid%cuppt,grid%vegfrc,grid%sno,grid%htop,grid%hbot                      &amp;<a name='1501'>
     &amp;                ,grid%z,grid%sice,NUM_AEROSOLC,NUM_OZMIXM        &amp;<a name='1502'>
     &amp;                ,OZMIXM,grid%PIN,grid%LEVSIZ                     &amp;<a name='1503'>
<a name='1504'>
     &amp;                ,GRID,CONFIG_FLAGS                               &amp;<a name='1505'>
     &amp;                ,RTHRATEN                                        &amp;  <a name='1506'>
     &amp;                ,grid%re_cloud,grid%re_ice,grid%re_snow          &amp;  <font color=#447700>! G. Thompson<a name='1507'></font>
     &amp;                ,grid%has_reqc,grid%has_reqi,grid%has_reqs       &amp;  <font color=#447700>! G. Thompson<a name='1508'></font>
     &amp;                ,grid%SWUPT,grid%SWUPTC,grid%SWDNT,grid%SWDNTC   &amp;<a name='1509'>
     &amp;                ,grid%SWUPB,grid%SWUPBC,grid%SWDNB,grid%SWDNBC   &amp;<a name='1510'>
     &amp;                ,grid%LWUPT,grid%LWUPTC,grid%LWDNT,grid%LWDNTC   &amp;<a name='1511'>
     &amp;                ,grid%LWUPB,grid%LWUPBC,grid%LWDNB,grid%LWDNBC   &amp;<a name='1512'>
     &amp;                ,grid%ACSWUPT,grid%ACSWUPTC,grid%ACSWDNT,grid%ACSWDNTC   &amp;<a name='1513'>
     &amp;                ,grid%ACSWUPB,grid%ACSWUPBC,grid%ACSWDNB,grid%ACSWDNBC   &amp;<a name='1514'>
     &amp;                ,grid%ACLWUPT,grid%ACLWUPTC,grid%ACLWDNT,grid%ACLWDNTC   &amp;<a name='1515'>
     &amp;                ,grid%ACLWUPB,grid%ACLWUPBC,grid%ACLWDNB,grid%ACLWDNBC   &amp;<a name='1516'>
     &amp;                 ,grid%swvisdir ,grid%swvisdif &amp;  <font color=#447700>!ssib<a name='1517'></font>
     &amp;                 ,grid%swnirdir ,grid%swnirdif &amp;  <font color=#447700>!ssib<a name='1518'></font>
     &amp;                ,IDS,IDF,JDS,JDF,KDS,KDE                         &amp;<a name='1519'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                         &amp;<a name='1520'>
     &amp;                ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1521'>
<font color=#447700>!<a name='1522'></font>
        DO J=jts,min(jde-1,jte)<a name='1523'>
        DO I=its,min(ide-1,ite)<a name='1524'>
          grid%gsw(I,J)=grid%rswin(I,J)-grid%rswout(I,J)<a name='1525'>
        ENDDO<a name='1526'>
        ENDDO<a name='1527'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1528'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_17">(loadimbal_tim,'after rad')<a name='1529'>
#endif<a name='1530'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_22">()<a name='1531'>
<font color=#447700>!-----------------<a name='1532'></font>
#ifdef DM_PARALLEL<a name='1533'>
#    include "<A href='../../html_code/include/HALO_NMM_RAD.inc.html'>HALO_NMM_RAD.inc</A>"<A NAME="HALO_NMM_RAD.inc_14"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1534'>
#endif<a name='1535'>
<font color=#447700>!-----------------<a name='1536'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='1537'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1538'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_18">(loadimbal_tim,'after rad halo')<a name='1539'>
#endif<a name='1540'>
<a name='1541'>
<font color=#447700>!<a name='1542'></font>
<font color=#447700>!                            ***  NOTE  ***<a name='1543'></font>
<font color=#447700>! grid%rlwin/grid%rswin  - downward longwave/shortwave at the surface (formerly TOTLWDN/TOTSWDN)<a name='1544'></font>
<font color=#447700>! grid%rswinc - CLEAR-SKY downward shortwave at the surface (new for AQ)<a name='1545'></font>
<font color=#447700>!                            ***  NOTE  ***<a name='1546'></font>
<font color=#447700>!<a name='1547'></font>
        radiation_tim=radiation_tim+now_time()-btimx<a name='1548'>
      ENDIF<a name='1549'>
<font color=#447700>!<a name='1550'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1551'></font>
<font color=#447700>!***  APPLY TEMPERATURE TENDENCY DUE TO RADIATION<a name='1552'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1553'></font>
<font color=#447700>!<a name='1554'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_23">()<a name='1555'>
<font color=#447700>!<a name='1556'></font>
<font color=#447700>!     Pass in XTIME (elapsed time from start of parent) to compute<a name='1557'></font>
<font color=#447700>!     the time passed into the zenith angle code consistently between<a name='1558'></font>
<font color=#447700>!     RDTEMP and RADIATION.<a name='1559'></font>
<a name='1560'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_12">(grid,config_flags,'before RDTEMP', &amp;<a name='1561'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1562'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1563'>
            its,ite,jts,jte,kts,kte)<a name='1564'>
      CALL <A href='../../html_code/dyn_nmm/RDTEMP.F.html#RDTEMP'>RDTEMP</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RDTEMP_1">(grid%ntsd,GRID%DT,GRID%JULDAY,GRID%JULYR                  &amp;<a name='1565'>
     &amp;           ,GRID%XTIME,IHRST,grid%glat,grid%glon                           &amp;<a name='1566'>
     &amp;           ,grid%czen,grid%czmean,grid%t,grid%rswtt,grid%rlwtt,grid%hbm2                       &amp;<a name='1567'>
     &amp;           ,IDS,IDF,JDS,JDF,KDS,KDE                              &amp;<a name='1568'>
     &amp;           ,IMS,IME,JMS,JME,KMS,KME                              &amp;<a name='1569'>
     &amp;           ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1570'>
<font color=#447700>!<a name='1571'></font>
      rdtemp_tim=rdtemp_tim+now_time()-btimx<a name='1572'>
<font color=#447700>!<a name='1573'></font>
<font color=#447700>!<a name='1574'></font>
#if ( HWRF == 1 )<a name='1575'>
<font color=#447700>!<a name='1576'></font>
<font color=#447700>!-------------------------------------------------------------------------------------<a name='1577'></font>
<font color=#447700>!*** GET SSTs FROM DMITRY's COUPLER ON TO THE PARENT AND NESTED GRID<a name='1578'></font>
<font color=#447700>!-------------------------------------------------------------------------------------<a name='1579'></font>
      CALL nl_get_multi_storm(1,multi_storm)<a name='1580'>
      CALL nl_get_no_ocean(1,no_ocean)<a name='1581'>
      IF ( .NOT. multi_storm .OR. no_ocean ) THEN<a name='1582'>
        write(message,*)' No Ocean Coupling Run'<a name='1583'>
        call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_128">(1,trim(message))<a name='1584'>
      ELSE<a name='1585'>
<font color=#447700>! Coupling insertion:-&gt;<a name='1586'></font>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_24">()<a name='1587'>
        CALL ATM_GETSST(grid%sst,grid%sm)<a name='1588'>
        sst_tim=sst_tim+now_time()-btimx<a name='1589'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_25">()<a name='1590'>
        CALL atm_getcur(grid%scurx, grid%scury)    <font color=#447700>!BT<a name='1591'></font>
        CALL atm_getwstate(grid%charn,grid%msang)  <font color=#447700>!BT<a name='1592'></font>
        wav_tim=wav_tim+now_time()-btimx<a name='1593'>
<font color=#447700>!&lt;-:Coupling insertion<a name='1594'></font>
      ENDIF<a name='1595'>
#endif<a name='1596'>
<font color=#447700>!----------------------------------------------------------------------<a name='1597'></font>
<font color=#447700>!***  TURBULENT PROCESSES <a name='1598'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1599'></font>
<font color=#447700>!<a name='1600'></font>
      turbl_time: IF(MOD(grid%ntsd,GRID%NPHS)==0)THEN<a name='1601'>
<font color=#447700>!<a name='1602'></font>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_26">()<a name='1603'>
<font color=#447700>!<a name='1604'></font>
        IF(OPERATIONAL_PHYSICS                                         &amp;<a name='1605'>
     &amp;    .AND.MOD(NTSD_rad,GRID%NRADS)/=0                             &amp;<a name='1606'>
     &amp;    .AND.MOD(NTSD_rad,GRID%NRADL)/=0)THEN<a name='1607'>
          CALL <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#UPDATE_MOIST'>UPDATE_MOIST</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_MOIST_2">(MOIST,grid%q,grid%cwm,grid%f_ice,grid%f_rain,N_MOIST           &amp;<a name='1608'>
     &amp;                     ,IDS,IDF,JDS,JDF,KDS,KDE                    &amp;<a name='1609'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1610'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1611'>
        ENDIF<a name='1612'>
<font color=#447700>!<a name='1613'></font>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_13">(grid,config_flags,'before TURBL', &amp;<a name='1614'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1615'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1616'>
            its,ite,jts,jte,kts,kte)<a name='1617'>
        CALL <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#TURBL'>TURBL</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TURBL_1">(grid%ntsd,GRID%DT,GRID%NPHS,RESTRT                       &amp;<a name='1618'>
     &amp;            ,N_MOIST,NUM_SCALAR,GRID%NUM_SOIL_LAYERS,grid%sldpth,grid%dzsoil          &amp;<a name='1619'>
     &amp;            ,grid%deta1,grid%deta2,grid%aeta1,grid%aeta2,grid%eta1,grid%eta2,grid%pdtop,grid%pt          &amp;<a name='1620'>
     &amp;            ,grid%sm,grid%hbm2,grid%vbm2,grid%dx_nmm,grid%dfrlg                           &amp;<a name='1621'>
     &amp;            ,grid%czen,grid%czmean,grid%sigt4,grid%rlwin,grid%rswin,grid%radot                 &amp;<a name='1622'>
     &amp;            ,grid%pd,grid%res,grid%pint,grid%t,grid%q,grid%cwm,grid%f_ice,grid%f_rain,grid%sr                 &amp;<a name='1623'>
     &amp;            ,grid%q2,grid%u,grid%v,grid%ths,grid%nmm_tsk,grid%sst,grid%prec,grid%sno                     &amp;<a name='1624'>
     &amp;            ,grid%scurx,grid%scury                                                             &amp;<a name='1625'>
     &amp;            ,grid%fis,grid%z0,grid%mz0,grid%z0base,grid%ustar,grid%mixht,grid%pblh,grid%lpbl,grid%el_pbl    &amp;   <font color=#447700>!KWON MZ0<a name='1626'></font>
     &amp;            ,MOIST,SCALAR,grid%rmol,grid%mol                                      &amp;<a name='1627'>
     &amp;            ,grid%exch_h,grid%exch_m,grid%f,grid%akhs,grid%akms,grid%akhs_out,grid%akms_out         &amp;<a name='1628'>
     &amp;            ,grid%thz0,grid%qz0,grid%uz0,grid%vz0,grid%qsh,grid%mavail                         &amp;<a name='1629'>
     &amp;            ,grid%stc,grid%smc,grid%cmc,grid%smstav,grid%smstot,grid%ssroff,grid%bgroff             &amp;<a name='1630'>
     &amp;            ,grid%ivgtyp,grid%isltyp,grid%vegfrc,grid%shdmin,grid%shdmax,grid%grnflx           &amp;<a name='1631'>
     &amp;            ,grid%snotime                                             &amp;<a name='1632'>
     &amp;            ,grid%sfcexc,grid%acsnow,grid%acsnom,grid%snopcx,grid%sice,grid%tg,grid%soiltb          &amp;<a name='1633'>
     &amp;            ,grid%albsi,grid%icedepth,grid%snowsi                                                   &amp;<a name='1634'>
     &amp;            ,grid%albase,grid%mxsnal,grid%albedo,grid%sh2o,grid%si,grid%epsr,grid%embck             &amp;<a name='1635'>
     &amp;            ,grid%u10,grid%v10,grid%uoce,grid%voce,grid%th10,grid%q10,grid%tshltr,grid%qshltr,grid%pshltr               &amp;<a name='1636'>
     &amp;            ,grid%t2,grid%qsg,grid%qvg,grid%qcg,grid%soilt1,grid%tsnav,grid%smfr3d,grid%keepfr3dflag     &amp;<a name='1637'>
#if (NMM_CORE==1)<a name='1638'>
     &amp;            ,grid%twbs,grid%qwbs,grid%taux,grid%tauy,grid%sfcshx,grid%sfclhx,grid%sfcevp,RTHRATEN                      &amp;<a name='1639'>
#else<a name='1640'>
     &amp;            ,grid%twbs,grid%qwbs,grid%sfcshx,grid%sfclhx,grid%sfcevp                      &amp;<a name='1641'>
#endif<a name='1642'>
     &amp;            ,grid%potevp,grid%potflx,grid%subshx                                &amp;<a name='1643'>
     &amp;            ,grid%aphtim,grid%ardsw,grid%ardlw,grid%asrfc                            &amp;<a name='1644'>
     &amp;            ,grid%rswout,grid%rswtoa,grid%rlwtoa                                &amp;<a name='1645'>
     &amp;            ,grid%aswin,grid%aswout,grid%aswtoa,grid%alwin,grid%alwout,grid%alwtoa             &amp;<a name='1646'>
#if (NMM_CORE==1)<a name='1647'>
     &amp;            ,grid%uz0h,grid%vz0h,grid%dudt,grid%dvdt,grid%ugwdsfc,grid%vgwdsfc,grid%sfenth          &amp; <a name='1648'>
#else<a name='1649'>
     &amp;            ,grid%uz0h,grid%vz0h,grid%dudt,grid%dvdt                                 &amp; <a name='1650'>
#endif<a name='1651'>
     &amp;            ,RTHBLTEN,RQVBLTEN                                   &amp; <a name='1652'>
     &amp;            ,GRID%PCPFLG,grid%ddata                                   &amp;<a name='1653'>
     &amp;            ,grid%hstdv,grid%hcnvx,grid%hasyw,grid%hasys,grid%hasysw,grid%hasynw,grid%hlenw,grid%hlens   &amp; <font color=#447700>! GWD<a name='1654'></font>
     &amp;            ,grid%hlensw,grid%hlennw,grid%hangl,grid%hanis,grid%hslop,grid%hzmax,grid%crot,grid%srot     &amp; <font color=#447700>! GWD<a name='1655'></font>
     &amp;            ,grid%dew                                            &amp; <font color=#447700>! RUC LSM<a name='1656'></font>
     &amp;            ,grid%rc_mf                                          &amp; <font color=#447700>! QNSE<a name='1657'></font>
     &amp;            ,GRID,CONFIG_FLAGS                                   &amp;<a name='1658'>
     &amp;            ,grid%ihe,grid%ihw,grid%ive,grid%ivw                 &amp;<a name='1659'>
     &amp;            ,GRID%DISHEAT,GRID%DKU3D,GRID%DKT3D                          &amp;<a name='1660'>
     &amp;            ,GRID%HPBL2D, GRID%EVAP2D, GRID%HEAT2D,GRID%RC2D               &amp;  <font color=#447700>!S&amp;P Kwon<a name='1661'></font>
     &amp;            ,GRID%SFCHEADRT,GRID%INFXSRT,GRID%SOLDRAIN           &amp;  <font color=#447700>!Hydrology, no-op right now<a name='1662'></font>
     &amp;            ,grid%cd_out,grid%ch_out                             &amp;<a name='1663'>
     &amp;            ,grid%ulowl,grid%vlowl                               &amp;<a name='1664'>
     &amp;            ,grid%zsig1,grid%rchno                               &amp;<a name='1665'>
     &amp;            ,grid%charn,grid%msang                               &amp;<a name='1666'>
     &amp;            ,grid%DUBLDT,grid%DVBLDT,grid%DTHBLDT,grid%DQVBLDT   &amp;<font color=#447700>!wang added PBL tendency output<a name='1667'></font>
     &amp;            ,IDS,IDF,JDS,JDF,KDS,KDE                             &amp;<a name='1668'>
     &amp;            ,IMS,IME,JMS,JME,KMS,KME                             &amp;<a name='1669'>
     &amp;            ,IPS,IPE,JPS,JPE,KPS,KPE                             &amp;<a name='1670'>
     &amp;            ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1671'>
<font color=#447700>!<a name='1672'></font>
<font color=#447700>!                     ***  NOTE  ***<a name='1673'></font>
<font color=#447700>! grid%rlwin/grid%rswin - downward longwave/shortwave at the surface<a name='1674'></font>
<font color=#447700>!                     ***  NOTE  ***<a name='1675'></font>
<font color=#447700>!<a name='1676'></font>
        turbl_tim=turbl_tim+now_time()-btimx<a name='1677'>
#if ( HWRF == 1 )<a name='1678'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_27">()<a name='1679'>
        call <A href='../../html_code/dyn_nmm/module_swath.F.html#SUSTAINED_WIND'>sustained_wind</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUSTAINED_WIND_1">(grid,config_flags,ips,ipe,jps,jpe,.true.)<a name='1680'>
        diag_tim=diag_tim+now_time()-btimx<a name='1681'>
<font color=#447700>!------------------------------------------------------------------------------<a name='1682'></font>
<font color=#447700>!*** ATMOSPHERIC MODEL OUTPUTS FROM PARENT AND NESTED GRID FOR DMITRYs COUPLER<a name='1683'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='1684'></font>
<font color=#447700>!<a name='1685'></font>
<font color=#447700>!-- grid%twbs  :  surface sensible heat flux, positive downward (grid%w/m2)<a name='1686'></font>
<font color=#447700>!-- grid%qwbs  :  surface latent heat flux, positive downward (grid%w/m2)<a name='1687'></font>
<font color=#447700>!-- grid%rlwin :  downward long wave flux at ground surface,positive downward (grid%w/m2)<a name='1688'></font>
<font color=#447700>!-- grid%rswin :  downward short wave flux at ground surface, positive downward (grid%w/m2)<a name='1689'></font>
<font color=#447700>!-- grid%radot :  outgoing long wave flux at ground surface, positive upward (grid%w/m2)<a name='1690'></font>
<font color=#447700>!-- grid%rswout:  outgoing short wave flux at ground surface, positive upward (grid%w/m2)<a name='1691'></font>
<font color=#447700>!-- grid%taux  :  x component of surface stress, grid%u positive Eastward<a name='1692'></font>
<font color=#447700>!-- grid%tauy  :  y component of surface stress, grid%v positive Northward<a name='1693'></font>
<font color=#447700>!-- grid%pint  :  3d array of interface pressure (pascals)<a name='1694'></font>
<font color=#447700>!-- grid%prec  :  grid%prec (m/timestep;timestep on grid1=60 sec)<a name='1695'></font>
<a name='1696'>
<font color=#447700>!<a name='1697'></font>
<font color=#447700>!<a name='1698'></font>
      CALL nl_get_multi_storm(1,multi_storm)<a name='1699'>
      CALL nl_get_no_ocean(1,no_ocean)<a name='1700'>
      IF ( .NOT. multi_storm .OR. no_ocean ) THEN<a name='1701'>
        write(message,*)' No Ocean Coupling Run'<a name='1702'>
        call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_129">(1,trim(message))<a name='1703'>
      ELSE<a name='1704'>
<font color=#447700>! Coupling insertion:-&gt;<a name='1705'></font>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_28">()<a name='1706'>
        call ATM_DOFLUXES(grid%twbs,grid%qwbs,grid%rlwin,grid%rswin,grid%radot,grid%rswout, &amp;<a name='1707'>
        grid%taux,grid%tauy,grid%pint,grid%prec)<a name='1708'>
        CALL atm_prepwindp(grid%ulowl,grid%vlowl,grid%rchno,grid%zsig1)<a name='1709'>
        flux_tim=flux_tim+now_time()-btimx<a name='1710'>
<font color=#447700>!&lt;-:Coupling insertion<a name='1711'></font>
<font color=#447700>!<a name='1712'></font>
      ENDIF<a name='1713'>
        IF(GRID%ID .EQ. 1 .AND. MOD(grid%ntsd,grid%NPHS)==0)THEN<a name='1714'>
          btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_29">()<a name='1715'>
          flux_tim=flux_tim+now_time()-btimx<a name='1716'>
        ENDIF<a name='1717'>
#endif<a name='1718'>
<font color=#447700>!<a name='1719'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1720'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_19">(loadimbal_tim,'after atm_dofluxes')<a name='1721'>
#endif<a name='1722'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_30">()<a name='1723'>
<font color=#447700>!-----------------<a name='1724'></font>
#ifdef DM_PARALLEL<a name='1725'>
# include "<A href='../../html_code/include/HALO_NMM_TURBL_A.inc.html'>HALO_NMM_TURBL_A.inc</A>"<A NAME="HALO_NMM_TURBL_A.inc_15"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1726'>
#endif<a name='1727'>
<font color=#447700>!-----------------<a name='1728'></font>
#ifdef DM_PARALLEL<a name='1729'>
# include "<A href='../../html_code/include/HALO_NMM_TURBL_B.inc.html'>HALO_NMM_TURBL_B.inc</A>"<A NAME="HALO_NMM_TURBL_B.inc_16"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1730'>
#endif<a name='1731'>
<font color=#447700>!-----------------<a name='1732'></font>
        exch_tim=exch_tim+now_time()-btimx<a name='1733'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1734'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_20">(loadimbal_tim,'after halo TURBL A &amp; B')<a name='1735'>
#endif<a name='1736'>
<font color=#447700>!       this_tim=now_time()-btimx<a name='1737'></font>
<font color=#447700>!       call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max           &amp;<a name='1738'></font>
<font color=#447700>!    &amp;                    ,mpi_comm_comp,irtn)<a name='1739'></font>
<font color=#447700>!       exch_tim_max=exch_tim_max+et_max<a name='1740'></font>
<font color=#447700>!<a name='1741'></font>
<font color=#447700>!***  INTERPOLATE WINDS FROM H POINTS BACK TO grid%v POINTS.<a name='1742'></font>
<font color=#447700>!<a name='1743'></font>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_31">()<a name='1744'>
        CALL <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#UV_H_TO_V'>UV_H_TO_V</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UV_H_TO_V_1">(grid%ntsd,GRID%DT,GRID%NPHS,grid%uz0h,grid%vz0h,grid%uz0,grid%vz0         &amp;<a name='1745'>
     &amp;                ,grid%dudt,grid%dvdt,grid%u,grid%v,grid%hbm2,grid%ive,grid%ivw                       &amp;<a name='1746'>
     &amp;                ,IDS,IDF,JDS,JDF,KDS,KDE                          &amp;<a name='1747'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='1748'>
     &amp;                ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1749'>
        uv_htov_tim=uv_htov_tim+now_time()-btimx<a name='1750'>
<font color=#447700>!<a name='1751'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1752'></font>
<font color=#447700>!*** STORE ORIGINAL TEMPERATURE ARRAY<a name='1753'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1754'></font>
<font color=#447700>!<a name='1755'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1756'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_21">(loadimbal_tim,'after uv_h_to_v')<a name='1757'>
#endif<a name='1758'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_32">()<a name='1759'>
<font color=#447700>!-----------------<a name='1760'></font>
#ifdef DM_PARALLEL<a name='1761'>
#    include "<A href='../../html_code/include/HALO_NMM_J.inc.html'>HALO_NMM_J.inc</A>"<A NAME="HALO_NMM_J.inc_17"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1762'>
#endif<a name='1763'>
<font color=#447700>!<a name='1764'></font>
#ifdef DM_PARALLEL<a name='1765'>
        IF (.NOT.ETAMP_PHYSICS) THEN<a name='1766'>
#    include "<A href='../../html_code/include/HALO_NMM_J_3.inc.html'>HALO_NMM_J_3.inc</A>"<A NAME="HALO_NMM_J_3.inc_18"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1767'>
        ENDIF<a name='1768'>
#endif<a name='1769'>
<font color=#447700>!<a name='1770'></font>
<font color=#447700>!-----------------<a name='1771'></font>
        exch_tim=exch_tim+now_time()-btimx<a name='1772'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1773'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_22">(loadimbal_tim,'after halo J, J2 &amp; J3')<a name='1774'>
#endif<a name='1775'>
<font color=#447700>!       this_tim=now_time()-btimx<a name='1776'></font>
<font color=#447700>!       call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max           &amp;<a name='1777'></font>
<font color=#447700>!    &amp;                    ,mpi_comm_comp,irtn)<a name='1778'></font>
<font color=#447700>!       exch_tim_max=exch_tim_max+et_max<a name='1779'></font>
<font color=#447700>!<a name='1780'></font>
        ICLTEND=-1<a name='1781'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_33">()<a name='1782'>
<font color=#447700>! <a name='1783'></font>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_14">(grid,config_flags,'before CLTEND', &amp;<a name='1784'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1785'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1786'>
            its,ite,jts,jte,kts,kte)<a name='1787'>
        CALL <A href='../../html_code/dyn_nmm/CLTEND.F.html#CLTEND'>CLTEND</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLTEND_1">(ICLTEND,GRID%NPHS,grid%t,grid%t_old,grid%t_adj                    &amp;<a name='1788'>
     &amp;             ,IDS,IDF,JDS,JDF,KDS,KDE                            &amp;<a name='1789'>
     &amp;             ,IMS,IME,JMS,JME,KMS,KME                            &amp;<a name='1790'>
     &amp;             ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1791'>
<font color=#447700>!<a name='1792'></font>
        cltend_tim=cltend_tim+now_time()-btimx<a name='1793'>
     ENDIF turbl_time<a name='1794'>
<font color=#447700>!<a name='1795'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1796'></font>
<font color=#447700>!***  CONVECTIVE PRECIPITATION<a name='1797'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1798'></font>
<font color=#447700>!<a name='1799'></font>
      IF(MOD(grid%ntsd,GRID%NCNVC)==0.AND.                              &amp;<a name='1800'>
     &amp;   (CONFIG_FLAGS%CU_PHYSICS.eq.KFETASCHEME .or.                     &amp;<a name='1801'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS.eq.OSASSCHEME .or.                       &amp;<a name='1802'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS.eq.NSASSCHEME .or.                       &amp;<a name='1803'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS.eq.SCALESASSCHEME .or.                   &amp;<a name='1804'>
     &amp;   CONFIG_FLAGS%CU_PHYSICS.eq.SASSCHEME))THEN                       <font color=#447700>! <a name='1805'></font>
<font color=#447700>!<a name='1806'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1807'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_23">(loadimbal_tim,'after cltend')<a name='1808'>
#endif<a name='1809'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_34">()<a name='1810'>
<font color=#447700>!-----------------<a name='1811'></font>
#ifdef DM_PARALLEL<a name='1812'>
#    include "<A href='../../html_code/include/HALO_NMM_C.inc.html'>HALO_NMM_C.inc</A>"<A NAME="HALO_NMM_C.inc_19"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1813'>
#endif<a name='1814'>
<font color=#447700>!-----------------<a name='1815'></font>
        exch_tim=exch_tim+now_time()-btimx<a name='1816'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1817'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_24">(loadimbal_tim,'after halo C')<a name='1818'>
#endif<a name='1819'>
<font color=#447700>!       this_tim=now_time()-btimx<a name='1820'></font>
<font color=#447700>!       call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max          &amp;<a name='1821'></font>
<font color=#447700>!    &amp;                    ,mpi_comm_comp,irtn)<a name='1822'></font>
<font color=#447700>!       exch_tim_max=exch_tim_max+et_max<a name='1823'></font>
     ENDIF<a name='1824'>
<font color=#447700>!<a name='1825'></font>
      convection: IF(CONFIG_FLAGS%CU_PHYSICS/=0)THEN<a name='1826'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_35">()<a name='1827'>
<font color=#447700>!<a name='1828'></font>
<font color=#447700>!***  GET TENDENCIES FOR GD SCHEME.<a name='1829'></font>
<font color=#447700>!    <a name='1830'></font>
        IF(CONFIG_FLAGS%CU_PHYSICS==GDSCHEME.OR.                        &amp;<a name='1831'>
     &amp;  CONFIG_FLAGS%CU_PHYSICS==TIEDTKESCHEME.OR.                      &amp;<a name='1832'>
     &amp;  CONFIG_FLAGS%CU_PHYSICS==KFETASCHEME)THEN<a name='1833'>
          DT_INV=1./GRID%DT<a name='1834'>
          DO J=JMS,JME<a name='1835'>
          DO K=KMS,KME<a name='1836'>
          DO I=IMS,IME<a name='1837'>
            TTEN(I,K,J)=(grid%t(I,J,K)-TTEN(I,K,J))*DT_INV<a name='1838'>
            QTEN(I,K,J)=(grid%q(I,J,K)-QTEN(I,K,J))*DT_INV<a name='1839'>
          ENDDO<a name='1840'>
          ENDDO<a name='1841'>
          ENDDO<a name='1842'>
        ENDIF<a name='1843'>
<font color=#447700>!<a name='1844'></font>
<font color=#447700>!***  UPDATE THE MOIST ARRAY IF NEEDED.<a name='1845'></font>
<font color=#447700>!<a name='1846'></font>
        IF(OPERATIONAL_PHYSICS                                         &amp;<a name='1847'>
     &amp;    .AND.MOD(NTSD_rad,GRID%NRADS)/=0                             &amp;<a name='1848'>
     &amp;    .AND.MOD(NTSD_rad,GRID%NRADL)/=0                             &amp;<a name='1849'>
     &amp;    .AND.MOD(grid%ntsd,GRID%NPHS)/=0)THEN<a name='1850'>
          CALL <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#UPDATE_MOIST'>UPDATE_MOIST</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_MOIST_3">(MOIST,grid%q,grid%cwm,grid%f_ice,grid%f_rain,N_MOIST           &amp;<a name='1851'>
     &amp;                     ,IDS,IDF,JDS,JDF,KDS,KDE                    &amp;<a name='1852'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1853'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1854'>
       ENDIF<a name='1855'>
<font color=#447700>!<a name='1856'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1857'></font>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_15">(grid,config_flags,'before CUCNVC', &amp;<a name='1858'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1859'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1860'>
            its,ite,jts,jte,kts,kte)<a name='1861'>
        CALL <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#CUCNVC'>CUCNVC</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUCNVC_1">(grid%ntsd,GRID%DT,GRID%NCNVC,GRID%NRADS,GRID%NRADL      &amp;<a name='1862'>
     &amp;             ,GPS,RESTRT,grid%hydro,grid%cldefi,N_MOIST,NUM_SCALAR,GRID%ENSDIM        &amp;<a name='1863'>
     &amp;             ,MOIST,SCALAR                                       &amp;<a name='1864'>
     &amp;             ,grid%deta1,grid%deta2,grid%aeta1,grid%aeta2,grid%eta1,grid%eta2                  &amp;<a name='1865'>
     &amp;             ,grid%f_ice,grid%f_rain                                       &amp;<a name='1866'>
<font color=#447700>!***  Changes for other cu schemes, most for GD scheme<a name='1867'></font>
     &amp;             ,grid%apr_gr,grid%apr_w,grid%apr_mc,TTEN,QTEN                      &amp;<a name='1868'>
     &amp;             ,grid%apr_st,grid%apr_as,grid%apr_capma                            &amp;<a name='1869'>
     &amp;             ,grid%apr_capme,grid%apr_capmi                                &amp;<a name='1870'>
     &amp;             ,grid%mass_flux,grid%xf_ens                                   &amp;<a name='1871'>
     &amp;             ,grid%pr_ens,grid%gsw                                         &amp;<a name='1872'>
     &amp;             ,grid%GD_CLOUD,grid%GD_CLOUD2,grid%ktop_deep                  &amp;<a name='1873'>
     &amp;             ,grid%pdtop,grid%pt,grid%pd,grid%res,grid%pint,grid%t,grid%q,grid%cwm,grid%tcucn                 &amp;<a name='1874'>
     &amp;             ,grid%omgalf,grid%u,grid%v,grid%w,grid%z,grid%fis,grid%w0avg                           &amp;<a name='1875'>
     &amp;             ,grid%prec,grid%acprec,grid%cuprec,grid%cuppt,grid%cprate                    &amp;<a name='1876'>
     &amp;             ,grid%sm,grid%hbm2,grid%pblh,grid%lpbl,grid%cnvbot,grid%cnvtop                         &amp;<a name='1877'>
     &amp;             ,grid%htop,grid%hbot,grid%htopd,grid%hbotd,grid%htops,grid%hbots                  &amp;<a name='1878'>
     &amp;             ,RTHBLTEN,RQVBLTEN,RTHRATEN                          &amp; <a name='1879'>
#if (NMM_CORE==1)                  <a name='1880'>
     &amp;             ,grid%twbs,grid%qwbs                                &amp;<a name='1881'>
     &amp;             ,grid%DUCUDT, grid%DVCUDT, GRID%MOMMIX, grid%random &amp; <a name='1882'>
     &amp;             ,grid%DTHCUDT,grid%DQVCUDT,grid%DQRCUDT,grid%DQCCUDT&amp;<font color=#447700>! wang, output CU tendency <a name='1883'></font>
     &amp;             ,grid%DQICUDT,grid%DQSCUDT                          &amp;<a name='1884'>
#endif<a name='1885'>
     &amp;             ,grid%hpbl2d,grid%evap2d,grid%heat2d                &amp;<a name='1886'>
     &amp;             ,grid%dx_nmm,grid%dy_nmm                            &amp; <font color=#447700>!wang, dx2d, dy<a name='1887'></font>
     &amp;             ,grid%scalefun, grid%scalefun1                      &amp; <font color=#447700>!wang<a name='1888'></font>
     &amp;             ,grid%sigmu, grid%sigmu1                            &amp; <font color=#447700>!wang<a name='1889'></font>
     &amp;             ,grid%avcnvc,grid%acutim,grid%ihe,grid%ihw          &amp;<a name='1890'>
     &amp;             ,GRID,CONFIG_FLAGS                                  &amp;<a name='1891'>
     &amp;             ,IDS,IDF,JDS,JDF,KDS,KDE                            &amp;<a name='1892'>
     &amp;             ,IMS,IME,JMS,JME,KMS,KME                            &amp;<a name='1893'>
     &amp;             ,IPS,IPE,JPS,JPE,KPS,KPE                            &amp;<a name='1894'>
     &amp;             ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1895'>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_16">(grid,config_flags,'after CUCNVC', &amp;<a name='1896'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1897'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1898'>
            its,ite,jts,jte,kts,kte)<a name='1899'>
<font color=#447700>!----------------------------------------------------------------------<a name='1900'></font>
<font color=#447700>!<a name='1901'></font>
        cucnvc_tim=cucnvc_tim+now_time()-btimx<a name='1902'>
<font color=#447700>!<a name='1903'></font>
<a name='1904'>
<a name='1905'>
#if (NMM_CORE==1)<a name='1906'>
<font color=#447700>!#if ( HWRF == 1 )<a name='1907'></font>
<font color=#447700>!-------------------------------------------------------------------------------------<a name='1908'></font>
<font color=#447700>!       This is gopal's doing for HWRFSAS<a name='1909'></font>
<a name='1910'>
<font color=#447700>!        IF(MOD(grid%ntsd,GRID%NCNVC).eq.0.and.(CONFIG_FLAGS%CU_PHYSICS.eq.OSASSCHEME))THEN<a name='1911'></font>
<font color=#447700>! update to match HWRFV2 behaviour - review later (1/15/10)<a name='1912'></font>
<font color=#447700>!<a name='1913'></font>
<font color=#447700>!emc_2010_bugfix_h50<a name='1914'></font>
        IF(MOD(grid%ntsd, GRID%NCNVC).eq.0.and.                 &amp;<a name='1915'>
     &amp;    (CONFIG_FLAGS%CU_PHYSICS.eq.OSASSCHEME.or.            &amp;<a name='1916'>
     &amp;     CONFIG_FLAGS%CU_PHYSICS.eq.NSASSCHEME.or.            &amp;<a name='1917'>
     &amp;     CONFIG_FLAGS%CU_PHYSICS.eq.SCALESASSCHEME.or.        &amp;<a name='1918'>
     &amp;     CONFIG_FLAGS%CU_PHYSICS.eq.SASSCHEME))THEN <a name='1919'>
<font color=#447700>!emc_2010_bugfix_h50<a name='1920'></font>
<font color=#447700>!<a name='1921'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1922'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_25">(loadimbal_tim,'after cucnvc')<a name='1923'>
#endif<a name='1924'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_36">()<a name='1925'>
<font color=#447700>!-----------------<a name='1926'></font>
#ifdef DM_PARALLEL<a name='1927'>
# include "<A href='../../html_code/include/HALO_NMM_SAS_A.inc.html'>HALO_NMM_SAS_A.inc</A>"<A NAME="HALO_NMM_SAS_A.inc_20"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1928'>
#endif<a name='1929'>
<font color=#447700>!-----------------<a name='1930'></font>
#ifdef DM_PARALLEL<a name='1931'>
# include "<A href='../../html_code/include/HALO_NMM_SAS_B.inc.html'>HALO_NMM_SAS_B.inc</A>"<A NAME="HALO_NMM_SAS_B.inc_21"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1932'>
#endif<a name='1933'>
<font color=#447700>!-----------------<a name='1934'></font>
        exch_tim=exch_tim+now_time()-btimx<a name='1935'>
<a name='1936'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='1937'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_26">(loadimbal_tim,'after halo SAS A &amp; B')<a name='1938'>
#endif<a name='1939'>
<font color=#447700>!<a name='1940'></font>
<font color=#447700>!***  INTERPOLATE WINDS FROM H POINTS BACK TO V POINTS AFTER SAS <a name='1941'></font>
<font color=#447700>!<a name='1942'></font>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_37">()<a name='1943'>
<a name='1944'>
<font color=#447700>!emc_2010_bugfix_h50<a name='1945'></font>
        CALL <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#UV_H_TO_V'>UV_H_TO_V</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UV_H_TO_V_2">(grid%NTSD,GRID%DT,GRID%NCNVC,grid%UZ0H,grid%VZ0H,grid%UZ0,grid%VZ0         &amp;<a name='1946'>
     &amp;                ,grid%DUCUDT,grid%DVCUDT,grid%U,grid%V,grid%HBM2,grid%IVE,grid%IVW                   &amp;<a name='1947'>
     &amp;                ,IDS,IDF,JDS,JDF,KDS,KDE                          &amp;<a name='1948'>
     &amp;                ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='1949'>
     &amp;                ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1950'>
        uv_htov_tim=uv_htov_tim+now_time()-btimx<a name='1951'>
<font color=#447700>!emc_2010_bugfix_h50<a name='1952'></font>
<a name='1953'>
     ENDIF <font color=#447700>! for SAS only <a name='1954'></font>
<font color=#447700>!#endif<a name='1955'></font>
#endif<a name='1956'>
<font color=#447700>!--------------------------------------------------------------------------------<a name='1957'></font>
<font color=#447700>!<a name='1958'></font>
  ENDIF convection<a name='1959'>
<font color=#447700>!<a name='1960'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1961'></font>
<font color=#447700>!***  GRIDSCALE MICROPHYSICS (CONDENSATION &amp; PRECIPITATION)<a name='1962'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1963'></font>
<font color=#447700>!<a name='1964'></font>
      IF(MOD(grid%ntsd,GRID%NPHS)==0)THEN<a name='1965'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_38">()<a name='1966'>
<font color=#447700>!<a name='1967'></font>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_17">(grid,config_flags,'before GSMDRIVE', &amp;<a name='1968'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1969'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1970'>
            its,ite,jts,jte,kts,kte)<a name='1971'>
        CALL <A href='../../html_code/dyn_nmm/module_PHYSICS_CALLS.F.html#GSMDRIVE'>GSMDRIVE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GSMDRIVE_1">(grid%ntsd,GRID%DT,GRID%NPHS,N_MOIST                   &amp;<a name='1972'>
     &amp;               ,grid%dx_nmm(ITS,JC),GRID%DY,grid%sm,grid%hbm2,grid%fis               &amp;<a name='1973'>
     &amp;               ,grid%deta1,grid%deta2,grid%aeta1,grid%aeta2,grid%eta1,grid%eta2                &amp;<a name='1974'>
     &amp;               ,grid%pdtop,grid%pt,grid%pd,grid%res,grid%pint,grid%t,grid%q,grid%cwm,grid%train               &amp;<a name='1975'>
     &amp;               ,MOIST,SCALAR,NUM_SCALAR                          &amp;<a name='1976'>
     &amp;               ,grid%f_ice,grid%f_rain,grid%f_rimef,grid%sr                          &amp;<a name='1977'>
     &amp;               ,grid%prec,grid%acprec,grid%avrain                               &amp;<a name='1978'>
     &amp;               ,grid%mp_restart_state                                 &amp;<a name='1979'>
     &amp;               ,grid%tbpvs_state                                      &amp;<a name='1980'>
     &amp;               ,grid%tbpvs0_state                                     &amp;<a name='1981'>
     &amp;               ,GRID,CONFIG_FLAGS                                &amp;<a name='1982'>
     &amp;               ,grid%re_cloud,grid%re_ice,grid%re_snow           &amp;  <font color=#447700>! G. Thompson<a name='1983'></font>
     &amp;               ,grid%has_reqc,grid%has_reqi,grid%has_reqs        &amp;  <font color=#447700>! G. Thompson<a name='1984'></font>
     &amp;               ,diag_flag                                        &amp;  <a name='1985'>
     &amp;               ,IDS,IDF,JDS,JDF,KDS,KDE                          &amp;<a name='1986'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='1987'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1988'>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_18">(grid,config_flags,'after GSMDRIVE', &amp;<a name='1989'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='1990'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1991'>
            its,ite,jts,jte,kts,kte)<a name='1992'>
<font color=#447700>!<a name='1993'></font>
        gsmdrive_tim=gsmdrive_tim+now_time()-btimx<a name='1994'>
<font color=#447700>!<a name='1995'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1996'></font>
<font color=#447700>!---------PRECIPITATION ASSIMILATION------------------------------------<a name='1997'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1998'></font>
<font color=#447700>!<a name='1999'></font>
        IF (GRID%PCPFLG) THEN<a name='2000'>
          btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_39">()<a name='2001'>
<font color=#447700>!<a name='2002'></font>
          CALL <A href='../../html_code/dyn_nmm/module_PRECIP_ADJUST.F.html#CHKSNOW'>CHKSNOW</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHKSNOW_1">(grid%ntsd,GRID%DT,GRID%NPHS,grid%sr,PPTDAT                 &amp;<a name='2003'>
     &amp;      ,IDS,IDE,JDS,JDE,KDS,KDE                                    &amp;<a name='2004'>
     &amp;      ,IMS,IME,JMS,JME,KMS,KME                                    &amp;<a name='2005'>
     &amp;      ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2006'>
          CALL <A href='../../html_code/dyn_nmm/module_PRECIP_ADJUST.F.html#ADJPPT'>ADJPPT</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJPPT_1">(grid%ntsd,GRID%DT,GRID%NPHS,grid%prec,grid%lspa,PPTDAT,grid%ddata     &amp;<a name='2007'>
     &amp;      ,IDS,IDE,JDS,JDE,KDS,KDE                                    &amp;<a name='2008'>
     &amp;      ,IMS,IME,JMS,JME,KMS,KME                                    &amp;<a name='2009'>
     &amp;      ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2010'>
<font color=#447700>!<a name='2011'></font>
          adjppt_tim=adjppt_tim+now_time()-btimx<a name='2012'>
        ENDIF<a name='2013'>
<font color=#447700>!<a name='2014'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2015'></font>
<font color=#447700>!***  CALCULATE TEMP TENDENCIES AND RESTORE ORIGINAL TEMPS<a name='2016'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2017'></font>
<font color=#447700>!      <a name='2018'></font>
        ICLTEND=0<a name='2019'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_40">()<a name='2020'>
<font color=#447700>!<a name='2021'></font>
        CALL <A href='../../html_code/dyn_nmm/CLTEND.F.html#CLTEND'>CLTEND</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLTEND_2">(ICLTEND,GRID%NPHS,grid%t,grid%t_old,grid%t_adj                    &amp;<a name='2022'>
     &amp;             ,IDS,IDF,JDS,JDF,KDS,KDE                            &amp;<a name='2023'>
     &amp;             ,IMS,IME,JMS,JME,KMS,KME                            &amp;<a name='2024'>
     &amp;             ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2025'>
<font color=#447700>!<a name='2026'></font>
        cltend_tim=cltend_tim+now_time()-btimx<a name='2027'>
      ENDIF<a name='2028'>
<font color=#447700>!<a name='2029'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2030'></font>
<font color=#447700>!***  UPDATE TEMP TENDENCIES FROM CLOUD PROCESSES EVERY TIME STEP<a name='2031'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2032'></font>
<font color=#447700>!<a name='2033'></font>
      ICLTEND=1<a name='2034'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_41">()<a name='2035'>
<font color=#447700>!<a name='2036'></font>
      CALL <A href='../../html_code/dyn_nmm/CLTEND.F.html#CLTEND'>CLTEND</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLTEND_3">(ICLTEND,GRID%NPHS,grid%t,grid%t_old,grid%t_adj                      &amp;<a name='2037'>
     &amp;           ,IDS,IDF,JDS,JDF,KDS,KDE                              &amp;<a name='2038'>
     &amp;           ,IMS,IME,JMS,JME,KMS,KME                              &amp;<a name='2039'>
     &amp;           ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2040'>
<font color=#447700>!<a name='2041'></font>
      cltend_tim=cltend_tim+now_time()-btimx<a name='2042'>
<font color=#447700>!<a name='2043'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2044'></font>
<font color=#447700>!***  LATERAL DIFFUSION<a name='2045'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2046'></font>
<font color=#447700>!<a name='2047'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2048'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_27">(loadimbal_tim,'after GSMDRIVE and a few other things')<a name='2049'>
#endif<a name='2050'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_42">()<a name='2051'>
<font color=#447700>!-----------------<a name='2052'></font>
#ifdef DM_PARALLEL<a name='2053'>
#    include "<A href='../../html_code/include/HALO_NMM_K.inc.html'>HALO_NMM_K.inc</A>"<A NAME="HALO_NMM_K.inc_22"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2054'>
#endif<a name='2055'>
<font color=#447700>!-----------------<a name='2056'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='2057'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2058'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_28">(loadimbal_tim,'after halo K')<a name='2059'>
#endif<a name='2060'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='2061'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max             &amp;<a name='2062'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='2063'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='2064'></font>
<font color=#447700>!<a name='2065'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_43">()<a name='2066'>
<font color=#447700>!<a name='2067'></font>
      CALL <A href='../../html_code/dyn_nmm/module_DIFFUSION_NMM.F.html#HDIFF'>HDIFF</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HDIFF_1">(grid%ntsd,GRID%DT,grid%fis,grid%dy_nmm,grid%hdac,grid%hdacv         &amp;<a name='2068'>
     &amp;          ,grid%hbm2,grid%deta1,GRID%SIGMA                       &amp;<a name='2069'>
#if ( HWRF == 1 )<a name='2070'>
     &amp;          ,grid%t,grid%q,grid%u,grid%v,grid%q2,grid%z,grid%w,grid%sm,grid%sice,grid%h_diff    &amp;<a name='2071'>
#else<a name='2072'>
     &amp;          ,grid%t,grid%q,grid%u,grid%v,grid%q2,grid%z,grid%w,grid%sm,grid%sice                &amp;<a name='2073'>
#endif<a name='2074'>
     &amp;          ,grid%def3d                                              &amp;<a name='2075'>
     &amp;          ,grid%ihe,grid%ihw,grid%ive,grid%ivw                   &amp;<a name='2076'>
     &amp;          ,CONFIG_FLAGS                                          &amp;<a name='2077'>
     &amp;          ,IDS,IDF,JDS,JDF,KDS,KDE                               &amp;<a name='2078'>
     &amp;          ,IMS,IME,JMS,JME,KMS,KME                               &amp;<a name='2079'>
     &amp;          ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2080'>
<font color=#447700>!<a name='2081'></font>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_19">(grid,config_flags,'after HDIFF', &amp;<a name='2082'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2083'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2084'>
            its,ite,jts,jte,kts,kte)<a name='2085'>
      IF(.NOT.OPERATIONAL_PHYSICS)THEN<a name='2086'>
        DO K=KTS,KTE<a name='2087'>
        DO J=MYJS,MYJE<a name='2088'>
        DO I=MYIS,MYIE<a name='2089'>
<font color=#447700>!!!       MOIST(I,J,K,P_QV)=MAX(0.,grid%q(I,J,K)/(1.-grid%q(I,J,K)))<a name='2090'></font>
          MOIST(I,J,K,P_QV)=grid%q(I,J,K)/(1.-grid%q(I,J,K))           <font color=#447700>!&lt;-- Update mixing ratio<a name='2091'></font>
        ENDDO<a name='2092'>
        ENDDO<a name='2093'>
        ENDDO<a name='2094'>
      ENDIF<a name='2095'>
<font color=#447700>!<a name='2096'></font>
      hdiff_tim=hdiff_tim+now_time()-btimx<a name='2097'>
<font color=#447700>!<a name='2098'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2099'></font>
<font color=#447700>!***  UPDATING BOUNDARY VALUES AT HEIGHT POINTS<a name='2100'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2101'></font>
<font color=#447700>!<a name='2102'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2103'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_29">(loadimbal_tim,'after hdiff')<a name='2104'>
#endif<a name='2105'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_44">()<a name='2106'>
<font color=#447700>!-----------------<a name='2107'></font>
#ifdef DM_PARALLEL<a name='2108'>
#    include "<A href='../../html_code/include/HALO_NMM_L.inc.html'>HALO_NMM_L.inc</A>"<A NAME="HALO_NMM_L.inc_23"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2109'>
#endif<a name='2110'>
<font color=#447700>!<a name='2111'></font>
#ifdef DM_PARALLEL<a name='2112'>
#    include "<A href='../../html_code/include/HALO_NMM_L_3.inc.html'>HALO_NMM_L_3.inc</A>"<A NAME="HALO_NMM_L_3.inc_24"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2113'>
#endif<a name='2114'>
<font color=#447700>!<a name='2115'></font>
<font color=#447700>!-----------------<a name='2116'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='2117'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2118'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_30">(loadimbal_tim,'after halo L, L2 &amp; L3')<a name='2119'>
#endif<a name='2120'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='2121'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max             &amp;<a name='2122'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='2123'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='2124'></font>
<font color=#447700>!<a name='2125'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_45">()<a name='2126'>
<font color=#447700>!<a name='2127'></font>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_20">(grid,config_flags,'before mass_boundary', &amp;<a name='2128'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2129'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2130'>
            its,ite,jts,jte,kts,kte)<a name='2131'>
      CALL <A href='../../html_code/dyn_nmm/module_BNDRY_COND.F.html#MASS_BOUNDARY'>MASS_BOUNDARY</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MASS_BOUNDARY_1">(GRID%ID,grid%ntsd,GRID%DT,NEST,NUNIT_NBC,NBOCO,LAST_TIME,TSPH &amp;<a name='2132'>
     &amp;          ,LB,grid%eta1,grid%eta2,grid%pdtop,grid%pt,grid%res                              &amp;<a name='2133'>
     &amp;          ,grid%PD_BXS,grid%PD_BXE,grid%PD_BYS,grid%PD_BYE,grid%T_BXS,grid%T_BXE,grid%T_BYS,grid%T_BYE    &amp;<a name='2134'>
     &amp;          ,grid%Q_BXS,grid%Q_BXE,grid%Q_BYS,grid%Q_BYE,grid%U_BXS,grid%U_BXE,grid%U_BYS,grid%U_BYE,grid%V_BXS  &amp;<a name='2135'>
     &amp;          ,grid%V_BXE,grid%V_BYS,grid%V_BYE,grid%Q2_BXS,grid%Q2_BXE,grid%Q2_BYS,grid%Q2_BYE  &amp;<a name='2136'>
     &amp;          ,grid%PD_BTXS,grid%PD_BTXE,grid%PD_BTYS        &amp;<a name='2137'>
     &amp;          ,grid%PD_BTYE,grid%T_BTXS,grid%T_BTXE,grid%T_BTYS,grid%T_BTYE,grid%Q_BTXS,grid%Q_BTXE      &amp;<a name='2138'>
     &amp;          ,grid%Q_BTYS,grid%Q_BTYE,grid%U_BTXS,grid%U_BTXE,grid%U_BTYS,grid%U_BTYE,grid%V_BTXS       &amp;<a name='2139'>
     &amp;          ,grid%V_BTXE,grid%V_BTYS,grid%V_BTYE,grid%Q2_BTXS,grid%Q2_BTXE,grid%Q2_BTYS,grid%Q2_BTYE   &amp;<a name='2140'>
     &amp;          ,grid%pd,grid%t,grid%q,grid%q2,grid%pint &amp;<a name='2141'>
<font color=#447700>!!BEGIN: LSM changes for LANDFALL: Subashini 7/27/2016<a name='2142'></font>
#ifdef IDEAL_NMM_TC<a name='2143'>
     &amp;          ,grid%SM_BXS, grid%SM_BXE, grid%SM_BYS, grid%SM_BYE     &amp; <font color=#447700>! gopal's doing for land motion<a name='2144'></font>
     &amp;          ,grid%SM_BTXS, grid%SM_BTXE, grid%SM_BTYS, grid%SM_BTYE &amp;<a name='2145'>
     &amp;          ,grid%SM                                                &amp;<a name='2146'>
     &amp;          ,grid%THS 						&amp;<a name='2147'>
#endif<a name='2148'>
<font color=#447700>!!END: LSM changes for LANDFALL : Subashini 7/27/2016<a name='2149'></font>
     &amp;          ,GRID%SPEC_BDY_WIDTH,grid%z                             &amp;<a name='2150'>
     &amp;          ,grid%ihe,grid%ihw,grid%ive,grid%ivw                    &amp;<a name='2151'>
     &amp;          ,IDS,IDF,JDS,JDF,KDS,KDE                                &amp;<a name='2152'>
     &amp;          ,IMS,IME,JMS,JME,KMS,KME                                &amp;<a name='2153'>
     &amp;          ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2154'>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_21">(grid,config_flags,'after MASS_BOUNDARY', &amp;<a name='2155'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2156'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2157'>
            its,ite,jts,jte,kts,kte)<a name='2158'>
#if (NMM_NEST==1)<a name='2159'>
      if(ETAMP_PHYSICS) then<a name='2160'>
#endif<a name='2161'>
<font color=#447700>!         write(0,*) 'MP_BULK_BOUNDARY'<a name='2162'></font>
      CALL <A href='../../html_code/dyn_nmm/module_BNDRY_COND.F.html#MP_BULK_BOUNDARY'>MP_BULK_BOUNDARY</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MP_BULK_BOUNDARY_1">(GRID%ID,grid%ntsd,GRID%DT &amp;<a name='2163'>
     &amp;          ,LB,grid%eta1,grid%eta2,grid%pdtop,grid%pt              &amp;<a name='2164'>
     &amp;          ,grid%CWM_BXS,grid%CWM_BXE,grid%CWM_BYS,grid%CWM_BYE    &amp;<a name='2165'>
     &amp;          ,grid%CWM_BTXS,grid%CWM_BTXE,grid%CWM_BTYS,grid%CWM_BTYE&amp;<a name='2166'>
     &amp;          ,grid%q,grid%cwm                                        &amp;<a name='2167'>
     &amp;          ,MOIST,N_MOIST,SCALAR,NUM_SCALAR                        &amp;<a name='2168'>
     &amp;          ,GRID%SPEC_BDY_WIDTH                                    &amp;<a name='2169'>
     &amp;          ,IDS,IDF,JDS,JDF,KDS,KDE                                &amp;<a name='2170'>
     &amp;          ,IMS,IME,JMS,JME,KMS,KME                                &amp;<a name='2171'>
     &amp;          ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2172'>
#if (NMM_NEST==1)<a name='2173'>
      else<a name='2174'>
         CALL <A href='../../html_code/dyn_nmm/module_BNDRY_COND.F.html#MP_SPECIES_BDY'>MP_SPECIES_BDY</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MP_SPECIES_BDY_1">(grid%id,1,grid%dt,               &amp;<a name='2175'>
              grid%CWM,grid%Q,                                &amp;<a name='2176'>
              MOIST,N_MOIST,                                  &amp;<a name='2177'>
              MOIST_bxs,MOIST_bxe,MOIST_bys,MOIST_bye,        &amp;<a name='2178'>
              MOIST_btxs,MOIST_btxe,MOIST_btys,MOIST_btye,    &amp;<a name='2179'>
              SCALAR,NUM_SCALAR,                              &amp;<a name='2180'>
              SCALAR_bxs,SCALAR_bxe,SCALAR_bys,SCALAR_bye,    &amp;<a name='2181'>
              SCALAR_btxs,SCALAR_btxe,SCALAR_btys,SCALAR_btye,&amp;<a name='2182'>
              ids,idf,jds,jdf,kds,kde,                        &amp;<a name='2183'>
              ims,ime,jms,jme,kms,kme,                        &amp;<a name='2184'>
              its,ite,jts,jte,kts,kte)<a name='2185'>
      endif<a name='2186'>
#endif<a name='2187'>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_22">(grid,config_flags,'after boundaries', &amp;<a name='2188'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2189'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2190'>
            its,ite,jts,jte,kts,kte)<a name='2191'>
<font color=#447700>!<a name='2192'></font>
      bocoh_tim=bocoh_tim+now_time()-btimx<a name='2193'>
<font color=#447700>!     if(mod(grid%ntsd,n_print_time)==0)then<a name='2194'></font>
<font color=#447700>!       call twr(grid%t,0,'grid%t',grid%ntsd,mype,npes,mpi_comm_comp &amp;<a name='2195'></font>
<font color=#447700>!    &amp;          ,ids,ide,jds,jde,kds,kde                               &amp;<a name='2196'></font>
<font color=#447700>!    &amp;          ,ims,ime,jms,jme,kms,kme                               &amp;<a name='2197'></font>
<font color=#447700>!    &amp;          ,its,ite,jts,jte,kts,kte)<a name='2198'></font>
<font color=#447700>!     endif<a name='2199'></font>
<font color=#447700>!<a name='2200'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2201'></font>
<font color=#447700>!***  IS IT TIME FOR A CHECK POINT ON THE MODEL HISTORY FILE?<a name='2202'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2203'></font>
<font color=#447700>!<a name='2204'></font>
 2003 CONTINUE<a name='2205'>
<font color=#447700>!<a name='2206'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2207'></font>
<font color=#447700>!***  PRESSURE GRD, CORIOLIS, DIVERGENCE, AND HORIZ PART OF OMEGA-ALPHA<a name='2208'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2209'></font>
<font color=#447700>!<a name='2210'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2211'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_31">(loadimbal_tim,'after h bdy')<a name='2212'>
#endif<a name='2213'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_46">()<a name='2214'>
<font color=#447700>!-----------------<a name='2215'></font>
#ifdef DM_PARALLEL<a name='2216'>
#    include "<A href='../../html_code/include/HALO_NMM_A.inc.html'>HALO_NMM_A.inc</A>"<A NAME="HALO_NMM_A.inc_25"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2217'>
#endif<a name='2218'>
<font color=#447700>!<a name='2219'></font>
#ifdef DM_PARALLEL<a name='2220'>
      IF (ETAMP_PHYSICS) THEN<a name='2221'>
#    include "<A href='../../html_code/include/HALO_NMM_A_3.inc.html'>HALO_NMM_A_3.inc</A>"<A NAME="HALO_NMM_A_3.inc_26"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2222'>
      ENDIF<a name='2223'>
#endif<a name='2224'>
<font color=#447700>!<a name='2225'></font>
<font color=#447700>!-----------------<a name='2226'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='2227'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2228'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_32">(loadimbal_tim,'after halo A, A2 and A3 after h bdy')<a name='2229'>
#endif<a name='2230'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='2231'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max             &amp;<a name='2232'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='2233'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='2234'></font>
<font color=#447700>!<a name='2235'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_47">()<a name='2236'>
<font color=#447700>!<a name='2237'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_23">(grid,config_flags,'before PFDHT', &amp;<a name='2238'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2239'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2240'>
            its,ite,jts,jte,kts,kte)<a name='2241'>
      CALL <A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#PFDHT'>PFDHT</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PFDHT_1">(grid%ntsd,LAST_TIME,grid%pt,grid%deta1,grid%deta2,grid%pdtop,grid%res,grid%fis           &amp;<a name='2242'>
     &amp;          ,grid%hydro,GRID%SIGMA,FIRST,grid%dx_nmm,grid%dy_nmm                  &amp;<a name='2243'>
     &amp;          ,grid%hbm2,grid%vbm2,grid%vbm3                                        &amp;<a name='2244'>
     &amp;          ,grid%fdiv,grid%fcp,grid%wpdar,grid%dfl,grid%cpgfu,grid%cpgfv                        &amp;<a name='2245'>
     &amp;          ,grid%pd,grid%pdsl,grid%t,grid%q,grid%u,grid%v,grid%cwm,grid%omgalf,grid%pint,grid%dwdt                  &amp;<a name='2246'>
     &amp;          ,grid%rtop,grid%div,grid%few,grid%fns,grid%fne,grid%fse                              &amp;<a name='2247'>
     &amp;          ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                       &amp;<a name='2248'>
     &amp;          ,IDS,IDF,JDS,JDF,KDS,KDE                               &amp;<a name='2249'>
     &amp;          ,IMS,IME,JMS,JME,KMS,KME                               &amp;<a name='2250'>
     &amp;          ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2251'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_24">(grid,config_flags,'after PFDHT', &amp;<a name='2252'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2253'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2254'>
            its,ite,jts,jte,kts,kte)<a name='2255'>
<a name='2256'>
<font color=#447700>!<a name='2257'></font>
      pfdht_tim=pfdht_tim+now_time()-btimx<a name='2258'>
<font color=#447700>!<a name='2259'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2260'></font>
<font color=#447700>!***  DIVERGENCE DAMPING<a name='2261'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2262'></font>
<font color=#447700>!<a name='2263'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2264'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_33">(loadimbal_tim,'after pfdht')<a name='2265'>
#endif<a name='2266'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_48">()<a name='2267'>
<font color=#447700>!-----------------<a name='2268'></font>
#ifdef DM_PARALLEL<a name='2269'>
#    include "<A href='../../html_code/include/HALO_NMM_B.inc.html'>HALO_NMM_B.inc</A>"<A NAME="HALO_NMM_B.inc_27"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2270'>
#endif<a name='2271'>
<font color=#447700>!-----------------<a name='2272'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='2273'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2274'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_34">(loadimbal_tim,'after halo B after pfdht')<a name='2275'>
#endif<a name='2276'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='2277'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max            &amp;<a name='2278'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='2279'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='2280'></font>
<font color=#447700>!<a name='2281'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_49">()<a name='2282'>
<font color=#447700>!<a name='2283'></font>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_25">(grid,config_flags,'before DDAMP', &amp;<a name='2284'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2285'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2286'>
            its,ite,jts,jte,kts,kte)<a name='2287'>
      CALL <A href='../../html_code/dyn_nmm/module_IGWAVE_ADJUST.F.html#DDAMP'>DDAMP</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DDAMP_1">(grid%ntsd,GRID%DT,grid%deta1,grid%deta2,grid%pdsl      &amp;<a name='2288'>
     &amp;          ,grid%pdtop,grid%div,grid%hbm2                          &amp;<a name='2289'>
     &amp;          ,grid%t,grid%u,grid%v,grid%ddmpu,grid%ddmpv             &amp;<a name='2290'>
     &amp;          ,grid%ihe,grid%ihw,grid%ive,grid%ivw                    &amp;<a name='2291'>
     &amp;          ,IDS,IDF,JDS,JDF,KDS,KDE                                &amp;<a name='2292'>
     &amp;          ,IMS,IME,JMS,JME,KMS,KME                                &amp;<a name='2293'>
     &amp;          ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2294'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_26">(grid,config_flags,'after DDAMP', &amp;<a name='2295'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2296'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2297'>
            its,ite,jts,jte,kts,kte)<a name='2298'>
<font color=#447700>!<a name='2299'></font>
      ddamp_tim=ddamp_tim+now_time()-btimx<a name='2300'>
<font color=#447700>!<a name='2301'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2302'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2303'></font>
<font color=#447700>!<a name='2304'></font>
      IF(FIRST.AND.grid%ntsd==0)THEN<a name='2305'>
        FIRST=.FALSE.<a name='2306'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2307'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_35">(loadimbal_tim,'after ddamp')<a name='2308'>
#endif<a name='2309'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_50">()<a name='2310'>
<font color=#447700>!-----------------<a name='2311'></font>
<font color=#447700>!!#ifdef DM_PARALLEL<a name='2312'></font>
<font color=#447700>!!#    include "HALO_NMM_A.inc"<a name='2313'></font>
<font color=#447700>!!#endif<a name='2314'></font>
<font color=#447700>!-----------------<a name='2315'></font>
        exch_tim=exch_tim+now_time()-btimx<a name='2316'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2317'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_36">(loadimbal_tim,'after halo A &amp; A2 after ddamp')<a name='2318'>
#endif<a name='2319'>
<font color=#447700>!       this_tim=now_time()-btimx<a name='2320'></font>
<font color=#447700>!       call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max          &amp;<a name='2321'></font>
<font color=#447700>!    &amp;                    ,mpi_comm_comp,irtn)<a name='2322'></font>
<font color=#447700>!       exch_tim_max=exch_tim_max+et_max<a name='2323'></font>
<font color=#447700>!<a name='2324'></font>
        GO TO 2000<a name='2325'>
      ENDIF<a name='2326'>
<font color=#447700>!<a name='2327'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2328'></font>
<font color=#447700>!***  UPDATING BOUNDARY VALUES AT VELOCITY POINTS<a name='2329'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2330'></font>
<font color=#447700>!<a name='2331'></font>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2332'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_37">(loadimbal_tim,'after ddamp again')<a name='2333'>
#endif<a name='2334'>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_51">()<a name='2335'>
<font color=#447700>!-----------------<a name='2336'></font>
#ifdef DM_PARALLEL<a name='2337'>
#    include "<A href='../../html_code/include/HALO_NMM_C.inc.html'>HALO_NMM_C.inc</A>"<A NAME="HALO_NMM_C.inc_28"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2338'>
#endif<a name='2339'>
<font color=#447700>!-----------------<a name='2340'></font>
      exch_tim=exch_tim+now_time()-btimx<a name='2341'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2342'>
      call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF'>blockf</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLOCKF_38">(loadimbal_tim,'after halo C after ddamp')<a name='2343'>
#endif<a name='2344'>
<font color=#447700>!     this_tim=now_time()-btimx<a name='2345'></font>
<font color=#447700>!     call mpi_allreduce(this_tim,et_max,1,mpi_real,mpi_max            &amp;<a name='2346'></font>
<font color=#447700>!    &amp;                  ,mpi_comm_comp,irtn)<a name='2347'></font>
<font color=#447700>!     exch_tim_max=exch_tim_max+et_max<a name='2348'></font>
<font color=#447700>!<a name='2349'></font>
      btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_52">()<a name='2350'>
<font color=#447700>!<a name='2351'></font>
      CALL <A href='../../html_code/dyn_nmm/module_BNDRY_COND.F.html#BOCOV'>BOCOV</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOCOV_1">(GRID%ID,grid%ntsd,GRID%DT,LB,grid%U_BXS,grid%U_BXE,grid%U_BYS,grid%U_BYE,grid%V_BXS &amp;<a name='2352'>
     &amp;          ,grid%V_BXE,grid%V_BYS,grid%V_BYE,grid%U_BTXS,grid%U_BTXE,grid%U_BTYS,grid%U_BTYE,grid%V_BTXS  &amp;<a name='2353'>
     &amp;          ,grid%V_BTXE,grid%V_BTYS,grid%V_BTYE,grid%u,grid%v                              &amp;<a name='2354'>
     &amp;          ,GRID%SPEC_BDY_WIDTH                                   &amp;<a name='2355'>
     &amp;          ,grid%ihe,grid%ihw,grid%ive,grid%ivw                                       &amp;<a name='2356'>
     &amp;          ,IDS,IDF,JDS,JDF,KDS,KDE                               &amp;<a name='2357'>
     &amp;          ,IMS,IME,JMS,JME,KMS,KME                               &amp;<a name='2358'>
     &amp;          ,ITS,ITE,JTS,JTE,KTS,KTE )<a name='2359'>
 <a name='2360'>
<font color=#447700>!<a name='2361'></font>
      bocov_tim=bocov_tim+now_time()-btimx<a name='2362'>
<font color=#447700>!<a name='2363'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2364'></font>
<font color=#447700>!***  COPY THE NMM VARIABLE grid%q2 TO THE WRF VARIABLE grid%tke_pbl<a name='2365'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2366'></font>
<font color=#447700>!<a name='2367'></font>
      DO K=KTS,KTE<a name='2368'>
      DO J=JTS,JTE<a name='2369'>
      DO I=ITS,ITE<a name='2370'>
        grid%tke_pbl(I,J,K)=0.5*grid%q2(I,J,K) <font color=#447700>!TKE is grid%q squared over 2<a name='2371'></font>
      ENDDO<a name='2372'>
      ENDDO<a name='2373'>
      ENDDO<a name='2374'>
<a name='2375'>
<font color=#447700>! calculate some model diagnostics.<a name='2376'></font>
<a name='2377'>
   IF ( config_flags%compute_radar_ref .EQ. 1 ) THEN<a name='2378'>
   CALL wrf_debug ( 200 , ' call diagnostic_driver' )<a name='2379'>
<a name='2380'>
   call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_27">(grid,config_flags,'before diag o c r', &amp;<a name='2381'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2382'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2383'>
            its,ite,jts,jte,kts,kte)<a name='2384'>
   CALL <A href='../../html_code/phys/module_diag_refl.F.html#DIAGNOSTIC_OUTPUT_CALC_REFL'>diagnostic_output_calc_refl</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSTIC_OUTPUT_CALC_REFL_1">(                                   &amp;<a name='2385'>
      &amp;              DIAGFLAG=diag_flag                                &amp;<a name='2386'>
      &amp;             ,REFD_MAX=grid%refd_max                            &amp;<a name='2387'>
      &amp;             ,refl_10cm=grid%refl_10cm                          &amp;<a name='2388'>
      &amp;             ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &amp;<a name='2389'>
      &amp;             ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &amp;<a name='2390'>
      &amp;             ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &amp;<a name='2391'>
      &amp;                                                          )<a name='2392'>
   call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID'>check_grid</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_GRID_28">(grid,config_flags,'after diag o c r', &amp;<a name='2393'>
            ids,ide,jds,jde,kds,kde, &amp;<a name='2394'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='2395'>
            its,ite,jts,jte,kts,kte)<a name='2396'>
   END IF<a name='2397'>
<a name='2398'>
<font color=#447700>!<a name='2399'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2400'></font>
<font color=#447700>!<a name='2401'></font>
      IF(LAST_TIME.AND.ALLOCATED(PPTDAT))THEN<a name='2402'>
        DEALLOCATE(PPTDAT,STAT=ISTAT)<a name='2403'>
      ENDIF<a name='2404'>
<font color=#447700>!<a name='2405'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2406'></font>
<font color=#447700>!<a name='2407'></font>
      solve_tim=solve_tim+now_time()-ttim<a name='2408'>
      ttim=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_53">()<a name='2409'>
<font color=#447700>!<a name='2410'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2411'></font>
<font color=#447700>!***  PRINT TIMING VARIABLES WHEN DESIRED.<a name='2412'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2413'></font>
<font color=#447700>!<a name='2414'></font>
      sum_tim=pdte_tim+adve_tim+vtoa_tim+vadz_tim+hadz_tim+eps_tim     &amp;<a name='2415'>
     &amp;       +vad2_tim+had2_tim+radiation_tim+rdtemp_tim+turbl_tim     &amp;<a name='2416'>
     &amp;       +cltend_tim+cucnvc_tim+gsmdrive_tim+hdiff_tim             &amp;<a name='2417'>
     &amp;       +bocoh_tim+pfdht_tim+ddamp_tim+bocov_tim+uv_htov_tim      &amp;<a name='2418'>
     &amp;       +exch_tim+adjppt_tim<a name='2419'>
#if defined(NMM_FIND_LOAD_IMBALANCE)<a name='2420'>
      sum_tim=sum_tim + loadimbal_tim + previmbal_tim<a name='2421'>
#endif<a name='2422'>
<font color=#447700>!<a name='2423'></font>
      if(mod(grid%ntsd,n_print_time)==0)then<a name='2424'>
        sum_tim = adjppt_tim + exch_tim + pdte_tim + adve_tim + vtoa_tim + &amp;<a name='2425'>
             vadz_tim + hadz_tim + eps_tim + vad2_tim + had2_tim +         &amp;<a name='2426'>
             radiation_tim + rdtemp_tim + turbl_tim + cltend_tim +         &amp;<a name='2427'>
             cucnvc_tim + gsmdrive_tim + hdiff_tim + bocoh_tim +           &amp;<a name='2428'>
             pfdht_tim + ddamp_tim + bocov_tim + uv_htov_tim + diag_tim +  &amp;<a name='2429'>
             tornado_tim<a name='2430'>
#if ( HWRF == 1 )<a name='2431'>
        sum_tim = sum_tim + sst_tim + flux_tim + hifreq_tim + wav_tim + cplstep_tim<a name='2432'>
#endif<a name='2433'>
#if defined(NMM_FIND_LOAD_IMBALANCE)<a name='2434'>
        sum_tim=sum_tim + loadimbal_tim + previmbal_tim<a name='2435'>
#endif<a name='2436'>
<font color=#447700>!<a name='2437'></font>
17      format(A16,F13.6,A5,F7.3,'%')<a name='2438'>
        write(message,*)' grid%ntsd=',grid%ntsd,' solve_tim=',solve_tim    &amp;<a name='2439'>
     &amp;           ,' sum_tim=',sum_tim<a name='2440'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_200">(trim(message))<a name='2441'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2442'>
        write(message,*)' running on cpu ',cpu<a name='2443'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_201">(trim(message))<a name='2444'>
#endif<a name='2445'>
        write(message,17)' pdte_tim=',pdte_tim,' pct=',pdte_tim/sum_tim*100.<a name='2446'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_202">(trim(message))<a name='2447'>
        write(message,17)' adve_tim=',adve_tim,' pct=',adve_tim/sum_tim*100.<a name='2448'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_203">(trim(message))<a name='2449'>
        write(message,17)' vtoa_tim=',vtoa_tim,' pct=',vtoa_tim/sum_tim*100.<a name='2450'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_204">(trim(message))<a name='2451'>
        write(message,17)' vadz_tim=',vadz_tim,' pct=',vadz_tim/sum_tim*100.<a name='2452'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_205">(trim(message))<a name='2453'>
        write(message,17)' hadz_tim=',hadz_tim,' pct=',hadz_tim/sum_tim*100.<a name='2454'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_206">(trim(message))<a name='2455'>
        write(message,17)' eps_tim=',eps_tim,' pct=',eps_tim/sum_tim*100.<a name='2456'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_207">(trim(message))<a name='2457'>
        write(message,17)' vad2_tim=',vad2_tim,' pct=',vad2_tim/sum_tim*100.<a name='2458'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_208">(trim(message))<a name='2459'>
        write(message,17)' had2_tim=',had2_tim,' pct=',had2_tim/sum_tim*100.<a name='2460'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_209">(trim(message))<a name='2461'>
        write(message,17)' radiation_tim=',radiation_tim,' pct=',radiation_tim/sum_tim*100.<a name='2462'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_210">(trim(message))<a name='2463'>
        write(message,17)' rdtemp_tim=',rdtemp_tim,' pct=',rdtemp_tim/sum_tim*100.<a name='2464'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_211">(trim(message))<a name='2465'>
        write(message,17)' turbl_tim=',turbl_tim,' pct=',turbl_tim/sum_tim*100.<a name='2466'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_212">(trim(message))<a name='2467'>
        write(message,17)' cltend_tim=',cltend_tim,' pct=',cltend_tim/sum_tim*100.<a name='2468'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_213">(trim(message))<a name='2469'>
        write(message,17)' cucnvc_tim=',cucnvc_tim,' pct=',cucnvc_tim/sum_tim*100.<a name='2470'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_214">(trim(message))<a name='2471'>
        write(message,17)' gsmdrive_tim=',gsmdrive_tim,' pct=',gsmdrive_tim/sum_tim*100.<a name='2472'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_215">(trim(message))<a name='2473'>
        write(message,17)' adjppt_tim=',adjppt_tim,' pct=',adjppt_tim/sum_tim*100.<a name='2474'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_216">(trim(message))<a name='2475'>
        write(message,17)' hdiff_tim=',hdiff_tim,' pct=',hdiff_tim/sum_tim*100.<a name='2476'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_217">(trim(message))<a name='2477'>
        write(message,17)' bocoh_tim=',bocoh_tim,' pct=',bocoh_tim/sum_tim*100.<a name='2478'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_218">(trim(message))<a name='2479'>
        write(message,17)' pfdht_tim=',pfdht_tim,' pct=',pfdht_tim/sum_tim*100.<a name='2480'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_219">(trim(message))<a name='2481'>
        write(message,17)' ddamp_tim=',ddamp_tim,' pct=',ddamp_tim/sum_tim*100.<a name='2482'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_220">(trim(message))<a name='2483'>
        write(message,17)' bocov_tim=',bocov_tim,' pct=',bocov_tim/sum_tim*100.<a name='2484'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_221">(trim(message))<a name='2485'>
        write(message,17)' uv_h_to_v_tim=',uv_htov_tim,' pct=',uv_htov_tim/sum_tim*100.<a name='2486'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_222">(trim(message))<a name='2487'>
        write(message,17)' exch_tim=',exch_tim,' pct=',exch_tim/sum_tim*100.<a name='2488'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_223">(trim(message))<a name='2489'>
        write(message,17)' diag_tim=',diag_tim,' pct=',diag_tim/sum_tim*100.<a name='2490'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_224">(trim(message))<a name='2491'>
        write(message,17)' tornado_tim=',tornado_tim,' pct=',tornado_tim/sum_tim*100.<a name='2492'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_225">(trim(message))<a name='2493'>
#if ( HWRF == 1 )<a name='2494'>
        write(message,17)' sst_tim=',sst_tim,' pct=',sst_tim/sum_tim*100.<a name='2495'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_226">(trim(message))<a name='2496'>
        write(message,17)' cplstep_tim=',cplstep_tim,' pct=',cplstep_tim/sum_tim*100.<a name='2497'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_227">(trim(message))<a name='2498'>
        write(message,17)' wav_tim=',wav_tim,' pct=',wav_tim/sum_tim*100.<a name='2499'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_228">(trim(message))<a name='2500'>
        write(message,17)' flux_tim=',flux_tim,' pct=',flux_tim/sum_tim*100.<a name='2501'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_229">(trim(message))<a name='2502'>
        write(message,17)' hifreq_tim=',hifreq_tim,' pct=',hifreq_tim/sum_tim*100.<a name='2503'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_230">(trim(message))<a name='2504'>
#endif<a name='2505'>
#ifdef NMM_FIND_LOAD_IMBALANCE<a name='2506'>
        write(message,17)' loadimbal_tim=',loadimbal_tim,' pct=',loadimbal_tim/sum_tim*100.<a name='2507'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_231">(trim(message))<a name='2508'>
        write(message,17)' previmbal_tim=',previmbal_tim,' pct=',previmbal_tim/sum_tim*100.<a name='2509'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_232">(trim(message))<a name='2510'>
#endif<a name='2511'>
<a name='2512'>
<font color=#447700>!        call time_stats(exch_tim,'exchange',grid%ntsd,mype,npes,mpi_comm_comp)<a name='2513'></font>
<font color=#447700>!        write(message,17)' exch_tim_max=',exch_tim_max<a name='2514'></font>
<font color=#447700>!        call wrf_message(trim(message))<a name='2515'></font>
<font color=#447700>!<a name='2516'></font>
        call <A href='../../html_code/dyn_nmm/solve_nmm.F.html#FIELD_STATS'>field_stats</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIELD_STATS_1">(grid%t,mype,mpi_comm_comp                          &amp;<a name='2517'>
     &amp;                  ,ids,ide,jds,jde,kds,kde                       &amp;<a name='2518'>
     &amp;                  ,ims,ime,jms,jme,kms,kme                       &amp;<a name='2519'>
     &amp;                  ,its,ite,jts,jte,kts,kte)<a name='2520'>
      endif<a name='2521'>
<font color=#447700>!<a name='2522'></font>
<font color=#447700>!     if(last_time)then<a name='2523'></font>
      DEALLOCATE(TTEN,STAT=ISTAT)<a name='2524'>
      DEALLOCATE(QTEN,STAT=ISTAT)<a name='2525'>
      DEALLOCATE(RTHRATEN,STAT=ISTAT)<a name='2526'>
      DEALLOCATE(RTHBLTEN,STAT=ISTAT)<a name='2527'>
      DEALLOCATE(RQVBLTEN,STAT=ISTAT)<a name='2528'>
<font color=#447700>!<a name='2529'></font>
<font color=#447700>! FOR VORTEX FOLLOWING MOVING NEST<a name='2530'></font>
<font color=#447700>!<a name='2531'></font>
<a name='2532'>
<a name='2533'>
<a name='2534'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2535'></font>
<font color=#447700>!***  CRITERIA SET FOR GRID MOTION. This is gopal's doing<a name='2536'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2537'></font>
<font color=#447700>!<a name='2538'></font>
#ifdef MOVE_NESTS<a name='2539'>
   IF ( grid%num_moves.EQ.-99 ) THEN<a name='2540'>
     btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_54">()<a name='2541'>
      call <A href='../../html_code/dyn_nmm/module_STATS_FOR_MOVE.F.html#STATS_FOR_MOVE'>stats_for_move</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STATS_FOR_MOVE_1">(grid,config_flags &amp;<a name='2542'>
                         ,IDS,IDE,JDS,JDE,KDS,KDE &amp;<a name='2543'>
                         ,IMS,IME,JMS,JME,KMS,KME &amp;<a name='2544'>
                         ,IPS,IPE,JPS,JPE,KPS,KPE &amp;<a name='2545'>
                         ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2546'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_130"> ( 100 , 'nmm stats_for_move: after advection' )<a name='2547'>
     diag_tim=diag_tim+now_time()-btimx<a name='2548'>
   ENDIF<a name='2549'>
#endif<a name='2550'>
#if ( HWRF == 1 )<a name='2551'>
   hwrfx_mlsp: if(grid%vortex_tracker /= 1) then<a name='2552'>
     btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_55">()<a name='2553'>
<a name='2554'>
<font color=#447700>!    output MSLP over parent domain for diagonostic purposes. outputs are hourly.<a name='2555'></font>
<font color=#447700>!    This is gopal's doing<a name='2556'></font>
<a name='2557'>
     IF(grid%id .EQ. 1 .AND. MOD(grid%NTSD,n_print_time)==0)THEN<a name='2558'>
      call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_131">(1,'COMPUTING MSLP OVER THE PARENT DOMAIN')<a name='2559'>
<a name='2560'>
      CALL <A href='../../html_code/dyn_nmm/module_NEST_UTIL.F.html#MSLP_DIAG'>MSLP_DIAG</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MSLP_DIAG_2"> (grid%MSLP,grid%PINT,grid%T,grid%Q                &amp;<a name='2561'>
                     ,grid%FIS,grid%PD,grid%DETA1,grid%DETA2,grid%PDTOP     &amp;<a name='2562'>
                     ,IDS,IDF,JDS,JDF,KDS,KDE      &amp;<a name='2563'>
                     ,IMS,IME,JMS,JME,KMS,KME      &amp;<a name='2564'>
                     ,ITS,ITE,JTS,JTE,KTS,KTE      )<a name='2565'>
     ENDIF<a name='2566'>
<a name='2567'>
     diag_tim=diag_tim+now_time()-btimx<a name='2568'>
   endif hwrfx_mlsp<a name='2569'>
#endif<a name='2570'>
<font color=#447700>!!BEGIN: LSM changes for LANDFALL: Subashini 7/27/2016<a name='2571'></font>
#ifdef IDEAL_NMM_TC<a name='2572'>
<a name='2573'>
     IF(grid%NTSD==0 .and. grid%id .gt. 1)THEN  <font color=#447700>! Initialize some variables<a name='2574'></font>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_132">(1,'NESTS INITIALIZED TO WATER WORLD')<a name='2575'>
           grid%sm=1.0    <font color=#447700>! Initialize a water world in the nests<a name='2576'></font>
     ENDIF<a name='2577'>
<font color=#447700>!<a name='2578'></font>
     move_land_time=nint(1200./30) <font color=#447700>! This needs to be changed for different parent domain resolution &amp; dt.  Subashini V1.0 7.13.2016<a name='2579'></font>
<a name='2580'>
     IF(MOD(grid%NTSD,move_land_time)==0)THEN    <font color=#447700>! n_print_time<a name='2581'></font>
<a name='2582'>
       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_133">(1,'LAND ADVECTED W2E FOR IDEALIZED LSM')<a name='2583'>
<a name='2584'>
#ifdef DM_PARALLEL<a name='2585'>
#    include "<A href='../../html_code/include/HALO_NMM_INIT_3.inc.html'>HALO_NMM_INIT_3.inc</A>"<A NAME="HALO_NMM_INIT_3.inc_29"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2586'>
#endif<a name='2587'>
<font color=#447700>!open ideal_land.nml for namelist values<a name='2588'></font>
<a name='2589'>
      open(8,FILE='land.nml')<a name='2590'>
      read(UNIT=8,NML=param_land)<a name='2591'>
      close(UNIT=8)<a name='2592'>
<a name='2593'>
       CALL <A href='../../html_code/dyn_nmm/module_NEST_UTIL.F.html#MOVE_LAND'>MOVE_LAND</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOVE_LAND_1"> (grid%SM,grid%nmm_tsk        &amp;<a name='2594'>
                      ,grid%SST,grid%FIS           &amp;<a name='2595'>
                      ,grid%PINT,grid%T,grid%Q     &amp;<a name='2596'>
                      ,grid%NTSD                   &amp;<a name='2597'>
                      ,IDS,IDE,JDS,JDE,KDS,KDE     &amp;<a name='2598'>
                      ,IMS,IME,JMS,JME,KMS,KME     &amp;<a name='2599'>
                      ,ITS,ITE,JTS,JTE,KTS,KTE,DIRN)<a name='2600'>
<a name='2601'>
<font color=#447700>!For diurnal temp changes - comment out for constant temperature and<a name='2602'></font>
<font color=#447700>!uncomment  temperature fix in module_surface_driver.F and<a name='2603'></font>
<font color=#447700>!module_radiation_driver.F<a name='2604'></font>
<a name='2605'>
     IF(DIRN == 1) THEN<a name='2606'>
      DO J = JMS, JME<a name='2607'>
       DO I = IMS,IME<a name='2608'>
        if(grid%SM(I,J) .le. 0.5)then<a name='2609'>
         grid%nmm_tsk(I,J)=grid%nmm_tsk(I-1,J)<a name='2610'>
         grid%albedo(I,J)=land_albedo<a name='2611'>
         grid%epsr(I,J)=land_emiss<a name='2612'>
         grid%isltyp(I,J)=SOIL_ID<a name='2613'>
         grid%ivgtyp(I,J)=VEG_ID<a name='2614'>
         grid%vegfrc(I,J)=land_vgfrac<a name='2615'>
         grid%z0(I,J)=land_z0<a name='2616'>
         DO K = 1,grid%num_soil_layers<a name='2617'>
         grid%smc(I,K,J)=land_smc<a name='2618'>
         ENDDO<a name='2619'>
        endif<a name='2620'>
       ENDDO<a name='2621'>
      ENDDO<a name='2622'>
     ELSE IF(DIRN == 2) THEN<a name='2623'>
      DO J = JMS, JME<a name='2624'>
       DO I = IME,IMS, -1<a name='2625'>
        if(grid%SM(I,J) .le. 0.5)then<a name='2626'>
         grid%nmm_tsk(I,J)=grid%nmm_tsk(I+1,J)<a name='2627'>
         grid%albedo(I,J)=land_albedo<a name='2628'>
         grid%epsr(I,J)=land_emiss<a name='2629'>
         grid%isltyp(I,J)=SOIL_ID<a name='2630'>
         grid%ivgtyp(I,J)=VEG_ID<a name='2631'>
         grid%vegfrc(I,J)=land_vgfrac<a name='2632'>
         grid%z0(I,J)=land_z0<a name='2633'>
         DO K = 1,grid%num_soil_layers<a name='2634'>
         grid%smc(I,K,J)=land_smc<a name='2635'>
         ENDDO<a name='2636'>
        endif<a name='2637'>
       ENDDO<a name='2638'>
      ENDDO<a name='2639'>
     ELSE<a name='2640'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_139"> ('Choose between 1 or 2 in land.nml')<a name='2641'>
     ENDIF<a name='2642'>
<a name='2643'>
     ENDIF<a name='2644'>
<a name='2645'>
#endif<a name='2646'>
<font color=#447700>!!END: LSM changes for LANDFALL : Subashini 7/27/2016<a name='2647'></font>
<a name='2648'>
<font color=#447700>!#define COPY_OUT<a name='2649'></font>
<font color=#447700>!#include "scalar_derefs.inc"<a name='2650'></font>
#if ( HWRF == 1 )<a name='2651'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2652'></font>
<font color=#447700>!*** ACCUMULATED ATMOSPHERIC MODEL FLUXES FOR DMITRYs COUPLER<a name='2653'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2654'></font>
<font color=#447700>!<a name='2655'></font>
<font color=#447700>!<a name='2656'></font>
<font color=#447700>!<a name='2657'></font>
      CALL nl_get_multi_storm(1,multi_storm)<a name='2658'>
      CALL nl_get_no_ocean(1,no_ocean)<a name='2659'>
      IF ( .NOT. multi_storm .OR. no_ocean ) THEN<a name='2660'>
        write(message,*)' No Ocean Coupling Run'<a name='2661'>
        call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_134">(1,trim(message))<a name='2662'>
      ELSE<a name='2663'>
<font color=#447700>! Coupling insertion:-&gt;<a name='2664'></font>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_56">()<a name='2665'>
        call ATM_SENDFLUXES<a name='2666'>
        CALL atm_sendwindp  <a name='2667'>
        flux_tim=flux_tim+now_time()-btimx<a name='2668'>
<font color=#447700>!&lt;-:Coupling insertion<a name='2669'></font>
<font color=#447700>!<a name='2670'></font>
<font color=#447700>! Kwon's doing to check heat flux<a name='2671'></font>
<font color=#447700>!<a name='2672'></font>
<font color=#447700>!  IF(grid%id==2)WRITE(0,*)'AFTER ATM_SENDFLUX grid%qwbs grid%twbs AT 10 10 ',grid%ntsd,grid%qwbs(10,10),grid%twbs(10,10)<a name='2673'></font>
<font color=#447700>!<a name='2674'></font>
      ENDIF<a name='2675'>
#endif<a name='2676'>
<a name='2677'>
<font color=#447700>!--------------------------------------------------------------------------------------------------------------<a name='2678'></font>
<font color=#447700>!<a name='2679'></font>
<font color=#447700>!      HIGH FREQUENCY OUTPUT    (STORM CENTER, MIN MSLP, MAX WINDS, TG products)<a name='2680'></font>
<font color=#447700>!          FOR NEST DOMAIN (9KM)        KWON 2011.4, TRAHAN 2011.6, 2014.1<a name='2681'></font>
<font color=#447700>!<a name='2682'></font>
<font color=#447700>!--------------------------------------------------------------------------------------------------------------<a name='2683'></font>
<font color=#447700>!<a name='2684'></font>
     IF(grid%ntornado&gt;0 .and. mod(grid%NTSD,grid%ntornado)==0) then<a name='2685'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_57">()<a name='2686'>
        CALL <A href='../../html_code/dyn_nmm/module_tornado_genesis.F.html#CALC_TORNADO_GENESIS'>CALC_TORNADO_GENESIS</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_TORNADO_GENESIS_1">(GRID,CONFIG_FLAGS)<a name='2687'>
        tornado_tim=tornado_tim+now_time()-btimx<a name='2688'>
     ENDIF<a name='2689'>
<a name='2690'>
#if ( HWRF == 1 )<a name='2691'>
     IF(grid%ntornado==0 .or. mod(grid%NTSD,grid%ntornado)==0) then<a name='2692'>
      have_best: if(size(grid%best_mslp)&gt;1) then<a name='2693'>
         have_membrane: if(size(grid%membrane_mslp)&gt;1) then<a name='2694'>
            call <A href='../../html_code/dyn_nmm/module_NEST_UTIL.F.html#CALC_BEST_MSLP'>CALC_BEST_MSLP</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_BEST_MSLP_1">(grid%best_mslp,grid%mslp, &amp;<a name='2695'>
                 grid%membrane_mslp,grid%fis, &amp;<a name='2696'>
                 IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='2697'>
                 IMS,IME,JMS,JME,KMS,KME, &amp;<a name='2698'>
                 ITS,ITE,JTS,JTE,KTS,KTE)<a name='2699'>
         else<a name='2700'>
            <font color=#447700>! In absence of the Membrane MSLP, the Schuell is all we<a name='2701'></font>
            <font color=#447700>! have, so it is the best by proxy:<a name='2702'></font>
            do j=jps,min(jde-1,jpe)<a name='2703'>
               do i=ips,min(ide-1,ipe)<a name='2704'>
                  grid%best_mslp(i,j)=grid%mslp(i,j)<a name='2705'>
               enddo<a name='2706'>
            enddo<a name='2707'>
         endif have_membrane<a name='2708'>
      endif have_best<a name='2709'>
     ENDIF<a name='2710'>
<a name='2711'>
     IF(grid%hifreq_lun /= 0) THEN<a name='2712'>
        btimx=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_58">()<a name='2713'>
        CALL <A href='../../html_code/dyn_nmm/module_HIFREQ.F.html#HIFREQ_WRITE'>HIFREQ_WRITE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SOLVE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HIFREQ_WRITE_1">(grid%hifreq_lun,GRID%NTSD,GRID%DT,GRID%HLAT,GRID%HLON    &amp;<a name='2714'>
                      ,GRID%U10,GRID%V10,grid%pint,grid%t,grid%q                   &amp;<a name='2715'>
                      ,grid%fis,grid%pd,grid%pdtop,grid%deta1,grid%deta2           &amp;<a name='2716'>
                      ,IDS,IDF,JDS,JDF,KDS,KDE                                     &amp;<a name='2717'>
                      ,IMS,IME,JMS,JME,KMS,KME                                     &amp;<a name='2718'>
                      ,ITS,ITE,JTS,JTE,KTS,KTE   )<a name='2719'>
        hifreq_tim=hifreq_tim+now_time()-btimx<a name='2720'>
     ENDIF<a name='2721'>
#endif<a name='2722'>
<font color=#447700>!<a name='2723'></font>
<font color=#447700>!-------------------  END OF HIGH FREQUENCY OUTPUT MODULE  ----------------------------<a name='2724'></font>
 <a name='2725'>
<a name='2726'>
      solve_tim=solve_tim+now_time()-ttim<a name='2727'>
      Return<a name='2728'>
<font color=#447700>!----------------------------------------------------------------------<a name='2729'></font>
<font color=#447700>!**********************************************************************<a name='2730'></font>
<font color=#447700>!**********************************************************************<a name='2731'></font>
<font color=#447700>!*************    EXIT FROM THE TIME LOOP    **************************<a name='2732'></font>
<font color=#447700>!**********************************************************************<a name='2733'></font>
<font color=#447700>!**********************************************************************<a name='2734'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2735'></font>
      CONTAINS<a name='2736'>
<a name='2737'>
<A NAME='ETAMP_TO_MOIST'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#ETAMP_TO_MOIST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2738'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>ETAMP_TO_MOIST</font>() <A href='../../call_to/ETAMP_TO_MOIST.html' TARGET='index'>2</A><a name='2739'>
            implicit none<a name='2740'>
            INTEGER :: I,J,K<a name='2741'>
            REAL :: QI,QR,QW,WC,FICE,FRAIN<a name='2742'>
            if(size(grid%f_ice,1)*size(grid%f_ice,2) &lt;= 1) then<a name='2743'>
              return<a name='2744'>
            endif<a name='2745'>
            DO K=KTS,KTE<a name='2746'>
            DO J=MYJS,MYJE<a name='2747'>
            DO I=MYIS,MYIE<a name='2748'>
              MOIST(I,J,K,P_QV)=grid%q(I,J,K)/(1.-grid%q(I,J,K))<a name='2749'>
              WC = grid%cwm(I,J,K)<a name='2750'>
              QI = 0.<a name='2751'>
              QR = 0.<a name='2752'>
              QW = 0.<a name='2753'>
              FICE=grid%f_ice(I,K,J)<a name='2754'>
              FRAIN=grid%f_rain(I,K,J)<a name='2755'>
<font color=#447700>!<a name='2756'></font>
              IF(FICE&gt;=1.)THEN<a name='2757'>
                QI=WC<a name='2758'>
              ELSEIF(FICE&lt;=0.)THEN<a name='2759'>
                QW=WC<a name='2760'>
              ELSE<a name='2761'>
                QI=FICE*WC<a name='2762'>
                QW=WC-QI<a name='2763'>
              ENDIF<a name='2764'>
<font color=#447700>!<a name='2765'></font>
              IF(QW&gt;0..AND.FRAIN&gt;0.)THEN<a name='2766'>
                IF(FRAIN&gt;=1.)THEN<a name='2767'>
                  QR=QW<a name='2768'>
                  QW=0.<a name='2769'>
                ELSE<a name='2770'>
                  QR=FRAIN*QW<a name='2771'>
                  QW=QW-QR<a name='2772'>
                ENDIF<a name='2773'>
              ENDIF<a name='2774'>
<font color=#447700>!<a name='2775'></font>
              MOIST(I,J,K,P_QC)=QW<a name='2776'>
              MOIST(I,J,K,P_QR)=QR<a name='2777'>
<a name='2778'>
              IF (ETAMP_PHYSICS) THEN<a name='2779'>
#if ( HWRF == 1 )<a name='2780'>
                 MOIST(I,J,K,P_QI)=QI<a name='2781'>
                 MOIST(I,J,K,P_QS)=0.<a name='2782'>
#else<a name='2783'>
                 MOIST(I,J,K,P_QI)=0.<a name='2784'>
                 MOIST(I,J,K,P_QS)=QI<a name='2785'>
#endif<a name='2786'>
              endif<a name='2787'>
              MOIST(I,J,K,P_QG)=0.<a name='2788'>
            ENDDO<a name='2789'>
            ENDDO<a name='2790'>
            ENDDO<a name='2791'>
         END SUBROUTINE ETAMP_TO_MOIST<a name='2792'>
<a name='2793'>
      END SUBROUTINE SOLVE_NMM<a name='2794'>
<font color=#447700>!----------------------------------------------------------------------<a name='2795'></font>
<font color=#447700>!**********************************************************************<a name='2796'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2797'></font>
<A NAME='TWR'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TWR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2798'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TWR</font>(ARRAY,KK,FIELD,ntsd,MYPE,NPES,MPI_COMM_COMP       &amp;,<A href='../../call_from/TWR.html' TARGET='index'>1</A><a name='2799'>
     &amp;              ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='2800'>
     &amp;              ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='2801'>
     &amp;              ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2802'>
<font color=#447700>!----------------------------------------------------------------------<a name='2803'></font>
<font color=#447700>!**********************************************************************<a name='2804'></font>
      USE MODULE_EXT_INTERNAL<a name='2805'>
<font color=#447700>!<a name='2806'></font>
      IMPLICIT NONE<a name='2807'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2808'></font>
      INCLUDE "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_30"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TWR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2809'>
#endif<a name='2810'>
<font color=#447700>!----------------------------------------------------------------------<a name='2811'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2812'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='2813'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='2814'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                    &amp;<a name='2815'>
     &amp;                     ,KK,MPI_COMM_COMP,MYPE,NPES,ntsd<a name='2816'>
<font color=#447700>!<a name='2817'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME+KK),INTENT(IN) :: ARRAY<a name='2818'>
<font color=#447700>!<a name='2819'></font>
      CHARACTER(*),INTENT(IN) :: FIELD<a name='2820'>
<font color=#447700>!<a name='2821'></font>
<font color=#447700>!*** LOCAL VARIABLES<a name='2822'></font>
<font color=#447700>!<a name='2823'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2824'></font>
      INTEGER,DIMENSION(MPI_STATUS_SIZE) :: JSTAT<a name='2825'>
      INTEGER,DIMENSION(MPI_STATUS_SIZE,4) :: STATUS_ARRAY<a name='2826'>
#endif<a name='2827'>
      INTEGER,DIMENSION(2) :: IM_REM,JM_REM,IT_REM,JT_REM<a name='2828'>
<font color=#447700>!<a name='2829'></font>
      INTEGER :: I,IENDX,IER,IPE,IRECV,IRTN,ISEND,IUNIT                &amp;<a name='2830'>
     &amp;          ,J,K,N,NLEN,NSIZE<a name='2831'>
      INTEGER :: ITS_REM,ITE_REM,JTS_REM,JTE_REM<a name='2832'>
<font color=#447700>!<a name='2833'></font>
      REAL,DIMENSION(IDS:IDE,JDS:JDE) :: TWRITE<a name='2834'>
      REAL,ALLOCATABLE,DIMENSION(:) :: VALUES<a name='2835'>
      CHARACTER(5) :: TIMESTEP<a name='2836'>
      CHARACTER(6) :: FMT<a name='2837'>
      CHARACTER(12) :: FILENAME<a name='2838'>
<font color=#447700>!----------------------------------------------------------------------<a name='2839'></font>
<font color=#447700>!**********************************************************************<a name='2840'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2841'></font>
<font color=#447700>!<a name='2842'></font>
      IF(ntsd&lt;=9)THEN<a name='2843'>
        FMT='(I1.1)'<a name='2844'>
        NLEN=1<a name='2845'>
      ELSEIF(ntsd&lt;=99)THEN<a name='2846'>
        FMT='(I2.2)'<a name='2847'>
        NLEN=2<a name='2848'>
      ELSEIF(ntsd&lt;=999)THEN<a name='2849'>
        FMT='(I3.3)'<a name='2850'>
        NLEN=3<a name='2851'>
      ELSEIF(ntsd&lt;=9999)THEN<a name='2852'>
        FMT='(I4.4)'<a name='2853'>
        NLEN=4<a name='2854'>
      ELSEIF(ntsd&lt;=99999)THEN<a name='2855'>
        FMT='(I5.5)'<a name='2856'>
        NLEN=5<a name='2857'>
      ENDIF<a name='2858'>
      WRITE(TIMESTEP,FMT)ntsd<a name='2859'>
      FILENAME=FIELD//'_'//TIMESTEP(1:NLEN)<a name='2860'>
<font color=#447700>!<a name='2861'></font>
      IF(MYPE==0)THEN<a name='2862'>
        CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#INT_GET_FRESH_HANDLE'>INT_GET_FRESH_HANDLE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TWR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_FRESH_HANDLE_1">(IUNIT)<a name='2863'>
        CLOSE(IUNIT)<a name='2864'>
        OPEN(UNIT=IUNIT,FILE=FILENAME,FORM='UNFORMATTED',IOSTAT=IER)<a name='2865'>
      ENDIF<a name='2866'>
<font color=#447700>!<a name='2867'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2868'></font>
      write_layers: DO K=KDE-1,KDS,-1   <font color=#447700>!Write LM layers top down for checking<a name='2869'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2870'></font>
<font color=#447700>!<a name='2871'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2872'></font>
      IF(MYPE==0)THEN<a name='2873'>
        DO J=JTS,JTE<a name='2874'>
        DO I=ITS,ITE<a name='2875'>
          TWRITE(I,J)=ARRAY(I,J,K)<a name='2876'>
        ENDDO<a name='2877'>
        ENDDO<a name='2878'>
<font color=#447700>!<a name='2879'></font>
        DO IPE=1,NPES-1<a name='2880'>
          CALL MPI_RECV(IT_REM,2,MPI_INTEGER,IPE,IPE                    &amp;<a name='2881'>
     &amp;                 ,MPI_COMM_COMP,JSTAT,IRECV)<a name='2882'>
          CALL MPI_RECV(JT_REM,2,MPI_INTEGER,IPE,IPE                    &amp;<a name='2883'>
     &amp;                 ,MPI_COMM_COMP,JSTAT,IRECV)<a name='2884'>
<font color=#447700>!<a name='2885'></font>
          ITS_REM=IT_REM(1)<a name='2886'>
          ITE_REM=IT_REM(2)<a name='2887'>
          JTS_REM=JT_REM(1)<a name='2888'>
          JTE_REM=JT_REM(2)<a name='2889'>
<font color=#447700>!<a name='2890'></font>
          NSIZE=(ITE_REM-ITS_REM+1)*(JTE_REM-JTS_REM+1)<a name='2891'>
          ALLOCATE(VALUES(1:NSIZE))<a name='2892'>
<font color=#447700>!<a name='2893'></font>
          CALL MPI_RECV(VALUES,NSIZE,MPI_REAL,IPE,IPE                   &amp;<a name='2894'>
     &amp;                 ,MPI_COMM_COMP,JSTAT,IRECV)<a name='2895'>
          N=0<a name='2896'>
          DO J=JTS_REM,JTE_REM<a name='2897'>
            DO I=ITS_REM,ITE_REM<a name='2898'>
              N=N+1<a name='2899'>
              TWRITE(I,J)=VALUES(N)<a name='2900'>
            ENDDO<a name='2901'>
          ENDDO<a name='2902'>
<font color=#447700>!<a name='2903'></font>
          DEALLOCATE(VALUES)<a name='2904'>
<font color=#447700>!<a name='2905'></font>
        ENDDO<a name='2906'>
<font color=#447700>!<a name='2907'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2908'></font>
      ELSE<a name='2909'>
        NSIZE=(ITE-ITS+1)*(JTE-JTS+1)<a name='2910'>
        ALLOCATE(VALUES(1:NSIZE))<a name='2911'>
<font color=#447700>!<a name='2912'></font>
        N=0<a name='2913'>
        DO J=JTS,JTE<a name='2914'>
        DO I=ITS,ITE<a name='2915'>
          N=N+1<a name='2916'>
          VALUES(N)=ARRAY(I,J,K)<a name='2917'>
        ENDDO<a name='2918'>
        ENDDO<a name='2919'>
<font color=#447700>!<a name='2920'></font>
        IT_REM(1)=ITS<a name='2921'>
        IT_REM(2)=ITE<a name='2922'>
        JT_REM(1)=JTS<a name='2923'>
        JT_REM(2)=JTE<a name='2924'>
<font color=#447700>!<a name='2925'></font>
        CALL MPI_SEND(IT_REM,2,MPI_INTEGER,0,MYPE                       &amp;<a name='2926'>
     &amp;               ,MPI_COMM_COMP,ISEND)<a name='2927'>
        CALL MPI_SEND(JT_REM,2,MPI_INTEGER,0,MYPE                       &amp;<a name='2928'>
     &amp;               ,MPI_COMM_COMP,ISEND)<a name='2929'>
<font color=#447700>!<a name='2930'></font>
        CALL MPI_SEND(VALUES,NSIZE,MPI_REAL,0,MYPE                      &amp;<a name='2931'>
     &amp;               ,MPI_COMM_COMP,ISEND)<a name='2932'>
<font color=#447700>!<a name='2933'></font>
        DEALLOCATE(VALUES)<a name='2934'>
<font color=#447700>!<a name='2935'></font>
      ENDIF<a name='2936'>
<font color=#447700>!----------------------------------------------------------------------<a name='2937'></font>
<font color=#447700>!<a name='2938'></font>
      CALL MPI_BARRIER(MPI_COMM_COMP,IRTN)<a name='2939'>
<font color=#447700>!<a name='2940'></font>
      IF(MYPE==0)THEN<a name='2941'>
<font color=#447700>!<a name='2942'></font>
        DO J=JDS,JDE-1<a name='2943'>
          IENDX=IDE-1<a name='2944'>
          IF(MOD(J,2)==0)IENDX=IENDX-1<a name='2945'>
          WRITE(IUNIT)(TWRITE(I,J),I=1,IENDX)<a name='2946'>
        ENDDO<a name='2947'>
<font color=#447700>!<a name='2948'></font>
      ENDIF<a name='2949'>
#else<a name='2950'>
<a name='2951'>
        DO J=JDS,JDE-1<a name='2952'>
          IENDX=IDE-1<a name='2953'>
          IF(MOD(J,2)==0)IENDX=IENDX-1<a name='2954'>
          WRITE(IUNIT)(ARRAY(I,K,J),I=1,IENDX)<a name='2955'>
        ENDDO<a name='2956'>
<a name='2957'>
#endif<a name='2958'>
<a name='2959'>
<font color=#447700>!<a name='2960'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2961'></font>
      ENDDO write_layers<a name='2962'>
<font color=#447700>!<a name='2963'></font>
      IF(MYPE==0)CLOSE(IUNIT)<a name='2964'>
<font color=#447700>!----------------------------------------------------------------------<a name='2965'></font>
<font color=#447700>!<a name='2966'></font>
      END SUBROUTINE TWR<a name='2967'>
<font color=#447700>!----------------------------------------------------------------------<a name='2968'></font>
<font color=#447700>!**********************************************************************<a name='2969'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2970'></font>
<A NAME='VWR'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#VWR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2971'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>VWR</font>(ARRAY,KK,FIELD,ntsd,MYPE,NPES,MPI_COMM_COMP       &amp;,<A href='../../call_from/VWR.html' TARGET='index'>1</A><a name='2972'>
     &amp;              ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='2973'>
     &amp;              ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='2974'>
     &amp;              ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='2975'>
<font color=#447700>!----------------------------------------------------------------------<a name='2976'></font>
<font color=#447700>!**********************************************************************<a name='2977'></font>
      USE MODULE_EXT_INTERNAL<a name='2978'>
<font color=#447700>!<a name='2979'></font>
      IMPLICIT NONE<a name='2980'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2981'></font>
      INCLUDE "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_31"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#VWR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2982'>
#endif<a name='2983'>
<font color=#447700>!----------------------------------------------------------------------<a name='2984'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2985'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='2986'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='2987'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE                    &amp;<a name='2988'>
     &amp;                     ,KK,MPI_COMM_COMP,MYPE,NPES,ntsd<a name='2989'>
<font color=#447700>!<a name='2990'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME+KK),INTENT(IN) :: ARRAY<a name='2991'>
<font color=#447700>!<a name='2992'></font>
      CHARACTER(*),INTENT(IN) :: FIELD<a name='2993'>
<font color=#447700>!<a name='2994'></font>
<font color=#447700>!*** LOCAL VARIABLES<a name='2995'></font>
<font color=#447700>!<a name='2996'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='2997'></font>
      INTEGER,DIMENSION(MPI_STATUS_SIZE) :: JSTAT<a name='2998'>
      INTEGER,DIMENSION(MPI_STATUS_SIZE,4) :: STATUS_ARRAY<a name='2999'>
#endif<a name='3000'>
      INTEGER,DIMENSION(2) :: IM_REM,JM_REM,IT_REM,JT_REM<a name='3001'>
<font color=#447700>!<a name='3002'></font>
      INTEGER :: I,IENDX,IER,IPE,IRECV,IRTN,ISEND,IUNIT                &amp;<a name='3003'>
     &amp;          ,J,K,L,N,NLEN,NSIZE<a name='3004'>
      INTEGER :: ITS_REM,ITE_REM,JTS_REM,JTE_REM<a name='3005'>
<font color=#447700>!<a name='3006'></font>
      REAL,DIMENSION(IDS:IDE,JDS:JDE) :: TWRITE<a name='3007'>
      REAL,ALLOCATABLE,DIMENSION(:) :: VALUES<a name='3008'>
      CHARACTER(5) :: TIMESTEP<a name='3009'>
      CHARACTER(6) :: FMT<a name='3010'>
      CHARACTER(12) :: FILENAME<a name='3011'>
      LOGICAL :: OPENED<a name='3012'>
<font color=#447700>!----------------------------------------------------------------------<a name='3013'></font>
<font color=#447700>!**********************************************************************<a name='3014'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3015'></font>
<font color=#447700>!<a name='3016'></font>
      IF(ntsd&lt;=9)THEN<a name='3017'>
        FMT='(I1.1)'<a name='3018'>
        NLEN=1<a name='3019'>
      ELSEIF(ntsd&lt;=99)THEN<a name='3020'>
        FMT='(I2.2)'<a name='3021'>
        NLEN=2<a name='3022'>
      ELSEIF(ntsd&lt;=999)THEN<a name='3023'>
        FMT='(I3.3)'<a name='3024'>
        NLEN=3<a name='3025'>
      ELSEIF(ntsd&lt;=9999)THEN<a name='3026'>
        FMT='(I4.4)'<a name='3027'>
        NLEN=4<a name='3028'>
      ELSEIF(ntsd&lt;=99999)THEN<a name='3029'>
        FMT='(I5.5)'<a name='3030'>
        NLEN=5<a name='3031'>
      ENDIF<a name='3032'>
      WRITE(TIMESTEP,FMT)ntsd<a name='3033'>
      FILENAME=FIELD//'_'//TIMESTEP(1:NLEN)<a name='3034'>
<font color=#447700>!<a name='3035'></font>
      IF(MYPE==0)THEN<a name='3036'>
        CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#INT_GET_FRESH_HANDLE'>INT_GET_FRESH_HANDLE</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#VWR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_FRESH_HANDLE_2">(IUNIT)<a name='3037'>
        CLOSE(IUNIT)<a name='3038'>
        OPEN(UNIT=IUNIT,FILE=FILENAME,FORM='UNFORMATTED',IOSTAT=IER)<a name='3039'>
      ENDIF<a name='3040'>
<font color=#447700>!     IF(MYPE==0)THEN<a name='3041'></font>
<font color=#447700>!       OPEN_UNIT: DO L=51,99<a name='3042'></font>
<font color=#447700>!         INQUIRE(L,OPENED=OPENED)<a name='3043'></font>
<font color=#447700>!         IF(.NOT.OPENED)THEN<a name='3044'></font>
<font color=#447700>!           IUNIT=L<a name='3045'></font>
<font color=#447700>!           OPEN(UNIT=IUNIT,FILE=FILENAME,STATUS='NEW'                 &amp;<a name='3046'></font>
<font color=#447700>!               ,FORM='UNFORMATTED',IOSTAT=IER)<a name='3047'></font>
<font color=#447700>!           IF(IER/=0)THEN<a name='3048'></font>
<font color=#447700>!             WRITE(message,*)' Opening file error=',IER<a name='3049'></font>
<font color=#447700>!             CALL wrf_message(trim(message))<a name='3050'></font>
<font color=#447700>!           ENDIF<a name='3051'></font>
<font color=#447700>!           EXIT OPEN_UNIT<a name='3052'></font>
<font color=#447700>!         ENDIF<a name='3053'></font>
<font color=#447700>!       ENDDO OPEN_UNIT<a name='3054'></font>
<font color=#447700>!     ENDIF<a name='3055'></font>
<font color=#447700>!<a name='3056'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3057'></font>
      write_layers: DO K=KDE-1,KDS,-1   <font color=#447700>!Write LM layers top down for checking<a name='3058'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3059'></font>
<font color=#447700>!<a name='3060'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3061'></font>
      IF(MYPE==0)THEN<a name='3062'>
        DO J=JTS,JTE<a name='3063'>
        DO I=ITS,ITE<a name='3064'>
          TWRITE(I,J)=ARRAY(I,J,K)<a name='3065'>
        ENDDO<a name='3066'>
        ENDDO<a name='3067'>
<font color=#447700>!<a name='3068'></font>
        DO IPE=1,NPES-1<a name='3069'>
          CALL MPI_RECV(IT_REM,2,MPI_INTEGER,IPE,IPE                    &amp;<a name='3070'>
     &amp;                 ,MPI_COMM_COMP,JSTAT,IRECV)<a name='3071'>
          CALL MPI_RECV(JT_REM,2,MPI_INTEGER,IPE,IPE                    &amp;<a name='3072'>
     &amp;                 ,MPI_COMM_COMP,JSTAT,IRECV)<a name='3073'>
<font color=#447700>!<a name='3074'></font>
          ITS_REM=IT_REM(1)<a name='3075'>
          ITE_REM=IT_REM(2)<a name='3076'>
          JTS_REM=JT_REM(1)<a name='3077'>
          JTE_REM=JT_REM(2)<a name='3078'>
<font color=#447700>!<a name='3079'></font>
          NSIZE=(ITE_REM-ITS_REM+1)*(JTE_REM-JTS_REM+1)<a name='3080'>
          ALLOCATE(VALUES(1:NSIZE))<a name='3081'>
<font color=#447700>!<a name='3082'></font>
          CALL MPI_RECV(VALUES,NSIZE,MPI_REAL,IPE,IPE                   &amp;<a name='3083'>
     &amp;                 ,MPI_COMM_COMP,JSTAT,IRECV)<a name='3084'>
          N=0<a name='3085'>
          DO J=JTS_REM,JTE_REM<a name='3086'>
            DO I=ITS_REM,ITE_REM<a name='3087'>
              N=N+1<a name='3088'>
              TWRITE(I,J)=VALUES(N)<a name='3089'>
            ENDDO<a name='3090'>
          ENDDO<a name='3091'>
<font color=#447700>!<a name='3092'></font>
          DEALLOCATE(VALUES)<a name='3093'>
<font color=#447700>!<a name='3094'></font>
        ENDDO<a name='3095'>
<font color=#447700>!<a name='3096'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3097'></font>
      ELSE<a name='3098'>
        NSIZE=(ITE-ITS+1)*(JTE-JTS+1)<a name='3099'>
        ALLOCATE(VALUES(1:NSIZE))<a name='3100'>
<font color=#447700>!<a name='3101'></font>
        N=0<a name='3102'>
        DO J=JTS,JTE<a name='3103'>
        DO I=ITS,ITE<a name='3104'>
          N=N+1<a name='3105'>
          VALUES(N)=ARRAY(I,J,K)<a name='3106'>
        ENDDO<a name='3107'>
        ENDDO<a name='3108'>
<font color=#447700>!<a name='3109'></font>
        IT_REM(1)=ITS<a name='3110'>
        IT_REM(2)=ITE<a name='3111'>
        JT_REM(1)=JTS<a name='3112'>
        JT_REM(2)=JTE<a name='3113'>
<font color=#447700>!<a name='3114'></font>
        CALL MPI_SEND(IT_REM,2,MPI_INTEGER,0,MYPE                       &amp;<a name='3115'>
     &amp;               ,MPI_COMM_COMP,ISEND)<a name='3116'>
        CALL MPI_SEND(JT_REM,2,MPI_INTEGER,0,MYPE                       &amp;<a name='3117'>
     &amp;               ,MPI_COMM_COMP,ISEND)<a name='3118'>
<font color=#447700>!<a name='3119'></font>
        CALL MPI_SEND(VALUES,NSIZE,MPI_REAL,0,MYPE                      &amp;<a name='3120'>
     &amp;               ,MPI_COMM_COMP,ISEND)<a name='3121'>
<font color=#447700>!<a name='3122'></font>
        DEALLOCATE(VALUES)<a name='3123'>
<font color=#447700>!<a name='3124'></font>
      ENDIF<a name='3125'>
<font color=#447700>!----------------------------------------------------------------------<a name='3126'></font>
<font color=#447700>!<a name='3127'></font>
      CALL MPI_BARRIER(MPI_COMM_COMP,IRTN)<a name='3128'>
<font color=#447700>!<a name='3129'></font>
      IF(MYPE==0)THEN<a name='3130'>
<font color=#447700>!<a name='3131'></font>
        DO J=JDS,JDE-1<a name='3132'>
          IENDX=IDE-1<a name='3133'>
          IF(MOD(J,2)==1)IENDX=IENDX-1<a name='3134'>
          WRITE(IUNIT)(TWRITE(I,J),I=1,IENDX)<a name='3135'>
        ENDDO<a name='3136'>
<font color=#447700>!<a name='3137'></font>
      ENDIF<a name='3138'>
#else<a name='3139'>
<a name='3140'>
        DO J=JDS,JDE-1<a name='3141'>
          IENDX=IDE-1<a name='3142'>
          IF(MOD(J,2)==0)IENDX=IENDX-1<a name='3143'>
          WRITE(IUNIT)(ARRAY(I,K,J),I=1,IENDX)<a name='3144'>
        ENDDO<a name='3145'>
<a name='3146'>
#endif<a name='3147'>
<font color=#447700>!<a name='3148'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3149'></font>
      ENDDO write_layers<a name='3150'>
<font color=#447700>!<a name='3151'></font>
      IF(MYPE==0)CLOSE(IUNIT)<a name='3152'>
<font color=#447700>!----------------------------------------------------------------------<a name='3153'></font>
<font color=#447700>!<a name='3154'></font>
      END SUBROUTINE VWR<a name='3155'>
<font color=#447700>!----------------------------------------------------------------------<a name='3156'></font>
<font color=#447700>!**********************************************************************<a name='3157'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3158'></font>
<A NAME='TIME_STATS'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TIME_STATS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3159'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>TIME_STATS</font>(TIME_LCL_IN,NAME,ntsd,MYPE,NPES,MPI_COMM_COMP),<A href='../../call_from/TIME_STATS.html' TARGET='index'>6</A><a name='3160'>
<font color=#447700>!----------------------------------------------------------------------<a name='3161'></font>
<font color=#447700>!**********************************************************************<a name='3162'></font>
      USE MODULE_EXT_INTERNAL<a name='3163'>
<font color=#447700>!<a name='3164'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3165'></font>
      IMPLICIT NONE<a name='3166'>
<font color=#447700>!----------------------------------------------------------------------<a name='3167'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3168'></font>
      INCLUDE "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_32"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TIME_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3169'>
#endif<a name='3170'>
<font color=#447700>!----------------------------------------------------------------------<a name='3171'></font>
      INTEGER,INTENT(IN) :: MPI_COMM_COMP,MYPE,NPES,ntsd<a name='3172'>
      REAL,INTENT(IN) :: TIME_LCL_IN<a name='3173'>
<font color=#447700>!<a name='3174'></font>
      CHARACTER(*),INTENT(IN) :: NAME<a name='3175'>
<font color=#447700>!<a name='3176'></font>
<font color=#447700>!*** LOCAL VARIABLES<a name='3177'></font>
<font color=#447700>!<a name='3178'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3179'></font>
      INTEGER,DIMENSION(MPI_STATUS_SIZE) :: JSTAT<a name='3180'>
      INTEGER,DIMENSION(MPI_STATUS_SIZE,4) :: STATUS_ARRAY<a name='3181'>
#endif<a name='3182'>
      INTEGER,ALLOCATABLE,DIMENSION(:) :: ID_PE,IPE_SORT<a name='3183'>
<font color=#447700>!<a name='3184'></font>
      INTEGER :: IPE,IPE_MAX,IPE_MEDIAN,IPE_MIN,IRECV,IRTN,ISEND       &amp;<a name='3185'>
     &amp;          ,N,N_MEDIAN,NLEN<a name='3186'>
<font color=#447700>!<a name='3187'></font>
      REAL,ALLOCATABLE,DIMENSION(:) :: TIME,SORT_TIME<a name='3188'>
      REAL,DIMENSION(2) :: REMOTE<a name='3189'>
      REAL :: TIME_MAX,TIME_MEAN,TIME_MEDIAN,TIME_MIN,TIME_LCL<a name='3190'>
<font color=#447700>!<a name='3191'></font>
      CHARACTER(5) :: TIMESTEP<a name='3192'>
      CHARACTER(6) :: FMT<a name='3193'>
      CHARACTER(25) :: TITLE<a name='3194'>
      CHARACTER(LEN=256) :: message<a name='3195'>
<font color=#447700>!----------------------------------------------------------------------<a name='3196'></font>
<font color=#447700>!**********************************************************************<a name='3197'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3198'></font>
<font color=#447700>!<a name='3199'></font>
      TIME_LCL=TIME_LCL_IN*1000.<a name='3200'>
      IF(ntsd&lt;=9)THEN<a name='3201'>
        FMT='(I1.1)'<a name='3202'>
        NLEN=1<a name='3203'>
      ELSEIF(ntsd&lt;=99)THEN<a name='3204'>
        FMT='(I2.2)'<a name='3205'>
        NLEN=2<a name='3206'>
      ELSEIF(ntsd&lt;=999)THEN<a name='3207'>
        FMT='(I3.3)'<a name='3208'>
        NLEN=3<a name='3209'>
      ELSEIF(ntsd&lt;=9999)THEN<a name='3210'>
        FMT='(I4.4)'<a name='3211'>
        NLEN=4<a name='3212'>
      ELSEIF(ntsd&lt;=99999)THEN<a name='3213'>
        FMT='(I5.5)'<a name='3214'>
        NLEN=5<a name='3215'>
      ENDIF<a name='3216'>
      WRITE(TIMESTEP,FMT)ntsd<a name='3217'>
      TITLE=NAME//'_'//TIMESTEP(1:NLEN)<a name='3218'>
<font color=#447700>!<a name='3219'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3220'></font>
<font color=#447700>!<a name='3221'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3222'></font>
      IF(MYPE==0)THEN<a name='3223'>
        ALLOCATE(TIME(1:NPES))<a name='3224'>
        ALLOCATE(SORT_TIME(1:NPES))<a name='3225'>
        ALLOCATE(ID_PE(1:NPES))<a name='3226'>
        ALLOCATE(IPE_SORT(1:NPES))<a name='3227'>
<font color=#447700>!<a name='3228'></font>
        TIME(1)=TIME_LCL<a name='3229'>
        ID_PE(1)=MYPE<a name='3230'>
<font color=#447700>!<a name='3231'></font>
<font color=#447700>!***  COLLECT TIMES AND PE VALUES FROM OTHER PEs<a name='3232'></font>
<font color=#447700>!<a name='3233'></font>
        DO IPE=1,NPES-1<a name='3234'>
          CALL MPI_RECV(REMOTE,2,MPI_REAL,IPE,IPE                      &amp;<a name='3235'>
     &amp;                 ,MPI_COMM_COMP,JSTAT,IRECV)<a name='3236'>
<font color=#447700>!<a name='3237'></font>
          TIME(IPE+1)=REMOTE(1)<a name='3238'>
          ID_PE(IPE+1)=NINT(REMOTE(2))<a name='3239'>
        ENDDO<a name='3240'>
<font color=#447700>!<a name='3241'></font>
<font color=#447700>!***  NOW GET STATS.<a name='3242'></font>
<font color=#447700>!***  FIRST THE MAX, MIN, AND MEAN TIMES.<a name='3243'></font>
<font color=#447700>!<a name='3244'></font>
        TIME_MEAN=0.<a name='3245'>
        TIME_MAX=-1.<a name='3246'>
        TIME_MIN=1.E10<a name='3247'>
        IPE_MAX=-1<a name='3248'>
        IPE_MIN=-1<a name='3249'>
<font color=#447700>!<a name='3250'></font>
        DO N=1,NPES<a name='3251'>
          TIME_MEAN=TIME_MEAN+TIME(N)<a name='3252'>
<font color=#447700>!<a name='3253'></font>
          IF(TIME(N)&gt;TIME_MAX)THEN<a name='3254'>
            TIME_MAX=TIME(N)<a name='3255'>
            IPE_MAX=ID_PE(N)<a name='3256'>
          ENDIF<a name='3257'>
<font color=#447700>!<a name='3258'></font>
          IF(TIME(N)&lt;TIME_MIN)THEN<a name='3259'>
            TIME_MIN=TIME(N)<a name='3260'>
            IPE_MIN=ID_PE(N)<a name='3261'>
          ENDIF<a name='3262'>
<font color=#447700>!<a name='3263'></font>
        ENDDO<a name='3264'>
<font color=#447700>!<a name='3265'></font>
        TIME_MAX=TIME_MAX*1.E-3<a name='3266'>
        TIME_MIN=TIME_MIN*1.E-3<a name='3267'>
        TIME_MEAN=TIME_MEAN*1.E-3/REAL(NPES)<a name='3268'>
<font color=#447700>!<a name='3269'></font>
<font color=#447700>!***  THEN THE MEDIAN TIME.<a name='3270'></font>
<font color=#447700>!<a name='3271'></font>
        CALL <A href='../../html_code/dyn_nmm/solve_nmm.F.html#SORT'>SORT</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TIME_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SORT_1">(TIME,NPES,SORT_TIME,IPE_SORT)<a name='3272'>
        N_MEDIAN=(NPES+1)/2<a name='3273'>
        TIME_MEDIAN=SORT_TIME(N_MEDIAN)*1.E-3<a name='3274'>
        IPE_MEDIAN=IPE_SORT(N_MEDIAN)<a name='3275'>
<font color=#447700>!<a name='3276'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3277'></font>
      ELSE<a name='3278'>
<font color=#447700>!<a name='3279'></font>
<font color=#447700>!***  SEND TIME AND PE VALUE TO PE0.<a name='3280'></font>
<font color=#447700>!<a name='3281'></font>
        REMOTE(1)=TIME_LCL<a name='3282'>
        REMOTE(2)=REAL(MYPE)<a name='3283'>
<font color=#447700>!<a name='3284'></font>
        CALL MPI_SEND(REMOTE,2,MPI_REAL,0,MYPE,MPI_COMM_COMP,ISEND)<a name='3285'>
<font color=#447700>!<a name='3286'></font>
      ENDIF<a name='3287'>
<font color=#447700>!----------------------------------------------------------------------<a name='3288'></font>
<font color=#447700>!<a name='3289'></font>
      CALL MPI_BARRIER(MPI_COMM_COMP,IRTN)<a name='3290'>
<font color=#447700>!<a name='3291'></font>
<font color=#447700>!***  WRITE RESULTS<a name='3292'></font>
<font color=#447700>!<a name='3293'></font>
      IF(MYPE==0)THEN<a name='3294'>
        WRITE(message,100)TITLE<a name='3295'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TIME_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_233">(trim(message))<a name='3296'>
        WRITE(message,105)TIME_MAX,IPE_MAX<a name='3297'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TIME_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_234">(trim(message))<a name='3298'>
        WRITE(message,110)TIME_MIN,IPE_MIN<a name='3299'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TIME_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_235">(trim(message))<a name='3300'>
        WRITE(message,115)TIME_MEDIAN,IPE_MEDIAN<a name='3301'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TIME_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_236">(trim(message))<a name='3302'>
        WRITE(message,120)TIME_MEAN<a name='3303'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#TIME_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_237">(trim(message))<a name='3304'>
  100   FORMAT(' Time for ',A)<a name='3305'>
  105   FORMAT(' Maximum=',G11.5,' for PE ',I2.2)<a name='3306'>
  110   FORMAT(' Minimum=',G11.5,' for PE ',I2.2)<a name='3307'>
  115   FORMAT(' Median =',G11.5,' for PE ',I2.2)<a name='3308'>
  120   FORMAT(' Mean   =',G11.5)<a name='3309'>
      ENDIF<a name='3310'>
<font color=#447700>!----------------------------------------------------------------------<a name='3311'></font>
<font color=#447700>!<a name='3312'></font>
#endif<a name='3313'>
      END SUBROUTINE TIME_STATS<a name='3314'>
<font color=#447700>!<a name='3315'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3316'></font>
<font color=#447700>!**********************************************************************<a name='3317'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3318'></font>
<A NAME='SORT'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#SORT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3319'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SORT</font>(DATA,NPES,DATA_SORTED,IPE_SORTED) <A href='../../call_to/SORT.html' TARGET='index'>1</A><a name='3320'>
<font color=#447700>!----------------------------------------------------------------------<a name='3321'></font>
<font color=#447700>!***<a name='3322'></font>
<font color=#447700>!***  SORT DATA FROM MULTIPLE PEs.  SEND BACK THE SORTED DATA ITEMS<a name='3323'></font>
<font color=#447700>!***  ALONG WITH THE ASSOCIATED TASK IDs.<a name='3324'></font>
<font color=#447700>!***<a name='3325'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3326'></font>
      IMPLICIT NONE<a name='3327'>
<font color=#447700>!----------------------------------------------------------------------<a name='3328'></font>
      INTEGER,INTENT(IN) :: NPES<a name='3329'>
      REAL,DIMENSION(NPES),INTENT(IN) :: DATA<a name='3330'>
<font color=#447700>!<a name='3331'></font>
      INTEGER,DIMENSION(NPES),INTENT(OUT) :: IPE_SORTED<a name='3332'>
      REAL,DIMENSION(NPES),INTENT(OUT) :: DATA_SORTED<a name='3333'>
<font color=#447700>!----------------------------------------------------------------------<a name='3334'></font>
      TYPE :: DATA_LINK<a name='3335'>
        REAL :: VALUE<a name='3336'>
        INTEGER :: IPE<a name='3337'>
        TYPE(DATA_LINK),POINTER :: NEXT_VALUE<a name='3338'>
      END TYPE<a name='3339'>
<font color=#447700>!----------------------------------------------------------------------<a name='3340'></font>
<font color=#447700>!<a name='3341'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='3342'></font>
<font color=#447700>!<a name='3343'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3344'></font>
      INTEGER :: ISTAT,N<a name='3345'>
<font color=#447700>!<a name='3346'></font>
      TYPE(DATA_LINK),POINTER :: HEAD,TAIL  <font color=#447700>! Smallest, largest<a name='3347'></font>
      TYPE(DATA_LINK),POINTER :: PTR_NEW    <font color=#447700>! Each new value<a name='3348'></font>
      TYPE(DATA_LINK),POINTER :: PTR1,PTR2  <font color=#447700>! Working pointers<a name='3349'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3350'></font>
<font color=#447700>!**********************************************************************<a name='3351'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3352'></font>
      pe_loop: DO N=1,NPES<a name='3353'>
        ALLOCATE(PTR_NEW,STAT=ISTAT)  <font color=#447700>! Location for next data items<a name='3354'></font>
        PTR_NEW%VALUE=DATA(N)<a name='3355'>
        PTR_NEW%IPE=N-1<a name='3356'>
<font color=#447700>!<a name='3357'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3358'></font>
<font color=#447700>!***  DETERMINE WHERE IN LIST TO INSERT VALUE.<a name='3359'></font>
<font color=#447700>!***  FIRST THE INITIAL DATA VALUE.<a name='3360'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3361'></font>
<font color=#447700>!<a name='3362'></font>
<font color=#447700>!       main: IF(.NOT.ASSOCIATED(HEAD))THEN<a name='3363'></font>
        main: IF(N==1)THEN<a name='3364'>
          HEAD=&gt;PTR_NEW<a name='3365'>
          TAIL=&gt;HEAD<a name='3366'>
          NULLIFY(PTR_NEW%NEXT_VALUE)<a name='3367'>
<font color=#447700>!<a name='3368'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3369'></font>
<font color=#447700>!***  THE NEW VALUE IS LESS THAN THE SMALLEST VALUE ALREADY SORTED.<a name='3370'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3371'></font>
<font color=#447700>!<a name='3372'></font>
        ELSE<a name='3373'>
          check: IF(PTR_NEW%VALUE&lt;HEAD%VALUE)THEN<a name='3374'>
            PTR_NEW%NEXT_VALUE=&gt;HEAD<a name='3375'>
            HEAD=&gt;PTR_NEW<a name='3376'>
<font color=#447700>!<a name='3377'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3378'></font>
<font color=#447700>!***  THE NEW VALUE IS GREATER THAN THE LARGEST VALUE ALREADY SORTED.<a name='3379'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3380'></font>
<font color=#447700>!<a name='3381'></font>
          ELSEIF(PTR_NEW%VALUE&gt;=TAIL%VALUE)THEN<a name='3382'>
            TAIL%NEXT_VALUE=&gt;PTR_NEW  <font color=#447700>! This is what connects the former<a name='3383'></font>
                                      <font color=#447700>! final value in the list to<a name='3384'></font>
                                      <font color=#447700>! the new value being appended.<a name='3385'></font>
            TAIL=&gt;PTR_NEW<a name='3386'>
            NULLIFY(TAIL%NEXT_VALUE)<a name='3387'>
<font color=#447700>!<a name='3388'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3389'></font>
<font color=#447700>!***  THE NEW VALUE IS IN BETWEEN VALUES ALREADY SORTED.<a name='3390'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3391'></font>
<font color=#447700>!<a name='3392'></font>
          ELSE<a name='3393'>
            PTR1=&gt;HEAD<a name='3394'>
            PTR2=&gt;PTR1%NEXT_VALUE<a name='3395'>
<font color=#447700>!<a name='3396'></font>
            search: DO<a name='3397'>
              IF((PTR_NEW%VALUE&gt;=PTR1%VALUE).AND.                      &amp;<a name='3398'>
     &amp;           (PTR_NEW%VALUE&lt;PTR2%VALUE))THEN<a name='3399'>
                PTR_NEW%NEXT_VALUE=&gt;PTR2<a name='3400'>
                PTR1%NEXT_VALUE=&gt;PTR_NEW<a name='3401'>
                EXIT search<a name='3402'>
              ENDIF<a name='3403'>
<font color=#447700>!<a name='3404'></font>
              PTR1=&gt;PTR2<a name='3405'>
              PTR2=&gt;PTR2%NEXT_VALUE<a name='3406'>
            ENDDO search<a name='3407'>
<font color=#447700>!<a name='3408'></font>
          ENDIF check<a name='3409'>
<font color=#447700>!<a name='3410'></font>
        ENDIF main<a name='3411'>
<font color=#447700>!<a name='3412'></font>
      ENDDO pe_loop<a name='3413'>
<font color=#447700>!<a name='3414'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3415'></font>
<font color=#447700>!***  COLLECT THE SORTED NUMBERS FROM THE LINKED LIST.<a name='3416'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3417'></font>
<font color=#447700>!<a name='3418'></font>
      PTR1=&gt;HEAD<a name='3419'>
<font color=#447700>!<a name='3420'></font>
      DO N=1,NPES<a name='3421'>
<font color=#447700>!       IF(.NOT.ASSOCIATED(PTR_NEW))EXIT<a name='3422'></font>
        DATA_SORTED(N)=PTR1%VALUE<a name='3423'>
        IPE_SORTED(N)=PTR1%IPE<a name='3424'>
        PTR1=&gt;PTR1%NEXT_VALUE<a name='3425'>
      ENDDO<a name='3426'>
<font color=#447700>!<a name='3427'></font>
      DEALLOCATE(PTR_NEW)<a name='3428'>
      NULLIFY (HEAD,TAIL,PTR1,PTR2)<a name='3429'>
<font color=#447700>!----------------------------------------------------------------------<a name='3430'></font>
      END SUBROUTINE SORT<a name='3431'>
<font color=#447700>!----------------------------------------------------------------------<a name='3432'></font>
<font color=#447700>!**********************************************************************<a name='3433'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3434'></font>
<A NAME='FIELD_STATS'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#FIELD_STATS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3435'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>FIELD_STATS</font>(FIELD,MYPE,MPI_COMM_COMP                  &amp; <A href='../../call_to/FIELD_STATS.html' TARGET='index'>1</A>,<A href='../../call_from/FIELD_STATS.html' TARGET='index'>2</A><a name='3436'>
     &amp;                      ,IDS,IDE,JDS,JDE,KDS,KDE                   &amp;<a name='3437'>
     &amp;                      ,IMS,IME,JMS,JME,KMS,KME                   &amp;<a name='3438'>
     &amp;                      ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='3439'>
<font color=#447700>!----------------------------------------------------------------------<a name='3440'></font>
<font color=#447700>!***<a name='3441'></font>
<font color=#447700>!***  GENERATE STANDARD LAYER STATISTICS FOR THE DESIRED FIELD.<a name='3442'></font>
<font color=#447700>!***<a name='3443'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3444'></font>
      IMPLICIT NONE<a name='3445'>
<font color=#447700>!----------------------------------------------------------------------<a name='3446'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3447'></font>
      INCLUDE "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_33"><A href='../../html_code/dyn_nmm/solve_nmm.F.html#FIELD_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3448'>
#endif<a name='3449'>
<font color=#447700>!----------------------------------------------------------------------<a name='3450'></font>
<font color=#447700>!<a name='3451'></font>
      INTEGER,INTENT(IN) :: MPI_COMM_COMP,MYPE<a name='3452'>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='3453'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='3454'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='3455'>
<font color=#447700>!<a name='3456'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME,KMS:KME),INTENT(IN) :: FIELD<a name='3457'>
<font color=#447700>!<a name='3458'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3459'></font>
<font color=#447700>!***  LOCAL<a name='3460'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3461'></font>
<font color=#447700>!<a name='3462'></font>
      INTEGER,PARAMETER :: DOUBLE=SELECTED_REAL_KIND(15,300)<a name='3463'>
<font color=#447700>!<a name='3464'></font>
      INTEGER :: I,IEND,IRTN,I_BY_J,J,K,KFLIP<a name='3465'>
<font color=#447700>!<a name='3466'></font>
      REAL :: FIKJ,FMAXK,FMINK<a name='3467'>
      REAL(KIND=DOUBLE) :: F_MEAN,POINTS,RMS,ST_DEV,SUMFK,SUMF2K<a name='3468'>
      REAL,DIMENSION(KTS:KTE) :: FMAX,FMAX_0,FMIN,FMIN_0<a name='3469'>
      REAL(KIND=DOUBLE),DIMENSION(KTS:KTE) :: SUMF,SUMF_0,SUMF2,SUMF2_0<a name='3470'>
 <a name='3471'>
      CHARACTER(LEN=256) :: message<a name='3472'>
<font color=#447700>!----------------------------------------------------------------------<a name='3473'></font>
<font color=#447700>!<a name='3474'></font>
      I_BY_J=(IDE-IDS)*(JDE-JDS)-(JDE-JDS-1)/2  <font color=#447700>! This assumes that<a name='3475'></font>
                                                <font color=#447700>! IDE and JDE are each<a name='3476'></font>
                                                <font color=#447700>! one greater than the<a name='3477'></font>
                                                <font color=#447700>! true grid size.<a name='3478'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI)<a name='3479'></font>
<font color=#447700>!<a name='3480'></font>
      layer_loop:  DO K=KTS,KTE<a name='3481'>
<font color=#447700>!<a name='3482'></font>
        FMAXK=-1.E10<a name='3483'>
        FMINK=1.E10<a name='3484'>
        SUMFK=0.<a name='3485'>
        SUMF2K=0.<a name='3486'>
<font color=#447700>!<a name='3487'></font>
        DO J=JTS,JTE<a name='3488'>
          IEND=MIN(ITE,IDE-1)<a name='3489'>
          IF(MOD(J,2)==0.AND.ITE==IDE-1)IEND=IEND-1<a name='3490'>
          DO I=ITS,IEND<a name='3491'>
            FIKJ=FIELD(I,J,K)<a name='3492'>
            FMAXK=MAX(FMAXK,FIKJ)<a name='3493'>
            FMINK=MIN(FMINK,FIKJ)<a name='3494'>
            SUMFK=SUMFK+FIKJ<a name='3495'>
            SUMF2K=SUMF2K+FIKJ*FIKJ<a name='3496'>
          ENDDO<a name='3497'>
        ENDDO<a name='3498'>
<font color=#447700>!<a name='3499'></font>
        FMAX(K)=FMAXK<a name='3500'>
        FMIN(K)=FMINK<a name='3501'>
        SUMF(K)=SUMFK<a name='3502'>
        SUMF2(K)=SUMF2K<a name='3503'>
<font color=#447700>!<a name='3504'></font>
      ENDDO layer_loop<a name='3505'>
<font color=#447700>!<a name='3506'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3507'></font>
<font color=#447700>!***  GLOBAL STATS<a name='3508'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3509'></font>
<font color=#447700>!<a name='3510'></font>
      CALL MPI_REDUCE(SUMF,SUMF_0,KTE,MPI_REAL8,MPI_SUM,0              &amp;<a name='3511'>
     &amp;               ,MPI_COMM_COMP,IRTN)<a name='3512'>
      CALL MPI_REDUCE(SUMF2,SUMF2_0,KTE,MPI_REAL8,MPI_SUM,0            &amp;<a name='3513'>
     &amp;               ,MPI_COMM_COMP,IRTN)<a name='3514'>
      CALL MPI_REDUCE(FMAX,FMAX_0,KTE,MPI_REAL,MPI_MAX,0               &amp;<a name='3515'>
     &amp;               ,MPI_COMM_COMP,IRTN)<a name='3516'>
      CALL MPI_REDUCE(FMIN,FMIN_0,KTE,MPI_REAL,MPI_MIN,0               &amp;<a name='3517'>
     &amp;               ,MPI_COMM_COMP,IRTN)<a name='3518'>
<font color=#447700>!<a name='3519'></font>
      IF(MYPE==0)THEN<a name='3520'>
        POINTS=I_BY_J<a name='3521'>
        DO K=KTE,KTS,-1<a name='3522'>
          F_MEAN=SUMF_0(K)/POINTS<a name='3523'>
          ST_DEV=SQRT((AMAX1(0.0,POINTS*SUMF2_0(K)-SUMF_0(K)*SUMF_0(K))/ &amp;<a name='3524'>
     &amp;                (POINTS*(POINTS-1))))<a name='3525'>
          RMS=SQRT(SUMF2_0(K)/POINTS)<a name='3526'>
          KFLIP=KTE-K+1<a name='3527'>
          WRITE(message,101)KFLIP,FMAX_0(K),FMIN_0(K)<a name='3528'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#FIELD_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_238">(trim(message))<a name='3529'>
          WRITE(message,102)F_MEAN,ST_DEV,RMS<a name='3530'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#FIELD_STATS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_239">(trim(message))<a name='3531'>
  101     FORMAT(' LAYER=',I2,' MAX=',E13.6,' MIN=',E13.6)<a name='3532'>
  102     FORMAT(9X,' MEAN=',E13.6,' STDEV=',E13.6,' RMS=',E13.6)<a name='3533'>
        ENDDO<a name='3534'>
      ENDIF<a name='3535'>
#endif<a name='3536'>
<font color=#447700>!----------------------------------------------------------------------<a name='3537'></font>
      END SUBROUTINE FIELD_STATS<a name='3538'>
<a name='3539'>
<A NAME='CHECK_GRID'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3540'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>check_grid</font>(grid,config_flags,where, &amp; <A href='../../call_to/CHECK_GRID.html' TARGET='index'>28</A>,<A href='../../call_from/CHECK_GRID.html' TARGET='index'>9</A><a name='3541'>
                            IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='3542'>
                            IMS,IME,JMS,JME,KMS,KME, &amp;<a name='3543'>
                            ITS,ITE,JTS,JTE,KTS,KTE)<a name='3544'>
        use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_89">, only : domain<a name='3545'>
        use <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_53">, only : grid_config_rec_type<a name='3546'>
#ifndef NO_IEEE_MODULE<a name='3547'>
        use, intrinsic :: ieee_arithmetic<a name='3548'>
#endif<a name='3549'>
        implicit none<a name='3550'>
        LOGICAL ISNAN, EXTERNAL           <font color=#447700>! NaN values detection<a name='3551'></font>
        character*(*), intent(in) :: where<a name='3552'>
        type(grid_config_rec_type),intent(in) :: config_flags<a name='3553'>
        type(domain), intent(in) :: grid<a name='3554'>
        INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                  &amp;<a name='3555'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='3556'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='3557'>
        <font color=#447700>! - locals - !<a name='3558'></font>
        character(len=255) :: message<a name='3559'>
        integer :: i,j,k<a name='3560'>
<a name='3561'>
        if(config_flags%halo_debug/=2 .and. config_flags%halo_debug/=3) then<a name='3562'>
           return<a name='3563'>
        endif<a name='3564'>
#ifndef NO_IEEE_MODULE<a name='3565'>
        call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_135">(2,'Check for NaN')<a name='3566'>
<a name='3567'>
        do k=kts,kte-1<a name='3568'>
           do j=jts,jte<a name='3569'>
              do i=its,ite<a name='3570'>
                 if(ieee_is_nan(grid%w(i,j,k))) then<a name='3571'>
                    write(message,303) where,'W',i,j,k<a name='3572'>
                    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_140">(message)<a name='3573'>
                 endif<a name='3574'>
                 if(ieee_is_nan(grid%u(i,j,k))) then<a name='3575'>
                    write(message,303) where,'U',i,j,k<a name='3576'>
                    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_141">(message)<a name='3577'>
                 endif<a name='3578'>
                 if(ieee_is_nan(grid%v(i,j,k))) then<a name='3579'>
                    write(message,303) where,'V',i,j,k<a name='3580'>
                    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_142">(message)<a name='3581'>
                 endif<a name='3582'>
                 if(ieee_is_nan(grid%t(i,j,k))) then<a name='3583'>
                    write(message,303) where,'T',i,j,k<a name='3584'>
                    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_143">(message)<a name='3585'>
                 endif<a name='3586'>
                 if(ieee_is_nan(grid%q(i,j,k))) then<a name='3587'>
                    write(message,303) where,'Q',i,j,k<a name='3588'>
                    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_144">(message)<a name='3589'>
                 endif<a name='3590'>
                 if(ieee_is_nan(grid%cwm(i,j,k))) then<a name='3591'>
                    write(message,303) where,'CWM',i,j,k<a name='3592'>
                    call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#CHECK_GRID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_145">(message)<a name='3593'>
                 endif<a name='3594'>
303              format('check_grid(...,"',A,'",...): NaN at ',A,'(',I0,',',I0,',',I0,')')<a name='3595'>
              enddo<a name='3596'>
           enddo<a name='3597'>
        enddo<a name='3598'>
#endif<a name='3599'>
      END SUBROUTINE check_grid<a name='3600'>
<font color=#447700>!----------------------------------------------------------------------<a name='3601'></font>
#if defined(NMM_FIND_LOAD_IMBALANCE)<a name='3602'>
<A NAME='BLOCKF'><A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3603'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>BLOCKF</font>(block_tim,what) <A href='../../call_to/BLOCKF.html' TARGET='index'>38</A>,<A href='../../call_from/BLOCKF.html' TARGET='index'>5</A><a name='3604'>
#if defined(DM_PARALLEL)<a name='3605'>
        use <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_17">, only: now_time<a name='3606'>
        use <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_62">, only : local_communicator<a name='3607'>
        implicit none<a name='3608'>
        integer :: ierr<a name='3609'>
        real, intent(inout) :: block_tim<a name='3610'>
        character*(*), intent(in) :: what<a name='3611'>
        real*8 :: when, len<a name='3612'>
        character*255 :: message<a name='3613'>
        when=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_59">()<a name='3614'>
        call mpi_barrier(local_communicator,ierr)<a name='3615'>
        len=<A href='../../html_code/frame/module_timing.F.html#NOW_TIME'>now_time</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOW_TIME_60">()-when<a name='3616'>
        if(len&gt;1.0) then<a name='3617'>
100        format(A,': large load imbalance: ',F0.5)<a name='3618'>
           write(message,100) trim(what),len<a name='3619'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_nmm/solve_nmm.F.html#BLOCKF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_240">(trim(message))<a name='3620'>
        endif<a name='3621'>
        block_tim=real(block_tim+len)<a name='3622'>
#else<a name='3623'>
        return<a name='3624'>
#endif<a name='3625'>
      END SUBROUTINE BLOCKF<a name='3626'>
#endif<a name='3627'>
</pre></body></html>