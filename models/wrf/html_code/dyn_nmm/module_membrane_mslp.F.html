<HTML> <BODY BGCOLOR=#bbeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_MEMBRANE_MSLP'><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MODULE_MEMBRANE_MSLP' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>module </font><font color=#cc0000>module_membrane_mslp</font> <A href='../../call_to/MODULE_MEMBRANE_MSLP.html' TARGET='index'>2</A><a name='3'>
  implicit none<a name='4'>
  private<a name='5'>
<a name='6'>
#if ( HWRF == 1 )<a name='7'>
<a name='8'>
  public :: make_membrane_mslp<a name='9'>
<a name='10'>
  integer, parameter :: npres = 33<a name='11'>
  real, parameter :: badheight=-9e9<a name='12'>
<a name='13'>
  <font color=#447700>! NCEP Unified Post standard pressure levels (SLPDEF) used for this<a name='14'></font>
  <font color=#447700>! membrane MSLP calculation.  These are ALL of the post pressure<a name='15'></font>
  <font color=#447700>! levels up to 200mbar:<a name='16'></font>
  real, parameter :: post_stdpres(npres) = (/ 20000.,          &amp;<a name='17'>
       22500., 25000., 27500., 30000., 32500., 35000., 37500., 40000., &amp;<a name='18'>
       42500., 45000., 47500., 50000., 52500., 55000., 57500., 60000., &amp;<a name='19'>
       62500., 65000., 67500., 70000., 72500., 75000., 77500., 80000., &amp;<a name='20'>
       82500., 85000., 87500., 90000., 92500., 95000., 97500.,100000./)<a name='21'>
<a name='22'>
  <font color=#447700>! index within post_stdpres of the 850mbar, 700mbar and 500mbar<a name='23'></font>
  <font color=#447700>! levels, respectively:<a name='24'></font>
  integer, parameter :: k850 = 27, k700=21, k500=13<a name='25'>
<a name='26'>
  <font color=#447700>! Pressure "interface" levels, used only for interpolation.  These<a name='27'></font>
  <font color=#447700>! are half-way between pressure levels (post_stdpres) in pressure<a name='28'></font>
  <font color=#447700>! space (instead of z, Z or density), to match assumptions made in<a name='29'></font>
  <font color=#447700>! the post's Memberane MSLP calculation:<a name='30'></font>
  real, parameter :: post_istdpres(npres+1) = (/ 18750., &amp;<a name='31'>
       21250., 23750., 26250., 28750., 31250., 33750., 36250., 38750., &amp;<a name='32'>
       41250., 43750., 46250., 48750., 51250., 53750., 56250., 58750., &amp;<a name='33'>
       61250., 63750., 66250., 68750., 71250., 73750., 76250., 78750., &amp;<a name='34'>
       81250., 83750., 86250., 88750., 91250., 93750., 96250., 98750., &amp;<a name='35'>
       101250./)<a name='36'>
<a name='37'>
  <font color=#447700>! Constants from the NCEP Unified Post used for interpolation and<a name='38'></font>
  <font color=#447700>! extrapolation:<a name='39'></font>
  real, parameter :: post_H1=1.0<a name='40'>
  real, parameter :: post_PQ0=379.90516<a name='41'>
  real, parameter :: post_A2=17.2693882<a name='42'>
  real, parameter :: post_A3=273.16<a name='43'>
  real, parameter :: post_A4=35.86<a name='44'>
  real, parameter :: post_D608=0.608<a name='45'>
  real, parameter :: post_RD=287.04<a name='46'>
  real, parameter :: post_G=9.81<a name='47'>
  real, parameter :: post_GAMMA=6.5E-3<a name='48'>
  real, parameter :: post_RGAMOG=post_RD*post_GAMMA/post_G<a name='49'>
  real, parameter :: post_RHmin=1.0E-6     <font color=#447700>! minimal RH bound<a name='50'></font>
  real, parameter :: post_smallQ=1.E-12<a name='51'>
<a name='52'>
  real, parameter :: post_slope=-6.6e-4 <font color=#447700>! K/km<a name='53'></font>
<a name='54'>
  REAL, PARAMETER :: old_COEF3=post_RD*post_SLOPE<a name='55'>
  REAL, PARAMETER :: old_COEF2=-1./old_COEF3<a name='56'>
<a name='57'>
contains<a name='58'>
<a name='59'>
<A NAME='MAKE_MEMBRANE_MSLP'><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MAKE_MEMBRANE_MSLP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='60'>
  <font color=#993300>subroutine </font><font color=#cc0000>make_membrane_mslp</font>(grid) <A href='../../call_to/MAKE_MEMBRANE_MSLP.html' TARGET='index'>1</A>,<A href='../../call_from/MAKE_MEMBRANE_MSLP.html' TARGET='index'>5</A><a name='61'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>MODULE_DOMAIN</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MAKE_MEMBRANE_MSLP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_37">, ONLY : domain,get_ijk_from_grid<a name='62'>
    implicit none<a name='63'>
    type(domain), intent(inout) :: grid<a name='64'>
    character*255 :: message<a name='65'>
<a name='66'>
    integer :: IDS,IDE,JDS,JDE,KDS,KDE<a name='67'>
    integer :: IMS,IME,JMS,JME,KMS,KME<a name='68'>
    integer :: IPS,IPE,JPS,JPE,KPS,KPE<a name='69'>
<a name='70'>
    <font color=#447700>! Make sure the two constant pressure level values are right:<a name='71'></font>
100 format('In module_membrane_mslp, post_stdpres(',A,')=',F0.3,' but should be ',F0.3)<a name='72'>
    if(abs(post_stdpres(k850)-85000.)&gt;1) then<a name='73'>
       write(message,100) 'k850',post_stdpres(k850),85000.<a name='74'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MAKE_MEMBRANE_MSLP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_81">(message)<a name='75'>
    endif<a name='76'>
    if(abs(post_stdpres(k700)-70000.)&gt;1) then<a name='77'>
       write(message,100) 'k850',post_stdpres(k700),70000.<a name='78'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MAKE_MEMBRANE_MSLP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_82">(message)<a name='79'>
    endif<a name='80'>
<a name='81'>
    CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MAKE_MEMBRANE_MSLP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_12"> (  grid ,      &amp;<a name='82'>
         ids, ide, jds, jde, kds, kde,    &amp;<a name='83'>
         ims, ime, jms, jme, kms, kme,    &amp;<a name='84'>
         ips, ipe, jps, jpe, kps, kpe    )<a name='85'>
<a name='86'>
    call <A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL'>membrane_mslp_impl</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MAKE_MEMBRANE_MSLP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MEMBRANE_MSLP_IMPL_1">(grid,         &amp;<a name='87'>
         ids, ide, jds, jde, kds, kde,    &amp;<a name='88'>
         ims, ime, jms, jme, kms, kme,    &amp;<a name='89'>
         ips, ipe, jps, jpe, kps, kpe    )<a name='90'>
<a name='91'>
  end subroutine make_membrane_mslp<a name='92'>
<a name='93'>
  <font color=#447700>! ------------------------------------------------------------<a name='94'></font>
  <font color=#447700>! BEGIN IMPLEMENTATION<a name='95'></font>
  <font color=#447700>! ------------------------------------------------------------<a name='96'></font>
<a name='97'>
<a name='98'>
  <font color=#447700>! ------------------------------------------------------------<a name='99'></font>
  <font color=#447700>! membrane_mslp_impl - top-level implementation function<a name='100'></font>
<A NAME='MEMBRANE_MSLP_IMPL'><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='101'>
  <font color=#993300>subroutine </font><font color=#cc0000>membrane_mslp_impl</font>(grid, &amp; <A href='../../call_to/MEMBRANE_MSLP_IMPL.html' TARGET='index'>1</A>,<A href='../../call_from/MEMBRANE_MSLP_IMPL.html' TARGET='index'>12</A><a name='102'>
       IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='103'>
       IMS,IME,JMS,JME,KMS,KME, &amp;<a name='104'>
       IPS,IPE,JPS,JPE,KPS,KPE)<a name='105'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>MODULE_DOMAIN</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_38">, ONLY : domain<a name='106'>
    USE <A href='../../html_code/dyn_nmm/module_relax.F.html#MODULE_RELAX'>MODULE_RELAX</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RELAX_1"><a name='107'>
#ifdef DM_PARALLEL<a name='108'>
    USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>MODULE_COMM_DM</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_14">, ONLY : HALO_NMM_MEMBRANE_INTERP_sub<a name='109'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>MODULE_DM</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_28">, ONLY: ntasks_x, ntasks_y, mytask, ntasks, local_communicator<a name='110'>
    use <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_29">, only: wrf_dm_minval_real, wrf_dm_maxval_integer<a name='111'>
#endif<a name='112'>
<a name='113'>
    implicit none<a name='114'>
<a name='115'>
    type(domain), intent(inout) :: grid<a name='116'>
<a name='117'>
    integer, intent(in) :: IDS,IDE,JDS,JDE,KDS,KDE<a name='118'>
    integer, intent(in) :: IMS,IME,JMS,JME,KMS,KME<a name='119'>
    integer, intent(in) :: IPS,IPE,JPS,JPE,KPS,KPE<a name='120'>
<a name='121'>
    real :: presTv(ips:ipe,jps:jpe,npres), Pmsl(ips:ipe,jps:jpe)<a name='122'>
    real :: presZ(ips:ipe,jps:jpe,npres)<a name='123'>
<a name='124'>
    real :: interP(ips:ipe,jps:jpe,npres+1), interZ(ips:ipe,jps:jpe,npres+1)<a name='125'>
<a name='126'>
    logical :: ground_mask(ips:ipe,jps:jpe,npres)<a name='127'>
    integer :: ground_level(ips:ipe,jps:jpe)<a name='128'>
    integer :: ipres,i,j,mpres,imin,jmin,k,need_to_relax,imax,jmax<a name='129'>
    real :: pmin<a name='130'>
    character*255 :: message<a name='131'>
<a name='132'>
    if(size(grid%p700rv)&gt;1) then<a name='133'>
       <font color=#447700>! Need a halo for winds in order to get vorticity and H point wind magnetudes:<a name='134'></font>
#ifdef DM_PARALLEL<a name='135'>
#      include "<A href='../../html_code/include/HALO_NMM_MEMBRANE_INTERP.inc.html'>HALO_NMM_MEMBRANE_INTERP.inc</A>"<A NAME="HALO_NMM_MEMBRANE_INTERP.inc_1"><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='136'>
#endif<a name='137'>
    endif<a name='138'>
<a name='139'>
    <font color=#447700>! UPPER BOUND: MPRES<a name='140'></font>
<a name='141'>
    <font color=#447700>! Find mpres: the lowest pressure that we need to handle.  This is<a name='142'></font>
    <font color=#447700>! mostly for efficiency: we don't need to interpolate or relax<a name='143'></font>
    <font color=#447700>! anything higher in the atmosphere than the next pressure level<a name='144'></font>
    <font color=#447700>! above the domain-wide lowest surface pressure:<a name='145'></font>
    pmin=9e9<a name='146'>
    imin=-99<a name='147'>
    jmin=-99<a name='148'>
    do j=max(jps,jds),min(jpe,jde-1)<a name='149'>
       do i=max(ips,ids),min(ipe,ide-1)<a name='150'>
          pmin=min(pmin,grid%pint(i,j,1))<a name='151'>
          imin=i<a name='152'>
          jmin=j<a name='153'>
       enddo<a name='154'>
    enddo<a name='155'>
#ifdef DM_PARALLEL<a name='156'>
    call <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_REAL'>wrf_dm_minval_real</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MINVAL_REAL_1">(pmin,imin,jmin)<a name='157'>
#endif<a name='158'>
<a name='159'>
    <font color=#447700>! FIXME: DON'T HANDLE ANYTHING ABOVE PMIN<a name='160'></font>
    <font color=#447700>! NOTE: MUST HANDLE TWO LEVELS ABOVE<a name='161'></font>
<a name='162'>
    <font color=#447700>! Step 1: calculate Tv, Q and Z on pressure levels using the same<a name='163'></font>
    <font color=#447700>! method as the NCEP Unified Post:<a name='164'></font>
    call <A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D'>calculate_3D</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_3D_1">(grid,presTv,presZ,ground_mask,ground_level, &amp;<a name='165'>
         IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='166'>
         IMS,IME,JMS,JME,KMS,KME, &amp;<a name='167'>
         IPS,IPE,JPS,JPE,KPS,KPE)<a name='168'>
<a name='169'>
    <font color=#447700>! Step 2: smooth Tv through an overrelaxation method:<a name='170'></font>
<a name='171'>
    <font color=#447700>! Modify the relax mask so that the outermost three rows and<a name='172'></font>
    <font color=#447700>! columns are always relaxed.  This is needed to overcome bad<a name='173'></font>
    <font color=#447700>! values fed in from the parent every timestep.  Setting the mask<a name='174'></font>
    <font color=#447700>! to true on the boundaries of the domain prevent them from being<a name='175'></font>
    <font color=#447700>! used as boundaries of the overrelaxation.  <a name='176'></font>
<a name='177'>
    <font color=#447700>! (Some of the reasons for boundary issues: The parent and nest<a name='178'></font>
    <font color=#447700>! terrain will never match because the nest terrain is smoothed on<a name='179'></font>
    <font color=#447700>! the boundary, and the parent is not.  Also, the user may have<a name='180'></font>
    <font color=#447700>! set a different terrain for different domains in their<a name='181'></font>
    <font color=#447700>! namelist.wps, in which case you'll get an even worse mismatch.<a name='182'></font>
    <font color=#447700>! Every time the nest moves, ips terrain changes on the leading<a name='183'></font>
    <font color=#447700>! and trailing edges of the nest.  That causes huge shocks when<a name='184'></font>
    <font color=#447700>! there are high mountains near the boundaries.  If you do a plot<a name='185'></font>
    <font color=#447700>! of 500mbar geopotential height, it looks like a piece of jello<a name='186'></font>
    <font color=#447700>! shaking every time the nest moves.  Also, there is some<a name='187'></font>
    <font color=#447700>! weirdness on the lateral boundaries of the MOAD due to the<a name='188'></font>
    <font color=#447700>! mismatch between GFS terrain (which has its higher spectral<a name='189'></font>
    <font color=#447700>! components discarded) and the smoothed HWRF terrain.)<a name='190'></font>
<a name='191'>
    grid%relaxmask=.true.<a name='192'>
<a name='193'>
    <font color=#447700>! Now loop over all vertical levels and relax them:<a name='194'></font>
    do ipres=npres,1,-1<a name='195'>
       <font color=#447700>! In the inner regions (all but outermost row &amp; col) set the<a name='196'></font>
       <font color=#447700>! relaxmask to the ground_mask:<a name='197'></font>
       need_to_relax=0<a name='198'>
       do j=max(jps,jds+1),min(jde-2,jpe)<a name='199'>
          do i=max(ips,ids+1),min(ide-2,ipe)<a name='200'>
             grid%relaxmask(i,j)=ground_mask(i,j,ipres)<a name='201'>
             if(grid%relaxmask(i,j)) need_to_relax=1<a name='202'>
          enddo<a name='203'>
       enddo<a name='204'>
<a name='205'>
       <font color=#447700>! If we do not need to relax any points, we are done.<a name='206'></font>
#ifdef DM_PARALLEL<a name='207'>
       call <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_INTEGER'>wrf_dm_maxval_integer</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_INTEGER_1">(need_to_relax,imax,jmax)<a name='208'>
#endif<a name='209'>
       if(need_to_relax==0) then<a name='210'>
 38       format('end mslp relax loop at ',I0)<a name='211'>
          write(message,38) ipres<a name='212'>
          call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_48">(2,message)<a name='213'>
          exit<a name='214'>
       endif<a name='215'>
<a name='216'>
       <font color=#447700>! Store Tv in relaxwork:<a name='217'></font>
       do j=jps,min(jde-1,jpe)<a name='218'>
          do i=ips,min(ide-1,ipe)<a name='219'>
             grid%relaxwork(i,j)=presTv(i,j,ipres)<a name='220'>
          enddo<a name='221'>
       enddo<a name='222'>
<a name='223'>
       <font color=#447700>! Overrelax:<a name='224'></font>
       call <A href='../../html_code/dyn_nmm/module_relax.F.html#RELAX4E'>relax4e</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX4E_1">(grid,0.7,100,2, &amp;<a name='225'>
            IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='226'>
            IMS,IME,JMS,JME,KMS,KME, &amp;<a name='227'>
            IPS,IPE,JPS,JPE,KPS,KPE)<a name='228'>
<a name='229'>
       <font color=#447700>! Copy back the modified relaxation mask<a name='230'></font>
       do j=jps,min(jde-1,jpe)<a name='231'>
          do i=ips,min(ide-1,ipe)<a name='232'>
             ground_mask(i,j,ipres)=grid%relaxmask(i,j)<a name='233'>
          enddo<a name='234'>
       enddo<a name='235'>
<a name='236'>
       <font color=#447700>! Copy the relaxed values back to Tv:<a name='237'></font>
       do j=jps,min(jde-1,jpe)<a name='238'>
          do i=ips,min(ide-1,ipe)<a name='239'>
             presTv(i,j,ipres)=grid%relaxwork(i,j)<a name='240'>
          enddo<a name='241'>
       enddo<a name='242'>
    end do<a name='243'>
<a name='244'>
    <font color=#447700>! Step 3: Solve for Z on interface levels (pressure space<a name='245'></font>
    <font color=#447700>! interface levels) using the hydrostatic equation.  Once Z=0 is<a name='246'></font>
    <font color=#447700>! reached, solve for Pmsl.<a name='247'></font>
    call <A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_INTERP'>calculate_interP</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_INTERP_1">(presTv,presZ,grid%Z,Pmsl,grid%PINT, &amp;<a name='248'>
         grid%T(:,:,1), grid%Q(:,:,1), &amp;<a name='249'>
         ground_level, ground_mask,grid%fis, &amp;<a name='250'>
         IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='251'>
         IMS,IME,JMS,JME,KMS,KME, &amp;<a name='252'>
         IPS,IPE,JPS,JPE,KPS,KPE)<a name='253'>
<a name='254'>
    <font color=#447700>! Copy the MSLP values back to the grid:<a name='255'></font>
    do j=jps,min(jde-1,jpe)<a name='256'>
       do i=ips,min(ide-1,ipe)<a name='257'>
          grid%membrane_MSLP(i,j)=Pmsl(i,j)<a name='258'>
       enddo<a name='259'>
    enddo<a name='260'>
<a name='261'>
    <font color=#447700>! Smooth the membrane_mslp values:<a name='262'></font>
    call <A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#SMOOTHMSLP'>smoothMSLP</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#MEMBRANE_MSLP_IMPL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMOOTHMSLP_1">(grid,1, &amp;<a name='263'>
         IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='264'>
         IMS,IME,JMS,JME,KMS,KME, &amp;<a name='265'>
         IPS,IPE,JPS,JPE,KPS,KPE)<a name='266'>
<a name='267'>
    if(size(grid%p850z)&gt;1) then<a name='268'>
       <font color=#447700>! Copy 700 and 850 mbar heights to their arrays:<a name='269'></font>
       do j=max(jds,jps),min(jde-1,jpe)<a name='270'>
          do i=max(ids,ips),min(ide-1,ipe)<a name='271'>
             grid%p850z(i,j)=presZ(i,j,k850)<a name='272'>
             grid%p700z(i,j)=presZ(i,j,k700)<a name='273'>
          enddo<a name='274'>
       enddo<a name='275'>
    endif<a name='276'>
<a name='277'>
  end subroutine membrane_mslp_impl<a name='278'>
<a name='279'>
<A NAME='CALCULATE_3D'><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='280'>
  <font color=#993300>subroutine </font><font color=#cc0000>calculate_3D</font>(grid,presTv,presZ,ground_mask,ground_level, &amp; <A href='../../call_to/CALCULATE_3D.html' TARGET='index'>1</A>,<A href='../../call_from/CALCULATE_3D.html' TARGET='index'>13</A><a name='281'>
       IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='282'>
       IMS,IME,JMS,JME,KMS,KME, &amp;<a name='283'>
       IPS,IPE,JPS,JPE,KPS,KPE)<a name='284'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>MODULE_DOMAIN</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_39">, ONLY : domain<a name='285'>
#ifdef DM_PARALLEL<a name='286'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>MODULE_DM</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_30">, ONLY: ntasks_x, ntasks_y, mytask, ntasks, local_communicator<a name='287'>
    USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>MODULE_COMM_DM</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_15">, ONLY : HALO_NMM_MEMBRANE_INTERP_sub<a name='288'>
    use <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_31">, only: wrf_dm_maxval_integer<a name='289'>
#endif<a name='290'>
    implicit none<a name='291'>
<a name='292'>
    type(domain), intent(inout) :: grid<a name='293'>
<a name='294'>
    integer, intent(in) :: IDS,IDE,JDS,JDE,KDS,KDE<a name='295'>
    integer, intent(in) :: IMS,IME,JMS,JME,KMS,KME<a name='296'>
    integer, intent(in) :: IPS,IPE,JPS,JPE,KPS,KPE<a name='297'>
<a name='298'>
    real, intent(inout) :: presTv(ips:ipe,jps:jpe,npres)<a name='299'>
    real, intent(inout) :: presZ(ips:ipe,jps:jpe,npres)<a name='300'>
<a name='301'>
    logical, intent(inout) :: ground_mask(ips:ipe,jps:jpe,npres)<a name='302'>
    integer, intent(inout) :: ground_level(ips:ipe,jps:jpe)<a name='303'>
<a name='304'>
    integer :: Tkdest(ips:ipe,jps:jpe), Zkdest(ips:ipe,jps:jpe), Zbottom(ips:ipe,jps:jpe)<a name='305'>
    integer :: i,j,ks,a,kd,k<a name='306'>
    real :: weight, TL,QL,PL, tempT, RHL, TVRL, TVRBLO, TBLO,QBLO<a name='307'>
<a name='308'>
    integer,target, dimension(ips:ipe,jps:jpe) :: ks850,ks700,ks500<a name='309'>
    real, target,dimension(ips:ipe,jps:jpe) :: dummy1,dummy2<a name='310'>
    integer, pointer, dimension(:,:) :: ksX<a name='311'>
    integer :: nanfound<a name='312'>
    real, pointer, dimension(:,:) :: preswind,presrv,presu,presv<a name='313'>
<a name='314'>
    real :: Pmass(ips:ipe,jps:jpe,kds:kde)<a name='315'>
    real :: numsum,densum,modelP1,modelP2,pdiff,presQ,presT,ZL,QSAT, U1, V1, U2, V2, dudy1,dvdx1, dudy2,dvdx2<a name='316'>
    character*255 :: message<a name='317'>
    logical :: wantuv<a name='318'>
    <a name='319'>
#ifdef DM_PARALLEL<a name='320'>
#      include "<A href='../../html_code/include/HALO_NMM_MEMBRANE_INTERP.inc.html'>HALO_NMM_MEMBRANE_INTERP.inc</A>"<A NAME="HALO_NMM_MEMBRANE_INTERP.inc_2"><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='321'>
#endif<a name='322'>
<a name='323'>
    <font color=#447700>! ks: k in source (model level) array<a name='324'></font>
    <font color=#447700>! kd: k in destination (pressure level) array<a name='325'></font>
    ground_level=0<a name='326'>
    ground_mask=.false.<a name='327'>
    Zkdest=1<a name='328'>
    Tkdest=1<a name='329'>
    Zbottom=0<a name='330'>
<a name='331'>
    ks850=0<a name='332'>
    ks700=0<a name='333'>
    ks500=0<a name='334'>
<a name='335'>
    <font color=#447700>! Interpolate geopotential height to post_stdpres pressure levels<a name='336'></font>
    <font color=#447700>! and create a temporary array with non-hydrostatic pressure<a name='337'></font>
    <font color=#447700>! (PINT) on model mass points:<a name='338'></font>
    do ks=kde-1,kds,-1<a name='339'>
       do j=jps,min(jde-1,jpe)<a name='340'>
          iZ: do i=ips,min(ide-1,ipe)<a name='341'>
             Pmass(i,j,ks)=sqrt(grid%PINT(i,j,ks)*grid%PINT(i,j,ks+1))<a name='342'>
          enddo iZ<a name='343'>
       enddo<a name='344'>
    enddo<a name='345'>
<a name='346'>
    <font color=#447700>! Interpolate temperature and specific humidity to post_stdpres<a name='347'></font>
    <font color=#447700>! pressure levels:<a name='348'></font>
    do ks=kde-1,kds+1,-1<a name='349'>
       do j=jps,min(jde-1,jpe)<a name='350'>
          iTQ: do i=ips,min(ide-1,ipe)<a name='351'>
             kd=Tkdest(i,j)<a name='352'>
             if(kd&lt;=npres) then<a name='353'>
                innerTQ: do while(kd&lt;=npres)<a name='354'>
                   if(.not.(post_stdpres(kd)&lt;=Pmass(i,j,ks-1) &amp;<a name='355'>
                        .and. post_stdpres(kd)&gt;=Pmass(i,j,ks))) then<a name='356'>
                      cycle iTQ<a name='357'>
                   endif<a name='358'>
                   weight=log(post_stdpres(kd)/Pmass(i,j,ks))/log(Pmass(i,j,ks-1)/Pmass(i,j,ks))<a name='359'>
<a name='360'>
                   presZ(i,j,kd)=weight*grid%Z(i,j,ks-1) + (1.-weight)*grid%Z(i,j,ks)<a name='361'>
<a name='362'>
                   presT=weight*grid%T(i,j,ks-1) + (1.-weight)*grid%T(i,j,ks)<a name='363'>
                   presQ=weight*grid%Q(i,j,ks-1) + (1.-weight)*grid%Q(i,j,ks)<a name='364'>
                   presTv(i,j,kd)=presT*(1.+post_D608*presQ)<a name='365'>
<a name='366'>
                   if(kd==k850) then<a name='367'>
                      ks850(i,j)=ks<a name='368'>
                   elseif(kd==k700) then<a name='369'>
                      ks700(i,j)=ks<a name='370'>
                   elseif(kd==k500) then<a name='371'>
                      ks500(i,j)=ks<a name='372'>
                   endif<a name='373'>
<a name='374'>
103                format('interp ks=',I0,' kd=',I0,' presT(i=',I0,',j=',I0,',kd)=',F0.3, &amp;<a name='375'>
                        ' between T(i,j,ks-1)=',F0.3,' and T(i,j,ks)=', &amp;<a name='376'>
                        F0.3,' using weight=',F0.3)<a name='377'>
                   <font color=#447700>!write(0,103) ks,kd,i,j,presT,grid%T(i,j,ks-1),grid%T(i,j,ks),weight<a name='378'></font>
104                format(' Pmass(i,j,ks)=',F0.3,' Pmass(i,j,ks-1)=',F0.3,' post_stdpres(kd)=',F0.3)<a name='379'>
                   <font color=#447700>!write(0,104) Pmass(i,j,ks),Pmass(i,j,ks-1),post_stdpres(kd)<a name='380'></font>
                   if(weight&lt;0 .or. weight&gt;1) then<a name='381'>
                      write(0,*) 'Bad weight: ',weight<a name='382'>
                      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_83">('bad weight')<a name='383'>
                   endif<a name='384'>
                   kd=kd+1<a name='385'>
                   Tkdest(i,j)=kd<a name='386'>
                   Zkdest(i,j)=kd<a name='387'>
                   Zbottom(i,j)=ks<a name='388'>
                end do innerTQ<a name='389'>
             end if<a name='390'>
          end do iTQ<a name='391'>
       end do<a name='392'>
    end do<a name='393'>
<a name='394'>
   <font color=#447700>! Interpolate to regions between the middle of the lowest mass<a name='395'></font>
   <font color=#447700>! level and the bottom of the atmosphere:<a name='396'></font>
   do j=jps,min(jde-1,jpe)<a name='397'>
      iTQ2: do i=ips,min(ide-1,ipe)<a name='398'>
         kd=Zkdest(i,j)<a name='399'>
         if(kd&lt;=npres) then<a name='400'>
            do while(kd&lt;=npres)<a name='401'>
               if(.not.(post_stdpres(kd)&lt;=grid%PINT(i,j,kds) &amp;<a name='402'>
                    .and. post_stdpres(kd)&gt;=Pmass(i,j,kds))) then<a name='403'>
                  cycle iTQ2<a name='404'>
               endif<a name='405'>
<a name='406'>
               presT=grid%T(i,j,1)<a name='407'>
               presQ=grid%Q(i,j,1)<a name='408'>
               presTv(i,j,kd)=presT*(1.+post_D608*presQ)<a name='409'>
<a name='410'>
               weight=log(post_stdpres(kd)/Pmass(i,j,kds))/log(grid%PINT(i,j,kds)/Pmass(i,j,kds))<a name='411'>
               presZ(i,j,kd)=(1.-weight)*grid%Z(i,j,1)+weight*grid%fis(i,j)/post_g<a name='412'>
<a name='413'>
               kd=kd+1<a name='414'>
               Tkdest(i,j)=kd<a name='415'>
               Zkdest(i,j)=kd<a name='416'>
               Zbottom(i,j)=ks<a name='417'>
            end do<a name='418'>
         end if<a name='419'>
      end do iTQ2<a name='420'>
   end do<a name='421'>
<a name='422'>
1234 format('grid ',I0,': size(',A,') = ',I0)<a name='423'>
   write(message,1234) grid%id,'grid%p700rv',size(grid%p700rv)<a name='424'>
   call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_49">(2,trim(message))<a name='425'>
   write(message,1234) grid%id,'grid%p700u',size(grid%p700u)<a name='426'>
   call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_50">(2,trim(message))<a name='427'>
<a name='428'>
   wantuv=(grid%vortex_tracker == 7) <font color=#447700>! do I need to calc. presu &amp; presv?<a name='429'></font>
<a name='430'>
   ifwind: if(size(grid%p700rv)&gt;1 .or. size(grid%p700u)&gt;1) then<a name='431'>
    <font color=#447700>! Interpolate wind to H points on pressure levels, calculating<a name='432'></font>
    <font color=#447700>! horizontal wind vector magnitude and vertical component of<a name='433'></font>
    <font color=#447700>! vorticity.  Interpolate only to 700 and 850 mbar, except for U &amp;<a name='434'></font>
    <font color=#447700>! V which are also interpolated to 500mbar.<a name='435'></font>
    nullify(presu)<a name='436'>
    nullify(presv)<a name='437'>
    windloop: do k=0,2<a name='438'>
       if(k==0) then<a name='439'>
          <font color=#447700>! Only need wind components at 500 mbar<a name='440'></font>
          kd=k500<a name='441'>
          ksX=&gt;ks500<a name='442'>
          preswind=&gt;dummy1<a name='443'>
          presrv=&gt;dummy2<a name='444'>
          if(wantuv) then<a name='445'>
             presu=&gt;grid%p500u<a name='446'>
             presv=&gt;grid%p500v<a name='447'>
          endif<a name='448'>
       elseif(k==1) then<a name='449'>
          ksX=&gt;ks700<a name='450'>
          preswind=&gt;grid%p700wind<a name='451'>
          presrv=&gt;grid%p700rv<a name='452'>
          kd=k700<a name='453'>
          if(wantuv) then<a name='454'>
             presu=&gt;grid%p700u<a name='455'>
             presv=&gt;grid%p700v<a name='456'>
          endif<a name='457'>
       elseif(k==2) then<a name='458'>
          ksX=&gt;ks850<a name='459'>
          kd=k850<a name='460'>
          preswind=&gt;grid%p850wind<a name='461'>
          presrv=&gt;grid%p850rv <a name='462'>
          if(wantuv) then<a name='463'>
             presu=&gt;grid%p850u<a name='464'>
             presv=&gt;grid%p850v<a name='465'>
          endif<a name='466'>
       endif<a name='467'>
<a name='468'>
      <font color=#447700>! No wind on boundaries:<a name='469'></font>
      if(jps&lt;=jds) then<a name='470'>
         do i=ips,min(ide-1,ipe)<a name='471'>
            preswind(i,jds)=0<a name='472'>
            presrv(i,jds)=0<a name='473'>
         enddo<a name='474'>
         if(wantuv) then<a name='475'>
            do i=ips,min(ide-1,ipe)<a name='476'>
               presu(i,jds)=0<a name='477'>
               presv(i,jds)=0<a name='478'>
            enddo<a name='479'>
         endif<a name='480'>
      endif<a name='481'>
      if(jpe&gt;=jde-1) then<a name='482'>
         do i=ips,min(ide-1,ipe)<a name='483'>
            preswind(i,jde-1)=0<a name='484'>
            presrv(i,jde-1)=0<a name='485'>
         enddo<a name='486'>
         if(wantuv) then<a name='487'>
            do i=ips,min(ide-1,ipe)<a name='488'>
               presu(i,jde-1)=0<a name='489'>
               presv(i,jde-1)=0<a name='490'>
            enddo<a name='491'>
         endif<a name='492'>
      endif<a name='493'>
      if(ips&lt;=ids) then<a name='494'>
         do j=jps,min(jde-1,jpe)<a name='495'>
            preswind(ids,j)=0<a name='496'>
            presrv(ids,j)=0<a name='497'>
         enddo<a name='498'>
         if(wantuv) then<a name='499'>
            do j=jps,min(jde-1,jpe)<a name='500'>
               presu(ids,j)=0<a name='501'>
               presv(ids,j)=0<a name='502'>
            enddo<a name='503'>
         endif<a name='504'>
      endif<a name='505'>
      if(ipe&gt;=ide-1) then<a name='506'>
         do j=jps,min(jde-1,jpe)<a name='507'>
            preswind(ide-1,j)=0<a name='508'>
            presrv(ide-1,j)=0<a name='509'>
         enddo<a name='510'>
         if(wantuv) then<a name='511'>
            do j=jps,min(jde-1,jpe)<a name='512'>
               presu(ide-1,j)=0<a name='513'>
               presv(ide-1,j)=0<a name='514'>
            enddo<a name='515'>
         endif<a name='516'>
      endif<a name='517'>
<a name='518'>
      <font color=#447700>! Interpolate winds:<a name='519'></font>
      do j=max(jps,jds+2),min(jde-2,jpe)<a name='520'>
         a=mod(j,2)<a name='521'>
         do i=max(ips,ids+2),min(ide-2,ipe)<a name='522'>
            ks=ksX(i,j)<a name='523'>
            if(ks&gt;1) then<a name='524'>
               <font color=#447700>! Interpolate between mass levels:<a name='525'></font>
               weight=log(post_stdpres(kd)/Pmass(i,j,ks))/log(Pmass(i,j,ks-1)/Pmass(i,j,ks))<a name='526'>
<a name='527'>
               U1=0.25*(grid%u(i,j-1,ks) + grid%u(i,j+1,ks) + grid%u(i-a,j,ks) + grid%u(i+1-a,j,ks))<a name='528'>
               V1=0.25*(grid%v(i,j-1,ks) + grid%v(i,j+1,ks) + grid%v(i-a,j,ks) + grid%v(i+1-a,j,ks))<a name='529'>
               U2=0.25*(grid%u(i,j-1,ks-1) + grid%u(i,j+1,ks-1) + grid%u(i-a,j,ks-1) + grid%u(i+1-a,j,ks-1))<a name='530'>
               V2=0.25*(grid%v(i,j-1,ks-1) + grid%v(i,j+1,ks-1) + grid%v(i-a,j,ks-1) + grid%v(i+1-a,j,ks-1))<a name='531'>
               <a name='532'>
               dvdx1 = (grid%v(i+1-a,j,ks)-grid%v(i-a,j,ks))/(2.*grid%dx_nmm(i,j))<a name='533'>
               dudy1 = (grid%u(i,j+1,ks)-grid%u(i,j-1,ks))/(2.*grid%dy_nmm)<a name='534'>
               dvdx2 = (grid%v(i+1-a,j,ks-1)-grid%v(i-a,j,ks-1))/(2.*grid%dx_nmm(i,j))<a name='535'>
               dudy2 = (grid%u(i,j+1,ks-1)-grid%u(i,j-1,ks-1))/(2.*grid%dy_nmm)<a name='536'>
<a name='537'>
               if(wantuv) then<a name='538'>
                  presu(i,j)=weight*u2+(1.-weight)*u1<a name='539'>
                  presv(i,j)=weight*v2+(1.-weight)*v1<a name='540'>
               endif<a name='541'>
               preswind(i,j)=weight*sqrt(u2*u2+v2*v2) + (1.-weight)*sqrt(u1*u1+v1*v1)<a name='542'>
               presrv(i,j)=(dvdx2-dudy2)*weight + (dvdx1-dudy1)*(1.-weight)<a name='543'>
            elseif(post_stdpres(kd)&gt;=Pmass(i,j,kds)) then<a name='544'>
               <font color=#447700>! At and below lowest mass level, use lowest model level winds<a name='545'></font>
               ks=1<a name='546'>
               U1=0.25*(grid%u(i,j-1,ks) + grid%u(i,j+1,ks) + grid%u(i-a,j,ks) + grid%u(i+1-a,j,ks))<a name='547'>
               V1=0.25*(grid%v(i,j-1,ks) + grid%v(i,j+1,ks) + grid%v(i-a,j,ks) + grid%v(i+1-a,j,ks))<a name='548'>
               <a name='549'>
               dvdx1 = (grid%v(i+1-a,j,ks)-grid%v(i-a,j,ks))/(2.*grid%dx_nmm(i,j))<a name='550'>
               dudy1 = (grid%u(i,j+1,ks)-grid%u(i,j-1,ks))/(2.*grid%dy_nmm)<a name='551'>
<a name='552'>
               preswind(i,j)=sqrt(u1*u1 + v1*v1)<a name='553'>
               presrv(i,j)=dvdx1-dudy1<a name='554'>
               if(wantuv) then<a name='555'>
                  presu(i,j)=u1<a name='556'>
                  presv(i,j)=v1<a name='557'>
               endif<a name='558'>
            endif<a name='559'>
         end do<a name='560'>
      end do<a name='561'>
   enddo windloop<a name='562'>
<a name='563'>
   <font color=#447700>! Calculate 10m wind magnitude and vorticity<a name='564'></font>
   <font color=#447700>! NOTE: u10 and v10 are already on H points<a name='565'></font>
   nanfound=0<a name='566'>
   do j=max(jps,jds+1),min(jpe,jde-2)<a name='567'>
      a=mod(j,2)<a name='568'>
      do i=max(ips,ids+1),min(ipe,ide-2)<a name='569'>
         grid%m10wind(i,j)=sqrt(grid%u10(i,j)*grid%u10(i,j) + grid%v10(i,j)*grid%v10(i,j))<a name='570'>
         dvdx1 = 0.5*(grid%v10(i-a+1,j+1)-grid%v10(i-a,j+1) + &amp;<a name='571'>
                     grid%v10(i-a+1,j-1)-grid%v10(i-a,j-1)) / (2*grid%dx_nmm(i,j))<a name='572'>
         dudy1 = 0.5*(grid%u10(i-a,j+1)-grid%u10(i-a,j-1) + &amp;<a name='573'>
                     grid%u10(i-a+1,j+1)-grid%u10(i-a+1,j-1)) / (2*grid%dy_nmm)<a name='574'>
         grid%m10rv(i,j) = dvdx1 - dudy1<a name='575'>
         if(grid%m10rv(i,j) == grid%m10rv(i,j)) then<a name='576'>
            call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_51">(1000,'FIXME: REMOVE THIS CHECK')<a name='577'>
         else<a name='578'>
3088        format('NaN m10rv at i=',I0,' j=',I0,': a=',I0,' dx=',F0.3,' dy=',F0.3)<a name='579'>
            write(message,3088) i,j,a,grid%dx_nmm(i,j),grid%dy_nmm<a name='580'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE2'>wrf_message2</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE2_1">(trim(message))<a name='581'>
3089        format('NaN m10rv at i=',I0,' j=',I0,': dvdx1=',F0.5,' dudy=',F0.5)<a name='582'>
            write(message,3089) i,j,dvdx1,dudy1<a name='583'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE2'>wrf_message2</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE2_2">(trim(message))<a name='584'>
            nanfound=1<a name='585'>
         endif<a name='586'>
      enddo<a name='587'>
   enddo<a name='588'>
#ifdef DM_PARALLEL<a name='589'>
   call <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_INTEGER'>wrf_dm_maxval_integer</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_INTEGER_2">(nanfound,i,j)<a name='590'>
#endif<a name='591'>
   if(nanfound/=0) then<a name='592'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_84">('ERROR: NaN m10rv seen; aborting.')<a name='593'>
   endif<a name='594'>
  elseif(grid%id==3) then<a name='595'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_85">('ERROR: NOT INTERPOLATING WIND')<a name='596'>
  endif ifwind<a name='597'>
<a name='598'>
    do j=jps,min(jde-1,jpe)<a name='599'>
       do i=ips,min(ide-1,ipe)<a name='600'>
          ground_level(i,j)=min(Zkdest(i,j),Tkdest(i,j))<a name='601'>
       enddo<a name='602'>
    enddo<a name='603'>
<a name='604'>
    do kd=1,npres<a name='605'>
       do j=jps,min(jde-1,jpe)<a name='606'>
          do i=ips,min(ide-1,ipe)<a name='607'>
             ground_mask(i,j,kd) = (kd&gt;=ground_level(i,j))<a name='608'>
          enddo<a name='609'>
       enddo<a name='610'>
    enddo<a name='611'>
<a name='612'>
    <font color=#447700>! Extrapolate below-ground temperature but not height.  Fill in<a name='613'></font>
    <font color=#447700>! badheight for height below ground.  <a name='614'></font>
    jloop2: do j=jps,min(jde-1,jpe)<a name='615'>
       iloop2: do i=ips,min(ide-1,ipe)<a name='616'>
          if(ground_level(i,j)&gt;npres) then<a name='617'>
301          format('Extrap: i=',I0,' j=',I0,' NO EXTRAP: ground at ',I0)<a name='618'>
             <font color=#447700>!write(0,301) i,j,ground_level(i,j)<a name='619'></font>
             cycle iloop2<a name='620'>
          else<a name='621'>
302          format('Extrap: i=',I0,' j=',I0,' extrap from ',F0.3,' ground at ',I0)<a name='622'>
             <font color=#447700>!write(0,302) i,j,post_stdpres(ground_level(i,j)),ground_level(i,j)<a name='623'></font>
          endif<a name='624'>
          kloop2: do kd=ground_level(i,j),npres<a name='625'>
             <font color=#447700>! Extrapolate first guess below-ground values using the<a name='626'></font>
             <font color=#447700>! exact same method used in the post.  Even the constants<a name='627'></font>
             <font color=#447700>! are copied from the post:<a name='628'></font>
             PL=grid%PINT(I,J,2)<a name='629'>
             ZL=0.5*(grid%Z(I,J,2)+grid%Z(I,J,1))<a name='630'>
             TL=0.5*(grid%T(I,J,2)+grid%T(I,J,1))<a name='631'>
             QL=0.5*(grid%Q(I,J,2)+grid%Q(I,J,1))<a name='632'>
             QSAT=post_PQ0/PL*EXP(post_A2*(TL-post_A3)/(TL-post_A4))<a name='633'>
             <font color=#447700>!<a name='634'></font>
             RHL=QL/QSAT<a name='635'>
             <font color=#447700>!<a name='636'></font>
             IF(RHL.GT.1.)THEN<a name='637'>
                RHL=1.<a name='638'>
                QL =RHL*QSAT<a name='639'>
             ENDIF<a name='640'>
             <font color=#447700>!<a name='641'></font>
             IF(RHL.LT.post_RHmin)THEN<a name='642'>
                RHL=post_RHmin<a name='643'>
                QL =RHL*QSAT<a name='644'>
             ENDIF<a name='645'>
             <font color=#447700>!<a name='646'></font>
             TVRL  =TL*(1.+post_D608*QL)<a name='647'>
             TVRBLO=TVRL*(post_stdpres(kd)/PL)**post_RGAMOG<a name='648'>
             TBLO  =TVRBLO/(1.+post_D608*QL)<a name='649'>
<a name='650'>
             <font color=#447700>!QSAT=post_PQ0/post_stdpres(kd)*EXP(post_A2*(TBLO-post_A3)/(TBLO-post_A4))<a name='651'></font>
<a name='652'>
             <font color=#447700>!QBLO =RHL*QSAT<a name='653'></font>
             <font color=#447700>!presQ(i,j,kd)=AMAX1(post_smallQ,QBLO)<a name='654'></font>
<a name='655'>
             presTv(i,j,kd)=TBLO<a name='656'>
<a name='657'>
             <font color=#447700>! Extrapolated virtual temperature:<a name='658'></font>
             <font color=#447700>!presTv(i,j,kd)=TBLO*(1.+post_D608*QBLO)<a name='659'></font>
<a name='660'>
             <font color=#447700>! extrapolated temperature, with virtual part removed using extrapolated specific humidity:<a name='661'></font>
             <font color=#447700>!presTv(i,j,kd)=TVRBLO/(1.+post_D608*QBLO)<a name='662'></font>
<a name='663'>
             <font color=#447700>! Below-ground Z is recalcluated after smoothing Tv.  We<a name='664'></font>
             <font color=#447700>! only fill in badval here:<a name='665'></font>
             presZ(i,j,kd)=badheight<a name='666'>
<a name='667'>
303          format('Extrap i=',I0,' j=',I0,' kd=',I0,' presTv=',F0.3,' presZ=',F0.3)<a name='668'>
304          format('   TL=',F0.3,' QL=',F0.3,' ZL=',F0.3,' QSAT=',F0.3)<a name='669'>
305          format('   TVRL=',F0.3,' TVRBLO=',F0.3,' TBLO=',F0.3,' RHL=',F0.3)<a name='670'>
             <font color=#447700>!write(0,303) i,j,kd,presTv(i,j,kd),presZ(i,j,kd)<a name='671'></font>
             <font color=#447700>!write(0,304) TL,QL,ZL,QSAT<a name='672'></font>
             <font color=#447700>!write(0,305) TVRL,TVRBLO,TBLO,RHL<a name='673'></font>
          enddo kloop2<a name='674'>
       enddo iloop2<a name='675'>
    enddo jloop2<a name='676'>
  end subroutine calculate_3D<a name='677'>
<a name='678'>
<A NAME='CALCULATE_INTERP'><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_INTERP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='679'>
  <font color=#993300>subroutine </font><font color=#cc0000>calculate_interP</font>( &amp; <A href='../../call_to/CALCULATE_INTERP.html' TARGET='index'>1</A>,<A href='../../call_from/CALCULATE_INTERP.html' TARGET='index'>3</A><a name='680'>
       presTv,presZ,modelZ,Pmsl,PINT,T1,Q1, &amp;<a name='681'>
       ground_level,ground_mask,fis, &amp;<a name='682'>
       IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='683'>
       IMS,IME,JMS,JME,KMS,KME, &amp;<a name='684'>
       IPS,IPE,JPS,JPE,KPS,KPE)<a name='685'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>MODULE_DOMAIN</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_40">, ONLY : domain<a name='686'>
<a name='687'>
    implicit none<a name='688'>
<a name='689'>
    integer, intent(in) :: IDS,IDE,JDS,JDE,KDS,KDE<a name='690'>
    integer, intent(in) :: IMS,IME,JMS,JME,KMS,KME<a name='691'>
    integer, intent(in) :: IPS,IPE,JPS,JPE,KPS,KPE<a name='692'>
<a name='693'>
    real, intent(in) :: PINT(ims:ime,jms:jme,kms:kme), modelZ(ims:ime,jms:jme,kms:kme)<a name='694'>
    real, intent(in) :: T1(ims:ime,jms:jme,1)<a name='695'>
    real, intent(in) :: Q1(ims:ime,jms:jme,1)<a name='696'>
<a name='697'>
    real, intent(in) :: fis(ims:ime,jms:jme)<a name='698'>
    real, intent(out) :: Pmsl(ips:ipe,jps:jpe)<a name='699'>
    real, intent(inout) :: presTv(ips:ipe,jps:jpe,npres)<a name='700'>
    real, intent(inout) :: presZ(ips:ipe,jps:jpe,npres)<a name='701'>
<a name='702'>
    logical, intent(inout) :: ground_mask(ips:ipe,jps:jpe,npres)<a name='703'>
    integer, intent(inout) :: ground_level(ips:ipe,jps:jpe)<a name='704'>
<a name='705'>
    real :: Z,midTv,dZ,newZ,P,newP,TVRT,TLYR,DIS,oa,slope<a name='706'>
    integer :: kp,ip,i,j<a name='707'>
<a name='708'>
    <font color=#447700>! What this code does:<a name='709'></font>
<a name='710'>
    <font color=#447700>! For every point where the surface is above Z=0, we start from<a name='711'></font>
    <font color=#447700>! the lowest above-ground pressure and integrate the hydrostatic<a name='712'></font>
    <font color=#447700>! equation downward to find P at Z=0.<a name='713'></font>
<a name='714'>
    <font color=#447700>! For points where the surface Z&lt;=0 (surface is at or below sea<a name='715'></font>
    <font color=#447700>! level), we interpolate to get P at Z=0.<a name='716'></font>
<a name='717'>
<a name='718'>
    <font color=#447700>! STEP 1: extrapolate below-ground values<a name='719'></font>
    do j=jps,min(jde-1,jpe)<a name='720'>
       iloop: do i=ips,min(ide-1,ipe)<a name='721'>
          <font color=#447700>!          nearground: if(modelZ(i,j,1)&lt;50.0) then<a name='722'></font>
          <font color=#447700>!             Pmsl(i,j)=pint1(i,j,1)<a name='723'></font>
          <font color=#447700>!                method(i,j)=-30<a name='724'></font>
          <font color=#447700>!          else<a name='725'></font>
          if(ground_level(i,j)&lt;npres+1) then<a name='726'>
             kp=ground_level(i,j)-1<a name='727'>
101          format('i=',I0,' j=',I0,' kp=',I0,' ground level =',I0)<a name='728'>
             <font color=#447700>!write(0,101) i,j,kp,ground_level(i,j)<a name='729'></font>
             if(kp&lt;1) then<a name='730'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_86">("Lowest model surface pressure is lower than second lowest standard pressure level." )<a name='731'>
             endif<a name='732'>
             <font color=#447700>! Ground is below lowest model level<a name='733'></font>
             <font color=#447700>!newZ=presZ(i,j,kp)<a name='734'></font>
             <font color=#447700>!newP=post_stdpres(kp)<a name='735'></font>
             newZ=fis(i,j)/post_G<a name='736'>
             newP=pint(i,j,1)<a name='737'>
             do ip=kp,npres-1<a name='738'>
                P=newP<a name='739'>
                Z=newZ<a name='740'>
                <font color=#447700>!                midTv=0.5*(presTv(i,j,ip)+presTv(i,j,ip+1))<a name='741'></font>
                midTv=presTv(i,j,ip+1)<a name='742'>
                newP=post_stdpres(ip+1)<a name='743'>
                dZ=post_Rd*midTv*alog(P/newP)/post_g<a name='744'>
102             format('  make some Z at ip=',I0,': P=',F0.3,' newP=',F0.3)<a name='745'>
1021            format('  Z=',F0.3,' midTv=',F0.3,' dZ=',F0.3)<a name='746'>
                <font color=#447700>!write(0,102) ip,P,newP<a name='747'></font>
                <font color=#447700>!write(0,1021) Z,midTv,dZ<a name='748'></font>
                if(dZ&gt;=0.) then<a name='749'>
                   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#CALCULATE_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_87">("dZ&gt;=0.")<a name='750'>
                endif<a name='751'>
                newZ=Z+dZ<a name='752'>
                presZ(i,j,ip+1)=newZ<a name='753'>
                if(newZ&lt;=0) then<a name='754'>
                   <font color=#447700>! interpolate between Z and newZ<a name='755'></font>
1022               format('  extrap using ',F0.3,'/exp(-',F0.3,'*',F0.3,'/(',F0.3,'*',F0.3,'))')<a name='756'>
                   <font color=#447700>!write(0,1022) P,Z,post_G,post_RD,presTV(i,j,ip)<a name='757'></font>
<a name='758'>
<a name='759'>
                   <font color=#447700>!Pmsl(i,j)=P/exp(-Z*post_G/(post_RD*presTv(i,j,ip)))<a name='760'></font>
                   Pmsl(i,j)=(Z*newP-newZ*P)/(-dZ)<a name='761'>
10221              format('  result: ',F0.3)<a name='762'>
                   <font color=#447700>!write(0,10221) Pmsl(i,j)<a name='763'></font>
<font color=#447700>!                   method(i,j)=ip<a name='764'></font>
                   cycle iloop<a name='765'>
                endif<a name='766'>
             enddo<a name='767'>
          endif<a name='768'>
          <font color=#447700>! If we get here, then Z=0 is below the lowest standard<a name='769'></font>
          <font color=#447700>! pressure level and we must extrapolate.<a name='770'></font>
<a name='771'>
          <font color=#447700>!               if(pint1(i,j,1)&gt;post_stdpres(npres) .and. modelZ(i,j,1)&gt;0.)then<a name='772'></font>
          <font color=#447700>!                  ! Model surface pressure is a higher pressure than the<a name='773'></font>
          <font color=#447700>!                  ! highest standard pressure level.  Use the model<a name='774'></font>
          <font color=#447700>!                  ! fields to extrapolate.<a name='775'></font>
          <font color=#447700>!                  TVRT=T1(I,J,1)*(post_H1+post_D608*Q1(I,J,1))<a name='776'></font>
          <font color=#447700>!                  !DIS=modelZ(I,J,2)-modelZ(I,J,1)+0.5*modelZ(I,J,2) ???<a name='777'></font>
          <font color=#447700>!                  DIS=0.5*(modelZ(I,J,2)+modelZ(I,J,1))<a name='778'></font>
          <font color=#447700>!                  TLYR=TVRT-DIS*post_SLOPE*post_G*0.5<a name='779'></font>
          <font color=#447700>!                  Pmsl(I,J)=PINT(I,J,1)*EXP((modelZ(I,J,1))*post_G/(post_RD*TLYR))<a name='780'></font>
          <font color=#447700>! ! 1023            format('  use model: TVRT=',F0.3,' DIS=',F0.3,' TLYR=',F0.3,' Pmsl=',F0.3)<a name='781'></font>
          <font color=#447700>! ! 1024            format('     result: ',F0.3,'*EXP(',F0.3,'/(',F0.3,'*',F0.3'))')<a name='782'></font>
          <font color=#447700>! !                 write(0,1023) TVRT,DIS,TLYR,Pmsl(i,j)<a name='783'></font>
          <font color=#447700>! !                 write(0,1024) PINT(I,J,1),modelZ(I,J,2),post_RD,TLYR<a name='784'></font>
          <font color=#447700>!                method(i,j)=-20<a name='785'></font>
          <font color=#447700>!               ELSE<a name='786'></font>
          <font color=#447700>! Highest pressure level (post_stdpres(1)) has a<a name='787'></font>
          <font color=#447700>! higher pressure than the model surface pressure, so<a name='788'></font>
          <font color=#447700>! extrapolate using the pressure level values.<a name='789'></font>
1025      format('  use npres: TLYR=',F0.3,' Pmsl=',F0.3)<a name='790'>
1026      format('     result: ',F0.3,'/EXP(-',F0.3,'*',F0.3,'/(',F0.3,'*',F0.3,'))')<a name='791'>
          TLYR=presTv(I,J,npres)-presZ(I,J,npres)*post_SLOPE*post_G*0.5<a name='792'>
          Pmsl(I,J)=post_stdpres(npres)/EXP(-presZ(I,J,npres)*post_G/(post_RD*TLYR))<a name='793'>
          <font color=#447700>!oa=0.5*post_SLOPE*post_g*presZ(i,j,npres)/TLYR<a name='794'></font>
          <font color=#447700>!Pmsl(i,j)=post_stdpres(npres)*(1.-oa)**old_coef2<a name='795'></font>
          <font color=#447700>!write(0,1025) TLYR,Pmsl(I,J)<a name='796'></font>
          <font color=#447700>!write(0,1026) post_stdpres(npres),presZ(I,J,npres),post_G,post_RD,TLYR<a name='797'></font>
<font color=#447700>!          method(i,j)=-10<a name='798'></font>
          <font color=#447700>!             END IF<a name='799'></font>
          <font color=#447700>!          endif nearground<a name='800'></font>
       enddo iloop<a name='801'>
    enddo<a name='802'>
  end subroutine calculate_interP<a name='803'>
<a name='804'>
<A NAME='SMOOTHMSLP'><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#SMOOTHMSLP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='805'>
  <font color=#993300>subroutine </font><font color=#cc0000>smoothMSLP</font>(grid,iterations,  &amp; <A href='../../call_to/SMOOTHMSLP.html' TARGET='index'>1</A>,<A href='../../call_from/SMOOTHMSLP.html' TARGET='index'>3</A><a name='806'>
       IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='807'>
       IMS,IME,JMS,JME,KMS,KME, &amp;<a name='808'>
       IPS,IPE,JPS,JPE,KPS,KPE)<a name='809'>
    use <A href='../../html_code/dyn_nmm/module_relax.F.html#MODULE_RELAX'>module_relax</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#SMOOTHMSLP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RELAX_2"><a name='810'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>MODULE_DOMAIN</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#SMOOTHMSLP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_41">, ONLY : domain<a name='811'>
    implicit none<a name='812'>
    type(domain), intent(inout) :: grid<a name='813'>
    integer, intent(in) :: iterations<a name='814'>
<a name='815'>
    integer :: IDS,IDE,JDS,JDE,KDS,KDE<a name='816'>
    integer :: IMS,IME,JMS,JME,KMS,KME<a name='817'>
    integer :: IPS,IPE,JPS,JPE,KPS,KPE<a name='818'>
    integer :: i,j<a name='819'>
<a name='820'>
    do j=jps,min(jde-1,jpe)<a name='821'>
       do i=ips,min(ide-1,ipe)<a name='822'>
          grid%relaxmask(i,j)=.true.<a name='823'>
          grid%relaxwork(i,j)=grid%membrane_mslp(i,j)<a name='824'>
       enddo<a name='825'>
    enddo<a name='826'>
<a name='827'>
    call <A href='../../html_code/dyn_nmm/module_relax.F.html#RELAX4E'>relax4e</A><A href='../../html_code/dyn_nmm/module_membrane_mslp.F.html#SMOOTHMSLP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX4E_2">(grid,0.5,iterations,0, &amp;<a name='828'>
         IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='829'>
         IMS,IME,JMS,JME,KMS,KME, &amp;<a name='830'>
         IPS,IPE,JPS,JPE,KPS,KPE)<a name='831'>
<a name='832'>
    do j=jps,min(jde-1,jpe)<a name='833'>
       do i=ips,min(ide-1,ipe)<a name='834'>
          grid%membrane_mslp(i,j)=grid%relaxwork(i,j)<a name='835'>
       enddo<a name='836'>
    enddo<a name='837'>
<a name='838'>
  end subroutine smoothMSLP<a name='839'>
<a name='840'>
#endif<a name='841'>
end module module_membrane_mslp<a name='842'>
</pre></body></html>