<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>! sed -e "s/grid%mu/gridmu/g" -e "s/grid%Mu/gridMu/g" dfi.F | cpp -DHYBRID_COORD | sed -e "s/gridmu/grid%mu/g" -e "s/gridMu/grid%Mu/g" &gt;&gt; dfi.next<a name='2'></font>
#if ( HYBRID_COORD==1 )<a name='3'>
#  define gridmu_2(...) (grid%c1h(k)*XXPC2HXX(__VA_ARGS__))<a name='4'>
#  define XXPC2HXX(...) grid%mu_2(__VA_ARGS__)<a name='5'>
<a name='6'>
#  define gridmub(...) (grid%c1h(k)*XXPCBHXX(__VA_ARGS__)+grid%c2h(k))<a name='7'>
#  define XXPCBHXX(...) grid%mub(__VA_ARGS__)<a name='8'>
<a name='9'>
#  define gridMu_2(...) (grid%c1f(k)*XXPC2FXX(__VA_ARGS__))<a name='10'>
#  define XXPC2FXX(...) grid%Mu_2(__VA_ARGS__)<a name='11'>
<a name='12'>
#  define gridMub(...) (grid%c1f(k)*XXPCBFXX(__VA_ARGS__)+grid%c2f(k))<a name='13'>
#  define XXPCBFXX(...) grid%Mub(__VA_ARGS__)<a name='14'>
#endif<a name='15'>
<a name='16'>
<A NAME='DFI_ACCUMULATE'><A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='17'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_accumulate</font>( grid ) <A href='../../call_to/DFI_ACCUMULATE.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_ACCUMULATE.html' TARGET='index'>6</A><a name='18'>
<a name='19'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_249">, ONLY : domain<a name='20'>
<font color=#447700>!      USE module_configure<a name='21'></font>
      USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_56"><a name='22'>
      USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_22"><a name='23'>
<font color=#447700>!      USE module_dm<a name='24'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_105"><a name='25'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_165"><a name='26'>
<a name='27'>
      IMPLICIT NONE<a name='28'>
<a name='29'>
      REAL hn<a name='30'>
      CHARACTER*80 mess<a name='31'>
<a name='32'>
      <font color=#447700>!  Input data.<a name='33'></font>
<a name='34'>
      TYPE(domain) , POINTER          :: grid<a name='35'>
<a name='36'>
      IF ( grid%dfi_opt .EQ. DFI_NODFI .OR. grid%dfi_stage .EQ. DFI_FST ) RETURN<a name='37'>
<a name='38'>
#if (EM_CORE == 1)<a name='39'>
<a name='40'>
<a name='41'>
      hn = grid%hcoeff(grid%itimestep+1)<a name='42'>
<a name='43'>
      <font color=#447700>! accumulate dynamic variables<a name='44'></font>
       grid%dfi_mu(:,:)    = grid%dfi_mu(:,:)    + grid%MU_2(:,:)    * hn<a name='45'>
       grid%dfi_u(:,:,:)   = grid%dfi_u(:,:,:)   + grid%u_2(:,:,:)   * hn<a name='46'>
       grid%dfi_v(:,:,:)   = grid%dfi_v(:,:,:)   + grid%v_2(:,:,:)   * hn<a name='47'>
       grid%dfi_w(:,:,:)   = grid%dfi_w(:,:,:)   + grid%w_2(:,:,:)   * hn<a name='48'>
       grid%dfi_ww(:,:,:)  = grid%dfi_ww(:,:,:)  + grid%ww(:,:,:)    * hn<a name='49'>
       grid%dfi_t(:,:,:)   = grid%dfi_t(:,:,:)   + grid%t_2(:,:,:)   * hn<a name='50'>
       grid%dfi_phb(:,:,:) = grid%dfi_phb(:,:,:) + grid%phb(:,:,:)   * hn<a name='51'>
       grid%dfi_ph0(:,:,:) = grid%dfi_ph0(:,:,:) + grid%ph0(:,:,:)   * hn<a name='52'>
       grid%dfi_php(:,:,:) = grid%dfi_php(:,:,:) + grid%php(:,:,:)   * hn<a name='53'>
       grid%dfi_p(:,:,:)   = grid%dfi_p(:,:,:)   + grid%p(:,:,:)     * hn<a name='54'>
       grid%dfi_ph(:,:,:)  = grid%dfi_ph(:,:,:)  + grid%ph_2(:,:,:)  * hn<a name='55'>
       grid%dfi_tke(:,:,:) = grid%dfi_tke(:,:,:) + grid%tke_2(:,:,:) * hn<a name='56'>
       grid%dfi_al(:,:,:)  = grid%dfi_al(:,:,:)  + grid%al(:,:,:)    * hn<a name='57'>
       grid%dfi_alt(:,:,:) = grid%dfi_alt(:,:,:) + grid%alt(:,:,:)   * hn<a name='58'>
       grid%dfi_pb(:,:,:)  = grid%dfi_pb(:,:,:)  + grid%pb(:,:,:)    * hn<a name='59'>
      <font color=#447700>! dfi_savehydmeteors is a namelist parameter, default =0  which means hydrometeor<a name='60'></font>
      <font color=#447700>! and scalar fields will be spinning up in DFI; if dfi_savehydmeteors=1 then <a name='61'></font>
      <font color=#447700>! hydrometeor fields will stay unchanged in DFI, but water vapor mixing ratio <a name='62'></font>
      <font color=#447700>! QV will be modified.<a name='63'></font>
     IF ( grid%dfi_savehydmeteors .EQ. 0 ) then  <a name='64'>
       grid%dfi_moist(:,:,:,:)  = grid%dfi_moist(:,:,:,:)  + grid%moist(:,:,:,:)  * hn<a name='65'>
       grid%dfi_scalar(:,:,:,:) = grid%dfi_scalar(:,:,:,:) + grid%scalar(:,:,:,:) * hn<a name='66'>
       grid%dfi_re_cloud(:,:,:) = grid%dfi_re_cloud(:,:,:) + grid%re_cloud(:,:,:) * hn<a name='67'>
       grid%dfi_re_ice(:,:,:)   = grid%dfi_re_ice(:,:,:)   + grid%re_ice(:,:,:)   * hn<a name='68'>
       grid%dfi_re_snow(:,:,:)  = grid%dfi_re_snow(:,:,:)  + grid%re_snow(:,:,:)  * hn<a name='69'>
     ELSE<a name='70'>
       grid%dfi_moist(:,:,:,P_QV) = grid%dfi_moist(:,:,:,P_QV) + grid%moist(:,:,:,P_QV) * hn<a name='71'>
     ENDIF<a name='72'>
<font color=#447700>!      IF ( grid%sf_surface_physics .EQ. RUCLSMSCHEME ) then<a name='73'></font>
<font color=#447700>!       grid%dfi_QVG(:,:)   = grid%dfi_QVG(:,:)    + grid%QVG(:,:)    * hn<a name='74'></font>
<font color=#447700>!      ENDIF<a name='75'></font>
<a name='76'>
      <font color=#447700>! accumulate DFI coefficient<a name='77'></font>
      grid%hcoeff_tot = grid%hcoeff_tot + hn<a name='78'>
#endif<a name='79'>
<a name='80'>
#if (NMM_CORE == 1)<a name='81'>
      hn = grid%hcoeff(grid%ntsd+1)<a name='82'>
      grid%dfi_pd(:,:)    = grid%dfi_pd(:,:)    + grid%pd(:,:)    * hn<a name='83'>
      grid%dfi_pint(:,:,:)   = grid%dfi_pint(:,:,:)   + grid%pint(:,:,:)   * hn<a name='84'>
      grid%dfi_dwdt(:,:,:)   = grid%dfi_dwdt(:,:,:)   + grid%dwdt(:,:,:)   * hn<a name='85'>
      grid%dfi_t(:,:,:)   = grid%dfi_t(:,:,:)   + grid%t(:,:,:)   * hn<a name='86'>
      grid%dfi_q(:,:,:)   = grid%dfi_q(:,:,:)   + grid%q(:,:,:)   * hn<a name='87'>
      grid%dfi_q2(:,:,:)  = grid%dfi_q2(:,:,:)  + grid%q2(:,:,:)  * hn<a name='88'>
      grid%dfi_cwm(:,:,:) = grid%dfi_cwm(:,:,:) + grid%cwm(:,:,:) * hn<a name='89'>
      grid%dfi_u(:,:,:)   = grid%dfi_u(:,:,:)   + grid%u(:,:,:)   * hn<a name='90'>
      grid%dfi_v(:,:,:)   = grid%dfi_v(:,:,:)   + grid%v(:,:,:)   * hn<a name='91'>
      grid%dfi_moist(:,:,:,:)  = grid%dfi_moist(:,:,:,:)  + grid%moist(:,:,:,:)  * hn<a name='92'>
      grid%dfi_scalar(:,:,:,:) = grid%dfi_scalar(:,:,:,:) + grid%scalar(:,:,:,:) * hn<a name='93'>
      <font color=#447700>! accumulate DFI coefficient<a name='94'></font>
      grid%hcoeff_tot = grid%hcoeff_tot + hn<a name='95'>
      write(mess,*) 'grid%hcoeff_tot: ', grid%hcoeff_tot<a name='96'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1077">(mess)<a name='97'>
#endif<a name='98'>
<a name='99'>
   END SUBROUTINE dfi_accumulate<a name='100'>
<a name='101'>
<A NAME='DFI_BCK_INIT'><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='102'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_bck_init</font> ( grid ) <A href='../../call_to/DFI_BCK_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/DFI_BCK_INIT.html' TARGET='index'>16</A><a name='103'>
<a name='104'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_250">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time<a name='105'>
      USE module_utility<a name='106'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_166"><a name='107'>
<a name='108'>
      IMPLICIT NONE<a name='109'>
<a name='110'>
      TYPE (domain) , POINTER                 :: grid<a name='111'>
      INTEGER rc<a name='112'>
      CHARACTER*80 mess<a name='113'>
<a name='114'>
      INTERFACE<a name='115'>
         SUBROUTINE Setup_Timekeeping(grid)<a name='116'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_251">, ONLY : domain<a name='117'>
            TYPE (domain), POINTER :: grid<a name='118'>
         END SUBROUTINE Setup_Timekeeping<a name='119'>
<a name='120'>
         SUBROUTINE dfi_save_arrays(grid)<a name='121'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_252">, ONLY : domain<a name='122'>
            TYPE (domain), POINTER :: grid<a name='123'>
         END SUBROUTINE dfi_save_arrays<a name='124'>
<a name='125'>
         SUBROUTINE dfi_clear_accumulation(grid)<a name='126'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_253">, ONLY : domain<a name='127'>
            TYPE (domain), POINTER :: grid<a name='128'>
         END SUBROUTINE dfi_clear_accumulation<a name='129'>
<a name='130'>
         SUBROUTINE optfil_driver(grid)<a name='131'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_254">, ONLY : domain<a name='132'>
            TYPE (domain), POINTER :: grid<a name='133'>
         END SUBROUTINE optfil_driver<a name='134'>
<a name='135'>
         SUBROUTINE start_domain(grid, allowed_to_read)<a name='136'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_255">, ONLY : domain<a name='137'>
            TYPE (domain)          :: grid<a name='138'>
            LOGICAL, INTENT(IN)    :: allowed_to_read<a name='139'>
         END SUBROUTINE start_domain<a name='140'>
<a name='141'>
#if (EM_CORE == 1)<a name='142'>
         SUBROUTINE rebalance_driver_dfi (grid)<a name='143'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_256">, ONLY : domain<a name='144'>
            TYPE (domain)          :: grid<a name='145'>
         END SUBROUTINE rebalance_driver_dfi<a name='146'>
#endif<a name='147'>
<a name='148'>
      END INTERFACE<a name='149'>
<a name='150'>
      grid%dfi_stage = DFI_BCK<a name='151'>
<a name='152'>
#if (EM_CORE == 1)<a name='153'>
      if(grid%cycling) then<a name='154'>
<font color=#447700>!         print *,'   Rebalancing is on '<a name='155'></font>
         CALL <A href='../../html_code/share/dfi.F.html#REBALANCE_DRIVER_DFI'>rebalance_driver_dfi</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REBALANCE_DRIVER_DFI_1"> ( grid )<a name='156'>
      endif<a name='157'>
#endif<a name='158'>
<a name='159'>
      <font color=#447700>! Negate time step<a name='160'></font>
      IF ( grid%time_step_dfi .gt. 0 ) THEN<a name='161'>
        CALL nl_set_time_step ( 1, -grid%time_step_dfi )<a name='162'>
      ELSE<a name='163'>
        CALL nl_set_time_step ( 1, -grid%time_step )<a name='164'>
        CALL nl_set_time_step_fract_num ( 1, -grid%time_step_fract_num )<a name='165'>
      ENDIF<a name='166'>
<a name='167'>
      CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_13"> (grid)<a name='168'>
<a name='169'>
      <font color=#447700>!tgs 7apr11 - need to call start_domain here to reset bc initialization for negative dt<a name='170'></font>
      CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_3"> ( grid , .TRUE. )<a name='171'>
      <font color=#447700>!tgs 7apr11 - save arrays should be done after start_domain to get correct grid%p field<a name='172'></font>
      <font color=#447700>!             used in computation of initial RH.<a name='173'></font>
      CALL <A href='../../html_code/share/dfi.F.html#DFI_SAVE_ARRAYS'>dfi_save_arrays</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_SAVE_ARRAYS_1"> ( grid )<a name='174'>
<a name='175'>
      <font color=#447700>! set physics options to zero<a name='176'></font>
      CALL nl_set_mp_physics( grid%id, 0 )<a name='177'>
      CALL nl_set_ra_lw_physics( grid%id, 0 )<a name='178'>
      CALL nl_set_ra_sw_physics( grid%id, 0 )<a name='179'>
      CALL nl_set_sf_surface_physics( grid%id, 0 )<a name='180'>
      CALL nl_set_sf_sfclay_physics( grid%id, 0 )<a name='181'>
      CALL nl_set_sf_urban_physics( grid%id, 0 )<a name='182'>
      CALL nl_set_bl_pbl_physics( grid%id, 0 )<a name='183'>
      CALL nl_set_cu_physics( grid%id, 0 )<a name='184'>
      CALL nl_set_cu_diag( grid%id, 0 )<a name='185'>
      CALL nl_set_damp_opt( grid%id, 0 )<a name='186'>
      CALL nl_set_sst_update( grid%id, 0 )<a name='187'>
      CALL nl_set_fractional_seaice( grid%id, 0 )<a name='188'>
      CALL nl_set_gwd_opt( grid%id, 0 )<a name='189'>
      CALL nl_set_feedback( grid%id, 0 )<a name='190'>
      <font color=#447700>! set bc<a name='191'></font>
#if (EM_CORE == 1)<a name='192'>
      CALL nl_set_diff_6th_opt( grid%id, 0 )<a name='193'>
      CALL nl_set_constant_bc(1, grid%constant_bc)<a name='194'>
      CALL nl_set_use_adaptive_time_step( grid%id, .false. )<a name='195'>
#endif<a name='196'>
<a name='197'>
#if ( WRF_CHEM == 1 )<a name='198'>
      <font color=#447700>! set chemistry option to zero<a name='199'></font>
      CALL nl_set_chem_opt (grid%id, 0)<a name='200'>
      CALL nl_set_aer_ra_feedback (grid%id, 0)<a name='201'>
      CALL nl_set_io_form_auxinput5 (grid%id, 0)<a name='202'>
      CALL nl_set_io_form_auxinput6 (grid%id, 0)<a name='203'>
      CALL nl_set_io_form_auxinput7 (grid%id, 0)<a name='204'>
      CALL nl_set_io_form_auxinput8 (grid%id, 0)<a name='205'>
      CALL nl_set_io_form_auxinput13 (grid%id, 0)<a name='206'>
      CALL nl_set_io_form_auxinput14 (grid%id, 0)<a name='207'>
      CALL nl_set_io_form_auxinput15 (grid%id, 0)<a name='208'>
#endif<a name='209'>
<a name='210'>
      <font color=#447700>! set diffusion to zero for backward integration<a name='211'></font>
<a name='212'>
#if (EM_CORE == 1)<a name='213'>
      grid%km_opt_dfi = grid%km_opt<a name='214'>
      grid%diff_opt_dfi = grid%diff_opt<a name='215'>
      CALL nl_set_km_opt( grid%id, 1) <a name='216'>
      CALL nl_set_diff_opt( grid%id, 0) <a name='217'>
      CALL nl_set_moist_adv_dfi_opt( grid%id, grid%moist_adv_dfi_opt)<a name='218'>
      CALL nl_set_moist_adv_opt( grid%id,grid%moist_adv_dfi_opt)<a name='219'>
#endif<a name='220'>
<a name='221'>
      <font color=#447700>! If a request to do pressure level diags, then shut it off<a name='222'></font>
      <font color=#447700>! until we get to the real forecast part of this integration.<a name='223'></font>
<a name='224'>
#if (EM_CORE == 1)<a name='225'>
      CALL nl_set_p_lev_diags( grid%id, grid%p_lev_diags_dfi)<a name='226'>
#endif<a name='227'>
<a name='228'>
#if (NMM_CORE == 1)<a name='229'>
<a name='230'>
<font color=#447700>!<a name='231'></font>
<font color=#447700>! CHANGE (SIGN ONLY OF) IMPORTANT TIME CONSTANTS<a name='232'></font>
<font color=#447700>!<a name='233'></font>
      CALL nl_get_time_step( grid%id, grid%time_step )<a name='234'>
      if (grid%time_step .lt. 0) then<a name='235'>
<font color=#447700>!       DT   =-DT<a name='236'></font>
<a name='237'>
        write(mess,*) 'changing signs for backward integration'<a name='238'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1078">(mess)<a name='239'>
        grid%CPGFV = -grid%CPGFV<a name='240'>
        grid%EN    = -grid%EN<a name='241'>
        grid%ENT   = -grid%ENT<a name='242'>
        grid%F4D   = -grid%F4D<a name='243'>
        grid%F4Q   = -grid%F4Q<a name='244'>
        grid%EF4T  = -grid%EF4T<a name='245'>
  <a name='246'>
        grid%EM(:) = -grid%EM(:)<a name='247'>
        grid%EMT(:) = -grid%EMT(:)<a name='248'>
        grid%F4Q2(:) = -grid%F4Q2(:)<a name='249'>
  <a name='250'>
        grid%WPDAR(:,:)= -grid%WPDAR(:,:)<a name='251'>
        grid%CPGFU(:,:)= -grid%CPGFU(:,:)<a name='252'>
        grid%CURV(:,:)= -grid%CURV(:,:)<a name='253'>
        grid%FCP(:,:)= -grid%FCP(:,:)<a name='254'>
        grid%FAD(:,:)= -grid%FAD(:,:)<a name='255'>
        grid%F(:,:)= -grid%F(:,:)<a name='256'>
      endif<a name='257'>
#endif<a name='258'>
<a name='259'>
      grid%start_subtime = domain_get_start_time ( grid )<a name='260'>
      grid%stop_subtime = domain_get_stop_time ( grid )<a name='261'>
<a name='262'>
      CALL WRFU_ClockSet(grid%domain_clock, currTime=grid%start_subtime, rc=rc)<a name='263'>
<a name='264'>
<font color=#447700>!tgs 7apr11 - this call has been moved up<a name='265'></font>
<font color=#447700>!     CALL dfi_save_arrays ( grid )<a name='266'></font>
      CALL <A href='../../html_code/share/dfi.F.html#DFI_CLEAR_ACCUMULATION'>dfi_clear_accumulation</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_CLEAR_ACCUMULATION_1">( grid )<a name='267'>
      CALL <A href='../../html_code/share/dfi.F.html#OPTFIL_DRIVER'>optfil_driver</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPTFIL_DRIVER_1">(grid)<a name='268'>
<a name='269'>
      <font color=#447700>!tgs need to call start_domain here to reset bc initialization for negative dt<a name='270'></font>
      CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_4"> ( grid , .TRUE. )<a name='271'>
<a name='272'>
   END SUBROUTINE dfi_bck_init<a name='273'>
<a name='274'>
<a name='275'>
<A NAME='DFI_FWD_INIT'><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='276'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_fwd_init</font> ( grid ) <A href='../../call_to/DFI_FWD_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/DFI_FWD_INIT.html' TARGET='index'>14</A><a name='277'>
<a name='278'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_257">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time<a name='279'>
      USE module_utility, ONLY : WRFU_ClockSet<a name='280'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_167"><a name='281'>
<a name='282'>
      IMPLICIT NONE<a name='283'>
<a name='284'>
      TYPE (domain) , POINTER                 :: grid<a name='285'>
      INTEGER rc<a name='286'>
      CHARACTER*80 mess<a name='287'>
      INTEGER n_moist,nm,n_scalar,ns<a name='288'>
<a name='289'>
      INTERFACE<a name='290'>
         SUBROUTINE Setup_Timekeeping(grid)<a name='291'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_258">, ONLY : domain<a name='292'>
            TYPE (domain), POINTER :: grid<a name='293'>
         END SUBROUTINE Setup_Timekeeping<a name='294'>
<a name='295'>
         SUBROUTINE dfi_save_arrays(grid)<a name='296'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_259">, ONLY : domain<a name='297'>
            TYPE (domain), POINTER :: grid<a name='298'>
         END SUBROUTINE dfi_save_arrays<a name='299'>
<a name='300'>
         SUBROUTINE dfi_clear_accumulation(grid)<a name='301'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_260">, ONLY : domain<a name='302'>
            TYPE (domain), POINTER :: grid<a name='303'>
         END SUBROUTINE dfi_clear_accumulation<a name='304'>
<a name='305'>
         SUBROUTINE optfil_driver(grid)<a name='306'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_261">, ONLY : domain<a name='307'>
            TYPE (domain), POINTER :: grid<a name='308'>
         END SUBROUTINE optfil_driver<a name='309'>
<a name='310'>
#if (EM_CORE == 1)<a name='311'>
         SUBROUTINE rebalance_driver_dfi (grid)<a name='312'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_262">, ONLY : domain<a name='313'>
            TYPE (domain)          :: grid<a name='314'>
         END SUBROUTINE rebalance_driver_dfi<a name='315'>
#endif<a name='316'>
<a name='317'>
         SUBROUTINE start_domain(grid, allowed_to_read)<a name='318'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_263">, ONLY : domain<a name='319'>
            TYPE (domain)          :: grid<a name='320'>
            LOGICAL, INTENT(IN)    :: allowed_to_read<a name='321'>
         END SUBROUTINE start_domain<a name='322'>
      END INTERFACE<a name='323'>
<a name='324'>
      grid%dfi_stage = DFI_FWD<a name='325'>
<a name='326'>
      <font color=#447700>! for Setup_Timekeeping to use when setting the clock<a name='327'></font>
<a name='328'>
      IF ( grid%time_step_dfi .gt. 0 ) THEN<a name='329'>
        CALL nl_set_time_step ( grid%id, grid%time_step_dfi )<a name='330'>
      ELSE<a name='331'>
<a name='332'>
      CALL nl_get_time_step( grid%id, grid%time_step )<a name='333'>
        CALL nl_get_time_step_fract_num( grid%id, grid%time_step_fract_num )<a name='334'>
<a name='335'>
      grid%time_step = abs(grid%time_step)<a name='336'>
      CALL nl_set_time_step( grid%id, grid%time_step )<a name='337'>
<a name='338'>
        grid%time_step_fract_num = abs(grid%time_step_fract_num)<a name='339'>
        CALL nl_set_time_step_fract_num( grid%id, grid%time_step_fract_num )<a name='340'>
<a name='341'>
      ENDIF<a name='342'>
<a name='343'>
      grid%itimestep=0<a name='344'>
      grid%xtime=0.<a name='345'>
<a name='346'>
      <font color=#447700>! reset physics options to normal<a name='347'></font>
      CALL nl_set_mp_physics( grid%id, grid%mp_physics)<a name='348'>
      CALL nl_set_ra_lw_physics( grid%id, grid%ra_lw_physics)<a name='349'>
      CALL nl_set_ra_sw_physics( grid%id, grid%ra_sw_physics)<a name='350'>
      CALL nl_set_sf_surface_physics( grid%id, grid%sf_surface_physics)<a name='351'>
      CALL nl_set_sf_sfclay_physics( grid%id, grid%sf_sfclay_physics)<a name='352'>
      CALL nl_set_sf_urban_physics( grid%id, grid%sf_urban_physics)<a name='353'>
      CALL nl_set_bl_pbl_physics( grid%id, grid%bl_pbl_physics)<a name='354'>
      CALL nl_set_cu_physics( grid%id, grid%cu_physics)<a name='355'>
      CALL nl_set_cu_diag( grid%id, grid%cu_diag )<a name='356'>
      CALL nl_set_damp_opt( grid%id, grid%damp_opt)<a name='357'>
      CALL nl_set_sst_update( grid%id, 0)<a name='358'>
      CALL nl_set_fractional_seaice( grid%id, grid%fractional_seaice)<a name='359'>
      CALL nl_set_gwd_opt( grid%id, grid%gwd_opt)<a name='360'>
      CALL nl_set_feedback( grid%id, 0 )<a name='361'>
#if (EM_CORE == 1) <a name='362'>
      CALL nl_set_diff_6th_opt( grid%id, grid%diff_6th_opt)<a name='363'>
      CALL nl_set_use_adaptive_time_step( grid%id, .false. )<a name='364'>
      <font color=#447700>! set bc<a name='365'></font>
      CALL nl_set_constant_bc(grid%id, grid%constant_bc)<a name='366'>
#endif<a name='367'>
<a name='368'>
#if (NMM_CORE == 1)<a name='369'>
<font color=#447700>!<a name='370'></font>
<font color=#447700>! CHANGE (SIGN ONLY OF) IMPORTANT TIME CONSTANTS<a name='371'></font>
<font color=#447700>!<a name='372'></font>
<font color=#447700>!mptest      CALL nl_get_time_step( grid%id, grid%time_step )<a name='373'></font>
<a name='374'>
<a name='375'>
<font color=#447700>!!! here need to key off something else being the "wrong" sign<a name='376'></font>
      if (grid%cpgfv .gt. 0) then<a name='377'>
<a name='378'>
        write(mess,*) 'changing signs for forward integration'<a name='379'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1079">(mess)<a name='380'>
        grid%CPGFV = -grid%CPGFV<a name='381'>
        grid%EN    = -grid%EN<a name='382'>
        grid%ENT   = -grid%ENT<a name='383'>
        grid%F4D   = -grid%F4D<a name='384'>
        grid%F4Q   = -grid%F4Q<a name='385'>
        grid%EF4T  = -grid%EF4T<a name='386'>
  <a name='387'>
        grid%EM(:) = -grid%EM(:)<a name='388'>
        grid%EMT(:) = -grid%EMT(:)<a name='389'>
        grid%F4Q2(:) = -grid%F4Q2(:)<a name='390'>
  <a name='391'>
        grid%WPDAR(:,:)= -grid%WPDAR(:,:)<a name='392'>
        grid%CPGFU(:,:)= -grid%CPGFU(:,:)<a name='393'>
        grid%CURV(:,:)= -grid%CURV(:,:)<a name='394'>
        grid%FCP(:,:)= -grid%FCP(:,:)<a name='395'>
        grid%FAD(:,:)= -grid%FAD(:,:)<a name='396'>
        grid%F(:,:)= -grid%F(:,:)<a name='397'>
      endif<a name='398'>
#endif<a name='399'>
<a name='400'>
<a name='401'>
<font color=#447700>!#if ( WRF_CHEM == 1 )<a name='402'></font>
<font color=#447700>!      ! reset chem option to normal<a name='403'></font>
<font color=#447700>!      CALL nl_set_chem_opt( grid%id, grid%chem_opt)<a name='404'></font>
<font color=#447700>!      CALL nl_set_aer_ra_feedback (grid%id, grid%aer_ra_feedback)<a name='405'></font>
<font color=#447700>!#endif<a name='406'></font>
<a name='407'>
#if (EM_CORE == 1)<a name='408'>
      <font color=#447700>! reset km_opt to normal<a name='409'></font>
      grid%km_opt = grid%km_opt_dfi<a name='410'>
      grid%diff_opt = grid%diff_opt_dfi<a name='411'>
      CALL nl_set_km_opt( grid%id, grid%km_opt_dfi)<a name='412'>
      CALL nl_set_diff_opt( grid%id, grid%diff_opt_dfi)<a name='413'>
      CALL nl_set_moist_adv_opt( grid%id, grid%moist_adv_opt)<a name='414'>
#endif<a name='415'>
<a name='416'>
<a name='417'>
      CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_14"> (grid)<a name='418'>
      grid%start_subtime = domain_get_start_time ( head_grid )<a name='419'>
      grid%stop_subtime = domain_get_stop_time ( head_grid )<a name='420'>
<a name='421'>
      CALL WRFU_ClockSet(grid%domain_clock, currTime=grid%start_subtime, rc=rc)<a name='422'>
<a name='423'>
      IF ( grid%dfi_opt .EQ. DFI_DFL ) THEN<a name='424'>
         CALL <A href='../../html_code/share/dfi.F.html#DFI_SAVE_ARRAYS'>dfi_save_arrays</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_SAVE_ARRAYS_2"> ( grid )<a name='425'>
      END IF<a name='426'>
      CALL <A href='../../html_code/share/dfi.F.html#DFI_CLEAR_ACCUMULATION'>dfi_clear_accumulation</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_CLEAR_ACCUMULATION_2">( grid )<a name='427'>
      CALL <A href='../../html_code/share/dfi.F.html#OPTFIL_DRIVER'>optfil_driver</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPTFIL_DRIVER_2">(grid)<a name='428'>
<a name='429'>
      <font color=#447700>!tgs need to call it here to reset bc initialization for positive time_step<a name='430'></font>
      CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_5"> ( grid , .TRUE. )<a name='431'>
<a name='432'>
      <font color=#447700>!tgs  After start_domain moist and scalar arrays are fully dimentioned,<a name='433'></font>
      <font color=#447700>!and initial values should be restored here if grid%dfi_savehydmeteors .EQ. 1:<a name='434'></font>
    IF ( grid%dfi_savehydmeteors .EQ. 1 ) then<a name='435'>
<font color=#447700>!       print *,'FWD n_moist,PARAM_FIRST_SCALAR,P_QV,P_QC,P_QR,P_QI,P_QS,P_QG', &amp;<a name='436'></font>
<font color=#447700>!                n_moist,PARAM_FIRST_SCALAR,P_QV,P_QC,P_QR,P_QI,P_QS,P_QG<a name='437'></font>
<font color=#447700>!       print *,'FWD num_scalar,P_QNC,P_QNI,P_QNR,P_QNWFA,P_QNIFA',P_QNC,P_QNI,P_QNR,P_QNWFA,P_QNIFA<a name='438'></font>
        n_moist = num_moist<a name='439'>
         DO nm=PARAM_FIRST_SCALAR+1,n_moist<a name='440'>
             grid%moist(:,:,:,nm)=grid%dfi_moist(:,:,:,nm)<a name='441'>
         ENDDO<a name='442'>
        grid%scalar(:,:,:,:) = grid%dfi_scalar(:,:,:,:)<a name='443'>
    ENDIF<a name='444'>
<a name='445'>
   END SUBROUTINE dfi_fwd_init<a name='446'>
<a name='447'>
<A NAME='DFI_FST_INIT'><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='448'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_fst_init</font> ( grid ) <A href='../../call_to/DFI_FST_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/DFI_FST_INIT.html' TARGET='index'>10</A><a name='449'>
<a name='450'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_264">, ONLY : domain, domain_get_stop_time, domain_get_start_time<a name='451'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_168"><a name='452'>
<a name='453'>
      IMPLICIT NONE<a name='454'>
<a name='455'>
      TYPE (domain) , POINTER :: grid<a name='456'>
      CHARACTER (LEN=80)      :: wrf_error_message<a name='457'>
      INTEGER n_moist,nm<a name='458'>
<a name='459'>
      INTERFACE<a name='460'>
         SUBROUTINE Setup_Timekeeping(grid)<a name='461'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_265">, ONLY : domain<a name='462'>
            TYPE (domain), POINTER :: grid<a name='463'>
         END SUBROUTINE Setup_Timekeeping<a name='464'>
<a name='465'>
         SUBROUTINE dfi_save_arrays(grid)<a name='466'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_266">, ONLY : domain<a name='467'>
            TYPE (domain), POINTER :: grid<a name='468'>
         END SUBROUTINE dfi_save_arrays<a name='469'>
<a name='470'>
         SUBROUTINE dfi_clear_accumulation(grid)<a name='471'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_267">, ONLY : domain<a name='472'>
            TYPE (domain), POINTER :: grid<a name='473'>
         END SUBROUTINE dfi_clear_accumulation<a name='474'>
<a name='475'>
         SUBROUTINE optfil_driver(grid)<a name='476'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_268">, ONLY : domain<a name='477'>
            TYPE (domain), POINTER :: grid<a name='478'>
         END SUBROUTINE optfil_driver<a name='479'>
<a name='480'>
#if (EM_CORE == 1)<a name='481'>
         SUBROUTINE rebalance_driver_dfi (grid)<a name='482'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_269">, ONLY : domain<a name='483'>
            TYPE (domain)          :: grid<a name='484'>
         END SUBROUTINE rebalance_driver_dfi<a name='485'>
#endif<a name='486'>
<a name='487'>
         SUBROUTINE start_domain(grid, allowed_to_read)<a name='488'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_270">, ONLY : domain<a name='489'>
            TYPE (domain)          :: grid<a name='490'>
            LOGICAL, INTENT(IN)    :: allowed_to_read<a name='491'>
         END SUBROUTINE start_domain<a name='492'>
      END INTERFACE<a name='493'>
<a name='494'>
      grid%dfi_stage = DFI_FST <a name='495'>
<a name='496'>
     <font color=#447700>! reset time_step to normal and adaptive_time_step<a name='497'></font>
      CALL nl_set_time_step( grid%id, grid%time_step )<a name='498'>
<a name='499'>
      grid%itimestep=0<a name='500'>
      grid%xtime=0.         <font color=#447700>! BUG: This will probably not work for all DFI options<a name='501'></font>
<font color=#447700>! only use adaptive time stepping for forecast<a name='502'></font>
#if (EM_CORE == 1)<a name='503'>
      if (grid%id == 1) then<a name='504'>
         CALL nl_set_use_adaptive_time_step( 1, grid%use_adaptive_time_step )<a name='505'>
      endif<a name='506'>
      CALL nl_set_sst_update( grid%id, grid%sst_update)<a name='507'>
      <font color=#447700>! reset to normal bc<a name='508'></font>
      CALL nl_set_constant_bc(grid%id, .false.)<a name='509'>
#endif<a name='510'>
      CALL nl_set_feedback( grid%id, grid%feedback )<a name='511'>
<a name='512'>
#if ( WRF_CHEM == 1 )<a name='513'>
      <font color=#447700>! reset chem option to normal<a name='514'></font>
      CALL nl_set_chem_opt( grid%id, grid%chem_opt)<a name='515'>
      CALL nl_set_aer_ra_feedback (grid%id, grid%aer_ra_feedback)<a name='516'>
      CALL nl_set_io_form_auxinput5 (grid%id, grid%io_form_auxinput5)<a name='517'>
      CALL nl_set_io_form_auxinput6 (grid%id, grid%io_form_auxinput6)<a name='518'>
      CALL nl_set_io_form_auxinput7 (grid%id, grid%io_form_auxinput7)<a name='519'>
      CALL nl_set_io_form_auxinput8 (grid%id, grid%io_form_auxinput8)<a name='520'>
      CALL nl_set_io_form_auxinput13(grid%id, grid%io_form_auxinput13)<a name='521'>
      CALL nl_set_io_form_auxinput14(grid%id, grid%io_form_auxinput14)<a name='522'>
      CALL nl_set_io_form_auxinput15(grid%id, grid%io_form_auxinput15)<a name='523'>
<a name='524'>
      <font color=#447700>! This resets the open file handles associated with the chemistry<a name='525'></font>
      <font color=#447700>! auxinputs.  It may be a good idea to do this with other auxinputs as well.<a name='526'></font>
      <font color=#447700>! A better fix than the below may be to never assign the file handles to begin<a name='527'></font>
      <font color=#447700>! with when running DFI.<a name='528'></font>
<a name='529'>
      grid%auxinput5_oid = 0<a name='530'>
      grid%auxinput6_oid = 0<a name='531'>
      grid%auxinput7_oid = 0<a name='532'>
      grid%auxinput8_oid = 0<a name='533'>
      grid%auxinput12_oid = 0<a name='534'>
      grid%auxinput13_oid = 0<a name='535'>
      grid%auxinput14_oid = 0<a name='536'>
      grid%auxinput15_oid = 0<a name='537'>
#endif<a name='538'>
    <a name='539'>
#if (EM_CORE == 1)<a name='540'>
      <font color=#447700>! reset pressure level diags to normal<a name='541'></font>
      CALL nl_set_p_lev_diags ( grid%id, grid%p_lev_diags)<a name='542'>
#endif<a name='543'>
<a name='544'>
<a name='545'>
      CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_15"> (grid)<a name='546'>
      grid%start_subtime = domain_get_start_time ( grid )<a name='547'>
      grid%stop_subtime = domain_get_stop_time ( grid )<a name='548'>
<a name='549'>
      CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_6"> ( grid , .TRUE. )<a name='550'>
<a name='551'>
   END SUBROUTINE dfi_fst_init<a name='552'>
<a name='553'>
<a name='554'>
<A NAME='DFI_WRITE_INITIALIZED_STATE'><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='555'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_write_initialized_state</font>( grid ) <A href='../../call_to/DFI_WRITE_INITIALIZED_STATE.html' TARGET='index'>1</A>,<A href='../../call_from/DFI_WRITE_INITIALIZED_STATE.html' TARGET='index'>8</A><a name='556'>
<a name='557'>
      <font color=#447700>! Driver layer<a name='558'></font>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_271">, ONLY : domain, head_grid<a name='559'>
      USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_22"><a name='560'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_164">, ONLY : grid_config_rec_type, model_config_rec<a name='561'>
<a name='562'>
      IMPLICIT NONE<a name='563'>
<a name='564'>
      TYPE (domain) , POINTER :: grid<a name='565'>
      INTEGER             :: fid, ierr<a name='566'>
      CHARACTER (LEN=80)  :: wrf_error_message<a name='567'>
      CHARACTER (LEN=256) :: rstname<a name='568'>
      CHARACTER (LEN=132) :: message<a name='569'>
<a name='570'>
      TYPE (grid_config_rec_type) :: config_flags<a name='571'>
<a name='572'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_48"> ( grid%id , model_config_rec , config_flags )<a name='573'>
<a name='574'>
      WRITE (wrf_err_message,'(A,I4)') 'Writing out initialized model state'<a name='575'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1080">(TRIM(wrf_err_message))<a name='576'>
<a name='577'>
      WRITE (rstname,'(A,I2.2)')'wrfinput_initialized_d',grid%id<a name='578'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_19"> ( fid, TRIM(rstname), grid, config_flags, output_input, "DATASET=INPUT", ierr )<a name='579'>
      IF ( ierr .NE. 0 ) THEN<a name='580'>
         WRITE( message , '("program wrf: error opening ",A," for writing")') TRIM(rstname)<a name='581'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1304"> ( message )<a name='582'>
      END IF<a name='583'>
      CALL output_input ( fid,   grid, config_flags, ierr )<a name='584'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_24"> ( fid, config_flags, "DATASET=INPUT" )<a name='585'>
<a name='586'>
   END SUBROUTINE dfi_write_initialized_state<a name='587'>
<a name='588'>
<A NAME='TDFI_WRITE_ANALYZED_STATE'><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='589'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>tdfi_write_analyzed_state</font> ( grid ) <A href='../../call_to/TDFI_WRITE_ANALYZED_STATE.html' TARGET='index'>1</A>,<A href='../../call_from/TDFI_WRITE_ANALYZED_STATE.html' TARGET='index'>7</A><a name='590'>
<a name='591'>
      <font color=#447700>! Driver layer<a name='592'></font>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_272">, ONLY : domain, head_grid<a name='593'>
      USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_23"><a name='594'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_165">, ONLY : grid_config_rec_type, model_config_rec<a name='595'>
<a name='596'>
      IMPLICIT NONE<a name='597'>
<a name='598'>
      TYPE (domain) , POINTER :: grid<a name='599'>
      INTEGER             :: fid, ierr<a name='600'>
      CHARACTER (LEN=80)  :: wrf_error_message<a name='601'>
      CHARACTER (LEN=256) :: rstname<a name='602'>
      CHARACTER (LEN=132) :: message<a name='603'>
<a name='604'>
      TYPE (grid_config_rec_type) :: config_flags<a name='605'>
<a name='606'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_49"> ( grid%id , model_config_rec , config_flags )<a name='607'>
<a name='608'>
      rstname = 'wrfout_analyzed_d01'<a name='609'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_20"> ( fid, TRIM(rstname),grid, config_flags, output_input, "DATASET=INPUT", ierr )<a name='610'>
      IF ( ierr .NE. 0 ) THEN<a name='611'>
         WRITE( message , '("program wrf: error opening ",A," for writing")') TRIM(rstname)<a name='612'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1305"> ( message )<a name='613'>
      END IF<a name='614'>
      CALL output_input ( fid,   grid, config_flags, ierr )<a name='615'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_25"> ( fid, config_flags, "DATASET=INPUT" )<a name='616'>
<a name='617'>
   END SUBROUTINE tdfi_write_analyzed_state<a name='618'>
<a name='619'>
<a name='620'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='621'></font>
<font color=#447700>! DFI array reset group of functions<a name='622'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='623'></font>
<a name='624'>
<A NAME='WRF_DFI_ARRAY_RESET'><A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='625'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dfi_array_reset</font> ( ) <A href='../../call_to/WRF_DFI_ARRAY_RESET.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_DFI_ARRAY_RESET.html' TARGET='index'>4</A><a name='626'>
<a name='627'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_273">, ONLY : domain, head_grid, set_current_grid_ptr<a name='628'>
<a name='629'>
      IMPLICIT NONE<a name='630'>
<a name='631'>
      INTERFACE<a name='632'>
         RECURSIVE SUBROUTINE dfi_array_reset_recurse(grid)<a name='633'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_274">, ONLY : domain<a name='634'>
            TYPE (domain), POINTER :: grid<a name='635'>
         END SUBROUTINE dfi_array_reset_recurse<a name='636'>
      END INTERFACE<a name='637'>
<a name='638'>
      <font color=#447700>! Copy filtered arrays back into state arrays in grid structure, and <a name='639'></font>
      <font color=#447700>!   restore original land surface fields<a name='640'></font>
<a name='641'>
      CALL <A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET_RECURSE'>dfi_array_reset_recurse</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_ARRAY_RESET_RECURSE_1">(head_grid)<a name='642'>
<a name='643'>
      CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_12">( head_grid )<a name='644'>
<a name='645'>
   END SUBROUTINE wrf_dfi_array_reset<a name='646'>
<a name='647'>
<A NAME='DFI_ARRAY_RESET'><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='648'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_array_reset</font>( grid ) <A href='../../call_to/DFI_ARRAY_RESET.html' TARGET='index'>1</A>,<A href='../../call_from/DFI_ARRAY_RESET.html' TARGET='index'>7</A><a name='649'>
<a name='650'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_275">, ONLY : domain<a name='651'>
<font color=#447700>!      USE module_configure<a name='652'></font>
<font color=#447700>!      USE module_driver_constants<a name='653'></font>
<font color=#447700>!      USE module_machine<a name='654'></font>
<font color=#447700>!      USE module_dm<a name='655'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_106"><a name='656'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_169"><a name='657'>
<a name='658'>
      IMPLICIT NONE<a name='659'>
<a name='660'>
      INTEGER :: its, ite, jts, jte, kts, kte, &amp;<a name='661'>
                 i, j, k<a name='662'>
      INTEGER :: n_moist, nm, n_scalar, ns<a name='663'>
<a name='664'>
      <font color=#447700>!  Input data.<a name='665'></font>
      TYPE(domain) , POINTER          :: grid<a name='666'>
<a name='667'>
      <font color=#447700>! local<a name='668'></font>
<font color=#447700>!      real p1000mb,eps,svp1,svp2,svp3,svpt0<a name='669'></font>
      real eps<a name='670'>
<font color=#447700>!      parameter (p1000mb = 1.e+05, eps=0.622,svp1=0.6112,svp3=29.65,svpt0=273.15)<a name='671'></font>
      parameter (eps=0.622)<a name='672'>
      integer nsoil , ncount<a name='673'>
      REAL es,qs,pol,tx,temp,pres,rslf,rsif             <a name='674'>
      CHARACTER*80 mess<a name='675'>
<a name='676'>
      ncount = 0<a name='677'>
      nsoil = grid%num_soil_layers <a name='678'>
<a name='679'>
      IF ( grid%dfi_opt .EQ. DFI_NODFI ) RETURN<a name='680'>
<a name='681'>
<a name='682'>
      <font color=#447700>! Set dynamic variables<a name='683'></font>
      <font color=#447700>! divide by total DFI coefficient<a name='684'></font>
<a name='685'>
#if (EM_CORE == 1)<a name='686'>
      grid%MU_2(:,:)    = grid%dfi_mu(:,:)      / grid%hcoeff_tot<a name='687'>
      grid%u_2(:,:,:)   = grid%dfi_u(:,:,:)     / grid%hcoeff_tot<a name='688'>
      grid%v_2(:,:,:)   = grid%dfi_v(:,:,:)     / grid%hcoeff_tot<a name='689'>
      grid%w_2(:,:,:)   = grid%dfi_w(:,:,:)     / grid%hcoeff_tot<a name='690'>
      grid%ww(:,:,:)    = grid%dfi_ww(:,:,:)    / grid%hcoeff_tot<a name='691'>
      grid%t_2(:,:,:)   = grid%dfi_t(:,:,:)     / grid%hcoeff_tot<a name='692'>
      grid%phb(:,:,:)   = grid%dfi_phb(:,:,:)   / grid%hcoeff_tot<a name='693'>
      grid%ph0(:,:,:)   = grid%dfi_ph0(:,:,:)   / grid%hcoeff_tot<a name='694'>
      grid%php(:,:,:)   = grid%dfi_php(:,:,:)   / grid%hcoeff_tot<a name='695'>
      grid%p(:,:,:)     = grid%dfi_p(:,:,:)     / grid%hcoeff_tot<a name='696'>
      grid%ph_2(:,:,:)  = grid%dfi_ph(:,:,:)    / grid%hcoeff_tot<a name='697'>
      grid%tke_2(:,:,:) = grid%dfi_tke(:,:,:)   / grid%hcoeff_tot<a name='698'>
      grid%al(:,:,:)    = grid%dfi_al(:,:,:)    / grid%hcoeff_tot<a name='699'>
      grid%alt(:,:,:)   = grid%dfi_alt(:,:,:)   / grid%hcoeff_tot<a name='700'>
      grid%pb(:,:,:)    = grid%dfi_pb(:,:,:)    / grid%hcoeff_tot<a name='701'>
    IF ( grid%dfi_savehydmeteors .EQ. 0 ) then<a name='702'>
<font color=#447700>!    print *,'Normal DFI'<a name='703'></font>
      grid%moist(:,:,:,:)  = max(0.,grid%dfi_moist(:,:,:,:)  / grid%hcoeff_tot)<a name='704'>
      grid%scalar(:,:,:,:) = max(0.,grid%dfi_scalar(:,:,:,:) / grid%hcoeff_tot)<a name='705'>
      grid%re_cloud(:,:,:) = max(0.,grid%dfi_re_cloud(:,:,:) / grid%hcoeff_tot)<a name='706'>
      grid%re_ice(:,:,:)   = max(0.,grid%dfi_re_ice(:,:,:)   / grid%hcoeff_tot)<a name='707'>
      grid%re_snow(:,:,:)  = max(0.,grid%dfi_re_snow(:,:,:)  / grid%hcoeff_tot)<a name='708'>
    ELSE<a name='709'>
<font color=#447700>!    print *,'In dfi_array_reset, QV comp, dfi_save_hydrometeors=1'<a name='710'></font>
      grid%moist(:,:,:,P_QV)  = max(0.,grid%dfi_moist(:,:,:,P_QV)  / grid%hcoeff_tot)<a name='711'>
    ENDIF<a name='712'>
     if ( grid%sf_surface_physics .EQ. RUCLSMSCHEME ) then<a name='713'>
<font color=#447700>!      grid%qvg(:,:)    = grid%dfi_qvg(:,:)      / grid%hcoeff_tot<a name='714'></font>
     endif<a name='715'>
<a name='716'>
    IF ( grid%dfi_savehydmeteors .EQ. 1 ) then<a name='717'>
<font color=#447700>!    print *,'restore initial surface fields'<a name='718'></font>
      <font color=#447700>! restore initial fields<a name='719'></font>
      grid%SNOW  (:,:) = grid%dfi_SNOW  (:,:)<a name='720'>
      grid%SNOWH (:,:) = grid%dfi_SNOWH (:,:)<a name='721'>
      grid%SNOWC (:,:) = grid%dfi_SNOWC (:,:)<a name='722'>
      grid%CANWAT(:,:) = grid%dfi_CANWAT(:,:)<a name='723'>
      grid%TSK   (:,:) = grid%dfi_TSK   (:,:)<a name='724'>
<a name='725'>
      grid%TSLB  (:,:,:)       = grid%dfi_TSLB   (:,:,:)<a name='726'>
      grid%SMOIS (:,:,:)       = grid%dfi_SMOIS  (:,:,:)<a name='727'>
      IF ( grid%sf_surface_physics .EQ. RUCLSMSCHEME ) then<a name='728'>
         grid%QVG   (:,:) = grid%dfi_QVG   (:,:)<a name='729'>
         grid%TSNAV (:,:) = grid%dfi_TSNAV (:,:)  <a name='730'>
         grid%SOILT1(:,:) = grid%dfi_SOILT1(:,:)   <a name='731'>
         grid%SMFR3D(:,:,:)       = grid%dfi_SMFR3D (:,:,:)<a name='732'>
         grid%KEEPFR3DFLAG(:,:,:) = grid%dfi_KEEPFR3DFLAG(:,:,:)<a name='733'>
      ENDIF<a name='734'>
<a name='735'>
    ELSE<a name='736'>
<font color=#447700>!      print *, 'take into account DFI snowfall'<a name='737'></font>
      <font color=#447700>! restore initial fields<a name='738'></font>
            its = grid%sp31 ; ite = grid%ep31 ;<a name='739'>
            jts = grid%sp33 ; jte = grid%ep33 ;<a name='740'>
    DO j=jts,jte<a name='741'>
       DO i=its,ite<a name='742'>
<a name='743'>
        grid%SNOW  (i,j) = max(grid%SNOW  (i,j),grid%dfi_SNOW  (i,j))<a name='744'>
        grid%SNOWH (i,j) = max(grid%SNOWH (i,j),grid%dfi_SNOWH (i,j))<a name='745'>
        grid%SNOWC (i,j) = max(grid%SNOWC (i,j),grid%dfi_SNOWC (i,j))<a name='746'>
        grid%CANWAT(i,j) = max(grid%CANWAT(i,j),grid%dfi_CANWAT(i,j))<a name='747'>
      IF(grid%SNOWC (i,j) .eq.0.) then<a name='748'>
        grid%TSK   (i,j) = grid%dfi_TSK   (i,j)<a name='749'>
        do k=1,nsoil<a name='750'>
          grid%TSLB  (i,k,j)       = grid%dfi_TSLB   (i,k,j)<a name='751'>
          grid%SMOIS (i,k,j)       = grid%dfi_SMOIS  (i,k,j)<a name='752'>
         IF ( grid%sf_surface_physics .EQ. RUCLSMSCHEME ) then<a name='753'>
          grid%KEEPFR3DFLAG(i,k,j) = grid%dfi_KEEPFR3DFLAG(i,k,j)<a name='754'>
          grid%SMFR3D(i,k,j)       = grid%dfi_SMFR3D (i,k,j)<a name='755'>
         ENDIF<a name='756'>
        enddo<a name='757'>
         IF ( grid%sf_surface_physics .EQ. RUCLSMSCHEME ) then<a name='758'>
          grid%QVG   (i,j)         = grid%dfi_QVG   (i,j)<a name='759'>
          grid%TSNAV (i,j)         = grid%dfi_TSNAV (i,j)<a name='760'>
          grid%SOILT1(i,j)         = grid%dfi_SOILT1(i,j)<a name='761'>
         ENDIF<a name='762'>
      ENDIF<a name='763'>
<a name='764'>
      ENDDO<a name='765'>
    ENDDO<a name='766'>
<a name='767'>
    ENDIF<a name='768'>
<a name='769'>
      <font color=#447700>! restore analized hydrometeor and scalar fileds <a name='770'></font>
    IF ( grid%dfi_savehydmeteors .EQ. 1 ) then<a name='771'>
<font color=#447700>!    print *,'In dfi_array_reset - restore initial hydrometeors'<a name='772'></font>
<font color=#447700>!      grid%moist(:,:,:,:)      = grid%dfi_moist(:,:,:,:)    !tgs<a name='773'></font>
        n_moist  = num_moist<a name='774'>
      if (grid%dfi_stage .EQ. DFI_BCK) then<a name='775'>
<font color=#447700>!tgs - backward integration changed only QV<a name='776'></font>
        n_moist        = P_QV<a name='777'>
        n_scalar       = PARAM_FIRST_SCALAR - 1<a name='778'>
      endif<a name='779'>
         DO nm=PARAM_FIRST_SCALAR+1,n_moist<a name='780'>
             grid%moist(:,:,:,nm)=grid%dfi_moist(:,:,:,nm)<a name='781'>
         ENDDO<a name='782'>
        grid%scalar(:,:,:,:)     = grid%dfi_scalar(:,:,:,:)<a name='783'>
<a name='784'>
       if(grid%dfi_stage .EQ. DFI_FWD) then<a name='785'>
<font color=#447700>!tgs change QV to restore initial RH field after the diabatic DFI<a name='786'></font>
            its = grid%sp31 ; ite = grid%ep31 ;  <a name='787'>
            kts = grid%sp32 ; kte = grid%ep32 ; <a name='788'>
            jts = grid%sp33 ; jte = grid%ep33 ;<a name='789'>
   DO j=jts,jte<a name='790'>
      DO i=its,ite<a name='791'>
         do k = kts , kte<a name='792'>
          temp = (grid%t_2(i,k,j)+t0)*( (grid%p(i,k,j)+grid%pb(i,k,j))/p1000mb )&amp;<a name='793'>
                     ** (r_d / Cp)<a name='794'>
          pres = grid%p(i,k,j)+grid%pb(i,k,j)<a name='795'>
<font color=#447700>!tgs rslf - function to compute qs from Thompson microphysics<a name='796'></font>
          qs = <A href='../../html_code/share/dfi.F.html#RSLF'>rslf</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSLF_8">(pres, temp)<a name='797'>
<a name='798'>
<font color=#447700>!      if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='799'></font>
<font color=#447700>!       print *,'temp,pres,qs-thomp',temp,pres,qs<a name='800'></font>
<font color=#447700>!      endif<a name='801'></font>
<font color=#447700>!!         es=svp1*10.*EXP(svp2*(temp-svpt0)/(temp-svp3))<a name='802'></font>
<font color=#447700>!!          qs=0.622*es/(pres/100.-es)<a name='803'></font>
<a name='804'>
<font color=#447700>!     if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='805'></font>
<font color=#447700>!       print *,'temp,pres,qs-wrf',temp,pres,qs<a name='806'></font>
<font color=#447700>!      endif<a name='807'></font>
        Tx = temp-273.15<a name='808'>
        POL = 0.99999683       + TX*(-0.90826951E-02 +          &amp;<a name='809'>
           TX*(0.78736169E-04   + TX*(-0.61117958E-06 +         &amp;<a name='810'>
           TX*(0.43884187E-08   + TX*(-0.29883885E-10 +         &amp;<a name='811'>
           TX*(0.21874425E-12   + TX*(-0.17892321E-14 +         &amp;<a name='812'>
           TX*(0.11112018E-16   + TX*(-0.30994571E-19)))))))))<a name='813'>
        es = 6.1078/POL**8<a name='814'>
<font color=#447700>!!        qs = 0.62197*es / (pres/100. - es*0.37803)<a name='815'></font>
<font color=#447700>!      if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='816'></font>
<font color=#447700>!       print *,'temp,pres,qs-ruc',temp,pres,qs<a name='817'></font>
<font color=#447700>!      endif<a name='818'></font>
<a name='819'>
<font color=#447700>!      if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='820'></font>
<font color=#447700>!       print *,'before grid%moist (i,k,j,P_QV),grid%dfi_rh(i,k,j)',   &amp;<a name='821'></font>
<font color=#447700>!               grid%moist(i,k,j,P_QV),grid%dfi_rh(i,k,j)<a name='822'></font>
<font color=#447700>!      endif<a name='823'></font>
<a name='824'>
<font color=#447700>! Ensure that saturated points going into DFI remain saturated after DFI<a name='825'></font>
      IF(grid%dfi_rh(i,k,j) == 1. ) then<a name='826'>
         grid%moist (i,k,j,P_QV) = MAX(grid%moist (i,k,j,P_QV),grid%dfi_rh(i,k,j)*QS)<a name='827'>
          ncount=ncount+1<a name='828'>
      ENDIF<a name='829'>
<font color=#447700>!      if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='830'></font>
<font color=#447700>!       print *,'after grid%moist (i,k,j,P_QV)',  &amp;<a name='831'></font>
<font color=#447700>!                grid%moist(i,k,j,P_QV)<a name='832'></font>
<font color=#447700>!      endif<a name='833'></font>
         enddo<a name='834'>
      ENDDO<a name='835'>
   ENDDO<a name='836'>
<font color=#447700>!       print *,'QV reset to saturation at ncount= ',ncount<a name='837'></font>
       endif<a name='838'>
      <font color=#447700>!tgs need to call rebalance here again after hydrometeor and QV reset<a name='839'></font>
<font color=#447700>!         print *,'   Rebalancing is on '<a name='840'></font>
         CALL <A href='../../html_code/share/dfi.F.html#REBALANCE_DRIVER_DFI'>rebalance_driver_dfi</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REBALANCE_DRIVER_DFI_2"> ( grid )<a name='841'>
   ENDIF<a name='842'>
<a name='843'>
#endif<a name='844'>
<a name='845'>
#if (NMM_CORE == 1)<a name='846'>
        write(mess,*) ' divide by grid%hcoeff_tot: ', grid%hcoeff_tot<a name='847'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1081">(mess)<a name='848'>
	if (grid%hcoeff_tot .lt. 0.0001) then<a name='849'>
	call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1306">("bad grid%hcoeff_tot")<a name='850'>
	endif<a name='851'>
       grid%pd(:,:)       = grid%dfi_pd(:,:)  / grid%hcoeff_tot<a name='852'>
       grid%pint(:,:,:)      = grid%dfi_pint(:,:,:) / grid%hcoeff_tot<a name='853'>
<font color=#447700>!       grid%dwdt(:,:,:)      = grid%dfi_dwdt(:,:,:) / grid%hcoeff_tot<a name='854'></font>
       grid%t(:,:,:)      = grid%dfi_t(:,:,:) / grid%hcoeff_tot<a name='855'>
       grid%q(:,:,:)      = grid%dfi_q(:,:,:) / grid%hcoeff_tot<a name='856'>
       grid%q2(:,:,:)     = grid%dfi_q2(:,:,:) / grid%hcoeff_tot<a name='857'>
       grid%cwm(:,:,:)    = grid%dfi_cwm(:,:,:) / grid%hcoeff_tot<a name='858'>
       grid%u(:,:,:)      = grid%dfi_u(:,:,:) / grid%hcoeff_tot<a name='859'>
       grid%v(:,:,:)      = grid%dfi_v(:,:,:) / grid%hcoeff_tot<a name='860'>
      grid%moist(:,:,:,:)  = grid%dfi_moist(:,:,:,:)  / grid%hcoeff_tot<a name='861'>
      grid%scalar(:,:,:,:) = grid%dfi_scalar(:,:,:,:) / grid%hcoeff_tot<a name='862'>
<a name='863'>
      <font color=#447700>! restore initial fields<a name='864'></font>
      grid%SNOW(:,:)   = grid%dfi_SNOW(:,:)<a name='865'>
      grid%SNOWH(:,:)  = grid%dfi_SNOWH(:,:)<a name='866'>
<font color=#447700>!      grid%SNOWC(:,:)  = grid%dfi_SNOWC(:,:)<a name='867'></font>
      grid%CANWAT(:,:) = grid%dfi_CANWAT(:,:)<a name='868'>
      grid%NMM_TSK(:,:)    = grid%dfi_NMM_TSK(:,:)<a name='869'>
      <font color=#447700>! save soil fields<a name='870'></font>
      grid%STC(:,:,:)         = grid%dfi_STC(:,:,:)<a name='871'>
      grid%SMC(:,:,:)        = grid%dfi_SMC(:,:,:)<a name='872'>
      grid%SH2O(:,:,:)       = grid%dfi_SH2O(:,:,:)<a name='873'>
#endif<a name='874'>
<a name='875'>
<a name='876'>
   END SUBROUTINE dfi_array_reset<a name='877'>
<a name='878'>
<A NAME='OPTFIL_DRIVER'><A href='../../html_code/share/dfi.F.html#OPTFIL_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='879'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>optfil_driver</font>( grid ) <A href='../../call_to/OPTFIL_DRIVER.html' TARGET='index'>2</A>,<A href='../../call_from/OPTFIL_DRIVER.html' TARGET='index'>5</A><a name='880'>
<a name='881'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#OPTFIL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_276">, ONLY : domain<a name='882'>
      USE module_utility<a name='883'>
<font color=#447700>!      USE module_wrf_error<a name='884'></font>
<font color=#447700>!      USE module_timing<a name='885'></font>
<font color=#447700>!      USE module_date_time<a name='886'></font>
<font color=#447700>!      USE module_configure<a name='887'></font>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#OPTFIL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_170"><a name='888'>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/dfi.F.html#OPTFIL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_107"><a name='889'>
<a name='890'>
      IMPLICIT NONE<a name='891'>
<a name='892'>
      TYPE (domain) , POINTER                 :: grid<a name='893'>
<a name='894'>
      <font color=#447700>! Local variables<a name='895'></font>
      integer :: nstep2, nstepmax, rundfi, i, rc,hr,min,sec<a name='896'>
      integer :: yr,jday<a name='897'>
      real :: timestep, tauc<a name='898'>
      TYPE(WRFU_TimeInterval) :: run_interval<a name='899'>
      CHARACTER*80 mess<a name='900'>
<a name='901'>
      timestep=abs(grid%dt)<a name='902'>
      run_interval = grid%stop_subtime - grid%start_subtime<a name='903'>
      CALL WRFU_TimeGet(grid%start_subtime, YY=yr, dayofYear=jday, H=hr, M=min, S=sec, rc=rc)<a name='904'>
      CALL WRFU_TimeGet(grid%stop_subtime, YY=yr, dayofYear=jday, H=hr, M=min, S=sec, rc=rc)<a name='905'>
<a name='906'>
      CALL WRFU_TimeIntervalGet( run_interval, S=rundfi, rc=rc )<a name='907'>
      rundfi = abs(rundfi)<a name='908'>
<a name='909'>
      nstep2= ceiling((1.0 + real(rundfi)/timestep) / 2.0)<a name='910'>
<a name='911'>
      <font color=#447700>! nstep2 is equal to a half of timesteps per initialization period,<a name='912'></font>
      <font color=#447700>! should not exceed nstepmax<a name='913'></font>
<a name='914'>
      tauc = real(grid%dfi_cutoff_seconds)<a name='915'>
<a name='916'>
      <font color=#447700>! Get DFI coefficient<a name='917'></font>
      grid%hcoeff(:) = 0.0<a name='918'>
      IF ( grid%dfi_nfilter &lt; 0 .OR. grid%dfi_nfilter &gt; 8 ) THEN<a name='919'>
write(mess,*) 'Invalid filter specified in namelist.'<a name='920'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#OPTFIL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1082">(mess)<a name='921'>
      ELSE<a name='922'>
         call <A href='../../html_code/share/dfi.F.html#DFCOEF'>dfcoef</A><A href='../../html_code/share/dfi.F.html#OPTFIL_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFCOEF_1">(nstep2-1, grid%dt, tauc, grid%dfi_nfilter, grid%hcoeff)<a name='923'>
      END IF<a name='924'>
<a name='925'>
      IF ( MOD(int(1.0 + real(rundfi)/timestep),2) /= 0 ) THEN<a name='926'>
         DO i=1,nstep2-1 <a name='927'>
            grid%hcoeff(2*nstep2-i) = grid%hcoeff(i)<a name='928'>
         END DO<a name='929'>
      ELSE<a name='930'>
         DO i=1,nstep2 <a name='931'>
            grid%hcoeff(2*nstep2-i+1) = grid%hcoeff(i)<a name='932'>
         END DO<a name='933'>
      END IF<a name='934'>
<a name='935'>
   END SUBROUTINE optfil_driver<a name='936'>
<a name='937'>
<a name='938'>
<A NAME='DFI_CLEAR_ACCUMULATION'><A href='../../html_code/share/dfi.F.html#DFI_CLEAR_ACCUMULATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='939'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_clear_accumulation</font>( grid ) <A href='../../call_to/DFI_CLEAR_ACCUMULATION.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_CLEAR_ACCUMULATION.html' TARGET='index'>2</A><a name='940'>
<a name='941'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_CLEAR_ACCUMULATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_277">, ONLY : domain<a name='942'>
<font color=#447700>!      USE module_configure<a name='943'></font>
<font color=#447700>!      USE module_driver_constants<a name='944'></font>
<font color=#447700>!      USE module_machine<a name='945'></font>
<font color=#447700>!      USE module_dm<a name='946'></font>
<font color=#447700>!      USE module_model_constants<a name='947'></font>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_CLEAR_ACCUMULATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_171"><a name='948'>
<a name='949'>
      IMPLICIT NONE<a name='950'>
<a name='951'>
      <font color=#447700>!  Input data.<a name='952'></font>
      TYPE(domain) , POINTER          :: grid<a name='953'>
<a name='954'>
#if (EM_CORE == 1)<a name='955'>
      grid%dfi_mu(:,:)       = 0.<a name='956'>
      grid%dfi_u(:,:,:)      = 0.<a name='957'>
      grid%dfi_v(:,:,:)      = 0.<a name='958'>
      grid%dfi_w(:,:,:)      = 0.<a name='959'>
      grid%dfi_ww(:,:,:)     = 0.<a name='960'>
      grid%dfi_t(:,:,:)      = 0.<a name='961'>
      grid%dfi_phb(:,:,:)    = 0.<a name='962'>
      grid%dfi_ph0(:,:,:)    = 0.<a name='963'>
      grid%dfi_php(:,:,:)    = 0.<a name='964'>
      grid%dfi_p(:,:,:)      = 0.<a name='965'>
      grid%dfi_ph(:,:,:)     = 0.<a name='966'>
      grid%dfi_tke(:,:,:)    = 0.<a name='967'>
      grid%dfi_al(:,:,:)     = 0.<a name='968'>
      grid%dfi_alt(:,:,:)    = 0.<a name='969'>
      grid%dfi_pb(:,:,:)     = 0.<a name='970'>
    IF ( grid%dfi_savehydmeteors .EQ. 0 ) then  <a name='971'>
<font color=#447700>!    print *,'normal DFI'<a name='972'></font>
      grid%dfi_moist(:,:,:,:)  = 0.<a name='973'>
      grid%dfi_scalar(:,:,:,:) = 0.<a name='974'>
      grid%dfi_re_cloud(:,:,:) = 0.<a name='975'>
      grid%dfi_re_ice(:,:,:)   = 0.<a name='976'>
      grid%dfi_re_snow(:,:,:)  = 0.<a name='977'>
    ELSE<a name='978'>
<font color=#447700>!    print *,'In dfi_clear_accumulation, clear dfi_QV - dfi_savehydmeteors=1'<a name='979'></font>
      grid%dfi_moist(:,:,:,P_QV) = 0.<a name='980'>
    ENDIF<a name='981'>
     if ( grid%sf_surface_physics .EQ. RUCLSMSCHEME ) then<a name='982'>
<font color=#447700>!      grid%dfi_qvg(:,:)      = 0.<a name='983'></font>
     endif<a name='984'>
#endif<a name='985'>
<a name='986'>
#if (NMM_CORE == 1)<a name='987'>
       grid%dfi_pd(:,:)    = 0.<a name='988'>
       grid%dfi_pint(:,:,:)   = 0.<a name='989'>
       grid%dfi_dwdt(:,:,:)   = 0.<a name='990'>
       grid%dfi_t(:,:,:)   = 0.<a name='991'>
       grid%dfi_q(:,:,:)   = 0.<a name='992'>
       grid%dfi_q2(:,:,:)  = 0.<a name='993'>
       grid%dfi_cwm(:,:,:) = 0.<a name='994'>
       grid%dfi_u(:,:,:)   = 0.<a name='995'>
       grid%dfi_v(:,:,:)   = 0.<a name='996'>
      grid%dfi_moist(:,:,:,:)  = 0.<a name='997'>
      grid%dfi_scalar(:,:,:,:) = 0.<a name='998'>
#endif<a name='999'>
<a name='1000'>
      grid%hcoeff_tot  = 0.0<a name='1001'>
<a name='1002'>
   END SUBROUTINE dfi_clear_accumulation<a name='1003'>
<a name='1004'>
<a name='1005'>
<A NAME='DFI_SAVE_ARRAYS'><A href='../../html_code/share/dfi.F.html#DFI_SAVE_ARRAYS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1006'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_save_arrays</font>( grid ) <A href='../../call_to/DFI_SAVE_ARRAYS.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_SAVE_ARRAYS.html' TARGET='index'>4</A><a name='1007'>
<a name='1008'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_SAVE_ARRAYS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_278">, ONLY : domain<a name='1009'>
<font color=#447700>!      USE module_configure<a name='1010'></font>
<font color=#447700>!      USE module_driver_constants<a name='1011'></font>
<font color=#447700>!      USE module_machine<a name='1012'></font>
<font color=#447700>!      USE module_dm<a name='1013'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/dfi.F.html#DFI_SAVE_ARRAYS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_108"><a name='1014'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_SAVE_ARRAYS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_172"><a name='1015'>
<a name='1016'>
      IMPLICIT NONE<a name='1017'>
<a name='1018'>
      INTEGER :: its, ite, jts, jte, kts, kte, &amp;<a name='1019'>
                 i, j, k, n_moist, nm<a name='1020'>
<a name='1021'>
      <font color=#447700>!  Input data.<a name='1022'></font>
      TYPE(domain) , POINTER          :: grid<a name='1023'>
      <font color=#447700>! local<a name='1024'></font>
<a name='1025'>
      REAL es,qs,pol,tx,temp,pres,rslf<a name='1026'>
<a name='1027'>
#if (EM_CORE == 1)<a name='1028'>
      <font color=#447700>! save surface 2-D fields<a name='1029'></font>
      grid%dfi_SNOW(:,:)   = grid%SNOW(:,:) <a name='1030'>
      grid%dfi_SNOWH(:,:)  = grid%SNOWH(:,:) <a name='1031'>
      grid%dfi_SNOWC(:,:)  = grid%SNOWC(:,:) <a name='1032'>
      grid%dfi_CANWAT(:,:) = grid%CANWAT(:,:) <a name='1033'>
      grid%dfi_TSK(:,:)    = grid%TSK(:,:) <a name='1034'>
<a name='1035'>
      <font color=#447700>! save soil fields<a name='1036'></font>
      grid%dfi_TSLB(:,:,:)         = grid%TSLB(:,:,:) <a name='1037'>
      grid%dfi_SMOIS(:,:,:)        = grid%SMOIS(:,:,:) <a name='1038'>
      <font color=#447700>! RUC LSM only, need conditional<a name='1039'></font>
      IF ( grid%sf_surface_physics .EQ. RUCLSMSCHEME ) then<a name='1040'>
      grid%dfi_QVG(:,:)            = grid%QVG(:,:) <a name='1041'>
      grid%dfi_SOILT1(:,:)         = grid%SOILT1(:,:) <a name='1042'>
<font color=#447700>! use this array to save initial mu_2<a name='1043'></font>
<font color=#447700>!      grid%dfi_TSNAV(:,:)          = grid%mu_2(:,:) <a name='1044'></font>
      grid%dfi_TSNAV(:,:)          = grid%TSNAV(:,:) <a name='1045'>
      grid%dfi_SMFR3D(:,:,:)       = grid%SMFR3D(:,:,:) <a name='1046'>
      grid%dfi_KEEPFR3DFLAG(:,:,:) = grid%KEEPFR3DFLAG(:,:,:) <a name='1047'>
      ENDIF<a name='1048'>
#endif<a name='1049'>
<a name='1050'>
#if (NMM_CORE == 1)<a name='1051'>
      <font color=#447700>! save surface 2-D fields<a name='1052'></font>
      grid%dfi_SNOW(:,:)   = grid%SNOW(:,:)<a name='1053'>
      grid%dfi_SNOWH(:,:)  = grid%SNOWH(:,:)<a name='1054'>
<font color=#447700>!      grid%dfi_SNOWC(:,:)  = grid%SNOWC(:,:)<a name='1055'></font>
      grid%dfi_CANWAT(:,:) = grid%CANWAT(:,:)<a name='1056'>
      grid%dfi_NMM_TSK(:,:)    = grid%NMM_TSK(:,:)<a name='1057'>
      <font color=#447700>! save soil fields<a name='1058'></font>
      grid%dfi_STC(:,:,:)         = grid%STC(:,:,:)<a name='1059'>
      grid%dfi_SMC(:,:,:)        = grid%SMC(:,:,:)<a name='1060'>
      grid%dfi_SH2O(:,:,:)       = grid%SH2O(:,:,:)<a name='1061'>
#endif<a name='1062'>
<a name='1063'>
#if (EM_CORE == 1)<a name='1064'>
      <font color=#447700>! save hydrometeor and scalar fields <a name='1065'></font>
    IF ( grid%dfi_savehydmeteors .EQ. 1 ) then    <font color=#447700>!tgs<a name='1066'></font>
<font color=#447700>!    print *,'In dfi_save_arrays - save initial hydrometeors'<a name='1067'></font>
<font color=#447700>!       print *,'SAVE n_moist,PARAM_FIRST_SCALAR,P_QV,P_QC,P_QR,P_QI,P_QS,P_QG', &amp;<a name='1068'></font>
<font color=#447700>!                n_moist,PARAM_FIRST_SCALAR,P_QV,P_QC,P_QR,P_QI,P_QS,P_QG<a name='1069'></font>
        n_moist = num_moist<a name='1070'>
         DO nm=PARAM_FIRST_SCALAR+1,n_moist<a name='1071'>
             grid%dfi_moist(:,:,:,nm)=max(0.,grid%moist(:,:,:,nm))<a name='1072'>
         ENDDO<a name='1073'>
        grid%dfi_scalar(:,:,:,:) = max(0.,grid%scalar(:,:,:,:))<a name='1074'>
    ENDIF<a name='1075'>
<a name='1076'>
       if(grid%dfi_stage .EQ. DFI_BCK) then<a name='1077'>
<font color=#447700>! compute initial RH field to be reintroduced after the diabatic DFI<a name='1078'></font>
            its = grid%sp31 ; ite = grid%ep31 ;  <a name='1079'>
            kts = grid%sp32 ; kte = grid%ep32 ; <a name='1080'>
            jts = grid%sp33 ; jte = grid%ep33 ;<a name='1081'>
   DO j=jts,jte<a name='1082'>
      DO i=its,ite<a name='1083'>
         do k = kts , kte<a name='1084'>
          temp = (grid%t_2(i,k,j)+t0)*( (grid%p(i,k,j)+grid%pb(i,k,j))/p1000mb )&amp;<a name='1085'>
                     ** (r_d / Cp)<a name='1086'>
          pres = grid%p(i,k,j)+grid%pb(i,k,j)<a name='1087'>
<font color=#447700>!tgs rslf - function to compute qs from Thompson microphysics<a name='1088'></font>
          qs = <A href='../../html_code/share/dfi.F.html#RSLF'>rslf</A><A href='../../html_code/share/dfi.F.html#DFI_SAVE_ARRAYS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RSLF_9">(pres, temp)<a name='1089'>
<font color=#447700>!      if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='1090'></font>
<font color=#447700>!       print *,'temp,pres,qs-thomp',temp,pres,qs<a name='1091'></font>
<font color=#447700>!      endif<a name='1092'></font>
<a name='1093'>
<font color=#447700>!!          es=svp1*10.*EXP(svp2*(temp-svpt0)/(temp-svp3))<a name='1094'></font>
<font color=#447700>!!          qs=0.622*es/(pres/100.-es)<a name='1095'></font>
<a name='1096'>
<font color=#447700>!     if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='1097'></font>
<font color=#447700>!       print *,'temp,pres,qs-wrf',temp,pres,qs<a name='1098'></font>
<font color=#447700>!      endif<a name='1099'></font>
        Tx = temp-svpt0<a name='1100'>
        POL = 0.99999683       + TX*(-0.90826951E-02 +     &amp;<a name='1101'>
           TX*(0.78736169E-04   + TX*(-0.61117958E-06 +    &amp;<a name='1102'>
           TX*(0.43884187E-08   + TX*(-0.29883885E-10 +    &amp;<a name='1103'>
           TX*(0.21874425E-12   + TX*(-0.17892321E-14 +    &amp; <a name='1104'>
           TX*(0.11112018E-16   + TX*(-0.30994571E-19)))))))))<a name='1105'>
        es = 6.1078/POL**8<a name='1106'>
<font color=#447700>!!        qs = 0.62197*es / (pres/100. - es*0.37803)<a name='1107'></font>
<font color=#447700>!      if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='1108'></font>
<font color=#447700>!       print *,'temp,pres,qs-ruc',temp,pres,qs<a name='1109'></font>
<font color=#447700>!      endif<a name='1110'></font>
<a name='1111'>
          grid%dfi_rh (i,k,j) = MIN(1.,MAX(0.,grid%moist(i,k,j,P_QV)/qs))<a name='1112'>
<font color=#447700>!      if(i.eq. 464 .and. j.eq. 212 .and. k.eq.6) then<a name='1113'></font>
<font color=#447700>!       print *,'temp,pres,qs,grid%moist (i,k,j,P_QV),grid%dfi_rh (i,k,j)',temp,pres,qs,  &amp;<a name='1114'></font>
<font color=#447700>!              grid%moist(i,k,j,P_QV),grid%dfi_rh (i,k,j)<a name='1115'></font>
<font color=#447700>!      endif<a name='1116'></font>
<a name='1117'>
<font color=#447700>!tgs saturation check for points with water or ice clouds<a name='1118'></font>
      IF ((grid%moist (i,k,j,P_QC) .GT. 1.e-6  .or.        &amp;<a name='1119'>
          grid%moist (i,k,j,P_QI) .GT. 1.e-6)  .and.       &amp;<a name='1120'>
          grid%dfi_rh (i,k,j) .lt. 1.) THEN <a name='1121'>
               grid%dfi_rh (i,k,j)=1.<a name='1122'>
      ENDIF<a name='1123'>
         <a name='1124'>
        end do<a name='1125'>
      END DO<a name='1126'>
    ENDDO<a name='1127'>
       endif<a name='1128'>
<a name='1129'>
#endif<a name='1130'>
<a name='1131'>
   END SUBROUTINE dfi_save_arrays<a name='1132'>
<a name='1133'>
<a name='1134'>
<A NAME='DFCOEF'><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1135'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfcoef</font> (NSTEPS,DT,TAUC,NFILT,H) <A href='../../call_to/DFCOEF.html' TARGET='index'>1</A>,<A href='../../call_from/DFCOEF.html' TARGET='index'>11</A><a name='1136'>
<font color=#447700>!<a name='1137'></font>
<font color=#447700>!     calculate filter weights with selected window.<a name='1138'></font>
<font color=#447700>!<a name='1139'></font>
<font color=#447700>!       peter lynch and xiang-yu huang<a name='1140'></font>
<font color=#447700>!<a name='1141'></font>
<font color=#447700>!       ref: see hamming, r.w., 1989: digital filters,<a name='1142'></font>
<font color=#447700>!                prentice-hall international. 3rd edition.<a name='1143'></font>
<font color=#447700>!<a name='1144'></font>
<font color=#447700>!       input:      nsteps  -  number of timesteps<a name='1145'></font>
<font color=#447700>!                              forward or backward.<a name='1146'></font>
<font color=#447700>!                   dt      -  time step in seconds.<a name='1147'></font>
<font color=#447700>!                   tauc    -  cut-off period in seconds.<a name='1148'></font>
<font color=#447700>!                   nfilt   -  indicator for selected filter.<a name='1149'></font>
<font color=#447700>!<a name='1150'></font>
<font color=#447700>!       output:     h       -  array(0:nsteps) with the<a name='1151'></font>
<font color=#447700>!                              required filter weights<a name='1152'></font>
<font color=#447700>!<a name='1153'></font>
<font color=#447700>!------------------------------------------------------------<a name='1154'></font>
 <a name='1155'>
      implicit none<a name='1156'>
<a name='1157'>
      integer, intent(in)   :: nsteps, nfilt<a name='1158'>
      real   , intent(in)   :: dt, tauc<a name='1159'>
      real, intent(out)  :: h(1:nsteps+1)<a name='1160'>
      <a name='1161'>
      <font color=#447700>! Local data<a name='1162'></font>
<a name='1163'>
      integer               :: n<a name='1164'>
      real                  :: pi, omegac, x, window, deltat<a name='1165'>
      real                  :: hh(0:nsteps)<a name='1166'>
<a name='1167'>
      pi=4*ATAN(1.)<a name='1168'>
      deltat=ABS(dt)<a name='1169'>
<a name='1170'>
      <font color=#447700>! windows are defined by a call and held in hh.<a name='1171'></font>
<a name='1172'>
      if ( nfilt .eq. -1) call <A href='../../html_code/share/dfi.F.html#DEBUG'>debug</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEBUG_1">    (nsteps,h)<a name='1173'>
<a name='1174'>
      IF ( NFILT .EQ. 0 ) CALL <A href='../../html_code/share/dfi.F.html#UNIFORM'>UNIFORM</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNIFORM_1">  (NSTEPS,HH)<a name='1175'>
      IF ( NFILT .EQ. 1 ) CALL <A href='../../html_code/share/dfi.F.html#LANCZOS'>LANCZOS</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LANCZOS_1">  (NSTEPS,HH)<a name='1176'>
      IF ( NFILT .EQ. 2 ) CALL <A href='../../html_code/share/dfi.F.html#HAMMING'>HAMMING</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HAMMING_1">  (NSTEPS,HH)<a name='1177'>
      IF ( NFILT .EQ. 3 ) CALL <A href='../../html_code/share/dfi.F.html#BLACKMAN'>BLACKMAN</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLACKMAN_1"> (NSTEPS,HH)<a name='1178'>
      IF ( NFILT .EQ. 4 ) CALL <A href='../../html_code/share/dfi.F.html#KAISER'>KAISER</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KAISER_1">   (NSTEPS,HH)<a name='1179'>
      IF ( NFILT .EQ. 5 ) CALL <A href='../../html_code/share/dfi.F.html#POTTER2'>POTTER2</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POTTER2_1">  (NSTEPS,HH)<a name='1180'>
      IF ( NFILT .EQ. 6 ) CALL <A href='../../html_code/share/dfi.F.html#DOLPHWIN'>DOLPHWIN</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOLPHWIN_1"> (NSTEPS,HH)<a name='1181'>
<a name='1182'>
      IF ( NFILT .LE. 6 ) THEN     <font color=#447700>! sinc-windowed filters<a name='1183'></font>
<a name='1184'>
         <font color=#447700>! calculate the cutoff frequency<a name='1185'></font>
         OMEGAC = 2.*PI/TAUC<a name='1186'>
<a name='1187'>
         DO N=0,NSTEPS<a name='1188'>
            WINDOW = HH(N)<a name='1189'>
            IF ( N .EQ. 0 ) THEN<a name='1190'>
              X = (OMEGAC*DELTAT/PI)<a name='1191'>
            ELSE<a name='1192'>
              X = SIN(N*OMEGAC*DELTAT)/(N*PI)<a name='1193'>
            END IF<a name='1194'>
            HH(N) = X*WINDOW<a name='1195'>
         END DO<a name='1196'>
<a name='1197'>
         <font color=#447700>! normalize the sums to be unity<a name='1198'></font>
         CALL <A href='../../html_code/share/dfi.F.html#NORMLZ'>NORMLZ</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NORMLZ_1">(HH,NSTEPS)<a name='1199'>
<a name='1200'>
         DO N=0,NSTEPS<a name='1201'>
            H(N+1) = HH(NSTEPS-N)<a name='1202'>
         END DO<a name='1203'>
<a name='1204'>
      ELSE IF ( NFILT .EQ. 7 ) THEN     <font color=#447700>! dolph filter<a name='1205'></font>
<a name='1206'>
         CALL <A href='../../html_code/share/dfi.F.html#DOLPH'>DOLPH</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOLPH_1">(DT,TAUC,NSTEPS,H)<a name='1207'>
<a name='1208'>
      ELSE IF ( NFILT .EQ. 8 ) THEN     <font color=#447700>! 2nd order, 2nd type quick start filter (RHO)<a name='1209'></font>
<a name='1210'>
         CALL <A href='../../html_code/share/dfi.F.html#RHOFIL'>RHOFIL</A><A href='../../html_code/share/dfi.F.html#DFCOEF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RHOFIL_1">(DT,TAUC,2,NSTEPS*2,2,H,NSTEPS)<a name='1211'>
<a name='1212'>
      END IF<a name='1213'>
<a name='1214'>
      RETURN<a name='1215'>
<a name='1216'>
   END SUBROUTINE dfcoef<a name='1217'>
<a name='1218'>
<a name='1219'>
<A NAME='NORMLZ'><A href='../../html_code/share/dfi.F.html#NORMLZ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1220'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>NORMLZ</font>(HH,NMAX) <A href='../../call_to/NORMLZ.html' TARGET='index'>1</A><a name='1221'>
<a name='1222'>
   <font color=#447700>! normalize the sum of hh to be unity<a name='1223'></font>
<a name='1224'>
      implicit none<a name='1225'>
  <a name='1226'>
      integer, intent(in)                       :: nmax<a name='1227'>
      real   , dimension(0:nmax), intent(out)   :: hh<a name='1228'>
<a name='1229'>
      <font color=#447700>! local data<a name='1230'></font>
      real     :: sumhh<a name='1231'>
      integer  :: n<a name='1232'>
<a name='1233'>
      SUMHH = HH(0)<a name='1234'>
      DO N=1,NMAX<a name='1235'>
        SUMHH = SUMHH + 2*HH(N)<a name='1236'>
      ENDDO<a name='1237'>
      DO N=0,NMAX<a name='1238'>
        HH(N)  = HH(N)/SUMHH<a name='1239'>
      ENDDO<a name='1240'>
<a name='1241'>
      RETURN<a name='1242'>
<a name='1243'>
   END subroutine normlz<a name='1244'>
<a name='1245'>
<a name='1246'>
<A NAME='DEBUG'><A href='../../html_code/share/dfi.F.html#DEBUG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1247'>
   <font color=#993300>subroutine </font><font color=#cc0000>debug</font>(nsteps, ww) <A href='../../call_to/DEBUG.html' TARGET='index'>1</A><a name='1248'>
<a name='1249'>
      implicit none<a name='1250'>
<a name='1251'>
      integer, intent(in)                        :: nsteps<a name='1252'>
      real   , dimension(0:nsteps), intent(out)  :: ww<a name='1253'>
      integer :: n<a name='1254'>
<a name='1255'>
      do n=0,nsteps<a name='1256'>
         ww(n)=0<a name='1257'>
      end do<a name='1258'>
<a name='1259'>
      ww(int(nsteps/2))=1<a name='1260'>
<a name='1261'>
      return<a name='1262'>
<a name='1263'>
   end subroutine debug<a name='1264'>
<a name='1265'>
<a name='1266'>
<A NAME='UNIFORM'><A href='../../html_code/share/dfi.F.html#UNIFORM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1267'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>UNIFORM</font>(NSTEPS,WW) <A href='../../call_to/UNIFORM.html' TARGET='index'>1</A><a name='1268'>
<a name='1269'>
   <font color=#447700>!  define uniform or rectangular window function.<a name='1270'></font>
<a name='1271'>
      implicit none<a name='1272'>
<a name='1273'>
      integer, intent(in)                        :: nsteps<a name='1274'>
      real   , dimension(0:nsteps), intent(out)  :: ww<a name='1275'>
       <a name='1276'>
      integer          :: n<a name='1277'>
<a name='1278'>
      DO N=0,NSTEPS<a name='1279'>
        WW(N) = 1.<a name='1280'>
      ENDDO<a name='1281'>
<a name='1282'>
      RETURN<a name='1283'>
<a name='1284'>
   END subroutine uniform<a name='1285'>
<a name='1286'>
<a name='1287'>
<A NAME='LANCZOS'><A href='../../html_code/share/dfi.F.html#LANCZOS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1288'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>LANCZOS</font>(NSTEPS,WW) <A href='../../call_to/LANCZOS.html' TARGET='index'>1</A><a name='1289'>
<a name='1290'>
   <font color=#447700>! define (genaralised) lanczos window function.<a name='1291'></font>
<a name='1292'>
      implicit none <a name='1293'>
<a name='1294'>
      integer,  parameter                      :: nmax = 1000<a name='1295'>
      integer,  intent(in)                     :: nsteps<a name='1296'>
      real   ,  dimension(0:nmax), intent(out) :: ww<a name='1297'>
      integer  ::  n<a name='1298'>
      real     :: power, pi, w<a name='1299'>
<a name='1300'>
      <font color=#447700>! (for the usual lanczos window, power = 1 )<a name='1301'></font>
      POWER = 1<a name='1302'>
<a name='1303'>
      PI=4*ATAN(1.)<a name='1304'>
      DO N=0,NSTEPS<a name='1305'>
         IF ( N .EQ. 0 ) THEN<a name='1306'>
            W = 1.0<a name='1307'>
         ELSE<a name='1308'>
            W = SIN(N*PI/(NSTEPS+1)) / ( N*PI/(NSTEPS+1))<a name='1309'>
         ENDIF<a name='1310'>
         WW(N) = W**POWER<a name='1311'>
      ENDDO<a name='1312'>
<a name='1313'>
      RETURN<a name='1314'>
<a name='1315'>
   END SUBROUTINE lanczos<a name='1316'>
<a name='1317'>
<a name='1318'>
<A NAME='HAMMING'><A href='../../html_code/share/dfi.F.html#HAMMING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1319'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>HAMMING</font>(NSTEPS,WW) <A href='../../call_to/HAMMING.html' TARGET='index'>1</A><a name='1320'>
<a name='1321'>
   <font color=#447700>! define (genaralised) hamming window function.<a name='1322'></font>
<a name='1323'>
      implicit none<a name='1324'>
<a name='1325'>
      integer, intent(in)           :: nsteps<a name='1326'>
      real, dimension(0:nsteps)    :: ww<a name='1327'>
      integer   ::   n<a name='1328'>
      real      :: alpha, pi, w<a name='1329'>
<a name='1330'>
      <font color=#447700>! (for the usual hamming window, alpha=0.54,<a name='1331'></font>
      <font color=#447700>!      for the hann window, alpha=0.50).<a name='1332'></font>
      ALPHA=0.54<a name='1333'>
<a name='1334'>
      PI=4*ATAN(1.)<a name='1335'>
      DO N=0,NSTEPS<a name='1336'>
         IF ( N .EQ. 0 ) THEN<a name='1337'>
            W = 1.0<a name='1338'>
         ELSE<a name='1339'>
            W = ALPHA + (1-ALPHA)*COS(N*PI/(NSTEPS))<a name='1340'>
         ENDIF<a name='1341'>
         WW(N) = W<a name='1342'>
      ENDDO<a name='1343'>
<a name='1344'>
      RETURN<a name='1345'>
<a name='1346'>
   END SUBROUTINE hamming<a name='1347'>
<a name='1348'>
<a name='1349'>
<A NAME='BLACKMAN'><A href='../../html_code/share/dfi.F.html#BLACKMAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1350'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>BLACKMAN</font>(NSTEPS,WW) <A href='../../call_to/BLACKMAN.html' TARGET='index'>1</A><a name='1351'>
<a name='1352'>
   <font color=#447700>! define blackman window function.<a name='1353'></font>
<a name='1354'>
      implicit none<a name='1355'>
<a name='1356'>
      integer, intent(in)           :: nsteps<a name='1357'>
      real, dimension(0:nsteps)    :: ww<a name='1358'>
      integer  :: n<a name='1359'>
<a name='1360'>
      real :: pi, w<a name='1361'>
<a name='1362'>
      PI=4*ATAN(1.)<a name='1363'>
      DO N=0,NSTEPS<a name='1364'>
         IF ( N .EQ. 0 ) THEN<a name='1365'>
            W = 1.0<a name='1366'>
         ELSE<a name='1367'>
            W = 0.42 + 0.50*COS(  N*PI/(NSTEPS))   &amp;<a name='1368'>
                     + 0.08*COS(2*N*PI/(NSTEPS))<a name='1369'>
         ENDIF<a name='1370'>
         WW(N) = W<a name='1371'>
      ENDDO<a name='1372'>
<a name='1373'>
      RETURN<a name='1374'>
<a name='1375'>
   END SUBROUTINE blackman<a name='1376'>
<a name='1377'>
<a name='1378'>
<A NAME='KAISER'><A href='../../html_code/share/dfi.F.html#KAISER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1379'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>KAISER</font>(NSTEPS,WW) <A href='../../call_to/KAISER.html' TARGET='index'>1</A>,<A href='../../call_from/KAISER.html' TARGET='index'>2</A><a name='1380'>
<a name='1381'>
   <font color=#447700>! define kaiser window function.<a name='1382'></font>
<a name='1383'>
      implicit none<a name='1384'>
<a name='1385'>
      real, external :: bessi0<a name='1386'>
<a name='1387'>
      integer, intent(in)           :: nsteps<a name='1388'>
      real, dimension(0:nsteps)    :: ww<a name='1389'>
      integer   :: n<a name='1390'>
      real      :: alpha, xi0a, xn, as<a name='1391'>
<a name='1392'>
      ALPHA = 1<a name='1393'>
<a name='1394'>
      XI0A =  <A href='../../html_code/share/dfi.F.html#BESSI0'>BESSI0</A><A href='../../html_code/share/dfi.F.html#KAISER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BESSI0_1">(ALPHA)<a name='1395'>
      DO N=0,NSTEPS<a name='1396'>
         XN = N<a name='1397'>
         AS = ALPHA*SQRT(1.-(XN/NSTEPS)**2)<a name='1398'>
         WW(N) = <A href='../../html_code/share/dfi.F.html#BESSI0'>BESSI0</A><A href='../../html_code/share/dfi.F.html#KAISER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BESSI0_2">(AS) / XI0A<a name='1399'>
      ENDDO<a name='1400'>
<a name='1401'>
      RETURN<a name='1402'>
<a name='1403'>
   END SUBROUTINE kaiser<a name='1404'>
<a name='1405'>
<a name='1406'>
<A NAME='BESSI0'><A href='../../html_code/share/dfi.F.html#BESSI0' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1407'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>BESSI0</font>(X) <A href='../../call_to/BESSI0.html' TARGET='index'>2</A><a name='1408'>
<a name='1409'>
   <font color=#447700>! from numerical recipes (press, et al.)<a name='1410'></font>
<a name='1411'>
      implicit none<a name='1412'>
<a name='1413'>
      real(8)   :: Y<a name='1414'>
      real(8)   :: P1 = 1.0d0<a name='1415'>
      real(8)   :: P2 = 3.5156230D0<a name='1416'>
      real(8)   :: P3 = 3.0899424D0<a name='1417'>
      real(8)   :: P4 = 1.2067492D0<a name='1418'>
      real(8)   :: P5 = 0.2659732D0<a name='1419'>
      real(8)   :: P6 = 0.360768D-1<a name='1420'>
      real(8)   :: P7 = 0.45813D-2<a name='1421'>
<a name='1422'>
      real*8    :: Q1 = 0.39894228D0<a name='1423'>
      real*8    :: Q2 = 0.1328592D-1<a name='1424'>
      real*8    :: Q3 = 0.225319D-2<a name='1425'>
      real*8    :: Q4 = -0.157565D-2<a name='1426'>
      real*8    :: Q5 = 0.916281D-2<a name='1427'>
      real*8    :: Q6 = -0.2057706D-1<a name='1428'>
      real*8    :: Q7 = 0.2635537D-1<a name='1429'>
      real*8    :: Q8 = -0.1647633D-1<a name='1430'>
      real*8    :: Q9 = 0.392377D-2<a name='1431'>
<a name='1432'>
      real            :: x, ax<a name='1433'>
<a name='1434'>
<a name='1435'>
      IF (ABS(X).LT.3.75) THEN<a name='1436'>
        Y=(X/3.75)**2<a name='1437'>
        BESSI0=P1+Y*(P2+Y*(P3+Y*(P4+Y*(P5+Y*(P6+Y*P7)))))<a name='1438'>
      ELSE<a name='1439'>
        AX=ABS(X)<a name='1440'>
        Y=3.75/AX<a name='1441'>
        BESSI0=(EXP(AX)/SQRT(AX))*(Q1+Y*(Q2+Y*(Q3+Y*(Q4    &amp;<a name='1442'>
           +Y*(Q5+Y*(Q6+Y*(Q7+Y*(Q8+Y*Q9))))))))<a name='1443'>
      ENDIF<a name='1444'>
      RETURN<a name='1445'>
<a name='1446'>
   END FUNCTION bessi0<a name='1447'>
<a name='1448'>
<a name='1449'>
<A NAME='POTTER2'><A href='../../html_code/share/dfi.F.html#POTTER2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1450'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>POTTER2</font>(NSTEPS,WW) <A href='../../call_to/POTTER2.html' TARGET='index'>1</A>,<A href='../../call_from/POTTER2.html' TARGET='index'>1</A><a name='1451'>
<a name='1452'>
      <font color=#447700>! define potter window function.<a name='1453'></font>
      <font color=#447700>! modified to fall off over twice the range.<a name='1454'></font>
<a name='1455'>
      implicit none<a name='1456'>
<a name='1457'>
      integer, intent(in)                       :: nsteps<a name='1458'>
      real, dimension(0:nsteps),intent(out)     ::  ww<a name='1459'>
      integer  :: n<a name='1460'>
      real     :: ck, sum, arg<a name='1461'>
<a name='1462'>
      <font color=#447700>! local data<a name='1463'></font>
      real, dimension(0:3)   :: d <a name='1464'>
      real                   :: pi<a name='1465'>
      integer                :: ip<a name='1466'>
<a name='1467'>
      d(0) = 0.35577019<a name='1468'>
      d(1) = 0.2436983<a name='1469'>
      d(2) = 0.07211497<a name='1470'>
      d(3) = 0.00630165<a name='1471'>
<a name='1472'>
      PI=4*ATAN(1.)<a name='1473'>
<a name='1474'>
      CK = 1.0<a name='1475'>
      DO N=0,NSTEPS<a name='1476'>
         IF (N.EQ.NSTEPS) CK = 0.5<a name='1477'>
         ARG = PI*FLOAT(N)/FLOAT(NSTEPS)<a name='1478'>
<font color=#447700>!min---        modification in next statement<a name='1479'></font>
         ARG = ARG/2.<a name='1480'>
<font color=#447700>!min---        end of modification<a name='1481'></font>
         SUM = <A href='../../html_code/share/dfi.F.html#D'>D</A><A href='../../html_code/share/dfi.F.html#POTTER2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_22">(0)<a name='1482'>
         DO IP=1,3<a name='1483'>
            SUM = SUM + 2.*D(IP)*COS(ARG*FLOAT(IP))<a name='1484'>
         END DO<a name='1485'>
         WW(N) = CK*SUM<a name='1486'>
      END DO<a name='1487'>
<a name='1488'>
      RETURN<a name='1489'>
<a name='1490'>
   END SUBROUTINE potter2<a name='1491'>
<a name='1492'>
<a name='1493'>
<A NAME='DOLPHWIN'><A href='../../html_code/share/dfi.F.html#DOLPHWIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1494'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dolphwin</font>(m, window) <A href='../../call_to/DOLPHWIN.html' TARGET='index'>1</A>,<A href='../../call_from/DOLPHWIN.html' TARGET='index'>1</A><a name='1495'>
<a name='1496'>
<font color=#447700>!     calculation of dolph-chebyshev window or, for short,<a name='1497'></font>
<font color=#447700>!     dolph window, using the expression in the reference:<a name='1498'></font>
<font color=#447700>!<a name='1499'></font>
<font color=#447700>!     antoniou, andreas, 1993: digital filters: analysis,<a name='1500'></font>
<font color=#447700>!     design and applications. mcgraw-hill, inc., 689pp.<a name='1501'></font>
<font color=#447700>!<a name='1502'></font>
<font color=#447700>!     the dolph window is optimal in the following sense:<a name='1503'></font>
<font color=#447700>!     for a given main-lobe width, the stop-band attenuation<a name='1504'></font>
<font color=#447700>!     is minimal; for a given stop-band level, the main-lobe<a name='1505'></font>
<font color=#447700>!     width is minimal.<a name='1506'></font>
<font color=#447700>!<a name='1507'></font>
<font color=#447700>!     it is possible to specify either the ripple-ratio r<a name='1508'></font>
<font color=#447700>!     or the stop-band edge thetas.<a name='1509'></font>
<a name='1510'>
      IMPLICIT NONE<a name='1511'>
<a name='1512'>
      <font color=#447700>! Arguments<a name='1513'></font>
      INTEGER, INTENT(IN)                  ::  m<a name='1514'>
      REAL, DIMENSION(0:M), INTENT(OUT)    ::  window<a name='1515'>
<a name='1516'>
      <font color=#447700>! local data<a name='1517'></font>
      REAL, DIMENSION(0:2*M)               :: t<a name='1518'>
      REAL, DIMENSION(0:M)                 :: w, time<a name='1519'>
      REAL    :: pi, thetas, x0, term1, term2, rr, r, db, sum, arg<a name='1520'>
      INTEGER :: n, nm1, nt, i<a name='1521'>
<a name='1522'>
      PI = 4*ATAN(1.D0)<a name='1523'>
      THETAS = 2*PI/M<a name='1524'>
<a name='1525'>
      N = 2*M+1<a name='1526'>
      NM1 = N-1<a name='1527'>
      X0 = 1/COS(THETAS/2)<a name='1528'>
<a name='1529'>
      TERM1 = (X0 + SQRT(X0**2-1))**(FLOAT(N-1))<a name='1530'>
      TERM2 = (X0 - SQRT(X0**2-1))**(FLOAT(N-1))<a name='1531'>
      RR = 0.5*(TERM1+TERM2)<a name='1532'>
      R = 1/RR<a name='1533'>
      DB = 20*LOG10(R)<a name='1534'>
      WRITE(*,'(1X,''DOLPH: M,N='',2I8)')M,N<a name='1535'>
      WRITE(*,'(1X,''DOLPH: THETAS (STOP-BAND EDGE)='',F10.3)')THETAS<a name='1536'>
      WRITE(*,'(1X,''DOLPH: R,DB='',2F10.3)')R, DB<a name='1537'>
<a name='1538'>
      DO NT=0,M<a name='1539'>
        SUM = RR<a name='1540'>
        DO I=1,M<a name='1541'>
          ARG = X0*COS(I*PI/N)<a name='1542'>
          CALL <A href='../../html_code/share/dfi.F.html#CHEBY'>CHEBY</A><A href='../../html_code/share/dfi.F.html#DOLPHWIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHEBY_1">(T,NM1,ARG)<a name='1543'>
          TERM1 = T(NM1)<a name='1544'>
          TERM2 = COS(2*NT*PI*I/N)<a name='1545'>
          SUM = SUM + 2*TERM1*TERM2<a name='1546'>
        ENDDO<a name='1547'>
        W(NT) = SUM/N<a name='1548'>
        TIME(NT) = NT<a name='1549'>
      ENDDO<a name='1550'>
<a name='1551'>
<font color=#447700>!     fill up the array for return<a name='1552'></font>
      DO NT=0,M<a name='1553'>
        WINDOW(NT) = W(NT)<a name='1554'>
      ENDDO<a name='1555'>
<a name='1556'>
      RETURN<a name='1557'>
<a name='1558'>
   END SUBROUTINE dolphwin<a name='1559'>
<a name='1560'>
<a name='1561'>
<A NAME='DOLPH'><A href='../../html_code/share/dfi.F.html#DOLPH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1562'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dolph</font>(deltat, taus, m, window) <A href='../../call_to/DOLPH.html' TARGET='index'>1</A>,<A href='../../call_from/DOLPH.html' TARGET='index'>7</A><a name='1563'>
<a name='1564'>
<font color=#447700>!     calculation of dolph-chebyshev window or, for short,<a name='1565'></font>
<font color=#447700>!     dolph window, using the expression in the reference:<a name='1566'></font>
<font color=#447700>!<a name='1567'></font>
<font color=#447700>!     antoniou, andreas, 1993: digital filters: analysis,<a name='1568'></font>
<font color=#447700>!     design and applications. mcgraw-hill, inc., 689pp.<a name='1569'></font>
<font color=#447700>!<a name='1570'></font>
<font color=#447700>!     the dolph window is optimal in the following sense:<a name='1571'></font>
<font color=#447700>!     for a given main-lobe width, the stop-band attenuation<a name='1572'></font>
<font color=#447700>!     is minimal; for a given stop-band level, the main-lobe<a name='1573'></font>
<font color=#447700>!     width is minimal.<a name='1574'></font>
<a name='1575'>
      IMPLICIT NONE<a name='1576'>
<a name='1577'>
      <font color=#447700>! Arguments<a name='1578'></font>
      INTEGER, INTENT(IN)                  ::  m<a name='1579'>
      REAL, DIMENSION(0:M), INTENT(OUT)    ::  window<a name='1580'>
      REAL, INTENT(IN)                     :: deltat, taus<a name='1581'>
<a name='1582'>
      <font color=#447700>! local data<a name='1583'></font>
      integer, PARAMETER        :: NMAX = 5000<a name='1584'>
      REAL, dimension(0:NMAX)   :: t, w, time<a name='1585'>
      real, dimension(0:2*nmax) :: w2<a name='1586'>
      INTEGER                   :: NPRPE=0        <font color=#447700>! no of pe<a name='1587'></font>
      CHARACTER*80              :: MES<a name='1588'>
<a name='1589'>
      real    :: pi, thetas, x0, term1, term2, rr, r,db, sum, arg, sumw<a name='1590'>
      integer :: n, nm1, i, nt<a name='1591'>
      <a name='1592'>
      PI = 4*ATAN(1.D0)<a name='1593'>
<a name='1594'>
      WRITE (mes,'(A,F8.2,A,F10.2)') 'In dolph, deltat = ',deltat,' taus = ',taus<a name='1595'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DOLPH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1083">(TRIM(mes))<a name='1596'>
<a name='1597'>
      N = 2*M+1<a name='1598'>
      NM1 = N-1<a name='1599'>
<a name='1600'>
      THETAS = 2*PI*ABS(DELTAT/TAUS)<a name='1601'>
      X0 = 1/COS(THETAS/2)<a name='1602'>
      TERM1 = (X0 + SQRT(X0**2-1))**(FLOAT(N-1))<a name='1603'>
      TERM2 = (X0 - SQRT(X0**2-1))**(FLOAT(N-1))<a name='1604'>
      RR = 0.5*(TERM1+TERM2)<a name='1605'>
      R = 1/RR<a name='1606'>
      DB = 20*LOG10(R)<a name='1607'>
<a name='1608'>
      WRITE (mes,'(A,2I8)') 'In dolph: M,N = ', M,N<a name='1609'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DOLPH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1084">(TRIM(mes))<a name='1610'>
      WRITE (mes,'(A,F10.3)') 'In dolph: THETAS (STOP-BAND EDGE) = ', thetas<a name='1611'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DOLPH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1085">(TRIM(mes))<a name='1612'>
      WRITE (mes,'(A,2F10.3)') 'In dolph: R,DB = ', R,DB<a name='1613'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DOLPH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1086">(TRIM(mes))<a name='1614'>
<a name='1615'>
      DO NT=0,M<a name='1616'>
         SUM = 1<a name='1617'>
         DO I=1,M<a name='1618'>
            ARG = X0*COS(I*PI/N)<a name='1619'>
            CALL <A href='../../html_code/share/dfi.F.html#CHEBY'>CHEBY</A><A href='../../html_code/share/dfi.F.html#DOLPH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHEBY_2">(T,NM1,ARG)<a name='1620'>
            TERM1 = T(NM1)<a name='1621'>
            TERM2 = COS(2*NT*PI*I/N)<a name='1622'>
            SUM = SUM + R*2*TERM1*TERM2<a name='1623'>
         ENDDO<a name='1624'>
         W(NT) = SUM/N<a name='1625'>
         TIME(NT) = NT<a name='1626'>
         WRITE (mes,'(A,F10.6,2x,E17.7)') 'In dolph: TIME, W = ', TIME(NT), W(NT)<a name='1627'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DOLPH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1087">(TRIM(mes))<a name='1628'>
      ENDDO<a name='1629'>
<font color=#447700>!     fill in the negative-time values by symmetry.<a name='1630'></font>
      DO NT=0,M<a name='1631'>
         W2(M+NT) = W(NT)<a name='1632'>
         W2(M-NT) = W(NT)<a name='1633'>
      ENDDO<a name='1634'>
<a name='1635'>
<font color=#447700>!     fill up the array for return<a name='1636'></font>
      SUMW = 0.<a name='1637'>
      DO NT=0,2*M<a name='1638'>
         SUMW = SUMW + W2(NT)<a name='1639'>
      ENDDO<a name='1640'>
      WRITE (mes,'(A,F10.4)') 'In dolph: SUM OF WEIGHTS W2 = ', sumw<a name='1641'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/dfi.F.html#DOLPH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1088">(TRIM(mes))<a name='1642'>
<a name='1643'>
      DO NT=0,M<a name='1644'>
         WINDOW(NT) = W2(NT)<a name='1645'>
      ENDDO<a name='1646'>
<a name='1647'>
      RETURN<a name='1648'>
<a name='1649'>
   END SUBROUTINE dolph<a name='1650'>
<a name='1651'>
<a name='1652'>
<A NAME='CHEBY'><A href='../../html_code/share/dfi.F.html#CHEBY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1653'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cheby</font>(t, n, x) <A href='../../call_to/CHEBY.html' TARGET='index'>2</A><a name='1654'>
<a name='1655'>
<font color=#447700>!     calculate all chebyshev polynomials up to order n<a name='1656'></font>
<font color=#447700>!     for the argument value x.<a name='1657'></font>
<a name='1658'>
<font color=#447700>!     reference: numerical recipes, page 184, recurrence<a name='1659'></font>
<font color=#447700>!         t_n(x) = 2xt_{n-1}(x) - t_{n-2}(x) ,  n&gt;=2.<a name='1660'></font>
<a name='1661'>
      IMPLICIT NONE<a name='1662'>
<a name='1663'>
      <font color=#447700>! Arguments<a name='1664'></font>
      INTEGER, INTENT(IN)  :: n<a name='1665'>
      REAL, INTENT(IN)     :: x<a name='1666'>
      REAL, DIMENSION(0:N) :: t<a name='1667'>
 <a name='1668'>
      integer  :: nn<a name='1669'>
<a name='1670'>
      T(0) = 1<a name='1671'>
      T(1) = X<a name='1672'>
      IF(N.LT.2) RETURN<a name='1673'>
      DO NN=2,N<a name='1674'>
         T(NN) = 2*X*T(NN-1) - T(NN-2)<a name='1675'>
      ENDDO<a name='1676'>
<a name='1677'>
      RETURN<a name='1678'>
<a name='1679'>
   END SUBROUTINE cheby<a name='1680'>
<a name='1681'>
<a name='1682'>
<A NAME='RHOFIL'><A href='../../html_code/share/dfi.F.html#RHOFIL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1683'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rhofil</font>(dt, tauc, norder, nstep, ictype, frow, nosize) <A href='../../call_to/RHOFIL.html' TARGET='index'>1</A>,<A href='../../call_from/RHOFIL.html' TARGET='index'>2</A><a name='1684'>
<a name='1685'>
<font color=#447700>!       RHO = recurssive high order.<a name='1686'></font>
<font color=#447700>!<a name='1687'></font>
<font color=#447700>!       This routine calculates and returns the <a name='1688'></font>
<font color=#447700>!       Last Row, FROW, of the FILTER matrix.<a name='1689'></font>
<font color=#447700>!<a name='1690'></font>
<font color=#447700>!       Input Parameters:<a name='1691'></font>
<font color=#447700>!              DT  :  Time Step in seconds<a name='1692'></font>
<font color=#447700>!            TAUC  :  Cut-off period (hours)<a name='1693'></font>
<font color=#447700>!          NORDER  :  Order of QS Filter<a name='1694'></font>
<font color=#447700>!           NSTEP  :  Number of step/Size of row.<a name='1695'></font>
<font color=#447700>!          ICTYPE  :  Initial Conditions<a name='1696'></font>
<font color=#447700>!          NOSIZE  :  Max. side of FROW.<a name='1697'></font>
<font color=#447700>!<a name='1698'></font>
<font color=#447700>!       Working Fields:<a name='1699'></font>
<font color=#447700>!           ACOEF  :  X-coefficients of filter<a name='1700'></font>
<font color=#447700>!           BCOEF  :  Y-coefficients of filter<a name='1701'></font>
<font color=#447700>!          FILTER  :  Filter Matrix.<a name='1702'></font>
<font color=#447700>!<a name='1703'></font>
<font color=#447700>!       Output Parameters:<a name='1704'></font>
<font color=#447700>!            FROW  : Last Row of Filter Matrix.<a name='1705'></font>
<font color=#447700>!<a name='1706'></font>
<font color=#447700>!       Note: Two types of initial conditions are permitted.<a name='1707'></font>
<font color=#447700>!          ICTYPE = 1 : Order increasing each row to NORDER.<a name='1708'></font>
<font color=#447700>!          ICTYPE = 2 : Order fixed at NORDER throughout.<a name='1709'></font>
<font color=#447700>!<a name='1710'></font>
<font color=#447700>!       DOUBLE PRECISION USED THROUGHOUT.<a name='1711'></font>
<a name='1712'>
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)<a name='1713'>
<a name='1714'>
      DOUBLE PRECISION MUC<a name='1715'>
<a name='1716'>
<font color=#447700>!       N.B. Single Precision for List Parameters.<a name='1717'></font>
      REAL, intent(in)    ::  DT,TAUC<a name='1718'>
<a name='1719'>
<font color=#447700>!       Space for the last row of FILTER.<a name='1720'></font>
      integer, intent(in) ::  norder, nstep, ictype, nosize<a name='1721'>
      REAL   , dimension(0:nosize), intent(out)::  FROW<a name='1722'>
<a name='1723'>
<font color=#447700>!       Arrays for rho filter.<a name='1724'></font>
      integer, PARAMETER  :: NOMAX=100<a name='1725'>
      real   , dimension(0:NOMAX) :: acoef, bcoef<a name='1726'>
      real   , dimension(0:NOMAX,0:NOMAX) :: filter<a name='1727'>
<font color=#447700>!       Working space.<a name='1728'></font>
      real   , dimension(0:NOMAX) :: alpha, beta<a name='1729'>
<a name='1730'>
      real   :: DTT<a name='1731'>
<a name='1732'>
      DTT = ABS(DT)<a name='1733'>
      PI = 2*DASIN(1.D0)<a name='1734'>
      IOTA = CMPLX(0.,1.)<a name='1735'>
<a name='1736'>
<font color=#447700>!       Filtering Parameters (derived).<a name='1737'></font>
      THETAC = 2*PI*DTT/(TAUC)<a name='1738'>
      MUC = tan(THETAC/2) <a name='1739'>
      FC = THETAC/(2*PI)<a name='1740'>
<a name='1741'>
<font color=#447700>!     Clear the arrays.<a name='1742'></font>
    DO NC=0,NOMAX<a name='1743'>
       ACOEF(NC) = 0.<a name='1744'>
       BCOEF(NC) = 0.<a name='1745'>
       ALPHA(NC) = 0.<a name='1746'>
       BETA (NC) = 0.<a name='1747'>
       FROW (NC) = 0.<a name='1748'>
       DO NR=0,NOMAX<a name='1749'>
          FILTER(NR,NC) = 0.<a name='1750'>
       ENDDO<a name='1751'>
    ENDDO<a name='1752'>
<a name='1753'>
<font color=#447700>!     Fill up the Filter Matrix.<a name='1754'></font>
    FILTER(0,0) = 1.<a name='1755'>
<a name='1756'>
<font color=#447700>!     Get the coefficients of the Filter.<a name='1757'></font>
    IF ( ICTYPE.eq.2 ) THEN<a name='1758'>
       CALL <A href='../../html_code/share/dfi.F.html#RHOCOF'>RHOCOF</A><A href='../../html_code/share/dfi.F.html#RHOFIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RHOCOF_1">(NORDER,NOMAX,MUC, ACOEF,BCOEF)<a name='1759'>
    ENDIF<a name='1760'>
<a name='1761'>
    DO 100 NROW=1,NSTEP<a name='1762'>
<a name='1763'>
       IF ( ICTYPE.eq.1 ) THEN<a name='1764'>
          NORD = MIN(NROW,NORDER)<a name='1765'>
          IF ( NORD.le.NORDER) THEN<a name='1766'>
             CALL <A href='../../html_code/share/dfi.F.html#RHOCOF'>RHOCOF</A><A href='../../html_code/share/dfi.F.html#RHOFIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RHOCOF_2">(NORD,NOMAX,MUC, ACOEF,BCOEF)<a name='1767'>
          ENDIF<a name='1768'>
       ENDIF<a name='1769'>
<a name='1770'>
       DO K=0,NROW<a name='1771'>
          ALPHA(K) = ACOEF(NROW-K)<a name='1772'>
          IF(K.lt.NROW) BETA(K) = BCOEF(NROW-K)<a name='1773'>
       ENDDO<a name='1774'>
<a name='1775'>
<font color=#447700>!        Correction for terms of negative index.<a name='1776'></font>
       IF ( ICTYPE.eq.2 ) THEN<a name='1777'>
          IF ( NROW.lt.NORDER ) THEN<a name='1778'>
             CN = 0.<a name='1779'>
             DO NN=NROW+1,NORDER<a name='1780'>
                CN = CN + (ACOEF(NN)+BCOEF(NN))<a name='1781'>
             ENDDO<a name='1782'>
             ALPHA(0) = ALPHA(0) + CN<a name='1783'>
          ENDIF<a name='1784'>
       ENDIF<a name='1785'>
<a name='1786'>
<font color=#447700>!       Check sum of ALPHAs and BETAs = 1<a name='1787'></font>
      SUMAB = 0.<a name='1788'>
      DO NN=0,NROW<a name='1789'>
        SUMAB = SUMAB + ALPHA(NN)<a name='1790'>
          IF(NN.lt.NROW) SUMAB = SUMAB + BETA(NN)<a name='1791'>
      ENDDO<a name='1792'>
<a name='1793'>
      DO KK=0,NROW-1<a name='1794'>
         SUMBF = 0.<a name='1795'>
         DO LL=0,NROW-1<a name='1796'>
            SUMBF = SUMBF + BETA(LL)*FILTER(LL,KK)<a name='1797'>
         ENDDO<a name='1798'>
         FILTER(NROW,KK) = ALPHA(KK)+SUMBF<a name='1799'>
      ENDDO<a name='1800'>
      FILTER(NROW,NROW) = ALPHA(NROW)<a name='1801'>
<a name='1802'>
<font color=#447700>!       Check sum of row elements = 1<a name='1803'></font>
      SUMROW = 0.<a name='1804'>
      DO NN=0,NROW<a name='1805'>
        SUMROW = SUMROW + FILTER(NROW,NN)<a name='1806'>
      ENDDO<a name='1807'>
<a name='1808'>
100 CONTINUE<a name='1809'>
<a name='1810'>
      DO NC=0,NSTEP<a name='1811'>
        FROW(NC) = FILTER(NSTEP,NC)<a name='1812'>
      ENDDO<a name='1813'>
<a name='1814'>
      RETURN<a name='1815'>
<a name='1816'>
   END SUBROUTINE rhofil<a name='1817'>
<a name='1818'>
<a name='1819'>
<A NAME='RHOCOF'><A href='../../html_code/share/dfi.F.html#RHOCOF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1820'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rhocof</font>(nord, nomax, muc, ca, cb) <A href='../../call_to/RHOCOF.html' TARGET='index'>2</A>,<A href='../../call_from/RHOCOF.html' TARGET='index'>1</A><a name='1821'>
<a name='1822'>
<font color=#447700>!     Get the coefficients of the RHO Filter <a name='1823'></font>
<a name='1824'>
<font color=#447700>!      IMPLICIT DOUBLE PRECISION (A-H,O-Z)<a name='1825'></font>
      IMPLICIT NONE <a name='1826'>
<a name='1827'>
      <font color=#447700>! Arguments<a name='1828'></font>
      integer, intent(in)      :: nord, nomax<a name='1829'>
      real, dimension(0:nomax) :: ca, cb<a name='1830'>
<a name='1831'>
      <font color=#447700>! Functions<a name='1832'></font>
      double precision, external :: cnr<a name='1833'>
<a name='1834'>
      <font color=#447700>! Local variables<a name='1835'></font>
      INTEGER                  :: nn<a name='1836'>
      COMPLEX                  :: IOTA<a name='1837'>
      DOUBLE PRECISION         :: MUC, ZN<a name='1838'>
      DOUBLE PRECISION         :: pi, root2, rn, sigma, gain, sumcof<a name='1839'>
<a name='1840'>
      PI = 2*ASIN(1.)<a name='1841'>
      ROOT2 = SQRT(2.)<a name='1842'>
      IOTA = (0.,1.)<a name='1843'>
<a name='1844'>
      RN = 1./FLOAT(NORD)<a name='1845'>
      SIGMA = 1./( SQRT(2.**RN-1.) )<a name='1846'>
<a name='1847'>
      GAIN  = (MUC*SIGMA/(1+MUC*SIGMA))**NORD<a name='1848'>
      ZN = (1-MUC*SIGMA)/(1+MUC*SIGMA)<a name='1849'>
<a name='1850'>
      DO NN=0,NORD<a name='1851'>
        CA(NN) = <A href='../../html_code/share/dfi.F.html#CNR'>CNR</A><A href='../../html_code/share/dfi.F.html#RHOCOF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNR_1">(NORD,NN)*GAIN<a name='1852'>
        IF(NN.gt.0) CB(NN) = -CNR(NORD,NN)*(-ZN)**NN<a name='1853'>
      ENDDO<a name='1854'>
<a name='1855'>
<font color=#447700>!     Check sum of coefficients = 1<a name='1856'></font>
      SUMCOF = 0.<a name='1857'>
      DO NN=0,NORD<a name='1858'>
        SUMCOF = SUMCOF + CA(NN)<a name='1859'>
        IF(NN.gt.0) SUMCOF = SUMCOF + CB(NN)<a name='1860'>
      ENDDO<a name='1861'>
<a name='1862'>
      RETURN<a name='1863'>
<a name='1864'>
   END SUBROUTINE RHOCOF<a name='1865'>
<a name='1866'>
<a name='1867'>
<A NAME='CNR'><A href='../../html_code/share/dfi.F.html#CNR' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1868'>
   DOUBLE PRECISION <font color=#993300>FUNCTION </font><font color=#cc0000>cnr</font>(n,r) <A href='../../call_to/CNR.html' TARGET='index'>1</A><a name='1869'>
<a name='1870'>
   <font color=#447700>! Binomial Coefficient (n,r).<a name='1871'></font>
<a name='1872'>
<font color=#447700>!      IMPLICIT DOUBLE PRECISION(C,X)<a name='1873'></font>
      IMPLICIT NONE<a name='1874'>
<a name='1875'>
      <font color=#447700>! Arguments<a name='1876'></font>
      INTEGER , intent(in)    :: n, R<a name='1877'>
<a name='1878'>
      <font color=#447700>! Local variables<a name='1879'></font>
      INTEGER          :: k<a name='1880'>
      DOUBLE PRECISION :: coeff, xn, xr, xk<a name='1881'>
<a name='1882'>
      IF ( R.eq.0 ) THEN<a name='1883'>
         CNR = 1.0<a name='1884'>
         RETURN<a name='1885'>
      ENDIF<a name='1886'>
      Coeff = 1.0<a name='1887'>
      XN = DFLOAT(N)<a name='1888'>
      XR = DFLOAT(R)<a name='1889'>
      DO K=1,R<a name='1890'>
        XK = DFLOAT(K)<a name='1891'>
        COEFF = COEFF * ( (XN-XR+XK)/XK )<a name='1892'>
      ENDDO<a name='1893'>
      CNR = COEFF<a name='1894'>
<a name='1895'>
      RETURN<a name='1896'>
<a name='1897'>
   END FUNCTION cnr<a name='1898'>
<a name='1899'>
<a name='1900'>
<A NAME='OPTFIL'><A href='../../html_code/share/dfi.F.html#OPTFIL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1901'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>optfil</font> (grid,NH,DELTAT,NHMAX),<A href='../../call_from/OPTFIL.html' TARGET='index'>4</A><a name='1902'>
<font color=#447700>!----------------------------------------------------------------------<a name='1903'></font>
<a name='1904'>
<font color=#447700>!    SUBROUTINE optfil (NH,DELTAT,TAUP,TAUS,LPRINT,         &amp;<a name='1905'></font>
<font color=#447700>!                         H,NHMAX)<a name='1906'></font>
<font color=#447700>!<a name='1907'></font>
<font color=#447700>! - Huang and Lynch optimal filter<a name='1908'></font>
<font color=#447700>!   Monthly Weather Review, Feb 1993<a name='1909'></font>
<font color=#447700>!----------------------------------------------------------<a name='1910'></font>
<font color=#447700>!       Input Parameters in List:<a name='1911'></font>
<font color=#447700>!             NH     :  Half-length of the Filter<a name='1912'></font>
<font color=#447700>!             DELTAT :  Time-step (in seconds).      <a name='1913'></font>
<font color=#447700>!             TAUP   :  Period of pass-band edge (hours).<a name='1914'></font>
<font color=#447700>!             TAUS   :  Period of stop-band edge (hours).<a name='1915'></font>
<font color=#447700>!             LPRINT :  Logical switch for messages.<a name='1916'></font>
<font color=#447700>!             NHMAX  :  Maximum permitted Half-length.<a name='1917'></font>
<font color=#447700>!<a name='1918'></font>
<font color=#447700>!       Output Parameters in List:<a name='1919'></font>
<font color=#447700>!             H      :  Impulse Response.<a name='1920'></font>
<font color=#447700>!             DP     :  Deviation in pass-band (db)<a name='1921'></font>
<font color=#447700>!             DS     :  Deviation in stop-band (db)<a name='1922'></font>
<font color=#447700>!----------------------------------------------------------<a name='1923'></font>
<font color=#447700>!<a name='1924'></font>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#OPTFIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_279">, ONLY : domain<a name='1925'>
    <a name='1926'>
     TYPE(domain) , POINTER :: grid<a name='1927'>
<a name='1928'>
     REAL,DIMENSION( 20) :: EDGE<a name='1929'>
     REAL,DIMENSION( 10) :: FX, WTX, DEVIAT<a name='1930'>
     REAL,DIMENSION(2*NHMAX+1) :: H<a name='1931'>
     logical LPRINT<a name='1932'>
     REAL, INTENT (IN) :: DELTAT<a name='1933'>
     INTEGER, INTENT (IN) :: NH, NHMAX<a name='1934'>
<font color=#447700>!<a name='1935'></font>
         TAUP = 3.<a name='1936'>
         TAUS = 1.5<a name='1937'>
         LPRINT = .true.<a name='1938'>
<font color=#447700>!initialize H array<a name='1939'></font>
<a name='1940'>
         NL=2*NHMAX+1<a name='1941'>
        do 101 n=1,NL<a name='1942'>
          H(n)=0.<a name='1943'>
 101    continue<a name='1944'>
<a name='1945'>
        NFILT = 2*NH+1<a name='1946'>
        print *,' start optfil, NFILT=', nfilt<a name='1947'>
<a name='1948'>
<font color=#447700>!<a name='1949'></font>
<font color=#447700>! 930325 PL &amp; XYH : the upper limit is changed from 64 to 128.<a name='1950'></font>
        IF(NFILT.LE.0 .OR. NFILT.GT.128 ) THEN<a name='1951'>
	   WRITE(6,*) 'NH=',NH<a name='1952'>
       CALL wrf_error_fatal (' Sorry, error 1 in call to OPTFIL ')<a name='1953'>
	ENDIF<a name='1954'>
<font color=#447700>!<a name='1955'></font>
<font color=#447700>!       The following four should always be the same.<a name='1956'></font>
        JTYPE = 1<a name='1957'>
        NBANDS = 2<a name='1958'>
<font color=#447700>!CC     JPRINT = 0<a name='1959'></font>
        LGRID = 16<a name='1960'>
<font color=#447700>!<a name='1961'></font>
<font color=#447700>!       calculate transition frequencies.<a name='1962'></font>
	  DT = ABS(DELTAT)<a name='1963'>
          FS = DT/(TAUS*3600.)<a name='1964'>
          FP = DT/(TAUP*3600.)<a name='1965'>
          IF(FS.GT.0.5) then<a name='1966'>
<font color=#447700>!            print *,' FS too large in OPTFIL '<a name='1967'></font>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/dfi.F.html#OPTFIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1307"> (' FS too large in OPTFIL ')<a name='1968'>
<font color=#447700>!            return<a name='1969'></font>
          end if<a name='1970'>
          IF(FP.LT.0.0) then<a name='1971'>
<font color=#447700>!            print *, ' FP too small in OPTFIL '<a name='1972'></font>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/dfi.F.html#OPTFIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1308"> (' FP too small in OPTFIL ')<a name='1973'>
<font color=#447700>!            return<a name='1974'></font>
          end if<a name='1975'>
<font color=#447700>!<a name='1976'></font>
<font color=#447700>!       Relative Weights in pass- and stop-bands.<a name='1977'></font>
          WTP = 1.0<a name='1978'>
          WTS = 1.0<a name='1979'>
<font color=#447700>!<a name='1980'></font>
<font color=#447700>!CC     NOTE: (FP,FC,FS) is an arithmetic progression, so<a name='1981'></font>
<font color=#447700>!CC           (1/FS,1/FC,1/FP) is a harmonic one.<a name='1982'></font>
<font color=#447700>!CC           TAUP = 1/( (1/TAUC)-(1/DTAU) )<a name='1983'></font>
<font color=#447700>!CC           TAUS = 1/( (1/TAUC)+(1/DTAU) )<a name='1984'></font>
<font color=#447700>!CC           TAUC   :  Cut-off Period (hours).<a name='1985'></font>
<font color=#447700>!CC           DTAU   :  Transition half-width (hours).<a name='1986'></font>
<font color=#447700>!CC           FC = 1/TAUC  ;  DF = 1/DTAU<a name='1987'></font>
<font color=#447700>!CC           FP = FC - DF :  FS = FC + DF<a name='1988'></font>
<font color=#447700>!<a name='1989'></font>
          IF ( LPRINT ) THEN<a name='1990'>
               TAUC = 2./((1/TAUS)+(1/TAUP))<a name='1991'>
               DTAU = 2./((1/TAUS)-(1/TAUP))<a name='1992'>
               FC = DT/(TAUC*3600.)<a name='1993'>
               DF = DT/(DTAU*3600.)<a name='1994'>
               WRITE(6,*) ' DT ' , dt<a name='1995'>
               WRITE(6,*) ' TAUS, TAUP ' , TAUS,TAUP<a name='1996'>
               WRITE(6,*) ' TAUC, DTAU ' , TAUC,DTAU<a name='1997'>
               WRITE(6,*) '   FP,   FS ' ,   FP,  FS   <a name='1998'>
               WRITE(6,*) '   FC,   DF ' ,   FC,  DF<a name='1999'>
               WRITE(6,*) '  WTS,  WTP ' ,  WTS, WTP<a name='2000'>
          ENDIF<a name='2001'>
<font color=#447700>!<a name='2002'></font>
<font color=#447700>!       Fill the control vectors for MCCPAR<a name='2003'></font>
        EDGE(1) = 0.0<a name='2004'>
        EDGE(2) = FP<a name='2005'>
        EDGE(3) = FS<a name='2006'>
        EDGE(4) = 0.5<a name='2007'>
        FX(1) = 1.0<a name='2008'>
        FX(2) = 0.0<a name='2009'>
        WTX(1) = WTP<a name='2010'>
        WTX(2) = WTS<a name='2011'>
<a name='2012'>
        CALL <A href='../../html_code/share/dfi.F.html#MCCPAR'>MCCPAR</A><A href='../../html_code/share/dfi.F.html#OPTFIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MCCPAR_1">(NFILT,JTYPE,NBANDS,LPRINT,LGRID,       &amp;<a name='2013'>
                   EDGE,FX,WTX,DEVIAT, h )<a name='2014'>
<font color=#447700>!<a name='2015'></font>
<font color=#447700>!       Save the deviations in the pass- and stop-bands.<a name='2016'></font>
        DP = DEVIAT(1)<a name='2017'>
        DS = DEVIAT(2)<a name='2018'>
<font color=#447700>!<a name='2019'></font>
<font color=#447700>!     Fill out the array H (only first half filled in MCCPAR).<a name='2020'></font>
      IF(MOD(NFILT,2).EQ.0) THEN<a name='2021'>
         NHALF = ( NFILT )/2<a name='2022'>
      ELSE<a name='2023'>
         NHALF = (NFILT+1)/2<a name='2024'>
      ENDIF<a name='2025'>
      DO 100 nn=1,NHALF<a name='2026'>
         H(NFILT+1-nn) = h(nn)<a name='2027'>
  100 CONTINUE<a name='2028'>
<a name='2029'>
<font color=#447700>!       normalize the sums to be unity<a name='2030'></font>
        sumh = 0 <a name='2031'>
        do 150 n=1,NFILT<a name='2032'>
          sumh = sumh + H(n)<a name='2033'>
  150   continue<a name='2034'>
  print *,'SUMH =', sumh<a name='2035'>
<a name='2036'>
        do 200 n=1,NFILT <a name='2037'>
          H(n)  = H(n)/sumh<a name='2038'>
  200   continue<a name='2039'>
        do 201 n=1,NFILT<a name='2040'>
        grid%hcoeff(n)=H(n)<a name='2041'>
  201   continue<a name='2042'>
<font color=#447700>!       print *,'HCOEFF(n) ', grid%hcoeff<a name='2043'></font>
<font color=#447700>! <a name='2044'></font>
   END SUBROUTINE optfil<a name='2045'>
<a name='2046'>
<a name='2047'>
<A NAME='MCCPAR'><A href='../../html_code/share/dfi.F.html#MCCPAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2048'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>MCCPAR</font> (NFILT,JTYPE,NBANDS,LPRINT,LGRID,    &amp; <A href='../../call_to/MCCPAR.html' TARGET='index'>1</A>,<A href='../../call_from/MCCPAR.html' TARGET='index'>7</A><a name='2049'>
                   EDGE,FX,WTX,DEVIAT,h )<a name='2050'>
<a name='2051'>
<font color=#447700>!      PROGRAM FOR THE DESIGN OF LINEAR PHASE FINITE IMPULSE<a name='2052'></font>
<font color=#447700>!      REPONSE (FIR) FILTERS USING THE REMEZ EXCHANGE ALGORITHM<a name='2053'></font>
<font color=#447700>!<a name='2054'></font>
<font color=#447700>!************************************************************<a name='2055'></font>
<font color=#447700>!*  Reference: McClellan, J.H., T.W. Parks and L.R.Rabiner, *<a name='2056'></font>
<font color=#447700>!*             1973:  A computer program for designing      *<a name='2057'></font>
<font color=#447700>!*             optimum FIR linear phase digital filters.    *<a name='2058'></font>
<font color=#447700>!*             IEEE Trans. on Audio and Electroacoustics,   *<a name='2059'></font>
<font color=#447700>!*             Vol AU-21, No. 6, 506-526.                   *<a name='2060'></font>
<font color=#447700>!************************************************************<a name='2061'></font>
<font color=#447700>!<a name='2062'></font>
<font color=#447700>!      THREE TYPES OF FILTERS ARE INCLUDED -- BANDPASS FILTERS<a name='2063'></font>
<font color=#447700>!      DIFFERENTIATORS, AND HILBERT TRANSFORM FILTERS<a name='2064'></font>
<font color=#447700>!<a name='2065'></font>
<font color=#447700>!---------------------------------------------------------------<a name='2066'></font>
<font color=#447700>!<a name='2067'></font>
<font color=#447700>!      COMMON /x3x/ PI2,AD,DEV,X,Y,GRID,DES,WT,ALPHA,IEXT,NFCNS,NGRID<a name='2068'></font>
      DIMENSION IEXT(66),AD(66),ALPHA(66),X(66),Y(66)<a name='2069'>
      DIMENSION H(66)<a name='2070'>
      DIMENSION DES(1045),GRID(1045),WT(1045)<a name='2071'>
      DIMENSION EDGE(20),FX(10),WTX(10),DEVIAT(10)<a name='2072'>
      DOUBLE PRECISION PI2,PI<a name='2073'>
      DOUBLE PRECISION AD,DEV,X,Y<a name='2074'>
      LOGICAL LPRINT<a name='2075'>
      <a name='2076'>
      PI  = 3.141592653589793<a name='2077'>
      PI2 = 6.283185307179586<a name='2078'>
<a name='2079'>
<font color=#447700>!      ......<a name='2080'></font>
<a name='2081'>
      NFMAX = 128<a name='2082'>
100      CONTINUE<a name='2083'>
<a name='2084'>
<font color=#447700>!      PROGRAM INPUT SECTION<a name='2085'></font>
<a name='2086'>
<font color=#447700>!CC     READ(5,*) NFILT,JTYPE,NBANDS,JPRINT,LGRID<a name='2087'></font>
<a name='2088'>
      IF(NFILT.GT.NFMAX.OR.NFILT.LT.3) THEN<a name='2089'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/dfi.F.html#MCCPAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1309"> (' **** ERROR IN INPUT DATA ****' )<a name='2090'>
      END IF<a name='2091'>
      IF(NBANDS.LE.0) NBANDS = 1<a name='2092'>
<a name='2093'>
<font color=#447700>!      ....<a name='2094'></font>
<a name='2095'>
      IF(LGRID.LE.0) LGRID = 16<a name='2096'>
      JB = 2*NBANDS<a name='2097'>
<font color=#447700>!cc       READ(5,*) (EDGE(J),J=1,JB)<a name='2098'></font>
<font color=#447700>!cc       READ(5,*) (FX(J),J=1,NBANDS)<a name='2099'></font>
<font color=#447700>!cc       READ(5,*) (WTX(J),J=1,NBANDS)<a name='2100'></font>
      IF(JTYPE.EQ.0) THEN<a name='2101'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/dfi.F.html#MCCPAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1310"> (' **** ERROR IN INPUT DATA ****' )<a name='2102'>
      END IF<a name='2103'>
      NEG = 1<a name='2104'>
      IF(JTYPE.EQ.1) NEG = 0<a name='2105'>
      NODD = NFILT/2<a name='2106'>
      NODD = NFILT-2*NODD<a name='2107'>
      NFCNS = NFILT/2<a name='2108'>
      IF(NODD.EQ.1.AND.NEG.EQ.0) NFCNS = NFCNS+1<a name='2109'>
<a name='2110'>
<font color=#447700>!      ...<a name='2111'></font>
<a name='2112'>
      GRID(1) = EDGE(1)<a name='2113'>
      DELF = LGRID*NFCNS<a name='2114'>
      DELF = 0.5/DELF<a name='2115'>
      IF(NEG.EQ.0) GOTO 135<a name='2116'>
      IF(EDGE(1).LT.DELF) GRID(1) = DELF<a name='2117'>
135      CONTINUE<a name='2118'>
      J = 1<a name='2119'>
      L = 1<a name='2120'>
      LBAND = 1<a name='2121'>
140      FUP = EDGE(L+1)<a name='2122'>
145      TEMP = GRID(J)<a name='2123'>
<a name='2124'>
<font color=#447700>!      ....<a name='2125'></font>
<a name='2126'>
      DES(J) = <A href='../../html_code/share/dfi.F.html#EFF'>EFF</A><A href='../../html_code/share/dfi.F.html#MCCPAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFF_1">(TEMP,FX,WTX,LBAND,JTYPE)<a name='2127'>
      WT(J) = <A href='../../html_code/share/dfi.F.html#WATE'>WATE</A><A href='../../html_code/share/dfi.F.html#MCCPAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WATE_1">(TEMP,FX,WTX,LBAND,JTYPE)<a name='2128'>
      J = J+1<a name='2129'>
      GRID(J) = TEMP+DELF<a name='2130'>
      IF(GRID(J).GT.FUP) GOTO 150<a name='2131'>
      GOTO 145<a name='2132'>
150      GRID(J-1) = FUP<a name='2133'>
      DES(J-1) = <A href='../../html_code/share/dfi.F.html#EFF'>EFF</A><A href='../../html_code/share/dfi.F.html#MCCPAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EFF_2">(FUP,FX,WTX,LBAND,JTYPE)<a name='2134'>
      WT(J-1) = <A href='../../html_code/share/dfi.F.html#WATE'>WATE</A><A href='../../html_code/share/dfi.F.html#MCCPAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WATE_2">(FUP,FX,WTX,LBAND,JTYPE)<a name='2135'>
      LBAND = LBAND+1<a name='2136'>
      L = L+2<a name='2137'>
      IF(LBAND.GT.NBANDS) GOTO 160<a name='2138'>
      GRID(J) = EDGE(L)<a name='2139'>
      GOTO 140<a name='2140'>
160      NGRID = J-1<a name='2141'>
      IF(NEG.NE.NODD) GOTO 165<a name='2142'>
      IF(GRID(NGRID).GT.(0.5-DELF)) NGRID = NGRID-1<a name='2143'>
165      CONTINUE<a name='2144'>
<a name='2145'>
<font color=#447700>!      ......<a name='2146'></font>
<a name='2147'>
      IF(NEG) 170,170,180<a name='2148'>
170      IF(NODD.EQ.1) GOTO 200<a name='2149'>
      DO 175 J=1,NGRID<a name='2150'>
            CHANGE = DCOS(PI*GRID(J))<a name='2151'>
            DES(J) = DES(J)/CHANGE<a name='2152'>
            WT(J) = WT(J)*CHANGE<a name='2153'>
175      CONTINUE<a name='2154'>
      GOTO 200<a name='2155'>
180      IF(NODD.EQ.1) GOTO 190<a name='2156'>
      DO 185 J = 1,NGRID<a name='2157'>
            CHANGE = DSIN(PI*GRID(J))<a name='2158'>
            DES(J) = DES(J)/CHANGE<a name='2159'>
            WT(J)  = WT(J)*CHANGE<a name='2160'>
185      CONTINUE<a name='2161'>
      GOTO 200<a name='2162'>
190      DO 195 J =1,NGRID<a name='2163'>
            CHANGE = DSIN(PI2*GRID(J))<a name='2164'>
            DES(J) = DES(J)/CHANGE<a name='2165'>
            WT(J)  = WT(J)*CHANGE<a name='2166'>
195      CONTINUE<a name='2167'>
<a name='2168'>
<font color=#447700>!      ......<a name='2169'></font>
<a name='2170'>
200      TEMP = FLOAT(NGRID-1)/FLOAT(NFCNS)<a name='2171'>
      DO 210 J = 1,NFCNS<a name='2172'>
            IEXT(J) = (J-1)*TEMP+1<a name='2173'>
210      CONTINUE<a name='2174'>
      IEXT(NFCNS+1) = NGRID<a name='2175'>
      NM1 = NFCNS-1<a name='2176'>
      NZ  = NFCNS+1<a name='2177'>
<a name='2178'>
<font color=#447700>! CALL THE REMEZ EXCHANGE ALGORITHM TO DO THE APPROXIMATION PROBLEM<a name='2179'></font>
<a name='2180'>
      CALL <A href='../../html_code/share/dfi.F.html#REMEZ'>REMEZ</A><A href='../../html_code/share/dfi.F.html#MCCPAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REMEZ_1">(EDGE,NBANDS,PI2,AD,DEV,X,Y,GRID,DES,WT,ALPHA,IEXT,NFCNS,NGRID)<a name='2181'>
<a name='2182'>
<font color=#447700>! CALCULATE THE IMPULSE RESPONSE<a name='2183'></font>
<a name='2184'>
      IF(NEG) 300,300,320<a name='2185'>
300      IF(NODD.EQ.0) GOTO 310<a name='2186'>
      DO 305 J=1,NM1<a name='2187'>
            H(J) = 0.5*ALPHA(NZ-J)<a name='2188'>
305      CONTINUE<a name='2189'>
      H(NFCNS)=ALPHA(1)<a name='2190'>
      GOTO 350<a name='2191'>
310      H(1) = 0.25*ALPHA(NFCNS)<a name='2192'>
      DO 315 J = 2,NM1<a name='2193'>
            H(J) = 0.25*(ALPHA(NZ-J)+ALPHA(NFCNS+2-J))<a name='2194'>
315      CONTINUE<a name='2195'>
      H(NFCNS) = 0.5*ALPHA(1)+0.25*ALPHA(2)<a name='2196'>
      GOTO 350<a name='2197'>
320      IF(NODD.EQ.0) GOTO 330<a name='2198'>
      H(1) = 0.25*ALPHA(NFCNS)<a name='2199'>
      H(2) = 0.25*ALPHA(NM1)<a name='2200'>
      DO 325 J = 3,NM1<a name='2201'>
            H(J) = 0.25*(ALPHA(NZ-J)-ALPHA(NFCNS+3-J))<a name='2202'>
325      CONTINUE<a name='2203'>
      H(NFCNS) = 0.5*ALPHA(1)-0.25*ALPHA(3)<a name='2204'>
      H(NZ) = 0.0<a name='2205'>
      GOTO 350<a name='2206'>
330      H(1) = 0.25*ALPHA(NFCNS)<a name='2207'>
      DO 335 J =2,NM1<a name='2208'>
            H(J) = 0.25*(ALPHA(NZ-J)-ALPHA(NFCNS+2-J))<a name='2209'>
335      CONTINUE<a name='2210'>
      H(NFCNS) = 0.5*ALPHA(1)-0.25*ALPHA(2)<a name='2211'>
<a name='2212'>
<font color=#447700>!   PROGRAM OUTPUT SECTION<a name='2213'></font>
<a name='2214'>
350   CONTINUE<a name='2215'>
<font color=#447700>!<a name='2216'></font>
      IF(LPRINT) THEN<a name='2217'>
<a name='2218'>
         print *, '****************************************************'<a name='2219'>
         print *, 'FINITE IMPULSE RESPONSE (FIR)'<a name='2220'>
         print *, 'LINEAR PHASE DIGITAL FILTER DESIGN'<a name='2221'>
         print *, 'REMEZ EXCHANGE ALGORITHM'<a name='2222'>
      <a name='2223'>
      IF(JTYPE.EQ.1) WRITE(6,365)<a name='2224'>
365      FORMAT(25X,'BANDPASS FILTER'/)<a name='2225'>
<a name='2226'>
      IF(JTYPE.EQ.2) WRITE(6,370)<a name='2227'>
370      FORMAT(25X,'DIFFERENTIATOR '/)<a name='2228'>
<a name='2229'>
      IF(JTYPE.EQ.3) WRITE(6,375)<a name='2230'>
375      FORMAT(25X,'HILBERT TRANSFORMER '/)<a name='2231'>
<a name='2232'>
      WRITE(6,378) NFILT<a name='2233'>
378      FORMAT(15X,'FILTER LENGTH =',I3/)<a name='2234'>
<a name='2235'>
      WRITE(6,380)<a name='2236'>
380      FORMAT(15X,'***** IMPULSE RESPONSE *****')<a name='2237'>
<a name='2238'>
      DO 381 J = 1,NFCNS<a name='2239'>
            K = NFILT+1-J<a name='2240'>
            IF(NEG.EQ.0) WRITE(6,382) J,H(J),K<a name='2241'>
            IF(NEG.EQ.1) WRITE(6,383) J,H(J),K<a name='2242'>
381      CONTINUE<a name='2243'>
382      FORMAT(20X,'H(',I3,') = ',E15.8,' = H(',I4,')')<a name='2244'>
383      FORMAT(20X,'H(',I3,') = ',E15.8,' = -H(',I4,')')<a name='2245'>
<a name='2246'>
      IF(NEG.EQ.1.AND.NODD.EQ.1) WRITE(6,384) NZ<a name='2247'>
384      FORMAT(20X,'H(',I3,') = 0.0')<a name='2248'>
<a name='2249'>
      DO 450 K=1,NBANDS,4<a name='2250'>
            KUP = K+3<a name='2251'>
            IF(KUP.GT.NBANDS) KUP = NBANDS<a name='2252'>
	    print *<a name='2253'>
            WRITE(6,385) (J,J=K,KUP)<a name='2254'>
385            FORMAT(24X,4('BAND',I3,8X))<a name='2255'>
            WRITE(6,390) (EDGE(2*J-1),J=K,KUP)<a name='2256'>
390            FORMAT(2X,'LOWER BAND EDGE',5F15.8)<a name='2257'>
            WRITE(6,395) (EDGE(2*J),J=K,KUP)<a name='2258'>
395            FORMAT(2X,'UPPER BAND EDGE',5F15.8)<a name='2259'>
            IF(JTYPE.NE.2) WRITE(6,400) (FX(J),J=K,KUP)<a name='2260'>
400            FORMAT(2X,'DESIRED VALUE',2X,5F15.8)<a name='2261'>
            IF(JTYPE.EQ.2) WRITE(6,405) (FX(J),J=K,KUP)<a name='2262'>
405            FORMAT(2X,'DESIRED SLOPE',2X,5F15.8)<a name='2263'>
            WRITE(6,410) (WTX(J),J=K,KUP)<a name='2264'>
410            FORMAT(2X,'WEIGHTING',6X,5F15.8)<a name='2265'>
            DO 420 J = K,KUP<a name='2266'>
                  DEVIAT(J) = DEV/WTX(J)<a name='2267'>
420            CONTINUE<a name='2268'>
            WRITE(6,425) (DEVIAT(J),J=K,KUP)<a name='2269'>
425            FORMAT(2X,'DEVIATION',6X,5F15.8)<a name='2270'>
            IF(JTYPE.NE.1) GOTO 450<a name='2271'>
            DO 430 J = K,KUP<a name='2272'>
                  DEVIAT(J) = 20.0*ALOG10(DEVIAT(J))<a name='2273'>
430            CONTINUE<a name='2274'>
            WRITE(6,435) (DEVIAT(J),J=K,KUP)<a name='2275'>
435            FORMAT(2X,'DEVIATION IN DB',5F15.8)<a name='2276'>
450      CONTINUE<a name='2277'>
      print *, 'EXTREMAL FREQUENCIES'<a name='2278'>
      WRITE(6,455) (GRID(IEXT(J)),J=1,NZ)<a name='2279'>
455      FORMAT((2X,5F15.7))<a name='2280'>
      WRITE(6,460)<a name='2281'>
460      FORMAT(1X,70(1H*))<a name='2282'>
<font color=#447700>!<a name='2283'></font>
      ENDIF<a name='2284'>
<font color=#447700>!<a name='2285'></font>
<font color=#447700>!CC     IF(NFILT.NE.0) GOTO 100  ! removal of re-run loop.<a name='2286'></font>
<font color=#447700>!<a name='2287'></font>
   END SUBROUTINE mccpar<a name='2288'>
<a name='2289'>
<a name='2290'>
<A NAME='EFF'><A href='../../html_code/share/dfi.F.html#EFF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2291'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>EFF</font>(TEMP,FX,WTX,LBAND,JTYPE) <A href='../../call_to/EFF.html' TARGET='index'>2</A><a name='2292'>
         DIMENSION FX(5),WTX(5)<a name='2293'>
         IF(JTYPE.EQ.2) GOTO 1<a name='2294'>
         EFF = FX(LBAND)<a name='2295'>
         RETURN<a name='2296'>
1        EFF = FX(LBAND)*TEMP<a name='2297'>
      END FUNCTION eff<a name='2298'>
<a name='2299'>
<a name='2300'>
<A NAME='WATE'><A href='../../html_code/share/dfi.F.html#WATE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2301'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>WATE</font>(TEMP,FX,WTX,LBAND,JTYPE) <A href='../../call_to/WATE.html' TARGET='index'>2</A><a name='2302'>
         DIMENSION FX(5),WTX(5)<a name='2303'>
         IF(JTYPE.EQ.2) GOTO 1<a name='2304'>
         WATE = WTX(LBAND)<a name='2305'>
         RETURN<a name='2306'>
1        IF(FX(LBAND).LT.0.0001) GOTO 2<a name='2307'>
         WATE = WTX(LBAND)/TEMP<a name='2308'>
         RETURN<a name='2309'>
2        WATE = WTX(LBAND)<a name='2310'>
      END FUNCTION wate<a name='2311'>
<a name='2312'>
<a name='2313'>
<font color=#447700>!      SUBROUTINE ERROR<a name='2314'></font>
<font color=#447700>!!         WRITE(6,*)' **** ERROR IN INPUT DATA ****'<a name='2315'></font>
<font color=#447700>!          CALL wrf_error_fatal (' **** ERROR IN INPUT DATA ****' )<a name='2316'></font>
<font color=#447700>!      END SUBROUTINE error<a name='2317'></font>
<a name='2318'>
      <a name='2319'>
<A NAME='REMEZ'><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2320'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>REMEZ</font>(EDGE,NBANDS,PI2,AD,DEV,X,Y,GRID,DES,WT,ALPHA,IEXT,NFCNS,NGRID) <A href='../../call_to/REMEZ.html' TARGET='index'>1</A>,<A href='../../call_from/REMEZ.html' TARGET='index'>9</A><a name='2321'>
<font color=#447700>!  THIS SUBROUTINE IMPLEMENTS THE REMEZ EXCHANGE ALGORITHM <a name='2322'></font>
<font color=#447700>!  FOR THE WEIGHTED CHEBCHEV APPROXIMATION OF A CONTINUOUS <a name='2323'></font>
<font color=#447700>!  FUNCTION WITH A SUM OF COSINES. INPUTS TO THE SUBROUTINE <a name='2324'></font>
<font color=#447700>!  ARE A DENSE GRID WHICH REPLACES THE FREQUENCY AXIS, THE<a name='2325'></font>
<font color=#447700>!  DESIRED FUNCTION ON THIS GRID, THE WEIGHT FUNCTION ON THE<a name='2326'></font>
<font color=#447700>!  GRID, THE NUMBER OF COSINES, AND THE INITIAL GUESS OF THE<a name='2327'></font>
<font color=#447700>!  EXTREMAL FREQUENCIES. THE PROGRAM MINIMIZES THE CHEBYSHEV <a name='2328'></font>
<font color=#447700>!  ERROR BY DETERMINING THE BEST LOCATION OF THE EXTREMAL<a name='2329'></font>
<font color=#447700>!  FREQUENCIES (POINTS OF MAXIMUM ERROR) AND THEN CALCULATES<a name='2330'></font>
<font color=#447700>!  THE COEFFICIENTS OF THE BEST APPROXIMATION.<a name='2331'></font>
<font color=#447700>!<a name='2332'></font>
<font color=#447700>!      COMMON /x3x/ PI2,AD,DEV,X,Y,GRID,DES,WT,ALPHA,IEXT,NFCNS,NGRID<a name='2333'></font>
      DIMENSION EDGE(20)<a name='2334'>
      DIMENSION IEXT(66),AD(66),ALPHA(66),X(66),Y(66)<a name='2335'>
      DIMENSION DES(1045),GRID(1045),WT(1045)<a name='2336'>
      DIMENSION A(66),P(65),Q(65)<a name='2337'>
      DOUBLE PRECISION PI2,DNUM,DDEN,DTEMP,A,P,Q<a name='2338'>
      DOUBLE PRECISION AD,DEV,X,Y<a name='2339'>
      DOUBLE PRECISION, EXTERNAL :: D, GEE<a name='2340'>
<font color=#447700>!<a name='2341'></font>
<font color=#447700>!  THE PROGRAM ALLOWS A MAXIMUM NUMBER OF ITERATIONS OF 25<a name='2342'></font>
<font color=#447700>!<a name='2343'></font>
      ITRMAX=25<a name='2344'>
      DEVL=-1.0<a name='2345'>
      NZ=NFCNS+1<a name='2346'>
      NZZ=NFCNS+2<a name='2347'>
      NITER=0<a name='2348'>
  100 CONTINUE<a name='2349'>
      IEXT(NZZ)=NGRID+1<a name='2350'>
      NITER=NITER+1<a name='2351'>
      IF(NITER.GT.ITRMAX) GO TO 400<a name='2352'>
      DO 110 J=1,NZ<a name='2353'>
      DTEMP=GRID(IEXT(J))<a name='2354'>
      DTEMP=DCOS(DTEMP*PI2)<a name='2355'>
  110 X(J)=DTEMP<a name='2356'>
      JET=(NFCNS-1)/15+1<a name='2357'>
      DO 120 J=1,NZ<a name='2358'>
  120 AD(J)=<A href='../../html_code/share/dfi.F.html#D'>D</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="D_23">(J,NZ,JET,X)<a name='2359'>
      DNUM=0.0<a name='2360'>
      DDEN=0.0<a name='2361'>
      K=1<a name='2362'>
      DO 130 J=1,NZ<a name='2363'>
      L=IEXT(J)<a name='2364'>
      DTEMP=AD(J)*DES(L)<a name='2365'>
      DNUM=DNUM+DTEMP<a name='2366'>
      DTEMP=K*AD(J)/WT(L)<a name='2367'>
      DDEN=DDEN+DTEMP<a name='2368'>
  130 K=-K<a name='2369'>
      DEV=DNUM/DDEN<a name='2370'>
      NU=1<a name='2371'>
      IF(DEV.GT.0.0) NU=-1<a name='2372'>
      DEV=-NU*DEV<a name='2373'>
      K=NU<a name='2374'>
      DO 140 J=1,NZ<a name='2375'>
      L=IEXT(J)<a name='2376'>
      DTEMP=K*DEV/WT(L)<a name='2377'>
      Y(J)=DES(L)+DTEMP<a name='2378'>
  140 K=-K<a name='2379'>
      IF(DEV.GE.DEVL) GO TO 150<a name='2380'>
      WRITE(6,*) ' ******** FAILURE TO CONVERGE *********** '<a name='2381'>
      WRITE(6,*) ' PROBABLE CAUSE IS MACHINE ROUNDING ERROR '<a name='2382'>
      WRITE(6,*) ' THE IMPULSE RESPONSE MAY BE CORRECT '<a name='2383'>
      WRITE(6,*) ' CHECK WITH A FREQUENCY RESPONSE '<a name='2384'>
      WRITE(6,*) ' **************************************** '<a name='2385'>
      GO TO 400<a name='2386'>
  150 DEVL=DEV<a name='2387'>
      JCHNGE=0<a name='2388'>
      K1=IEXT(1)<a name='2389'>
      KNZ=IEXT(NZ)<a name='2390'>
      KLOW=0<a name='2391'>
      NUT=-NU<a name='2392'>
      J=1<a name='2393'>
<font color=#447700>!<a name='2394'></font>
<font color=#447700>!  SEARCH FOR THE EXTERMAL FREQUENCIES OF THE BEST<a name='2395'></font>
<font color=#447700>!  APPROXIMATION.<a name='2396'></font>
<a name='2397'>
  200 IF(J.EQ.NZZ) YNZ=COMP<a name='2398'>
      IF(J.GE.NZZ) GO TO 300<a name='2399'>
      KUP=IEXT(J+1)<a name='2400'>
      L=IEXT(J)+1<a name='2401'>
      NUT=-NUT<a name='2402'>
      IF(J.EQ.2) Y1=COMP<a name='2403'>
      COMP=DEV<a name='2404'>
      IF(L.GE.KUP) GO TO 220<a name='2405'>
      ERR=<A href='../../html_code/share/dfi.F.html#GEE'>GEE</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEE_1">(L,NZ,GRID,PI2,X,Y,AD)<a name='2406'>
      ERR=(ERR-DES(L))*WT(L)<a name='2407'>
      DTEMP=NUT*ERR-COMP<a name='2408'>
      IF(DTEMP.LE.0.0) GO TO 220<a name='2409'>
      COMP=NUT*ERR<a name='2410'>
  210 L=L+1<a name='2411'>
      IF(L.GE.KUP) GO TO 215<a name='2412'>
      ERR=<A href='../../html_code/share/dfi.F.html#GEE'>GEE</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEE_2">(L,NZ,GRID,PI2,X,Y,AD)<a name='2413'>
      ERR=(ERR-DES(L))*WT(L)<a name='2414'>
      DTEMP=NUT*ERR-COMP<a name='2415'>
      IF(DTEMP.LE.0.0) GO TO 215<a name='2416'>
      COMP=NUT*ERR<a name='2417'>
      GO TO 210<a name='2418'>
  215 IEXT(J)=L-1<a name='2419'>
      J=J+1<a name='2420'>
      KLOW=L-1<a name='2421'>
      JCHNGE=JCHNGE+1<a name='2422'>
      GO TO 200<a name='2423'>
  220 L=L-1<a name='2424'>
  225 L=L-1<a name='2425'>
      IF(L.LE.KLOW) GO TO 250<a name='2426'>
      ERR=<A href='../../html_code/share/dfi.F.html#GEE'>GEE</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEE_3">(L,NZ,GRID,PI2,X,Y,AD)<a name='2427'>
      ERR=(ERR-DES(L))*WT(L)<a name='2428'>
      DTEMP=NUT*ERR-COMP<a name='2429'>
      IF(DTEMP.GT.0.0) GO TO 230<a name='2430'>
      IF(JCHNGE.LE.0) GO TO 225<a name='2431'>
      GO TO 260<a name='2432'>
  230 COMP=NUT*ERR<a name='2433'>
  235 L=L-1<a name='2434'>
      IF(L.LE.KLOW) GO TO 240<a name='2435'>
      ERR=<A href='../../html_code/share/dfi.F.html#GEE'>GEE</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEE_4">(L,NZ,GRID,PI2,X,Y,AD)<a name='2436'>
      ERR=(ERR-DES(L))*WT(L)<a name='2437'>
      DTEMP=NUT*ERR-COMP<a name='2438'>
      IF(DTEMP.LE.0.0) GO TO 240<a name='2439'>
      COMP=NUT*ERR<a name='2440'>
      GO TO 235<a name='2441'>
  240 KLOW=IEXT(J)<a name='2442'>
      IEXT(J)=L+1<a name='2443'>
      J=J+1<a name='2444'>
      JCHNGE=JCHNGE+1<a name='2445'>
      GO TO 200<a name='2446'>
  250 L=IEXT(J)+1<a name='2447'>
      IF(JCHNGE.GT.0) GO TO 215<a name='2448'>
  255 L=L+1<a name='2449'>
      IF(L.GE.KUP) GO TO 260<a name='2450'>
      ERR=<A href='../../html_code/share/dfi.F.html#GEE'>GEE</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEE_5">(L,NZ,GRID,PI2,X,Y,AD)<a name='2451'>
      ERR=(ERR-DES(L))*WT(L)<a name='2452'>
      DTEMP=NUT*ERR-COMP<a name='2453'>
      IF(DTEMP.LE.0.0) GO TO 255<a name='2454'>
      COMP=NUT*ERR<a name='2455'>
      GO TO 210<a name='2456'>
  260 KLOW=IEXT(J)<a name='2457'>
      J=J+1<a name='2458'>
      GO TO 200<a name='2459'>
  300 IF(J.GT.NZZ) GO TO 320<a name='2460'>
      IF(K1.GT.IEXT(1)) K1=IEXT(1)<a name='2461'>
      IF(KNZ.LT.IEXT(NZ)) KNZ=IEXT(NZ)<a name='2462'>
      NUT1=NUT<a name='2463'>
      NUT=-NU<a name='2464'>
      L=0<a name='2465'>
      KUP=K1<a name='2466'>
      COMP=YNZ*(1.00001)<a name='2467'>
      LUCK=1<a name='2468'>
  310 L=L+1<a name='2469'>
      IF(L.GE.KUP) GO TO 315<a name='2470'>
      ERR=<A href='../../html_code/share/dfi.F.html#GEE'>GEE</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEE_6">(L,NZ,GRID,PI2,X,Y,AD)<a name='2471'>
      ERR=(ERR-DES(L))*WT(L)<a name='2472'>
      DTEMP=NUT*ERR-COMP<a name='2473'>
      IF(DTEMP.LE.0.0) GO TO 310<a name='2474'>
      COMP=NUT*ERR<a name='2475'>
      J=NZZ<a name='2476'>
      GO TO 210<a name='2477'>
  315 LUCK=6<a name='2478'>
      GO TO 325<a name='2479'>
  320 IF(LUCK.GT.9) GO TO 350<a name='2480'>
      IF(COMP.GT.Y1) Y1=COMP<a name='2481'>
      K1=IEXT(NZZ)<a name='2482'>
  325 L=NGRID+1<a name='2483'>
      KLOW=KNZ<a name='2484'>
      NUT=-NUT1<a name='2485'>
      COMP=Y1*(1.00001)<a name='2486'>
  330 L=L-1<a name='2487'>
      IF(L.LE.KLOW) GO TO 340<a name='2488'>
      ERR=<A href='../../html_code/share/dfi.F.html#GEE'>GEE</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEE_7">(L,NZ,GRID,PI2,X,Y,AD)<a name='2489'>
      ERR=(ERR-DES(L))*WT(L)<a name='2490'>
      DTEMP=NUT*ERR-COMP<a name='2491'>
      IF(DTEMP.LE.0.0) GO TO 330<a name='2492'>
      J=NZZ<a name='2493'>
      COMP=NUT*ERR<a name='2494'>
      LUCK=LUCK+10<a name='2495'>
      GO TO 235<a name='2496'>
  340 IF(LUCK.EQ.6) GO TO 370<a name='2497'>
      DO 345 J=1,NFCNS<a name='2498'>
  345 IEXT(NZZ-J)=IEXT(NZ-J)<a name='2499'>
      IEXT(1)=K1<a name='2500'>
      GO TO 100<a name='2501'>
  350 KN=IEXT(NZZ)<a name='2502'>
      DO 360 J=1,NFCNS<a name='2503'>
  360 IEXT(J)=IEXT(J+1)<a name='2504'>
      IEXT(NZ)=KN<a name='2505'>
      GO TO 100<a name='2506'>
  370 IF(JCHNGE.GT.0) GO TO 100<a name='2507'>
<font color=#447700>!<a name='2508'></font>
<font color=#447700>!  CALCULATION OF THE COEFFICIENTS OF THE BEST APPROXIMATION<a name='2509'></font>
<font color=#447700>!  USING THE INVERSE DISCRETE FOURIER TRANSFORM.<a name='2510'></font>
<font color=#447700>!      <a name='2511'></font>
  400 CONTINUE<a name='2512'>
      NM1=NFCNS-1<a name='2513'>
      FSH=1.0E-06<a name='2514'>
      GTEMP=GRID(1)<a name='2515'>
      X(NZZ)=-2.0<a name='2516'>
      CN=2*NFCNS-1<a name='2517'>
      DELF=1.0/CN<a name='2518'>
      L=1<a name='2519'>
      KKK=0<a name='2520'>
      IF(EDGE(1).EQ.0.0.AND.EDGE(2*NBANDS).EQ.0.5) KKK=1<a name='2521'>
      IF(NFCNS.LE.3) KKK=1<a name='2522'>
      IF(KKK.EQ.1) GO TO 405<a name='2523'>
      DTEMP=DCOS(PI2*GRID(1))<a name='2524'>
      DNUM=DCOS(PI2*GRID(NGRID))<a name='2525'>
      AA=2.0/(DTEMP-DNUM)<a name='2526'>
      BB=-(DTEMP+DNUM)/(DTEMP-DNUM)<a name='2527'>
  405 CONTINUE<a name='2528'>
      DO 430 J=1,NFCNS<a name='2529'>
      FT=(J-1)*DELF<a name='2530'>
      XT=DCOS(PI2*FT)<a name='2531'>
      IF(KKK.EQ.1) GO TO 410<a name='2532'>
      XT=(XT-BB)/AA<a name='2533'>
<font color=#447700>! original :      FT=ARCOS(XT)/PI2<a name='2534'></font>
      FT=ACOS(XT)/PI2<a name='2535'>
  410 XE=X(L)<a name='2536'>
      IF(XT.GT.XE) GO TO 420<a name='2537'>
      IF((XE-XT).LT.FSH) GO TO 415<a name='2538'>
      L=L+1<a name='2539'>
      GO TO 410<a name='2540'>
  415 A(J)=Y(L)<a name='2541'>
      GO TO 425<a name='2542'>
  420 IF((XT-XE).LT.FSH) GO TO 415<a name='2543'>
      GRID(1)=FT<a name='2544'>
      A(J)=<A href='../../html_code/share/dfi.F.html#GEE'>GEE</A><A href='../../html_code/share/dfi.F.html#REMEZ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GEE_8">(1,NZ,GRID,PI2,X,Y,AD)<a name='2545'>
  425 CONTINUE<a name='2546'>
      IF(L.GT.1) L=L-1<a name='2547'>
  430 CONTINUE<a name='2548'>
      GRID(1)=GTEMP<a name='2549'>
      DDEN=PI2/CN<a name='2550'>
      DO 510 J=1,NFCNS<a name='2551'>
      DTEMP=0.0<a name='2552'>
      DNUM=(J-1)*DDEN<a name='2553'>
      IF(NM1.LT.1) GO TO 505<a name='2554'>
      DO 500 K=1,NM1<a name='2555'>
  500 DTEMP=DTEMP+A(K+1)*DCOS(DNUM*K)<a name='2556'>
  505 DTEMP=2.0*DTEMP+A(1)<a name='2557'>
  510 ALPHA(J)=DTEMP<a name='2558'>
      DO 550 J=2,NFCNS<a name='2559'>
  550 ALPHA(J)=2*ALPHA(J)/CN<a name='2560'>
      ALPHA(1)=ALPHA(1)/CN<a name='2561'>
      IF(KKK.EQ.1) GO TO 545<a name='2562'>
      P(1)=2.0*ALPHA(NFCNS)*BB+ALPHA(NM1)<a name='2563'>
      P(2)=2.0*AA*ALPHA(NFCNS)<a name='2564'>
      Q(1)=ALPHA(NFCNS-2)-ALPHA(NFCNS)<a name='2565'>
      DO 540 J=2,NM1<a name='2566'>
      IF(J.LT.NM1) GO TO 515<a name='2567'>
      AA=0.5*AA<a name='2568'>
      BB=0.5*BB<a name='2569'>
  515 CONTINUE<a name='2570'>
      P(J+1)=0.0<a name='2571'>
      DO 520 K=1,J<a name='2572'>
      A(K)=P(K)<a name='2573'>
  520 P(K)=2.0*BB*A(K)<a name='2574'>
      P(2)=P(2)+A(1)*2.0*AA<a name='2575'>
      JM1=J-1<a name='2576'>
      DO 525 K=1,JM1<a name='2577'>
  525 P(K)=P(K)+Q(K)+AA*A(K+1)<a name='2578'>
      JP1=J+1<a name='2579'>
      DO 530 K=3,JP1<a name='2580'>
  530 P(K)=P(K)+AA*A(K-1)<a name='2581'>
      IF(J.EQ.NM1) GO TO 540<a name='2582'>
      DO 535 K=1,J<a name='2583'>
  535 Q(K)=-A(K)<a name='2584'>
      Q(1)=Q(1)+ALPHA(NFCNS-1-J)<a name='2585'>
  540 CONTINUE<a name='2586'>
      DO 543 J=1,NFCNS<a name='2587'>
  543 ALPHA(J)=P(J)<a name='2588'>
  545 CONTINUE<a name='2589'>
      IF(NFCNS.GT.3) RETURN<a name='2590'>
      ALPHA(NFCNS+1)=0.0<a name='2591'>
      ALPHA(NFCNS+2)=0.0<a name='2592'>
   END SUBROUTINE remez<a name='2593'>
<a name='2594'>
<A NAME='D'><A href='../../html_code/share/dfi.F.html#D' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2595'>
   DOUBLE PRECISION <font color=#993300>FUNCTION </font><font color=#cc0000>D</font>(K,N,M,X) <A href='../../call_to/D.html' TARGET='index'>27</A><a name='2596'>
<font color=#447700>!      COMMON /x3x/ PI2,AD,DEV,X,Y,GRID,DES,WT,ALPHA,IEXT,NFCNS,NGRID<a name='2597'></font>
      DIMENSION IEXT(66),AD(66),ALPHA(66),X(66),Y(66)<a name='2598'>
      DIMENSION DES(1045),GRID(1045),WT(1045)<a name='2599'>
      DOUBLE PRECISION AD,DEV,X,Y<a name='2600'>
      DOUBLE PRECISION Q<a name='2601'>
      DOUBLE PRECISION PI2<a name='2602'>
      D = 1.0<a name='2603'>
      Q = X(K)<a name='2604'>
      DO 3 L = 1,M<a name='2605'>
      DO 2 J = L,N,M<a name='2606'>
            IF(J-K) 1,2,1<a name='2607'>
1                  D = 2.0*D*(Q-X(J))<a name='2608'>
2      CONTINUE<a name='2609'>
3      CONTINUE<a name='2610'>
      D = 1.0/D<a name='2611'>
   END FUNCTION D<a name='2612'>
<a name='2613'>
<a name='2614'>
<A NAME='GEE'><A href='../../html_code/share/dfi.F.html#GEE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2615'>
   DOUBLE PRECISION <font color=#993300>FUNCTION </font><font color=#cc0000>GEE</font>(K,N,GRID,PI2,X,Y,AD) <A href='../../call_to/GEE.html' TARGET='index'>8</A><a name='2616'>
<font color=#447700>!      COMMON /x3x/ PI2,AD,DEV,X,Y,GRID,DES,WT,ALPHA,IEXT,NFCNS,NGRID<a name='2617'></font>
      DIMENSION IEXT(66),AD(66),ALPHA(66),X(66),Y(66)<a name='2618'>
      DIMENSION DES(1045),GRID(1045),WT(1045)<a name='2619'>
      DOUBLE PRECISION AD,DEV,X,Y<a name='2620'>
      DOUBLE PRECISION P,C,D,XF<a name='2621'>
      DOUBLE PRECISION PI2<a name='2622'>
      P = 0.0<a name='2623'>
      XF = GRID(K)<a name='2624'>
      XF = DCOS(PI2*XF)<a name='2625'>
      D = 0.0<a name='2626'>
      DO 1 J =1,N<a name='2627'>
            C = XF-X(J)<a name='2628'>
            C = AD(J)/C<a name='2629'>
            D = D+C<a name='2630'>
            P = P+C*Y(J)<a name='2631'>
1      CONTINUE<a name='2632'>
      GEE = P/D<a name='2633'>
   END FUNCTION GEE<a name='2634'>
<a name='2635'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2636'></font>
<font color=#447700>! THIS FUNCTION CALCULATES THE LIQUID SATURATION VAPOR MIXING RATIO AS<a name='2637'></font>
<font color=#447700>! A FUNCTION OF TEMPERATURE AND PRESSURE in Thompson microphysics<a name='2638'></font>
<font color=#447700>!<a name='2639'></font>
<a name='2640'>
<A NAME='RSLF'><A href='../../html_code/share/dfi.F.html#RSLF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2641'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>RSLF</font>(P,T) <A href='../../call_to/RSLF.html' TARGET='index'>9</A><a name='2642'>
<a name='2643'>
      IMPLICIT NONE<a name='2644'>
      REAL, INTENT(IN):: P, T<a name='2645'>
      REAL:: ESL,X<a name='2646'>
      REAL, PARAMETER:: C0= .611583699E03<a name='2647'>
      REAL, PARAMETER:: C1= .444606896E02<a name='2648'>
      REAL, PARAMETER:: C2= .143177157E01<a name='2649'>
      REAL, PARAMETER:: C3= .264224321E-1<a name='2650'>
      REAL, PARAMETER:: C4= .299291081E-3<a name='2651'>
      REAL, PARAMETER:: C5= .203154182E-5<a name='2652'>
      REAL, PARAMETER:: C6= .702620698E-8<a name='2653'>
      REAL, PARAMETER:: C7= .379534310E-11<a name='2654'>
      REAL, PARAMETER:: C8=-.321582393E-13<a name='2655'>
<a name='2656'>
      X=MAX(-80.,T-273.16)<a name='2657'>
<a name='2658'>
<font color=#447700>!      ESL=612.2*EXP(17.67*X/(T-29.65))<a name='2659'></font>
      ESL=C0+X*(C1+X*(C2+X*(C3+X*(C4+X*(C5+X*(C6+X*(C7+X*C8)))))))<a name='2660'>
      RSLF=.622*ESL/(P-ESL)<a name='2661'>
<a name='2662'>
      END FUNCTION RSLF<a name='2663'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2664'></font>
<font color=#447700>! THIS FUNCTION CALCULATES THE ICE SATURATION VAPOR MIXING RATIO AS A<a name='2665'></font>
<font color=#447700>! FUNCTION OF TEMPERATURE AND PRESSURE<a name='2666'></font>
<font color=#447700>!<a name='2667'></font>
<A NAME='RSIF'><A href='../../html_code/share/dfi.F.html#RSIF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2668'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>RSIF</font>(P,T) <A href='../../call_to/RSIF.html' TARGET='index'>4</A><a name='2669'>
<a name='2670'>
      IMPLICIT NONE<a name='2671'>
      REAL, INTENT(IN):: P, T<a name='2672'>
      REAL:: ESI,X<a name='2673'>
      REAL, PARAMETER:: C0= .609868993E03<a name='2674'>
      REAL, PARAMETER:: C1= .499320233E02<a name='2675'>
      REAL, PARAMETER:: C2= .184672631E01<a name='2676'>
      REAL, PARAMETER:: C3= .402737184E-1<a name='2677'>
      REAL, PARAMETER:: C4= .565392987E-3<a name='2678'>
      REAL, PARAMETER:: C5= .521693933E-5<a name='2679'>
      REAL, PARAMETER:: C6= .307839583E-7<a name='2680'>
      REAL, PARAMETER:: C7= .105785160E-9<a name='2681'>
      REAL, PARAMETER:: C8= .161444444E-12<a name='2682'>
<a name='2683'>
      X=MAX(-80.,T-273.16)<a name='2684'>
      ESI=C0+X*(C1+X*(C2+X*(C3+X*(C4+X*(C5+X*(C6+X*(C7+X*C8)))))))<a name='2685'>
      RSIF=.622*ESI/(P-ESI)<a name='2686'>
<a name='2687'>
<font color=#447700>!    ALTERNATIVE<a name='2688'></font>
<font color=#447700>!  ; Source: Murphy and Koop, Review of the vapour pressure of ice and<a name='2689'></font>
<font color=#447700>!             supercooled water for atmospheric applications, Q. J. R.<a name='2690'></font>
<font color=#447700>!             Meteorol. Soc (2005), 131, pp. 1539-1565.<a name='2691'></font>
<font color=#447700>!     ESI = EXP(9.550426 - 5723.265/T + 3.53068*ALOG(T) - 0.00728332*T)<a name='2692'></font>
<a name='2693'>
      END FUNCTION RSIF<a name='2694'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='2695'></font>
<a name='2696'>
<a name='2697'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2698'></font>
<font color=#447700>! DFI startfwd group of functions<a name='2699'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2700'></font>
<a name='2701'>
<A NAME='WRF_DFI_STARTFWD_INIT'><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTFWD_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2702'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dfi_startfwd_init</font> ( ) <A href='../../call_to/WRF_DFI_STARTFWD_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DFI_STARTFWD_INIT.html' TARGET='index'>4</A><a name='2703'>
<a name='2704'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTFWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_280">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time, set_current_grid_ptr<a name='2705'>
     USE module_utility<a name='2706'>
     <a name='2707'>
     IMPLICIT NONE<a name='2708'>
<a name='2709'>
     INTERFACE<a name='2710'>
        SUBROUTINE dfi_startfwd_init_recurse(grid)<a name='2711'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTFWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_281">, ONLY : domain<a name='2712'>
          TYPE (domain), POINTER :: grid<a name='2713'>
        END SUBROUTINE dfi_startfwd_init_recurse<a name='2714'>
     END INTERFACE<a name='2715'>
<a name='2716'>
     <font color=#447700>! Now, setup all nests<a name='2717'></font>
<a name='2718'>
     CALL <A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT_RECURSE'>dfi_startfwd_init_recurse</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTFWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_STARTFWD_INIT_RECURSE_1">(head_grid)<a name='2719'>
     <a name='2720'>
     CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTFWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_13">( head_grid )<a name='2721'>
<a name='2722'>
   END SUBROUTINE wrf_dfi_startfwd_init<a name='2723'>
<a name='2724'>
<a name='2725'>
<A NAME='DFI_STARTFWD_INIT_RECURSE'><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT_RECURSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2726'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_startfwd_init_recurse</font>(grid) <A href='../../call_to/DFI_STARTFWD_INIT_RECURSE.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_STARTFWD_INIT_RECURSE.html' TARGET='index'>5</A><a name='2727'>
<a name='2728'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_282">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time, max_nests, set_current_grid_ptr<a name='2729'>
<a name='2730'>
     IMPLICIT NONE<a name='2731'>
<a name='2732'>
      INTERFACE<a name='2733'>
         SUBROUTINE dfi_startfwd_init(grid)<a name='2734'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_283">, ONLY : domain<a name='2735'>
            TYPE (domain), POINTER :: grid<a name='2736'>
         END SUBROUTINE dfi_startfwd_init<a name='2737'>
      END INTERFACE<a name='2738'>
<a name='2739'>
     INTEGER :: kid<a name='2740'>
     TYPE (domain), POINTER :: grid<a name='2741'>
     TYPE (domain), POINTER :: grid_ptr<a name='2742'>
    <a name='2743'>
     grid_ptr =&gt; grid<a name='2744'>
<a name='2745'>
     DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='2746'>
        <font color=#447700>!<a name='2747'></font>
        <font color=#447700>! Assure that time-step is set back to positive<a name='2748'></font>
        <font color=#447700>!   for this forward step.<a name='2749'></font>
        <font color=#447700>!<a name='2750'></font>
        grid_ptr%dt = abs(grid_ptr%dt)<a name='2751'>
        grid_ptr%time_step = abs(grid_ptr%time_step)<a name='2752'>
        CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_14">( grid_ptr )<a name='2753'>
        CALL <A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT'>dfi_startfwd_init</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_STARTFWD_INIT_1">( grid_ptr )<a name='2754'>
        DO kid = 1, max_nests<a name='2755'>
           IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='2756'>
              CALL <A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT_RECURSE'>dfi_startfwd_init_recurse</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_STARTFWD_INIT_RECURSE_2">(grid_ptr%nests(kid)%ptr)<a name='2757'>
           ENDIF<a name='2758'>
        END DO<a name='2759'>
        grid_ptr =&gt; grid_ptr%sibling<a name='2760'>
     END DO<a name='2761'>
     <a name='2762'>
   END SUBROUTINE dfi_startfwd_init_recurse<a name='2763'>
<a name='2764'>
<a name='2765'>
<A NAME='DFI_STARTFWD_INIT'><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2766'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_startfwd_init</font> ( grid ) <A href='../../call_to/DFI_STARTFWD_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/DFI_STARTFWD_INIT.html' TARGET='index'>4</A><a name='2767'>
<a name='2768'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_284">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time<a name='2769'>
      USE module_utility<a name='2770'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_173"><a name='2771'>
<a name='2772'>
      IMPLICIT NONE<a name='2773'>
<a name='2774'>
      TYPE (domain) , POINTER                 :: grid<a name='2775'>
      INTEGER rc<a name='2776'>
<a name='2777'>
      INTERFACE<a name='2778'>
         SUBROUTINE Setup_Timekeeping(grid)<a name='2779'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_285">, ONLY : domain<a name='2780'>
            TYPE (domain), POINTER :: grid<a name='2781'>
         END SUBROUTINE Setup_Timekeeping<a name='2782'>
<a name='2783'>
      END INTERFACE<a name='2784'>
<a name='2785'>
      grid%dfi_stage = DFI_STARTFWD<a name='2786'>
<a name='2787'>
#if (EM_CORE == 1)<a name='2788'>
      <font color=#447700>! No need for adaptive time-step<a name='2789'></font>
      CALL nl_set_use_adaptive_time_step( grid%id, .false. )<a name='2790'>
#endif<a name='2791'>
<a name='2792'>
      CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/share/dfi.F.html#DFI_STARTFWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_16"> (grid)<a name='2793'>
      grid%start_subtime = domain_get_start_time ( head_grid )<a name='2794'>
      grid%stop_subtime = domain_get_stop_time ( head_grid )<a name='2795'>
<a name='2796'>
      CALL WRFU_ClockSet(grid%domain_clock, currTime=grid%start_subtime, rc=rc)<a name='2797'>
<a name='2798'>
   END SUBROUTINE dfi_startfwd_init<a name='2799'>
<a name='2800'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2801'></font>
<font color=#447700>! DFI startbck group of functions<a name='2802'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2803'></font>
<a name='2804'>
<A NAME='WRF_DFI_STARTBCK_INIT'><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTBCK_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2805'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dfi_startbck_init</font> ( ),<A href='../../call_from/WRF_DFI_STARTBCK_INIT.html' TARGET='index'>4</A><a name='2806'>
<a name='2807'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_286">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time, set_current_grid_ptr<a name='2808'>
     USE module_utility<a name='2809'>
     <a name='2810'>
     IMPLICIT NONE<a name='2811'>
<a name='2812'>
     INTERFACE<a name='2813'>
        SUBROUTINE dfi_startbck_init_recurse(grid)<a name='2814'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_287">, ONLY : domain<a name='2815'>
          TYPE (domain), POINTER :: grid<a name='2816'>
        END SUBROUTINE dfi_startbck_init_recurse<a name='2817'>
     END INTERFACE<a name='2818'>
<a name='2819'>
     <font color=#447700>! Now, setup all nests<a name='2820'></font>
<a name='2821'>
     CALL <A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT_RECURSE'>dfi_startbck_init_recurse</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_STARTBCK_INIT_RECURSE_1">(head_grid)<a name='2822'>
     <a name='2823'>
     CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_15">( head_grid )<a name='2824'>
<a name='2825'>
   END SUBROUTINE wrf_dfi_startbck_init<a name='2826'>
<a name='2827'>
<a name='2828'>
<A NAME='DFI_STARTBCK_INIT_RECURSE'><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT_RECURSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2829'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_startbck_init_recurse</font>(grid) <A href='../../call_to/DFI_STARTBCK_INIT_RECURSE.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_STARTBCK_INIT_RECURSE.html' TARGET='index'>5</A><a name='2830'>
<a name='2831'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_288">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time, max_nests, set_current_grid_ptr<a name='2832'>
<a name='2833'>
     IMPLICIT NONE<a name='2834'>
<a name='2835'>
      INTERFACE<a name='2836'>
         SUBROUTINE dfi_startbck_init(grid)<a name='2837'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_289">, ONLY : domain<a name='2838'>
            TYPE (domain), POINTER :: grid<a name='2839'>
         END SUBROUTINE dfi_startbck_init<a name='2840'>
      END INTERFACE<a name='2841'>
<a name='2842'>
     INTEGER :: kid<a name='2843'>
     TYPE (domain), POINTER :: grid<a name='2844'>
     TYPE (domain), POINTER :: grid_ptr<a name='2845'>
    <a name='2846'>
     grid_ptr =&gt; grid<a name='2847'>
<a name='2848'>
     DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='2849'>
        <font color=#447700>!<a name='2850'></font>
        <font color=#447700>! Assure that time-step is set back to positive<a name='2851'></font>
        <font color=#447700>!   for this forward step.<a name='2852'></font>
        <font color=#447700>!<a name='2853'></font>
        grid_ptr%dt = abs(grid_ptr%dt)<a name='2854'>
        grid_ptr%time_step = abs(grid_ptr%time_step)<a name='2855'>
        CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_16">( grid_ptr )<a name='2856'>
        CALL <A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT'>dfi_startbck_init</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_STARTBCK_INIT_1">( grid_ptr )<a name='2857'>
        DO kid = 1, max_nests<a name='2858'>
           IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='2859'>
              CALL <A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT_RECURSE'>dfi_startbck_init_recurse</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_STARTBCK_INIT_RECURSE_2">(grid_ptr%nests(kid)%ptr)<a name='2860'>
           ENDIF<a name='2861'>
        END DO<a name='2862'>
        grid_ptr =&gt; grid_ptr%sibling<a name='2863'>
     END DO<a name='2864'>
     <a name='2865'>
   END SUBROUTINE dfi_startbck_init_recurse<a name='2866'>
<a name='2867'>
<a name='2868'>
<A NAME='DFI_STARTBCK_INIT'><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2869'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_startbck_init</font> ( grid ) <A href='../../call_to/DFI_STARTBCK_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/DFI_STARTBCK_INIT.html' TARGET='index'>5</A><a name='2870'>
<a name='2871'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_290">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time<a name='2872'>
      USE module_utility<a name='2873'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_174"><a name='2874'>
<a name='2875'>
      IMPLICIT NONE<a name='2876'>
<a name='2877'>
      TYPE (domain) , POINTER                 :: grid<a name='2878'>
      INTEGER rc<a name='2879'>
<a name='2880'>
      INTERFACE<a name='2881'>
         SUBROUTINE Setup_Timekeeping(grid)<a name='2882'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_291">, ONLY : domain<a name='2883'>
            TYPE (domain), POINTER :: grid<a name='2884'>
         END SUBROUTINE Setup_Timekeeping<a name='2885'>
<a name='2886'>
      END INTERFACE<a name='2887'>
<a name='2888'>
      grid%dfi_stage = DFI_STARTBCK<a name='2889'>
<a name='2890'>
      <font color=#447700>! set physics options to zero<a name='2891'></font>
      CALL nl_set_mp_physics( grid%id, 0 )<a name='2892'>
      CALL nl_set_ra_lw_physics( grid%id, 0 )<a name='2893'>
      CALL nl_set_ra_sw_physics( grid%id, 0 )<a name='2894'>
      CALL nl_set_sf_surface_physics( grid%id, 0 )<a name='2895'>
      CALL nl_set_sf_sfclay_physics( grid%id, 0 )<a name='2896'>
      CALL nl_set_sf_urban_physics( grid%id, 0 )<a name='2897'>
      CALL nl_set_bl_pbl_physics( grid%id, 0 )<a name='2898'>
      CALL nl_set_cu_physics( grid%id, 0 )<a name='2899'>
      CALL nl_set_cu_diag( grid%id, 0 )<a name='2900'>
      CALL nl_set_damp_opt( grid%id, 0 )<a name='2901'>
      CALL nl_set_sst_update( grid%id, 0 )<a name='2902'>
      CALL nl_set_gwd_opt( grid%id, 0 )<a name='2903'>
#if (EM_CORE == 1)<a name='2904'>
      CALL nl_set_diff_6th_opt( grid%id, 0 )<a name='2905'>
      CALL nl_set_use_adaptive_time_step( grid%id, .false. )<a name='2906'>
#endif<a name='2907'>
      CALL nl_set_feedback( grid%id, 0 )<a name='2908'>
#if (EM_CORE == 1)<a name='2909'>
      <font color=#447700>! set bc<a name='2910'></font>
      CALL nl_set_constant_bc( grid%id, head_grid%constant_bc)<a name='2911'>
#endif<a name='2912'>
<a name='2913'>
#if ( WRF_CHEM == 1 )<a name='2914'>
      <font color=#447700>! set chemistry option to zero<a name='2915'></font>
      CALL nl_set_chem_opt (grid%id, 0)<a name='2916'>
      CALL nl_set_aer_ra_feedback (grid%id, 0)<a name='2917'>
      CALL nl_set_io_form_auxinput5 (grid%id, 0)<a name='2918'>
      CALL nl_set_io_form_auxinput6 (grid%id, 0)<a name='2919'>
      CALL nl_set_io_form_auxinput7 (grid%id, 0)<a name='2920'>
      CALL nl_set_io_form_auxinput8 (grid%id, 0)<a name='2921'>
      CALL nl_set_io_form_auxinput13 (grid%id, 0)<a name='2922'>
      CALL nl_set_io_form_auxinput14 (grid%id, 0)<a name='2923'>
      CALL nl_set_io_form_auxinput15 (grid%id, 0)<a name='2924'>
#endif<a name='2925'>
<a name='2926'>
#if (EM_CORE == 1)<a name='2927'>
      <font color=#447700>! set diffusion to zero for backward integration<a name='2928'></font>
      grid%km_opt_dfi = grid%km_opt<a name='2929'>
      grid%diff_opt_dfi = grid%diff_opt<a name='2930'>
      CALL nl_set_km_opt( grid%id, grid%km_opt_dfi)<a name='2931'>
      CALL nl_set_diff_opt( grid%id, grid%diff_opt_dfi)<a name='2932'>
      CALL nl_set_moist_adv_dfi_opt( grid%id, grid%moist_adv_dfi_opt)<a name='2933'>
      CALL nl_set_moist_adv_opt( grid%id,grid%moist_adv_dfi_opt)<a name='2934'>
#endif<a name='2935'>
<a name='2936'>
      <font color=#447700>! If a request to do pressure level diags, then shut it off<a name='2937'></font>
      <font color=#447700>! until we get to the real forecast part of this integration.<a name='2938'></font>
<a name='2939'>
#if (EM_CORE == 1)<a name='2940'>
      CALL nl_set_p_lev_diags( grid%id, grid%p_lev_diags_dfi)<a name='2941'>
#endif<a name='2942'>
<a name='2943'>
      <font color=#447700>!tgs need to call start_domain here to reset bc initialization for <a name='2944'></font>
      <font color=#447700>!      negative dt, but only for outer domain.<a name='2945'></font>
      if (grid%id == 1) then<a name='2946'>
        CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_7"> ( grid , .TRUE. )<a name='2947'>
      endif<a name='2948'>
<a name='2949'>
      <font color=#447700>! Call wrf_run to advance forward 1 step<a name='2950'></font>
<a name='2951'>
      <font color=#447700>! Negate time step<a name='2952'></font>
      CALL nl_set_time_step ( grid%id, -grid%time_step )<a name='2953'>
<a name='2954'>
      CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/share/dfi.F.html#DFI_STARTBCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_17"> (grid) <a name='2955'>
<a name='2956'>
      grid%start_subtime = domain_get_start_time ( grid )<a name='2957'>
      grid%stop_subtime = domain_get_stop_time ( grid )<a name='2958'>
<a name='2959'>
      CALL WRFU_ClockSet(grid%domain_clock, currTime=grid%start_subtime, rc=rc)<a name='2960'>
<a name='2961'>
   END SUBROUTINE dfi_startbck_init<a name='2962'>
<a name='2963'>
<a name='2964'>
<A NAME='WRF_DFI_BCK_INIT'><A href='../../html_code/share/dfi.F.html#WRF_DFI_BCK_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2965'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dfi_bck_init</font> ( ) <A href='../../call_to/WRF_DFI_BCK_INIT.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_DFI_BCK_INIT.html' TARGET='index'>4</A><a name='2966'>
<a name='2967'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_292">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time<a name='2968'>
     USE module_utility<a name='2969'>
     USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_175"><a name='2970'>
     <a name='2971'>
     IMPLICIT NONE<a name='2972'>
<a name='2973'>
     INTERFACE<a name='2974'>
        SUBROUTINE dfi_bck_init_recurse(grid)<a name='2975'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_293">, ONLY : domain<a name='2976'>
          TYPE (domain), POINTER :: grid<a name='2977'>
        END SUBROUTINE dfi_bck_init_recurse<a name='2978'>
     END INTERFACE<a name='2979'>
<a name='2980'>
     <font color=#447700>! We can only call dfi_bck_init for the head_grid<a name='2981'></font>
     <font color=#447700>!    since nests have not been instantiated at this point,<a name='2982'></font>
     <font color=#447700>!    so, dfi_bck_init will need to be called for each<a name='2983'></font>
     <font color=#447700>!    nest from integrate.<a name='2984'></font>
     CALL <A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT_RECURSE'>dfi_bck_init_recurse</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_BCK_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_BCK_INIT_RECURSE_1">(head_grid)<a name='2985'>
<a name='2986'>
   END SUBROUTINE wrf_dfi_bck_init<a name='2987'>
<a name='2988'>
<A NAME='DFI_BCK_INIT_RECURSE'><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT_RECURSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2989'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_bck_init_recurse</font>(grid) <A href='../../call_to/DFI_BCK_INIT_RECURSE.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_BCK_INIT_RECURSE.html' TARGET='index'>5</A><a name='2990'>
<a name='2991'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_294">, ONLY : domain, domain_get_stop_time, domain_get_start_time, max_nests, set_current_grid_ptr<a name='2992'>
<a name='2993'>
     IMPLICIT NONE<a name='2994'>
<a name='2995'>
      INTERFACE<a name='2996'>
         SUBROUTINE dfi_bck_init(grid)<a name='2997'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_295">, ONLY : domain<a name='2998'>
            TYPE (domain), POINTER :: grid<a name='2999'>
         END SUBROUTINE dfi_bck_init<a name='3000'>
      END INTERFACE<a name='3001'>
<a name='3002'>
     INTEGER :: kid<a name='3003'>
     TYPE (domain), POINTER :: grid<a name='3004'>
     TYPE (domain), POINTER :: grid_ptr<a name='3005'>
    <a name='3006'>
     grid_ptr =&gt; grid<a name='3007'>
<a name='3008'>
     DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='3009'>
        <font color=#447700>!<a name='3010'></font>
        <font color=#447700>! Assure that time-step is set back to positive<a name='3011'></font>
        <font color=#447700>!   for this forward step.<a name='3012'></font>
        <font color=#447700>!<a name='3013'></font>
        grid_ptr%dt = abs(grid_ptr%dt)<a name='3014'>
        grid_ptr%time_step = abs(grid_ptr%time_step)<a name='3015'>
        CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_17">( grid_ptr )<a name='3016'>
        CALL <A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT'>dfi_bck_init</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_BCK_INIT_1">( grid_ptr )<a name='3017'>
        DO kid = 1, max_nests<a name='3018'>
           IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='3019'>
              CALL <A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT_RECURSE'>dfi_bck_init_recurse</A><A href='../../html_code/share/dfi.F.html#DFI_BCK_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_BCK_INIT_RECURSE_2">(grid_ptr%nests(kid)%ptr)<a name='3020'>
           ENDIF<a name='3021'>
        END DO<a name='3022'>
        grid_ptr =&gt; grid_ptr%sibling<a name='3023'>
     END DO<a name='3024'>
     <a name='3025'>
   END SUBROUTINE dfi_bck_init_recurse<a name='3026'>
<a name='3027'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3028'></font>
<font color=#447700>! DFI forward initialization group of functions<a name='3029'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3030'></font>
<a name='3031'>
<A NAME='WRF_DFI_FWD_INIT'><A href='../../html_code/share/dfi.F.html#WRF_DFI_FWD_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3032'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dfi_fwd_init</font> ( ) <A href='../../call_to/WRF_DFI_FWD_INIT.html' TARGET='index'>3</A>,<A href='../../call_from/WRF_DFI_FWD_INIT.html' TARGET='index'>4</A><a name='3033'>
<a name='3034'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_296">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time, set_current_grid_ptr<a name='3035'>
     USE module_utility<a name='3036'>
     <a name='3037'>
     IMPLICIT NONE<a name='3038'>
<a name='3039'>
     INTERFACE<a name='3040'>
        SUBROUTINE dfi_fwd_init_recurse(grid)<a name='3041'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_297">, ONLY : domain<a name='3042'>
          TYPE (domain), POINTER :: grid<a name='3043'>
        END SUBROUTINE dfi_fwd_init_recurse<a name='3044'>
     END INTERFACE<a name='3045'>
<a name='3046'>
     <font color=#447700>! Now, setup all nests<a name='3047'></font>
<a name='3048'>
     CALL <A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT_RECURSE'>dfi_fwd_init_recurse</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_FWD_INIT_RECURSE_1">(head_grid)<a name='3049'>
     <a name='3050'>
     CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_FWD_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_18">( head_grid )<a name='3051'>
<a name='3052'>
   END SUBROUTINE wrf_dfi_fwd_init<a name='3053'>
<a name='3054'>
<A NAME='DFI_FWD_INIT_RECURSE'><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT_RECURSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3055'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_fwd_init_recurse</font>(grid) <A href='../../call_to/DFI_FWD_INIT_RECURSE.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_FWD_INIT_RECURSE.html' TARGET='index'>5</A><a name='3056'>
<a name='3057'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_298">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time, max_nests, set_current_grid_ptr<a name='3058'>
<a name='3059'>
     IMPLICIT NONE<a name='3060'>
<a name='3061'>
      INTERFACE<a name='3062'>
         SUBROUTINE dfi_fwd_init(grid)<a name='3063'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_299">, ONLY : domain<a name='3064'>
            TYPE (domain), POINTER :: grid<a name='3065'>
         END SUBROUTINE dfi_fwd_init<a name='3066'>
      END INTERFACE<a name='3067'>
<a name='3068'>
     INTEGER :: kid<a name='3069'>
     TYPE (domain), POINTER :: grid<a name='3070'>
     TYPE (domain), POINTER :: grid_ptr<a name='3071'>
    <a name='3072'>
     grid_ptr =&gt; grid<a name='3073'>
<a name='3074'>
     DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='3075'>
        <font color=#447700>!<a name='3076'></font>
        <font color=#447700>! Assure that time-step is set back to positive<a name='3077'></font>
        <font color=#447700>!   for this forward step.<a name='3078'></font>
        <font color=#447700>!<a name='3079'></font>
        grid_ptr%dt = abs(grid_ptr%dt)<a name='3080'>
        grid_ptr%time_step = abs(grid_ptr%time_step)<a name='3081'>
        CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_19">( grid_ptr )<a name='3082'>
        CALL <A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT'>dfi_fwd_init</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_FWD_INIT_1">( grid_ptr )<a name='3083'>
        DO kid = 1, max_nests<a name='3084'>
           IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='3085'>
              CALL <A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT_RECURSE'>dfi_fwd_init_recurse</A><A href='../../html_code/share/dfi.F.html#DFI_FWD_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_FWD_INIT_RECURSE_2">(grid_ptr%nests(kid)%ptr)<a name='3086'>
           ENDIF<a name='3087'>
        END DO<a name='3088'>
        grid_ptr =&gt; grid_ptr%sibling<a name='3089'>
     END DO<a name='3090'>
     <a name='3091'>
   END SUBROUTINE dfi_fwd_init_recurse<a name='3092'>
<a name='3093'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3094'></font>
<font color=#447700>! DFI forecast initialization group of functions<a name='3095'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3096'></font>
<a name='3097'>
<A NAME='WRF_DFI_FST_INIT'><A href='../../html_code/share/dfi.F.html#WRF_DFI_FST_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3098'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dfi_fst_init</font> ( ) <A href='../../call_to/WRF_DFI_FST_INIT.html' TARGET='index'>3</A>,<A href='../../call_from/WRF_DFI_FST_INIT.html' TARGET='index'>4</A><a name='3099'>
<a name='3100'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_300">, ONLY : domain, head_grid, domain_get_stop_time, domain_get_start_time, set_current_grid_ptr<a name='3101'>
     USE module_utility<a name='3102'>
     <a name='3103'>
     IMPLICIT NONE<a name='3104'>
<a name='3105'>
     INTERFACE<a name='3106'>
        SUBROUTINE dfi_fst_init_recurse(grid)<a name='3107'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_301">, ONLY : domain<a name='3108'>
          TYPE (domain), POINTER :: grid<a name='3109'>
        END SUBROUTINE dfi_fst_init_recurse<a name='3110'>
     END INTERFACE<a name='3111'>
<a name='3112'>
     <font color=#447700>! Now, setup all nests<a name='3113'></font>
<a name='3114'>
     CALL <A href='../../html_code/share/dfi.F.html#DFI_FST_INIT_RECURSE'>dfi_fst_init_recurse</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_FST_INIT_RECURSE_1">(head_grid)<a name='3115'>
     <a name='3116'>
     CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_FST_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_20">( head_grid )<a name='3117'>
<a name='3118'>
   END SUBROUTINE wrf_dfi_fst_init<a name='3119'>
<a name='3120'>
<A NAME='DFI_FST_INIT_RECURSE'><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT_RECURSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3121'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_fst_init_recurse</font> ( grid ) <A href='../../call_to/DFI_FST_INIT_RECURSE.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_FST_INIT_RECURSE.html' TARGET='index'>5</A><a name='3122'>
<a name='3123'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_302">, ONLY : domain, domain_get_stop_time, domain_get_start_time, max_nests, set_current_grid_ptr<a name='3124'>
<a name='3125'>
     IMPLICIT NONE<a name='3126'>
<a name='3127'>
      INTERFACE<a name='3128'>
         SUBROUTINE dfi_fst_init(grid)<a name='3129'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_303">, ONLY : domain<a name='3130'>
            TYPE (domain), POINTER :: grid<a name='3131'>
         END SUBROUTINE dfi_fst_init<a name='3132'>
      END INTERFACE<a name='3133'>
<a name='3134'>
     INTEGER :: kid<a name='3135'>
     TYPE (domain), POINTER :: grid<a name='3136'>
     TYPE (domain), POINTER :: grid_ptr<a name='3137'>
    <a name='3138'>
     grid_ptr =&gt; grid<a name='3139'>
<a name='3140'>
     DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='3141'>
        <font color=#447700>!<a name='3142'></font>
        <font color=#447700>! Assure that time-step is set back to positive<a name='3143'></font>
        <font color=#447700>!   for this forward step.<a name='3144'></font>
        <font color=#447700>!<a name='3145'></font>
        grid_ptr%dt = abs(grid_ptr%dt)<a name='3146'>
        grid_ptr%time_step = abs(grid_ptr%time_step)<a name='3147'>
        CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_21">( grid_ptr )<a name='3148'>
        CALL <A href='../../html_code/share/dfi.F.html#DFI_FST_INIT'>dfi_fst_init</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_FST_INIT_1">( grid_ptr )<a name='3149'>
        DO kid = 1, max_nests<a name='3150'>
           IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='3151'>
              CALL <A href='../../html_code/share/dfi.F.html#DFI_FST_INIT_RECURSE'>dfi_fst_init_recurse</A><A href='../../html_code/share/dfi.F.html#DFI_FST_INIT_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_FST_INIT_RECURSE_2">(grid_ptr%nests(kid)%ptr)<a name='3152'>
           ENDIF<a name='3153'>
        END DO<a name='3154'>
        grid_ptr =&gt; grid_ptr%sibling<a name='3155'>
     END DO<a name='3156'>
     <a name='3157'>
   END SUBROUTINE dfi_fst_init_recurse<a name='3158'>
<a name='3159'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3160'></font>
<font color=#447700>! DFI write initialization group of functions<a name='3161'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3162'></font>
<a name='3163'>
<A NAME='WRF_DFI_WRITE_INITIALIZED_STATE'><A href='../../html_code/share/dfi.F.html#WRF_DFI_WRITE_INITIALIZED_STATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3164'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dfi_write_initialized_state</font>( ) <A href='../../call_to/WRF_DFI_WRITE_INITIALIZED_STATE.html' TARGET='index'>3</A>,<A href='../../call_from/WRF_DFI_WRITE_INITIALIZED_STATE.html' TARGET='index'>3</A><a name='3165'>
<a name='3166'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_304">, ONLY : domain, head_grid<a name='3167'>
<a name='3168'>
     INTERFACE<a name='3169'>
        SUBROUTINE dfi_write_initialized_state_recurse(grid)<a name='3170'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_305">, ONLY : domain<a name='3171'>
          TYPE (domain), POINTER :: grid<a name='3172'>
        END SUBROUTINE dfi_write_initialized_state_recurse<a name='3173'>
     END INTERFACE<a name='3174'>
<a name='3175'>
     <font color=#447700>! Now, setup all nests<a name='3176'></font>
<a name='3177'>
     CALL <A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE_RECURSE'>dfi_write_initialized_state_recurse</A><A href='../../html_code/share/dfi.F.html#WRF_DFI_WRITE_INITIALIZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_WRITE_INITIALIZED_STATE_RECURSE_1">(head_grid)<a name='3178'>
     <a name='3179'>
   END SUBROUTINE wrf_dfi_write_initialized_state<a name='3180'>
<a name='3181'>
<A NAME='DFI_WRITE_INITIALIZED_STATE_RECURSE'><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE_RECURSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3182'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_write_initialized_state_recurse</font>( grid ) <A href='../../call_to/DFI_WRITE_INITIALIZED_STATE_RECURSE.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_WRITE_INITIALIZED_STATE_RECURSE.html' TARGET='index'>4</A><a name='3183'>
<a name='3184'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_306">, ONLY : domain, max_nests<a name='3185'>
     <a name='3186'>
     IMPLICIT NONE<a name='3187'>
     <a name='3188'>
     INTERFACE<a name='3189'>
        SUBROUTINE dfi_write_initialized_state( grid )<a name='3190'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_307">, ONLY : domain<a name='3191'>
          TYPE (domain), POINTER :: grid<a name='3192'>
        END SUBROUTINE dfi_write_initialized_state<a name='3193'>
     END INTERFACE<a name='3194'>
     <a name='3195'>
     INTEGER :: kid<a name='3196'>
     TYPE (domain), POINTER :: grid<a name='3197'>
     TYPE (domain), POINTER :: grid_ptr<a name='3198'>
     <a name='3199'>
     grid_ptr =&gt; grid<a name='3200'>
     <a name='3201'>
     DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='3202'>
        <font color=#447700>!<a name='3203'></font>
        <font color=#447700>! Assure that time-step is set back to positive<a name='3204'></font>
        <font color=#447700>!   for this forward step.<a name='3205'></font>
        <font color=#447700>!<a name='3206'></font>
        CALL <A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE'>dfi_write_initialized_state</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_WRITE_INITIALIZED_STATE_1">( grid_ptr )<a name='3207'>
        DO kid = 1, max_nests<a name='3208'>
           IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='3209'>
              CALL <A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE_RECURSE'>dfi_write_initialized_state_recurse</A><A href='../../html_code/share/dfi.F.html#DFI_WRITE_INITIALIZED_STATE_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_WRITE_INITIALIZED_STATE_RECURSE_2">(grid_ptr%nests(kid)%ptr)<a name='3210'>
           ENDIF<a name='3211'>
        END DO<a name='3212'>
        grid_ptr =&gt; grid_ptr%sibling<a name='3213'>
     END DO<a name='3214'>
     <a name='3215'>
   END SUBROUTINE dfi_write_initialized_state_recurse<a name='3216'>
<a name='3217'>
<A NAME='WRF_TDFI_WRITE_ANALYZED_STATE'><A href='../../html_code/share/dfi.F.html#WRF_TDFI_WRITE_ANALYZED_STATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3218'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_tdfi_write_analyzed_state</font>( ),<A href='../../call_from/WRF_TDFI_WRITE_ANALYZED_STATE.html' TARGET='index'>3</A><a name='3219'>
<a name='3220'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_308">, ONLY : domain, head_grid<a name='3221'>
<a name='3222'>
     INTERFACE<a name='3223'>
        SUBROUTINE tdfi_write_analyzed_state_recurse(grid)<a name='3224'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#WRF_TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_309">, ONLY : domain<a name='3225'>
          TYPE (domain), POINTER :: grid<a name='3226'>
        END SUBROUTINE tdfi_write_analyzed_state_recurse<a name='3227'>
     END INTERFACE<a name='3228'>
<a name='3229'>
     <font color=#447700>! Now, setup all nests<a name='3230'></font>
<a name='3231'>
     CALL <A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE_RECURSE'>tdfi_write_analyzed_state_recurse</A><A href='../../html_code/share/dfi.F.html#WRF_TDFI_WRITE_ANALYZED_STATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFI_WRITE_ANALYZED_STATE_RECURSE_1">(head_grid)<a name='3232'>
<a name='3233'>
   END SUBROUTINE wrf_tdfi_write_analyzed_state<a name='3234'>
<a name='3235'>
<A NAME='TDFI_WRITE_ANALYZED_STATE_RECURSE'><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE_RECURSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3236'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>tdfi_write_analyzed_state_recurse</font>( grid ) <A href='../../call_to/TDFI_WRITE_ANALYZED_STATE_RECURSE.html' TARGET='index'>2</A>,<A href='../../call_from/TDFI_WRITE_ANALYZED_STATE_RECURSE.html' TARGET='index'>4</A><a name='3237'>
<a name='3238'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_310">, ONLY : domain, max_nests<a name='3239'>
<a name='3240'>
     IMPLICIT NONE<a name='3241'>
<a name='3242'>
     INTERFACE<a name='3243'>
        SUBROUTINE tdfi_write_analyzed_state( grid )<a name='3244'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_311">, ONLY : domain<a name='3245'>
          TYPE (domain), POINTER :: grid<a name='3246'>
        END SUBROUTINE tdfi_write_analyzed_state<a name='3247'>
     END INTERFACE<a name='3248'>
<a name='3249'>
     INTEGER :: kid<a name='3250'>
     TYPE (domain), POINTER :: grid<a name='3251'>
     TYPE (domain), POINTER :: grid_ptr<a name='3252'>
<a name='3253'>
     grid_ptr =&gt; grid<a name='3254'>
<a name='3255'>
     DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='3256'>
        <font color=#447700>!<a name='3257'></font>
        <font color=#447700>! Assure that time-step is set back to positive<a name='3258'></font>
        <font color=#447700>!   for this forward step.<a name='3259'></font>
        <font color=#447700>!<a name='3260'></font>
        CALL <A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE'>tdfi_write_analyzed_state</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFI_WRITE_ANALYZED_STATE_1">( grid_ptr )<a name='3261'>
        DO kid = 1, max_nests<a name='3262'>
           IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='3263'>
              CALL <A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE_RECURSE'>tdfi_write_analyzed_state_recurse</A><A href='../../html_code/share/dfi.F.html#TDFI_WRITE_ANALYZED_STATE_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TDFI_WRITE_ANALYZED_STATE_RECURSE_2">(grid_ptr%nests(kid)%ptr)<a name='3264'>
           ENDIF<a name='3265'>
        END DO<a name='3266'>
        grid_ptr =&gt; grid_ptr%sibling<a name='3267'>
     END DO<a name='3268'>
<a name='3269'>
   END SUBROUTINE tdfi_write_analyzed_state_recurse<a name='3270'>
<a name='3271'>
<A NAME='DFI_ARRAY_RESET_RECURSE'><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET_RECURSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3272'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>dfi_array_reset_recurse</font>(grid) <A href='../../call_to/DFI_ARRAY_RESET_RECURSE.html' TARGET='index'>2</A>,<A href='../../call_from/DFI_ARRAY_RESET_RECURSE.html' TARGET='index'>5</A><a name='3273'>
<a name='3274'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_312">, ONLY : domain, max_nests, set_current_grid_ptr<a name='3275'>
<a name='3276'>
     IMPLICIT NONE<a name='3277'>
<a name='3278'>
      INTERFACE<a name='3279'>
         SUBROUTINE dfi_array_reset(grid)<a name='3280'>
            USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_313">, ONLY : domain<a name='3281'>
            TYPE (domain), POINTER :: grid<a name='3282'>
         END SUBROUTINE dfi_array_reset<a name='3283'>
      END INTERFACE<a name='3284'>
<a name='3285'>
     INTEGER :: kid<a name='3286'>
     TYPE (domain), POINTER :: grid<a name='3287'>
     TYPE (domain), POINTER :: grid_ptr<a name='3288'>
    <a name='3289'>
     grid_ptr =&gt; grid<a name='3290'>
<a name='3291'>
     DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='3292'>
        CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_22">( grid_ptr )<a name='3293'>
        CALL <A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET'>dfi_array_reset</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_ARRAY_RESET_1">( grid_ptr )<a name='3294'>
        DO kid = 1, max_nests<a name='3295'>
           IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='3296'>
              CALL <A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET_RECURSE'>dfi_array_reset_recurse</A><A href='../../html_code/share/dfi.F.html#DFI_ARRAY_RESET_RECURSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_ARRAY_RESET_RECURSE_2">(grid_ptr%nests(kid)%ptr)<a name='3297'>
           ENDIF<a name='3298'>
        END DO<a name='3299'>
        grid_ptr =&gt; grid_ptr%sibling<a name='3300'>
     END DO<a name='3301'>
     <a name='3302'>
   END SUBROUTINE dfi_array_reset_recurse<a name='3303'>
<a name='3304'>
<font color=#447700>!-------------------------------------------------------------------<a name='3305'></font>
<a name='3306'>
#if (EM_CORE == 1)<a name='3307'>
<A NAME='REBALANCE_DRIVER_DFI'><A href='../../html_code/share/dfi.F.html#REBALANCE_DRIVER_DFI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3308'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rebalance_driver_dfi</font> ( grid ) <A href='../../call_to/REBALANCE_DRIVER_DFI.html' TARGET='index'>2</A>,<A href='../../call_from/REBALANCE_DRIVER_DFI.html' TARGET='index'>2</A><a name='3309'>
<a name='3310'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#REBALANCE_DRIVER_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_314">, ONLY : domain<a name='3311'>
<a name='3312'>
      IMPLICIT NONE<a name='3313'>
<a name='3314'>
      TYPE (domain)          :: grid<a name='3315'>
<a name='3316'>
      CALL <A href='../../html_code/share/dfi.F.html#REBALANCE_DFI'>rebalance_dfi</A><A href='../../html_code/share/dfi.F.html#REBALANCE_DRIVER_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REBALANCE_DFI_1">( grid &amp;<a name='3317'>
<font color=#447700>!<a name='3318'></font>
#include "<A href='../../html_code/include/actual_new_args.inc.html'>actual_new_args.inc</A>"<A NAME="actual_new_args.inc_1"><A href='../../html_code/share/dfi.F.html#REBALANCE_DRIVER_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3319'>
<font color=#447700>!<a name='3320'></font>
      )<a name='3321'>
<a name='3322'>
   END SUBROUTINE rebalance_driver_dfi<a name='3323'>
<a name='3324'>
<font color=#447700>!---------------------------------------------------------------------<a name='3325'></font>
<a name='3326'>
<A NAME='REBALANCE_DFI'><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3327'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rebalance_dfi</font> ( grid  &amp; <A href='../../call_to/REBALANCE_DFI.html' TARGET='index'>1</A>,<A href='../../call_from/REBALANCE_DFI.html' TARGET='index'>6</A><a name='3328'>
<font color=#447700>!<a name='3329'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_2"><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3330'>
<font color=#447700>!<a name='3331'></font>
                        )<a name='3332'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_315">, ONLY : domain<a name='3333'>
      USE module_utility<a name='3334'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_176"><a name='3335'>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_109"><a name='3336'>
      USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_57"><a name='3337'>
#ifdef DM_PARALLEL<a name='3338'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_167"><a name='3339'>
   USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_33">, ONLY : &amp;<a name='3340'>
                           HALO_EM_INIT_1_sub   &amp;<a name='3341'>
                          ,HALO_EM_INIT_2_sub   &amp;<a name='3342'>
                          ,HALO_EM_INIT_3_sub   &amp;<a name='3343'>
                          ,HALO_EM_INIT_4_sub   &amp;<a name='3344'>
                          ,HALO_EM_INIT_5_sub   <a name='3345'>
#endif<a name='3346'>
<a name='3347'>
<a name='3348'>
      IMPLICIT NONE<a name='3349'>
<a name='3350'>
      TYPE (domain)        :: grid<a name='3351'>
<a name='3352'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_3"><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3353'>
<a name='3354'>
      REAL :: p_surf ,  pd_surf, p_surf_int , pb_int , ht_hold<a name='3355'>
      REAL :: qvf , qvf1 , qvf2, qtot<a name='3356'>
      REAL :: pfu, pfd, phm<a name='3357'>
      REAL :: z0, z1, z2, w1, w2<a name='3358'>
<a name='3359'>
      <font color=#447700>!  Local domain indices and counters.<a name='3360'></font>
<a name='3361'>
      INTEGER :: n_moist<a name='3362'>
<a name='3363'>
      INTEGER                             ::                       &amp;<a name='3364'>
                                     ids, ide, jds, jde, kds, kde, &amp;<a name='3365'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='3366'>
                                     its, ite, jts, jte, kts, kte, &amp;<a name='3367'>
                                     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='3368'>
                                     i, j, k, kk, ispe, ktf<a name='3369'>
<a name='3370'>
      SELECT CASE ( model_data_order )<a name='3371'>
         CASE ( DATA_ORDER_ZXY )<a name='3372'>
            kds = grid%sd31 ; kde = grid%ed31 ;<a name='3373'>
            ids = grid%sd32 ; ide = grid%ed32 ;<a name='3374'>
            jds = grid%sd33 ; jde = grid%ed33 ;<a name='3375'>
<a name='3376'>
            kms = grid%sm31 ; kme = grid%em31 ;<a name='3377'>
            ims = grid%sm32 ; ime = grid%em32 ;<a name='3378'>
            jms = grid%sm33 ; jme = grid%em33 ;<a name='3379'>
<a name='3380'>
            kts = grid%sp31 ; kte = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='3381'></font>
            its = grid%sp32 ; ite = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='3382'></font>
            jts = grid%sp33 ; jte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='3383'></font>
<a name='3384'>
         CASE ( DATA_ORDER_XYZ )<a name='3385'>
            ids = grid%sd31 ; ide = grid%ed31 ;<a name='3386'>
            jds = grid%sd32 ; jde = grid%ed32 ;<a name='3387'>
            kds = grid%sd33 ; kde = grid%ed33 ;<a name='3388'>
<a name='3389'>
            ims = grid%sm31 ; ime = grid%em31 ;<a name='3390'>
            jms = grid%sm32 ; jme = grid%em32 ;<a name='3391'>
            kms = grid%sm33 ; kme = grid%em33 ;<a name='3392'>
<a name='3393'>
            its = grid%sp31 ; ite = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='3394'></font>
            jts = grid%sp32 ; jte = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='3395'></font>
            kts = grid%sp33 ; kte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='3396'></font>
<a name='3397'>
         CASE ( DATA_ORDER_XZY )<a name='3398'>
            ids = grid%sd31 ; ide = grid%ed31 ;<a name='3399'>
            kds = grid%sd32 ; kde = grid%ed32 ;<a name='3400'>
            jds = grid%sd33 ; jde = grid%ed33 ;<a name='3401'>
<a name='3402'>
            ims = grid%sm31 ; ime = grid%em31 ;<a name='3403'>
            kms = grid%sm32 ; kme = grid%em32 ;<a name='3404'>
            jms = grid%sm33 ; jme = grid%em33 ;<a name='3405'>
<a name='3406'>
            its = grid%sp31 ; ite = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='3407'></font>
            kts = grid%sp32 ; kte = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='3408'></font>
            jts = grid%sp33 ; jte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='3409'></font>
<a name='3410'>
      END SELECT<a name='3411'>
<a name='3412'>
            ktf=MIN(kte,kde-1)<a name='3413'>
<a name='3414'>
      DO j=jts,jte<a name='3415'>
         DO i=its,ite<a name='3416'>
            grid%ph_2(i,1,j) = 0.<a name='3417'>
         END DO<a name='3418'>
      END DO<a name='3419'>
<a name='3420'>
      <font color=#447700>!  Base state potential temperature and inverse density (alpha = 1/rho) from<a name='3421'></font>
      <font color=#447700>!  the half eta levels and the base-profile surface pressure.  Compute 1/rho<a name='3422'></font>
      <font color=#447700>!  from equation of state.  The potential temperature is a perturbation from t0.<a name='3423'></font>
<a name='3424'>
         n_moist = num_moist<a name='3425'>
<font color=#447700>!         n_moist = num_moist-1<a name='3426'></font>
<a name='3427'>
<font color=#447700>!       print *,'n_moist,PARAM_FIRST_SCALAR',n_moist,PARAM_FIRST_SCALAR<a name='3428'></font>
<a name='3429'>
       DO j = jts, MIN(jte,jde-1)<a name='3430'>
         DO i = its, MIN(ite,ide-1)<a name='3431'>
<a name='3432'>
               <font color=#447700>!  Integrate the hydrostatic equation (from the RHS of the bigstep vertical momentum<a name='3433'></font>
               <font color=#447700>!  equation) down from the top to get the pressure perturbation.  First get the pressure<a name='3434'></font>
               <font color=#447700>!  perturbation, moisture, and inverse density (total and perturbation) at the top-most level.<a name='3435'></font>
               kk = kte-1<a name='3436'>
               k=kk+1<a name='3437'>
<a name='3438'>
               qtot = 0.<a name='3439'>
               DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='3440'>
                 qtot = qtot + 0.5*(moist(i,kk,j,ispe)+moist(i,kk,j,ispe))<a name='3441'>
               ENDDO<a name='3442'>
               qvf2 = 1./(1.+qtot)<a name='3443'>
               qvf1 = qtot*qvf2<a name='3444'>
<a name='3445'>
               grid%p(i,kk,j) = - 0.5*(grid%Mu_2(i,j)+qvf1*grid%Mub(i,j))/grid%rdnw(kk)/qvf2<a name='3446'>
               qvf = 1.+rvovrd*moist(i,kk,j,P_QV)<a name='3447'>
               grid%alt(i,kk,j) = (r_d/p1000mb)*(grid%t_2(i,kk,j)+t0)*qvf*         &amp;<a name='3448'>
                      (((grid%p(i,kk,j)+grid%pb(i,kk,j))/p1000mb)**cvpm)<a name='3449'>
               grid%al(i,kk,j) = grid%alt(i,kk,j) - grid%alb(i,kk,j)<a name='3450'>
               grid%p_hyd(i,kk,j) = grid%p(i,kk,j) + grid%pb(i,kk,j)<a name='3451'>
<a name='3452'>
               <font color=#447700>!  Now, integrate down the column to compute the pressure perturbation, and diagnose the two<a name='3453'></font>
               <font color=#447700>!  inverse density fields (total and perturbation).<a name='3454'></font>
<a name='3455'>
           DO kk=kte-2,1,-1<a name='3456'>
               k = kk + 1<a name='3457'>
               qtot = 0.<a name='3458'>
               DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='3459'>
               qtot = qtot + 0.5*(  moist(i,kk  ,j,ispe) + moist(i,kk+1,j,ispe) )<a name='3460'>
               ENDDO<a name='3461'>
               qvf2 = 1./(1.+qtot)<a name='3462'>
               qvf1 = qtot*qvf2<a name='3463'>
               grid%p(i,kk,j) = grid%p(i,kk+1,j) - (grid%Mu_2(i,j) +       &amp;<a name='3464'>
                               qvf1*grid%Mub(i,j))/qvf2/grid%rdn(kk+1)<a name='3465'>
               qvf = 1. + rvovrd*moist(i,kk,j,P_QV)<a name='3466'>
               grid%alt(i,kk,j) = (r_d/p1000mb)*(grid%t_2(i,kk,j)+t0)*qvf* &amp;<a name='3467'>
                           (((grid%p(i,kk,j)+grid%pb(i,kk,j))/p1000mb)**cvpm)<a name='3468'>
               grid%al(i,kk,j) = grid%alt(i,kk,j) - grid%alb(i,kk,j)<a name='3469'>
               grid%p_hyd(i,kk,j) = grid%p(i,kk,j) + grid%pb(i,kk,j)<a name='3470'>
           ENDDO<a name='3471'>
<a name='3472'>
               <font color=#447700>!  This is the hydrostatic equation used in the model after the small timesteps.  In<a name='3473'></font>
               <font color=#447700>!  the model, grid%al (inverse density) is computed from the geopotential.<a name='3474'></font>
<a name='3475'>
               IF (grid%hypsometric_opt == 1) THEN<a name='3476'>
                  DO kk  = 2,kte<a name='3477'>
                     k = kk - 1 <a name='3478'>
                     grid%ph_2(i,kk,j) = grid%ph_2(i,kk-1,j) - &amp;<a name='3479'>
                                   grid%dnw(kk-1) * ( (grid%mub(i,j)+grid%mu_2(i,j))*grid%al(i,kk-1,j) &amp;<a name='3480'>
                                 + grid%mu_2(i,j)*grid%alb(i,kk-1,j) )<a name='3481'>
                     grid%ph0(i,kk,j) = grid%ph_2(i,kk,j) + grid%phb(i,kk,j)<a name='3482'>
                  END DO<a name='3483'>
               ELSE IF (grid%hypsometric_opt == 2) THEN<a name='3484'>
                <font color=#447700>! Alternative hydrostatic eq.: dZ = -al*p*dLOG(p), where p is<a name='3485'></font>
                <font color=#447700>! dry pressure.<a name='3486'></font>
                <font color=#447700>! Note that al*p approximates Rd*T and dLOG(p) does z.<a name='3487'></font>
                <font color=#447700>! Here T varies mostly linear with z, the first-order<a name='3488'></font>
                <font color=#447700>! integration produces better result.<a name='3489'></font>
<a name='3490'>
                  grid%ph_2(i,1,j) = grid%phb(i,1,j)<a name='3491'>
                  DO k = 2,kte<a name='3492'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='3493'></font>
                     pfu = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znw(k)   + grid%p_top<a name='3494'>
                     pfd = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znw(k-1) + grid%p_top<a name='3495'>
                     phm = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znu(k-1) + grid%p_top<a name='3496'>
#elif ( HYBRID_COORD==1 )<a name='3497'>
                     pfu = grid%c3f(k  )*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4f(k  ) + grid%p_top<a name='3498'>
                     pfd = grid%c3f(k-1)*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4f(k-1) + grid%p_top<a name='3499'>
                     phm = grid%c3h(k-1)*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4h(k-1) + grid%p_top<a name='3500'>
#endif<a name='3501'>
                     grid%ph_2(i,k,j) = grid%ph_2(i,k-1,j) + grid%alt(i,k-1,j)*phm*LOG(pfd/pfu)<a name='3502'>
                  END DO<a name='3503'>
<a name='3504'>
                  DO k = 1,kte<a name='3505'>
                     grid%ph_2(i,k,j) = grid%ph_2(i,k,j) - grid%phb(i,k,j)<a name='3506'>
                  END DO<a name='3507'>
<a name='3508'>
                  DO k = 1,kte<a name='3509'>
                     grid%ph0(i,k,j) = grid%ph_2(i,k,j) + grid%phb(i,k,j)<a name='3510'>
                  END DO<a name='3511'>
<a name='3512'>
               END IF<a name='3513'>
<font color=#447700>! update surface pressure PSFC:<a name='3514'></font>
                  z0 = grid%ph0(i,1,j)/g<a name='3515'>
                  z1 = 0.5*(grid%ph0(i,1,j)+grid%ph0(i,2,j))/g<a name='3516'>
                  z2 = 0.5*(grid%ph0(i,2,j)+grid%ph0(i,3,j))/g<a name='3517'>
                  w1 = (z0 - z2)/(z1 - z2)<a name='3518'>
                  w2 = 1. - w1<a name='3519'>
                  grid%psfc(i,j) = w1*(grid%p(i,1,j)+grid%pb(i,1,j))+w2*(grid%p(i,2,j)+grid%pb(i,2,j))<a name='3520'>
<a name='3521'>
         ENDDO  <font color=#447700>!i<a name='3522'></font>
        ENDDO  <font color=#447700>!j<a name='3523'></font>
<a name='3524'>
      ips = its ; ipe = ite ; jps = jts ; jpe = jte ; kps = kts ; kpe = kte<a name='3525'>
#ifdef DM_PARALLEL<a name='3526'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_1.inc.html'>HALO_EM_INIT_1.inc</A>"<A NAME="HALO_EM_INIT_1.inc_4"><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3527'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_2.inc.html'>HALO_EM_INIT_2.inc</A>"<A NAME="HALO_EM_INIT_2.inc_5"><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3528'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_3.inc.html'>HALO_EM_INIT_3.inc</A>"<A NAME="HALO_EM_INIT_3.inc_6"><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3529'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_4.inc.html'>HALO_EM_INIT_4.inc</A>"<A NAME="HALO_EM_INIT_4.inc_7"><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3530'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_5.inc.html'>HALO_EM_INIT_5.inc</A>"<A NAME="HALO_EM_INIT_5.inc_8"><A href='../../html_code/share/dfi.F.html#REBALANCE_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3531'>
#endif<a name='3532'>
   END SUBROUTINE rebalance_dfi<a name='3533'>
<a name='3534'>
#endif<a name='3535'>
<font color=#447700>!---------------------------------------------------------------------<a name='3536'></font>
</pre></body></html>