<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2'></font>
<font color=#447700>! This routine prints out the current value of variables at all specified<a name='3'></font>
<font color=#447700>!   time series locations that are within the current patch.<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>! Michael G. Duda -- 25 August 2005<a name='6'></font>
<font color=#447700>! vertical profiles added by Torge Lorenz -- June 2012<a name='7'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='8'></font>
<A NAME='CALC_TS_LOCATIONS'><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_ts_locations</font>( grid ) <A href='../../call_to/CALC_TS_LOCATIONS.html' TARGET='index'>1</A>,<A href='../../call_from/CALC_TS_LOCATIONS.html' TARGET='index'>24</A><a name='10'>
<a name='11'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_464">, ONLY : domain, get_ijk_from_grid<a name='12'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_296">, ONLY : model_config_rec, grid_config_rec_type, model_to_grid_config_rec<a name='13'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_201">, ONLY : wrf_dm_min_real<a name='14'>
   USE <A href='../../html_code/share/module_llxy.F.html#MODULE_LLXY'>module_llxy</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LLXY_14"><a name='15'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_213"><a name='16'>
<a name='17'>
   IMPLICIT NONE<a name='18'>
<a name='19'>
   <font color=#447700>! Arguments<a name='20'></font>
   TYPE (domain), INTENT(INOUT) :: grid<a name='21'>
<a name='22'>
   <font color=#447700>! Externals<a name='23'></font>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='24'>
   INTEGER, EXTERNAL :: get_unused_unit<a name='25'>
<a name='26'>
   <font color=#447700>! Local variables<a name='27'></font>
   INTEGER :: ntsloc_temp<a name='28'>
   INTEGER :: i, j, k, iunit<a name='29'>
   REAL :: ts_rx, ts_ry, ts_xlat, ts_xlong, ts_hgt<a name='30'>
   REAL :: known_lat, known_lon<a name='31'>
   CHARACTER (LEN=132) :: message<a name='32'>
   CHARACTER (LEN=24) :: ts_profile_filename<a name='33'>
   CHARACTER (LEN=2), DIMENSION(5) :: ts_file_endings = (/ 'UU', 'VV', 'PH', 'TH', 'QV' /)<a name='34'>
   TYPE (PROJ_INFO) :: ts_proj<a name='35'>
   TYPE (grid_config_rec_type) :: config_flags<a name='36'>
<a name='37'>
   INTEGER :: ids, ide, jds, jde, kds, kde,        &amp;<a name='38'>
              ims, ime, jms, jme, kms, kme,        &amp;<a name='39'>
              ips, ipe, jps, jpe, kps, kpe,        &amp;<a name='40'>
              imsx, imex, jmsx, jmex, kmsx, kmex,  &amp;<a name='41'>
              ipsx, ipex, jpsx, jpex, kpsx, kpex,  &amp;<a name='42'>
              imsy, imey, jmsy, jmey, kmsy, kmey,  &amp;<a name='43'>
              ipsy, ipey, jpsy, jpey, kpsy, kpey<a name='44'>
<a name='45'>
<a name='46'>
   IF ( grid%ntsloc .LE. 0 ) RETURN<a name='47'>
<a name='48'>
#if ((EM_CORE == 1) &amp;&amp; (DA_CORE <font color=#447700>!= 1))<a name='49'></font>
   IF ( grid%dfi_stage == DFI_FST ) THEN<a name='50'>
#endif<a name='51'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_126"> ( grid ,                               &amp;<a name='52'>
                               ids, ide, jds, jde, kds, kde,        &amp;<a name='53'>
                               ims, ime, jms, jme, kms, kme,        &amp;<a name='54'>
                               ips, ipe, jps, jpe, kps, kpe,        &amp;<a name='55'>
                               imsx, imex, jmsx, jmex, kmsx, kmex,  &amp;<a name='56'>
                               ipsx, ipex, jpsx, jpex, kpsx, kpex,  &amp;<a name='57'>
                               imsy, imey, jmsy, jmey, kmsy, kmey,  &amp;<a name='58'>
                               ipsy, ipey, jpsy, jpey, kpsy, kpey )<a name='59'>
   <a name='60'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_87"> ( grid%id , model_config_rec , config_flags )<a name='61'>
   <a name='62'>
      <font color=#447700>! Set up map transformation structure<a name='63'></font>
      CALL <A href='../../html_code/share/module_llxy.F.html#MAP_INIT'>map_init</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_INIT_7">(ts_proj)<a name='64'>
   <a name='65'>
      IF (ips &lt;= 1 .AND. 1 &lt;= ipe .AND. &amp;<a name='66'>
          jps &lt;= 1 .AND. 1 &lt;= jpe) THEN<a name='67'>
#if(NMM_CORE==1)<a name='68'>
         known_lat = grid%hlat(1,1)<a name='69'>
         known_lon = grid%hlon(1,1)<a name='70'>
#else<a name='71'>
         known_lat = grid%xlat(1,1)<a name='72'>
         known_lon = grid%xlong(1,1)<a name='73'>
#endif<a name='74'>
      ELSE<a name='75'>
         known_lat = 9999.<a name='76'>
         known_lon = 9999.<a name='77'>
      END IF<a name='78'>
      known_lat = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_12">(known_lat)<a name='79'>
      known_lon = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_13">(known_lon)<a name='80'>
   <a name='81'>
      <font color=#447700>! Mercator<a name='82'></font>
      IF (config_flags%map_proj == PROJ_MERC) THEN<a name='83'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_27">(PROJ_MERC, ts_proj,               &amp;<a name='84'>
                      truelat1 = config_flags%truelat1, &amp;<a name='85'>
                      lat1     = known_lat,             &amp;<a name='86'>
                      lon1     = known_lon,             &amp;<a name='87'>
                      knowni   = 1.,                    &amp;<a name='88'>
                      knownj   = 1.,                    &amp;<a name='89'>
                      dx       = config_flags%dx)<a name='90'>
   <a name='91'>
      <font color=#447700>! Lambert conformal<a name='92'></font>
      ELSE IF (config_flags%map_proj == PROJ_LC) THEN<a name='93'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_28">(PROJ_LC, ts_proj,                  &amp;<a name='94'>
                      truelat1 = config_flags%truelat1,  &amp;<a name='95'>
                      truelat2 = config_flags%truelat2,  &amp;<a name='96'>
                      stdlon   = config_flags%stand_lon, &amp;<a name='97'>
                      lat1     = known_lat,              &amp;<a name='98'>
                      lon1     = known_lon,              &amp;<a name='99'>
                      knowni   = 1.,                     &amp;<a name='100'>
                      knownj   = 1.,                     &amp;<a name='101'>
                      dx       = config_flags%dx)<a name='102'>
   <a name='103'>
      <font color=#447700>! Polar stereographic<a name='104'></font>
      ELSE IF (config_flags%map_proj == PROJ_PS) THEN<a name='105'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_29">(PROJ_PS, ts_proj,                  &amp;<a name='106'>
                      truelat1 = config_flags%truelat1,  &amp;<a name='107'>
                      stdlon   = config_flags%stand_lon, &amp;<a name='108'>
                      lat1     = known_lat,              &amp;<a name='109'>
                      lon1     = known_lon,              &amp;<a name='110'>
                      knowni   = 1.,                     &amp;<a name='111'>
                      knownj   = 1.,                     &amp;<a name='112'>
                      dx       = config_flags%dx)<a name='113'>
   <a name='114'>
#if (EM_CORE == 1)<a name='115'>
      <font color=#447700>! Cassini (global ARW)<a name='116'></font>
      ELSE IF (config_flags%map_proj == PROJ_CASSINI) THEN<a name='117'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_30">(PROJ_CASSINI, ts_proj,                            &amp;<a name='118'>
                      latinc   = grid%dy*360.0/(2.0*EARTH_RADIUS_M*PI), &amp;<a name='119'>
                      loninc   = grid%dx*360.0/(2.0*EARTH_RADIUS_M*PI), &amp; <a name='120'>
                      lat1     = known_lat,                             &amp;<a name='121'>
                      lon1     = known_lon,                             &amp;<a name='122'>
                      lat0     = config_flags%pole_lat,                 &amp;<a name='123'>
                      lon0     = config_flags%pole_lon,                 &amp;<a name='124'>
                      knowni   = 1.,                                    &amp;<a name='125'>
                      knownj   = 1.,                                    &amp;<a name='126'>
                      stdlon   = config_flags%stand_lon)<a name='127'>
#endif<a name='128'>
<a name='129'>
      <font color=#447700>! Rotated latitude-longitude<a name='130'></font>
      ELSE IF (config_flags%map_proj == PROJ_ROTLL) THEN<a name='131'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_31">(PROJ_ROTLL, ts_proj,                      &amp;<a name='132'>
<font color=#447700>! I have no idea how this should work for NMM nested domains<a name='133'></font>
                      ixdim    = grid%e_we-1,                   &amp;<a name='134'>
                      jydim    = grid%e_sn-1,                   &amp;<a name='135'>
                      phi      = real(grid%e_sn-2)*grid%dy/2.0, &amp;<a name='136'>
                      lambda   = real(grid%e_we-2)*grid%dx,     &amp;<a name='137'>
                      lat1     = config_flags%cen_lat,          &amp;<a name='138'>
                      lon1     = config_flags%cen_lon,          &amp;<a name='139'>
                      latinc   = grid%dy,                       &amp;<a name='140'>
                      loninc   = grid%dx,                       &amp;<a name='141'>
                      stagger  = HH)<a name='142'>
   <a name='143'>
      END IF<a name='144'>
   <a name='145'>
      <font color=#447700>! Determine time series locations for domain<a name='146'></font>
      IF (.NOT. grid%have_calculated_tslocs) THEN<a name='147'>
         grid%have_calculated_tslocs = .TRUE.<a name='148'>
         WRITE(message, '(A43,I3)') 'Computing time series locations for domain ', grid%id<a name='149'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1458">(message)<a name='150'>
   <a name='151'>
         ntsloc_temp = 0<a name='152'>
         DO k=1,grid%ntsloc<a name='153'>
         <a name='154'>
            IF (config_flags%map_proj == 0) THEN  <font color=#447700>! For idealized cases, no map transformation needed<a name='155'></font>
               ts_rx = grid%lattsloc(k)           <font color=#447700>! NB: (x,y) = (lat,lon) rather than (x,y) = (lon,lat)<a name='156'></font>
               ts_ry = grid%lontsloc(k)<a name='157'>
            ELSE<a name='158'>
               CALL <A href='../../html_code/share/module_llxy.F.html#LATLON_TO_IJ'>latlon_to_ij</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LATLON_TO_IJ_7">(ts_proj, grid%lattsloc(k), grid%lontsloc(k), ts_rx, ts_ry)<a name='159'>
            END IF<a name='160'>
            <a name='161'>
<a name='162'>
            ntsloc_temp = ntsloc_temp + 1<a name='163'>
            grid%itsloc(ntsloc_temp) = NINT(ts_rx)<a name='164'>
            grid%jtsloc(ntsloc_temp) = NINT(ts_ry)<a name='165'>
            grid%id_tsloc(ntsloc_temp) = k<a name='166'>
   <a name='167'>
            <font color=#447700>! Is point outside of domain (or on the edge of domain)?<a name='168'></font>
            IF (grid%itsloc(ntsloc_temp) &lt; ids .OR. grid%itsloc(ntsloc_temp) &gt; ide .OR. &amp;<a name='169'>
                grid%jtsloc(ntsloc_temp) &lt; jds .OR. grid%jtsloc(ntsloc_temp) &gt; jde) THEN<a name='170'>
               ntsloc_temp = ntsloc_temp - 1<a name='171'>
   <a name='172'>
            END IF<a name='173'>
   <a name='174'>
         END DO<a name='175'>
   <a name='176'>
         grid%next_ts_time = 1<a name='177'>
   <a name='178'>
         grid%ntsloc_domain = ntsloc_temp<a name='179'>
   <a name='180'>
         DO k=1,grid%ntsloc_domain<a name='181'>
   <a name='182'>
            <font color=#447700>! If location is outside of patch, we need to get lat/lon of TS grid cell from another patch<a name='183'></font>
            IF (grid%itsloc(k) &lt; ips .OR. grid%itsloc(k) &gt; ipe .OR. &amp;<a name='184'>
                grid%jtsloc(k) &lt; jps .OR. grid%jtsloc(k) &gt; jpe) THEN<a name='185'>
               ts_xlat  = 1.E30<a name='186'>
               ts_xlong = 1.E30<a name='187'>
               ts_hgt   = 1.E30<a name='188'>
            ELSE<a name='189'>
#if(NMM_CORE==1)<a name='190'>
               ts_xlat  = grid%hlat(grid%itsloc(k),grid%jtsloc(k))<a name='191'>
               ts_xlong = grid%hlon(grid%itsloc(k),grid%jtsloc(k))<a name='192'>
#else<a name='193'>
               ts_xlat  = grid%xlat(grid%itsloc(k),grid%jtsloc(k))<a name='194'>
               ts_xlong = grid%xlong(grid%itsloc(k),grid%jtsloc(k))<a name='195'>
#endif<a name='196'>
#if (EM_CORE == 1)<a name='197'>
               ts_hgt   = grid%ht(grid%itsloc(k),grid%jtsloc(k))<a name='198'>
#endif<a name='199'>
            END IF<a name='200'>
#if DM_PARALLEL<a name='201'>
            ts_xlat  = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_14">(ts_xlat)<a name='202'>
            ts_xlong = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_15">(ts_xlong)<a name='203'>
            ts_hgt   = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_16">(ts_hgt)<a name='204'>
#endif<a name='205'>
   <a name='206'>
            IF ( wrf_dm_on_monitor() ) THEN<a name='207'>
               iunit = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_4">()<a name='208'>
               IF ( iunit &lt;= 0 ) THEN<a name='209'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1490">('Error in calc_ts_locations: could not find a free Fortran unit.')<a name='210'>
               END IF<a name='211'>
               WRITE(grid%ts_filename(k),'(A)') TRIM(grid%nametsloc(grid%id_tsloc(k)))//'.d00.TS'<a name='212'>
               i = LEN_TRIM(grid%ts_filename(k))<a name='213'>
               WRITE(grid%ts_filename(k)(i-4:i-3),'(I2.2)') grid%id<a name='214'>
               OPEN(UNIT=iunit, FILE=TRIM(grid%ts_filename(k)), FORM='FORMATTED', STATUS='REPLACE')<a name='215'>
#if (EM_CORE == 1)<a name='216'>
               WRITE(UNIT=iunit, &amp;<a name='217'>
                     FMT='(A26,I2,I3,A6,A2,F7.3,A1,F8.3,A3,I4,A1,I4,A3,F7.3,A1,F8.3,A2,F6.1,A7)') &amp;<a name='218'>
                     grid%desctsloc(grid%id_tsloc(k))//' ', grid%id, grid%id_tsloc(k), &amp;<a name='219'>
                     ' '//grid%nametsloc(grid%id_tsloc(k)), &amp;<a name='220'>
                     ' (', grid%lattsloc(grid%id_tsloc(k)), ',', grid%lontsloc(grid%id_tsloc(k)), ') (', &amp;<a name='221'>
                     grid%itsloc(k), ',', grid%jtsloc(k), ') (', &amp;<a name='222'>
                     ts_xlat, ',', ts_xlong, ') ', &amp;<a name='223'>
                     ts_hgt,' meters'<a name='224'>
#else<a name='225'>
               WRITE(UNIT=iunit, &amp;<a name='226'>
                     FMT='(A26,I2,I3,A6,A2,F7.3,A1,F8.3,A3,I4,A1,I4,A3,F7.3,A1,F8.3,A2)') &amp;<a name='227'>
                     grid%desctsloc(grid%id_tsloc(k))//' ', grid%id, grid%id_tsloc(k), &amp;<a name='228'>
                     ' '//grid%nametsloc(grid%id_tsloc(k)), &amp;<a name='229'>
                     ' (', grid%lattsloc(grid%id_tsloc(k)), ',', grid%lontsloc(grid%id_tsloc(k)), ') (', &amp;<a name='230'>
                     grid%itsloc(k), ',', grid%jtsloc(k), ') (', &amp;<a name='231'>
                     ts_xlat, ',', ts_xlong, ') '<a name='232'>
#endif<a name='233'>
               CLOSE(UNIT=iunit)<a name='234'>
<a name='235'>
               ts_profile_filename = grid%ts_filename(k)<a name='236'>
               DO j=1,5<a name='237'>
                  <font color=#447700>! Create the output files for the vertical profiles, one file for each variable<a name='238'></font>
                  iunit = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_5">()<a name='239'>
                  IF ( iunit &lt;= 0 ) THEN<a name='240'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS_LOCATIONS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1491">('Error in calc_ts_locations: could not find a free Fortran unit.')<a name='241'>
                  END IF<a name='242'>
                  i = LEN_TRIM(ts_profile_filename)<a name='243'>
                  WRITE(ts_profile_filename(i-1:i),'(A2)') ts_file_endings(j)<a name='244'>
                  OPEN(UNIT=iunit, FILE=TRIM(ts_profile_filename), FORM='FORMATTED', STATUS='REPLACE')<a name='245'>
#if (EM_CORE == 1)<a name='246'>
                  WRITE(UNIT=iunit, &amp;<a name='247'>
                        FMT='(A26,I2,I3,A6,A2,F7.3,A1,F8.3,A3,I4,A1,I4,A3,F7.3,A1,F8.3,A2,F6.1,A7)') &amp;<a name='248'>
                        grid%desctsloc(grid%id_tsloc(k))//' ', grid%id, grid%id_tsloc(k), &amp;<a name='249'>
                        ' '//grid%nametsloc(grid%id_tsloc(k)), &amp;<a name='250'>
                        ' (', grid%lattsloc(grid%id_tsloc(k)), ',', grid%lontsloc(grid%id_tsloc(k)), ') (', &amp;<a name='251'>
                        grid%itsloc(k), ',', grid%jtsloc(k), ') (', &amp;<a name='252'>
                        ts_xlat, ',', ts_xlong, ') ', &amp;<a name='253'>
                        ts_hgt,' meters'<a name='254'>
#else<a name='255'>
                  WRITE(UNIT=iunit, &amp;<a name='256'>
                        FMT='(A26,I2,I3,A6,A2,F7.3,A1,F8.3,A3,I4,A1,I4,A3,F7.3,A1,F8.3,A2)') &amp;<a name='257'>
                        grid%desctsloc(grid%id_tsloc(k))//' ', grid%id, grid%id_tsloc(k), &amp;<a name='258'>
                        ' '//grid%nametsloc(grid%id_tsloc(k)), &amp;<a name='259'>
                        ' (', grid%lattsloc(grid%id_tsloc(k)), ',', grid%lontsloc(grid%id_tsloc(k)), ') (', &amp;<a name='260'>
                        grid%itsloc(k), ',', grid%jtsloc(k), ') (', &amp;<a name='261'>
                        ts_xlat, ',', ts_xlong, ') '<a name='262'>
#endif               <a name='263'>
                  CLOSE(UNIT=iunit)<a name='264'>
               END DO<a name='265'>
            END IF<a name='266'>
         END DO<a name='267'>
   <a name='268'>
      END IF<a name='269'>
#if ((EM_CORE == 1) &amp;&amp; (DA_CORE <font color=#447700>!= 1))<a name='270'></font>
   END IF<a name='271'>
#endif<a name='272'>
<a name='273'>
END SUBROUTINE calc_ts_locations<a name='274'>
<a name='275'>
<a name='276'>
<A NAME='CALC_TS'><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='277'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_ts</font>( grid ) <A href='../../call_to/CALC_TS.html' TARGET='index'>1</A>,<A href='../../call_from/CALC_TS.html' TARGET='index'>5</A><a name='278'>
<a name='279'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_465"><a name='280'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_124"><a name='281'>
<a name='282'>
   IMPLICIT NONE<a name='283'>
<a name='284'>
   <font color=#447700>! Arguments<a name='285'></font>
   TYPE (domain), INTENT(INOUT) :: grid<a name='286'>
<a name='287'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='288'>
<a name='289'>
   <font color=#447700>! Local variables<a name='290'></font>
   INTEGER :: i, k, mm, n, ix, iy, rc<a name='291'>
   REAL :: earth_u, earth_v,                       &amp;<a name='292'>
           output_t, output_q, clw, xtime_minutes<a name='293'>
   REAL, ALLOCATABLE, DIMENSION(:) :: p8w<a name='294'>
   REAL, ALLOCATABLE, DIMENSION(:) :: earth_u_profile, earth_v_profile<a name='295'>
<a name='296'>
   <font color=#447700>! Parameter ts_model_level:  <a name='297'></font>
       <font color=#447700>! TRUE to output T, Q, and wind at lowest model level<a name='298'></font>
       <font color=#447700>! FALSE to output T and Q at 2-m and wind at 10-m diagnostic levels:<a name='299'></font>
   LOGICAL, PARAMETER :: ts_model_level = .FALSE. <a name='300'>
<a name='301'>
   <font color=#447700>!Allocate the arrays for wind components<a name='302'></font>
#if ( EM_CORE == 1 )   <a name='303'>
   ALLOCATE ( earth_u_profile(grid%max_ts_level), earth_v_profile(grid%max_ts_level) )<a name='304'>
#endif<a name='305'>
<a name='306'>
   IF ( grid%ntsloc_domain .LE. 0 ) RETURN<a name='307'>
<a name='308'>
#if ((EM_CORE == 1) &amp;&amp; (DA_CORE <font color=#447700>!= 1))<a name='309'></font>
   IF ( grid%dfi_opt /= DFI_NODFI .AND. grid%dfi_stage /= DFI_FST ) RETURN<a name='310'>
#endif<a name='311'>
<a name='312'>
   n = grid%next_ts_time<a name='313'>
<a name='314'>
   ALLOCATE(p8w(grid%sm32:grid%em32))<a name='315'>
<a name='316'>
   DO i=1,grid%ntsloc_domain<a name='317'>
<a name='318'>
      ix = grid%itsloc(i)<a name='319'>
      iy = grid%jtsloc(i)<a name='320'>
  <a name='321'>
      IF (grid%sp31 &lt;= ix .AND. ix &lt;= grid%ep31 .AND. &amp;<a name='322'>
          grid%sp33 &lt;= iy .AND. iy &lt;= grid%ep33) THEN<a name='323'>
       <a name='324'>
         IF (ts_model_level) THEN<a name='325'>
   <a name='326'>
            <font color=#447700>!<a name='327'></font>
            <font color=#447700>! Output from the lowest model computational level:<a name='328'></font>
            <font color=#447700>!<a name='329'></font>
#if (EM_CORE == 1)<a name='330'>
            earth_u = grid%u_2(ix,1,iy)*grid%cosa(ix,iy)-grid%v_2(ix,1,iy)*grid%sina(ix,iy)<a name='331'>
            earth_v = grid%v_2(ix,1,iy)*grid%cosa(ix,iy)+grid%u_2(ix,1,iy)*grid%sina(ix,iy)<a name='332'>
            output_t = grid%t_2(ix,1,iy)<a name='333'>
#else<a name='334'>
            earth_u = grid%u(ix,1,iy)<a name='335'>
            earth_v = grid%v(ix,1,iy)<a name='336'>
            output_t = grid%t(ix,1,iy)<a name='337'>
#endif<a name='338'>
            output_q = grid%moist(ix,1,iy,P_QV)<a name='339'>
   <a name='340'>
         ELSE<a name='341'>
   <a name='342'>
            <font color=#447700>!<a name='343'></font>
            <font color=#447700>! Output at 2-m and 10-m diagnostic levels:<a name='344'></font>
            <font color=#447700>!<a name='345'></font>
#if (EM_CORE == 1)<a name='346'>
            DO k=1,grid%max_ts_level<a name='347'>
            earth_u_profile(k) = grid%u_2(ix,k,iy)*grid%cosa(ix,iy)-grid%v_2(ix,k,iy)*grid%sina(ix,iy)<a name='348'>
            earth_v_profile(k) = grid%v_2(ix,k,iy)*grid%cosa(ix,iy)+grid%u_2(ix,k,iy)*grid%sina(ix,iy)<a name='349'>
            END DO<a name='350'>
            earth_u = grid%u10(ix,iy)*grid%cosa(ix,iy)-grid%v10(ix,iy)*grid%sina(ix,iy)<a name='351'>
            earth_v = grid%v10(ix,iy)*grid%cosa(ix,iy)+grid%u10(ix,iy)*grid%sina(ix,iy)<a name='352'>
            output_q = grid%q2(ix,iy)<a name='353'>
#else<a name='354'>
            earth_u = grid%u10(ix,iy)<a name='355'>
            earth_v = grid%v10(ix,iy)<a name='356'>
            output_q = grid%qsfc(ix,iy)<a name='357'>
#endif<a name='358'>
            output_t = grid%t2(ix,iy)<a name='359'>
   <a name='360'>
         END IF<a name='361'>
   <a name='362'>
#if (EM_CORE == 1)<a name='363'>
         <font color=#447700>! Calculate column-integrated liquid/ice  (kg/m^2 or mm)<a name='364'></font>
         CALL <A href='../../html_code/share/wrf_timeseries.F.html#CALC_P8W'>calc_p8w</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P8W_1">(grid, ix, iy, p8w, grid%sm32, grid%em32)<a name='365'>
         clw=0.<a name='366'>
         DO mm = 1, num_moist<a name='367'>
            IF ( (mm == P_QC) .OR. (mm == P_QR) .OR. (mm == P_QI) .OR. &amp;<a name='368'>
                 (mm == P_QS) .OR. (mm == P_QG) ) THEN<a name='369'>
               DO k=grid%sm32,grid%em32-1<a name='370'>
                  clw=clw+grid%moist(ix,k,iy,mm)*(p8w(k)-p8w(k+1))<a name='371'>
               END DO<a name='372'>
           END IF<a name='373'>
         END DO<a name='374'>
         clw = clw / g<a name='375'>
#endif<a name='376'>
   <a name='377'>
         CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_85">( grid, minutesSinceSimulationStart=xtime_minutes )<a name='378'>
         grid%ts_hour(n,i) = xtime_minutes / 60.<a name='379'>
#if (EM_CORE == 1)<a name='380'>
            <font color=#447700>!Create vertical profiles, from lowest model level up to desired level max_ts_level<a name='381'></font>
            DO k=1,grid%max_ts_level<a name='382'>
            grid%ts_u_profile(n,i,k)   = earth_u_profile(k)<a name='383'>
            grid%ts_v_profile(n,i,k)   = earth_v_profile(k)<a name='384'>
            grid%ts_gph_profile(n,i,k) = (grid%phb(ix,k,iy)+grid%ph_2(ix,k,iy))/9.81 <a name='385'>
            grid%ts_th_profile(n,i,k)  = grid%t_2(ix,k,iy) + 300<a name='386'>
            grid%ts_qv_profile(n,i,k)  = grid%moist(ix,k,iy,P_QV)<a name='387'>
            END DO<a name='388'>
#endif<a name='389'>
         grid%ts_u(n,i)    = earth_u<a name='390'>
         grid%ts_v(n,i)    = earth_v<a name='391'>
         grid%ts_t(n,i)    = output_t<a name='392'>
         grid%ts_q(n,i)    = output_q<a name='393'>
         grid%ts_psfc(n,i) = grid%psfc(ix,iy)<a name='394'>
#if (EM_CORE == 1)<a name='395'>
         grid%ts_glw(n,i)  = grid%glw(ix,iy)<a name='396'>
         grid%ts_gsw(n,i)  = grid%gsw(ix,iy)<a name='397'>
         grid%ts_hfx(n,i)  = grid%hfx(ix,iy)<a name='398'>
         grid%ts_lh(n,i)   = grid%lh(ix,iy)<a name='399'>
         grid%ts_clw(n,i)  = clw<a name='400'>
         grid%ts_rainc(n,i)  = grid%rainc(ix,iy)<a name='401'>
         grid%ts_rainnc(n,i) = grid%rainnc(ix,iy)<a name='402'>
         grid%ts_tsk(n,i)  = grid%tsk(ix,iy)<a name='403'>
#else<a name='404'>
         grid%ts_tsk(n,i)  = grid%nmm_tsk(ix,iy)<a name='405'>
#endif<a name='406'>
         grid%ts_tslb(n,i) = grid%tslb(ix,1,iy)<a name='407'>
   <a name='408'>
      ELSE<a name='409'>
#if (EM_CORE == 1 )   <a name='410'>
         DO k=1,grid%max_ts_level<a name='411'>
         grid%ts_u_profile(n,i,k)     = 1.E30<a name='412'>
         grid%ts_v_profile(n,i,k)     = 1.E30<a name='413'>
         grid%ts_gph_profile(n,i,k)   = 1.E30<a name='414'>
         grid%ts_th_profile(n,i,k)    = 1.E30<a name='415'>
         grid%ts_qv_profile(n,i,k)    = 1.E30<a name='416'>
         END DO<a name='417'>
#endif   <a name='418'>
         grid%ts_hour(n,i) = 1.E30<a name='419'>
         grid%ts_u(n,i)    = 1.E30<a name='420'>
         grid%ts_v(n,i)    = 1.E30<a name='421'>
         grid%ts_t(n,i)    = 1.E30<a name='422'>
         grid%ts_q(n,i)    = 1.E30<a name='423'>
         grid%ts_psfc(n,i) = 1.E30<a name='424'>
#if (EM_CORE == 1)<a name='425'>
         grid%ts_glw(n,i)  = 1.E30<a name='426'>
         grid%ts_gsw(n,i)  = 1.E30<a name='427'>
         grid%ts_hfx(n,i)  = 1.E30<a name='428'>
         grid%ts_lh(n,i)   = 1.E30<a name='429'>
         grid%ts_clw(n,i)  = 1.E30<a name='430'>
         grid%ts_rainc(n,i)  = 1.E30<a name='431'>
         grid%ts_rainnc(n,i) = 1.E30<a name='432'>
#endif<a name='433'>
         grid%ts_tsk(n,i)  = 1.E30<a name='434'>
         grid%ts_tslb(n,i) = 1.E30<a name='435'>
   <a name='436'>
      END IF<a name='437'>
   END DO<a name='438'>
<a name='439'>
#if (EM_CORE == 1) <a name='440'>
   DEALLOCATE(p8w, earth_u_profile, earth_v_profile)<a name='441'>
#endif <a name='442'>
 <a name='443'>
   grid%next_ts_time = grid%next_ts_time + 1<a name='444'>
<a name='445'>
   IF ( grid%next_ts_time &gt; grid%ts_buf_size ) CALL <A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS'>write_ts</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_TS_2">(grid)<a name='446'>
<a name='447'>
END SUBROUTINE calc_ts<a name='448'>
<a name='449'>
<a name='450'>
<A NAME='WRITE_TS'><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='451'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>write_ts</font>( grid ) <A href='../../call_to/WRITE_TS.html' TARGET='index'>2</A>,<A href='../../call_from/WRITE_TS.html' TARGET='index'>35</A><a name='452'>
<a name='453'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_466">, ONLY : domain<a name='454'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_202">, ONLY : wrf_dm_min_reals<a name='455'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_214"><a name='456'>
<a name='457'>
   IMPLICIT NONE<a name='458'>
<a name='459'>
   <font color=#447700>! Arguments<a name='460'></font>
   TYPE (domain), INTENT(INOUT) :: grid<a name='461'>
<a name='462'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='463'>
   INTEGER, EXTERNAL :: get_unused_unit<a name='464'>
<a name='465'>
   <font color=#447700>! Local variables<a name='466'></font>
   INTEGER :: i, n, ix, iy, iunit, k<a name='467'>
   REAL, ALLOCATABLE, DIMENSION(:,:) :: ts_buf<a name='468'>
   CHARACTER (LEN=24) :: ts_profile_filename<a name='469'>
   CHARACTER (LEN=26) :: profile_format<a name='470'>
<a name='471'>
   IF ( grid%ntsloc_domain .LE. 0 ) RETURN<a name='472'>
<a name='473'>
#if ((EM_CORE == 1) &amp;&amp; (DA_CORE <font color=#447700>!= 1))<a name='474'></font>
   IF ( grid%dfi_opt /= DFI_NODFI .AND. grid%dfi_stage /= DFI_FST ) RETURN<a name='475'>
#endif<a name='476'>
<a name='477'>
#ifdef DM_PARALLEL<a name='478'>
   ALLOCATE(ts_buf(grid%ts_buf_size,grid%max_ts_locs))<a name='479'>
<a name='480'>
   ts_buf(:,:) = grid%ts_hour(:,:)<a name='481'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_26">(ts_buf(:,:),grid%ts_hour(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='482'>
<a name='483'>
#if (EM_CORE == 1) <a name='484'>
   DO k=1,grid%max_ts_level<a name='485'>
   ts_buf(:,:) = grid%ts_u_profile(:,:,k)<a name='486'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_27">(ts_buf(:,:),grid%ts_u_profile(:,:,k),grid%ts_buf_size*grid%max_ts_locs)<a name='487'>
   END DO<a name='488'>
 <a name='489'>
   DO k=1,grid%max_ts_level<a name='490'>
   ts_buf(:,:) = grid%ts_v_profile(:,:,k)<a name='491'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_28">(ts_buf(:,:),grid%ts_v_profile(:,:,k),grid%ts_buf_size*grid%max_ts_locs)<a name='492'>
   END DO<a name='493'>
<a name='494'>
   DO k=1,grid%max_ts_level<a name='495'>
   ts_buf(:,:) = grid%ts_gph_profile(:,:,k)<a name='496'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_29">(ts_buf(:,:),grid%ts_gph_profile(:,:,k),grid%ts_buf_size*grid%max_ts_locs)<a name='497'>
   END DO<a name='498'>
<a name='499'>
   DO k=1,grid%max_ts_level<a name='500'>
   ts_buf(:,:) = grid%ts_th_profile(:,:,k)<a name='501'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_30">(ts_buf(:,:),grid%ts_th_profile(:,:,k),grid%ts_buf_size*grid%max_ts_locs)<a name='502'>
   END DO<a name='503'>
<a name='504'>
   DO k=1,grid%max_ts_level<a name='505'>
   ts_buf(:,:) = grid%ts_qv_profile(:,:,k)<a name='506'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_31">(ts_buf(:,:),grid%ts_qv_profile(:,:,k),grid%ts_buf_size*grid%max_ts_locs)<a name='507'>
   END DO<a name='508'>
#endif         <a name='509'>
   ts_buf(:,:) = grid%ts_u(:,:)<a name='510'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_32">(ts_buf(:,:),grid%ts_u(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='511'>
<a name='512'>
   ts_buf(:,:) = grid%ts_v(:,:)<a name='513'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_33">(ts_buf(:,:),grid%ts_v(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='514'>
<a name='515'>
   ts_buf(:,:) = grid%ts_t(:,:)<a name='516'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_34">(ts_buf(:,:),grid%ts_t(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='517'>
<a name='518'>
   ts_buf(:,:) = grid%ts_q(:,:)<a name='519'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_35">(ts_buf(:,:),grid%ts_q(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='520'>
<a name='521'>
   ts_buf(:,:) = grid%ts_psfc(:,:)<a name='522'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_36">(ts_buf(:,:),grid%ts_psfc(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='523'>
<a name='524'>
#if (EM_CORE == 1)<a name='525'>
   ts_buf(:,:) = grid%ts_glw(:,:)<a name='526'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_37">(ts_buf(:,:),grid%ts_glw(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='527'>
<a name='528'>
   ts_buf(:,:) = grid%ts_gsw(:,:)<a name='529'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_38">(ts_buf(:,:),grid%ts_gsw(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='530'>
<a name='531'>
   ts_buf(:,:) = grid%ts_hfx(:,:)<a name='532'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_39">(ts_buf(:,:),grid%ts_hfx(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='533'>
<a name='534'>
   ts_buf(:,:) = grid%ts_lh(:,:)<a name='535'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_40">(ts_buf(:,:),grid%ts_lh(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='536'>
<a name='537'>
   ts_buf(:,:) = grid%ts_clw(:,:)<a name='538'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_41">(ts_buf(:,:),grid%ts_clw(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='539'>
<a name='540'>
   ts_buf(:,:) = grid%ts_rainc(:,:)<a name='541'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_42">(ts_buf(:,:),grid%ts_rainc(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='542'>
<a name='543'>
   ts_buf(:,:) = grid%ts_rainnc(:,:)<a name='544'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_43">(ts_buf(:,:),grid%ts_rainnc(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='545'>
#endif<a name='546'>
<a name='547'>
   ts_buf(:,:) = grid%ts_tsk(:,:)<a name='548'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_44">(ts_buf(:,:),grid%ts_tsk(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='549'>
<a name='550'>
   ts_buf(:,:) = grid%ts_tslb(:,:)<a name='551'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS'>wrf_dm_min_reals</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REALS_45">(ts_buf(:,:),grid%ts_tslb(:,:),grid%ts_buf_size*grid%max_ts_locs)<a name='552'>
<a name='553'>
   DEALLOCATE(ts_buf)<a name='554'>
#endif<a name='555'>
<a name='556'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='557'>
<a name='558'>
      iunit = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_6">()<a name='559'>
      IF ( iunit &lt;= 0 ) THEN<a name='560'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1492">('Error in write_ts: could not find a free Fortran unit.')<a name='561'>
      END IF<a name='562'>
<a name='563'>
      DO i=1,grid%ntsloc_domain<a name='564'>
<a name='565'>
         ix = grid%itsloc(i)<a name='566'>
         iy = grid%jtsloc(i)<a name='567'>
<a name='568'>
         OPEN(UNIT=iunit, FILE=TRIM(grid%ts_filename(i)), STATUS='unknown', POSITION='append', FORM='formatted')<a name='569'>
<a name='570'>
         DO n=1,grid%next_ts_time - 1<a name='571'>
<a name='572'>
#if (EM_CORE == 1)<a name='573'>
            WRITE(UNIT=iunit,FMT='(i2,f13.6,i5,i5,i5,1x,14(f13.5,1x))')  &amp;<a name='574'>
                              grid%id, grid%ts_hour(n,i),                &amp;<a name='575'>
                              grid%id_tsloc(i), ix, iy,                  &amp;<a name='576'>
                              grid%ts_t(n,i),                            &amp;<a name='577'>
                              grid%ts_q(n,i),                            &amp;<a name='578'>
                              grid%ts_u(n,i),                            &amp;<a name='579'>
                              grid%ts_v(n,i),                            &amp;<a name='580'>
                              grid%ts_psfc(n,i),                         &amp;<a name='581'>
                              grid%ts_glw(n,i),                          &amp;<a name='582'>
                              grid%ts_gsw(n,i),                          &amp;<a name='583'>
                              grid%ts_hfx(n,i),                          &amp;<a name='584'>
                              grid%ts_lh(n,i),                           &amp;<a name='585'>
                              grid%ts_tsk(n,i),                          &amp;<a name='586'>
                              grid%ts_tslb(n,i),                         &amp;<a name='587'>
                              grid%ts_rainc(n,i),                        &amp;<a name='588'>
                              grid%ts_rainnc(n,i),                       &amp;<a name='589'>
                              grid%ts_clw(n,i)<a name='590'>
#else<a name='591'>
            WRITE(UNIT=iunit,FMT='(i2,f13.6,i5,i5,i5,1x,7(f13.5,1x))')   &amp;<a name='592'>
                              grid%id, grid%ts_hour(n,i),                &amp;<a name='593'>
                              grid%id_tsloc(i), ix, iy,                  &amp;<a name='594'>
                              grid%ts_t(n,i),                            &amp;<a name='595'>
                              grid%ts_q(n,i),                            &amp;<a name='596'>
                              grid%ts_u(n,i),                            &amp;<a name='597'>
                              grid%ts_v(n,i),                            &amp;<a name='598'>
                              grid%ts_psfc(n,i),                         &amp;<a name='599'>
                              grid%ts_tsk(n,i),                          &amp;<a name='600'>
                              grid%ts_tslb(n,i)<a name='601'>
#endif<a name='602'>
         END DO<a name='603'>
         CLOSE(UNIT=iunit)<a name='604'>
         <a name='605'>
         <font color=#447700>!Set write format for vertical profiles, depending on the highest model level of interest<a name='606'></font>
#if (EM_CORE == 1)   <a name='607'>
         profile_format = '(f13.6,1x,000(f13.5,1x))'<a name='608'>
         k= LEN_TRIM(profile_format)<a name='609'>
         WRITE(profile_format(12:14),'(I3.3)') grid%max_ts_level<a name='610'>
<a name='611'>
         <font color=#447700>!Write u wind component profile to separate file<a name='612'></font>
         iunit = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_7">()<a name='613'>
            IF ( iunit &lt;= 0 ) THEN<a name='614'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1493">('Error in write_ts: could not find a free Fortran unit.')<a name='615'>
            END IF<a name='616'>
         <font color=#447700>!Recreate filename for u wind component profiles<a name='617'></font>
         WRITE(ts_profile_filename,'(A)') TRIM(grid%nametsloc(grid%id_tsloc(i)))//'.d00.TS'<a name='618'>
         k = LEN_TRIM(ts_profile_filename)<a name='619'>
         WRITE(ts_profile_filename(k-4:k-3),'(I2.2)') grid%id<a name='620'>
         WRITE(ts_profile_filename(k-1:k),'(A2)') 'UU'<a name='621'>
         <a name='622'>
         OPEN(UNIT=iunit, FILE=TRIM(ts_profile_filename), STATUS='unknown', POSITION='append', FORM='formatted')<a name='623'>
<a name='624'>
         DO n=1,grid%next_ts_time - 1<a name='625'>
<a name='626'>
            WRITE(UNIT=iunit,FMT=profile_format)           &amp;<a name='627'>
                              grid%ts_hour(n,i),                      &amp;<a name='628'>
                              grid%ts_u_profile(n,i,1:grid%max_ts_level)                                       <a name='629'>
         END DO<a name='630'>
         CLOSE(UNIT=iunit)<a name='631'>
<a name='632'>
         <font color=#447700>!Write v wind component profile to separate file<a name='633'></font>
         iunit = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_8">()<a name='634'>
            IF ( iunit &lt;= 0 ) THEN<a name='635'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1494">('Error in write_ts: could not find a free Fortran unit.')<a name='636'>
            END IF<a name='637'>
         <font color=#447700>!Recreate filename for v wind component profiles<a name='638'></font>
         k = LEN_TRIM(ts_profile_filename)<a name='639'>
         WRITE(ts_profile_filename(k-1:k),'(A2)') 'VV'<a name='640'>
         <a name='641'>
         OPEN(UNIT=iunit, FILE=TRIM(ts_profile_filename), STATUS='unknown', POSITION='append', FORM='formatted')<a name='642'>
<a name='643'>
         DO n=1,grid%next_ts_time - 1<a name='644'>
<a name='645'>
            WRITE(UNIT=iunit,FMT=profile_format)  &amp;<a name='646'>
                              grid%ts_hour(n,i),             &amp; <a name='647'>
                              grid%ts_v_profile(n,i,1:grid%max_ts_level)                                       <a name='648'>
         END DO<a name='649'>
         CLOSE(UNIT=iunit)<a name='650'>
<a name='651'>
         <font color=#447700>!Write geopotential height profile to separate file<a name='652'></font>
         iunit = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_9">()<a name='653'>
            IF ( iunit &lt;= 0 ) THEN<a name='654'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1495">('Error in write_ts: could not find a free Fortran unit.')<a name='655'>
            END IF<a name='656'>
         <font color=#447700>!Recreate filename for geopotential height profiles<a name='657'></font>
         k = LEN_TRIM(ts_profile_filename)<a name='658'>
         WRITE(ts_profile_filename(k-1:k),'(A2)') 'PH'<a name='659'>
         <a name='660'>
         OPEN(UNIT=iunit, FILE=TRIM(ts_profile_filename), STATUS='unknown', POSITION='append', FORM='formatted')<a name='661'>
<a name='662'>
         DO n=1,grid%next_ts_time - 1<a name='663'>
<a name='664'>
            WRITE(UNIT=iunit,FMT=profile_format)  &amp;<a name='665'>
                              grid%ts_hour(n,i),             &amp;<a name='666'>
                              grid%ts_gph_profile(n,i,1:grid%max_ts_level)                                       <a name='667'>
         END DO<a name='668'>
         CLOSE(UNIT=iunit)<a name='669'>
         <a name='670'>
         <font color=#447700>!Write potential temperature profile to separate file<a name='671'></font>
         iunit = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_10">()<a name='672'>
            IF ( iunit &lt;= 0 ) THEN<a name='673'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1496">('Error in write_ts: could not find a free Fortran unit.')<a name='674'>
            END IF<a name='675'>
         <font color=#447700>!Recreate filename for potential temperature profiles<a name='676'></font>
         k = LEN_TRIM(ts_profile_filename)<a name='677'>
         WRITE(ts_profile_filename(k-1:k),'(A2)') 'TH'<a name='678'>
         <a name='679'>
         OPEN(UNIT=iunit, FILE=TRIM(ts_profile_filename), STATUS='unknown', POSITION='append', FORM='formatted')<a name='680'>
<a name='681'>
         DO n=1,grid%next_ts_time - 1<a name='682'>
<a name='683'>
            WRITE(UNIT=iunit,FMT=profile_format)   &amp;<a name='684'>
                              grid%ts_hour(n,i),              &amp;<a name='685'>
                              grid%ts_th_profile(n,i,1:grid%max_ts_level)                                       <a name='686'>
         END DO<a name='687'>
         CLOSE(UNIT=iunit) <a name='688'>
       <a name='689'>
         <font color=#447700>!Write water vapor mixing ratio profile to separate file<a name='690'></font>
         iunit = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_11">()<a name='691'>
            IF ( iunit &lt;= 0 ) THEN<a name='692'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1497">('Error in write_ts: could not find a free Fortran unit.')<a name='693'>
            END IF<a name='694'>
         <font color=#447700>!Recreate filename for water vapor mixing ratio profiles<a name='695'></font>
         k = LEN_TRIM(ts_profile_filename)<a name='696'>
         WRITE(ts_profile_filename(k-1:k),'(A2)') 'QV'<a name='697'>
         <a name='698'>
         OPEN(UNIT=iunit, FILE=TRIM(ts_profile_filename), STATUS='unknown', POSITION='append', FORM='formatted')<a name='699'>
<a name='700'>
         DO n=1,grid%next_ts_time - 1<a name='701'>
<a name='702'>
            WRITE(UNIT=iunit,FMT=profile_format)  &amp;<a name='703'>
                              grid%ts_hour(n,i),             &amp;<a name='704'>
                              grid%ts_qv_profile(n,i,1:grid%max_ts_level)                                       <a name='705'>
         END DO<a name='706'>
         CLOSE(UNIT=iunit)<a name='707'>
#endif   <a name='708'>
<a name='709'>
      END DO<a name='710'>
<a name='711'>
   END IF<a name='712'>
<a name='713'>
   grid%next_ts_time = 1<a name='714'>
<a name='715'>
END SUBROUTINE write_ts<a name='716'>
<a name='717'>
<a name='718'>
#if (EM_CORE == 1)<a name='719'>
<A NAME='CALC_P8W'><A href='../../html_code/share/wrf_timeseries.F.html#CALC_P8W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='720'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_p8w</font>(grid, ix, iy, p8w, k_start, k_end) <A href='../../call_to/CALC_P8W.html' TARGET='index'>1</A>,<A href='../../call_from/CALC_P8W.html' TARGET='index'>2</A><a name='721'>
<a name='722'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_P8W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_467"><a name='723'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/wrf_timeseries.F.html#CALC_P8W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_125"><a name='724'>
<a name='725'>
   IMPLICIT NONE<a name='726'>
<a name='727'>
   <font color=#447700>! Arguments<a name='728'></font>
   TYPE (domain), INTENT(IN) :: grid<a name='729'>
   INTEGER, INTENT(IN) :: ix, iy, k_start, k_end<a name='730'>
   REAL, DIMENSION(k_start:k_end), INTENT(OUT) :: p8w<a name='731'>
<a name='732'>
   <font color=#447700>! Local variables<a name='733'></font>
   INTEGER :: k<a name='734'>
   REAL    :: z0, z1, z2, w1, w2 <a name='735'>
   REAL, DIMENSION(k_start:k_end)   :: z_at_w<a name='736'>
   REAL, DIMENSION(k_start:k_end-1) :: z<a name='737'>
<a name='738'>
<a name='739'>
   DO k = k_start, k_end<a name='740'>
      z_at_w(k) = (grid%phb(ix,k,iy)+grid%ph_2(ix,k,iy))/g<a name='741'>
   END DO<a name='742'>
<a name='743'>
   DO k = k_start, k_end-1<a name='744'>
      z(k) = 0.5*(z_at_w(k) + z_at_w(k+1))<a name='745'>
   END DO<a name='746'>
<a name='747'>
   DO k = k_start+1, k_end-1<a name='748'>
      p8w(k) = grid%fnm(k)*(grid%p(ix,k,iy)+grid%pb(ix,k,iy)) + &amp;<a name='749'>
               grid%fnp(k)*(grid%p(ix,k-1,iy)+grid%pb(ix,k-1,iy))<a name='750'>
   END DO<a name='751'>
<a name='752'>
   z0 = z_at_w(k_start)<a name='753'>
   z1 = z(k_start)<a name='754'>
   z2 = z(k_start+1)<a name='755'>
   w1 = (z0 - z2)/(z1 - z2)<a name='756'>
   w2 = 1. - w1<a name='757'>
   p8w(k_start) = w1*(grid%p(ix,k_start,iy)+grid%pb(ix,k_start,iy)) + &amp;<a name='758'>
                  w2*(grid%p(ix,k_start+1,iy)+grid%pb(ix,k_start+1,iy))<a name='759'>
<a name='760'>
   z0 = z_at_w(k_end)<a name='761'>
   z1 = z(k_end-1)<a name='762'>
   z2 = z(k_end-2)<a name='763'>
   w1 = (z0 - z2)/(z1 - z2)<a name='764'>
   w2 = 1. - w1<a name='765'>
   p8w(k_end) = exp(w1*log(grid%p(ix,k_end-1,iy)+grid%pb(ix,k_end-1,iy)) + &amp;<a name='766'>
                    w2*log(grid%p(ix,k_end-2,iy)+grid%pb(ix,k_end-2,iy)))<a name='767'>
<a name='768'>
END SUBROUTINE calc_p8w<a name='769'>
#endif<a name='770'>
</pre></body></html>