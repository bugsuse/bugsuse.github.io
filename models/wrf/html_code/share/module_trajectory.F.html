<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
   <a name='2'>
<A NAME='MODULE_TRAJECTORY'><A href='../../html_code/share/module_trajectory.F.html#MODULE_TRAJECTORY' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
   <font color=#993300>module </font><font color=#cc0000>module_trajectory</font> <A href='../../call_to/MODULE_TRAJECTORY.html' TARGET='index'>3</A><a name='4'>
<a name='5'>
   use <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/share/module_trajectory.F.html#module_trajectory.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_62">,  only : max_domains<a name='6'>
#if( EM_CORE == 1 )<a name='7'>
   use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_trajectory.F.html#module_trajectory.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_196">, only : num_chem<a name='8'>
#endif<a name='9'>
#if( NMM_CORE == 1 )<a name='10'>
   CONTAINS<a name='11'>
<a name='12'>
<A NAME='TRAJECTORY_INIT'><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='13'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajectory_init</font>( grid, config_flags, &amp; <A href='../../call_to/TRAJECTORY_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/TRAJECTORY_INIT.html' TARGET='index'>61</A><a name='14'>
                               ims,ime, jms,jme, kms,kme )<a name='15'>
<a name='16'>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_434"><a name='17'>
   use <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_281">,         only : grid_config_rec_type<a name='18'>
<a name='19'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='20'></font>
<font color=#447700>!  dummy arguments<a name='21'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='22'></font>
   integer, intent(in)      :: ims,ime, jms,jme, kms,kme<a name='23'>
   type(domain), intent(inout)            :: grid<a name='24'>
   type(grid_config_rec_type), intent(in) :: config_flags<a name='25'>
<a name='26'>
   end subroutine trajectory_init<a name='27'>
<a name='28'>
<A NAME='TRAJECTORY_DRIVER'><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='29'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajectory_driver</font>( grid ) <A href='../../call_to/TRAJECTORY_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/TRAJECTORY_DRIVER.html' TARGET='index'>26</A><a name='30'>
<a name='31'>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_435"><a name='32'>
<a name='33'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='34'></font>
<font color=#447700>!  dummy arguments<a name='35'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='36'></font>
   type(domain), intent(in) :: grid<a name='37'>
<a name='38'>
   end subroutine trajectory_driver<a name='39'>
<a name='40'>
#elif( EM_CORE == 1 )<a name='41'>
<a name='42'>
   implicit none<a name='43'>
<a name='44'>
   private<a name='45'>
   public :: trajectory_init<a name='46'>
#ifdef NETCDF<a name='47'>
   public :: trajectory_driver<a name='48'>
   public :: trajectory_dchm_tstep_init<a name='49'>
   public :: trajectory_dchm_tstep_set<a name='50'>
#endif<a name='51'>
   public :: traject<a name='52'>
   public :: traj_cnt<a name='53'>
<a name='54'>
   integer, parameter :: vals_max = 1000<a name='55'>
   integer, parameter :: traj_max = 1000<a name='56'>
   integer, parameter :: var_max  = 100<a name='57'>
   integer, parameter :: pkg_max  = 6<a name='58'>
   integer, parameter :: dyn_max  = 8<a name='59'>
   integer, parameter :: chm_pkg  = 1<a name='60'>
   integer, parameter :: hyd_pkg  = 2<a name='61'>
   integer, parameter :: trc_pkg  = 3<a name='62'>
   integer, parameter :: dyn_pkg  = 4<a name='63'>
   integer, parameter :: msc_pkg  = 5<a name='64'>
   integer, parameter :: dchm_pkg = 6<a name='65'>
   real, parameter    :: missing_val = -9999.<a name='66'>
   real, parameter    :: zero_val    = 0.<a name='67'>
   <a name='68'>
   integer :: n_dom        <font color=#447700>! domain count<a name='69'></font>
   integer, pointer :: n_vals                         <font color=#447700>! wrking count of time points in buffer<a name='70'></font>
   integer, target  :: n_vals_dm(max_domains)         <font color=#447700>! count of time points in buffer per domain<a name='71'></font>
   integer, target  :: n_dchm_dm(max_domains)         <font color=#447700>! count of dchm variables in  buffer per domain<a name='72'></font>
   integer, allocatable, target :: num_msc_dm(:)      <font color=#447700>! number misc species<a name='73'></font>
   integer, allocatable, target :: dchm_buf_ndx_dm(:,:)  <font color=#447700>! dchm buffer indices<a name='74'></font>
   integer, pointer :: dchm_buf_ndx(:)<a name='75'>
   integer :: offset       <font color=#447700>! into variable arrays<a name='76'></font>
<a name='77'>
   type default<a name='78'>
     character(len=19) :: start_time<a name='79'>
     character(len=19) :: stop_time<a name='80'>
     character(len=32) :: chm_name(var_max)<a name='81'>
     character(len=32) :: hyd_name(var_max)<a name='82'>
     character(len=32) :: trc_name(var_max)<a name='83'>
     character(len=32) :: dyn_name(var_max)<a name='84'>
     character(len=32) :: msc_name(var_max)<a name='85'>
     character(len=32) :: dchm_name(var_max)<a name='86'>
   end type default<a name='87'>
<a name='88'>
   type base<a name='89'>
     real    :: lon<a name='90'>
     real    :: lat<a name='91'>
     real    :: lev<a name='92'>
     real    :: x, y<a name='93'>
     real    :: traj_var(var_max)<a name='94'>
     integer :: n_chm_var<a name='95'>
     integer :: n_ct_var<a name='96'>
     integer :: n_hyd_var<a name='97'>
     integer :: n_trc_var<a name='98'>
     integer :: n_dyn_var<a name='99'>
     integer :: n_msc_var<a name='100'>
     integer :: n_dchm_var<a name='101'>
     integer :: chm_ndx(var_max)<a name='102'>
     integer :: hyd_ndx(var_max)<a name='103'>
     integer :: trc_ndx(var_max)<a name='104'>
     integer :: dyn_ndx(var_max)<a name='105'>
     integer :: msc_ndx(var_max)<a name='106'>
     integer :: dchm_ndx(var_max)<a name='107'>
     character(len=19) :: start_time<a name='108'>
     character(len=19) :: stop_time<a name='109'>
     character(len=32) :: chm_spc(var_max)<a name='110'>
     character(len=32) :: hyd_spc(var_max)<a name='111'>
     character(len=32) :: trc_spc(var_max)<a name='112'>
     character(len=32) :: dyn_var(var_max)<a name='113'>
     character(len=32) :: msc_var(var_max)<a name='114'>
     character(len=32) :: dchm_spc(var_max)<a name='115'>
     logical :: in_dom<a name='116'>
     logical :: in_patch<a name='117'>
     logical :: is_stationary<a name='118'>
     logical :: z_is_agl<a name='119'>
     logical :: chm_is_gas(var_max)<a name='120'>
   end type base<a name='121'>
<a name='122'>
   type buffer<a name='123'>
     real    :: trj_i(vals_max)<a name='124'>
     real    :: trj_j(vals_max)<a name='125'>
     real    :: trj_k(vals_max)<a name='126'>
     real    :: trj_lons(vals_max)<a name='127'>
     real    :: trj_lats(vals_max)<a name='128'>
     real, allocatable :: chm_vals(:,:)<a name='129'>
     real, allocatable :: trc_vals(:,:)<a name='130'>
     real, allocatable :: hyd_vals(:,:)<a name='131'>
     real, allocatable :: dyn_vals(:,:)<a name='132'>
     real, allocatable :: msc_vals(:,:)<a name='133'>
     real, allocatable :: dchm_vals(:,:)<a name='134'>
     character(len=19) :: times(vals_max)<a name='135'>
   end type buffer<a name='136'>
<a name='137'>
   type statevar<a name='138'>
     character(len=80) :: Varname<a name='139'>
     character(len=80) :: Description<a name='140'>
     character(len=80) :: Units<a name='141'>
     character(len=10) :: MemOrd<a name='142'>
     character(len=10) :: Stagger<a name='143'>
     integer           :: Ndim<a name='144'>
     real, pointer     :: rfield_2d(:,:)<a name='145'>
     real, pointer     :: rfield_3d(:,:,:)<a name='146'>
   end type statevar<a name='147'>
<a name='148'>
   integer,    allocatable           :: traj_cnt(:)<a name='149'>
   type(base), allocatable, target   :: traject(:,:)<a name='150'>
   type(base), pointer               :: trjects(:)<a name='151'>
   type(buffer), allocatable, target :: trj_buff(:,:)<a name='152'>
   type(buffer), pointer             :: trj_pbf(:)<a name='153'>
   type(statevar), allocatable, target :: St_Vars_dm(:,:)<a name='154'>
   type(statevar), pointer             :: St_Vars(:)<a name='155'>
<a name='156'>
   real, allocatable  :: dchm_buff(:,:,:,:)<a name='157'>
<a name='158'>
   character(len=256) :: dyn_var_lst(dyn_max)<a name='159'>
   character(len=32)  :: dyn_var_desc_att(dyn_max)<a name='160'>
   character(len=32)  :: dyn_var_unit_att(dyn_max)<a name='161'>
   character(len=4)   :: pkg_tag(pkg_max) = (/ 'chm ', 'hyd ', 'trc ', 'dyn ', 'msc ', 'dchm' /)<a name='162'>
<a name='163'>
   logical                      :: do_chemstep<a name='164'>
   logical, allocatable, target :: pkg_has_vars_dm(:,:,:)<a name='165'>
   logical, pointer             :: pkg_has_vars(:,:)<a name='166'>
   logical, allocatable, target :: trj_msk_dm(:,:,:,:)<a name='167'>
   logical, pointer             :: trj_msk(:,:)<a name='168'>
   logical, allocatable, target :: St_Vars_msk_dm(:,:)<a name='169'>
   logical, pointer             :: St_Vars_msk(:)<a name='170'>
   logical, allocatable, target :: dchm_msk_dm(:,:)<a name='171'>
   logical, pointer             :: dchm_msk(:)<a name='172'>
   logical, allocatable         :: is_initialized(:)<a name='173'>
   logical, allocatable         :: dm_has_traj(:)<a name='174'>
<a name='175'>
   CONTAINS<a name='176'>
<a name='177'>
<A NAME='TRAJECTORY_INIT'><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='178'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajectory_init</font>( grid, config_flags, &amp; <A href='../../call_to/TRAJECTORY_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/TRAJECTORY_INIT.html' TARGET='index'>61</A><a name='179'>
                               ims,ime, jms,jme, kms,kme )<a name='180'>
<a name='181'>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_436"><a name='182'>
   use <A href='../../html_code/share/module_llxy.F.html#MODULE_LLXY'>module_llxy</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LLXY_8">,              only : proj_info, latlon_to_ij<a name='183'>
   use <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_282">,         only : grid_config_rec_type<a name='184'>
   use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_197">, only : no_trajectory, param_first_scalar, num_chem, num_moist, num_tracer<a name='185'>
   use <A href='../../html_code/frame/module_configure.F.html#MODULE_SCALAR_TABLES'>module_scalar_tables</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SCALAR_TABLES_3">,     only : chem_dname_table, moist_dname_table, tracer_dname_table<a name='186'>
   use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_118">,   only : g<a name='187'>
   use <A href='../../html_code/frame/module_domain_type.F.html#MODULE_DOMAIN_TYPE'>module_domain_type</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_TYPE_11">,       only : fieldlist<a name='188'>
#ifdef DM_PARALLEL<a name='189'>
   use <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_196">,                only : wrf_dm_sum_integer, wrf_dm_max_real<a name='190'>
#endif<a name='191'>
<a name='192'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='193'></font>
<font color=#447700>!  dummy arguments<a name='194'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='195'></font>
   integer, intent(in)      :: ims,ime, jms,jme, kms,kme<a name='196'>
   type(domain), intent(inout)            :: grid<a name='197'>
   type(grid_config_rec_type), intent(in) :: config_flags<a name='198'>
<a name='199'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='200'></font>
<font color=#447700>!  local variables<a name='201'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='202'></font>
   integer :: astat<a name='203'>
   integer :: dm<a name='204'>
   integer, pointer :: num_msc      <font color=#447700>! number misc species<a name='205'></font>
   integer, pointer :: n_dchm       <font color=#447700>! number dchm buffer species<a name='206'></font>
   integer :: ierr, ios<a name='207'>
   integer :: i, j, k, k1, m, m1, m2<a name='208'>
   integer :: i_end, j_end, u_lim<a name='209'>
   integer :: n, pkg, trj<a name='210'>
   integer :: n_traj, n_traj_1<a name='211'>
   integer :: p_size<a name='212'>
   integer :: unitno<a name='213'>
   integer :: ids,ide, jds,jde, kds,kde<a name='214'>
   integer :: ips,ipe, jps,jpe, kps,kpe<a name='215'>
   integer :: dbg_lvl<a name='216'>
   integer :: target<a name='217'>
   integer :: n_def_var(pkg_max)<a name='218'>
   real    :: x, y<a name='219'>
   real    :: z_dm_bot, z_dm_top<a name='220'>
   real    :: z(kms:kme-1)<a name='221'>
   real    :: z_at_w(ims:ime,kms:kme,jms:jme)<a name='222'>
   character(len=256), allocatable :: msc_tbl(:)<a name='223'>
   character(len=32)  :: var_name<a name='224'>
   character(len=128) :: filename<a name='225'>
   character(len=256) :: err_mes<a name='226'>
   character(len=32)  :: wrk_var_name<a name='227'>
   character(len=32)  :: wrk_chr(var_max)<a name='228'>
   character(len=32)  :: wrk_def_name(var_max)<a name='229'>
   logical :: exists<a name='230'>
   logical :: is_root_proc<a name='231'>
   logical :: rstrt<a name='232'>
   logical :: mask(var_max)<a name='233'>
   logical :: trj_mask(traj_max)<a name='234'>
<a name='235'>
   type(grid_config_rec_type) :: config_temp<a name='236'>
   type(proj_info)            :: proj<a name='237'>
<a name='238'>
   type(default) :: traj_def<a name='239'>
   type(base)    :: traj_type(traj_max)<a name='240'>
<a name='241'>
   logical, external :: wrf_dm_on_monitor<a name='242'>
   integer, external :: get_unused_unit<a name='243'>
<a name='244'>
   namelist / traj_spec /    traj_type<a name='245'>
   namelist / traj_default / traj_def<a name='246'>
<a name='247'>
#ifndef NETCDF<a name='248'>
   call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1453">( 'trajectory_init: requires netcdf' )<a name='249'>
#endif<a name='250'>
<a name='251'>
   offset = param_first_scalar - 1<a name='252'>
<a name='253'>
   if( .not. allocated( dm_has_traj ) ) then<a name='254'>
     call nl_get_max_dom( 1,n_dom )<a name='255'>
     allocate( dm_has_traj(n_dom),traj_cnt(n_dom),stat=astat )<a name='256'>
     if( astat /= 0 ) then<a name='257'>
       write(err_mes,'(''trajectory_init('',i2.2,''): failed to allocate dm_has_traj,traj_cnt; error = '',i6)') dm,astat<a name='258'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1454">( trim( err_mes  ) )<a name='259'>
     endif<a name='260'>
     traj_cnt(:) = 0<a name='261'>
   endif<a name='262'>
<a name='263'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='264'></font>
<font color=#447700>!  check for trajectory option<a name='265'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='266'></font>
   if( grid%traj_opt == no_trajectory ) then<a name='267'>
     write(err_mes,'(''trajectory_init('',i2.2,''): traj_opt = no_trajectory'')') grid%id<a name='268'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1386">( trim(err_mes) )<a name='269'>
     dm_has_traj(:) = .false.<a name='270'>
     return<a name='271'>
   endif<a name='272'>
<a name='273'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='274'></font>
<font color=#447700>!  domain requests trajectories<a name='275'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='276'></font>
   dm = grid%id<a name='277'>
   if( .not. config_flags%dm_has_traj ) then<a name='278'>
     write(err_mes,'(''trajectory_init('',i2.2,''): no trajectory calculation for domain '',i2.2)') dm,dm<a name='279'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1387">( trim( err_mes ) )<a name='280'>
     dm_has_traj(dm) = .false.<a name='281'>
     return<a name='282'>
   else<a name='283'>
     dm_has_traj(dm) = .true.<a name='284'>
   endif<a name='285'>
<a name='286'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='287'></font>
<font color=#447700>!  set domain count, restarting?<a name='288'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='289'></font>
   call nl_get_restart( dm,rstrt )<a name='290'>
   if( .not. allocated( traject ) ) then<a name='291'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='292'></font>
<font color=#447700>!  allocate module variables<a name='293'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='294'></font>
     allocate( traject(traj_max,n_dom), &amp;<a name='295'>
               pkg_has_vars_dm(traj_max,pkg_max,n_dom), &amp;<a name='296'>
               num_msc_dm(n_dom), is_initialized(n_dom),stat=astat )<a name='297'>
     if( astat /= 0 ) then<a name='298'>
       write(err_mes,'(''trajectory_init('',i2.2,''): failed to allocate traject...num_msc_dm; error = '',i6)') dm,astat<a name='299'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1455">( trim( err_mes  ) )<a name='300'>
     endif<a name='301'>
     is_initialized(:) = .false.<a name='302'>
   endif<a name='303'>
<a name='304'>
   if( is_initialized(dm) ) then<a name='305'>
     return<a name='306'>
   endif<a name='307'>
<a name='308'>
   trjects =&gt; traject(:,dm)<a name='309'>
<a name='310'>
   call <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_114">( grid ,                   &amp;<a name='311'>
                           ids, ide, jds, jde, kds, kde, &amp;<a name='312'>
                           n,n,  n,n, n,n,          &amp;<a name='313'>
                           ips, ipe, jps, jpe, kps, kpe    )<a name='314'>
<a name='315'>
   n_vals      =&gt; n_vals_dm(dm)<a name='316'>
   n_vals      = 0<a name='317'>
   is_root_proc = <A href='../../html_code/io_netcdf/diffwrf.F90.html#WRF_DM_ON_MONITOR'>wrf_dm_on_monitor</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_ON_MONITOR_3">()<a name='318'>
   pkg_has_vars =&gt; pkg_has_vars_dm(:,:,dm)<a name='319'>
<a name='320'>
   dyn_var_lst(1:dyn_max)      = (/ 'p       ', 'T       ', 'z       ', 'u       ', &amp;<a name='321'>
                                    'v       ', 'w       ', 'rainprod', 'evapprod' /)<a name='322'>
   dyn_var_unit_att(1:dyn_max) = (/ 'hPa', 'K  ', 'm  ', 'm/s', 'm/s', 'm/s', 's-1', 's-1' /)<a name='323'>
   dyn_var_desc_att(1:dyn_max) = (/ 'pressure            ', 'temperature         ', 'height              ', &amp;<a name='324'>
                                    'x wind component    ', 'y wind component    ', 'z wind component    ', &amp;<a name='325'>
                                    'rain production rate', 'rain evap rate      ' /)<a name='326'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='327'></font>
<font color=#447700>!  master proc<a name='328'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='329'></font>
<font color=#447700>!master_proc: &amp;<a name='330'></font>
<font color=#447700>!   if( is_root_proc ) then<a name='331'></font>
      write(filename,'(''wrfinput_traj_d'',i2.2)',iostat=ios) dm<a name='332'>
      if( ios /= 0 ) then<a name='333'>
        write(err_mes,'(''trajectory_init('',i2.2,''): failed to set filename: error = '',i6)') dm,ios<a name='334'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1456">( trim( err_mes  ) )<a name='335'>
      endif<a name='336'>
      inquire( file=trim(filename),exist=exists )<a name='337'>
input_file: &amp;<a name='338'>
      if( exists ) then<a name='339'>
        unitno = <A href='../../html_code/share/wrf_tsin.F.html#GET_UNUSED_UNIT'>get_unused_unit</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_UNUSED_UNIT_2">()<a name='340'>
        if( unitno &lt;= 0 ) then<a name='341'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1457">( 'trajectory_init: failed to get unit number' )<a name='342'>
        endif<a name='343'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='344'></font>
<font color=#447700>!  open file<a name='345'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='346'></font>
        open( unit = unitno,file=trim(filename),iostat=ios )<a name='347'>
        if( ios /= 0 ) then<a name='348'>
          write(err_mes,'(''trajectory_init('',i2.2,''): failed to open '',a,''; error = '',i6)') dm,trim(filename),ios<a name='349'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1458">( trim( err_mes  ) )<a name='350'>
        endif<a name='351'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='352'></font>
<font color=#447700>!  initialize trajectories<a name='353'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='354'></font>
        traj_def%start_time = ' '<a name='355'>
        traj_def%stop_time  = ' '<a name='356'>
        traj_def%chm_name(:) = ' '<a name='357'>
        traj_def%hyd_name(:) = ' '<a name='358'>
        traj_def%trc_name(:) = ' '<a name='359'>
        traj_def%dyn_name(:) = ' '<a name='360'>
        traj_def%msc_name(:) = ' '<a name='361'>
        traj_def%dchm_name(:) = ' '<a name='362'>
<a name='363'>
        do trj = 1,traj_max<a name='364'>
          traj_type(trj)%start_time = ' '<a name='365'>
          traj_type(trj)%stop_time  = ' '<a name='366'>
          traj_type(trj)%chm_spc(:) = ' '<a name='367'>
          traj_type(trj)%dchm_spc(:) = ' '<a name='368'>
          traj_type(trj)%hyd_spc(:) = ' '<a name='369'>
          traj_type(trj)%trc_spc(:) = ' '<a name='370'>
          traj_type(trj)%dyn_var(:) = ' '<a name='371'>
          traj_type(trj)%msc_var(:) = ' '<a name='372'>
          traj_type(trj)%chm_ndx(:) = 0<a name='373'>
          traj_type(trj)%hyd_ndx(:) = 0<a name='374'>
          traj_type(trj)%trc_ndx(:) = 0<a name='375'>
          traj_type(trj)%dyn_ndx(:) = 0<a name='376'>
          traj_type(trj)%msc_ndx(:) = 0<a name='377'>
          traj_type(trj)%dchm_ndx(:) = 0<a name='378'>
          traj_type(trj)%n_chm_var = 0 ; traj_type(trj)%n_ct_var = 0<a name='379'>
          traj_type(trj)%n_hyd_var = 0 ; traj_type(trj)%n_trc_var = 0 <a name='380'>
          traj_type(trj)%n_dyn_var = 0 ; traj_type(trj)%n_msc_var = 0<a name='381'>
          traj_type(trj)%n_dchm_var = 0<a name='382'>
          traj_type(trj)%is_stationary = .false.<a name='383'>
          traj_type(trj)%chm_is_gas(:) = .true.<a name='384'>
          traj_type(trj)%z_is_agl      = .true.<a name='385'>
          traj_type(trj)%lon           = missing_val<a name='386'>
          traj_type(trj)%lat           = missing_val<a name='387'>
          traj_type(trj)%lev           = missing_val<a name='388'>
        end do<a name='389'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='390'></font>
<font color=#447700>!  read file<a name='391'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='392'></font>
        read(unit=unitno,nml=traj_default,iostat=ios)<a name='393'>
        if( ios /= 0 ) then<a name='394'>
          close( unit=unitno )<a name='395'>
          write(err_mes,'(''trajectory_init('',i2.2,''): failed to read '',a,''; error = '',i6)') dm,trim(filename),ios<a name='396'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1459">( trim( err_mes  ) )<a name='397'>
        endif<a name='398'>
        read(unit=unitno,nml=traj_spec,iostat=ios)<a name='399'>
        if( ios /= 0 ) then<a name='400'>
          close( unit=unitno )<a name='401'>
          write(err_mes,'(''trajectory_init('',i2.2,''): failed to read '',a,''; error = '',i6)') dm,trim(filename),ios<a name='402'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1460">( trim( err_mes  ) )<a name='403'>
        endif<a name='404'>
        close( unit=unitno )<a name='405'>
      else input_file<a name='406'>
        write(err_mes,'(''trajectory_init('',i2.2,''): no '',a,'' file'')') dm,trim(filename)<a name='407'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1388">( trim( err_mes ) )<a name='408'>
        traj_cnt(dm) = 0<a name='409'>
        return<a name='410'>
      endif input_file<a name='411'>
<a name='412'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='413'></font>
<font color=#447700>!  process the namelist input<a name='414'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='415'></font>
      do pkg = 1,pkg_max<a name='416'>
        select case( trim(pkg_tag(pkg)) )<a name='417'>
          case( 'chm' )<a name='418'>
            wrk_def_name(:) = traj_def%chm_name(:)<a name='419'>
          case( 'dchm' )<a name='420'>
            wrk_def_name(:) = traj_def%dchm_name(:)<a name='421'>
          case( 'hyd' )<a name='422'>
            wrk_def_name(:) = traj_def%hyd_name(:)<a name='423'>
          case( 'trc' )<a name='424'>
            wrk_def_name(:) = traj_def%trc_name(:)<a name='425'>
          case( 'dyn' )<a name='426'>
            wrk_def_name(:) = traj_def%dyn_name(:)<a name='427'>
          case( 'msc' )<a name='428'>
            wrk_def_name(:) = traj_def%msc_name(:)<a name='429'>
        end select<a name='430'>
        do m = 1,var_max<a name='431'>
          if( wrk_def_name(m) == ' ' ) then<a name='432'>
            exit<a name='433'>
          endif<a name='434'>
        end do<a name='435'>
        n_def_var(pkg) = m - 1<a name='436'>
      end do<a name='437'>
<a name='438'>
      if( traj_def%start_time /= ' ' ) then<a name='439'>
        write(err_mes,'(''trajectory_init('',i2.2,''): default start time = '',a)') dm,traj_def%start_time<a name='440'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1389">( trim(err_mes) )<a name='441'>
      endif<a name='442'>
      if( traj_def%stop_time /= ' ' ) then<a name='443'>
        write(err_mes,'(''trajectory_init('',i2.2,''): default stop  time = '',a)') dm,traj_def%stop_time<a name='444'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1390">( trim(err_mes) )<a name='445'>
      endif<a name='446'>
<a name='447'>
      do pkg = 1,pkg_max<a name='448'>
        if( n_def_var(pkg) &gt; 0 ) then<a name='449'>
          write(*,*) ' '<a name='450'>
          write(*,'(''trajectory_init('',i2.2,''): default '',a,'' variables'')') dm,pkg_tag(pkg)<a name='451'>
          select case( trim(pkg_tag(pkg)) )<a name='452'>
#if( WRF_CHEM == 1 )<a name='453'>
            case( 'chm' )<a name='454'>
              wrk_def_name(:) = traj_def%chm_name(:)<a name='455'>
            case( 'dchm' )<a name='456'>
              wrk_def_name(:) = traj_def%dchm_name(:)<a name='457'>
#endif<a name='458'>
            case( 'hyd' )<a name='459'>
              wrk_def_name(:) = traj_def%hyd_name(:)<a name='460'>
            case( 'trc' )<a name='461'>
              wrk_def_name(:) = traj_def%trc_name(:)<a name='462'>
            case( 'dyn' )<a name='463'>
              wrk_def_name(:) = traj_def%dyn_name(:)<a name='464'>
            case( 'msc' )<a name='465'>
              wrk_def_name(:) = traj_def%msc_name(:)<a name='466'>
          end select<a name='467'>
          write(*,*) wrk_def_name(:n_def_var(pkg))<a name='468'>
        endif<a name='469'>
      end do<a name='470'>
<a name='471'>
      do n_traj = 1,traj_max<a name='472'>
        if( traj_type(n_traj)%lon == missing_val .or. &amp;<a name='473'>
            traj_type(n_traj)%lat == missing_val .or. &amp;<a name='474'>
            traj_type(n_traj)%lev == missing_val ) then<a name='475'>
          exit<a name='476'>
        endif<a name='477'>
      end do<a name='478'>
      n_traj = n_traj - 1<a name='479'>
<a name='480'>
has_trajectories: &amp;<a name='481'>
      if( n_traj &gt; 0 ) then<a name='482'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='483'></font>
<font color=#447700>!  set individual trajectories to default if specified<a name='484'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='485'></font>
        if( traj_def%start_time /= ' ' ) then<a name='486'>
          do trj = 1,n_traj<a name='487'>
            if( traj_type(trj)%start_time == ' ' ) then<a name='488'>
              traj_type(trj)%start_time = traj_def%start_time<a name='489'>
            endif<a name='490'>
          end do<a name='491'>
        endif<a name='492'>
        if( traj_def%stop_time /= ' ' ) then<a name='493'>
          do trj = 1,n_traj<a name='494'>
            if( traj_type(trj)%stop_time == ' ' ) then<a name='495'>
              traj_type(trj)%stop_time = traj_def%stop_time<a name='496'>
            endif<a name='497'>
          end do<a name='498'>
        endif<a name='499'>
<a name='500'>
        do pkg = 1,pkg_max<a name='501'>
          select case( trim(pkg_tag(pkg)) )<a name='502'>
#if( WRF_CHEM == 1 )<a name='503'>
            case( 'chm' )<a name='504'>
              wrk_def_name(:) = traj_def%chm_name(:)<a name='505'>
            case( 'dchm' )<a name='506'>
              wrk_def_name(:) = traj_def%dchm_name(:)<a name='507'>
#endif<a name='508'>
            case( 'hyd' )<a name='509'>
              wrk_def_name(:) = traj_def%hyd_name(:)<a name='510'>
            case( 'trc' )<a name='511'>
              wrk_def_name(:) = traj_def%trc_name(:)<a name='512'>
            case( 'dyn' )<a name='513'>
              wrk_def_name(:) = traj_def%dyn_name(:)<a name='514'>
            case( 'msc' )<a name='515'>
              wrk_def_name(:) = traj_def%msc_name(:)<a name='516'>
          end select<a name='517'>
          do trj = 1,n_traj<a name='518'>
            select case( trim(pkg_tag(pkg)) )<a name='519'>
#if( WRF_CHEM == 1 )<a name='520'>
              case( 'chm' )<a name='521'>
                wrk_var_name = traj_type(trj)%chm_spc(1)<a name='522'>
              case( 'dchm' )<a name='523'>
                wrk_var_name = traj_type(trj)%dchm_spc(1)<a name='524'>
#endif<a name='525'>
              case( 'hyd' )<a name='526'>
                wrk_var_name = traj_type(trj)%hyd_spc(1)<a name='527'>
              case( 'trc' )<a name='528'>
                wrk_var_name = traj_type(trj)%trc_spc(1)<a name='529'>
              case( 'dyn' )<a name='530'>
                wrk_var_name = traj_type(trj)%dyn_var(1)<a name='531'>
              case( 'msc' )<a name='532'>
                wrk_var_name = traj_type(trj)%msc_var(1)<a name='533'>
            end select<a name='534'>
            if( wrk_var_name == ' ' ) then<a name='535'>
              m1 = n_def_var(pkg)<a name='536'>
              select case( trim(pkg_tag(pkg)) )<a name='537'>
#if( WRF_CHEM == 1 )<a name='538'>
                case( 'chm' )<a name='539'>
                  traj_type(trj)%chm_spc(:m1) = traj_def%chm_name(:m1)<a name='540'>
                case( 'dchm' )<a name='541'>
                  traj_type(trj)%dchm_spc(:m1) = traj_def%dchm_name(:m1)<a name='542'>
#endif<a name='543'>
                case( 'hyd' )<a name='544'>
                  traj_type(trj)%hyd_spc(:m1) = traj_def%hyd_name(:m1)<a name='545'>
                case( 'trc' )<a name='546'>
                  traj_type(trj)%trc_spc(:m1) = traj_def%trc_name(:m1)<a name='547'>
                case( 'dyn' )<a name='548'>
                  traj_type(trj)%dyn_var(:m1) = traj_def%dyn_name(:m1)<a name='549'>
                case( 'msc' )<a name='550'>
                  traj_type(trj)%msc_var(:m1) = traj_def%msc_name(:m1)<a name='551'>
              end select<a name='552'>
            endif<a name='553'>
          end do<a name='554'>
        end do<a name='555'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='556'></font>
<font color=#447700>!  scan registry real, 2d, 3d variables<a name='557'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='558'></font>
        call <A href='../../html_code/share/module_trajectory.F.html#REG_SCAN'>reg_scan</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REG_SCAN_1">( grid )<a name='559'>
        num_msc =&gt; num_msc_dm(dm)<a name='560'>
<a name='561'>
        call <A href='../../html_code/frame/wrf_debug.F.html#GET_WRF_DEBUG_LEVEL'>get_wrf_debug_level</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_WRF_DEBUG_LEVEL_10">( dbg_lvl )<a name='562'>
        if( dbg_lvl &gt; 200 ) then<a name='563'>
          write(*,*) ' '<a name='564'>
          write(*,'(''trajectory_init('',i2.2,''): Registry 2d,3d variables'')') dm<a name='565'>
          do n = 1,num_msc<a name='566'>
            write(*,*) trim(St_Vars(n)%varname)<a name='567'>
          end do<a name='568'>
          n = count( St_Vars(:num_msc)%Stagger == 'X' )<a name='569'>
          if( n &gt; 0 ) then<a name='570'>
            write(*,*) ' '<a name='571'>
            write(*,*) 'Registry 2d,3d variables with staggered X'<a name='572'>
            do n = 1,num_msc<a name='573'>
              if( St_Vars(n)%Stagger == 'X' ) then<a name='574'>
                write(*,*) trim(St_Vars(n)%varname)<a name='575'>
              endif<a name='576'>
            end do<a name='577'>
          endif<a name='578'>
          n = count( St_Vars(:num_msc)%Stagger == 'Y' )<a name='579'>
          if( n &gt; 0 ) then<a name='580'>
            write(*,*) ' '<a name='581'>
            write(*,*) 'trajectory_init: Registry 2d,3d variables with staggered Y'<a name='582'>
            do n = 1,num_msc<a name='583'>
              if( St_Vars(n)%Stagger == 'Y' ) then<a name='584'>
                write(*,*) trim(St_Vars(n)%varname)<a name='585'>
              endif<a name='586'>
            end do<a name='587'>
          endif<a name='588'>
          n = count( St_Vars(:num_msc)%Stagger == 'Z' )<a name='589'>
          if( n &gt; 0 ) then<a name='590'>
            write(*,*) ' '<a name='591'>
            write(*,*) 'trajectory_init: Registry 2d,3d variables with staggered Z'<a name='592'>
            do n = 1,num_msc<a name='593'>
              if( St_Vars(n)%Stagger == 'Z' ) then<a name='594'>
                write(*,*) trim(St_Vars(n)%varname)<a name='595'>
              endif<a name='596'>
            end do<a name='597'>
          endif<a name='598'>
        endif<a name='599'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='600'></font>
<font color=#447700>!  get variable counts<a name='601'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='602'></font>
        do trj = 1,n_traj<a name='603'>
          if( num_chem &gt; 1 ) then<a name='604'>
#if( WRF_CHEM == 1 )<a name='605'>
            call <A href='../../html_code/share/module_trajectory.F.html#GET_VAR_CNT'>get_var_cnt</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_VAR_CNT_1">( traj_type(trj)%n_chm_var, traj_type(trj)%chm_spc )<a name='606'>
            call <A href='../../html_code/share/module_trajectory.F.html#GET_VAR_CNT'>get_var_cnt</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_VAR_CNT_2">( traj_type(trj)%n_dchm_var, traj_type(trj)%dchm_spc )<a name='607'>
#endif<a name='608'>
          else<a name='609'>
            traj_type(trj)%n_chm_var  = 0<a name='610'>
            traj_type(trj)%n_dchm_var = 0<a name='611'>
          endif<a name='612'>
          if( num_moist &gt; 1 ) then<a name='613'>
            call <A href='../../html_code/share/module_trajectory.F.html#GET_VAR_CNT'>get_var_cnt</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_VAR_CNT_3">( traj_type(trj)%n_hyd_var, traj_type(trj)%hyd_spc )<a name='614'>
          else<a name='615'>
            traj_type(trj)%n_hyd_var = 0<a name='616'>
          endif<a name='617'>
          if( num_tracer &gt; 1 ) then<a name='618'>
            call <A href='../../html_code/share/module_trajectory.F.html#GET_VAR_CNT'>get_var_cnt</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_VAR_CNT_4">( traj_type(trj)%n_trc_var, traj_type(trj)%trc_spc )<a name='619'>
          else<a name='620'>
            traj_type(trj)%n_trc_var = 0<a name='621'>
          endif<a name='622'>
          if( num_msc &gt; 1 ) then<a name='623'>
            call <A href='../../html_code/share/module_trajectory.F.html#GET_VAR_CNT'>get_var_cnt</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_VAR_CNT_5">( traj_type(trj)%n_msc_var, traj_type(trj)%msc_var )<a name='624'>
          else<a name='625'>
            traj_type(trj)%n_msc_var = 0<a name='626'>
          endif<a name='627'>
          call <A href='../../html_code/share/module_trajectory.F.html#GET_VAR_CNT'>get_var_cnt</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_VAR_CNT_6">( traj_type(trj)%n_dyn_var, traj_type(trj)%dyn_var )<a name='628'>
        end do<a name='629'>
<a name='630'>
        if( any( traj_type(:n_traj)%n_msc_var &gt; 0 ) ) then<a name='631'>
          allocate( msc_tbl(num_msc),stat=astat )<a name='632'>
          if( astat /= 0 ) then<a name='633'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1461">( 'trajectory_init: failed to find allocate msc_tbl' )<a name='634'>
          endif<a name='635'>
          do m = 1,num_msc<a name='636'>
            msc_tbl(m) = trim( St_Vars(m)%Varname )<a name='637'>
          end do<a name='638'>
        endif<a name='639'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='640'></font>
<font color=#447700>!  check for trajectory variables in simulation<a name='641'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='642'></font>
        do trj = 1,n_traj<a name='643'>
#if( WRF_CHEM == 1 )<a name='644'>
          if( num_chem &gt; 1 ) then<a name='645'>
            if( traj_type(trj)%n_chm_var &gt; 0 ) then<a name='646'>
              mask(:) = .false.<a name='647'>
              call <A href='../../html_code/share/module_trajectory.F.html#SCAN_VARS'>scan_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCAN_VARS_1">( traj_type(trj)%n_chm_var, traj_type(trj)%chm_spc, traj_type(trj)%chm_ndx, &amp;<a name='648'>
                              num_chem, chem_dname_table(dm,:), &amp;<a name='649'>
                              traj_type(trj)%chm_is_gas, 'chm' )<a name='650'>
            endif<a name='651'>
            if( traj_type(trj)%n_dchm_var &gt; 0 ) then<a name='652'>
              mask(:) = .false.<a name='653'>
              call <A href='../../html_code/share/module_trajectory.F.html#SCAN_VARS'>scan_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCAN_VARS_2">( traj_type(trj)%n_dchm_var, traj_type(trj)%dchm_spc, traj_type(trj)%dchm_ndx, &amp;<a name='654'>
                              num_chem, chem_dname_table(dm,:), &amp;<a name='655'>
                              traj_type(trj)%chm_is_gas, 'chm' )<a name='656'>
            endif<a name='657'>
          endif<a name='658'>
#endif<a name='659'>
          if( traj_type(trj)%n_hyd_var &gt; 0 .and. num_moist &gt; 1 ) then<a name='660'>
            mask(:) = .false.<a name='661'>
            call <A href='../../html_code/share/module_trajectory.F.html#SCAN_VARS'>scan_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCAN_VARS_3">( traj_type(trj)%n_hyd_var, traj_type(trj)%hyd_spc, traj_type(trj)%hyd_ndx, &amp;<a name='662'>
                            num_moist, moist_dname_table(dm,:), &amp;<a name='663'>
                            traj_type(trj)%chm_is_gas, 'hyd' )<a name='664'>
          endif<a name='665'>
          if( traj_type(trj)%n_trc_var &gt; 0 .and. num_tracer &gt; 1 ) then<a name='666'>
            mask(:) = .false.<a name='667'>
            call <A href='../../html_code/share/module_trajectory.F.html#SCAN_VARS'>scan_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCAN_VARS_4">( traj_type(trj)%n_trc_var, traj_type(trj)%trc_spc, traj_type(trj)%trc_ndx, &amp;<a name='668'>
                            num_tracer, tracer_dname_table(dm,:), &amp;<a name='669'>
                            traj_type(trj)%chm_is_gas, 'trc' )<a name='670'>
          endif<a name='671'>
          if( traj_type(trj)%n_dyn_var &gt; 0 ) then<a name='672'>
            mask(:) = .false.<a name='673'>
            call <A href='../../html_code/share/module_trajectory.F.html#SCAN_VARS'>scan_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCAN_VARS_5">( traj_type(trj)%n_dyn_var, traj_type(trj)%dyn_var, traj_type(trj)%dyn_ndx, &amp;<a name='674'>
                            dyn_max, dyn_var_lst(:), &amp;<a name='675'>
                            traj_type(trj)%chm_is_gas, 'dyn' )<a name='676'>
          endif<a name='677'>
          if( traj_type(trj)%n_msc_var &gt; 0 ) then<a name='678'>
            mask(:) = .false.<a name='679'>
            call <A href='../../html_code/share/module_trajectory.F.html#SCAN_VARS'>scan_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCAN_VARS_6">( traj_type(trj)%n_msc_var, traj_type(trj)%msc_var, traj_type(trj)%msc_ndx, &amp;<a name='680'>
                            num_msc, msc_tbl(:), &amp;<a name='681'>
                            traj_type(trj)%chm_is_gas, 'msc' )<a name='682'>
          endif<a name='683'>
        end do<a name='684'>
<a name='685'>
        do trj = 1,n_traj<a name='686'>
          if( traj_type(trj)%n_msc_var &gt; 0 ) then<a name='687'>
            do m = 1,traj_type(trj)%n_msc_var<a name='688'>
              St_Vars_msk(traj_type(trj)%msc_ndx(m)-offset) = .true.<a name='689'>
            end do<a name='690'>
          endif<a name='691'>
        end do<a name='692'>
        m = count( St_Vars_msk(:num_msc) )<a name='693'>
<a name='694'>
        if( allocated( msc_tbl ) ) then<a name='695'>
          deallocate( msc_tbl )<a name='696'>
        endif<a name='697'>
<a name='698'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='699'></font>
<font color=#447700>!  remove trajectories with no variables<a name='700'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='701'></font>
        n_traj_1 = count( (traj_type(:n_traj)%n_chm_var + traj_type(:n_traj)%n_hyd_var &amp;<a name='702'>
                           + traj_type(:n_traj)%n_trc_var + traj_type(:n_traj)%n_dyn_var &amp;<a name='703'>
                           + traj_type(:n_traj)%n_msc_var + traj_type(:n_traj)%n_dchm_var) &gt; 0 )<a name='704'>
        if( n_traj_1 &gt; 0 ) then<a name='705'>
          if( n_traj_1 /= n_traj ) then<a name='706'>
            trj_mask(1:n_traj) = traj_type(1:n_traj)%in_dom<a name='707'>
            m = 1<a name='708'>
            do trj = 1,n_traj<a name='709'>
              if( trj_mask(trj) ) then<a name='710'>
                if( trj /= m ) then<a name='711'>
                  traj_type(m) = traj_type(trj)<a name='712'>
                  m = m + 1<a name='713'>
                endif<a name='714'>
              endif<a name='715'>
            end do<a name='716'>
            n_traj = n_traj_1<a name='717'>
          endif<a name='718'>
        else<a name='719'>
          dm_has_traj(dm) = .false.<a name='720'>
          return<a name='721'>
        endif<a name='722'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='723'></font>
<font color=#447700>!  allocate buffer type<a name='724'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='725'></font>
        if( is_root_proc ) then<a name='726'>
          if( dm == 1 ) then<a name='727'>
            allocate( trj_buff(traj_max,n_dom),stat=astat )<a name='728'>
            if( astat /= 0 ) then<a name='729'>
              write(err_mes,'(''trajectory_init: failed to allocate traj_buff; error = '',i6)') astat<a name='730'>
              call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1462">( trim( err_mes  ) )<a name='731'>
            endif<a name='732'>
          endif<a name='733'>
          trj_pbf =&gt; trj_buff(:,dm)<a name='734'>
        endif<a name='735'>
      endif has_trajectories<a name='736'>
<font color=#447700>!   endif master_proc<a name='737'></font>
#if( WRF_CHEM == 1 )<a name='738'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='739'></font>
<font color=#447700>!   for dchm package make sure dchm_ndx is ordered list<a name='740'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='741'></font>
    do trj = 1,n_traj<a name='742'>
      n = traj_type(trj)%n_dchm_var<a name='743'>
      if( n &gt; 0 .and.  any( traj_type(trj)%dchm_ndx(1:n-1) &gt; traj_type(trj)%dchm_ndx(2:n) ) ) then<a name='744'>
        trj_mask(:num_chem) = .false. <a name='745'>
        do m = 1,n<a name='746'>
          trj_mask(traj_type(trj)%dchm_ndx(m)) = .true. <a name='747'>
        end do<a name='748'>
        traj_type(trj)%dchm_ndx(:n) = pack( (/ (m,m=1,num_chem) /),trj_mask(:num_chem) )<a name='749'>
        do m = 1,n<a name='750'>
          m1 = traj_type(trj)%dchm_ndx(m)<a name='751'>
          traj_type(trj)%dchm_spc(m) = trim(chem_dname_table(dm,m1))<a name='752'>
        end do<a name='753'>
      endif<a name='754'>
    end do<a name='755'>
#endif<a name='756'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='757'></font>
<font color=#447700>!  if initial run, overwrite existing grid trajectory variables<a name='758'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='759'></font>
#ifdef DM_PARALLEL<a name='760'>
<font color=#447700>!  call wrf_dm_bcast_integer( n_traj,1 )<a name='761'></font>
<font color=#447700>!  if( n_traj &gt; 0 ) then<a name='762'></font>
<font color=#447700>!    p_size = (5+var_max)*RWORDSIZE + (2+var_max)*LWORDSIZE &amp;<a name='763'></font>
<font color=#447700>!           + (5+4*var_max)*IWORDSIZE + 4*32*var_max + 38<a name='764'></font>
<font color=#447700>!    do trj = 1,n_traj<a name='765'></font>
<font color=#447700>!      call wrf_dm_bcast_bytes( traj_type(trj),p_size )<a name='766'></font>
<font color=#447700>!    end do<a name='767'></font>
<font color=#447700>!  endif<a name='768'></font>
#endif<a name='769'>
<font color=#447700>!  call wrf_abort( 'Debugging' )<a name='770'></font>
is_cold_start: &amp;<a name='771'>
   if( .not. rstrt ) then<a name='772'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='773'></font>
<font color=#447700>!  calc and check trajectory start point<a name='774'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='775'></font>
has_trajectories_a: &amp;<a name='776'>
     if( n_traj &gt; 0 ) then<a name='777'>
       config_temp = config_flags<a name='778'>
       call <A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ'>trajmapproj</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRAJMAPPROJ_2">( grid, config_temp, proj )<a name='779'>
       i_end = min(ipe,ide-1)<a name='780'>
       j_end = min(jpe,jde-1)<a name='781'>
       do j = jps,j_end<a name='782'>
         do k = kps,kpe<a name='783'>
           z_at_w(ips:i_end,k,j) = (grid%ph_2(ips:i_end,k,j) + grid%phb(ips:i_end,k,j))/g<a name='784'>
         end do<a name='785'>
       end do<a name='786'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='787'></font>
<font color=#447700>!  first check x,y<a name='788'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='789'></font>
traj_loop: &amp;<a name='790'>
       do trj = 1,n_traj<a name='791'>
         if( traj_type(trj)%lat /= missing_val .and. &amp;<a name='792'>
             traj_type(trj)%lon /= missing_val ) then<a name='793'>
           call <A href='../../html_code/share/module_llxy.F.html#LATLON_TO_IJ'>latlon_to_ij</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LATLON_TO_IJ_4">( proj, traj_type(trj)%lat, traj_type(trj)%lon, x, y )<a name='794'>
           traj_type(trj)%in_dom = &amp;<a name='795'>
                  (x &gt;= real(ids) .and. x &lt;= real(ide-1) .and. &amp;<a name='796'>
                   y &gt;= real(jds) .and. y &lt;= real(jde-1))<a name='797'>
#ifdef SW_DEBUG<a name='798'>
          write(err_mes,'(''trajectory_init('',i2.2,''): x,y = '',1p,2g15.7)') dm,x,y<a name='799'>
          call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1112">( 0,trim(err_mes) )<a name='800'>
#endif<a name='801'>
         else<a name='802'>
           traj_type(trj)%in_dom = .false.<a name='803'>
         endif<a name='804'>
#ifdef SW_DEBUG<a name='805'>
         write(err_mes,'(''trajectory_init('',i2.2,''): traj '',i4,'' in dom  = '',l)') dm,trj,traj_type(trj)%in_dom<a name='806'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1113">( 0,trim(err_mes) )<a name='807'>
#endif<a name='808'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='809'></font>
<font color=#447700>!  then check z<a name='810'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='811'></font>
is_in_domain: &amp;<a name='812'>
         if( traj_type(trj)%in_dom ) then<a name='813'>
           i = nint( x )<a name='814'>
           j = nint( y )<a name='815'>
           traj_type(trj)%in_patch = &amp;<a name='816'>
                  (i &gt;= ips .and. i &lt;= min(ipe,ide-1) .and. &amp;<a name='817'>
                   j &gt;= jps .and. j &lt;= min(jpe,jde-1))<a name='818'>
is_in_patch: &amp;<a name='819'>
           if( traj_type(trj)%in_patch ) then<a name='820'>
             k1 = kde - 1<a name='821'>
             if( traj_type(trj)%z_is_agl ) then<a name='822'>
               traj_type(trj)%lev = traj_type(trj)%lev + z_at_w(i,kds,j)<a name='823'>
             endif<a name='824'>
             z_dm_bot = z_at_w(i,kds,j)<a name='825'>
             z_dm_top = z_at_w(i,k1,j)<a name='826'>
             write(err_mes,'(''trajectory_init('',i2.2,''): traj '',i3.3,'' i,j,z_bot,z_top,lev = '',2i4,1p3g15.7)') &amp;<a name='827'>
                dm,trj,i,j,z_dm_bot,z_dm_top,traj_type(trj)%lev<a name='828'>
             call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1114">( 0,trim(err_mes) )<a name='829'>
             if( traj_type(trj)%lev &gt;= z_dm_bot .and. &amp;<a name='830'>
                 traj_type(trj)%lev &lt;= z_dm_top ) then<a name='831'>
               traj_type(trj)%in_dom = .true.<a name='832'>
               traj_type(trj)%x      = x<a name='833'>
               traj_type(trj)%y      = y<a name='834'>
             else<a name='835'>
               traj_type(trj)%in_dom = .false.<a name='836'>
             endif<a name='837'>
           else is_in_patch<a name='838'>
             traj_type(trj)%x = missing_val<a name='839'>
             traj_type(trj)%y = missing_val<a name='840'>
           endif is_in_patch<a name='841'>
         endif is_in_domain<a name='842'>
       end do traj_loop<a name='843'>
       n_traj_1 = count( traj_type(:n_traj)%in_dom )<a name='844'>
     else has_trajectories_a<a name='845'>
       n_traj_1 = 0<a name='846'>
     endif has_trajectories_a<a name='847'>
<a name='848'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='849'></font>
<font color=#447700>!  remove out of domain trajectories<a name='850'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='851'></font>
     write(err_mes,'(''trajectory_init('',i2.2,''): traj cnt = '',2i6)') dm,n_traj_1,n_traj<a name='852'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1115">( 0,trim(err_mes) )<a name='853'>
     if( n_traj_1 /= n_traj ) then<a name='854'>
       trj_mask(1:n_traj) = traj_type(1:n_traj)%in_dom<a name='855'>
       m = 1<a name='856'>
       do trj = 1,n_traj<a name='857'>
         if( trj_mask(trj) ) then<a name='858'>
           if( trj /= m ) then<a name='859'>
             traj_type(m) = traj_type(trj)<a name='860'>
             m = m + 1<a name='861'>
           endif<a name='862'>
         endif<a name='863'>
       end do<a name='864'>
       n_traj = n_traj_1<a name='865'>
     endif<a name='866'>
<a name='867'>
has_trajectories_b: &amp;<a name='868'>
     if( n_traj_1 &gt; 0 ) then<a name='869'>
       grid%traj_i(:) = missing_val<a name='870'>
       grid%traj_j(:) = missing_val<a name='871'>
       grid%traj_k(:) = missing_val<a name='872'>
       grid%traj_long(:) = missing_val<a name='873'>
       grid%traj_lat(:)  = missing_val<a name='874'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='875'></font>
<font color=#447700>!  set initial trajectory spatial coordinates<a name='876'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='877'></font>
       k1 = kde - 1<a name='878'>
       do trj = 1,n_traj<a name='879'>
         if( traj_type(trj)%in_patch ) then<a name='880'>
           grid%traj_i(trj) = traj_type(trj)%x<a name='881'>
           grid%traj_j(trj) = traj_type(trj)%y<a name='882'>
           grid%traj_long(trj) = traj_type(trj)%lon<a name='883'>
           grid%traj_lat(trj)  = traj_type(trj)%lat<a name='884'>
           i = nint( traj_type(trj)%x )<a name='885'>
           j = nint( traj_type(trj)%y )<a name='886'>
<font color=#447700>!          z(kds:k1) = .5*(z_at_w(i,kds:k1,j) + z_at_w(i,kds+1:k1+1,j))<a name='887'></font>
           z(kds:k1) = z_at_w(i,kds:k1,j)<a name='888'>
           do k = kds+1,k1<a name='889'>
             if( traj_type(trj)%lev &lt;= z(k) ) then<a name='890'>
               grid%traj_k(trj) = real(k - 1) &amp;<a name='891'>
                              + (traj_type(trj)%lev - z(k-1))/(z(k) - z(k-1))<a name='892'>
               exit<a name='893'>
             endif<a name='894'>
           end do<a name='895'>
           write(err_mes,'(''trajectory_init('',i2.2,''): trj,k,z(k-1:k),traj_k = '',2i3,1p3g15.7)') &amp;<a name='896'>
              dm,trj,k,z(k-1:k),grid%traj_k(trj)<a name='897'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1116">( 0,trim(err_mes) )<a name='898'>
         endif<a name='899'>
       end do<a name='900'>
     else has_trajectories_b<a name='901'>
       dm_has_traj(dm) = .false.<a name='902'>
       return<a name='903'>
     endif has_trajectories_b<a name='904'>
   else is_cold_start<a name='905'>
     if( n_traj &gt; 0 ) then<a name='906'>
       call <A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM'>set_in_dom</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_IN_DOM_1"><a name='907'>
     else<a name='908'>
       traj_cnt(dm) = n_traj<a name='909'>
       return<a name='910'>
     endif<a name='911'>
   endif is_cold_start<a name='912'>
<a name='913'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='914'></font>
<font color=#447700>!  transfer from local variable to module variable<a name='915'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='916'></font>
   traj_cnt(dm) = n_traj<a name='917'>
   do trj = 1,n_traj<a name='918'>
     trjects(trj) = traj_type(trj)<a name='919'>
   end do<a name='920'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='921'></font>
<font color=#447700>!  create netcdf trajectory file<a name='922'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='923'></font>
   if( .not. rstrt ) then<a name='924'>
     do trj = 1,n_traj<a name='925'>
#ifdef DM_PARALLEL<a name='926'>
       grid%traj_i(trj) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_8">( grid%traj_i(trj) )<a name='927'>
       grid%traj_j(trj) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_9">( grid%traj_j(trj) )<a name='928'>
       grid%traj_k(trj) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_10">( grid%traj_k(trj) )<a name='929'>
       grid%traj_long(trj) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_11">( grid%traj_long(trj) )<a name='930'>
       grid%traj_lat(trj)  = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_12">( grid%traj_lat(trj) )<a name='931'>
#else<a name='932'>
       grid%traj_i(trj) = grid%traj_i(trj)<a name='933'>
       grid%traj_j(trj) = grid%traj_j(trj)<a name='934'>
       grid%traj_k(trj) = grid%traj_k(trj)<a name='935'>
       grid%traj_long(trj) = grid%traj_long(trj)<a name='936'>
       grid%traj_lat(trj)  = grid%traj_lat(trj)<a name='937'>
#endif<a name='938'>
     end do<a name='939'>
   endif<a name='940'>
<a name='941'>
   do pkg = 1,pkg_max<a name='942'>
     select case( trim(pkg_tag(pkg)) )<a name='943'>
#if( WRF_CHEM == 1 )<a name='944'>
       case( 'chm' )<a name='945'>
         pkg_has_vars(:n_traj,pkg) = trjects(:n_traj)%n_chm_var &gt; 0<a name='946'>
       case( 'dchm' )<a name='947'>
         pkg_has_vars(:n_traj,pkg) = trjects(:n_traj)%n_dchm_var &gt; 0<a name='948'>
#endif<a name='949'>
       case( 'hyd' )<a name='950'>
         pkg_has_vars(:n_traj,pkg) = trjects(:n_traj)%n_hyd_var &gt; 0<a name='951'>
       case( 'trc' )<a name='952'>
         pkg_has_vars(:n_traj,pkg) = trjects(:n_traj)%n_trc_var &gt; 0<a name='953'>
       case( 'dyn' )<a name='954'>
         pkg_has_vars(:n_traj,pkg) = trjects(:n_traj)%n_dyn_var &gt; 0<a name='955'>
       case( 'msc' )<a name='956'>
         pkg_has_vars(:n_traj,pkg) = trjects(:n_traj)%n_msc_var &gt; 0<a name='957'>
     end select<a name='958'>
   end do<a name='959'>
<a name='960'>
#if( WRF_CHEM == 1 )<a name='961'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='962'></font>
<font color=#447700>!  setup for  dchm buffer<a name='963'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='964'></font>
   n_dchm_dm(dm) = 0<a name='965'>
   if( any( pkg_has_vars(:n_traj,dchm_pkg) ) ) then<a name='966'>
     if( .not. allocated( dchm_msk_dm ) ) then<a name='967'>
       allocate( dchm_msk_dm(num_chem,n_dom),stat=astat )<a name='968'>
       if( astat /= 0 ) then<a name='969'>
         write(err_mes,'(''trajectory_init('',i2.2,''): failed to allocate dchm_msk_dm; error = '',i6)') dm,astat<a name='970'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1463">( trim( err_mes  ) )<a name='971'>
       endif<a name='972'>
     endif<a name='973'>
     if( .not. allocated( dchm_buf_ndx_dm ) ) then<a name='974'>
       allocate( dchm_buf_ndx_dm(num_chem,n_dom),stat=astat )<a name='975'>
       if( astat /= 0 ) then<a name='976'>
         write(err_mes,'(''trajectory_init('',i2.2,''): failed to allocate dchm_buf_ndx_dm; error = '',i6)') dm,astat<a name='977'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1464">( trim( err_mes  ) )<a name='978'>
       endif<a name='979'>
     endif<a name='980'>
     n_dchm   =&gt; n_dchm_dm(dm)<a name='981'>
     dchm_msk =&gt; dchm_msk_dm(:,dm)<a name='982'>
     dchm_msk(:) = .false.<a name='983'>
     dchm_buf_ndx =&gt; dchm_buf_ndx_dm(:,dm)<a name='984'>
     dchm_buf_ndx(:) = 0<a name='985'>
     do trj = 1,n_traj<a name='986'>
       do m = 1,trjects(trj)%n_dchm_var<a name='987'>
         dchm_msk(trjects(trj)%dchm_ndx(m)) = .true.<a name='988'>
       end do<a name='989'>
     end do<a name='990'>
     n_dchm = count( dchm_msk )<a name='991'>
     dchm_buf_ndx(:n_dchm) = pack( (/ (m,m=1,num_chem) /),dchm_msk(:num_chem) )<a name='992'>
     do trj = 1,n_traj<a name='993'>
       if( trjects(trj)%n_dchm_var &gt; 0 ) then<a name='994'>
         do m1 = 1,trjects(trj)%n_dchm_var<a name='995'>
           target = trjects(trj)%dchm_ndx(m1)<a name='996'>
           do m2 = 1,n_dchm<a name='997'>
             if( target == dchm_buf_ndx(m2) ) then<a name='998'>
               trjects(trj)%dchm_ndx(m1) = m2 + offset<a name='999'>
               exit<a name='1000'>
             endif<a name='1001'>
           end do<a name='1002'>
         end do<a name='1003'>
       endif<a name='1004'>
     end do<a name='1005'>
   endif<a name='1006'>
#endif<a name='1007'>
<a name='1008'>
master_proc_a: &amp;<a name='1009'>
   if( is_root_proc ) then<a name='1010'>
     if( dm == 1 ) then<a name='1011'>
       n = max(num_chem,num_moist,num_tracer,num_msc+offset,dyn_max+offset)<a name='1012'>
       if( n  &gt; offset .and. .not. allocated(trj_msk_dm) ) then<a name='1013'>
         allocate( trj_msk_dm(traj_max,n,pkg_max,n_dom),stat=astat )<a name='1014'>
         if( astat /= 0 ) then<a name='1015'>
           write(err_mes,'(''trajectory_init: failed to allocate trj_msk_dm; error = '',i6)') astat<a name='1016'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1465">( trim( err_mes  ) )<a name='1017'>
         endif<a name='1018'>
         trj_msk_dm(:,:,:,:) = .false.<a name='1019'>
       endif<a name='1020'>
     endif<a name='1021'>
is_initial: &amp;<a name='1022'>
     if( .not. is_initialized(dm) ) then<a name='1023'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1024'></font>
<font color=#447700>!  allocate buffer arrays<a name='1025'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1026'></font>
trj_loop: &amp;<a name='1027'>
       do trj = 1,n_traj<a name='1028'>
pkg_loop:  do pkg = 1,pkg_max<a name='1029'>
             astat = 0<a name='1030'>
             select case( trim(pkg_tag(pkg)) )<a name='1031'>
#if( WRF_CHEM == 1 )<a name='1032'>
               case( 'chm' )<a name='1033'>
                 trj_msk =&gt; trj_msk_dm(:,:,chm_pkg,dm)<a name='1034'>
                 m1 = trjects(trj)%n_chm_var<a name='1035'>
                 if( m1 &gt; 0 ) then<a name='1036'>
                   allocate( trj_pbf(trj)%chm_vals(vals_max,m1),stat=astat)<a name='1037'>
                   do m = 1,m1<a name='1038'>
                     trj_msk(trj,trjects(trj)%chm_ndx(m)) = trjects(trj)%in_dom<a name='1039'>
                   end do<a name='1040'>
                 endif<a name='1041'>
               case( 'dchm' )<a name='1042'>
                 trj_msk =&gt; trj_msk_dm(:,:,dchm_pkg,dm)<a name='1043'>
                 m1 = trjects(trj)%n_dchm_var<a name='1044'>
                 if( m1 &gt; 0 ) then<a name='1045'>
                   allocate( trj_pbf(trj)%dchm_vals(vals_max,m1),stat=astat)<a name='1046'>
                   do m = 1,m1<a name='1047'>
                     trj_msk(trj,trjects(trj)%dchm_ndx(m)) = trjects(trj)%in_dom<a name='1048'>
                   end do<a name='1049'>
                 endif<a name='1050'>
#endif<a name='1051'>
               case( 'hyd' )<a name='1052'>
                 trj_msk =&gt; trj_msk_dm(:,:,hyd_pkg,dm)<a name='1053'>
                 m1 = trjects(trj)%n_hyd_var<a name='1054'>
                 if( m1 &gt; 0 ) then<a name='1055'>
                   allocate( trj_pbf(trj)%hyd_vals(vals_max,m1),stat=astat)<a name='1056'>
                   do m = 1,m1<a name='1057'>
                     trj_msk(trj,trjects(trj)%hyd_ndx(m)) = trjects(trj)%in_dom<a name='1058'>
                   end do<a name='1059'>
                 endif<a name='1060'>
               case( 'trc' )<a name='1061'>
                 trj_msk =&gt; trj_msk_dm(:,:,trc_pkg,dm)<a name='1062'>
                 m1 = trjects(trj)%n_trc_var<a name='1063'>
                 if( m1 &gt; 0 ) then<a name='1064'>
                   allocate( trj_pbf(trj)%trc_vals(vals_max,m1),stat=astat)<a name='1065'>
                   do m = 1,m1<a name='1066'>
                     trj_msk(trj,trjects(trj)%trc_ndx(m)) = trjects(trj)%in_dom<a name='1067'>
                   end do<a name='1068'>
                 endif<a name='1069'>
               case( 'dyn' )<a name='1070'>
                 trj_msk =&gt; trj_msk_dm(:,:,dyn_pkg,dm)<a name='1071'>
                 m1 = trjects(trj)%n_dyn_var<a name='1072'>
                 if( m1 &gt; 0 ) then<a name='1073'>
                   allocate( trj_pbf(trj)%dyn_vals(vals_max,m1),stat=astat)<a name='1074'>
                   do m = 1,m1<a name='1075'>
                     trj_msk(trj,trjects(trj)%dyn_ndx(m)) = trjects(trj)%in_dom<a name='1076'>
                   end do<a name='1077'>
                 endif<a name='1078'>
               case( 'msc' )<a name='1079'>
                 trj_msk =&gt; trj_msk_dm(:,:,msc_pkg,dm)<a name='1080'>
                 m1 = trjects(trj)%n_msc_var<a name='1081'>
                 if( m1 &gt; 0 ) then<a name='1082'>
                   allocate( trj_pbf(trj)%msc_vals(vals_max,m1),stat=astat)<a name='1083'>
                   do m = 1,m1<a name='1084'>
                     trj_msk(trj,trjects(trj)%msc_ndx(m)) = trjects(trj)%in_dom<a name='1085'>
                   end do<a name='1086'>
                 endif<a name='1087'>
             end select<a name='1088'>
             if( astat /= 0 ) then<a name='1089'>
               write(err_mes,'(''trajectory_init: failed to allocate buffer%'',a,''; error = '',i6)') &amp;<a name='1090'>
                   pkg_tag(pkg),astat<a name='1091'>
               call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1466">( trim( err_mes  ) )<a name='1092'>
             endif<a name='1093'>
           end do pkg_loop<a name='1094'>
       end do trj_loop<a name='1095'>
<a name='1096'>
       do pkg = 1,pkg_max<a name='1097'>
         select case( trim(pkg_tag(pkg)) )<a name='1098'>
#if( WRF_CHEM == 1 )<a name='1099'>
           case( 'chm' )<a name='1100'>
             trj_msk =&gt; trj_msk_dm(:,:,chm_pkg,dm)<a name='1101'>
             u_lim = num_chem<a name='1102'>
           case( 'dchm' )<a name='1103'>
             trj_msk =&gt; trj_msk_dm(:,:,dchm_pkg,dm)<a name='1104'>
             u_lim = num_chem<a name='1105'>
#endif<a name='1106'>
           case( 'hyd' )<a name='1107'>
             trj_msk =&gt; trj_msk_dm(:,:,hyd_pkg,dm)<a name='1108'>
             u_lim = num_moist<a name='1109'>
           case( 'trc' )<a name='1110'>
             trj_msk =&gt; trj_msk_dm(:,:,trc_pkg,dm)<a name='1111'>
             u_lim = num_tracer<a name='1112'>
           case( 'dyn' )<a name='1113'>
             trj_msk =&gt; trj_msk_dm(:,:,dyn_pkg,dm)<a name='1114'>
             u_lim = dyn_max + offset<a name='1115'>
           case( 'msc' )<a name='1116'>
             trj_msk =&gt; trj_msk_dm(:,:,msc_pkg,dm)<a name='1117'>
             u_lim = num_msc + offset<a name='1118'>
         end select<a name='1119'>
         do trj = 1,n_traj<a name='1120'>
           trj_msk(trj,1) = any( trj_msk(trj,param_first_scalar:u_lim) )<a name='1121'>
         end do<a name='1122'>
       end do<a name='1123'>
       is_initialized(dm) = .true.<a name='1124'>
       if( .not. rstrt ) then<a name='1125'>
         call <A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE'>trajectory_create_file</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRAJECTORY_CREATE_FILE_1">( grid, n_traj )<a name='1126'>
       endif<a name='1127'>
     endif is_initial<a name='1128'>
   endif master_proc_a<a name='1129'>
#ifdef DM_PARALLEL<a name='1130'>
   call <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_LOGICAL'>wrf_dm_bcast_logical</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_LOGICAL_1">( is_initialized,n_dom )<a name='1131'>
#endif<a name='1132'>
<a name='1133'>
   CONTAINS<a name='1134'>
<a name='1135'>
<A NAME='REG_SCAN'><A href='../../html_code/share/module_trajectory.F.html#REG_SCAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1136'>
   <font color=#993300>subroutine </font><font color=#cc0000>reg_scan</font>( grid ) <A href='../../call_to/REG_SCAN.html' TARGET='index'>1</A>,<A href='../../call_from/REG_SCAN.html' TARGET='index'>6</A><a name='1137'>
<a name='1138'>
   use <A href='../../html_code/frame/module_domain_type.F.html#MODULE_DOMAIN_TYPE'>module_domain_type</A><A href='../../html_code/share/module_trajectory.F.html#REG_SCAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_TYPE_12">, only : domain, fieldlist<a name='1139'>
<a name='1140'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1141'></font>
<font color=#447700>!  dummy arguments<a name='1142'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1143'></font>
   type(domain), intent(in) :: grid<a name='1144'>
<a name='1145'>
   integer, parameter :: nVerbotten = 8<a name='1146'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1147'></font>
<font color=#447700>!  local variables<a name='1148'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1149'></font>
   integer         :: astat<a name='1150'>
   integer         :: cnt<a name='1151'>
   integer         :: dm, dm_ndx<a name='1152'>
   integer         :: m, n<a name='1153'>
   type(fieldlist), pointer :: p<a name='1154'>
   logical         :: valid<a name='1155'>
   type(statevar), allocatable :: St_Vars_wrk(:,:)<a name='1156'>
   logical, allocatable :: St_Vars_msk_wrk(:,:)<a name='1157'>
   character(len=80) :: tstring<a name='1158'>
   character(len=9) :: Verbotten(nVerbotten) = (/ 'zx       ', 'zy       ', &amp;<a name='1159'>
                                                  'RUNDGTEN ', 'RVNDGTEN ', &amp;<a name='1160'>
                                                  'U_NDG_OLD', 'V_NDG_OLD', &amp;<a name='1161'>
                                                  'U_NDG_NEW', 'V_NDG_NEW'/)<a name='1162'>
<a name='1163'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1164'></font>
<font color=#447700>!  just get the count<a name='1165'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1166'></font>
   dm = grid%id<a name='1167'>
   p =&gt; grid%head_statevars%next ; cnt = 0<a name='1168'>
   do while( associated(p) )<a name='1169'>
     valid = (p%Type == 'R' .or. p%Type == 'r') .and. &amp;<a name='1170'>
             (p%Ndim == 3 .or. (p%Ndim == 4 .and. p%scalar_array))<a name='1171'>
     if( valid ) then<a name='1172'>
       valid = p%MemoryOrder(:3) == 'XZY' .and. (p%em2 == kde-1 .or. p%em2 == kde)<a name='1173'>
       if( valid ) then<a name='1174'>
         if( p%Ndim == 3 ) then<a name='1175'>
           do m = 1,nVerbotten<a name='1176'>
             if( trim(Verbotten(m)) == trim(p%Varname) ) then<a name='1177'>
               valid = .false.<a name='1178'>
               exit<a name='1179'>
             endif<a name='1180'>
           enddo<a name='1181'>
           if( valid ) then<a name='1182'>
             cnt = cnt + 1<a name='1183'>
           endif<a name='1184'>
         elseif( p%Ndim == 4 ) then<a name='1185'>
           do n = param_first_scalar,p%num_table(dm)<a name='1186'>
             valid = .true.<a name='1187'>
             do m = 1,nVerbotten<a name='1188'>
               tstring = trim(Verbotten(m))<a name='1189'>
               call <A href='../../html_code/share/module_trajectory.F.html#UPCASE'>upcase</A><A href='../../html_code/share/module_trajectory.F.html#REG_SCAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPCASE_1">( tstring )<a name='1190'>
               if( trim(tstring) == trim(p%dname_table(dm,n)) ) then<a name='1191'>
                 valid = .false.<a name='1192'>
                 exit<a name='1193'>
               endif<a name='1194'>
             enddo<a name='1195'>
             if( valid ) then<a name='1196'>
               cnt = cnt + 1<a name='1197'>
             endif<a name='1198'>
           enddo<a name='1199'>
         endif<a name='1200'>
       endif<a name='1201'>
     endif<a name='1202'>
     p =&gt; p%next<a name='1203'>
   end do<a name='1204'>
<a name='1205'>
   write(*,'(''reg_scan('',i2.2,''): found '',i4,'' state variables '')') dm,cnt<a name='1206'>
<a name='1207'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1208'></font>
<font color=#447700>!  now allocate and set St_Vars<a name='1209'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1210'></font>
   num_msc_dm(dm) = cnt<a name='1211'>
   if( cnt &gt; 0 ) then<a name='1212'>
     if( .not. allocated( St_Vars_dm ) ) then<a name='1213'>
       allocate( St_Vars_dm(cnt,n_dom),St_Vars_msk_dm(cnt,n_dom),stat=astat )<a name='1214'>
       if( astat /= 0 ) then<a name='1215'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#REG_SCAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1467">( 'reg_scan: failed to allocate St_Vars,St_Vars_msk' )<a name='1216'>
       endif<a name='1217'>
     elseif( cnt &gt; maxval(num_msc_dm(1:dm-1)) ) then<a name='1218'>
       n = size( St_vars_dm,dim=1 )<a name='1219'>
       allocate( St_Vars_wrk(n,dm-1),St_Vars_msk_wrk(n,dm-1),stat=astat )<a name='1220'>
       if( astat /= 0 ) then<a name='1221'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#REG_SCAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1468">( 'reg_scan: failed to allocate St_Vars,St_Vars_msk wrk arrays' )<a name='1222'>
       endif<a name='1223'>
       do dm_ndx = 1,dm-1<a name='1224'>
         do m = 1,n<a name='1225'>
           St_Vars_wrk(m,dm_ndx) = St_Vars_dm(m,dm_ndx)<a name='1226'>
           St_Vars_msk_wrk(m,dm_ndx) = St_Vars_msk_dm(m,dm_ndx)<a name='1227'>
         end do<a name='1228'>
       end do<a name='1229'>
       deallocate( St_vars_dm,St_Vars_msk_dm )<a name='1230'>
       allocate( St_Vars_dm(cnt,n_dom),St_Vars_msk_dm(cnt,n_dom),stat=astat )<a name='1231'>
       if( astat /= 0 ) then<a name='1232'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#REG_SCAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1469">( 'reg_scan: failed to allocate St_Vars,St_Vars_msk' )<a name='1233'>
       endif<a name='1234'>
       do dm_ndx = 1,dm-1<a name='1235'>
         do m = 1,n<a name='1236'>
           St_Vars_dm(m,dm_ndx) = St_Vars_wrk(m,dm_ndx)<a name='1237'>
           St_Vars_msk_dm(m,dm_ndx) = St_Vars_msk_wrk(m,dm_ndx)<a name='1238'>
         end do<a name='1239'>
       end do<a name='1240'>
       deallocate( St_vars_wrk,St_Vars_msk_wrk )<a name='1241'>
     endif<a name='1242'>
<a name='1243'>
     St_Vars     =&gt; St_Vars_dm(:,dm)<a name='1244'>
     St_Vars_msk =&gt; St_Vars_msk_dm(:,dm)<a name='1245'>
<a name='1246'>
     St_Vars_msk(:cnt) = .false.<a name='1247'>
     p =&gt; grid%head_statevars%next ; cnt = 0<a name='1248'>
<a name='1249'>
     do while( associated(p) )<a name='1250'>
       valid = (p%Type == 'R' .or. p%Type == 'r') .and. &amp;<a name='1251'>
               (p%Ndim == 3 .or. (p%Ndim == 4 .and. p%scalar_array))<a name='1252'>
       if( valid ) then<a name='1253'>
         valid = p%MemoryOrder(:3) == 'XZY' .and. (p%em2 == kde-1 .or. p%em2 == kde)<a name='1254'>
         if( valid ) then<a name='1255'>
           if( p%Ndim == 3 ) then<a name='1256'>
             do m = 1,nVerbotten<a name='1257'>
               if( trim(Verbotten(m)) == trim(p%Varname) ) then<a name='1258'>
                 valid = .false.<a name='1259'>
                 exit<a name='1260'>
               endif<a name='1261'>
             enddo<a name='1262'>
             if( valid ) then<a name='1263'>
               cnt = cnt + 1<a name='1264'>
               St_Vars(cnt)%Varname = p%Varname <a name='1265'>
               St_Vars(cnt)%Description = p%Description <a name='1266'>
               St_Vars(cnt)%Units   = p%Units <a name='1267'>
               St_Vars(cnt)%MemOrd  = p%MemoryOrder <a name='1268'>
               St_Vars(cnt)%Stagger = p%Stagger<a name='1269'>
               St_Vars(cnt)%Ndim = p%Ndim <a name='1270'>
               St_Vars(cnt)%rfield_3d =&gt; p%rfield_3d<a name='1271'>
             endif<a name='1272'>
           elseif( p%Ndim == 4 ) then<a name='1273'>
             do n = param_first_scalar,p%num_table(dm)<a name='1274'>
               valid = .true.<a name='1275'>
               do m = 1,nVerbotten<a name='1276'>
                 tstring = trim(Verbotten(m))<a name='1277'>
                 call <A href='../../html_code/share/module_trajectory.F.html#UPCASE'>upcase</A><A href='../../html_code/share/module_trajectory.F.html#REG_SCAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPCASE_2">( tstring )<a name='1278'>
                 if( trim(tstring) == trim(p%dname_table(dm,n)) ) then<a name='1279'>
                   valid = .false.<a name='1280'>
                   exit<a name='1281'>
                 endif<a name='1282'>
               enddo<a name='1283'>
               if( valid ) then<a name='1284'>
                 cnt = cnt + 1<a name='1285'>
                 St_Vars(cnt)%Varname = trim(p%dname_table(dm,n))<a name='1286'>
                 St_Vars(cnt)%Description = p%Description <a name='1287'>
                 St_Vars(cnt)%Units   = p%Units <a name='1288'>
                 St_Vars(cnt)%MemOrd  = p%MemoryOrder <a name='1289'>
                 St_Vars(cnt)%Stagger = p%Stagger<a name='1290'>
                 St_Vars(cnt)%Ndim = 3<a name='1291'>
                 St_Vars(cnt)%rfield_3d =&gt; p%rfield_4d(:,:,:,p%index_table(n,dm))<a name='1292'>
               endif<a name='1293'>
             enddo<a name='1294'>
           endif<a name='1295'>
         endif<a name='1296'>
       endif<a name='1297'>
       p =&gt; p%next<a name='1298'>
     end do<a name='1299'>
   endif<a name='1300'>
<a name='1301'>
   end subroutine reg_scan<a name='1302'>
<a name='1303'>
<A NAME='GET_VAR_CNT'><A href='../../html_code/share/module_trajectory.F.html#GET_VAR_CNT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1304'>
   <font color=#993300>subroutine </font><font color=#cc0000>get_var_cnt</font>( n_vars, vars ) <A href='../../call_to/GET_VAR_CNT.html' TARGET='index'>6</A><a name='1305'>
<a name='1306'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1307'></font>
<font color=#447700>!  dummy arguments<a name='1308'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1309'></font>
   integer, intent(inout) :: n_vars<a name='1310'>
   character(len=32), intent(inout)  :: vars(:)<a name='1311'>
<a name='1312'>
   mask(:) = vars(:) /= ' '<a name='1313'>
   wrk_chr(:) = ' '<a name='1314'>
   m1 = 0<a name='1315'>
   do n = 1,var_max<a name='1316'>
     if( mask(n) ) then<a name='1317'>
       m1 = m1 + 1<a name='1318'>
       wrk_chr(m1) = vars(n)<a name='1319'>
     endif<a name='1320'>
   end do<a name='1321'>
<a name='1322'>
   n_vars  = count( wrk_chr(:) /= ' ' )<a name='1323'>
   vars(:) = wrk_chr(:)<a name='1324'>
<a name='1325'>
   end subroutine get_var_cnt<a name='1326'>
<a name='1327'>
<A NAME='SCAN_VARS'><A href='../../html_code/share/module_trajectory.F.html#SCAN_VARS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1328'>
   <font color=#993300>subroutine </font><font color=#cc0000>scan_vars</font>( n_vars, vars, var_ndx, n_tbl, tbl, &amp; <A href='../../call_to/SCAN_VARS.html' TARGET='index'>6</A>,<A href='../../call_from/SCAN_VARS.html' TARGET='index'>1</A><a name='1329'>
                         is_gas, var_type )<a name='1330'>
<a name='1331'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1332'></font>
<font color=#447700>!  dummy arguments<a name='1333'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1334'></font>
   integer, intent(inout) :: n_vars<a name='1335'>
   integer, intent(in)    :: n_tbl<a name='1336'>
   integer, intent(inout) :: var_ndx(:)<a name='1337'>
   logical, intent(inout) :: is_gas(:)<a name='1338'>
   character(len=*), intent(in)      :: var_type<a name='1339'>
   character(len=32), intent(inout)  :: vars(:)<a name='1340'>
   character(len=256), intent(in)    :: tbl(:)<a name='1341'>
<a name='1342'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1343'></font>
<font color=#447700>!  local variables<a name='1344'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1345'></font>
   integer :: ml<a name='1346'>
   integer :: ndx(var_max)<a name='1347'>
<a name='1348'>
var_loop: &amp;<a name='1349'>
   do n = 1,n_vars<a name='1350'>
     var_name = vars(n)<a name='1351'>
     if( trim(var_type) == 'chm' ) then<a name='1352'>
       i = index( '(a)', var_name )<a name='1353'>
       if( i == 0 ) then<a name='1354'>
         i = index( '(A)', var_name )<a name='1355'>
       endif<a name='1356'>
       if( i &gt; 0 ) then<a name='1357'>
         is_gas(n) = .false.<a name='1358'>
         var_name(i:) = ' '<a name='1359'>
         vars(n)(i:)  = ' '<a name='1360'>
       endif<a name='1361'>
     endif<a name='1362'>
     if( trim(var_type) == 'dyn' .or. trim(var_type) == 'msc' ) then<a name='1363'>
       ml = 1<a name='1364'>
     else<a name='1365'>
       ml = param_first_scalar<a name='1366'>
     endif<a name='1367'>
<font color=#447700>!    if( trim(var_type) /= 'dyn' ) then<a name='1368'></font>
<font color=#447700>!      ml = param_first_scalar<a name='1369'></font>
<font color=#447700>!    else<a name='1370'></font>
<font color=#447700>!      ml = 1<a name='1371'></font>
<font color=#447700>!    endif<a name='1372'></font>
     do m1 = ml,n_tbl<a name='1373'>
       if( trim(var_name) == trim(tbl(m1)) ) then<a name='1374'>
         mask(n) = .true.<a name='1375'>
         ndx(n)  = m1<a name='1376'>
         exit<a name='1377'>
       endif <a name='1378'>
     end do<a name='1379'>
     if( .not. mask(n) ) then<a name='1380'>
       write(err_mes,'(''scan_vars('',i2.2,''): '',a,'' not in '',a,'' opt'')') dm,trim(var_name),var_type<a name='1381'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_trajectory.F.html#SCAN_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1391">( trim(err_mes) )<a name='1382'>
     endif<a name='1383'>
   end do var_loop<a name='1384'>
<a name='1385'>
   if( trim(var_type) == 'dyn' .or. trim(var_type) == 'msc' ) then<a name='1386'>
     ndx(1:n_vars) = ndx(1:n_vars) + offset<a name='1387'>
   endif<a name='1388'>
<a name='1389'>
   wrk_chr(:) = ' '<a name='1390'>
   m1 = 0<a name='1391'>
   do n = 1,var_max<a name='1392'>
     if( mask(n) ) then<a name='1393'>
       m1 = m1 + 1<a name='1394'>
       wrk_chr(m1) = vars(n)<a name='1395'>
     endif<a name='1396'>
   end do<a name='1397'>
<a name='1398'>
   var_ndx(:count(mask)) = pack( ndx(:),mask=mask)<a name='1399'>
   vars(:) = wrk_chr(:)<a name='1400'>
   n_vars  = count( mask )<a name='1401'>
<a name='1402'>
   end subroutine scan_vars<a name='1403'>
<a name='1404'>
<A NAME='SET_IN_DOM'><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1405'>
   <font color=#993300>subroutine </font><font color=#cc0000>set_in_dom</font> <A href='../../call_to/SET_IN_DOM.html' TARGET='index'>1</A>,<A href='../../call_from/SET_IN_DOM.html' TARGET='index'>10</A><a name='1406'>
<a name='1407'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1408'></font>
<font color=#447700>!  local variables<a name='1409'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1410'></font>
   integer :: ncid<a name='1411'>
   integer :: ios<a name='1412'>
   integer :: time_id<a name='1413'>
   integer :: varid<a name='1414'>
   integer :: time_ndx<a name='1415'>
<a name='1416'>
   real    :: traj_i(n_traj)<a name='1417'>
   real    :: traj_j(n_traj)<a name='1418'>
   real    :: traj_k(n_traj)<a name='1419'>
<a name='1420'>
   character(len=256) :: err_mes<a name='1421'>
   character(len=256) :: filename<a name='1422'>
<a name='1423'>
include 'netcdf.inc'<a name='1424'>
<a name='1425'>
<font color=#447700>!---------------------------------------------------------------------<a name='1426'></font>
<font color=#447700>!  open netcdf file<a name='1427'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1428'></font>
   write(filename,'(''wrfout_traj_d'',i2.2)',iostat=ios) dm<a name='1429'>
   if( ios /= 0 ) then<a name='1430'>
     write(err_mes,'(''set_in_dom: failed to set filename: error = '',i6)') ios<a name='1431'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1470">( trim( err_mes  ) )<a name='1432'>
   endif<a name='1433'>
   ios = nf_open( trim(filename), nf_nowrite, ncid )<a name='1434'>
   if( ios /= 0 ) then<a name='1435'>
     write(err_mes,'(''set_in_dom: failed to open '',a,'': error = '',i6)') trim(filename),ios<a name='1436'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1471">( trim( err_mes  ) )<a name='1437'>
   endif<a name='1438'>
<a name='1439'>
<font color=#447700>!---------------------------------------------------------------------<a name='1440'></font>
<font color=#447700>!  get current time index<a name='1441'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1442'></font>
   err_mes = 'set_in_dom: failed to get time id'<a name='1443'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_1">( nf_inq_dimid( ncid, 'time', time_id ),trim(err_mes) )<a name='1444'>
   err_mes = 'set_in_dom: failed to get time dimension'<a name='1445'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_2">( nf_inq_dimlen( ncid, time_id, time_ndx ),trim(err_mes) )<a name='1446'>
<a name='1447'>
<font color=#447700>!---------------------------------------------------------------------<a name='1448'></font>
<font color=#447700>!  read in last traj_{i,j,k} variables<a name='1449'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='1450'></font>
   err_mes = 'set_in_dom: failed to get traj_i id'<a name='1451'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_3">( nf_inq_varid( ncid, 'traj_i', varid ),trim(err_mes) )<a name='1452'>
   err_mes = 'set_in_dom: failed to get traj_i'<a name='1453'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_4">( nf_get_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,1 /), &amp;<a name='1454'>
                                        traj_i ),trim(err_mes) )<a name='1455'>
   err_mes = 'set_in_dom: failed to get traj_j id'<a name='1456'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_5">( nf_inq_varid( ncid, 'traj_j', varid ),trim(err_mes) )<a name='1457'>
   err_mes = 'set_in_dom: failed to get traj_j'<a name='1458'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_6">( nf_get_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,1 /), &amp;<a name='1459'>
                                        traj_j ),trim(err_mes) )<a name='1460'>
   err_mes = 'set_in_dom: failed to get traj_k id'<a name='1461'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_7">( nf_inq_varid( ncid, 'traj_k', varid ),trim(err_mes) )<a name='1462'>
   err_mes = 'set_in_dom: failed to get traj_k'<a name='1463'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#SET_IN_DOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_8">( nf_get_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,1 /), &amp;<a name='1464'>
                                        traj_k ),trim(err_mes) )<a name='1465'>
   traj_type(1:n_traj)%in_dom = traj_i(1:n_traj) /= missing_val .and.  traj_j(1:n_traj) /= missing_val &amp;<a name='1466'>
                                                                .and.  traj_k(1:n_traj) /= missing_val<a name='1467'>
<a name='1468'>
   ios = nf_close( ncid )<a name='1469'>
<a name='1470'>
   end subroutine set_in_dom<a name='1471'>
<a name='1472'>
   end subroutine trajectory_init<a name='1473'>
<a name='1474'>
#ifdef NETCDF<a name='1475'>
<A NAME='TRAJECTORY_DRIVER'><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1476'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajectory_driver</font>( grid ) <A href='../../call_to/TRAJECTORY_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/TRAJECTORY_DRIVER.html' TARGET='index'>26</A><a name='1477'>
<a name='1478'>
#ifdef DM_PARALLEL<a name='1479'>
   use <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_197">, only : &amp;<a name='1480'>
                  local_communicator, mytask, ntasks, ntasks_x, ntasks_y                   &amp;<a name='1481'>
                 ,local_communicator_periodic, wrf_dm_max_real, wrf_dm_max_int<a name='1482'>
   use <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_34">, only : halo_em_chem_e_3_sub, halo_em_moist_e_3_sub<a name='1483'>
   use <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_35">, only : halo_em_tracer_e_3_sub<a name='1484'>
#endif<a name='1485'>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_437"><a name='1486'>
   use <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_28"><a name='1487'>
   use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_198">, only : num_chem<a name='1488'>
   use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_199">, only : num_moist, num_tracer, param_first_scalar<a name='1489'>
<a name='1490'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1491'></font>
<font color=#447700>!  dummy arguments<a name='1492'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1493'></font>
   type(domain), intent(in) :: grid<a name='1494'>
<a name='1495'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1496'></font>
<font color=#447700>!  local variables<a name='1497'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1498'></font>
   integer :: ims,ime, jms,jme, kms,kme<a name='1499'>
   integer :: ids,ide, jds,jde, kds,kde<a name='1500'>
   integer :: ips,ipe, jps,jpe, kps,kpe<a name='1501'>
   integer :: dm<a name='1502'>
   integer :: j, k<a name='1503'>
   integer :: il, iu, ios, jl, ju, kl, ku<a name='1504'>
   integer :: m, mu, n, ndx, n_vars, n_traj<a name='1505'>
   integer :: pkg_var_cnt(traj_max)<a name='1506'>
   integer :: ncid<a name='1507'>
   integer :: pkg, trj<a name='1508'>
   integer :: n_msc_buf<a name='1509'>
   integer :: num_chem_sav<a name='1510'>
   integer, pointer :: num_msc      <font color=#447700>! number misc species<a name='1511'></font>
   integer, pointer :: n_dchm       <font color=#447700>! number dchm buffer species<a name='1512'></font>
   integer, pointer :: dchm_buf_ndx(:)<a name='1513'>
   integer :: St_Vars_ndx<a name='1514'>
   integer, allocatable :: St_Vars_buf_ndx(:)<a name='1515'>
#ifndef DM_PARALLEL<a name='1516'>
   integer :: mytask<a name='1517'>
#endif<a name='1518'>
   integer :: traj_proc(traj_max), glb_traj_proc(traj_max)<a name='1519'>
   real :: dchm_fill_val(traj_max)<a name='1520'>
   real :: x, y, zi<a name='1521'>
   real :: delsx, delsy, o_delsx, o_delsy<a name='1522'>
   real :: delsz, o_delsz<a name='1523'>
   real :: max_conc<a name='1524'>
   real :: horz_conc(2)<a name='1525'>
   real, pointer :: traj_conc(:)<a name='1526'>
   real, target  :: traj_val(var_max,traj_max)<a name='1527'>
   real, pointer :: wrk4d(:,:,:,:)<a name='1528'>
   real, allocatable, target :: chem(:,:,:,:)<a name='1529'>
   real, allocatable, target :: moist(:,:,:,:)<a name='1530'>
   real, allocatable, target :: tracer(:,:,:,:)<a name='1531'>
   character(len=19)  :: current_timestr, next_timestr<a name='1532'>
   character(len=32)  :: var_name(var_max)<a name='1533'>
   character(len=256) :: err_mes<a name='1534'>
   logical :: has_dchm<a name='1535'>
   logical :: is_root_proc<a name='1536'>
   logical :: is_in_patch_gap<a name='1537'>
   logical :: flsh_buff<a name='1538'>
   logical :: found<a name='1539'>
   logical :: traj_is_active(traj_max)<a name='1540'>
   logical :: pkg_is_active(traj_max,pkg_max)<a name='1541'>
   logical, pointer :: pkg_has_vars(:,:)<a name='1542'>
<a name='1543'>
   logical, external :: wrf_dm_on_monitor<a name='1544'>
<a name='1545'>
   type(WRFU_Time) :: current_time, next_time<a name='1546'>
   type(WRFU_Time) :: start_time, stop_time<a name='1547'>
<a name='1548'>
include 'netcdf.inc'<a name='1549'>
<a name='1550'>
#ifndef DM_PARALLEL<a name='1551'>
   mytask = 0<a name='1552'>
#endif<a name='1553'>
   dm = grid%id<a name='1554'>
   n_traj = traj_cnt(dm)<a name='1555'>
has_trajectories: &amp;<a name='1556'>
   if( dm_has_traj(dm) .and. n_traj &gt; 0 ) then<a name='1557'>
     St_Vars =&gt; St_Vars_dm(:,dm)<a name='1558'>
     St_Vars_msk =&gt; St_Vars_msk_dm(:,dm)<a name='1559'>
     num_msc =&gt; num_msc_dm(dm)<a name='1560'>
     trjects =&gt; traject(:,dm)<a name='1561'>
     n_vals  =&gt; n_vals_dm(dm)<a name='1562'>
     is_root_proc = <A href='../../html_code/io_netcdf/diffwrf.F90.html#WRF_DM_ON_MONITOR'>wrf_dm_on_monitor</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_ON_MONITOR_4">()<a name='1563'>
     if( is_root_proc ) then<a name='1564'>
       trj_pbf =&gt; trj_buff(:,dm)<a name='1565'>
     endif<a name='1566'>
     has_dchm = any( trjects(:n_traj)%n_dchm_var &gt; 0 )<a name='1567'>
     if( has_dchm ) then<a name='1568'>
       n_dchm =&gt; n_dchm_dm(dm)<a name='1569'>
       dchm_buf_ndx =&gt; dchm_buf_ndx_dm(:,dm)<a name='1570'>
     endif<a name='1571'>
<a name='1572'>
     call <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_115">( grid ,                   &amp;<a name='1573'>
                             ids, ide, jds, jde, kds, kde,    &amp;<a name='1574'>
                             ims, ime, jms, jme, kms, kme,    &amp;<a name='1575'>
                             ips, ipe, jps, jpe, kps, kpe    )<a name='1576'>
<a name='1577'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1578'></font>
<font color=#447700>!  is trajectory in time interval?<a name='1579'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1580'></font>
     call <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_80">( grid, current_time=current_time, current_timestr=current_timestr)<a name='1581'>
     call <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_18">( next_timestr, current_timestr, int(grid%dt) )<a name='1582'>
     call <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_20">( next_timestr(1:19), next_time )<a name='1583'>
     do trj = 1,n_traj<a name='1584'>
       call <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_21">( traject(trj,dm)%start_time(1:19), start_time )<a name='1585'>
       call <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_22">( traject(trj,dm)%stop_time(1:19), stop_time )<a name='1586'>
       traj_is_active(trj) = next_time .ge. start_time .and. next_time .le. stop_time<a name='1587'>
     end do<a name='1588'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1589'></font>
<font color=#447700>!  is trajectory in domain?<a name='1590'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1591'></font>
     pkg_has_vars =&gt; pkg_has_vars_dm(:,:,dm)<a name='1592'>
     do trj = 1,n_traj<a name='1593'>
       if( traj_is_active(trj) ) then<a name='1594'>
         trjects(trj)%in_dom = grid%traj_i(trj) &gt;= real(ids) .and. grid%traj_i(trj) &lt;= real(ide-1)<a name='1595'>
         if( trjects(trj)%in_dom ) then<a name='1596'>
           trjects(trj)%in_dom = grid%traj_j(trj) &gt;= real(jds) .and. grid%traj_j(trj) &lt;= real(jde-1)<a name='1597'>
         endif<a name='1598'>
         if( trjects(trj)%in_dom ) then<a name='1599'>
           trjects(trj)%in_dom = grid%traj_k(trj) &gt;= real(kps) .and. grid%traj_k(trj) &lt;= real( min( kpe,kde-1 ) )<a name='1600'>
         endif<a name='1601'>
         traj_is_active(trj) = trjects(trj)%in_dom<a name='1602'>
       endif<a name='1603'>
     end do<a name='1604'>
     do pkg = 1,pkg_max<a name='1605'>
       pkg_is_active(:n_traj,pkg) = traj_is_active(:n_traj) .and. pkg_has_vars(:n_traj,pkg)<a name='1606'>
     end do<a name='1607'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1608'></font>
<font color=#447700>!  check whether this is a chemistry time step<a name='1609'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1610'></font>
     dchm_fill_val(:n_traj) = missing_val<a name='1611'>
     if( .not. do_chemstep ) then<a name='1612'>
       do trj = 1,n_traj<a name='1613'>
         if( pkg_is_active(trj,dchm_pkg) ) then<a name='1614'>
           dchm_fill_val(trj) = zero_val<a name='1615'>
         endif<a name='1616'>
       end do<a name='1617'>
       pkg_is_active(:n_traj,dchm_pkg) = .false.<a name='1618'>
     endif<a name='1619'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1620'></font>
<font color=#447700>!  is trajectory in mpi process?<a name='1621'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1622'></font>
     traj_proc(:n_traj) = -1<a name='1623'>
     do trj = 1,n_traj<a name='1624'>
       if( traj_is_active(trj) ) then<a name='1625'>
         trjects(trj)%in_patch = grid%traj_i(trj) &gt;= real(ips) .and. grid%traj_i(trj) &lt;= real( min( ipe,ide-1 ) )<a name='1626'>
         if( trjects(trj)%in_patch ) then<a name='1627'>
           trjects(trj)%in_patch = grid%traj_j(trj) &gt;= real(jps) .and. grid%traj_j(trj) &lt;= real( min( jpe,jde-1 ) )<a name='1628'>
         endif<a name='1629'>
         if( trjects(trj)%in_patch ) then<a name='1630'>
           trjects(trj)%in_patch = grid%traj_k(trj) &gt;= real(kps) .and. grid%traj_k(trj) &lt;= real( min( kpe,kde-1 ) )<a name='1631'>
         endif<a name='1632'>
         if( trjects(trj)%in_patch ) then<a name='1633'>
           traj_proc(trj) = mytask + 1<a name='1634'>
         else<a name='1635'>
           traj_proc(trj) = 0<a name='1636'>
         endif<a name='1637'>
       endif<a name='1638'>
     end do<a name='1639'>
#ifdef DM_PARALLEL<a name='1640'>
     do trj = 1,n_traj<a name='1641'>
       glb_traj_proc(trj) = <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAX_INT'>wrf_dm_max_int</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_INT_1">( traj_proc(trj) )<a name='1642'>
     end do<a name='1643'>
#else<a name='1644'>
     glb_traj_proc(1:n_traj) = traj_proc(1:n_traj)<a name='1645'>
#endif<a name='1646'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1647'></font>
<font color=#447700>!  any trajectories in "gap" between patches?<a name='1648'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1649'></font>
     do trj = 1,n_traj<a name='1650'>
       if( traj_is_active(trj) .and. glb_traj_proc(trj) == 0 ) then<a name='1651'>
         trjects(trj)%in_patch = grid%traj_i(trj) &gt;= real(ips) .and. grid%traj_i(trj) &lt;= real( min( ipe+1,ide-1 ) )<a name='1652'>
         if( trjects(trj)%in_patch ) then<a name='1653'>
           trjects(trj)%in_patch = grid%traj_j(trj) &gt;= real(jps) .and. grid%traj_j(trj) &lt;= real( min( jpe+1,jde-1 ) )<a name='1654'>
         endif<a name='1655'>
         if( trjects(trj)%in_patch ) then<a name='1656'>
           trjects(trj)%in_patch = grid%traj_k(trj) &gt;= real(kps) .and. grid%traj_k(trj) &lt;= real( min( kme,kde-1 ) )<a name='1657'>
         endif<a name='1658'>
         if( trjects(trj)%in_patch ) then<a name='1659'>
           traj_proc(trj) = mytask + 1<a name='1660'>
         else<a name='1661'>
           traj_proc(trj) = 0<a name='1662'>
         endif<a name='1663'>
         if( traj_proc(trj) /= 0 ) then<a name='1664'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1117">( 0,'^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^')<a name='1665'>
           write(err_mes,'(''Gapper '',i5,''; x,y,zi = '',1p,3g15.7)') trj,grid%traj_i(trj),grid%traj_j(trj),grid%traj_k(trj)<a name='1666'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1118">( 0,trim(err_mes) )<a name='1667'>
           write(err_mes,'(''Gapper ips,ipe,jps,jpe = '',4i5)') ips,ipe,jps,jpe<a name='1668'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1119">( 0,trim(err_mes) )<a name='1669'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1120">( 0,'^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^')<a name='1670'>
         endif<a name='1671'>
       endif<a name='1672'>
     end do<a name='1673'>
<a name='1674'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1675'></font>
<font color=#447700>!  buffer traj time and position<a name='1676'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1677'></font>
     if( is_root_proc ) then<a name='1678'>
       n_vals = n_vals + 1<a name='1679'>
       if( grid%itimestep &gt; 0 ) then<a name='1680'>
         trj_pbf(:n_traj)%times(n_vals) = next_timestr<a name='1681'>
       else<a name='1682'>
         trj_pbf(:n_traj)%times(n_vals) = current_timestr<a name='1683'>
       endif<a name='1684'>
       do trj = 1,n_traj<a name='1685'>
         trj_pbf(trj)%trj_i(n_vals) = grid%traj_i(trj)<a name='1686'>
         trj_pbf(trj)%trj_j(n_vals) = grid%traj_j(trj)<a name='1687'>
         trj_pbf(trj)%trj_k(n_vals) = grid%traj_k(trj)<a name='1688'>
         trj_pbf(trj)%trj_lons(n_vals) = grid%traj_long(trj)<a name='1689'>
         trj_pbf(trj)%trj_lats(n_vals) = grid%traj_lat(trj)<a name='1690'>
       end do<a name='1691'>
     endif<a name='1692'>
<a name='1693'>
     do trj = 1,n_traj<a name='1694'>
       traj_val(:,trj) = missing_val<a name='1695'>
     end do<a name='1696'>
<a name='1697'>
pkg_loop: &amp;<a name='1698'>
     do pkg = 1,pkg_max <a name='1699'>
pkg_has_active_traj: &amp;<a name='1700'>
       if( any( pkg_is_active(:n_traj,pkg) ) ) then<a name='1701'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1702'></font>
<font color=#447700>!  allocate working data array<a name='1703'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1704'></font>
         select case( trim(pkg_tag(pkg)) )<a name='1705'>
#if( WRF_CHEM == 1 )<a name='1706'>
           case( 'chm' )<a name='1707'>
             allocate( chem(ims:ime,kms:kme,jms:jme,num_chem),stat=ios )<a name='1708'>
           case( 'dchm' )<a name='1709'>
             if( n_dchm &gt; 0 ) then<a name='1710'>
               allocate( chem(ims:ime,kms:kme,jms:jme,n_dchm+offset),stat=ios )<a name='1711'>
             endif<a name='1712'>
#endif<a name='1713'>
           case( 'hyd' )<a name='1714'>
             allocate( moist(ims:ime,kms:kme,jms:jme,num_moist),stat=ios )<a name='1715'>
           case( 'trc' )<a name='1716'>
             allocate( tracer(ims:ime,kms:kme,jms:jme,num_tracer),stat=ios )<a name='1717'>
           case( 'dyn' )<a name='1718'>
             allocate( chem(ims:ime,kms:kme,jms:jme,dyn_max+offset+2),stat=ios )<a name='1719'>
           case( 'msc' )<a name='1720'>
             m = count( St_Vars_msk(:num_msc) )<a name='1721'>
             if( m &gt; 0 ) then<a name='1722'>
               allocate( chem(ims:ime,kms:kme,jms:jme,m+offset), &amp;<a name='1723'>
                         St_Vars_buf_ndx(m+offset),stat=ios )<a name='1724'>
             endif<a name='1725'>
           case default<a name='1726'>
             ios = 0<a name='1727'>
         end select<a name='1728'>
         if( ios /= 0 ) then<a name='1729'>
           write(err_mes,'(''trajectory_driver: failed to allocate wrk4d: error = '',i6)') ios<a name='1730'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1472">( trim( err_mes  ) )<a name='1731'>
         endif<a name='1732'>
         select case( trim(pkg_tag(pkg)) )<a name='1733'>
#if( WRF_CHEM == 1 )<a name='1734'>
           case( 'chm' )<a name='1735'>
             do m = 1,num_chem<a name='1736'>
               do j = jps,jpe<a name='1737'>
                 do k = kps,kpe<a name='1738'>
                   chem(ips:ipe,k,j,m) = grid%chem(ips:ipe,k,j,m)<a name='1739'>
                 end do<a name='1740'>
               end do<a name='1741'>
             end do<a name='1742'>
           case( 'dchm' )<a name='1743'>
             do m = param_first_scalar,n_dchm+offset<a name='1744'>
               do j = jps,jpe<a name='1745'>
                 do k = kps,kpe<a name='1746'>
                   chem(ips:ipe,k,j,m) = dchm_buff(ips:ipe,k,j,m)<a name='1747'>
                 end do<a name='1748'>
               end do<a name='1749'>
             end do<a name='1750'>
#endif<a name='1751'>
           case( 'hyd' )<a name='1752'>
             do m = 1,num_moist<a name='1753'>
               do j = jps,jpe<a name='1754'>
                 do k = kps,kpe<a name='1755'>
                   moist(ips:ipe,k,j,m) = grid%moist(ips:ipe,k,j,m)<a name='1756'>
                 end do<a name='1757'>
               end do<a name='1758'>
             end do<a name='1759'>
           case( 'trc' )<a name='1760'>
             do m = 1,num_tracer<a name='1761'>
               do j = jps,jpe<a name='1762'>
                 do k = kps,kpe<a name='1763'>
                   tracer(ips:ipe,k,j,m) = grid%tracer(ips:ipe,k,j,m)<a name='1764'>
                 end do<a name='1765'>
               end do<a name='1766'>
             end do<a name='1767'>
           case( 'dyn' )<a name='1768'>
             call <A href='../../html_code/share/module_trajectory.F.html#PACK_DYN_VALS'>pack_dyn_vals</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PACK_DYN_VALS_1"><a name='1769'>
           case( 'msc' )<a name='1770'>
             n_msc_buf = 1<a name='1771'>
             do m = 1,num_msc<a name='1772'>
               if( St_Vars_msk(m) ) then<a name='1773'>
                 n_msc_buf = n_msc_buf + 1<a name='1774'>
                 St_Vars_buf_ndx(n_msc_buf) = m<a name='1775'>
                 do j = jps,jpe<a name='1776'>
                   do k = kps,kpe<a name='1777'>
                     chem(ips:ipe,k,j,n_msc_buf) = St_Vars(m)%rfield_3d(ips:ipe,k,j)<a name='1778'>
                   end do<a name='1779'>
                 end do<a name='1780'>
               endif<a name='1781'>
             end do<a name='1782'>
         end select<a name='1783'>
#ifdef DM_PARALLEL<a name='1784'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1785'></font>
<font color=#447700>!  any trajectories in "gap" between patches?<a name='1786'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1787'></font>
             is_in_patch_gap = any( glb_traj_proc(:n_traj) == 0 .and. pkg_is_active(:n_traj,pkg) )<a name='1788'>
             if( is_in_patch_gap ) then<a name='1789'>
<font color=#447700>!              write(err_mes,'(''glb_traj_proc mask = '',10i5)') glb_traj_proc(:n_traj)<a name='1790'></font>
<font color=#447700>!              call wrf_debug( 0,trim(err_mes) )<a name='1791'></font>
               select case( trim(pkg_tag(pkg)) )<a name='1792'>
#if( WRF_CHEM == 1 )<a name='1793'>
                 case( 'chm' )<a name='1794'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_1"><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1795'>
                 case( 'dchm' )<a name='1796'>
                   num_chem_sav = num_chem<a name='1797'>
                   num_chem     = n_dchm<a name='1798'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_2"><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1799'>
                   num_chem = num_chem_sav<a name='1800'>
#endif<a name='1801'>
                 case( 'hyd' )<a name='1802'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_3.inc.html'>HALO_EM_MOIST_E_3.inc</A>"<A NAME="HALO_EM_MOIST_E_3.inc_3"><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1803'>
                 case( 'trc' )<a name='1804'>
#      include "<A href='../../html_code/include/HALO_EM_TRACER_E_3.inc.html'>HALO_EM_TRACER_E_3.inc</A>"<A NAME="HALO_EM_TRACER_E_3.inc_4"><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1805'>
                 case( 'dyn' )<a name='1806'>
                   num_chem_sav = num_chem<a name='1807'>
                   num_chem     = dyn_max + offset + 2<a name='1808'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_5"><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1809'>
                   num_chem = num_chem_sav<a name='1810'>
                 case( 'msc' )<a name='1811'>
                   num_chem_sav = num_chem<a name='1812'>
                   num_chem     = n_msc_buf<a name='1813'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_6"><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1814'>
                   num_chem = num_chem_sav<a name='1815'>
               end select<a name='1816'>
             endif<a name='1817'>
#endif<a name='1818'>
<a name='1819'>
traj_loop: &amp;<a name='1820'>
         do trj = 1,n_traj<a name='1821'>
           select case( trim(pkg_tag(pkg)) )<a name='1822'>
             case( 'chm' )<a name='1823'>
               n_vars = traject(trj,dm)%n_chm_var<a name='1824'>
             case( 'hyd' )<a name='1825'>
               n_vars = traject(trj,dm)%n_hyd_var<a name='1826'>
             case( 'trc' )<a name='1827'>
               n_vars = traject(trj,dm)%n_trc_var<a name='1828'>
             case( 'dyn' )<a name='1829'>
               n_vars = traject(trj,dm)%n_dyn_var<a name='1830'>
             case( 'msc' )<a name='1831'>
               n_vars = traject(trj,dm)%n_msc_var<a name='1832'>
             case( 'dchm' )<a name='1833'>
               n_vars = traject(trj,dm)%n_dchm_var<a name='1834'>
           end select<a name='1835'>
pkg_is_active_in_traj: &amp;<a name='1836'>
           if( pkg_is_active(trj,pkg) ) then<a name='1837'>
             select case( trim(pkg_tag(pkg)) )<a name='1838'>
#if( WRF_CHEM == 1 )<a name='1839'>
               case( 'chm', 'dchm' )<a name='1840'>
                 wrk4d =&gt; chem<a name='1841'>
#endif<a name='1842'>
               case( 'dyn', 'msc' )<a name='1843'>
                 wrk4d =&gt; chem<a name='1844'>
               case( 'hyd' )<a name='1845'>
                 wrk4d =&gt; moist<a name='1846'>
               case( 'trc' )<a name='1847'>
                 wrk4d =&gt; tracer<a name='1848'>
             end select<a name='1849'>
in_patch:    if( traj_proc(trj) == mytask+1 ) then<a name='1850'>
               x = grid%traj_i(trj)<a name='1851'>
               y = grid%traj_j(trj)<a name='1852'>
               zi = grid%traj_k(trj)<a name='1853'>
               il = int( x ) ; iu = il + 1<a name='1854'>
               jl = int( y ) ; ju = jl + 1<a name='1855'>
               kl = int( zi ) ; ku = kl + 1<a name='1856'>
               delsx = x - floor(x) ; o_delsx = 1. - delsx<a name='1857'>
               delsy = y - floor(y) ; o_delsy = 1. - delsy<a name='1858'>
               delsz = zi - floor(zi) ; o_delsz = 1. - delsz<a name='1859'>
var_loop:      do n = 1,n_vars<a name='1860'>
                 found = .true.<a name='1861'>
                 select case( trim(pkg_tag(pkg)) )<a name='1862'>
                   case( 'chm' )<a name='1863'>
                     ndx = traject(trj,dm)%chm_ndx(n)<a name='1864'>
                   case( 'hyd' )<a name='1865'>
                     ndx = traject(trj,dm)%hyd_ndx(n)<a name='1866'>
                   case( 'trc' )<a name='1867'>
                     ndx = traject(trj,dm)%trc_ndx(n)<a name='1868'>
                   case( 'dyn' )<a name='1869'>
                     ndx = 1<a name='1870'>
                     call <A href='../../html_code/share/module_trajectory.F.html#SET_DYN_VALS'>set_dyn_vals</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_DYN_VALS_1"><a name='1871'>
                   case( 'msc' )<a name='1872'>
                     found = .false.<a name='1873'>
                     St_Vars_ndx = trjects(trj)%msc_ndx(n) - offset<a name='1874'>
                     do ndx = param_first_scalar,n_msc_buf<a name='1875'>
                       if( St_Vars_ndx == St_Vars_buf_ndx(ndx) ) then<a name='1876'>
                         found = .true.<a name='1877'>
                         exit<a name='1878'>
                       endif<a name='1879'>
                     end do<a name='1880'>
                     if( found ) then<a name='1881'>
                       call <A href='../../html_code/share/module_trajectory.F.html#SET_MSC_VALS'>set_msc_vals</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_MSC_VALS_1"><a name='1882'>
                     endif<a name='1883'>
                     ndx = 1<a name='1884'>
                   case( 'dchm' )<a name='1885'>
                     ndx = trjects(trj)%dchm_ndx(n)<a name='1886'>
                 end select<a name='1887'>
                 if( found ) then<a name='1888'>
                   horz_conc(1) = o_delsx*o_delsy*wrk4d(il,kl,jl,ndx) + o_delsy*delsx*wrk4d(iu,kl,jl,ndx) &amp;<a name='1889'>
                                + delsy*o_delsx*wrk4d(il,kl,ju,ndx) + delsx*delsy*wrk4d(iu,kl,ju,ndx)<a name='1890'>
                   horz_conc(2) = o_delsx*o_delsy*wrk4d(il,ku,jl,ndx) + o_delsy*delsx*wrk4d(iu,ku,jl,ndx) &amp;<a name='1891'>
                                + delsy*o_delsx*wrk4d(il,ku,ju,ndx) + delsx*delsy*wrk4d(iu,ku,ju,ndx)<a name='1892'>
                   traject(trj,dm)%traj_var(n) = delsz*horz_conc(2) + o_delsz*horz_conc(1)<a name='1893'>
                 else<a name='1894'>
                   traject(trj,dm)%traj_var(n) = missing_val<a name='1895'>
                 endif<a name='1896'>
               end do var_loop<a name='1897'>
             else in_patch<a name='1898'>
               traject(trj,dm)%traj_var(:n_vars) = missing_val<a name='1899'>
             endif in_patch<a name='1900'>
             traj_conc =&gt; traj_val(:,trj)<a name='1901'>
             do n = 1,n_vars<a name='1902'>
#ifdef DM_PARALLEL<a name='1903'>
               max_conc = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_13">( traject(trj,dm)%traj_var(n) )<a name='1904'>
#else<a name='1905'>
               max_conc = traject(trj,dm)%traj_var(n)<a name='1906'>
#endif<a name='1907'>
               if( is_root_proc ) then<a name='1908'>
                 traj_conc(n) = max_conc<a name='1909'>
               endif<a name='1910'>
             end do<a name='1911'>
           else pkg_is_active_in_traj<a name='1912'>
             if( is_root_proc .and. n_vars &gt; 0 ) then<a name='1913'>
               traj_conc =&gt; traj_val(:,trj)<a name='1914'>
               traj_conc(:n_vars) = missing_val<a name='1915'>
             endif<a name='1916'>
           endif pkg_is_active_in_traj<a name='1917'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1918'></font>
<font color=#447700>!  buffer traj chm,trc,hyb,msc,dchm variables<a name='1919'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1920'></font>
           if( is_root_proc .and. n_vars &gt; 0 ) then<a name='1921'>
             select case( pkg_tag(pkg) )<a name='1922'>
#if( WRF_CHEM == 1 )<a name='1923'>
               case( 'chm' )<a name='1924'>
                 trj_pbf(trj)%chm_vals(n_vals,:n_vars) = traj_conc(:n_vars)<a name='1925'>
               case( 'dchm' )<a name='1926'>
                 trj_pbf(trj)%dchm_vals(n_vals,:n_vars) = traj_conc(:n_vars)<a name='1927'>
#endif<a name='1928'>
               case( 'hyd' )<a name='1929'>
                 trj_pbf(trj)%hyd_vals(n_vals,:n_vars) = traj_conc(:n_vars)<a name='1930'>
               case( 'trc' )<a name='1931'>
                 trj_pbf(trj)%trc_vals(n_vals,:n_vars) = traj_conc(:n_vars)<a name='1932'>
               case( 'dyn' )<a name='1933'>
                 trj_pbf(trj)%dyn_vals(n_vals,:n_vars) = traj_conc(:n_vars)<a name='1934'>
               case( 'msc' )<a name='1935'>
                 trj_pbf(trj)%msc_vals(n_vals,:n_vars) = traj_conc(:n_vars)<a name='1936'>
             end select<a name='1937'>
           endif<a name='1938'>
         end do traj_loop<a name='1939'>
         if( allocated( chem ) ) then<a name='1940'>
           deallocate( chem )<a name='1941'>
         endif<a name='1942'>
         if( allocated( moist ) ) then<a name='1943'>
           deallocate( moist )<a name='1944'>
         endif<a name='1945'>
         if( allocated( tracer ) ) then<a name='1946'>
           deallocate( tracer )<a name='1947'>
         endif<a name='1948'>
         if( allocated( St_Vars_buf_ndx ) ) then<a name='1949'>
           deallocate( St_Vars_buf_ndx )<a name='1950'>
         endif<a name='1951'>
         if( pkg == dchm_pkg .and. allocated( dchm_buff ) ) then<a name='1952'>
           deallocate( dchm_buff )<a name='1953'>
         endif<a name='1954'>
       else pkg_has_active_traj<a name='1955'>
         if( is_root_proc ) then<a name='1956'>
           do trj = 1,n_traj<a name='1957'>
             select case( trim(pkg_tag(pkg)) )<a name='1958'>
#if( WRF_CHEM == 1 )<a name='1959'>
               case( 'chm' )<a name='1960'>
                 n_vars = traject(trj,dm)%n_chm_var<a name='1961'>
               case( 'dchm' )<a name='1962'>
                 n_vars = traject(trj,dm)%n_dchm_var<a name='1963'>
#endif<a name='1964'>
               case( 'hyd' )<a name='1965'>
                 n_vars = traject(trj,dm)%n_hyd_var<a name='1966'>
               case( 'trc' )<a name='1967'>
                 n_vars = traject(trj,dm)%n_trc_var<a name='1968'>
               case( 'dyn' )<a name='1969'>
                 n_vars = traject(trj,dm)%n_dyn_var<a name='1970'>
               case( 'msc' )<a name='1971'>
                 n_vars = traject(trj,dm)%n_msc_var<a name='1972'>
             end select<a name='1973'>
             if( n_vars &gt; 0 ) then<a name='1974'>
               select case( pkg_tag(pkg) )<a name='1975'>
#if( WRF_CHEM == 1 )<a name='1976'>
                 case( 'chm' )<a name='1977'>
                   trj_pbf(trj)%chm_vals(n_vals,:n_vars) = missing_val<a name='1978'>
                 case( 'dchm' )<a name='1979'>
                   trj_pbf(trj)%dchm_vals(n_vals,:n_vars) = dchm_fill_val(trj)<a name='1980'>
#endif<a name='1981'>
                 case( 'hyd' )<a name='1982'>
                   trj_pbf(trj)%hyd_vals(n_vals,:n_vars) = missing_val<a name='1983'>
                 case( 'trc' )<a name='1984'>
                   trj_pbf(trj)%trc_vals(n_vals,:n_vars) = missing_val<a name='1985'>
                 case( 'dyn' )<a name='1986'>
                   trj_pbf(trj)%dyn_vals(n_vals,:n_vars) = missing_val<a name='1987'>
                 case( 'msc' )<a name='1988'>
                   trj_pbf(trj)%msc_vals(n_vals,:n_vars) = missing_val<a name='1989'>
               end select<a name='1990'>
             endif<a name='1991'>
           end do<a name='1992'>
         endif<a name='1993'>
       endif pkg_has_active_traj<a name='1994'>
     end do pkg_loop<a name='1995'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1996'></font>
<font color=#447700>!  output trajectory buffer<a name='1997'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1998'></font>
     if( is_root_proc ) then<a name='1999'>
       flsh_buff = n_vals == vals_max .or. domain_last_time_step( grid )<a name='2000'>
       if( flsh_buff ) then<a name='2001'>
         call <A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE'>trajectory_write_file</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRAJECTORY_WRITE_FILE_1">( n_traj, n_vals, dm )<a name='2002'>
       endif<a name='2003'>
     endif<a name='2004'>
   endif has_trajectories<a name='2005'>
<a name='2006'>
   CONTAINS<a name='2007'>
<a name='2008'>
<A NAME='PACK_DYN_VALS'><A href='../../html_code/share/module_trajectory.F.html#PACK_DYN_VALS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2009'>
   <font color=#993300>subroutine </font><font color=#cc0000>pack_dyn_vals</font> <A href='../../call_to/PACK_DYN_VALS.html' TARGET='index'>1</A><a name='2010'>
<a name='2011'>
   integer :: mp1<a name='2012'>
<a name='2013'>
   do m = 1,dyn_max+2<a name='2014'>
     mp1 = m + 1<a name='2015'>
     select case( m )<a name='2016'>
       case( 1 )<a name='2017'>
         do j = jps,jpe<a name='2018'>
           do k = kps,kpe<a name='2019'>
             chem(ips:ipe,k,j,mp1) = grid%p(ips:ipe,k,j)<a name='2020'>
           end do<a name='2021'>
         end do<a name='2022'>
       case( 2 )<a name='2023'>
         do j = jps,jpe<a name='2024'>
           do k = kps,kpe<a name='2025'>
             chem(ips:ipe,k,j,mp1) = grid%t_2(ips:ipe,k,j)<a name='2026'>
           end do<a name='2027'>
         end do<a name='2028'>
       case( 3 )<a name='2029'>
         do j = jps,jpe<a name='2030'>
           do k = kps,kpe<a name='2031'>
             chem(ips:ipe,k,j,mp1) = grid%pb(ips:ipe,k,j)<a name='2032'>
           end do<a name='2033'>
         end do<a name='2034'>
       case( 4 )<a name='2035'>
         do j = jps,jpe<a name='2036'>
           do k = kps,kpe<a name='2037'>
             chem(ips:ipe,k,j,mp1) = grid%u_2(ips:ipe,k,j)<a name='2038'>
           end do<a name='2039'>
         end do<a name='2040'>
       case( 5 )<a name='2041'>
         do j = jps,jpe<a name='2042'>
           do k = kps,kpe<a name='2043'>
             chem(ips:ipe,k,j,mp1) = grid%v_2(ips:ipe,k,j)<a name='2044'>
           end do<a name='2045'>
         end do<a name='2046'>
       case( 6 )<a name='2047'>
         do j = jps,jpe<a name='2048'>
           do k = kps,kpe<a name='2049'>
             chem(ips:ipe,k,j,mp1) = grid%w_2(ips:ipe,k,j)<a name='2050'>
           end do<a name='2051'>
         end do<a name='2052'>
       case( 7 )<a name='2053'>
         do j = jps,jpe<a name='2054'>
           do k = kps,kpe<a name='2055'>
             chem(ips:ipe,k,j,mp1) = grid%ph_2(ips:ipe,k,j)<a name='2056'>
           end do<a name='2057'>
         end do<a name='2058'>
       case( 8 )<a name='2059'>
         do j = jps,jpe<a name='2060'>
           do k = kps,kpe<a name='2061'>
             chem(ips:ipe,k,j,mp1) = grid%phb(ips:ipe,k,j)<a name='2062'>
           end do<a name='2063'>
         end do<a name='2064'>
#if( WRF_CHEM == 1 )<a name='2065'>
       case( 9 )<a name='2066'>
         do j = jps,jpe<a name='2067'>
           do k = kps,kpe<a name='2068'>
             chem(ips:ipe,k,j,mp1) = grid%rainprod(ips:ipe,k,j)<a name='2069'>
           end do<a name='2070'>
         end do<a name='2071'>
       case( 10 )<a name='2072'>
         do j = jps,jpe<a name='2073'>
           do k = kps,kpe<a name='2074'>
             chem(ips:ipe,k,j,mp1) = grid%evapprod(ips:ipe,k,j)<a name='2075'>
           end do<a name='2076'>
         end do<a name='2077'>
#endif<a name='2078'>
     end select<a name='2079'>
   end do<a name='2080'>
<a name='2081'>
   end subroutine pack_dyn_vals<a name='2082'>
<a name='2083'>
<A NAME='SET_DYN_VALS'><A href='../../html_code/share/module_trajectory.F.html#SET_DYN_VALS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2084'>
   <font color=#993300>subroutine </font><font color=#cc0000>set_dyn_vals</font> <A href='../../call_to/SET_DYN_VALS.html' TARGET='index'>1</A>,<A href='../../call_from/SET_DYN_VALS.html' TARGET='index'>1</A><a name='2085'>
<a name='2086'>
   use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/module_trajectory.F.html#SET_DYN_VALS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_119">, only : g, t0, p1000mb, rcp<a name='2087'>
<a name='2088'>
   integer :: ilp1, iup1, jlp1, jup1, klp1, kup1<a name='2089'>
   real    :: ginv, pinv<a name='2090'>
<a name='2091'>
   select case( traject(trj,dm)%dyn_var(n) )<a name='2092'>
     case( 'p' )<a name='2093'>
       wrk4d(il,kl,jl,1) = chem(il,kl,jl,2) + chem(il,kl,jl,4)<a name='2094'>
       wrk4d(iu,kl,jl,1) = chem(iu,kl,jl,2) + chem(iu,kl,jl,4)<a name='2095'>
       wrk4d(il,ku,jl,1) = chem(il,ku,jl,2) + chem(il,ku,jl,4)<a name='2096'>
       wrk4d(iu,ku,jl,1) = chem(iu,ku,jl,2) + chem(iu,ku,jl,4)<a name='2097'>
       wrk4d(il,kl,ju,1) = chem(il,kl,ju,2) + chem(il,kl,ju,4)<a name='2098'>
       wrk4d(iu,kl,ju,1) = chem(iu,kl,ju,2) + chem(iu,kl,ju,4)<a name='2099'>
       wrk4d(il,ku,ju,1) = chem(il,ku,ju,2) + chem(il,ku,ju,4)<a name='2100'>
       wrk4d(iu,ku,ju,1) = chem(iu,ku,ju,2) + chem(iu,ku,ju,4)<a name='2101'>
     case( 'T' )<a name='2102'>
       wrk4d(il,kl,jl,1) = chem(il,kl,jl,2) + chem(il,kl,jl,4)<a name='2103'>
       wrk4d(iu,kl,jl,1) = chem(iu,kl,jl,2) + chem(iu,kl,jl,4)<a name='2104'>
       wrk4d(il,ku,jl,1) = chem(il,ku,jl,2) + chem(il,ku,jl,4)<a name='2105'>
       wrk4d(iu,ku,jl,1) = chem(iu,ku,jl,2) + chem(iu,ku,jl,4)<a name='2106'>
       wrk4d(il,kl,ju,1) = chem(il,kl,ju,2) + chem(il,kl,ju,4)<a name='2107'>
       wrk4d(iu,kl,ju,1) = chem(iu,kl,ju,2) + chem(iu,kl,ju,4)<a name='2108'>
       wrk4d(il,ku,ju,1) = chem(il,ku,ju,2) + chem(il,ku,ju,4)<a name='2109'>
       wrk4d(iu,ku,ju,1) = chem(iu,ku,ju,2) + chem(iu,ku,ju,4)<a name='2110'>
<a name='2111'>
       pinv = 1./p1000mb<a name='2112'>
       wrk4d(il,kl,jl,1) = (chem(il,kl,jl,3) + t0)*(wrk4d(il,kl,jl,1)*pinv)**rcp<a name='2113'>
       wrk4d(iu,kl,jl,1) = (chem(iu,kl,jl,3) + t0)*(wrk4d(iu,kl,jl,1)*pinv)**rcp<a name='2114'>
       wrk4d(il,ku,jl,1) = (chem(il,ku,jl,3) + t0)*(wrk4d(il,ku,jl,1)*pinv)**rcp<a name='2115'>
       wrk4d(iu,ku,jl,1) = (chem(iu,ku,jl,3) + t0)*(wrk4d(iu,ku,jl,1)*pinv)**rcp<a name='2116'>
       wrk4d(il,kl,ju,1) = (chem(il,kl,ju,3) + t0)*(wrk4d(il,kl,ju,1)*pinv)**rcp<a name='2117'>
       wrk4d(iu,kl,ju,1) = (chem(iu,kl,ju,3) + t0)*(wrk4d(iu,kl,ju,1)*pinv)**rcp<a name='2118'>
       wrk4d(il,ku,ju,1) = (chem(il,ku,ju,3) + t0)*(wrk4d(il,ku,ju,1)*pinv)**rcp<a name='2119'>
       wrk4d(iu,ku,ju,1) = (chem(iu,ku,ju,3) + t0)*(wrk4d(iu,ku,ju,1)*pinv)**rcp<a name='2120'>
     case( 'z' )<a name='2121'>
       klp1 = kl + 1 ; kup1 = ku + 1<a name='2122'>
       ginv = 1./g<a name='2123'>
       wrk4d(il,kl,jl,1) = .5*(chem(il,kl,jl,8) + chem(il,klp1,jl,8) &amp;<a name='2124'>
                               + chem(il,kl,jl,9) + chem(il,klp1,jl,9))*ginv<a name='2125'>
       wrk4d(iu,kl,jl,1) = .5*(chem(iu,kl,jl,8) + chem(iu,klp1,jl,8) &amp;<a name='2126'>
                               + chem(iu,kl,jl,9) + chem(iu,klp1,jl,9))*ginv<a name='2127'>
       wrk4d(il,ku,jl,1) = .5*(chem(il,ku,jl,8) + chem(il,kup1,jl,8) &amp;<a name='2128'>
                               + chem(il,ku,jl,9) + chem(il,kup1,jl,9))*ginv<a name='2129'>
       wrk4d(iu,ku,jl,1) = .5*(chem(iu,ku,jl,8) + chem(iu,kup1,jl,8) &amp;<a name='2130'>
                               + chem(iu,ku,jl,9) + chem(iu,kup1,jl,9))*ginv<a name='2131'>
       wrk4d(il,kl,ju,1) = .5*(chem(il,kl,ju,8) + chem(il,klp1,ju,8) &amp;<a name='2132'>
                               + chem(il,kl,ju,9) + chem(il,klp1,ju,9))*ginv<a name='2133'>
       wrk4d(iu,kl,ju,1) = .5*(chem(iu,kl,ju,8) + chem(iu,klp1,ju,8) &amp;<a name='2134'>
                               + chem(iu,kl,ju,9) + chem(iu,klp1,ju,9))*ginv<a name='2135'>
       wrk4d(il,ku,ju,1) = .5*(chem(il,ku,ju,8) + chem(il,kup1,ju,8) &amp;<a name='2136'>
                               + chem(il,ku,ju,9) + chem(il,kup1,ju,9))*ginv<a name='2137'>
       wrk4d(iu,ku,ju,1) = .5*(chem(iu,ku,ju,8) + chem(iu,kup1,ju,8) &amp;<a name='2138'>
                               + chem(iu,ku,ju,9) + chem(iu,kup1,ju,9))*ginv<a name='2139'>
     case( 'u' )<a name='2140'>
       ilp1 = il + 1 ; iup1 = iu + 1<a name='2141'>
       wrk4d(il,kl,jl,1) = .5*(chem(il,kl,jl,5) + chem(ilp1,kl,jl,5))<a name='2142'>
       wrk4d(iu,kl,jl,1) = .5*(chem(iu,kl,jl,5) + chem(iup1,kl,jl,5))<a name='2143'>
       wrk4d(il,ku,jl,1) = .5*(chem(il,ku,jl,5) + chem(ilp1,ku,jl,5))<a name='2144'>
       wrk4d(iu,ku,jl,1) = .5*(chem(iu,ku,jl,5) + chem(iup1,ku,jl,5))<a name='2145'>
       wrk4d(il,kl,ju,1) = .5*(chem(il,kl,ju,5) + chem(ilp1,kl,ju,5))<a name='2146'>
       wrk4d(iu,kl,ju,1) = .5*(chem(iu,kl,ju,5) + chem(iup1,kl,ju,5))<a name='2147'>
       wrk4d(il,ku,ju,1) = .5*(chem(il,ku,ju,5) + chem(ilp1,ku,ju,5))<a name='2148'>
       wrk4d(iu,ku,ju,1) = .5*(chem(iu,ku,ju,5) + chem(iup1,ku,ju,5))<a name='2149'>
     case( 'v' )<a name='2150'>
       jlp1 = jl + 1 ; jup1 = ju + 1<a name='2151'>
       wrk4d(il,kl,jl,1) = .5*(chem(il,kl,jl,6) + chem(il,kl,jlp1,6))<a name='2152'>
       wrk4d(iu,kl,jl,1) = .5*(chem(iu,kl,jl,6) + chem(iu,kl,jlp1,6))<a name='2153'>
       wrk4d(il,ku,jl,1) = .5*(chem(il,ku,jl,6) + chem(il,ku,jlp1,6))<a name='2154'>
       wrk4d(iu,ku,jl,1) = .5*(chem(iu,ku,jl,6) + chem(iu,ku,jlp1,6))<a name='2155'>
       wrk4d(il,kl,ju,1) = .5*(chem(il,kl,ju,6) + chem(il,kl,jup1,6))<a name='2156'>
       wrk4d(iu,kl,ju,1) = .5*(chem(iu,kl,ju,6) + chem(iu,kl,jup1,6))<a name='2157'>
       wrk4d(il,ku,ju,1) = .5*(chem(il,ku,ju,6) + chem(il,ku,jup1,6))<a name='2158'>
       wrk4d(iu,ku,ju,1) = .5*(chem(iu,ku,ju,6) + chem(iu,ku,jup1,6))<a name='2159'>
     case( 'w' )<a name='2160'>
       klp1 = kl + 1 ; kup1 = ku + 1<a name='2161'>
       wrk4d(il,kl,jl,1) = .5*(chem(il,kl,jl,7) + chem(il,klp1,jl,7))<a name='2162'>
       wrk4d(iu,kl,jl,1) = .5*(chem(iu,kl,jl,7) + chem(iu,klp1,jl,7))<a name='2163'>
       wrk4d(il,ku,jl,1) = .5*(chem(il,ku,jl,7) + chem(il,kup1,jl,7))<a name='2164'>
       wrk4d(iu,ku,jl,1) = .5*(chem(iu,ku,jl,7) + chem(iu,kup1,jl,7))<a name='2165'>
       wrk4d(il,kl,ju,1) = .5*(chem(il,kl,ju,7) + chem(il,klp1,ju,7))<a name='2166'>
       wrk4d(iu,kl,ju,1) = .5*(chem(iu,kl,ju,7) + chem(iu,klp1,ju,7))<a name='2167'>
       wrk4d(il,ku,ju,1) = .5*(chem(il,ku,ju,7) + chem(il,kup1,ju,7))<a name='2168'>
       wrk4d(iu,ku,ju,1) = .5*(chem(iu,ku,ju,7) + chem(iu,kup1,ju,7))<a name='2169'>
#if( WRF_CHEM == 1 )<a name='2170'>
     case( 'rainprod' )<a name='2171'>
       wrk4d(il,kl,jl,1) = chem(il,kl,jl,10)<a name='2172'>
       wrk4d(iu,kl,jl,1) = chem(iu,kl,jl,10)<a name='2173'>
       wrk4d(il,ku,jl,1) = chem(il,ku,jl,10)<a name='2174'>
       wrk4d(iu,ku,jl,1) = chem(iu,ku,jl,10)<a name='2175'>
       wrk4d(il,kl,ju,1) = chem(il,kl,ju,10)<a name='2176'>
       wrk4d(iu,kl,ju,1) = chem(iu,kl,ju,10)<a name='2177'>
       wrk4d(il,ku,ju,1) = chem(il,ku,ju,10)<a name='2178'>
       wrk4d(iu,ku,ju,1) = chem(iu,ku,ju,10)<a name='2179'>
     case( 'evapprod' )<a name='2180'>
       wrk4d(il,kl,jl,1) = chem(il,kl,jl,11)<a name='2181'>
       wrk4d(iu,kl,jl,1) = chem(iu,kl,jl,11)<a name='2182'>
       wrk4d(il,ku,jl,1) = chem(il,ku,jl,11)<a name='2183'>
       wrk4d(iu,ku,jl,1) = chem(iu,ku,jl,11)<a name='2184'>
       wrk4d(il,kl,ju,1) = chem(il,kl,ju,11)<a name='2185'>
       wrk4d(iu,kl,ju,1) = chem(iu,kl,ju,11)<a name='2186'>
       wrk4d(il,ku,ju,1) = chem(il,ku,ju,11)<a name='2187'>
       wrk4d(iu,ku,ju,1) = chem(iu,ku,ju,11)<a name='2188'>
#endif<a name='2189'>
   end select<a name='2190'>
<a name='2191'>
   end subroutine set_dyn_vals<a name='2192'>
<a name='2193'>
<A NAME='SET_MSC_VALS'><A href='../../html_code/share/module_trajectory.F.html#SET_MSC_VALS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2194'>
   <font color=#993300>subroutine </font><font color=#cc0000>set_msc_vals</font> <A href='../../call_to/SET_MSC_VALS.html' TARGET='index'>1</A><a name='2195'>
<a name='2196'>
   integer :: ilp1, iup1, jlp1, jup1, klp1, kup1<a name='2197'>
<a name='2198'>
   select case( trim(St_Vars(St_Vars_ndx)%Stagger) )<a name='2199'>
     case( 'X' )<a name='2200'>
       ilp1 = il + 1 ; iup1 = iu + 1<a name='2201'>
       wrk4d(il,kl,jl,1) = .5*(chem(il,kl,jl,ndx) + chem(ilp1,kl,jl,ndx))<a name='2202'>
       wrk4d(iu,kl,jl,1) = .5*(chem(iu,kl,jl,ndx) + chem(iup1,kl,jl,ndx))<a name='2203'>
       wrk4d(il,ku,jl,1) = .5*(chem(il,ku,jl,ndx) + chem(ilp1,ku,jl,ndx))<a name='2204'>
       wrk4d(iu,ku,jl,1) = .5*(chem(iu,ku,jl,ndx) + chem(iup1,ku,jl,ndx))<a name='2205'>
       wrk4d(il,kl,ju,1) = .5*(chem(il,kl,ju,ndx) + chem(ilp1,kl,ju,ndx))<a name='2206'>
       wrk4d(iu,kl,ju,1) = .5*(chem(iu,kl,ju,ndx) + chem(iup1,kl,ju,ndx))<a name='2207'>
       wrk4d(il,ku,ju,1) = .5*(chem(il,ku,ju,ndx) + chem(ilp1,ku,ju,ndx))<a name='2208'>
       wrk4d(iu,ku,ju,1) = .5*(chem(iu,ku,ju,ndx) + chem(iup1,ku,ju,ndx))<a name='2209'>
     case( 'Y' )<a name='2210'>
       jlp1 = jl + 1 ; jup1 = ju + 1<a name='2211'>
       wrk4d(il,kl,jl,1) = .5*(chem(il,kl,jl,ndx) + chem(il,kl,jlp1,ndx))<a name='2212'>
       wrk4d(iu,kl,jl,1) = .5*(chem(iu,kl,jl,ndx) + chem(iu,kl,jlp1,ndx))<a name='2213'>
       wrk4d(il,ku,jl,1) = .5*(chem(il,ku,jl,ndx) + chem(il,ku,jlp1,ndx))<a name='2214'>
       wrk4d(iu,ku,jl,1) = .5*(chem(iu,ku,jl,ndx) + chem(iu,ku,jlp1,ndx))<a name='2215'>
       wrk4d(il,kl,ju,1) = .5*(chem(il,kl,ju,ndx) + chem(il,kl,jup1,ndx))<a name='2216'>
       wrk4d(iu,kl,ju,1) = .5*(chem(iu,kl,ju,ndx) + chem(iu,kl,jup1,ndx))<a name='2217'>
       wrk4d(il,ku,ju,1) = .5*(chem(il,ku,ju,ndx) + chem(il,ku,jup1,ndx))<a name='2218'>
       wrk4d(iu,ku,ju,1) = .5*(chem(iu,ku,ju,ndx) + chem(iu,ku,jup1,ndx))<a name='2219'>
     case( 'Z' )<a name='2220'>
       klp1 = kl + 1 ; kup1 = ku + 1<a name='2221'>
       wrk4d(il,kl,jl,1) = .5*(chem(il,kl,jl,ndx) + chem(il,klp1,jl,ndx))<a name='2222'>
       wrk4d(iu,kl,jl,1) = .5*(chem(iu,kl,jl,ndx) + chem(iu,klp1,jl,ndx))<a name='2223'>
       wrk4d(il,ku,jl,1) = .5*(chem(il,ku,jl,ndx) + chem(il,kup1,jl,ndx))<a name='2224'>
       wrk4d(iu,ku,jl,1) = .5*(chem(iu,ku,jl,ndx) + chem(iu,kup1,jl,ndx))<a name='2225'>
       wrk4d(il,kl,ju,1) = .5*(chem(il,kl,ju,ndx) + chem(il,klp1,ju,ndx))<a name='2226'>
       wrk4d(iu,kl,ju,1) = .5*(chem(iu,kl,ju,ndx) + chem(iu,klp1,ju,ndx))<a name='2227'>
       wrk4d(il,ku,ju,1) = .5*(chem(il,ku,ju,ndx) + chem(il,kup1,ju,ndx))<a name='2228'>
       wrk4d(iu,ku,ju,1) = .5*(chem(iu,ku,ju,ndx) + chem(iu,kup1,ju,ndx))<a name='2229'>
     case default<a name='2230'>
       wrk4d(il,kl,jl,1) = chem(il,kl,jl,ndx)<a name='2231'>
       wrk4d(iu,kl,jl,1) = chem(iu,kl,jl,ndx)<a name='2232'>
       wrk4d(il,ku,jl,1) = chem(il,ku,jl,ndx)<a name='2233'>
       wrk4d(iu,ku,jl,1) = chem(iu,ku,jl,ndx)<a name='2234'>
       wrk4d(il,kl,ju,1) = chem(il,kl,ju,ndx)<a name='2235'>
       wrk4d(iu,kl,ju,1) = chem(iu,kl,ju,ndx)<a name='2236'>
       wrk4d(il,ku,ju,1) = chem(il,ku,ju,ndx)<a name='2237'>
       wrk4d(iu,ku,ju,1) = chem(iu,ku,ju,ndx)<a name='2238'>
   end select<a name='2239'>
<a name='2240'>
   end subroutine set_msc_vals<a name='2241'>
<a name='2242'>
   end subroutine trajectory_driver<a name='2243'>
<a name='2244'>
<A NAME='TRAJECTORY_DCHM_TSTEP_INIT'><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2245'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajectory_dchm_tstep_init</font>( grid, is_chemstep ),<A href='../../call_from/TRAJECTORY_DCHM_TSTEP_INIT.html' TARGET='index'>4</A><a name='2246'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2247'></font>
<font color=#447700>!  initialize dchm buffer<a name='2248'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2249'></font>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_438">, only : domain, get_ijk_from_grid<a name='2250'>
   use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_200">, only : num_chem<a name='2251'>
<a name='2252'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2253'></font>
<font color=#447700>!  dummy arguments<a name='2254'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2255'></font>
   logical, intent(in)      :: is_chemstep<a name='2256'>
   type(domain), intent(in) :: grid<a name='2257'>
<a name='2258'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2259'></font>
<font color=#447700>!  local variables<a name='2260'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2261'></font>
   integer :: astat<a name='2262'>
   integer :: j, k, m<a name='2263'>
   integer :: chm_ndx<a name='2264'>
   integer :: dm<a name='2265'>
   integer :: ims,ime, jms,jme, kms,kme<a name='2266'>
   integer :: ids,ide, jds,jde, kds,kde<a name='2267'>
   integer :: ips,ipe, jps,jpe, kps,kpe<a name='2268'>
   integer, pointer :: n_dchm       <font color=#447700>! number dchm buffer species<a name='2269'></font>
   integer, pointer :: dchm_buf_ndx(:)<a name='2270'>
   character(len=256) :: err_mes<a name='2271'>
<a name='2272'>
   do_chemstep = is_chemstep<a name='2273'>
<a name='2274'>
   if( is_chemstep ) then<a name='2275'>
     dm = grid%id<a name='2276'>
     n_dchm =&gt; n_dchm_dm(dm)<a name='2277'>
     if( n_dchm &gt; 0 ) then<a name='2278'>
       call <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_116">( grid ,                   &amp;<a name='2279'>
                               ids, ide, jds, jde, kds, kde,    &amp;<a name='2280'>
                               ims, ime, jms, jme, kms, kme,    &amp;<a name='2281'>
                               ips, ipe, jps, jpe, kps, kpe    )<a name='2282'>
       if( allocated( dchm_buff ) ) then<a name='2283'>
         deallocate( dchm_buff )<a name='2284'>
       endif<a name='2285'>
       allocate( dchm_buff(ims:ime,kms:kme,jms:jme,n_dchm+offset),stat=astat )<a name='2286'>
       if( astat /= 0 ) then<a name='2287'>
         write(err_mes,'(''trajectory_dchm_tstep_init('',i2.2,''): failed to allocate wrk4d: error = '',i6)') dm,astat<a name='2288'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1473">( trim( err_mes  ) )<a name='2289'>
       endif<a name='2290'>
       dchm_buf_ndx =&gt; dchm_buf_ndx_dm(:,dm)<a name='2291'>
       do m = 1,n_dchm<a name='2292'>
         chm_ndx = dchm_buf_ndx(m)<a name='2293'>
         do j = jps,jpe<a name='2294'>
           do k = kps,kpe<a name='2295'>
             dchm_buff(ips:ipe,k,j,m+offset) = grid%chem(ips:ipe,k,j,chm_ndx)<a name='2296'>
           end do<a name='2297'>
         end do<a name='2298'>
       end do<a name='2299'>
     endif<a name='2300'>
   endif<a name='2301'>
<a name='2302'>
   end subroutine trajectory_dchm_tstep_init<a name='2303'>
<a name='2304'>
<A NAME='TRAJECTORY_DCHM_TSTEP_SET'><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_SET' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2305'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajectory_dchm_tstep_set</font>( grid ),<A href='../../call_from/TRAJECTORY_DCHM_TSTEP_SET.html' TARGET='index'>3</A><a name='2306'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2307'></font>
<font color=#447700>!  set dchm buffer<a name='2308'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2309'></font>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_SET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_439">, only : domain, get_ijk_from_grid<a name='2310'>
   use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_SET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_201">, only : num_chem<a name='2311'>
<a name='2312'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2313'></font>
<font color=#447700>!  dummy arguments<a name='2314'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2315'></font>
   type(domain), intent(in) :: grid<a name='2316'>
<a name='2317'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2318'></font>
<font color=#447700>!  local variables<a name='2319'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2320'></font>
   integer :: j, k, m, mp1<a name='2321'>
   integer :: chm_ndx<a name='2322'>
   integer :: dm<a name='2323'>
   integer :: ims,ime, jms,jme, kms,kme<a name='2324'>
   integer :: ids,ide, jds,jde, kds,kde<a name='2325'>
   integer :: ips,ipe, jps,jpe, kps,kpe<a name='2326'>
   integer, pointer :: n_dchm       <font color=#447700>! number dchm buffer species<a name='2327'></font>
   integer, pointer :: dchm_buf_ndx(:)<a name='2328'>
<a name='2329'>
   dm = grid%id<a name='2330'>
   n_dchm =&gt; n_dchm_dm(dm)<a name='2331'>
   if( n_dchm &gt; 0 ) then<a name='2332'>
     call <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_DCHM_TSTEP_SET' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_117">( grid ,                   &amp;<a name='2333'>
                             ids, ide, jds, jde, kds, kde,    &amp;<a name='2334'>
                             ims, ime, jms, jme, kms, kme,    &amp;<a name='2335'>
                             ips, ipe, jps, jpe, kps, kpe    )<a name='2336'>
     dchm_buf_ndx =&gt; dchm_buf_ndx_dm(:,dm)<a name='2337'>
     do m = 1,n_dchm<a name='2338'>
       mp1 = m + offset<a name='2339'>
       chm_ndx = dchm_buf_ndx(m)<a name='2340'>
       do j = jps,jpe<a name='2341'>
         do k = kps,kpe<a name='2342'>
           dchm_buff(ips:ipe,k,j,mp1) = grid%chem(ips:ipe,k,j,chm_ndx) - dchm_buff(ips:ipe,k,j,mp1)<a name='2343'>
         end do<a name='2344'>
       end do<a name='2345'>
     end do<a name='2346'>
   endif<a name='2347'>
<a name='2348'>
   end subroutine trajectory_dchm_tstep_set<a name='2349'>
<a name='2350'>
<A NAME='TRAJECTORY_CREATE_FILE'><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2351'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajectory_create_file</font>( grid, n_traj ) <A href='../../call_to/TRAJECTORY_CREATE_FILE.html' TARGET='index'>1</A>,<A href='../../call_from/TRAJECTORY_CREATE_FILE.html' TARGET='index'>18</A><a name='2352'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2353'></font>
<font color=#447700>!  create trajectory netcdf file<a name='2354'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2355'></font>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_440"><a name='2356'>
   use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_202">, only : param_first_scalar, num_chem, num_moist, num_tracer<a name='2357'>
   use <A href='../../html_code/frame/module_configure.F.html#MODULE_SCALAR_TABLES'>module_scalar_tables</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SCALAR_TABLES_4">,     only : chem_dname_table, moist_dname_table, tracer_dname_table<a name='2358'>
<a name='2359'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2360'></font>
<font color=#447700>!  dummy arguments<a name='2361'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2362'></font>
   integer, intent(in)       :: n_traj<a name='2363'>
   type(domain), intent(in)  :: grid<a name='2364'>
<a name='2365'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2366'></font>
<font color=#447700>!  local variables<a name='2367'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2368'></font>
   integer :: dm<a name='2369'>
   integer :: ncid, ios<a name='2370'>
   integer :: traj_dim, time_dim, Times_dim<a name='2371'>
   integer :: varid<a name='2372'>
   integer, pointer :: num_msc<a name='2373'>
   integer :: var_dims(2)<a name='2374'>
   integer :: m, n, trj, pkg<a name='2375'>
   character(len=10)  :: coord_name(5) = (/ 'traj_i    ', 'traj_j    ', 'traj_k    ', &amp;<a name='2376'>
                                            'traj_long ', 'traj_lat  ' /)<a name='2377'>
   character(len=256) :: filename<a name='2378'>
   character(len=256) :: var_name<a name='2379'>
   character(len=256) :: err_mes<a name='2380'>
   character(len=256) :: description<a name='2381'>
   character(len=256) :: units<a name='2382'>
<a name='2383'>
   logical, external :: wrf_dm_on_monitor<a name='2384'>
<a name='2385'>
include 'netcdf.inc'<a name='2386'>
<a name='2387'>
master_proc: &amp;<a name='2388'>
   if( wrf_dm_on_monitor() ) then<a name='2389'>
     dm = grid%id<a name='2390'>
     write(filename,'(''wrfout_traj_d'',i2.2)',iostat=ios) dm<a name='2391'>
     if( ios /= 0 ) then<a name='2392'>
       write(err_mes,'(''trajectory_create_file: failed to set filename: error = '',i6)') ios<a name='2393'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1474">( trim( err_mes  ) )<a name='2394'>
     endif<a name='2395'>
<font color=#447700>!    ios = nf_create( trim(filename), or(nf_clobber,nf_netcdf4), ncid )<a name='2396'></font>
     ios = nf_create( trim(filename), nf_clobber, ncid )<a name='2397'>
     if( ios /= nf_noerr ) then<a name='2398'>
       write(err_mes,'(''trajectory_create_file: failed to create '',a,'': error = '',i6)') trim(filename),ios<a name='2399'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1475">( trim( err_mes  ) )<a name='2400'>
     endif<a name='2401'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2402'></font>
<font color=#447700>!  define dimensions<a name='2403'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2404'></font>
     err_mes = 'trajectory_create_file: failed to create traj dimension'<a name='2405'>
     call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_9">( nf_def_dim( ncid, 'traj', n_traj, traj_dim ), trim(err_mes) )<a name='2406'>
     err_mes = 'trajectory_create_file: failed to create time dimension'<a name='2407'>
     call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_10">( nf_def_dim( ncid, 'time', nf_unlimited, time_dim ), trim(err_mes) )<a name='2408'>
     err_mes = 'trajectory_create_file: failed to create Times dimension'<a name='2409'>
     call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_11">( nf_def_dim( ncid, 'DateStrLen', 19, Times_dim ), trim(err_mes) )<a name='2410'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2411'></font>
<font color=#447700>!  define variables<a name='2412'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2413'></font>
     var_dims(:) = (/ Times_dim,time_dim /)<a name='2414'>
     err_mes = 'trajectory_create_file: failed to create Times variable'<a name='2415'>
     call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_12">( nf_def_var( ncid, 'Times', nf_char, 2, var_dims, varid ), trim(err_mes) )<a name='2416'>
<a name='2417'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2418'></font>
<font color=#447700>!  first the coordinate variables<a name='2419'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2420'></font>
     var_dims(:) = (/ traj_dim,time_dim /)<a name='2421'>
     do m = 1,5<a name='2422'>
       var_name = coord_name(m)<a name='2423'>
       err_mes = 'trajectory_create_file: failed to create ' // trim(var_name) // ' variable'<a name='2424'>
       call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_13">( nf_def_var( ncid, trim(var_name), nf_real, 2, var_dims, varid ), trim(err_mes) )<a name='2425'>
     end do<a name='2426'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2427'></font>
<font color=#447700>!  then the species variables<a name='2428'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2429'></font>
     num_msc =&gt; num_msc_dm(dm)<a name='2430'>
pgk_loop: &amp;<a name='2431'>
     do pkg = 1,pkg_max<a name='2432'>
       select case( pkg_tag(pkg) )<a name='2433'>
         case( 'chm' )<a name='2434'>
           trj_msk =&gt; trj_msk_dm(:,:,chm_pkg,dm)<a name='2435'>
           if( any( trj_msk(:n_traj,1) ) ) then<a name='2436'>
             call <A href='../../html_code/share/module_trajectory.F.html#DEF_VARS'>def_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEF_VARS_1">( 'chm' )<a name='2437'>
           endif<a name='2438'>
         case( 'hyd' )<a name='2439'>
           trj_msk =&gt; trj_msk_dm(:,:,hyd_pkg,dm)<a name='2440'>
           if( any( trj_msk(:n_traj,1) ) ) then<a name='2441'>
             call <A href='../../html_code/share/module_trajectory.F.html#DEF_VARS'>def_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEF_VARS_2">( 'hyd' )<a name='2442'>
           endif<a name='2443'>
         case( 'trc' )<a name='2444'>
           trj_msk =&gt; trj_msk_dm(:,:,trc_pkg,dm)<a name='2445'>
           if( any( trj_msk(:n_traj,1) ) ) then<a name='2446'>
             call <A href='../../html_code/share/module_trajectory.F.html#DEF_VARS'>def_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEF_VARS_3">( 'trc' )<a name='2447'>
           endif<a name='2448'>
         case( 'dyn' )<a name='2449'>
           trj_msk =&gt; trj_msk_dm(:,:,dyn_pkg,dm)<a name='2450'>
           if( any( trj_msk(:n_traj,1) ) ) then<a name='2451'>
             call <A href='../../html_code/share/module_trajectory.F.html#DEF_VARS'>def_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEF_VARS_4">( 'dyn' )<a name='2452'>
           endif<a name='2453'>
         case( 'msc' )<a name='2454'>
           trj_msk =&gt; trj_msk_dm(:,:,msc_pkg,dm)<a name='2455'>
           if( any( trj_msk(:n_traj,1) ) ) then<a name='2456'>
             call <A href='../../html_code/share/module_trajectory.F.html#DEF_VARS'>def_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEF_VARS_5">( 'msc' )<a name='2457'>
           endif<a name='2458'>
         case( 'dchm' )<a name='2459'>
           trj_msk =&gt; trj_msk_dm(:,:,dchm_pkg,dm)<a name='2460'>
           if( any( trj_msk(:n_traj,1) ) ) then<a name='2461'>
             call <A href='../../html_code/share/module_trajectory.F.html#DEF_VARS'>def_vars</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEF_VARS_6">( 'dchm' )<a name='2462'>
           endif<a name='2463'>
       end select<a name='2464'>
     end do pgk_loop<a name='2465'>
<a name='2466'>
     err_mes = 'trajectory_create_file: failed to end definition for file ' // trim(filename)<a name='2467'>
     call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_14">( nf_enddef( ncid ), trim(err_mes) )<a name='2468'>
     err_mes = 'trajectory_create_file: failed to close file ' // trim(filename)<a name='2469'>
     call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_CREATE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_15">( nf_close( ncid ), trim(err_mes) )<a name='2470'>
   endif master_proc<a name='2471'>
<a name='2472'>
   CONTAINS<a name='2473'>
<a name='2474'>
<A NAME='DEF_VARS'><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2475'>
   <font color=#993300>subroutine </font><font color=#cc0000>def_vars</font>( var_type ) <A href='../../call_to/DEF_VARS.html' TARGET='index'>6</A>,<A href='../../call_from/DEF_VARS.html' TARGET='index'>18</A><a name='2476'>
<a name='2477'>
   character(len=*), intent(in)  :: var_type<a name='2478'>
<a name='2479'>
   integer :: m, ndx, trj<a name='2480'>
   integer, pointer  :: n_dchm<a name='2481'>
   character(len=32) :: spc_name<a name='2482'>
<a name='2483'>
   select case( var_type )<a name='2484'>
     case( 'chm' )<a name='2485'>
       trj_msk =&gt; trj_msk_dm(:,:,chm_pkg,dm)<a name='2486'>
       do n = param_first_scalar,num_chem<a name='2487'>
         if( any( trj_msk(:n_traj,n) ) ) then<a name='2488'>
           spc_name = chem_dname_table(dm,n)<a name='2489'>
           write(var_name,'(a,''_traj'')') trim(spc_name)<a name='2490'>
           err_mes = 'def_vars: failed to create ' // trim(var_name) // ' variable'<a name='2491'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_16">( nf_def_var( ncid, trim(var_name), nf_real, 2, var_dims, varid ), trim(err_mes) )<a name='2492'>
           description = trim(var_name) // ' mixing ratio'<a name='2493'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_17">( nf_put_att_text( ncid, varid, 'description', len_trim(description), description ), trim(err_mes) )<a name='2494'>
           units = 'ppmv'<a name='2495'>
trj_loop:  do trj = 1,n_traj<a name='2496'>
             if( trj_msk(trj,n) ) then<a name='2497'>
               do m = 1,trjects(trj)%n_chm_var<a name='2498'>
                 if( trim(trjects(trj)%chm_spc(m)) == trim(spc_name) ) then<a name='2499'>
                   if( .not. trjects(trj)%chm_is_gas(m) ) then<a name='2500'>
                     units = 'ug/kg-dryair'<a name='2501'>
                   endif<a name='2502'>
                   exit trj_loop<a name='2503'>
                 endif<a name='2504'>
               end do<a name='2505'>
               exit trj_loop<a name='2506'>
             endif<a name='2507'>
           end do trj_loop<a name='2508'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_18">( nf_put_att_text( ncid, varid, 'units', len_trim(units), units ), trim(err_mes) )<a name='2509'>
         endif<a name='2510'>
       end do<a name='2511'>
     case( 'hyd' )<a name='2512'>
       trj_msk =&gt; trj_msk_dm(:,:,hyd_pkg,dm)<a name='2513'>
       do n = param_first_scalar,num_moist<a name='2514'>
         if( any( trj_msk(:n_traj,n) ) ) then<a name='2515'>
           write(var_name,'(a,''_traj'')') trim(moist_dname_table(dm,n))<a name='2516'>
           err_mes = 'def_vars: failed to create ' // trim(var_name) // ' variable'<a name='2517'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_19">( nf_def_var( ncid, trim(var_name), nf_real, 2, var_dims, varid ), trim(err_mes) )<a name='2518'>
           description = trim(var_name) // ' mixing ratio'<a name='2519'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_20">( nf_put_att_text( ncid, varid, 'description', len_trim(description), description ), trim(err_mes) )<a name='2520'>
           units = 'ug/kg-dryair'<a name='2521'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_21">( nf_put_att_text( ncid, varid, 'units', len_trim(units), units ), trim(err_mes) )<a name='2522'>
         endif<a name='2523'>
       end do<a name='2524'>
     case( 'trc' )<a name='2525'>
       trj_msk =&gt; trj_msk_dm(:,:,trc_pkg,dm)<a name='2526'>
       do n = param_first_scalar,num_tracer<a name='2527'>
         if( any( trj_msk(:n_traj,n) ) ) then<a name='2528'>
           write(var_name,'(a,''_traj'')') trim(tracer_dname_table(dm,n))<a name='2529'>
           err_mes = 'def_vars: failed to create ' // trim(var_name) // ' variable'<a name='2530'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_22">( nf_def_var( ncid, trim(var_name), nf_real, 2, var_dims, varid ), trim(err_mes) )<a name='2531'>
           description = trim(var_name) // ' mixing ratio'<a name='2532'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_23">( nf_put_att_text( ncid, varid, 'description', len_trim(description), description ), trim(err_mes) )<a name='2533'>
           units = ' '<a name='2534'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_24">( nf_put_att_text( ncid, varid, 'units', len_trim(units), units ), trim(err_mes) )<a name='2535'>
         endif<a name='2536'>
       end do<a name='2537'>
     case( 'dyn' )<a name='2538'>
       trj_msk =&gt; trj_msk_dm(:,:,dyn_pkg,dm)<a name='2539'>
       do n = param_first_scalar,dyn_max + offset<a name='2540'>
         if( any( trj_msk(:n_traj,n) ) ) then<a name='2541'>
           write(var_name,'(a,''_traj'')') trim(dyn_var_lst(n-1))<a name='2542'>
           err_mes = 'def_vars: failed to create ' // trim(var_name) // ' variable'<a name='2543'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_25">( nf_def_var( ncid, trim(var_name), nf_real, 2, var_dims, varid ), trim(err_mes) )<a name='2544'>
           description = trim(dyn_var_desc_att(n-1))<a name='2545'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_26">( nf_put_att_text( ncid, varid, 'description', len_trim(description), description ), trim(err_mes) )<a name='2546'>
           units = trim(dyn_var_unit_att(n-1))<a name='2547'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_27">( nf_put_att_text( ncid, varid, 'units', len_trim(units), units ), trim(err_mes) )<a name='2548'>
         endif<a name='2549'>
       end do<a name='2550'>
     case( 'msc' )<a name='2551'>
       trj_msk =&gt; trj_msk_dm(:,:,msc_pkg,dm)<a name='2552'>
       do n = param_first_scalar,num_msc + offset<a name='2553'>
         if( any( trj_msk(:n_traj,n) ) ) then<a name='2554'>
           write(var_name,'(a,''_traj'')') trim(St_Vars(n-1)%Varname)<a name='2555'>
           err_mes = 'def_vars: failed to create ' // trim(var_name) // ' variable'<a name='2556'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_28">( nf_def_var( ncid, trim(var_name), nf_real, 2, var_dims, varid ), trim(err_mes) )<a name='2557'>
           description = trim(St_Vars(n-1)%Description)<a name='2558'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_29">( nf_put_att_text( ncid, varid, 'description', len_trim(description), description ), trim(err_mes) )<a name='2559'>
           units = trim(St_Vars(n-1)%Units)<a name='2560'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_30">( nf_put_att_text( ncid, varid, 'units', len_trim(units), units ), trim(err_mes) )<a name='2561'>
         endif<a name='2562'>
       end do<a name='2563'>
     case( 'dchm' )<a name='2564'>
       trj_msk =&gt; trj_msk_dm(:,:,dchm_pkg,dm)<a name='2565'>
       n_dchm  =&gt; n_dchm_dm(dm)<a name='2566'>
       dchm_buf_ndx =&gt; dchm_buf_ndx_dm(:,dm)<a name='2567'>
       do n = 1,n_dchm<a name='2568'>
         if( any( trj_msk(:n_traj,n+offset) ) ) then<a name='2569'>
           ndx = dchm_buf_ndx(n)<a name='2570'>
           spc_name = 'dchm_' // trim(chem_dname_table(dm,ndx))<a name='2571'>
           write(var_name,'(a,''_traj'')') trim(spc_name)<a name='2572'>
           err_mes = 'def_vars: failed to create ' // trim(var_name) // ' variable'<a name='2573'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_31">( nf_def_var( ncid, trim(var_name), nf_real, 2, var_dims, varid ), trim(err_mes) )<a name='2574'>
           description = trim(var_name) // ' mixing ratio'<a name='2575'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_32">( nf_put_att_text( ncid, varid, 'description', len_trim(description), description ), trim(err_mes) )<a name='2576'>
           units = 'ppmv'<a name='2577'>
           call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#DEF_VARS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_33">( nf_put_att_text( ncid, varid, 'units', len_trim(units), units ), trim(err_mes) )<a name='2578'>
         endif<a name='2579'>
       end do<a name='2580'>
   end select<a name='2581'>
<a name='2582'>
   end subroutine def_vars<a name='2583'>
<a name='2584'>
   end subroutine trajectory_create_file<a name='2585'>
<a name='2586'>
<A NAME='TRAJECTORY_WRITE_FILE'><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2587'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajectory_write_file</font>( n_traj, n_vals, dm ) <A href='../../call_to/TRAJECTORY_WRITE_FILE.html' TARGET='index'>1</A>,<A href='../../call_from/TRAJECTORY_WRITE_FILE.html' TARGET='index'>29</A><a name='2588'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2589'></font>
<font color=#447700>!  create trajectory netcdf file<a name='2590'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2591'></font>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_441"><a name='2592'>
   use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_203">, only : param_first_scalar, num_chem, num_moist, num_tracer<a name='2593'>
   use <A href='../../html_code/frame/module_configure.F.html#MODULE_SCALAR_TABLES'>module_scalar_tables</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SCALAR_TABLES_5">,     only : chem_dname_table, moist_dname_table, tracer_dname_table<a name='2594'>
<a name='2595'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2596'></font>
<font color=#447700>!  dummy arguments<a name='2597'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2598'></font>
   integer, intent(in)        :: n_traj<a name='2599'>
   integer, intent(inout)     :: n_vals<a name='2600'>
   integer, intent(in)        :: dm<a name='2601'>
<a name='2602'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2603'></font>
<font color=#447700>!  local variables<a name='2604'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2605'></font>
   integer :: ncid<a name='2606'>
   integer :: astat, ios<a name='2607'>
   integer :: time_id<a name='2608'>
   integer :: varid<a name='2609'>
   integer :: l, m, n, trj, pkg, spc, spcp1<a name='2610'>
   integer :: time_ndx<a name='2611'>
   integer :: buf_ndx<a name='2612'>
   integer :: ndx<a name='2613'>
   integer, pointer :: num_msc      <font color=#447700>! number misc species<a name='2614'></font>
   integer, pointer :: n_dchm       <font color=#447700>! total number of dchm species in domain<a name='2615'></font>
   real, allocatable :: holder(:,:)<a name='2616'>
   character(len=10)  :: coord_name(5) = (/ 'traj_i    ', 'traj_j    ', 'traj_k    ', &amp;<a name='2617'>
                                            'traj_long ', 'traj_lat  ' /)<a name='2618'>
   character(len=256) :: var_name<a name='2619'>
   character(len=256) :: err_mes<a name='2620'>
   character(len=256) :: filename<a name='2621'>
   character(len=256) :: spcname<a name='2622'>
<a name='2623'>
   logical :: found<a name='2624'>
<a name='2625'>
include 'netcdf.inc'<a name='2626'>
<a name='2627'>
<font color=#447700>!---------------------------------------------------------------------<a name='2628'></font>
<font color=#447700>!  open netcdf file<a name='2629'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2630'></font>
   write(filename,'(''wrfout_traj_d'',i2.2)',iostat=ios) dm<a name='2631'>
   if( ios /= 0 ) then<a name='2632'>
     write(err_mes,'(''trajectory_write_file: failed to set filename: error = '',i6)') ios<a name='2633'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1476">( trim( err_mes  ) )<a name='2634'>
   endif<a name='2635'>
   ios = nf_open( trim(filename), nf_write, ncid )<a name='2636'>
   if( ios /= 0 ) then<a name='2637'>
     write(err_mes,'(''trajectory_write_file: failed to open '',a,'': error = '',i6)') trim(filename),ios<a name='2638'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1477">( trim( err_mes  ) )<a name='2639'>
   endif<a name='2640'>
<a name='2641'>
<font color=#447700>!---------------------------------------------------------------------<a name='2642'></font>
<font color=#447700>!  allocate wrking array<a name='2643'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2644'></font>
   allocate( holder(n_traj,n_vals),stat=astat )<a name='2645'>
   if( astat /= 0 ) then<a name='2646'>
     write(err_mes,'(''trajectory_write_file: failed to allocate holder; error = '',i6)') astat<a name='2647'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1478">( trim( err_mes  ) )<a name='2648'>
   endif<a name='2649'>
<a name='2650'>
<font color=#447700>!---------------------------------------------------------------------<a name='2651'></font>
<font color=#447700>!  get current time index<a name='2652'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2653'></font>
   err_mes = 'trajectory_write_file: failed to get time id'<a name='2654'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_34">( nf_inq_dimid( ncid, 'time', time_id ),trim(err_mes) )<a name='2655'>
   err_mes = 'trajectory_write_file: failed to get time dimension'<a name='2656'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_35">( nf_inq_dimlen( ncid, time_id, time_ndx ),trim(err_mes) )<a name='2657'>
   time_ndx = time_ndx + 1<a name='2658'>
<a name='2659'>
<font color=#447700>!---------------------------------------------------------------------<a name='2660'></font>
<font color=#447700>!  write out trajectory times<a name='2661'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2662'></font>
   err_mes = 'trajectory_write_file: failed to get Times id'<a name='2663'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_36">( nf_inq_varid( ncid, 'Times', varid ),trim(err_mes) )<a name='2664'>
   err_mes = 'trajectory_write_file: failed to write Times'<a name='2665'>
   call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_37">( nf_put_vara_text( ncid, varid, (/ 1,time_ndx /), (/ 19,n_vals /), trj_pbf(1)%times(:n_vals) ), trim(err_mes) )<a name='2666'>
<a name='2667'>
<font color=#447700>!---------------------------------------------------------------------<a name='2668'></font>
<font color=#447700>!  write out trajectory coordinates<a name='2669'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2670'></font>
coord_loop: &amp;<a name='2671'>
   do l = 1,5<a name='2672'>
     var_name = coord_name(l)<a name='2673'>
     err_mes = 'trajectory_write_file: failed to get '// trim(var_name) // ' id'<a name='2674'>
     call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_38">( nf_inq_varid( ncid, trim(var_name), varid ),trim(err_mes) )<a name='2675'>
     select case( l )<a name='2676'>
       case( 1 )<a name='2677'>
         do n = 1,n_traj<a name='2678'>
           holder(n,:n_vals) = trj_pbf(n)%trj_i(:n_vals)<a name='2679'>
         end do<a name='2680'>
       case( 2 )<a name='2681'>
         do n = 1,n_traj<a name='2682'>
           holder(n,:n_vals) = trj_pbf(n)%trj_j(:n_vals)<a name='2683'>
         end do<a name='2684'>
       case( 3 )<a name='2685'>
         do n = 1,n_traj<a name='2686'>
           holder(n,:n_vals) = trj_pbf(n)%trj_k(:n_vals)<a name='2687'>
         end do<a name='2688'>
       case( 4 )<a name='2689'>
         do n = 1,n_traj<a name='2690'>
           holder(n,:n_vals) = trj_pbf(n)%trj_lons(:n_vals)<a name='2691'>
         end do<a name='2692'>
       case( 5 )<a name='2693'>
         do n = 1,n_traj<a name='2694'>
           holder(n,:n_vals) = trj_pbf(n)%trj_lats(:n_vals)<a name='2695'>
         end do<a name='2696'>
       end select<a name='2697'>
       err_mes = 'trajectory_write_file: failed to write ' // trim(var_name)<a name='2698'>
       call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_39">( nf_put_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,n_vals /), &amp;<a name='2699'>
                                            holder ), trim(err_mes) )<a name='2700'>
   end do coord_loop<a name='2701'>
<a name='2702'>
   St_Vars =&gt; St_Vars_dm(:,dm)<a name='2703'>
   St_Vars_msk =&gt; St_Vars_msk_dm(:,dm)<a name='2704'>
   num_msc =&gt; num_msc_dm(dm)<a name='2705'>
<font color=#447700>!---------------------------------------------------------------------<a name='2706'></font>
<font color=#447700>!  write out trajectory variables<a name='2707'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2708'></font>
pkg_loop: &amp;<a name='2709'>
   do pkg = 1,pkg_max<a name='2710'>
     select case( pkg_tag(pkg) )<a name='2711'>
       case( 'chm' )<a name='2712'>
         trj_msk =&gt; trj_msk_dm(:,:,chm_pkg,dm)<a name='2713'>
         do spc = param_first_scalar,num_chem<a name='2714'>
           if( any( trj_msk(:n_traj,spc) ) ) then<a name='2715'>
             holder(:,:) = missing_val<a name='2716'>
             do trj = 1,n_traj<a name='2717'>
               if( trj_msk(trj,spc) ) then<a name='2718'>
                 buf_ndx = <A href='../../html_code/share/module_trajectory.F.html#GET_SPC_BUF_NDX'>get_spc_buf_ndx</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_SPC_BUF_NDX_1">( trjects(trj)%n_chm_var, trjects(trj)%chm_spc, chem_dname_table(dm,spc) )<a name='2719'>
                 if( buf_ndx &gt; 0 ) then<a name='2720'>
                   holder(trj,:n_vals) = trj_pbf(trj)%chm_vals(:n_vals,buf_ndx)<a name='2721'>
                 endif<a name='2722'>
               endif<a name='2723'>
             end do<a name='2724'>
             write(var_name,'(a,''_traj'')') trim(chem_dname_table(dm,spc))<a name='2725'>
             err_mes = 'trajectory_write_file: failed to get '// trim(var_name) // ' id'<a name='2726'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_40">( nf_inq_varid( ncid, trim(var_name), varid ),trim(err_mes) )<a name='2727'>
             err_mes = 'trajectory_write_file: failed to write ' // trim(var_name)<a name='2728'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_41">( nf_put_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,n_vals /), &amp;<a name='2729'>
                                                  holder ),trim(err_mes) )<a name='2730'>
           endif<a name='2731'>
         end do<a name='2732'>
       case( 'hyd' )<a name='2733'>
         trj_msk =&gt; trj_msk_dm(:,:,hyd_pkg,dm)<a name='2734'>
         do spc = param_first_scalar,num_moist<a name='2735'>
           if( any( trj_msk(:n_traj,spc) ) ) then<a name='2736'>
             holder(:,:) = missing_val<a name='2737'>
             do trj = 1,n_traj<a name='2738'>
               if( trj_msk(trj,spc) ) then<a name='2739'>
                 buf_ndx = <A href='../../html_code/share/module_trajectory.F.html#GET_SPC_BUF_NDX'>get_spc_buf_ndx</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_SPC_BUF_NDX_2">( trjects(trj)%n_hyd_var, trjects(trj)%hyd_spc, moist_dname_table(dm,spc) )<a name='2740'>
                 if( buf_ndx &gt; 0 ) then<a name='2741'>
                   holder(trj,:n_vals) = trj_pbf(trj)%hyd_vals(:n_vals,buf_ndx)<a name='2742'>
                 endif<a name='2743'>
               endif<a name='2744'>
             end do<a name='2745'>
             write(var_name,'(a,''_traj'')') trim(moist_dname_table(dm,spc))<a name='2746'>
             err_mes = 'trajectory_write_file: failed to get '// trim(var_name) // ' id'<a name='2747'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_42">( nf_inq_varid( ncid, trim(var_name), varid ),trim(err_mes) )<a name='2748'>
             err_mes = 'trajectory_write_file: failed to write ' // trim(var_name)<a name='2749'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_43">( nf_put_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,n_vals /), &amp;<a name='2750'>
                                                  holder ),trim(err_mes) )<a name='2751'>
           endif<a name='2752'>
         end do<a name='2753'>
       case( 'trc' )<a name='2754'>
         trj_msk =&gt; trj_msk_dm(:,:,trc_pkg,dm)<a name='2755'>
         do spc = param_first_scalar,num_tracer<a name='2756'>
           if( any( trj_msk(:n_traj,spc) ) ) then<a name='2757'>
             holder(:,:) = missing_val<a name='2758'>
             do trj = 1,n_traj<a name='2759'>
               if( trj_msk(trj,spc) ) then<a name='2760'>
                 buf_ndx = <A href='../../html_code/share/module_trajectory.F.html#GET_SPC_BUF_NDX'>get_spc_buf_ndx</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_SPC_BUF_NDX_3">( trjects(trj)%n_trc_var, trjects(trj)%trc_spc, tracer_dname_table(dm,spc) )<a name='2761'>
                 if( buf_ndx &gt; 0 ) then<a name='2762'>
                   holder(trj,:n_vals) = trj_pbf(trj)%trc_vals(:n_vals,buf_ndx)<a name='2763'>
                 endif<a name='2764'>
               endif<a name='2765'>
             end do<a name='2766'>
             write(var_name,'(a,''_traj'')') trim(tracer_dname_table(dm,spc))<a name='2767'>
             err_mes = 'trajectory_write_file: failed to get '// trim(var_name) // ' id'<a name='2768'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_44">( nf_inq_varid( ncid, trim(var_name), varid ),trim(err_mes) )<a name='2769'>
             err_mes = 'trajectory_write_file: failed to write ' // trim(var_name)<a name='2770'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_45">( nf_put_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,n_vals /), &amp;<a name='2771'>
                                                  holder ),trim(err_mes) )<a name='2772'>
           endif<a name='2773'>
         end do<a name='2774'>
       case( 'dyn' )<a name='2775'>
         trj_msk =&gt; trj_msk_dm(:,:,dyn_pkg,dm)<a name='2776'>
         do spc = param_first_scalar,dyn_max+offset<a name='2777'>
           if( any( trj_msk(:n_traj,spc) ) ) then<a name='2778'>
             holder(:,:) = missing_val<a name='2779'>
             do trj = 1,n_traj<a name='2780'>
               if( trj_msk(trj,spc) ) then<a name='2781'>
                 buf_ndx = <A href='../../html_code/share/module_trajectory.F.html#GET_SPC_BUF_NDX'>get_spc_buf_ndx</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_SPC_BUF_NDX_4">( trjects(trj)%n_dyn_var, trjects(trj)%dyn_var, dyn_var_lst(spc-offset) )<a name='2782'>
                 if( buf_ndx &gt; 0 ) then<a name='2783'>
                   holder(trj,:n_vals) = trj_pbf(trj)%dyn_vals(:n_vals,buf_ndx)<a name='2784'>
                 endif<a name='2785'>
               endif<a name='2786'>
             end do<a name='2787'>
             write(var_name,'(a,''_traj'')') trim(dyn_var_lst(spc-offset))<a name='2788'>
             err_mes = 'trajectory_write_file: failed to get '// trim(var_name) // ' id'<a name='2789'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_46">( nf_inq_varid( ncid, trim(var_name), varid ),trim(err_mes) )<a name='2790'>
             err_mes = 'trajectory_write_file: failed to write ' // trim(var_name)<a name='2791'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_47">( nf_put_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,n_vals /), &amp;<a name='2792'>
                                                  holder ),trim(err_mes) )<a name='2793'>
           endif<a name='2794'>
         end do<a name='2795'>
       case( 'msc' )<a name='2796'>
         trj_msk =&gt; trj_msk_dm(:,:,msc_pkg,dm)<a name='2797'>
         do spc = param_first_scalar,num_msc+offset<a name='2798'>
           if( any( trj_msk(:n_traj,spc) ) ) then<a name='2799'>
             holder(:,:) = missing_val<a name='2800'>
             do trj = 1,n_traj<a name='2801'>
               if( trj_msk(trj,spc) ) then<a name='2802'>
                 found = .false.<a name='2803'>
                 do buf_ndx = 1,traject(trj,dm)%n_msc_var<a name='2804'>
                   if( traject(trj,dm)%msc_ndx(buf_ndx) == spc ) then<a name='2805'>
                     found = .true.<a name='2806'>
                     exit<a name='2807'>
                   endif<a name='2808'>
                 end do<a name='2809'>
                 if( found ) then<a name='2810'>
                   holder(trj,:n_vals) = trj_pbf(trj)%msc_vals(:n_vals,buf_ndx)<a name='2811'>
                 endif<a name='2812'>
               endif<a name='2813'>
             end do<a name='2814'>
             write(var_name,'(a,''_traj'')') trim(St_Vars(spc-offset)%Varname)<a name='2815'>
             err_mes = 'trajectory_write_file: failed to get '// trim(var_name) // ' id'<a name='2816'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_48">( nf_inq_varid( ncid, trim(var_name), varid ),trim(err_mes) )<a name='2817'>
             err_mes = 'trajectory_write_file: failed to write ' // trim(var_name)<a name='2818'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_49">( nf_put_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,n_vals /), &amp;<a name='2819'>
                                                  holder ),trim(err_mes) )<a name='2820'>
           endif<a name='2821'>
         end do<a name='2822'>
       case( 'dchm' )<a name='2823'>
         dchm_buf_ndx =&gt; dchm_buf_ndx_dm(:,dm)<a name='2824'>
         trj_msk =&gt; trj_msk_dm(:,:,dchm_pkg,dm)<a name='2825'>
         n_dchm  =&gt; n_dchm_dm(dm)<a name='2826'>
         do spc = 1,n_dchm<a name='2827'>
           spcp1 = spc + 1<a name='2828'>
           if( any( trj_msk(:n_traj,spcp1) ) ) then<a name='2829'>
             holder(:,:) = missing_val<a name='2830'>
             do trj = 1,n_traj<a name='2831'>
               if( trj_msk(trj,spcp1) ) then<a name='2832'>
                 buf_ndx = <A href='../../html_code/share/module_trajectory.F.html#GET_DCHM_BUF_NDX'>get_dchm_buf_ndx</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DCHM_BUF_NDX_1">( trjects(trj)%n_dchm_var, trjects(trj)%dchm_ndx, spcp1 )<a name='2833'>
                 if( buf_ndx &gt; 0 ) then<a name='2834'>
                   holder(trj,:n_vals) = trj_pbf(trj)%dchm_vals(:n_vals,buf_ndx)<a name='2835'>
                 endif<a name='2836'>
               endif<a name='2837'>
             end do<a name='2838'>
             ndx = dchm_buf_ndx(spc)<a name='2839'>
             var_name = 'dchm_' // trim(chem_dname_table(dm,ndx)) // '_traj'<a name='2840'>
<font color=#447700>!            write(var_name,'(a,''_traj'')') trim(chem_dname_table(dm,ndx))<a name='2841'></font>
             err_mes = 'trajectory_write_file: failed to get '// trim(var_name) // ' id'<a name='2842'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_50">( nf_inq_varid( ncid, trim(var_name), varid ),trim(err_mes) )<a name='2843'>
             err_mes = 'trajectory_write_file: failed to write ' // trim(var_name)<a name='2844'>
             call <A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR'>handle_ncerr</A><A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_WRITE_FILE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HANDLE_NCERR_51">( nf_put_vara_real( ncid, varid, (/ 1,time_ndx /), (/ n_traj,n_vals /), &amp;<a name='2845'>
                                                  holder ),trim(err_mes) )<a name='2846'>
           endif<a name='2847'>
         end do<a name='2848'>
     end select<a name='2849'>
   end do pkg_loop<a name='2850'>
<a name='2851'>
   n_vals = 0<a name='2852'>
<a name='2853'>
   ios = nf_close( ncid )<a name='2854'>
<a name='2855'>
   if( allocated( holder ) ) then<a name='2856'>
     deallocate( holder )<a name='2857'>
   endif<a name='2858'>
<a name='2859'>
   end subroutine trajectory_write_file<a name='2860'>
<a name='2861'>
<A NAME='GET_SPC_BUF_NDX'><A href='../../html_code/share/module_trajectory.F.html#GET_SPC_BUF_NDX' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2862'>
   integer <font color=#993300>function </font><font color=#cc0000>get_spc_buf_ndx</font>( ncnt, list, match_name ) <A href='../../call_to/GET_SPC_BUF_NDX.html' TARGET='index'>4</A><a name='2863'>
<a name='2864'>
   integer, intent(in)          :: ncnt<a name='2865'>
   character(len=*), intent(in) :: match_name<a name='2866'>
   character(len=*), intent(in) :: list(:)<a name='2867'>
<a name='2868'>
   integer :: spc<a name='2869'>
<a name='2870'>
   get_spc_buf_ndx = -1<a name='2871'>
   do spc = 1,ncnt<a name='2872'>
     if( trim(match_name) == trim(list(spc)) ) then<a name='2873'>
       get_spc_buf_ndx = spc<a name='2874'>
       exit<a name='2875'>
     endif<a name='2876'>
   end do<a name='2877'>
<a name='2878'>
   end function get_spc_buf_ndx<a name='2879'>
<a name='2880'>
<A NAME='GET_DCHM_BUF_NDX'><A href='../../html_code/share/module_trajectory.F.html#GET_DCHM_BUF_NDX' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2881'>
   integer <font color=#993300>function </font><font color=#cc0000>get_dchm_buf_ndx</font>( ncnt, list, match_ndx ) <A href='../../call_to/GET_DCHM_BUF_NDX.html' TARGET='index'>1</A><a name='2882'>
<a name='2883'>
   integer, intent(in)          :: ncnt<a name='2884'>
   integer, intent(in)          :: match_ndx<a name='2885'>
   integer, intent(in)          :: list(:)<a name='2886'>
<a name='2887'>
   integer :: spc<a name='2888'>
<a name='2889'>
   get_dchm_buf_ndx = -1<a name='2890'>
   do spc = 1,ncnt<a name='2891'>
     if( match_ndx == list(spc) ) then<a name='2892'>
       get_dchm_buf_ndx = spc<a name='2893'>
       exit<a name='2894'>
     endif<a name='2895'>
   end do<a name='2896'>
<a name='2897'>
   end function get_dchm_buf_ndx<a name='2898'>
<a name='2899'>
<A NAME='HANDLE_NCERR'><A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2900'>
   <font color=#993300>subroutine </font><font color=#cc0000>handle_ncerr</font>( ret, mes ) <A href='../../call_to/HANDLE_NCERR.html' TARGET='index'>51</A>,<A href='../../call_from/HANDLE_NCERR.html' TARGET='index'>3</A><a name='2901'>
<font color=#447700>!---------------------------------------------------------------------<a name='2902'></font>
<font color=#447700>!	... netcdf error handling routine<a name='2903'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2904'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2905'></font>
<font color=#447700>!	... dummy arguments<a name='2906'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='2907'></font>
   integer, intent(in) :: ret<a name='2908'>
   character(len=*), intent(in) :: mes<a name='2909'>
<a name='2910'>
include 'netcdf.inc'<a name='2911'>
<a name='2912'>
   if( ret /= nf_noerr ) then<a name='2913'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1392">( trim(mes) )<a name='2914'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1393">( trim(nf_strerror(ret)) )<a name='2915'>
      call <A href='../../html_code/io_netcdf/vort.F90.html#WRF_ABORT'>wrf_abort</A><A href='../../html_code/share/module_trajectory.F.html#HANDLE_NCERR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ABORT_2"><a name='2916'>
   endif<a name='2917'>
<a name='2918'>
   end subroutine handle_ncerr<a name='2919'>
#endif<a name='2920'>
<a name='2921'>
<A NAME='TRAJMAPPROJ'><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2922'>
   <font color=#993300>subroutine </font><font color=#cc0000>trajmapproj</font> (grid,config_flags,ts_proj) <A href='../../call_to/TRAJMAPPROJ.html' TARGET='index'>2</A>,<A href='../../call_from/TRAJMAPPROJ.html' TARGET='index'>24</A><a name='2923'>
<a name='2924'>
   use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_442"><a name='2925'>
   use <A href='../../html_code/share/module_llxy.F.html#MODULE_LLXY'>module_llxy</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LLXY_9"><a name='2926'>
   use <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_283">, only : grid_config_rec_type, model_config_rec<a name='2927'>
   use <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_198">, only : wrf_dm_min_real<a name='2928'>
<a name='2929'>
   IMPLICIT NONE<a name='2930'>
<a name='2931'>
<a name='2932'>
<font color=#447700>!------------------------------------------------------------------------<a name='2933'></font>
<font color=#447700>! Arguments<a name='2934'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2935'></font>
   TYPE(domain), INTENT(IN) :: grid<a name='2936'>
   TYPE(grid_config_rec_type) , INTENT(IN)  :: config_flags<a name='2937'>
   TYPE(PROJ_INFO), INTENT(out) :: ts_proj<a name='2938'>
<a name='2939'>
<font color=#447700>!------------------------------------------------------------------------<a name='2940'></font>
<font color=#447700>! Local variables<a name='2941'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2942'></font>
   REAL :: ts_rx, ts_ry, ts_xlat, ts_xlong, ts_hgt<a name='2943'>
   REAL :: known_lat, known_lon<a name='2944'>
<a name='2945'>
   INTEGER :: ids, ide, jds, jde, kds, kde,        &amp;<a name='2946'>
              ims, ime, jms, jme, kms, kme,        &amp;<a name='2947'>
              ips, ipe, jps, jpe, kps, kpe<a name='2948'>
<a name='2949'>
   TYPE (grid_config_rec_type)               :: config_flags_temp<a name='2950'>
<a name='2951'>
   config_flags_temp = config_flags<a name='2952'>
<a name='2953'>
   call <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_118"> ( grid ,                               &amp;<a name='2954'>
                            ids, ide, jds, jde, kds, kde,        &amp;<a name='2955'>
                            ims, ime, jms, jme, kms, kme,        &amp;<a name='2956'>
                            ips, ipe, jps, jpe, kps, kpe )<a name='2957'>
<a name='2958'>
   call <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_84"> ( grid%id , model_config_rec , config_flags_temp )<a name='2959'>
<a name='2960'>
<a name='2961'>
<font color=#447700>!------------------------------------------------------------------------<a name='2962'></font>
<font color=#447700>! Set up map transformation structure<a name='2963'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2964'></font>
   call <A href='../../html_code/share/module_llxy.F.html#MAP_INIT'>map_init</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_INIT_4">( ts_proj )<a name='2965'>
<a name='2966'>
   IF (ips &lt;= 1 .AND. 1 &lt;= ipe .AND. jps &lt;= 1 .AND. 1 &lt;= jpe) THEN<a name='2967'>
      known_lat = grid%xlat(1,1)<a name='2968'>
      known_lon = grid%xlong(1,1)<a name='2969'>
   ELSE<a name='2970'>
      known_lat = 9999.<a name='2971'>
      known_lon = 9999.<a name='2972'>
   END IF<a name='2973'>
   known_lat = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_5">(known_lat)<a name='2974'>
   known_lon = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_6">(known_lon)<a name='2975'>
<a name='2976'>
<a name='2977'>
   select case( config_flags%map_proj )<a name='2978'>
<font color=#447700>!------------------------------------------------------------------------<a name='2979'></font>
<font color=#447700>! Mercator<a name='2980'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2981'></font>
     case( PROJ_MERC )<a name='2982'>
       call <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_12">(PROJ_MERC, ts_proj,               &amp;<a name='2983'>
                    truelat1 = config_flags%truelat1, &amp;<a name='2984'>
                    lat1     = known_lat,             &amp;<a name='2985'>
                    lon1     = known_lon,             &amp;<a name='2986'>
                    knowni   = 1.,                    &amp;<a name='2987'>
                    knownj   = 1.,                    &amp;<a name='2988'>
                    dx       = config_flags%dx)<a name='2989'>
<font color=#447700>!------------------------------------------------------------------------<a name='2990'></font>
<font color=#447700>! Lambert conformal<a name='2991'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2992'></font>
     case( PROJ_LC )<a name='2993'>
       call <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_13">(PROJ_LC, ts_proj,                  &amp;<a name='2994'>
                    truelat1 = config_flags%truelat1,  &amp;<a name='2995'>
                    truelat2 = config_flags%truelat2,  &amp;<a name='2996'>
                    stdlon   = config_flags%stand_lon, &amp;<a name='2997'>
                    lat1     = known_lat,              &amp;<a name='2998'>
                    lon1     = known_lon,              &amp;<a name='2999'>
                    knowni   = 1.,                     &amp;<a name='3000'>
                    knownj   = 1.,                     &amp;<a name='3001'>
                    dx       = config_flags%dx)<a name='3002'>
<font color=#447700>!------------------------------------------------------------------------<a name='3003'></font>
<font color=#447700>! Polar stereographic<a name='3004'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3005'></font>
     case( PROJ_PS )<a name='3006'>
       call <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_14">(PROJ_PS, ts_proj,                  &amp;<a name='3007'>
                    truelat1 = config_flags%truelat1,  &amp;<a name='3008'>
                    stdlon   = config_flags%stand_lon, &amp;<a name='3009'>
                    lat1     = known_lat,              &amp;<a name='3010'>
                    lon1     = known_lon,              &amp;<a name='3011'>
                    knowni   = 1.,                     &amp;<a name='3012'>
                    knownj   = 1.,                     &amp;<a name='3013'>
                    dx       = config_flags%dx)<a name='3014'>
<font color=#447700>!------------------------------------------------------------------------<a name='3015'></font>
<font color=#447700>! Cassini (global ARW)<a name='3016'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3017'></font>
     case( PROJ_CASSINI )<a name='3018'>
       call <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_15">(PROJ_CASSINI, ts_proj,                            &amp;<a name='3019'>
                    latinc   = grid%dy*360.0/(2.0*EARTH_RADIUS_M*PI), &amp;<a name='3020'>
                    loninc   = grid%dx*360.0/(2.0*EARTH_RADIUS_M*PI), &amp;<a name='3021'>
                    lat1     = known_lat,                             &amp;<a name='3022'>
                    lon1     = known_lon,                             &amp;<a name='3023'>
<font color=#447700>! We still need to get POLE_LAT and POLE_LON metadata variables before<a name='3024'></font>
<font color=#447700>!   this will work for rotated poles.<a name='3025'></font>
                    lat0     = 90.0,                                  &amp;<a name='3026'>
                    lon0     = 0.0,                                   &amp;<a name='3027'>
                    knowni   = 1.,                                    &amp;<a name='3028'>
                    knownj   = 1.,                                    &amp;<a name='3029'>
                    stdlon   = config_flags%stand_lon)<a name='3030'>
<font color=#447700>!------------------------------------------------------------------------<a name='3031'></font>
<font color=#447700>! Rotated latitude-longitude<a name='3032'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='3033'></font>
     case( PROJ_ROTLL )<a name='3034'>
       call <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_16">(PROJ_ROTLL, ts_proj,                      &amp;<a name='3035'>
                    ixdim    = grid%e_we-1,                   &amp;<a name='3036'>
                    jydim    = grid%e_sn-1,                   &amp;<a name='3037'>
                    phi      = real(grid%e_sn-2)*grid%dy/2.0, &amp;<a name='3038'>
                    lambda   = real(grid%e_we-2)*grid%dx,     &amp;<a name='3039'>
                    lat1     = config_flags%cen_lat,          &amp;<a name='3040'>
                    lon1     = config_flags%cen_lon,          &amp;<a name='3041'>
                    latinc   = grid%dy,                       &amp;<a name='3042'>
                    loninc   = grid%dx,                       &amp;<a name='3043'>
                    stagger  = HH)<a name='3044'>
   end select<a name='3045'>
<a name='3046'>
   end subroutine trajmapproj<a name='3047'>
<a name='3048'>
<A NAME='UPCASE'><A href='../../html_code/share/module_trajectory.F.html#UPCASE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3049'>
   <font color=#993300>subroutine </font><font color=#cc0000>UPCASE</font>( lstring ) <A href='../../call_to/UPCASE.html' TARGET='index'>2</A><a name='3050'>
<font color=#447700>!----------------------------------------------------------------------<a name='3051'></font>
<font color=#447700>!       ... Convert character string lstring to upper case<a name='3052'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='3053'></font>
   implicit none<a name='3054'>
<a name='3055'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3056'></font>
<font color=#447700>!	... Dummy args<a name='3057'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3058'></font>
   character(len=*), intent(inout) ::  lstring<a name='3059'>
<a name='3060'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3061'></font>
<font color=#447700>!	... Local variables<a name='3062'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3063'></font>
   integer :: i<a name='3064'>
<a name='3065'>
   do i = 1,LEN_TRIM( lstring )<a name='3066'>
     if( ICHAR(lstring(i:i)) &gt;= 97 .and.  ICHAR(lstring(i:i)) &lt;= 122 ) then<a name='3067'>
       lstring(i:i) = CHAR(ICHAR(lstring(i:i)) - 32)<a name='3068'>
     end if<a name='3069'>
   end do<a name='3070'>
<a name='3071'>
   end subroutine UPCASE<a name='3072'>
<a name='3073'>
#endif<a name='3074'>
<a name='3075'>
   end module module_trajectory<a name='3076'>
</pre></body></html>