<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( <font color=#447700>! NMM_CORE == 1 )<a name='2'></font>
<a name='3'>
<A NAME='MODULE_SOIL_PRE'><A href='../../html_code/share/module_soil_pre.F.html#MODULE_SOIL_PRE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_soil_pre</font> <A href='../../call_to/MODULE_SOIL_PRE.html' TARGET='index'>5</A><a name='5'>
<a name='6'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/module_soil_pre.F.html#module_soil_pre.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_26"><a name='7'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_soil_pre.F.html#module_soil_pre.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_194"><a name='8'>
<a name='9'>
   CHARACTER (LEN=3) :: num_cat_count<a name='10'>
   INTEGER , PARAMETER , DIMENSION(0:300) :: ints = &amp;<a name='11'>
   (/    0,    1,    2,    3,    4,    5,    6,    7,    8,    9, &amp;<a name='12'>
        10,   11,   12,   13,   14,   15,   16,   17,   18,   19, &amp;<a name='13'>
        20,   21,   22,   23,   24,   25,   26,   27,   28,   29, &amp;<a name='14'>
        30,   31,   32,   33,   34,   35,   36,   37,   38,   39, &amp;<a name='15'>
        40,   41,   42,   43,   44,   45,   46,   47,   48,   49, &amp;<a name='16'>
        50,   51,   52,   53,   54,   55,   56,   57,   58,   59, &amp;<a name='17'>
        60,   61,   62,   63,   64,   65,   66,   67,   68,   69, &amp;<a name='18'>
        70,   71,   72,   73,   74,   75,   76,   77,   78,   79, &amp;<a name='19'>
        80,   81,   82,   83,   84,   85,   86,   87,   88,   89, &amp;<a name='20'>
        90,   91,   92,   93,   94,   95,   96,   97,   98,   99, &amp;<a name='21'>
       100,  101,  102,  103,  104,  105,  106,  107,  108,  109, &amp;<a name='22'>
       110,  111,  112,  113,  114,  115,  116,  117,  118,  119, &amp;<a name='23'>
       120,  121,  122,  123,  124,  125,  126,  127,  128,  129, &amp;<a name='24'>
       130,  131,  132,  133,  134,  135,  136,  137,  138,  139, &amp;<a name='25'>
       140,  141,  142,  143,  144,  145,  146,  147,  148,  149, &amp;<a name='26'>
       150,  151,  152,  153,  154,  155,  156,  157,  158,  159, &amp;<a name='27'>
       160,  161,  162,  163,  164,  165,  166,  167,  168,  169, &amp;<a name='28'>
       170,  171,  172,  173,  174,  175,  176,  177,  178,  179, &amp;<a name='29'>
       180,  181,  182,  183,  184,  185,  186,  187,  188,  189, &amp;<a name='30'>
       190,  191,  192,  193,  194,  195,  196,  197,  198,  199, &amp;<a name='31'>
       200,  201,  202,  203,  204,  205,  206,  207,  208,  209, &amp;<a name='32'>
       210,  211,  212,  213,  214,  215,  216,  217,  218,  219, &amp;<a name='33'>
       220,  221,  222,  223,  224,  225,  226,  227,  228,  229, &amp;<a name='34'>
       230,  231,  232,  233,  234,  235,  236,  237,  238,  239, &amp;<a name='35'>
       240,  241,  242,  243,  244,  245,  246,  247,  248,  249, &amp;<a name='36'>
       250,  251,  252,  253,  254,  255,  256,  257,  258,  259, &amp;<a name='37'>
       260,  261,  262,  263,  264,  265,  266,  267,  268,  269, &amp;<a name='38'>
       270,  271,  272,  273,  274,  275,  276,  277,  278,  279, &amp;<a name='39'>
       280,  281,  282,  283,  284,  285,  286,  287,  288,  289, &amp;<a name='40'>
       290,  291,  292,  293,  294,  295,  296,  297,  298,  299, 300 /)<a name='41'>
<a name='42'>
   <font color=#447700>!  Excluded middle processing<a name='43'></font>
<a name='44'>
   LOGICAL , SAVE :: hold_ups<a name='45'>
   INTEGER , SAVE :: em_width<a name='46'>
<a name='47'>
   LOGICAL , EXTERNAL :: skip_middle_points_t<a name='48'>
<a name='49'>
CONTAINS<a name='50'>
<a name='51'>
<A NAME='ADJUST_FOR_SEAICE_PRE'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='52'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_for_seaice_pre</font> ( xice , landmask , tsk , ivgtyp , vegcat , lu_index , &amp;,<A href='../../call_from/ADJUST_FOR_SEAICE_PRE.html' TARGET='index'>6</A><a name='53'>
                                      xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='54'>
                                      soilcbot , tmn , &amp;<a name='55'>
                                      seaice_threshold , &amp;<a name='56'>
                                      fractional_seaice, &amp;<a name='57'>
                                      num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='58'>
                                      iswater , isice , &amp;<a name='59'>
                                      scheme , &amp;<a name='60'>
                                      ids , ide , jds , jde , kds , kde , &amp;<a name='61'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='62'>
                                      its , ite , jts , jte , kts , kte )<a name='63'>
<a name='64'>
      IMPLICIT NONE<a name='65'>
<a name='66'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='67'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='68'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='69'>
                              iswater , isice<a name='70'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat , scheme<a name='71'>
<a name='72'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landusef<a name='73'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(INOUT):: soilctop<a name='74'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(INOUT):: soilcbot<a name='75'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='76'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask , xice , tsk , lu_index , &amp;<a name='77'>
                                                           vegcat, xland , soilcat , tmn<a name='78'>
      REAL , INTENT(IN) :: seaice_threshold<a name='79'>
<a name='80'>
      INTEGER :: i , j , num_seaice_changes , loop<a name='81'>
      CHARACTER (LEN=132) :: message<a name='82'>
<a name='83'>
      INTEGER, INTENT(IN) :: fractional_seaice<a name='84'>
      REAL :: XICE_THRESHOLD<a name='85'>
<a name='86'>
      IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='87'>
         xice_threshold = 0.5<a name='88'>
      ELSEIF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='89'>
         xice_threshold = 0.02<a name='90'>
      ENDIF<a name='91'>
<a name='92'>
      num_seaice_changes = 0<a name='93'>
      fix_seaice : SELECT CASE ( scheme )<a name='94'>
<a name='95'>
         CASE ( SLABSCHEME )<a name='96'>
            DO j = jts , MIN(jde-1,jte)<a name='97'>
               DO i = its , MIN(ide-1,ite)<a name='98'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='99'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='100'>
                     xice(i,j) = 0.<a name='101'>
                     num_seaice_changes = num_seaice_changes + 1<a name='102'>
                  END IF<a name='103'>
               END DO<a name='104'>
            END DO<a name='105'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='106'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='107'>
               'Total pre number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='108'>
               num_seaice_changes<a name='109'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1081"> ( 0 , message )<a name='110'>
            END IF<a name='111'>
            num_seaice_changes = 0<a name='112'>
            DO j = jts , MIN(jde-1,jte)<a name='113'>
               DO i = its , MIN(ide-1,ite)<a name='114'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='115'>
                  IF ( ( xice(i,j) .GE. xice_threshold ) .OR. &amp;<a name='116'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='117'>
                     IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='118'>
                        xice(i,j) = 1.0<a name='119'>
                     ENDIF<a name='120'>
                     num_seaice_changes = num_seaice_changes + 1<a name='121'>
                     if(landmask(i,j) .LT. 0.5 )tmn(i,j) = 271.4<a name='122'>
                     vegcat(i,j)=isice<a name='123'>
                     ivgtyp(i,j)=isice<a name='124'>
                     lu_index(i,j)=isice<a name='125'>
                     landmask(i,j)=1.<a name='126'>
                     xland(i,j)=1.<a name='127'>
                     DO loop=1,num_veg_cat<a name='128'>
                        landusef(i,loop,j)=0.<a name='129'>
                     END DO<a name='130'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='131'>
<a name='132'>
                     isltyp(i,j) = 16<a name='133'>
                     soilcat(i,j)=isltyp(i,j)<a name='134'>
                     DO loop=1,num_soil_top_cat<a name='135'>
                        soilctop(i,loop,j)=0<a name='136'>
                     END DO<a name='137'>
                     DO loop=1,num_soil_bot_cat<a name='138'>
                        soilcbot(i,loop,j)=0<a name='139'>
                     END DO<a name='140'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='141'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='142'>
                  ELSE<a name='143'>
                     xice(i,j) = 0.0<a name='144'>
                  END IF<a name='145'>
               END DO<a name='146'>
            END DO<a name='147'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='148'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='149'>
               'Total pre number of sea ice location changes (water to land) = ', num_seaice_changes<a name='150'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1082"> ( 0 , message )<a name='151'>
            END IF<a name='152'>
<a name='153'>
         CASE ( LSMSCHEME , NOAHMPSCHEME , RUCLSMSCHEME ,CLMSCHEME,SSIBSCHEME)   <font color=#447700>!mchen add for ssib<a name='154'></font>
            num_seaice_changes = 0<a name='155'>
            DO j = jts , MIN(jde-1,jte)<a name='156'>
               DO i = its , MIN(ide-1,ite)<a name='157'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='158'>
                  IF ( landmask(i,j) .GT. 0.5 ) THEN<a name='159'>
                     if (xice(i,j).gt.0) num_seaice_changes = num_seaice_changes + 1<a name='160'>
                     xice(i,j) = 0.<a name='161'>
                  END IF<a name='162'>
               END DO<a name='163'>
            END DO<a name='164'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='165'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='166'>
               'Total pre number of land location changes (seaice set to zero) = ', num_seaice_changes<a name='167'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1083"> ( 0 , message )<a name='168'>
            END IF<a name='169'>
<a name='170'>
      END SELECT fix_seaice<a name='171'>
<a name='172'>
   END SUBROUTINE adjust_for_seaice_pre<a name='173'>
<a name='174'>
<A NAME='ADJUST_FOR_SEAICE_POST'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='175'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_for_seaice_post</font> ( xice , landmask , tsk_old , tsk , ivgtyp , vegcat , lu_index , &amp;,<A href='../../call_from/ADJUST_FOR_SEAICE_POST.html' TARGET='index'>11</A><a name='176'>
                                      xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='177'>
                                      soilcbot , tmn , vegfra , &amp;<a name='178'>
                                      tslb , smois , sh2o , &amp;<a name='179'>
                                      seaice_threshold , &amp;<a name='180'>
                                      sst , flag_sst , &amp;<a name='181'>
                                      fractional_seaice, &amp;<a name='182'>
                                      num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='183'>
                                      num_soil_layers , &amp;<a name='184'>
                                      iswater , isice , &amp;<a name='185'>
                                      scheme , &amp;<a name='186'>
                                      ids , ide , jds , jde , kds , kde , &amp;<a name='187'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='188'>
                                      its , ite , jts , jte , kts , kte )<a name='189'>
<a name='190'>
      IMPLICIT NONE<a name='191'>
<a name='192'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='193'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='194'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='195'>
                              iswater , isice<a name='196'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat , scheme<a name='197'>
      INTEGER , INTENT(IN) :: num_soil_layers<a name='198'>
<a name='199'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landusef<a name='200'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(INOUT):: soilctop<a name='201'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(INOUT):: soilcbot<a name='202'>
      REAL , DIMENSION(ims:ime,1:num_soil_layers,jms:jme) , INTENT(INOUT):: tslb , smois , sh2o<a name='203'>
      REAL , DIMENSION(ims:ime,jms:jme)                   , INTENT(IN):: sst<a name='204'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='205'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask , xice , tsk , lu_index , &amp;<a name='206'>
                                                           vegcat, xland , soilcat , tmn , &amp;<a name='207'>
                                                           tsk_old , vegfra<a name='208'>
      INTEGER , INTENT(IN) :: flag_sst<a name='209'>
      REAL , INTENT(IN) :: seaice_threshold<a name='210'>
      REAL :: total_depth , mid_point_depth<a name='211'>
<a name='212'>
      INTEGER :: i , j , num_seaice_changes , loop<a name='213'>
      CHARACTER (LEN=132) :: message<a name='214'>
<a name='215'>
<a name='216'>
      INTEGER, INTENT(IN) :: fractional_seaice<a name='217'>
      real :: xice_threshold<a name='218'>
<a name='219'>
      IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='220'>
         xice_threshold = 0.5<a name='221'>
      ELSEIF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='222'>
         xice_threshold = 0.02<a name='223'>
      ENDIF<a name='224'>
<a name='225'>
      num_seaice_changes = 0<a name='226'>
      fix_seaice : SELECT CASE ( scheme )<a name='227'>
<a name='228'>
         CASE ( SLABSCHEME )<a name='229'>
<a name='230'>
         CASE ( LSMSCHEME , NOAHMPSCHEME , CLMSCHEME, SSIBSCHEME )   <font color=#447700>!mchen add for ssib<a name='231'></font>
            DO j = jts , MIN(jde-1,jte)<a name='232'>
               DO i = its , MIN(ide-1,ite)<a name='233'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='234'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='235'>
                     xice(i,j) = 0.<a name='236'>
                     num_seaice_changes = num_seaice_changes + 1<a name='237'>
                  END IF<a name='238'>
               END DO<a name='239'>
            END DO<a name='240'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='241'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='242'>
               'Total post number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='243'>
               num_seaice_changes<a name='244'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1084"> ( 0 , message )<a name='245'>
            END IF<a name='246'>
            num_seaice_changes = 0<a name='247'>
            DO j = jts , MIN(jde-1,jte)<a name='248'>
               DO i = its , MIN(ide-1,ite)<a name='249'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='250'>
                  IF ( ( ( tsk(i,j) .LT. 170 ) .OR. ( tsk(i,j) .GT. 400 ) ) .AND. &amp;<a name='251'>
                       ( ( tsk_old(i,j) .GT. 170 ) .AND. ( tsk_old(i,j) .LT. 400 ) ) )THEN<a name='252'>
                     tsk(i,j) = tsk_old(i,j)<a name='253'>
                  END IF<a name='254'>
                  IF ( ( ( tsk(i,j) .LT. 170 ) .OR. ( tsk(i,j) .GT. 400 ) ) .AND. &amp;<a name='255'>
                       ( ( tsk_old(i,j) .LT. 170 ) .OR. ( tsk_old(i,j) .GT. 400 ) ) )THEN<a name='256'>
                     print *,'TSK woes in seaice post, i,j=',i,j,'  tsk = ',tsk(i,j), tsk_old(i,j)<a name='257'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1431"> ( 'TSK is unrealistic, problems for seaice post')<a name='258'>
                  ELSE IF ( ( xice(i,j) .GE. xice_threshold ) .OR. &amp;<a name='259'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='260'>
                     IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='261'>
                        xice(i,j) = 1.0<a name='262'>
                     ENDIF<a name='263'>
                     num_seaice_changes = num_seaice_changes + 1<a name='264'>
                     if(landmask(i,j) .LT. 0.5 )tmn(i,j) = 271.4<a name='265'>
                     vegcat(i,j)=isice<a name='266'>
                     ivgtyp(i,j)=isice<a name='267'>
                     lu_index(i,j)=isice<a name='268'>
                     landmask(i,j)=1.<a name='269'>
                     xland(i,j)=1.<a name='270'>
                     vegfra(i,j)=0.<a name='271'>
                     DO loop=1,num_veg_cat<a name='272'>
                        landusef(i,loop,j)=0.<a name='273'>
                     END DO<a name='274'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='275'>
<a name='276'>
                     tsk_old(i,j) = tsk(i,j)<a name='277'>
<a name='278'>
                     isltyp(i,j) = 16<a name='279'>
                     soilcat(i,j)=isltyp(i,j)<a name='280'>
                     DO loop=1,num_soil_top_cat<a name='281'>
                        soilctop(i,loop,j)=0<a name='282'>
                     END DO<a name='283'>
                     DO loop=1,num_soil_bot_cat<a name='284'>
                        soilcbot(i,loop,j)=0<a name='285'>
                     END DO<a name='286'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='287'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='288'>
<a name='289'>
                     total_depth = 3. <font color=#447700>! ice is 3 m deep, num_soil_layers equispaced layers<a name='290'></font>
                     DO loop = 1,num_soil_layers<a name='291'>
                        mid_point_depth=(total_depth/num_soil_layers)/2. + &amp;<a name='292'>
                                        (loop-1)*(total_depth/num_soil_layers)<a name='293'>
                        tslb(i,loop,j) = ( (total_depth-mid_point_depth)*tsk(i,j) + &amp;<a name='294'>
                                            mid_point_depth*tmn(i,j) ) / total_depth<a name='295'>
                     END DO<a name='296'>
<a name='297'>
                     DO loop=1,num_soil_layers<a name='298'>
                        smois(i,loop,j) = 1.0<a name='299'>
                        sh2o(i,loop,j)  = 0.0<a name='300'>
                     END DO<a name='301'>
                  ELSE IF ( xice(i,j) .LT. xice_threshold ) THEN<a name='302'>
                     xice(i,j) = 0.<a name='303'>
                  END IF<a name='304'>
               END DO<a name='305'>
            END DO<a name='306'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='307'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='308'>
               'Total post number of sea ice location changes (water to land) = ', num_seaice_changes<a name='309'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1085"> ( 0 , message )<a name='310'>
            END IF<a name='311'>
<a name='312'>
        CASE ( RUCLSMSCHEME )<a name='313'>
            DO j = jts , MIN(jde-1,jte)<a name='314'>
               DO i = its , MIN(ide-1,ite)<a name='315'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='316'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='317'>
                     xice(i,j) = 0.<a name='318'>
                     num_seaice_changes = num_seaice_changes + 1<a name='319'>
                  END IF<a name='320'>
               END DO<a name='321'>
            END DO<a name='322'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='323'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='324'>
               'Total post number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='325'>
               num_seaice_changes<a name='326'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1086"> ( 0 , message )<a name='327'>
            END IF<a name='328'>
            num_seaice_changes = 0<a name='329'>
            DO j = jts , MIN(jde-1,jte)<a name='330'>
               DO i = its , MIN(ide-1,ite)<a name='331'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='332'>
                  IF ( ( ( tsk(i,j) .LT. 170 ) .OR. ( tsk(i,j) .GT. 400 ) ) .AND. &amp;<a name='333'>
                       ( ( tsk_old(i,j) .GT. 170 ) .AND. ( tsk_old(i,j) .LT. 400 ) ) )THEN<a name='334'>
                     tsk(i,j) = tsk_old(i,j)<a name='335'>
                  END IF<a name='336'>
                  IF ( ( ( tsk(i,j) .LT. 170 ) .OR. ( tsk(i,j) .GT. 400 ) ) .AND. &amp;<a name='337'>
                       ( ( tsk_old(i,j) .LT. 170 ) .OR. ( tsk_old(i,j) .GT. 400 ) ) )THEN<a name='338'>
                     print *,'TSK woes in seaice post, i,j=',i,j,'  tsk = ',tsk(i,j), tsk_old(i,j)<a name='339'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1432"> ( 'TSK is unrealistic, problems for seaice post')<a name='340'>
                  ELSE IF ( ( xice(i,j) .GE. xice_threshold ) .OR. &amp;<a name='341'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='342'>
                       IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='343'>
                          xice(i,j) = 1.0<a name='344'>
                       ELSE<a name='345'>
                          xice(i,j)=max(0.25,xice(i,j))<a name='346'>
                       ENDIF<a name='347'>
                     num_seaice_changes = num_seaice_changes + 1<a name='348'>
                     if(landmask(i,j) .LT. 0.5 )tmn(i,j) = 271.4<a name='349'>
                     vegcat(i,j)=isice<a name='350'>
                     ivgtyp(i,j)=isice<a name='351'>
                     lu_index(i,j)=isice<a name='352'>
                     landmask(i,j)=1.<a name='353'>
                     xland(i,j)=1.<a name='354'>
                     vegfra(i,j)=0.<a name='355'>
                     DO loop=1,num_veg_cat<a name='356'>
                        landusef(i,loop,j)=0.<a name='357'>
                     END DO<a name='358'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='359'>
<a name='360'>
<font color=#447700>!tgs - compute blended sea ice/water skin temperature<a name='361'></font>
                   if(flag_sst.eq.1) then<a name='362'>
                     tsk(i,j) = xice(i,j)*(min(271.4,tsk(i,j)))  &amp;<a name='363'>
                                +(1-xice(i,j))*sst(i,j)<a name='364'>
                   else<a name='365'>
                     tsk(i,j) = xice(i,j)*(min(271.4,tsk(i,j)))  &amp;<a name='366'>
                                +(1-xice(i,j))*tsk(i,j)<a name='367'>
                   endif<a name='368'>
                     tsk_old(i,j) = tsk(i,j)<a name='369'>
<a name='370'>
                     isltyp(i,j) = 16<a name='371'>
                     soilcat(i,j)=isltyp(i,j)<a name='372'>
                     DO loop=1,num_soil_top_cat<a name='373'>
                        soilctop(i,loop,j)=0<a name='374'>
                     END DO<a name='375'>
                     DO loop=1,num_soil_bot_cat<a name='376'>
                        soilcbot(i,loop,j)=0<a name='377'>
                     END DO<a name='378'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='379'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='380'>
<a name='381'>
                 total_depth = 3. <font color=#447700>! ice is 3 m deep, num_soil_layers equispaced layers<a name='382'></font>
                       tslb(i,1,j) = tsk(i,j)<a name='383'>
                       tslb(i,num_soil_layers,j) = tmn(i,j)<a name='384'>
                     DO loop = 2,num_soil_layers-1<a name='385'>
                        mid_point_depth=(total_depth/num_soil_layers)/4. + &amp;<a name='386'>
                                        (loop-2)*(total_depth/num_soil_layers)<a name='387'>
                        tslb(i,loop,j) = ( (total_depth-mid_point_depth)*tsk(i,j) + &amp;<a name='388'>
                                            mid_point_depth*tmn(i,j) ) / total_depth<a name='389'>
                     END DO<a name='390'>
<a name='391'>
                     DO loop=1,num_soil_layers<a name='392'>
                        smois(i,loop,j) = 1.0<a name='393'>
                        sh2o(i,loop,j)  = 0.0<a name='394'>
                     END DO<a name='395'>
                  ELSE IF ( xice(i,j) .LT. xice_threshold ) THEN<a name='396'>
                     xice(i,j) = 0.<a name='397'>
                  END IF<a name='398'>
               END DO<a name='399'>
            END DO<a name='400'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='401'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='402'>
               'Total post number of sea ice location changes (water to land) = ', num_seaice_changes<a name='403'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1087"> ( 0 , message )<a name='404'>
            END IF<a name='405'>
<a name='406'>
<a name='407'>
      END SELECT fix_seaice<a name='408'>
<a name='409'>
   END SUBROUTINE adjust_for_seaice_post<a name='410'>
<a name='411'>
<A NAME='PROCESS_PERCENT_CAT_NEW'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='412'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_percent_cat_new</font> ( landmask ,  &amp; <A href='../../call_to/PROCESS_PERCENT_CAT_NEW.html' TARGET='index'>2</A>,<A href='../../call_from/PROCESS_PERCENT_CAT_NEW.html' TARGET='index'>14</A><a name='413'>
                                landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='414'>
                                isltyp , ivgtyp , &amp;<a name='415'>
                                num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='416'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='417'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='418'>
                                its , ite , jts , jte , kts , kte , &amp;<a name='419'>
                                iswater )<a name='420'>
<a name='421'>
      IMPLICIT NONE<a name='422'>
<a name='423'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='424'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='425'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='426'>
                              iswater<a name='427'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='428'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landuse_frac<a name='429'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(IN):: soil_top_cat<a name='430'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(IN):: soil_bot_cat<a name='431'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='432'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask<a name='433'>
<a name='434'>
      INTEGER :: i , j , l , ll, dominant_index<a name='435'>
      REAL :: dominant_value<a name='436'>
<a name='437'>
#if ( WRF_CHEM == 1 )<a name='438'>
<font color=#447700>!      REAL :: lwthresh = .99<a name='439'></font>
      REAL :: lwthresh = .50<a name='440'>
#else<a name='441'>
      REAL :: lwthresh = .50<a name='442'>
#endif<a name='443'>
<a name='444'>
      INTEGER , PARAMETER :: iswater_soil = 14<a name='445'>
      INTEGER :: iforce<a name='446'>
      CHARACTER (LEN=132) :: message<a name='447'>
      CHARACTER(LEN=256) :: mminlu<a name='448'>
      LOGICAL :: aggregate_lu<a name='449'>
integer :: change_water , change_land<a name='450'>
change_water = 0<a name='451'>
change_land = 0<a name='452'>
<a name='453'>
      <font color=#447700>!  Sanity check on the 50/50 points<a name='454'></font>
<a name='455'>
      DO j = jts , MIN(jde-1,jte)<a name='456'>
         DO i = its , MIN(ide-1,ite)<a name='457'>
            IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='458'>
            dominant_value = landuse_frac(i,iswater,j)<a name='459'>
            IF ( dominant_value .EQ. lwthresh ) THEN<a name='460'>
               DO l = 1 , num_veg_cat<a name='461'>
                  IF ( l .EQ. iswater ) CYCLE<a name='462'>
                  IF ( ( landuse_frac(i,l,j) .EQ. lwthresh ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='463'>
                     PRINT *,i,j,' water and category ',l,' both at 50%, landmask is ',landmask(i,j)<a name='464'>
                     landuse_frac(i,l,j) = lwthresh - .01<a name='465'>
                     landuse_frac(i,iswater,j) = lwthresh + 0.01<a name='466'>
                  ELSE IF ( ( landuse_frac(i,l,j) .EQ. lwthresh ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='467'>
                     PRINT *,i,j,' water and category ',l,' both at 50%, landmask is ',landmask(i,j)<a name='468'>
                     landuse_frac(i,l,j) = lwthresh + .01<a name='469'>
                     landuse_frac(i,iswater,j) = lwthresh - 0.01<a name='470'>
                  END IF<a name='471'>
               END DO<a name='472'>
            END IF<a name='473'>
         END DO<a name='474'>
      END DO<a name='475'>
<a name='476'>
      <font color=#447700>!  Compute the aggregate of the vegetation/land use categories.  Lump all of the grasses together,<a name='477'></font>
      <font color=#447700>!  all of the shrubs, all of the trees, etc.  Choose the correct set of available land use<a name='478'></font>
      <font color=#447700>!  categories.  Also, make sure that the user wants to actually avail themselves of aforementioned<a name='479'></font>
      <font color=#447700>!  opportunity, as mayhaps they don't.<a name='480'></font>
 <a name='481'>
      CALL nl_get_mminlu       ( 1 , mminlu       )<a name='482'>
      CALL nl_get_aggregate_lu ( 1 , aggregate_lu )<a name='483'>
      IF ( aggregate_lu ) THEN<a name='484'>
         DO j = jts , MIN(jde-1,jte)<a name='485'>
            DO i = its , MIN(ide-1,ite)<a name='486'>
               IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='487'>
               CALL <A href='../../html_code/share/module_soil_pre.F.html#AGGREGATE_CATEGORIES_PART1'>aggregate_categories_part1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AGGREGATE_CATEGORIES_PART1_1"> ( landuse_frac , iswater , num_veg_cat , mminlu(1:4) )<a name='488'>
            END DO<a name='489'>
         END DO<a name='490'>
      END IF<a name='491'>
<a name='492'>
      <font color=#447700>!  Compute the dominant VEGETATION INDEX.<a name='493'></font>
<a name='494'>
      DO j = jts , MIN(jde-1,jte)<a name='495'>
         DO i = its , MIN(ide-1,ite)<a name='496'>
            IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='497'>
            dominant_value = landuse_frac(i,1,j)<a name='498'>
            dominant_index = 1<a name='499'>
            DO l = 2 , num_veg_cat<a name='500'>
               IF        ( l .EQ. iswater ) THEN<a name='501'>
                  <font color=#447700>! wait a bit<a name='502'></font>
               ELSE IF ( ( l .NE. iswater ) .AND. ( landuse_frac(i,l,j) .GT. dominant_value ) ) THEN<a name='503'>
                  dominant_value = landuse_frac(i,l,j)<a name='504'>
                  dominant_index = l<a name='505'>
               END IF<a name='506'>
            END DO<a name='507'>
            IF ( landuse_frac(i,iswater,j) .GT. lwthresh ) THEN<a name='508'>
               dominant_value = landuse_frac(i,iswater,j)<a name='509'>
               dominant_index = iswater<a name='510'>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh) .AND. &amp;<a name='511'>
                      ( landmask(i,j) .LT. 0.5) .AND. &amp;<a name='512'>
                      ( dominant_value .EQ. lwthresh) ) THEN<a name='513'>
               dominant_value = landuse_frac(i,iswater,j)<a name='514'>
               dominant_index = iswater<a name='515'>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh) .AND. &amp;<a name='516'>
                      ( landmask(i,j) .GT. 0.5) .AND. &amp;<a name='517'>
                      ( dominant_value .EQ. lwthresh) ) THEN<a name='518'>
               <font color=#447700>!no op<a name='519'></font>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh ) .AND. &amp;<a name='520'>
                      ( dominant_value .LT. lwthresh ) ) THEN<a name='521'>
               dominant_value = landuse_frac(i,iswater,j)<a name='522'>
               dominant_index = iswater<a name='523'>
            END IF<a name='524'>
            IF      ( dominant_index .EQ. iswater ) THEN<a name='525'>
if(landmask(i,j).gt.lwthresh) then<a name='526'>
<font color=#447700>!print *,'changing to water at point ',i,j<a name='527'></font>
<font color=#447700>!WRITE ( num_cat_count , FMT = '(I3)' ) num_veg_cat<a name='528'></font>
<font color=#447700>!WRITE ( message , FMT = '('//num_cat_count//'(i3,1x))' ) ints(1:num_veg_cat)<a name='529'></font>
<font color=#447700>!CALL wrf_debug(1,message)<a name='530'></font>
<font color=#447700>!WRITE ( message , FMT = '('//num_cat_count//'(i3,1x))' ) nint(landuse_frac(i,:,j)*100)<a name='531'></font>
<font color=#447700>!CALL wrf_debug(1,message)<a name='532'></font>
change_water=change_water+1<a name='533'>
endif<a name='534'>
               landmask(i,j) = 0<a name='535'>
            ELSE IF ( dominant_index .NE. iswater ) THEN<a name='536'>
if(landmask(i,j).lt.lwthresh) then<a name='537'>
<font color=#447700>!print *,'changing to land at point ',i,j<a name='538'></font>
<font color=#447700>!WRITE ( num_cat_count , FMT = '(I3)' ) num_veg_cat<a name='539'></font>
<font color=#447700>!WRITE ( message , FMT = '('//num_cat_count//'(i3,1x))' ) ints(1:num_veg_cat)<a name='540'></font>
<font color=#447700>!CALL wrf_debug(1,message)<a name='541'></font>
<font color=#447700>!WRITE ( message , FMT = '('//num_cat_count//'(i3,1x))' ) nint(landuse_frac(i,:,j)*100)<a name='542'></font>
<font color=#447700>!CALL wrf_debug(1,message)<a name='543'></font>
change_land=change_land+1<a name='544'>
endif<a name='545'>
               landmask(i,j) = 1<a name='546'>
            END IF<a name='547'>
            ivgtyp(i,j) = dominant_index<a name='548'>
         END DO<a name='549'>
      END DO<a name='550'>
<a name='551'>
      <font color=#447700>!  Compute the dominant SOIL TEXTURE INDEX, TOP.<a name='552'></font>
<a name='553'>
      iforce = 0<a name='554'>
      DO i = its , MIN(ide-1,ite)<a name='555'>
         DO j = jts , MIN(jde-1,jte)<a name='556'>
            IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='557'>
            dominant_value = soil_top_cat(i,1,j)<a name='558'>
            dominant_index = 1<a name='559'>
            IF ( landmask(i,j) .GT. lwthresh ) THEN<a name='560'>
               DO l = 2 , num_soil_top_cat<a name='561'>
                  IF ( ( l .NE. iswater_soil ) .AND. ( soil_top_cat(i,l,j) .GT. dominant_value ) ) THEN<a name='562'>
                     dominant_value = soil_top_cat(i,l,j)<a name='563'>
                     dominant_index = l<a name='564'>
                  END IF<a name='565'>
               END DO<a name='566'>
               IF ( dominant_value .LT. 0.01 ) THEN<a name='567'>
                  iforce = iforce + 1<a name='568'>
                  WRITE ( message , FMT = '(A,I4,I4)' ) &amp;<a name='569'>
                  'based on landuse, changing soil to land at point ',i,j<a name='570'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1088">(1,message)<a name='571'>
                  WRITE ( num_cat_count , FMT = '(I3)' ) num_soil_top_cat<a name='572'>
                  WRITE ( message , FMT = '('//num_cat_count//'(i3,1x))' ) (ints(l),l=1,num_soil_top_cat)<a name='573'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1089">(1,message)<a name='574'>
                  WRITE ( message , FMT = '('//num_cat_count//'(i3,1x))' ) &amp;<a name='575'>
                    ((nint(soil_top_cat(i,ints(l),j)*100)), l=1,num_soil_top_cat)<a name='576'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1090">(1,message)<a name='577'>
                  dominant_index = 8<a name='578'>
               END IF<a name='579'>
            ELSE<a name='580'>
               dominant_index = iswater_soil<a name='581'>
            END IF<a name='582'>
            isltyp(i,j) = dominant_index<a name='583'>
         END DO<a name='584'>
      END DO<a name='585'>
<a name='586'>
if(iforce.ne.0)then<a name='587'>
WRITE(message,FMT='(A,I4,A,I6)' ) &amp;<a name='588'>
'forcing artificial silty clay loam at ',iforce,' points, out of ',&amp;<a name='589'>
(MIN(ide-1,ite)-its+1)*(MIN(jde-1,jte)-jts+1)<a name='590'>
CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1091">(0,message)<a name='591'>
endif<a name='592'>
print *,'LAND  CHANGE = ',change_land<a name='593'>
print *,'WATER CHANGE = ',change_water<a name='594'>
<a name='595'>
   END SUBROUTINE process_percent_cat_new<a name='596'>
<a name='597'>
<A NAME='PROCESS_SOIL_REAL'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='598'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_soil_real</font> ( tsk , tmn , tavgsfc, &amp;,<A href='../../call_from/PROCESS_SOIL_REAL.html' TARGET='index'>33</A><a name='599'>
                                landmask , sst , ht, toposoil, &amp;<a name='600'>
                                st_input , sm_input , sw_input , &amp;<a name='601'>
                                st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='602'>
                                zs , dzs , tslb , smois , sh2o , &amp;<a name='603'>
                                flag_sst , flag_tavgsfc, flag_soilhgt, &amp;<a name='604'>
                                flag_soil_layers, flag_soil_levels, &amp;<a name='605'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='606'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='607'>
                                its , ite , jts , jte , kts , kte , &amp;<a name='608'>
                                sf_surface_physics , num_soil_layers , real_data_init_type , &amp;<a name='609'>
                                num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='610'>
                                num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc )<a name='611'>
<a name='612'>
      IMPLICIT NONE<a name='613'>
<a name='614'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='615'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='616'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='617'>
                              sf_surface_physics , num_soil_layers , real_data_init_type , &amp;<a name='618'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='619'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc<a name='620'>
<a name='621'>
      INTEGER , INTENT(IN) :: flag_sst, flag_tavgsfc<a name='622'>
      INTEGER , INTENT(IN) :: flag_soil_layers, flag_soil_levels, flag_soilhgt<a name='623'>
<a name='624'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='625'>
<a name='626'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='627'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='628'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='629'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='630'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='631'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='632'>
<a name='633'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='634'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='635'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tavgsfc, ht, toposoil<a name='636'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk, tmn<a name='637'>
<a name='638'>
      INTEGER :: i , j , k, l , dominant_index , num_soil_cat , num_veg_cat, closest_layer<a name='639'>
      REAL :: dominant_value, closest_depth, diff_cm<a name='640'>
      REAL , ALLOCATABLE , DIMENSION(:) :: depth     <font color=#447700>! Soil layer thicknesses (cm)<a name='641'></font>
      REAL, PARAMETER :: get_temp_closest_to = 30.   <font color=#447700>! use soil temperature closest to this depth (cm)<a name='642'></font>
      REAL, PARAMETER :: something_big = 1.e6        <font color=#447700>! Initialize closest depth as something big (cm)<a name='643'></font>
      INTEGER :: something_far = 1000                <font color=#447700>! Soil array index far away<a name='644'></font>
      CHARACTER (LEN=132) :: message<a name='645'>
<a name='646'>
      <font color=#447700>!  Case statement for tmn initialization<a name='647'></font>
      <font color=#447700>!  Need to have a reasonable default value for annual mean deeeeep soil temperature<a name='648'></font>
      <font color=#447700>!  For sf_surface_physics = 1, we want to use close to a 30 cm value<a name='649'></font>
      <font color=#447700>!  for the bottom level of the soil temps.<a name='650'></font>
      <font color=#447700>! NOTE:  We are assuming that soil_layers are the same for each grid point<a name='651'></font>
<a name='652'>
      fix_bottom_level_for_temp : SELECT CASE ( sf_surface_physics )<a name='653'>
         CASE (SLABSCHEME)<a name='654'>
            IF ( flag_tavgsfc  .EQ. 1 ) THEN<a name='655'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1092"> ( 0 , 'Using average surface temperature for tmn')<a name='656'>
               DO j = jts , MIN(jde-1,jte)<a name='657'>
                  DO i = its , MIN(ide-1,ite)<a name='658'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='659'>
                     tmn(i,j) = tavgsfc(i,j)<a name='660'>
                  END DO<a name='661'>
               END DO<a name='662'>
            ELSE<a name='663'>
            <font color=#447700>! Look for soil temp close to 30 cm<a name='664'></font>
               closest_layer = something_far<a name='665'>
               closest_depth = something_big<a name='666'>
               DO k = 1, num_st_levels_input<a name='667'>
                  diff_cm = abs( st_levels_input(k) - get_temp_closest_to )<a name='668'>
                  IF ( diff_cm &lt; closest_depth ) THEN<a name='669'>
                     closest_depth = diff_cm<a name='670'>
                     closest_layer = k<a name='671'>
                  END IF<a name='672'>
               END DO<a name='673'>
               IF ( closest_layer == something_far ) THEN<a name='674'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1093"> ( 0 , 'No soil temperature data for grid%tmn near 30 cm')<a name='675'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1094"> ( 0 , 'Using 1 degree static annual mean temps' )<a name='676'>
               ELSE<a name='677'>
                  write(message, FMT='(A,F7.2,A,I3)')&amp;<a name='678'>
                     'Soil temperature closest to ',get_temp_closest_to, &amp;<a name='679'>
                     ' at level ',st_levels_input(closest_layer)<a name='680'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1095"> ( 0 , message )<a name='681'>
                  DO j = jts , MIN(jde-1,jte)<a name='682'>
                     DO i = its , MIN(ide-1,ite)<a name='683'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='684'>
                        tmn(i,j) = st_input(i,closest_layer+1,j)<a name='685'>
                     END DO<a name='686'>
                  END DO<a name='687'>
               END IF<a name='688'>
            END IF<a name='689'>
<a name='690'>
         CASE (LSMSCHEME)<a name='691'>
<a name='692'>
         CASE (NOAHMPSCHEME)<a name='693'>
<a name='694'>
         CASE (CLMSCHEME)<a name='695'>
<a name='696'>
         CASE (RUCLSMSCHEME)<a name='697'>
<a name='698'>
         CASE (PXLSMSCHEME)<a name='699'>
<font color=#447700>! When the input data from met_em is in layers, there is an additional level added to the beginning<a name='700'></font>
<font color=#447700>! of the array to define the surface, which is why we add the extra value (closest_layer+1)<a name='701'></font>
            IF ( flag_tavgsfc  .EQ. 1 ) THEN<a name='702'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1096"> ( 0 , 'Using average surface temperature for tmn')<a name='703'>
               DO j = jts , MIN(jde-1,jte)<a name='704'>
                  DO i = its , MIN(ide-1,ite)<a name='705'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='706'>
                     tmn(i,j) = tavgsfc(i,j)<a name='707'>
                  END DO<a name='708'>
               END DO<a name='709'>
            ELSE<a name='710'>
            <font color=#447700>! Look for soil temp close to 30 cm<a name='711'></font>
               closest_layer = num_st_levels_input+1<a name='712'>
               closest_depth = something_big<a name='713'>
               DO k = 1, num_st_levels_input<a name='714'>
                  diff_cm = abs( st_levels_input(k) - get_temp_closest_to )<a name='715'>
                  IF ( diff_cm &lt; closest_depth ) THEN<a name='716'>
                     closest_depth = diff_cm<a name='717'>
                     closest_layer = k<a name='718'>
                  END IF<a name='719'>
               END DO<a name='720'>
               IF ( closest_layer == num_st_levels_input + 1 ) THEN<a name='721'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1097"> ( 0 , 'No soil temperature data for grid%tmn near 30 cm')<a name='722'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1098"> ( 0 , 'Using 1 degree static annual mean temps' )<a name='723'>
               ELSE<a name='724'>
                  write(message, FMT='(A,F7.2,A,I3)')&amp;<a name='725'>
                     'Soil temperature closest to ',get_temp_closest_to, &amp;<a name='726'>
                     ' at level ',st_levels_input(closest_layer)<a name='727'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1099"> ( 0 , message )<a name='728'>
                  DO j = jts , MIN(jde-1,jte)<a name='729'>
                     DO i = its , MIN(ide-1,ite)<a name='730'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='731'>
                        tmn(i,j) = st_input(i,closest_layer+1,j)<a name='732'>
                     END DO<a name='733'>
                  END DO<a name='734'>
               END IF<a name='735'>
            END IF<a name='736'>
<a name='737'>
#if 0<a name='738'>
            <font color=#447700>! Loop over layers and do a weighted mean<a name='739'></font>
            IF ( ALLOCATED ( depth ) ) DEALLOCATE ( depth )<a name='740'>
            ALLOCATE ( depth(num_st_levels_input) )<a name='741'>
            IF ( flag_soil_layers == 1 ) THEN<a name='742'>
               DO k = num_st_levels_input, 2, -1<a name='743'>
                  depth(k) = st_levels_input(k) - st_levels_input(k-1)<a name='744'>
               END DO<a name='745'>
               depth(1) = st_levels_input(1)<a name='746'>
            ELSE IF ( flag_soil_levels == 1 ) THEN<a name='747'>
               DO k = 2, num_st_levels_input<a name='748'>
                  depth(k) = st_levels_input(k) - st_levels_input(k-1)<a name='749'>
               END DO<a name='750'>
               depth(1) = 0.<a name='751'>
            END IF<a name='752'>
<a name='753'>
            DO j = jts , MIN(jde-1,jte)<a name='754'>
               DO i = its , MIN(ide-1,ite)<a name='755'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='756'>
                  tmn(i,j) = 0.<a name='757'>
                  DO k = 1, num_st_levels_input<a name='758'>
                     tmn(i,j) = tmn(i,j) + depth(k) * st_input(i,k,j)<a name='759'>
                  END DO<a name='760'>
               END DO<a name='761'>
            END DO<a name='762'>
            DEALLOCATE ( depth )<a name='763'>
<a name='764'>
#endif<a name='765'>
<a name='766'>
      END SELECT fix_bottom_level_for_temp<a name='767'>
<a name='768'>
      <font color=#447700>!  Adjust the various soil temperature values depending on the difference in<a name='769'></font>
      <font color=#447700>!  elevation between the current model's elevation and the incoming data's<a name='770'></font>
      <font color=#447700>!  orography.<a name='771'></font>
<a name='772'>
      adjust_soil : SELECT CASE ( sf_surface_physics )<a name='773'>
<a name='774'>
         CASE ( SLABSCHEME,LSMSCHEME,NOAHMPSCHEME,RUCLSMSCHEME,PXLSMSCHEME,CLMSCHEME,SSIBSCHEME )<a name='775'>
            CALL <A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW'>adjust_soil_temp_new</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_SOIL_TEMP_NEW_1"> ( tmn , sf_surface_physics , tsk , ht ,            &amp;<a name='776'>
                                        toposoil , landmask , st_input, st_levels_input, &amp;<a name='777'>
                                        flag_soilhgt , flag_tavgsfc ,                    &amp;<a name='778'>
                                        flag_soil_layers , flag_soil_levels,             &amp;<a name='779'>
                                        num_st_levels_input, num_st_levels_alloc,        &amp;<a name='780'>
                                        ids , ide , jds , jde , kds , kde ,              &amp;<a name='781'>
                                        ims , ime , jms , jme , kms , kme ,              &amp;<a name='782'>
                                        its , ite , jts , jte , kts , kte )<a name='783'>
<a name='784'>
      END SELECT adjust_soil<a name='785'>
<a name='786'>
      <font color=#447700>!  Initialize the soil depth, and the soil temperature and moisture.<a name='787'></font>
   <a name='788'>
      IF      ( ( sf_surface_physics .EQ. SLABSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='789'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1'>init_soil_depth_1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_1_1"> ( zs , dzs , num_soil_layers )<a name='790'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_REAL'>init_soil_1_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_1_REAL_1"> ( tsk , tmn , tslb , zs , dzs , num_soil_layers , real_data_init_type , &amp;<a name='791'>
                                 landmask , sst , flag_sst , &amp;<a name='792'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='793'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='794'>
                                 its , ite , jts , jte , kts , kte )<a name='795'>
<a name='796'>
      ELSE IF ( ( sf_surface_physics .EQ. LSMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='797'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_1"> ( zs , dzs , num_soil_layers )<a name='798'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL'>init_soil_2_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_REAL_1"> ( tsk , tmn , smois , sh2o , tslb , &amp;<a name='799'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='800'>
                                 zs , dzs , &amp;<a name='801'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='802'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='803'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='804'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='805'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='806'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='807'>
                                 its , ite , jts , jte , kts , kte )<a name='808'>
      ELSE IF ( ( sf_surface_physics .EQ. NOAHMPSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='809'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_2"> ( zs , dzs , num_soil_layers )<a name='810'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL'>init_soil_2_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_REAL_2"> ( tsk , tmn , smois , sh2o , tslb , &amp;<a name='811'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='812'>
                                 zs , dzs , &amp;<a name='813'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='814'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='815'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='816'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='817'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='818'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='819'>
                                 its , ite , jts , jte , kts , kte )<a name='820'>
      ELSE IF ( ( sf_surface_physics .EQ. RUCLSMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='821'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3'>init_soil_depth_3</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_3_1"> ( zs , dzs , num_soil_layers )<a name='822'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL'>init_soil_3_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_3_REAL_1"> ( tsk , tmn , smois , tslb , &amp;<a name='823'>
                                 st_input , sm_input , landmask , sst , &amp;<a name='824'>
                                 zs , dzs , &amp;<a name='825'>
                                 st_levels_input , sm_levels_input , &amp;<a name='826'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , &amp;<a name='827'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='828'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='829'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='830'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='831'>
                                 its , ite , jts , jte , kts , kte )<a name='832'>
<font color=#447700>!CLM -- Jiming Jin 10/17/2012<a name='833'></font>
      ELSE IF ( ( sf_surface_physics .EQ. CLMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='834'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_4'>init_soil_depth_4</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_4_1"> ( zs , dzs , num_soil_layers )<a name='835'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL'>init_soil_4_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_4_REAL_1"> ( tsk , tmn , smois , sh2o , tslb , &amp;<a name='836'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='837'>
                                 zs , dzs , &amp;<a name='838'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='839'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='840'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='841'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='842'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='843'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='844'>
                                 its , ite , jts , jte , kts , kte )<a name='845'>
      ELSE IF ( ( sf_surface_physics .EQ. PXLSMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='846'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_7'>init_soil_depth_7</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_7_1"> ( zs , dzs , num_soil_layers )<a name='847'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_7_REAL'>init_soil_7_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_7_REAL_1"> ( tsk , tmn , smois , sh2o, tslb , &amp;<a name='848'>
                                 st_input , sm_input , sw_input, landmask , sst , &amp;<a name='849'>
                                 zs , dzs , &amp;<a name='850'>
                                 st_levels_input , sm_levels_input , sw_levels_input, &amp;<a name='851'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='852'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='853'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='854'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='855'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='856'>
                                 its , ite , jts , jte , kts , kte )<a name='857'>
      ELSE IF ( ( sf_surface_physics .EQ. 8 ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='858'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_8'>init_soil_depth_8</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_8_1"> ( zs , dzs , num_soil_layers )<a name='859'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL'>init_soil_3_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_3_REAL_2"> ( tsk , tmn , smois , tslb , &amp;<a name='860'>
                                 st_input , sm_input , landmask , sst , &amp;<a name='861'>
                                 zs , dzs , &amp;<a name='862'>
                                 st_levels_input , sm_levels_input , &amp;<a name='863'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , &amp;<a name='864'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='865'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='866'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='867'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='868'>
                                 its , ite , jts , jte , kts , kte )<a name='869'>
      END IF<a name='870'>
<a name='871'>
   END SUBROUTINE process_soil_real<a name='872'>
<a name='873'>
<A NAME='PROCESS_SOIL_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='874'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_soil_ideal</font> ( xland,xice,vegfra,snow,canwat,  &amp;,<A href='../../call_from/PROCESS_SOIL_IDEAL.html' TARGET='index'>14</A><a name='875'>
                                   ivgtyp,isltyp,tslb,smois, &amp;<a name='876'>
                                   tsk,tmn,zs,dzs,           &amp;<a name='877'>
                                   num_soil_layers,          &amp;<a name='878'>
                                   sf_surface_physics ,      &amp;<a name='879'>
                                   ids,ide, jds,jde, kds,kde,&amp;<a name='880'>
                                   ims,ime, jms,jme, kms,kme,&amp;<a name='881'>
                                   its,ite, jts,jte, kts,kte )<a name='882'>
<a name='883'>
      IMPLICIT NONE<a name='884'>
<a name='885'>
      INTEGER, INTENT(IN) ::ids,ide, jds,jde, kds,kde,  &amp;<a name='886'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='887'>
                            its,ite, jts,jte, kts,kte<a name='888'>
<a name='889'>
      INTEGER, INTENT(IN) :: num_soil_layers , sf_surface_physics<a name='890'>
<a name='891'>
      REAL, DIMENSION( ims:ime, num_soil_layers, jms:jme ) , INTENT(INOUT) :: smois, tslb<a name='892'>
<a name='893'>
      REAL, DIMENSION(num_soil_layers), INTENT(OUT) :: dzs,zs<a name='894'>
<a name='895'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT) :: tsk, tmn<a name='896'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: xland, snow, canwat, xice, vegfra<a name='897'>
      INTEGER, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: ivgtyp, isltyp<a name='898'>
<a name='899'>
      <font color=#447700>!  Local variables.<a name='900'></font>
<a name='901'>
      INTEGER :: itf,jtf<a name='902'>
<a name='903'>
      itf=MIN(ite,ide-1)<a name='904'>
      jtf=MIN(jte,jde-1)<a name='905'>
<a name='906'>
      IF      ( ( sf_surface_physics .EQ. SLABSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='907'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1'>init_soil_depth_1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_1_2"> ( zs , dzs , num_soil_layers )<a name='908'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_IDEAL'>init_soil_1_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_1_IDEAL_1">(tsk,tmn,tslb,xland,                      &amp;<a name='909'>
                                ivgtyp,zs,dzs,num_soil_layers,           &amp;<a name='910'>
                                ids,ide, jds,jde, kds,kde,               &amp;<a name='911'>
                                ims,ime, jms,jme, kms,kme,               &amp;<a name='912'>
                                its,ite, jts,jte, kts,kte                )<a name='913'>
      ELSE IF ( ( sf_surface_physics .EQ. LSMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='914'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_3"> ( zs , dzs , num_soil_layers )<a name='915'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL'>init_soil_2_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_IDEAL_1"> ( xland,xice,vegfra,snow,canwat,         &amp;<a name='916'>
                                  ivgtyp,isltyp,tslb,smois,tmn,          &amp;<a name='917'>
                                  num_soil_layers,                       &amp;<a name='918'>
                                  ids,ide, jds,jde, kds,kde,             &amp;<a name='919'>
                                  ims,ime, jms,jme, kms,kme,             &amp;<a name='920'>
                                  its,ite, jts,jte, kts,kte              )<a name='921'>
      ELSE IF ( ( sf_surface_physics .EQ. NOAHMPSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='922'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_4"> ( zs , dzs , num_soil_layers )<a name='923'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL'>init_soil_2_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_IDEAL_2"> ( xland,xice,vegfra,snow,canwat,         &amp;<a name='924'>
                                  ivgtyp,isltyp,tslb,smois,tmn,          &amp;<a name='925'>
                                  num_soil_layers,                       &amp;<a name='926'>
                                  ids,ide, jds,jde, kds,kde,             &amp;<a name='927'>
                                  ims,ime, jms,jme, kms,kme,             &amp;<a name='928'>
                                  its,ite, jts,jte, kts,kte              )<a name='929'>
      ELSE IF ( ( sf_surface_physics .EQ. RUCLSMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='930'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3'>init_soil_depth_3</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_3_2"> ( zs , dzs , num_soil_layers )<a name='931'>
<a name='932'>
      END IF<a name='933'>
<a name='934'>
   END SUBROUTINE process_soil_ideal<a name='935'>
<a name='936'>
<A NAME='ADJUST_SOIL_TEMP_NEW'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='937'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_soil_temp_new</font> ( tmn , sf_surface_physics , tsk , ter ,            &amp; <A href='../../call_to/ADJUST_SOIL_TEMP_NEW.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_SOIL_TEMP_NEW.html' TARGET='index'>4</A><a name='938'>
                                     toposoil , landmask , st_input , st_levels_input, &amp;<a name='939'>
                                     flag_toposoil , flag_tavgsfc ,                    &amp;<a name='940'>
                                     flag_soil_layers , flag_soil_levels,              &amp;<a name='941'>
                                     num_st_levels_input, num_st_levels_alloc,         &amp;<a name='942'>
                                     ids , ide , jds , jde , kds , kde ,               &amp;<a name='943'>
                                     ims , ime , jms , jme , kms , kme ,               &amp;<a name='944'>
                                     its , ite , jts , jte , kts , kte )<a name='945'>
<a name='946'>
      IMPLICIT NONE<a name='947'>
<a name='948'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='949'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='950'>
                              its , ite , jts , jte , kts , kte <a name='951'>
      INTEGER , INTENT(IN) :: num_st_levels_input, num_st_levels_alloc<a name='952'>
<a name='953'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN)    :: ter , toposoil , landmask<a name='954'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tmn , tsk<a name='955'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='956'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(IN) :: st_levels_input<a name='957'>
<a name='958'>
      INTEGER , INTENT(IN) :: sf_surface_physics , flag_toposoil , flag_tavgsfc<a name='959'>
      INTEGER , INTENT(IN) :: flag_soil_layers , flag_soil_levels<a name='960'>
 <a name='961'>
      INTEGER :: i , j, k , st_near_sfc<a name='962'>
<a name='963'>
      REAL :: soil_elev_min_val ,  soil_elev_max_val , soil_elev_min_dif , soil_elev_max_dif<a name='964'>
<a name='965'>
      <font color=#447700>!  Adjust the annual mean temperature as if it is based on from a sea-level elevation<a name='966'></font>
      <font color=#447700>!  if the value used is from the actual annula mean data set.  If the input field to<a name='967'></font>
      <font color=#447700>!  be used for tmn is one of the first-guess input temp fields, need to do an adjustment<a name='968'></font>
      <font color=#447700>!  only on the diff in topo from the model terrain and the first-guess terrain.<a name='969'></font>
<a name='970'>
       SELECT CASE ( sf_surface_physics )<a name='971'>
<a name='972'>
         CASE ( LSMSCHEME , NOAHMPSCHEME,CLMSCHEME )<a name='973'>
            DO j = jts , MIN(jde-1,jte)<a name='974'>
               DO i = its , MIN(ide-1,ite)<a name='975'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='976'>
                  IF (landmask(i,j) .GT. 0.5 ) THEN<a name='977'>
                     tmn(i,j) = tmn(i,j) - 0.0065 * ter(i,j)<a name='978'>
                  END IF<a name='979'>
               END DO<a name='980'>
            END DO<a name='981'>
<a name='982'>
         CASE (RUCLSMSCHEME)<a name='983'>
            DO j = jts , MIN(jde-1,jte)<a name='984'>
               DO i = its , MIN(ide-1,ite)<a name='985'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='986'>
                  IF (landmask(i,j) .GT. 0.5 ) THEN<a name='987'>
                     tmn(i,j) = tmn(i,j) - 0.0065 * ter(i,j)<a name='988'>
                  END IF<a name='989'>
               END DO<a name='990'>
            END DO<a name='991'>
<a name='992'>
      END SELECT<a name='993'>
<a name='994'>
<a name='995'>
      <font color=#447700>!  Do we have a soil field with which to modify soil temperatures?<a name='996'></font>
<a name='997'>
      IF ( flag_toposoil .EQ. 1 ) THEN<a name='998'>
<a name='999'>
         DO j = jts , MIN(jde-1,jte)<a name='1000'>
            DO i = its , MIN(ide-1,ite)<a name='1001'>
<a name='1002'>
               IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1003'>
               <font color=#447700>!  Is the toposoil field OK, or is it a subversive soil elevation field.  We can tell<a name='1004'></font>
               <font color=#447700>!  usually by looking at values.  Anything less than -1000 m (lower than the Dead Sea) is<a name='1005'></font>
               <font color=#447700>!  bad.  Anything larger than 10 km (taller than Everest) is toast.  Also, anything where<a name='1006'></font>
               <font color=#447700>!  the difference between the soil elevation and the terrain is greater than 3 km means<a name='1007'></font>
               <font color=#447700>!  that the soil data is either all zeros or that the data are inconsistent.  Any of these<a name='1008'></font>
               <font color=#447700>!  three conditions is grievous enough to induce a WRF fatality.  However, if they are at<a name='1009'></font>
               <font color=#447700>!  a water point, then we can safely ignore them.<a name='1010'></font>
<a name='1011'>
               soil_elev_min_val = toposoil(i,j)<a name='1012'>
               soil_elev_max_val = toposoil(i,j)<a name='1013'>
               soil_elev_min_dif = ter(i,j) - toposoil(i,j)<a name='1014'>
               soil_elev_max_dif = ter(i,j) - toposoil(i,j)<a name='1015'>
<a name='1016'>
               IF      ( ( soil_elev_min_val .LT. -1000 ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='1017'>
                  CYCLE<a name='1018'>
               ELSE IF ( ( soil_elev_min_val .LT. -1000 ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='1019'>
<font color=#447700>!print *,'no soil temperature elevation adjustment, soil height too small = ',toposoil(i,j)<a name='1020'></font>
cycle<a name='1021'>
<font color=#447700>!                 CALL wrf_error_fatal ( 'TOPOSOIL values have large negative values &lt; -1000 m, unrealistic.' )<a name='1022'></font>
               ENDIF<a name='1023'>
<a name='1024'>
               IF      ( ( soil_elev_max_val .GT. 10000 ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='1025'>
                  CYCLE<a name='1026'>
               ELSE IF ( ( soil_elev_max_val .GT. 10000 ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='1027'>
print *,'no soil temperature elevation adjustment, soil height too high = ',toposoil(i,j)<a name='1028'>
cycle<a name='1029'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1433"> ( 'TOPOSOIL values have large positive values &gt; 10,000 m , unrealistic.' )<a name='1030'>
               ENDIF<a name='1031'>
<a name='1032'>
               IF      ( ( ( soil_elev_min_dif .LT. -3000 ) .OR. ( soil_elev_max_dif .GT. 3000 ) ) .AND. &amp;<a name='1033'>
                           ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='1034'>
                  CYCLE<a name='1035'>
               ELSE IF ( ( ( soil_elev_min_dif .LT. -3000 ) .OR. ( soil_elev_max_dif .GT. 3000 ) ) .AND. &amp;<a name='1036'>
                           ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='1037'>
print *,'no soil temperature elevation adjustment, diff of soil height and terrain = ',ter(i,j) - toposoil(i,j)<a name='1038'>
cycle<a name='1039'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1434"> ( 'TOPOSOIL difference with terrain elevation differs by more than 3000 m, unrealistic' )<a name='1040'>
               ENDIF<a name='1041'>
<a name='1042'>
               <font color=#447700>!  For each of the fields that we would like to modify, check to see if it came in from the SI.<a name='1043'></font>
               <font color=#447700>!  If so, then use a -6.5 K/km lapse rate (based on the elevation diffs).  We only adjust when we<a name='1044'></font>
               <font color=#447700>!  are not at a water point.<a name='1045'></font>
<a name='1046'>
               IF (landmask(i,j) .GT. 0.5 ) THEN<a name='1047'>
                  IF ( sf_surface_physics .EQ. SLABSCHEME ) THEN<a name='1048'>
                     st_near_sfc = 0                             <font color=#447700>! Check if there is a soil layer above 40 cm<a name='1049'></font>
                     DO k = 1, num_st_levels_input<a name='1050'>
                        IF ( st_levels_input(k) .LE. 40 ) THEN<a name='1051'>
                           st_near_sfc = 1<a name='1052'>
                        END IF<a name='1053'>
                     END DO<a name='1054'>
                     IF ( ( flag_tavgsfc  == 1 ) .OR. ( st_near_sfc == 1 ) ) THEN<a name='1055'>
                        tmn(i,j) = tmn(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='1056'>
                     ELSE<a name='1057'>
                        tmn(i,j) = tmn(i,j) - 0.0065 * ter(i,j)<a name='1058'>
                     END IF<a name='1059'>
                  END IF<a name='1060'>
<a name='1061'>
                  tsk(i,j) = tsk(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='1062'>
      <a name='1063'>
                  IF ( flag_soil_layers == 1 ) THEN<a name='1064'>
                     DO k = 2, num_st_levels_input+1<a name='1065'>
                        st_input(i,k,j) = st_input(i,k,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='1066'>
                     END DO<a name='1067'>
                  ELSE<a name='1068'>
                     DO k = 1, num_st_levels_input<a name='1069'>
                        st_input(i,k,j) = st_input(i,k,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='1070'>
                     END DO<a name='1071'>
                  END IF<a name='1072'>
<a name='1073'>
               END IF<a name='1074'>
            END DO<a name='1075'>
         END DO<a name='1076'>
<a name='1077'>
      END IF<a name='1078'>
<a name='1079'>
   END SUBROUTINE adjust_soil_temp_new<a name='1080'>
<a name='1081'>
<a name='1082'>
<A NAME='INIT_SOIL_DEPTH_1'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1083'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_1</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_1.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_1.html' TARGET='index'>2</A><a name='1084'>
<a name='1085'>
      IMPLICIT NONE<a name='1086'>
<a name='1087'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='1088'>
<a name='1089'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='1090'>
<a name='1091'>
      INTEGER                   ::      l<a name='1092'>
<a name='1093'>
      <font color=#447700>!  Define layers (top layer = 0.01 m).  Double the thicknesses at each step (dzs values).<a name='1094'></font>
      <font color=#447700>!  The distance from the ground level to the midpoint of the layer is given by zs.<a name='1095'></font>
<a name='1096'>
      <font color=#447700>!    -------   Ground Level   ----------      ||      ||   ||  ||<a name='1097'></font>
      <font color=#447700>!                                             ||      ||   ||  || zs(1) = 0.005 m<a name='1098'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||      ||   ||  \/<a name='1099'></font>
      <font color=#447700>!                                             ||      ||   ||<a name='1100'></font>
      <font color=#447700>!    -----------------------------------      ||  ||  ||   \/   dzs(1) = 0.01 m<a name='1101'></font>
      <font color=#447700>!                                             ||  ||  ||<a name='1102'></font>
      <font color=#447700>!                                             ||  ||  || zs(2) = 0.02<a name='1103'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||  ||  \/<a name='1104'></font>
      <font color=#447700>!                                             ||  ||<a name='1105'></font>
      <font color=#447700>!                                             ||  ||<a name='1106'></font>
      <font color=#447700>!    -----------------------------------  ||  ||  \/   dzs(2) = 0.02 m<a name='1107'></font>
      <font color=#447700>!                                         ||  ||<a name='1108'></font>
      <font color=#447700>!                                         ||  ||<a name='1109'></font>
      <font color=#447700>!                                         ||  ||<a name='1110'></font>
      <font color=#447700>!                                         ||  || zs(3) = 0.05<a name='1111'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --   ||  \/<a name='1112'></font>
      <font color=#447700>!                                         ||<a name='1113'></font>
      <font color=#447700>!                                         ||<a name='1114'></font>
      <font color=#447700>!                                         ||<a name='1115'></font>
      <font color=#447700>!                                         ||<a name='1116'></font>
      <font color=#447700>!    -----------------------------------  \/   dzs(3) = 0.04 m<a name='1117'></font>
<a name='1118'>
      IF ( num_soil_layers .NE. 5 ) THEN<a name='1119'>
         PRINT '(A)','Usually, the 5-layer diffusion uses 5 layers.  Change this in the namelist.'<a name='1120'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1435"> ( '5-layer_diffusion_uses_5_layers' )<a name='1121'>
      END IF<a name='1122'>
<a name='1123'>
      dzs(1)=.01<a name='1124'>
      zs(1)=.5*dzs(1)<a name='1125'>
<a name='1126'>
      DO l=2,num_soil_layers<a name='1127'>
         dzs(l)=2*dzs(l-1)<a name='1128'>
         zs(l)=zs(l-1)+.5*dzs(l-1)+.5*dzs(l)<a name='1129'>
      ENDDO<a name='1130'>
<a name='1131'>
   END SUBROUTINE init_soil_depth_1<a name='1132'>
<a name='1133'>
<A NAME='INIT_SOIL_DEPTH_2'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1134'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_2</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_2.html' TARGET='index'>8</A>,<A href='../../call_from/INIT_SOIL_DEPTH_2.html' TARGET='index'>2</A><a name='1135'>
<a name='1136'>
      IMPLICIT NONE<a name='1137'>
<a name='1138'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='1139'>
<a name='1140'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='1141'>
<a name='1142'>
      INTEGER                   ::      l<a name='1143'>
<a name='1144'>
      dzs = (/ 0.1 , 0.3 , 0.6 , 1.0 /)<a name='1145'>
<a name='1146'>
      IF ( num_soil_layers .NE. 4 ) THEN<a name='1147'>
         PRINT '(A)','Usually, the LSM uses 4 layers.  Change this in the namelist.'<a name='1148'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1436"> ( 'LSM_uses_4_layers' )<a name='1149'>
      END IF<a name='1150'>
<a name='1151'>
      zs(1)=.5*dzs(1)<a name='1152'>
<a name='1153'>
      DO l=2,num_soil_layers<a name='1154'>
         zs(l)=zs(l-1)+.5*dzs(l-1)+.5*dzs(l)<a name='1155'>
      ENDDO<a name='1156'>
<a name='1157'>
   END SUBROUTINE init_soil_depth_2<a name='1158'>
<a name='1159'>
<A NAME='INIT_SOIL_DEPTH_3'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1160'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_3</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_3.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_3.html' TARGET='index'>2</A><a name='1161'>
<a name='1162'>
      IMPLICIT NONE<a name='1163'>
<a name='1164'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='1165'>
<a name='1166'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='1167'>
      REAL, DIMENSION(1:num_soil_layers)               ::  zs2<a name='1168'>
<a name='1169'>
      INTEGER                   ::      l<a name='1170'>
<a name='1171'>
      CHARACTER (LEN=132) :: message<a name='1172'>
<a name='1173'>
<font color=#447700>! in RUC LSM ZS - soil levels, and DZS - soil layer thicknesses, not used<a name='1174'></font>
<font color=#447700>! ZS is specified in the namelist: num_soil_layers = 6 or 9.<a name='1175'></font>
<font color=#447700>! Other options with number of levels are possible, but<a name='1176'></font>
<font color=#447700>! WRF users should change consistently the namelist entry with the<a name='1177'></font>
<font color=#447700>!    ZS array in this subroutine.<a name='1178'></font>
<a name='1179'>
     IF ( num_soil_layers .EQ. 6) THEN<a name='1180'>
      zs  = (/ 0.00 , 0.05 , 0.20 , 0.40 , 1.60 , 3.00 /)<a name='1181'>
     ELSEIF ( num_soil_layers .EQ. 9) THEN<a name='1182'>
      zs  = (/ 0.00 , 0.01 , 0.04 , 0.10 , 0.30, 0.60, 1.00 , 1.60, 3.00 /)<a name='1183'>
<font color=#447700>!     zs  = (/ 0.00 , 0.005 , 0.02 , 0.10 , 0.30, 0.60, 1.00 , 1.60, 3.00 /)<a name='1184'></font>
     ENDIF<a name='1185'>
<a name='1186'>
      zs2(1) = 0.<a name='1187'>
      zs2(2) = (zs(2) + zs(1))*0.5<a name='1188'>
      dzs(1) = zs2(2) - zs2(1)<a name='1189'>
     do l = 2, num_soil_layers - 1<a name='1190'>
      zs2(l) = (zs(l+1) + zs(l)) * 0.5<a name='1191'>
      dzs(l) = zs2(l) - zs2(l-1)<a name='1192'>
     enddo<a name='1193'>
      zs2(num_soil_layers) = zs(num_soil_layers)<a name='1194'>
      dzs(num_soil_layers) = zs2(num_soil_layers) - zs2(num_soil_layers-1)<a name='1195'>
<a name='1196'>
      IF ( num_soil_layers .EQ. 4 .OR. num_soil_layers .EQ. 5 ) THEN<a name='1197'>
         write (message, FMT='(A)') 'The RUC LSM uses 6, 9 or more levels.  Change this in the namelist.'<a name='1198'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1437"> ( message )<a name='1199'>
      END IF<a name='1200'>
<a name='1201'>
   END SUBROUTINE init_soil_depth_3<a name='1202'>
<a name='1203'>
<A NAME='INIT_SOIL_DEPTH_4'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_4' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1204'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_4</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_4.html' TARGET='index'>2</A><a name='1205'>
<a name='1206'>
      IMPLICIT NONE<a name='1207'>
<a name='1208'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='1209'>
<a name='1210'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='1211'>
      REAL, PARAMETER :: scalez = 0.025<a name='1212'>
<a name='1213'>
      INTEGER                   ::      l<a name='1214'>
<a name='1215'>
      <font color=#447700>!  Define layers (top layer = 0.01 m).  Double the thicknesses at each<a name='1216'></font>
      <font color=#447700>!  step (dzs values).<a name='1217'></font>
      <font color=#447700>!  The distance from the ground level to the midpoint of the layer is<a name='1218'></font>
      <font color=#447700>!  given by zs.<a name='1219'></font>
<a name='1220'>
      <font color=#447700>!    -------   Ground Level   ----------      ||      ||   ||  ||<a name='1221'></font>
      <font color=#447700>!                                             ||      ||   ||  || zs(1) =<a name='1222'></font>
      <font color=#447700>!                                             0.005 m<a name='1223'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||      ||   ||  \/<a name='1224'></font>
      <font color=#447700>!                                             ||      ||   ||<a name='1225'></font>
      <font color=#447700>!    -----------------------------------      ||  ||  ||   \/   dzs(1) =<a name='1226'></font>
      <font color=#447700>!    0.01 m<a name='1227'></font>
      <font color=#447700>!                                             ||  ||  ||<a name='1228'></font>
      <font color=#447700>!                                             ||  ||  || zs(2) = 0.02<a name='1229'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||  ||  \/<a name='1230'></font>
      <font color=#447700>!                                             ||  ||<a name='1231'></font>
      <font color=#447700>!                                             ||  ||<a name='1232'></font>
      <font color=#447700>!    -----------------------------------  ||  ||  \/   dzs(2) = 0.02 m<a name='1233'></font>
      <font color=#447700>!                                         ||  ||<a name='1234'></font>
      <font color=#447700>!                                         ||  ||<a name='1235'></font>
      <font color=#447700>!                                         ||  ||<a name='1236'></font>
      <font color=#447700>!                                         ||  || zs(3) = 0.05<a name='1237'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --   ||  \/<a name='1238'></font>
      <font color=#447700>!                                         ||<a name='1239'></font>
      <font color=#447700>!                                         ||<a name='1240'></font>
      <font color=#447700>!                                         ||<a name='1241'></font>
      <font color=#447700>!                                         ||<a name='1242'></font>
      <font color=#447700>!    -----------------------------------  \/   dzs(3) = 0.04 m<a name='1243'></font>
<a name='1244'>
      do l = 1, num_soil_layers<a name='1245'>
         zs(l) = scalez*(exp(0.5*(l-0.5))-1.)    <font color=#447700>!node depths<a name='1246'></font>
      enddo<a name='1247'>
       dzs(1) = 0.5*(zs(1)+zs(2))             <font color=#447700>!thickness b/n two interfaces<a name='1248'></font>
       do l = 2,num_soil_layers-1<a name='1249'>
         dzs(l)= 0.5*(zs(l+1)-zs(l-1))<a name='1250'>
       enddo<a name='1251'>
       dzs(num_soil_layers) = zs(num_soil_layers)-zs(num_soil_layers-1)<a name='1252'>
<a name='1253'>
   END SUBROUTINE init_soil_depth_4<a name='1254'>
<a name='1255'>
<A NAME='INIT_SOIL_DEPTH_7'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_7' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1256'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_7</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_7.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_SOIL_DEPTH_7.html' TARGET='index'>1</A><a name='1257'>
<a name='1258'>
      IMPLICIT NONE<a name='1259'>
<a name='1260'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='1261'>
<a name='1262'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='1263'>
<a name='1264'>
      INTEGER                   ::      l<a name='1265'>
<a name='1266'>
      dzs = (/ 0.01 , 0.99 /)<a name='1267'>
<a name='1268'>
      IF ( num_soil_layers .NE. 2 ) THEN<a name='1269'>
         PRINT '(A)','Usually, the PX LSM uses 2 layers.  Change this in the namelist.'<a name='1270'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_7' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1438"> ( 'PXLSM_uses_2_layers' )<a name='1271'>
      END IF<a name='1272'>
<a name='1273'>
      zs(1) = 0.5 * dzs(1)<a name='1274'>
      zs(2) = dzs(1) + 0.5 * dzs(2)<a name='1275'>
<a name='1276'>
   END SUBROUTINE init_soil_depth_7<a name='1277'>
<a name='1278'>
<A NAME='INIT_SOIL_DEPTH_8'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_8' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1279'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_8</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_8.html' TARGET='index'>1</A><a name='1280'>
<a name='1281'>
      IMPLICIT NONE<a name='1282'>
<a name='1283'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='1284'>
<a name='1285'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='1286'>
<a name='1287'>
      INTEGER                   ::      l<a name='1288'>
<a name='1289'>
      zs(1) = 0.00<a name='1290'>
      zs(2) = 0.05<a name='1291'>
      zs(3) = 1.05<a name='1292'>
<a name='1293'>
   END SUBROUTINE init_soil_depth_8<a name='1294'>
<a name='1295'>
<A NAME='INIT_SOIL_1_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1296'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_1_real</font> ( tsk , tmn , tslb , zs , dzs , &amp; <A href='../../call_to/INIT_SOIL_1_REAL.html' TARGET='index'>2</A><a name='1297'>
                                 num_soil_layers , real_data_init_type , &amp;<a name='1298'>
                                 landmask , sst , flag_sst , &amp;<a name='1299'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='1300'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='1301'>
                                 its , ite , jts , jte , kts , kte )<a name='1302'>
<a name='1303'>
      IMPLICIT NONE<a name='1304'>
<a name='1305'>
      INTEGER , INTENT(IN) :: num_soil_layers , real_data_init_type , &amp;<a name='1306'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='1307'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1308'>
                              its , ite , jts , jte , kts , kte<a name='1309'>
<a name='1310'>
      INTEGER , INTENT(IN) :: flag_sst<a name='1311'>
<a name='1312'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='1313'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tsk , tmn<a name='1314'>
<a name='1315'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='1316'>
<a name='1317'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb<a name='1318'>
<a name='1319'>
      INTEGER :: i , j , l<a name='1320'>
<a name='1321'>
      <font color=#447700>!  Soil temperature is linearly interpolated between the skin temperature (taken to be at a<a name='1322'></font>
      <font color=#447700>!  depth of 0.5 cm) and the deep soil, annual temperature (taken to be at a depth of 23 cm).<a name='1323'></font>
      <font color=#447700>!  The tslb(i,1,j) is the skin temperature, and the tslb(i,num_soil_layers,j) level is the<a name='1324'></font>
      <font color=#447700>!  annual mean temperature.<a name='1325'></font>
<a name='1326'>
      DO j = jts , MIN(jde-1,jte)<a name='1327'>
         DO i = its , MIN(ide-1,ite)<a name='1328'>
            IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1329'>
            IF ( landmask(i,j) .GT. 0.5 ) THEN<a name='1330'>
               DO l = 1 , num_soil_layers<a name='1331'>
                  tslb(i,l,j)= ( tsk(i,j) * ( zs(num_soil_layers) - zs(l) )   + &amp;<a name='1332'>
                                 tmn(i,j) * ( zs(              l) - zs(1) ) ) / &amp;<a name='1333'>
                                            ( zs(num_soil_layers) - zs(1) )<a name='1334'>
               END DO<a name='1335'>
            ELSE<a name='1336'>
               IF ( ( real_data_init_type .EQ. 1 ) .AND. ( flag_sst .EQ. 1 ) ) THEN<a name='1337'>
                  DO l = 1 , num_soil_layers<a name='1338'>
                     tslb(i,l,j)= sst(i,j)<a name='1339'>
                  END DO<a name='1340'>
               ELSE<a name='1341'>
                  DO l = 1 , num_soil_layers<a name='1342'>
                     tslb(i,l,j)= tsk(i,j)<a name='1343'>
                  END DO<a name='1344'>
               END IF<a name='1345'>
            END IF<a name='1346'>
         END DO<a name='1347'>
      END DO<a name='1348'>
<a name='1349'>
   END SUBROUTINE init_soil_1_real<a name='1350'>
<a name='1351'>
<A NAME='INIT_SOIL_1_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1352'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_1_ideal</font>(tsk,tmn,tslb,xland,             &amp; <A href='../../call_to/INIT_SOIL_1_IDEAL.html' TARGET='index'>2</A><a name='1353'>
                       ivgtyp,ZS,DZS,num_soil_layers,           &amp;<a name='1354'>
                       ids,ide, jds,jde, kds,kde,               &amp;<a name='1355'>
                       ims,ime, jms,jme, kms,kme,               &amp;<a name='1356'>
                       its,ite, jts,jte, kts,kte                )<a name='1357'>
<a name='1358'>
      IMPLICIT NONE<a name='1359'>
<a name='1360'>
      INTEGER, INTENT(IN   )    ::      ids,ide, jds,jde, kds,kde, &amp;<a name='1361'>
                                        ims,ime, jms,jme, kms,kme, &amp;<a name='1362'>
                                        its,ite, jts,jte, kts,kte<a name='1363'>
<a name='1364'>
      INTEGER, INTENT(IN   )    ::      num_soil_layers<a name='1365'>
<a name='1366'>
      REAL, DIMENSION( ims:ime , num_soil_layers , jms:jme ), INTENT(OUT) :: tslb<a name='1367'>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(OUT) :: xland<a name='1368'>
      INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(OUT) :: ivgtyp<a name='1369'>
<a name='1370'>
      REAL, DIMENSION(1:), INTENT(IN) :: dzs,zs<a name='1371'>
<a name='1372'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(IN) :: tsk, tmn<a name='1373'>
<a name='1374'>
      <font color=#447700>!  Lcal variables.<a name='1375'></font>
<a name='1376'>
      INTEGER :: l,j,i,itf,jtf<a name='1377'>
<a name='1378'>
      itf=MIN(ite,ide-1)<a name='1379'>
      jtf=MIN(jte,jde-1)<a name='1380'>
<a name='1381'>
      IF (num_soil_layers.NE.1)THEN<a name='1382'>
         DO j=jts,jtf<a name='1383'>
            DO l=1,num_soil_layers<a name='1384'>
               DO i=its,itf<a name='1385'>
                 tslb(i,l,j)=( tsk(i,j)*(zs(num_soil_layers)-zs(l)) + tmn(i,j)*(zs(l)-zs(1)) ) / &amp;<a name='1386'>
                             ( zs(num_soil_layers)-zs(1) )<a name='1387'>
               ENDDO<a name='1388'>
            ENDDO<a name='1389'>
         ENDDO<a name='1390'>
      ENDIF<a name='1391'>
<a name='1392'>
<font color=#447700>!     DO j=jts,jtf<a name='1393'></font>
<font color=#447700>!        DO i=its,itf<a name='1394'></font>
<font color=#447700>!          xland(i,j)  = 2<a name='1395'></font>
<font color=#447700>!          ivgtyp(i,j) = 7<a name='1396'></font>
<font color=#447700>!        ENDDO<a name='1397'></font>
<font color=#447700>!     ENDDO<a name='1398'></font>
<a name='1399'>
   END SUBROUTINE init_soil_1_ideal<a name='1400'>
<a name='1401'>
<A NAME='INIT_SOIL_2_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1402'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_2_real</font> ( tsk , tmn , smois , sh2o , tslb , &amp; <A href='../../call_to/INIT_SOIL_2_REAL.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_2_REAL.html' TARGET='index'>6</A><a name='1403'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='1404'>
                                 zs , dzs , &amp;<a name='1405'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='1406'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  num_sw_levels_input , &amp;<a name='1407'>
                                 num_st_levels_alloc , num_sm_levels_alloc ,  num_sw_levels_alloc , &amp;<a name='1408'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='1409'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='1410'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='1411'>
                                 its , ite , jts , jte , kts , kte )<a name='1412'>
<a name='1413'>
      IMPLICIT NONE<a name='1414'>
<a name='1415'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='1416'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='1417'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='1418'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='1419'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1420'>
                              its , ite , jts , jte , kts , kte<a name='1421'>
<a name='1422'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soil_layers, flag_soil_levels<a name='1423'>
<a name='1424'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='1425'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='1426'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='1427'>
<a name='1428'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='1429'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='1430'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='1431'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='1432'>
<a name='1433'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='1434'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='1435'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='1436'>
<a name='1437'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='1438'>
<a name='1439'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='1440'>
<a name='1441'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave , num<a name='1442'>
      REAL :: temp<a name='1443'>
      LOGICAL :: found_levels<a name='1444'>
<a name='1445'>
      CHARACTER (LEN=132) :: message<a name='1446'>
<a name='1447'>
      <font color=#447700>!  Are there any soil temp and moisture levels - ya know, they are mandatory.<a name='1448'></font>
<a name='1449'>
      num = num_st_levels_input * num_sm_levels_input<a name='1450'>
<a name='1451'>
      IF ( num .GE. 1 ) THEN<a name='1452'>
<a name='1453'>
         <font color=#447700>!  Ordered levels that we have data for.<a name='1454'></font>
<a name='1455'>
<font color=#447700>!tgs add option to initialize from RUCLSM<a name='1456'></font>
         IF ( flag_soil_levels == 1 ) THEN<a name='1457'>
           write(message, FMT='(A)') ' Assume RUC LSM 6-level input'<a name='1458'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1367"> ( message )<a name='1459'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input)  ) )<a name='1460'>
         ELSE<a name='1461'>
           write(message, FMT='(A)') ' Assume Noah LSM input'<a name='1462'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1368"> ( message )<a name='1463'>
         ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input) +2) )<a name='1464'>
         END IF<a name='1465'>
<a name='1466'>
<a name='1467'>
         <font color=#447700>!  Sort the levels for temperature.<a name='1468'></font>
<a name='1469'>
         outert : DO lout = 1 , num_st_levels_input-1<a name='1470'>
            innert : DO lin = lout+1 , num_st_levels_input<a name='1471'>
               IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='1472'>
                  temp = st_levels_input(lout)<a name='1473'>
                  st_levels_input(lout) = st_levels_input(lin)<a name='1474'>
                  st_levels_input(lin) = NINT(temp)<a name='1475'>
                  DO j = jts , MIN(jde-1,jte)<a name='1476'>
                     DO i = its , MIN(ide-1,ite)<a name='1477'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1478'>
                        temp = st_input(i,lout+1,j)<a name='1479'>
                        st_input(i,lout+1,j) = st_input(i,lin+1,j)<a name='1480'>
                        st_input(i,lin+1,j) = temp<a name='1481'>
                     END DO<a name='1482'>
                  END DO<a name='1483'>
               END IF<a name='1484'>
            END DO innert<a name='1485'>
         END DO outert<a name='1486'>
<font color=#447700>!tgs add IF<a name='1487'></font>
      IF ( flag_soil_layers == 1 ) THEN<a name='1488'>
         DO j = jts , MIN(jde-1,jte)<a name='1489'>
            DO i = its , MIN(ide-1,ite)<a name='1490'>
               IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1491'>
               st_input(i,1,j) = tsk(i,j)<a name='1492'>
               st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='1493'>
            END DO<a name='1494'>
         END DO<a name='1495'>
      ENDIF<a name='1496'>
<a name='1497'>
         <font color=#447700>!  Sort the levels for moisture.<a name='1498'></font>
<a name='1499'>
         outerm: DO lout = 1 , num_sm_levels_input-1<a name='1500'>
            innerm : DO lin = lout+1 , num_sm_levels_input<a name='1501'>
               IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='1502'>
                  temp = sm_levels_input(lout)<a name='1503'>
                  sm_levels_input(lout) = sm_levels_input(lin)<a name='1504'>
                  sm_levels_input(lin) = NINT(temp)<a name='1505'>
                  DO j = jts , MIN(jde-1,jte)<a name='1506'>
                     DO i = its , MIN(ide-1,ite)<a name='1507'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1508'>
                        temp = sm_input(i,lout+1,j)<a name='1509'>
                        sm_input(i,lout+1,j) = sm_input(i,lin+1,j)<a name='1510'>
                        sm_input(i,lin+1,j) = temp<a name='1511'>
                     END DO<a name='1512'>
                  END DO<a name='1513'>
               END IF<a name='1514'>
            END DO innerm<a name='1515'>
         END DO outerm<a name='1516'>
<font color=#447700>!tgs add IF<a name='1517'></font>
      IF ( flag_soil_layers == 1 ) THEN<a name='1518'>
         DO j = jts , MIN(jde-1,jte)<a name='1519'>
            DO i = its , MIN(ide-1,ite)<a name='1520'>
               IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1521'>
               sm_input(i,1,j) = sm_input(i,2,j)<a name='1522'>
               sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='1523'>
            END DO<a name='1524'>
         END DO<a name='1525'>
      ENDIF<a name='1526'>
<a name='1527'>
         <font color=#447700>!  Sort the levels for liquid moisture.<a name='1528'></font>
<a name='1529'>
         outerw: DO lout = 1 , num_sw_levels_input-1<a name='1530'>
            innerw : DO lin = lout+1 , num_sw_levels_input<a name='1531'>
               IF ( sw_levels_input(lout) .GT. sw_levels_input(lin) ) THEN<a name='1532'>
                  temp = sw_levels_input(lout)<a name='1533'>
                  sw_levels_input(lout) = sw_levels_input(lin)<a name='1534'>
                  sw_levels_input(lin) = NINT(temp)<a name='1535'>
                  DO j = jts , MIN(jde-1,jte)<a name='1536'>
                     DO i = its , MIN(ide-1,ite)<a name='1537'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1538'>
                        temp = sw_input(i,lout+1,j)<a name='1539'>
                        sw_input(i,lout+1,j) = sw_input(i,lin+1,j)<a name='1540'>
                        sw_input(i,lin+1,j) = temp<a name='1541'>
                     END DO<a name='1542'>
                  END DO<a name='1543'>
               END IF<a name='1544'>
            END DO innerw<a name='1545'>
         END DO outerw<a name='1546'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='1547'>
            DO j = jts , MIN(jde-1,jte)<a name='1548'>
               DO i = its , MIN(ide-1,ite)<a name='1549'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1550'>
                  sw_input(i,1,j) = sw_input(i,2,j)<a name='1551'>
                  sw_input(i,num_sw_levels_input+2,j) = sw_input(i,num_sw_levels_input+1,j)<a name='1552'>
               END DO<a name='1553'>
            END DO<a name='1554'>
         END IF<a name='1555'>
<a name='1556'>
         found_levels = .TRUE.<a name='1557'>
<a name='1558'>
      ELSE IF ( ( num .LE. 0 ) .AND. (  start_date .NE. current_date ) ) THEN<a name='1559'>
<a name='1560'>
         found_levels = .FALSE.<a name='1561'>
<a name='1562'>
      ELSE<a name='1563'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1439"> ( &amp;<a name='1564'>
         'No input soil level data (temperature, moisture or liquid, or all are missing). Required for LSM.' )<a name='1565'>
      END IF<a name='1566'>
<a name='1567'>
      <font color=#447700>!  Is it OK to continue?<a name='1568'></font>
<a name='1569'>
      IF ( found_levels ) THEN<a name='1570'>
<a name='1571'>
         <font color=#447700>!tgs:  Here are the levels that we have from the input for temperature.<a name='1572'></font>
<a name='1573'>
         IF ( flag_soil_levels == 1 ) THEN<a name='1574'>
            DO l = 1 , num_st_levels_input<a name='1575'>
               zhave(l) = st_levels_input(l) / 100.<a name='1576'>
            END DO<a name='1577'>
<a name='1578'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1579'></font>
<a name='1580'>
         z_wantt : DO lwant = 1 , num_soil_layers<a name='1581'>
            z_havet : DO lhave = 1 , num_st_levels_input -1<a name='1582'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1583'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1584'>
                  DO j = jts , MIN(jde-1,jte)<a name='1585'>
                     DO i = its , MIN(ide-1,ite)<a name='1586'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1587'>
                        tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1588'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1589'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='1590'>
                     END DO<a name='1591'>
                  END DO<a name='1592'>
                  EXIT z_havet<a name='1593'>
               END IF<a name='1594'>
            END DO z_havet<a name='1595'>
         END DO z_wantt<a name='1596'>
<a name='1597'>
         ELSE<a name='1598'>
<a name='1599'>
         <font color=#447700>!  Here are the levels that we have from the input for temperature.  The input levels plus<a name='1600'></font>
         <font color=#447700>!  two more: the skin temperature at 0 cm, and the annual mean temperature at 300 cm.<a name='1601'></font>
<a name='1602'>
         zhave(1) = 0.<a name='1603'>
         DO l = 1 , num_st_levels_input<a name='1604'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='1605'>
         END DO<a name='1606'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='1607'>
<a name='1608'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1609'></font>
<a name='1610'>
         z_wantt_2: DO lwant = 1 , num_soil_layers<a name='1611'>
            z_havet_2 : DO lhave = 1 , num_st_levels_input +2 -1<a name='1612'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1613'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1614'>
                  DO j = jts , MIN(jde-1,jte)<a name='1615'>
                     DO i = its , MIN(ide-1,ite)<a name='1616'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1617'>
                        tslb(i,lwant,j)= ( st_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1618'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1619'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='1620'>
                     END DO<a name='1621'>
                  END DO<a name='1622'>
                  EXIT z_havet_2<a name='1623'>
               END IF<a name='1624'>
            END DO z_havet_2<a name='1625'>
         END DO z_wantt_2<a name='1626'>
<a name='1627'>
      END IF<a name='1628'>
<a name='1629'>
<font color=#447700>!tgs:<a name='1630'></font>
      IF ( flag_soil_levels == 1 ) THEN<a name='1631'>
         DO l = 1 , num_sm_levels_input<a name='1632'>
            zhave(l) = sm_levels_input(l) / 100.<a name='1633'>
         END DO<a name='1634'>
<a name='1635'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1636'></font>
<a name='1637'>
      z_wantm : DO lwant = 1 , num_soil_layers<a name='1638'>
         z_havem : DO lhave = 1 , num_sm_levels_input -1<a name='1639'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1640'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1641'>
               DO j = jts , MIN(jde-1,jte)<a name='1642'>
                  DO i = its , MIN(ide-1,ite)<a name='1643'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1644'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1645'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1646'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='1647'>
                  END DO<a name='1648'>
               END DO<a name='1649'>
               EXIT z_havem<a name='1650'>
            END IF<a name='1651'>
         END DO z_havem<a name='1652'>
      END DO z_wantm<a name='1653'>
<a name='1654'>
      ELSE<a name='1655'>
         <font color=#447700>!  Here are the levels that we have from the input for moisture.  The input levels plus<a name='1656'></font>
         <font color=#447700>!  two more: a value at 0 cm and one at 300 cm.  The 0 cm value is taken to be identical<a name='1657'></font>
         <font color=#447700>!  to the most shallow layer's value.  Similarly, the 300 cm value is taken to be the same<a name='1658'></font>
         <font color=#447700>!  as the most deep layer's value.<a name='1659'></font>
<a name='1660'>
         zhave(1) = 0.<a name='1661'>
         DO l = 1 , num_sm_levels_input<a name='1662'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='1663'>
         END DO<a name='1664'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='1665'>
<a name='1666'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1667'></font>
<a name='1668'>
         z_wantm_2 : DO lwant = 1 , num_soil_layers<a name='1669'>
            z_havem_2 : DO lhave = 1 , num_sm_levels_input +2 -1<a name='1670'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1671'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1672'>
                  DO j = jts , MIN(jde-1,jte)<a name='1673'>
                     DO i = its , MIN(ide-1,ite)<a name='1674'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1675'>
                        smois(i,lwant,j)= ( sm_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1676'>
                                            sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1677'>
                                                                    ( zhave(lhave+1) - zhave(lhave) )<a name='1678'>
                     END DO<a name='1679'>
                  END DO<a name='1680'>
                  EXIT z_havem_2<a name='1681'>
               END IF<a name='1682'>
            END DO z_havem_2<a name='1683'>
         END DO z_wantm_2<a name='1684'>
       ENDIF<a name='1685'>
<a name='1686'>
         <font color=#447700>!  Any liquid soil moisture to worry about?<a name='1687'></font>
<a name='1688'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='1689'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want<a name='1690'></font>
      <font color=#447700>!  (zs).<a name='1691'></font>
      IF ( flag_soil_levels == 1 ) THEN<a name='1692'>
<font color=#447700>!tgs: for RUC LSM<a name='1693'></font>
      z_wantw : DO lwant = 1 , num_soil_layers<a name='1694'>
         z_havew : DO lhave = 1 , num_sw_levels_input -1<a name='1695'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1696'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1697'>
               DO j = jts , MIN(jde-1,jte)<a name='1698'>
                  DO i = its , MIN(ide-1,ite)<a name='1699'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE<a name='1700'>
                     sh2o(i,lwant,j)= ( sw_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1701'>
                                         sw_input(i,lhave+1,j) * ( zs   (lwant) - zhave(lhave) ) ) / &amp;<a name='1702'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='1703'>
                  END DO<a name='1704'>
               END DO<a name='1705'>
               EXIT z_havew<a name='1706'>
            END IF<a name='1707'>
         END DO z_havew<a name='1708'>
      END DO z_wantw<a name='1709'>
<a name='1710'>
     ELSE<a name='1711'>
            zhave(1) = 0.<a name='1712'>
            DO l = 1 , num_sw_levels_input<a name='1713'>
               zhave(l+1) = sw_levels_input(l) / 100.<a name='1714'>
            END DO<a name='1715'>
            zhave(num_sw_levels_input+2) = 300. / 100.<a name='1716'>
<a name='1717'>
            <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1718'></font>
<a name='1719'>
            z_wantw_2 : DO lwant = 1 , num_soil_layers<a name='1720'>
               z_havew_2 : DO lhave = 1 , num_sw_levels_input +2 -1<a name='1721'>
                  IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1722'>
                       ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1723'>
                     DO j = jts , MIN(jde-1,jte)<a name='1724'>
                        DO i = its , MIN(ide-1,ite)<a name='1725'>
                           IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE<a name='1726'>
                           sh2o(i,lwant,j)= ( sw_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1727'>
                                               sw_input(i,lhave+1,j) * ( zs (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1728'>
                                                                       ( zhave(lhave+1) - zhave(lhave) )<a name='1729'>
                        END DO<a name='1730'>
                     END DO<a name='1731'>
                     EXIT z_havew_2<a name='1732'>
                  END IF<a name='1733'>
               END DO z_havew_2<a name='1734'>
            END DO z_wantw_2<a name='1735'>
       ENDIF<a name='1736'>
<a name='1737'>
         END IF<a name='1738'>
<a name='1739'>
<a name='1740'>
         <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='1741'></font>
         <font color=#447700>!  used, but they will make a more continuous plot.<a name='1742'></font>
<a name='1743'>
         IF ( flag_sst .EQ. 1 ) THEN<a name='1744'>
            DO j = jts , MIN(jde-1,jte)<a name='1745'>
               DO i = its , MIN(ide-1,ite)<a name='1746'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1747'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='1748'>
                     DO l = 1 , num_soil_layers<a name='1749'>
                        tslb(i,l,j)= sst(i,j)<a name='1750'>
                        smois(i,l,j)= 1.0<a name='1751'>
                        sh2o (i,l,j)= 1.0<a name='1752'>
                     END DO<a name='1753'>
                  END IF<a name='1754'>
               END DO<a name='1755'>
            END DO<a name='1756'>
         ELSE<a name='1757'>
            DO j = jts , MIN(jde-1,jte)<a name='1758'>
               DO i = its , MIN(ide-1,ite)<a name='1759'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1760'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='1761'>
                     DO l = 1 , num_soil_layers<a name='1762'>
                        tslb(i,l,j)= tsk(i,j)<a name='1763'>
                        smois(i,l,j)= 1.0<a name='1764'>
                        sh2o (i,l,j)= 1.0<a name='1765'>
                     END DO<a name='1766'>
                  END IF<a name='1767'>
               END DO<a name='1768'>
            END DO<a name='1769'>
         END IF<a name='1770'>
<a name='1771'>
         DEALLOCATE (zhave)<a name='1772'>
<a name='1773'>
      END IF<a name='1774'>
<a name='1775'>
   END SUBROUTINE init_soil_2_real<a name='1776'>
<a name='1777'>
<A NAME='INIT_SOIL_2_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1778'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_2_ideal</font> ( xland,xice,vegfra,snow,canwat,     &amp; <A href='../../call_to/INIT_SOIL_2_IDEAL.html' TARGET='index'>4</A><a name='1779'>
                     ivgtyp,isltyp,tslb,smois,tmn,                  &amp;<a name='1780'>
                     num_soil_layers,                               &amp;<a name='1781'>
                     ids,ide, jds,jde, kds,kde,                     &amp;<a name='1782'>
                     ims,ime, jms,jme, kms,kme,                     &amp;<a name='1783'>
                     its,ite, jts,jte, kts,kte                      )<a name='1784'>
<a name='1785'>
      IMPLICIT NONE<a name='1786'>
<a name='1787'>
      INTEGER, INTENT(IN) ::ids,ide, jds,jde, kds,kde,  &amp;<a name='1788'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='1789'>
                            its,ite, jts,jte, kts,kte<a name='1790'>
<a name='1791'>
      INTEGER, INTENT(IN) ::num_soil_layers<a name='1792'>
<a name='1793'>
      REAL, DIMENSION( ims:ime, num_soil_layers, jms:jme ) , INTENT(OUT) :: smois, tslb<a name='1794'>
<a name='1795'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(IN)   :: xland<a name='1796'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT)  :: snow, canwat, xice, vegfra, tmn<a name='1797'>
<a name='1798'>
      INTEGER, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: ivgtyp, isltyp<a name='1799'>
<a name='1800'>
      INTEGER :: icm,jcm,itf,jtf<a name='1801'>
      INTEGER ::  i,j,l<a name='1802'>
<a name='1803'>
      itf=min0(ite,ide-1)<a name='1804'>
      jtf=min0(jte,jde-1)<a name='1805'>
<a name='1806'>
      icm = ide/2<a name='1807'>
      jcm = jde/2<a name='1808'>
<a name='1809'>
      DO j=jts,jtf<a name='1810'>
         DO l=1,num_soil_layers<a name='1811'>
            DO i=its,itf<a name='1812'>
               if (xland(i,j) .lt. 1.5) then<a name='1813'>
               smois(i,1,j)=0.30<a name='1814'>
               smois(i,2,j)=0.30<a name='1815'>
               smois(i,3,j)=0.30<a name='1816'>
               smois(i,4,j)=0.30<a name='1817'>
<a name='1818'>
               tslb(i,1,j)=290.<a name='1819'>
               tslb(i,2,j)=290.<a name='1820'>
               tslb(i,3,j)=290.<a name='1821'>
               tslb(i,4,j)=290.<a name='1822'>
               endif<a name='1823'>
            ENDDO<a name='1824'>
         ENDDO<a name='1825'>
      ENDDO<a name='1826'>
<a name='1827'>
   END SUBROUTINE init_soil_2_ideal<a name='1828'>
<a name='1829'>
<A NAME='INIT_SOIL_3_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1830'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_3_real</font> ( tsk , tmn , smois , tslb , &amp; <A href='../../call_to/INIT_SOIL_3_REAL.html' TARGET='index'>3</A>,<A href='../../call_from/INIT_SOIL_3_REAL.html' TARGET='index'>6</A><a name='1831'>
                                 st_input , sm_input , landmask, sst, &amp;<a name='1832'>
                                 zs , dzs , &amp;<a name='1833'>
                                 st_levels_input , sm_levels_input , &amp;<a name='1834'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  &amp;<a name='1835'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='1836'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='1837'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='1838'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='1839'>
                                 its , ite , jts , jte , kts , kte )<a name='1840'>
<a name='1841'>
      IMPLICIT NONE<a name='1842'>
<a name='1843'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='1844'>
                              num_st_levels_input , num_sm_levels_input , &amp;<a name='1845'>
                              num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='1846'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='1847'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1848'>
                              its , ite , jts , jte , kts , kte<a name='1849'>
<a name='1850'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soil_layers, flag_soil_levels<a name='1851'>
<a name='1852'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='1853'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='1854'>
<a name='1855'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='1856'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='1857'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='1858'>
<a name='1859'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='1860'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='1861'>
      REAL , DIMENSION(ims:ime,jms:jme) :: smtotn, smtotr, smtotn_1m, smtotr_1m<a name='1862'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs, factorsm<a name='1863'>
<a name='1864'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois<a name='1865'>
<a name='1866'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='1867'>
<a name='1868'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave, k<a name='1869'>
      REAL :: temp<a name='1870'>
<a name='1871'>
      CHARACTER (LEN=132) :: message<a name='1872'>
<a name='1873'>
      <font color=#447700>!  Allocate the soil layer array used for interpolating.<a name='1874'></font>
<a name='1875'>
      IF ( ( num_st_levels_input .LE. 0 ) .OR. &amp;<a name='1876'>
           ( num_sm_levels_input .LE. 0 ) ) THEN<a name='1877'>
         write (message, FMT='(A)')&amp;<a name='1878'>
'No input soil level data (either temperature or moisture, or both are missing).  Required for RUC LSM.'<a name='1879'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1440"> ( message )<a name='1880'>
      ELSE<a name='1881'>
         IF ( flag_soil_levels == 1 ) THEN<a name='1882'>
           write(message, FMT='(A)') ' Assume RUC LSM 6-level input'<a name='1883'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1369"> ( message )<a name='1884'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input)  ) )<a name='1885'>
         ELSE<a name='1886'>
           write(message, FMT='(A)') ' Assume non-RUC LSM input'<a name='1887'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1370"> ( message )<a name='1888'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_soil_layers)  ) )<a name='1889'>
         END IF<a name='1890'>
      END IF<a name='1891'>
<a name='1892'>
      <font color=#447700>!  Sort the levels for temperature.<a name='1893'></font>
<a name='1894'>
      outert : DO lout = 1 , num_st_levels_input-1<a name='1895'>
         innert : DO lin = lout+1 , num_st_levels_input<a name='1896'>
            IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='1897'>
               temp = st_levels_input(lout)<a name='1898'>
               st_levels_input(lout) = st_levels_input(lin)<a name='1899'>
               st_levels_input(lin) = NINT(temp)<a name='1900'>
               DO j = jts , MIN(jde-1,jte)<a name='1901'>
                  DO i = its , MIN(ide-1,ite)<a name='1902'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1903'>
                     temp = st_input(i,lout,j)<a name='1904'>
                     st_input(i,lout,j) = st_input(i,lin,j)<a name='1905'>
                     st_input(i,lin,j) = temp<a name='1906'>
                  END DO<a name='1907'>
               END DO<a name='1908'>
            END IF<a name='1909'>
         END DO innert<a name='1910'>
      END DO outert<a name='1911'>
<a name='1912'>
      IF ( flag_soil_layers == 1 ) THEN<a name='1913'>
      DO j = jts , MIN(jde-1,jte)<a name='1914'>
         DO i = its , MIN(ide-1,ite)<a name='1915'>
            IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1916'>
            st_input(i,1,j) = tsk(i,j)<a name='1917'>
            st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='1918'>
         END DO<a name='1919'>
      END DO<a name='1920'>
      END IF<a name='1921'>
<a name='1922'>
      <font color=#447700>!  Sort the levels for moisture.<a name='1923'></font>
<a name='1924'>
      outerm: DO lout = 1 , num_sm_levels_input-1<a name='1925'>
         innerm : DO lin = lout+1 , num_sm_levels_input<a name='1926'>
            IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='1927'>
               temp = sm_levels_input(lout)<a name='1928'>
               sm_levels_input(lout) = sm_levels_input(lin)<a name='1929'>
               sm_levels_input(lin) = NINT(temp)<a name='1930'>
               DO j = jts , MIN(jde-1,jte)<a name='1931'>
                  DO i = its , MIN(ide-1,ite)<a name='1932'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1933'>
                     temp = sm_input(i,lout,j)<a name='1934'>
                     sm_input(i,lout,j) = sm_input(i,lin,j)<a name='1935'>
                     sm_input(i,lin,j) = temp<a name='1936'>
                  END DO<a name='1937'>
               END DO<a name='1938'>
            END IF<a name='1939'>
         END DO innerm<a name='1940'>
      END DO outerm<a name='1941'>
<a name='1942'>
      if( flag_soil_levels .ne. 1) then<a name='1943'>
           write(message, FMT='(A)') ' from Noah to RUC - compute Noah bucket'<a name='1944'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1371"> ( message )<a name='1945'>
<font color=#447700>! Compute Noah sil moisture bucket<a name='1946'></font>
               DO j = jts , MIN(jde-1,jte)<a name='1947'>
                  DO i = its , MIN(ide-1,ite)<a name='1948'>
                  smtotn(i,j)=sm_input(i,2,j)*0.1 + sm_input(i,3,j)*0.2 + sm_input(i,4,j)*0.7 + sm_input(i,5,j)*1.<a name='1949'>
                  smtotn_1m(i,j)=sm_input(i,2,j)*0.1 + sm_input(i,3,j)*0.2 + sm_input(i,4,j)*0.7<a name='1950'>
                  END DO<a name='1951'>
               END DO<a name='1952'>
      endif<a name='1953'>
<a name='1954'>
      IF ( flag_soil_layers == 1 ) THEN<a name='1955'>
      DO j = jts , MIN(jde-1,jte)<a name='1956'>
         DO i = its , MIN(ide-1,ite)<a name='1957'>
            IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1958'>
            sm_input(i,1,j) = (sm_input(i,2,j)-sm_input(i,3,j))/   &amp;<a name='1959'>
                              (st_levels_input(2)-st_levels_input(1))*st_levels_input(1)+  &amp;<a name='1960'>
                              sm_input(i,2,j)<a name='1961'>
<font color=#447700>!           sm_input(i,1,j) = sm_input(i,2,j)<a name='1962'></font>
            sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='1963'>
         END DO<a name='1964'>
      END DO<a name='1965'>
      END IF<a name='1966'>
<a name='1967'>
      <font color=#447700>!  Here are the levels that we have from the input for temperature.<a name='1968'></font>
<a name='1969'>
      IF ( flag_soil_levels == 1 ) THEN<a name='1970'>
         DO l = 1 , num_st_levels_input<a name='1971'>
            zhave(l) = st_levels_input(l) / 100.<a name='1972'>
         END DO<a name='1973'>
<a name='1974'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='1975'></font>
<a name='1976'>
<a name='1977'>
      z_wantt : DO lwant = 1 , num_soil_layers<a name='1978'>
         z_havet : DO lhave = 1 , num_st_levels_input -1<a name='1979'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='1980'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='1981'>
               DO j = jts , MIN(jde-1,jte)<a name='1982'>
                  DO i = its , MIN(ide-1,ite)<a name='1983'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='1984'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='1985'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='1986'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='1987'>
                  END DO<a name='1988'>
               END DO<a name='1989'>
               EXIT z_havet<a name='1990'>
            END IF<a name='1991'>
         END DO z_havet<a name='1992'>
      END DO z_wantt<a name='1993'>
<a name='1994'>
      ELSE<a name='1995'>
<a name='1996'>
         zhave(1) = 0.<a name='1997'>
         DO l = 1 , num_st_levels_input<a name='1998'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='1999'>
         END DO<a name='2000'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='2001'>
<a name='2002'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2003'></font>
<a name='2004'>
      z_wantt_2 : DO lwant = 1 , num_soil_layers<a name='2005'>
         z_havet_2 : DO lhave = 1 , num_st_levels_input +2<a name='2006'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2007'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2008'>
               DO j = jts , MIN(jde-1,jte)<a name='2009'>
                  DO i = its , MIN(ide-1,ite)<a name='2010'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2011'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2012'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2013'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='2014'>
                  END DO<a name='2015'>
               END DO<a name='2016'>
               EXIT z_havet_2<a name='2017'>
            END IF<a name='2018'>
         END DO z_havet_2<a name='2019'>
      END DO z_wantt_2<a name='2020'>
<a name='2021'>
      END IF<a name='2022'>
<a name='2023'>
      <font color=#447700>!  Here are the levels that we have from the input for moisture.<a name='2024'></font>
<a name='2025'>
      IF ( flag_soil_levels .EQ. 1 ) THEN<a name='2026'>
         DO l = 1 , num_sm_levels_input<a name='2027'>
            zhave(l) = sm_levels_input(l) / 100.<a name='2028'>
         END DO<a name='2029'>
<a name='2030'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2031'></font>
<a name='2032'>
      z_wantm : DO lwant = 1 , num_soil_layers<a name='2033'>
         z_havem : DO lhave = 1 , num_sm_levels_input -1<a name='2034'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2035'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2036'>
               DO j = jts , MIN(jde-1,jte)<a name='2037'>
                  DO i = its , MIN(ide-1,ite)<a name='2038'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2039'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2040'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2041'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='2042'>
                  END DO<a name='2043'>
               END DO<a name='2044'>
               EXIT z_havem<a name='2045'>
            END IF<a name='2046'>
         END DO z_havem<a name='2047'>
      END DO z_wantm<a name='2048'>
<a name='2049'>
      ELSE<a name='2050'>
<a name='2051'>
         zhave(1) = 0.<a name='2052'>
         DO l = 1 , num_sm_levels_input<a name='2053'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='2054'>
         END DO<a name='2055'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='2056'>
<a name='2057'>
      z_wantm_2 : DO lwant = 1 , num_soil_layers<a name='2058'>
         z_havem_2 : DO lhave = 1 , num_sm_levels_input +2<a name='2059'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2060'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2061'>
               DO j = jts , MIN(jde-1,jte)<a name='2062'>
                  DO i = its , MIN(ide-1,ite)<a name='2063'>
                     IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2064'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2065'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2066'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='2067'>
                  END DO<a name='2068'>
               END DO<a name='2069'>
               EXIT z_havem_2<a name='2070'>
            END IF<a name='2071'>
         END DO z_havem_2<a name='2072'>
      END DO z_wantm_2<a name='2073'>
<a name='2074'>
      END IF<a name='2075'>
<a name='2076'>
      if( flag_soil_levels .ne. 1) then<a name='2077'>
           write(message, FMT='(A)') ' from Noah to RUC - compute RUC bucket'<a name='2078'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1372"> ( message )<a name='2079'>
      DO j = jts , MIN(jde-1,jte)<a name='2080'>
         DO i = its , MIN(ide-1,ite)<a name='2081'>
               smtotr(i,j)=0.<a name='2082'>
               smtotr_1m(i,j)=0.<a name='2083'>
               do k=1,num_soil_layers-1 <a name='2084'>
                  smtotr(i,j)=smtotr(i,j) + smois(i,k,j) *dzs(k)<a name='2085'>
               enddo<a name='2086'>
               do k=1,num_soil_layers-2<a name='2087'>
                  smtotr_1m(i,j)=smtotr_1m(i,j) + smois(i,k,j) *dzs(k)<a name='2088'>
               enddo<a name='2089'>
<a name='2090'>
        IF ( landmask(i,j) &gt; 0.5) then<a name='2091'>
<font color=#447700>! land<a name='2092'></font>
<font color=#447700>! initialize factor<a name='2093'></font>
       do k=1,num_soil_layers<a name='2094'>
          factorsm(k)=1.<a name='2095'>
       enddo<a name='2096'>
<font color=#447700>! Correct RUC soil moisture to match Noah bucket<a name='2097'></font>
<font color=#447700>!   print *,'1-m Buckets: RUC and Noah',i,j,smtotr_1m(i,j),0.77*smtotr_1m(i,j),smtotn_1m(i,j)<a name='2098'></font>
<font color=#447700>!   print *,'Buckets: RUC and Noah',i,j,smtotr(i,j),smtotn(i,j)<a name='2099'></font>
<font color=#447700>!        print *,'before smois=',i,j,smois(i,:,j)<a name='2100'></font>
          do k=1,num_soil_layers-1 <a name='2101'>
            smois(i,k,j) = max(0.02,smois(i,k,j)*smtotn(i,j)/(0.9*smtotr(i,j)))<a name='2102'>
          enddo<a name='2103'>
<font color=#447700>!        print *,'after smois=',i,j,smois(i,:,j)<a name='2104'></font>
<font color=#447700>! Compute RUC bucket after correction<a name='2105'></font>
            smtotr(i,j) = 0.<a name='2106'>
          do k=1,num_soil_layers-1<a name='2107'>
            smtotr(i,j)=smtotr(i,j) + smois(i,k,j) *dzs(k)<a name='2108'>
          enddo<a name='2109'>
<font color=#447700>!     print *,'Buckets after correction: RUC and Noah at',i,j,smtotr(i,j),smtotn(i,j)<a name='2110'></font>
   if( smois(i,2,j) &gt; smois(i,1,j) .and. smois(i,3,j) &gt; smois(i,2,j)) then<a name='2111'>
<font color=#447700>! typical for daytime, no recent precip<a name='2112'></font>
          factorsm(1) = 0.75<a name='2113'>
          factorsm(2) = 0.8 <a name='2114'>
          factorsm(3) = 0.85<a name='2115'>
          factorsm(4) = 0.9<a name='2116'>
          factorsm(5) = 0.95<a name='2117'>
    endif<a name='2118'>
   do k=1,num_soil_layers-1<a name='2119'>
      smois(i,k,j) = factorsm(k) * smois(i,k,j)<a name='2120'>
   enddo<a name='2121'>
<a name='2122'>
<font color=#447700>!        print *,'1 - after smois=',i,j,smois(i,:,j)<a name='2123'></font>
            smtotr(i,j) = 0.<a name='2124'>
          do k=1,num_soil_layers-1<a name='2125'>
            smtotr(i,j)=smtotr(i,j) + smois(i,k,j) *dzs(k)<a name='2126'>
          enddo<a name='2127'>
<font color=#447700>!     print *,'1 - Buckets after correction: RUC and Noah at',i,j,smtotr(i,j),smtotn(i,j)<a name='2128'></font>
        ENDIF <font color=#447700>! land<a name='2129'></font>
         END DO<a name='2130'>
      END DO<a name='2131'>
<a name='2132'>
      endif <font color=#447700>! flag_soil_levels<a name='2133'></font>
<a name='2134'>
      <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='2135'></font>
      <font color=#447700>!  used, but they will make a more continuous plot.<a name='2136'></font>
<a name='2137'>
      IF ( flag_sst .EQ. 1 ) THEN<a name='2138'>
         DO j = jts , MIN(jde-1,jte)<a name='2139'>
            DO i = its , MIN(ide-1,ite)<a name='2140'>
               IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2141'>
               IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2142'>
                  DO l = 1 , num_soil_layers<a name='2143'>
                     tslb(i,l,j) = sst(i,j)<a name='2144'>
                     tsk(i,j)    = sst(i,j)<a name='2145'>
                     smois(i,l,j)= 1.0<a name='2146'>
                  END DO<a name='2147'>
               END IF<a name='2148'>
            END DO<a name='2149'>
         END DO<a name='2150'>
      ELSE<a name='2151'>
         DO j = jts , MIN(jde-1,jte)<a name='2152'>
            DO i = its , MIN(ide-1,ite)<a name='2153'>
               IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2154'>
               IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2155'>
                  DO l = 1 , num_soil_layers<a name='2156'>
                     tslb(i,l,j)= tsk(i,j)<a name='2157'>
                     smois(i,l,j)= 1.0<a name='2158'>
                  END DO<a name='2159'>
               END IF<a name='2160'>
            END DO<a name='2161'>
         END DO<a name='2162'>
      END IF<a name='2163'>
<a name='2164'>
      DEALLOCATE (zhave)<a name='2165'>
<a name='2166'>
   END SUBROUTINE init_soil_3_real<a name='2167'>
<a name='2168'>
<A NAME='INIT_SOIL_4_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2169'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_4_real</font> ( tsk , tmn , smois , sh2o , tslb , &amp; <A href='../../call_to/INIT_SOIL_4_REAL.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_SOIL_4_REAL.html' TARGET='index'>6</A><a name='2170'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='2171'>
                                 zs , dzs , &amp;<a name='2172'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='2173'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  num_sw_levels_input , &amp;<a name='2174'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='2175'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='2176'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='2177'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='2178'>
                                 its , ite , jts , jte , kts , kte )<a name='2179'>
<a name='2180'>
      IMPLICIT NONE<a name='2181'>
<a name='2182'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='2183'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='2184'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='2185'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='2186'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='2187'>
                              its , ite , jts , jte , kts , kte<a name='2188'>
<a name='2189'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soil_layers, flag_soil_levels<a name='2190'>
<a name='2191'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='2192'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='2193'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='2194'>
<a name='2195'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='2196'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='2197'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='2198'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='2199'>
<a name='2200'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='2201'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='2202'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='2203'>
<a name='2204'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='2205'>
<a name='2206'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='2207'>
<a name='2208'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave , num<a name='2209'>
      REAL :: temp<a name='2210'>
      LOGICAL :: found_levels<a name='2211'>
<a name='2212'>
      CHARACTER (LEN=132) :: message<a name='2213'>
<a name='2214'>
      <font color=#447700>!  Are there any soil temp and moisture levels - ya know, they are<a name='2215'></font>
      <font color=#447700>!  mandatory.<a name='2216'></font>
<a name='2217'>
      num = num_st_levels_input * num_sm_levels_input<a name='2218'>
<a name='2219'>
      IF ( num .GE. 1 ) THEN<a name='2220'>
<a name='2221'>
         <font color=#447700>!  Ordered levels that we have data for.  <a name='2222'></font>
<a name='2223'>
<font color=#447700>!tgs add option to initialize from RUCLSM<a name='2224'></font>
         IF ( flag_soil_levels == 1 ) THEN<a name='2225'>
           write(message, FMT='(A)') ' Assume CLM input'<a name='2226'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1373"> ( message )<a name='2227'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input)  ) )<a name='2228'>
         ELSE<a name='2229'>
           write(message, FMT='(A)') ' Assume non-CLM input'<a name='2230'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1374"> ( message )<a name='2231'>
        ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input) +2) )<a name='2232'>
      <font color=#447700>!   ALLOCATE ( zhave( MAX(num_st_levels_input,num_soil_layers)  ) )<a name='2233'></font>
         END IF<a name='2234'>
<a name='2235'>
<a name='2236'>
         <font color=#447700>!  Sort the levels for temperature.<a name='2237'></font>
<a name='2238'>
         outert : DO lout = 1 , num_st_levels_input-1<a name='2239'>
            innert : DO lin = lout+1 , num_st_levels_input<a name='2240'>
               IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='2241'>
                  temp = st_levels_input(lout)<a name='2242'>
                  st_levels_input(lout) = st_levels_input(lin)<a name='2243'>
                  st_levels_input(lin) = NINT(temp)<a name='2244'>
                  DO j = jts , MIN(jde-1,jte)<a name='2245'>
                     DO i = its , MIN(ide-1,ite)<a name='2246'>
                        temp = st_input(i,lout+1,j)<a name='2247'>
                        st_input(i,lout+1,j) = st_input(i,lin+1,j)<a name='2248'>
                        st_input(i,lin+1,j) = temp<a name='2249'>
                     END DO<a name='2250'>
                  END DO<a name='2251'>
               END IF<a name='2252'>
            END DO innert<a name='2253'>
         END DO outert<a name='2254'>
<font color=#447700>!tgs add IF<a name='2255'></font>
      IF ( flag_soil_layers == 1 ) THEN<a name='2256'>
         DO j = jts , MIN(jde-1,jte)<a name='2257'>
            DO i = its , MIN(ide-1,ite)<a name='2258'>
               st_input(i,1,j) = tsk(i,j)<a name='2259'>
               st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='2260'>
            END DO<a name='2261'>
         END DO<a name='2262'>
      ENDIF<a name='2263'>
        <font color=#447700>!  Sort the levels for moisture.<a name='2264'></font>
<a name='2265'>
        outerm: DO lout = 1 , num_sm_levels_input-1<a name='2266'>
            innerm : DO lin = lout+1 , num_sm_levels_input<a name='2267'>
               IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='2268'>
                  temp = sm_levels_input(lout)<a name='2269'>
                  sm_levels_input(lout) = sm_levels_input(lin)<a name='2270'>
                  sm_levels_input(lin) = NINT(temp)<a name='2271'>
                  DO j = jts , MIN(jde-1,jte)<a name='2272'>
                     DO i = its , MIN(ide-1,ite)<a name='2273'>
                        temp = sm_input(i,lout+1,j)<a name='2274'>
                        sm_input(i,lout+1,j) = sm_input(i,lin+1,j)<a name='2275'>
                        sm_input(i,lin+1,j) = temp<a name='2276'>
                     END DO<a name='2277'>
                  END DO<a name='2278'>
               END IF<a name='2279'>
            END DO innerm<a name='2280'>
         END DO outerm<a name='2281'>
<font color=#447700>!tgs add IF<a name='2282'></font>
      IF ( flag_soil_layers == 1 ) THEN<a name='2283'>
         DO j = jts , MIN(jde-1,jte)<a name='2284'>
            DO i = its , MIN(ide-1,ite)<a name='2285'>
               sm_input(i,1,j) = sm_input(i,2,j)<a name='2286'>
               sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='2287'>
            END DO<a name='2288'>
         END DO<a name='2289'>
      ENDIF<a name='2290'>
<a name='2291'>
         <font color=#447700>!  Sort the levels for liquid moisture.<a name='2292'></font>
<a name='2293'>
         outerw: DO lout = 1 , num_sw_levels_input-1<a name='2294'>
            innerw : DO lin = lout+1 , num_sw_levels_input<a name='2295'>
               IF ( sw_levels_input(lout) .GT. sw_levels_input(lin) ) THEN<a name='2296'>
                  temp = sw_levels_input(lout)<a name='2297'>
                  sw_levels_input(lout) = sw_levels_input(lin)<a name='2298'>
                  sw_levels_input(lin) = NINT(temp)<a name='2299'>
                  DO j = jts , MIN(jde-1,jte)<a name='2300'>
                     DO i = its , MIN(ide-1,ite)<a name='2301'>
                        temp = sw_input(i,lout+1,j)<a name='2302'>
                        sw_input(i,lout+1,j) = sw_input(i,lin+1,j)<a name='2303'>
                        sw_input(i,lin+1,j) = temp<a name='2304'>
                     END DO<a name='2305'>
                  END DO<a name='2306'>
               END IF<a name='2307'>
            END DO innerw<a name='2308'>
         END DO outerw<a name='2309'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='2310'>
            DO j = jts , MIN(jde-1,jte)<a name='2311'>
               DO i = its , MIN(ide-1,ite)<a name='2312'>
                  sw_input(i,1,j) = sw_input(i,2,j)<a name='2313'>
                  sw_input(i,num_sw_levels_input+2,j) = sw_input(i,num_sw_levels_input+1,j)<a name='2314'>
               END DO<a name='2315'>
            END DO<a name='2316'>
         END IF<a name='2317'>
<a name='2318'>
         found_levels = .TRUE.<a name='2319'>
<a name='2320'>
      ELSE IF ( ( num .LE. 0 ) .AND. (  start_date .NE. current_date ) ) THEN<a name='2321'>
<a name='2322'>
         found_levels = .FALSE.<a name='2323'>
<a name='2324'>
      ELSE<a name='2325'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1441"> ( &amp;<a name='2326'>
         'No input soil level data (temperature, moisture or liquid, or all are missing). Required for LSM.' )<a name='2327'>
      END IF<a name='2328'>
<a name='2329'>
      <font color=#447700>!  Is it OK to continue?<a name='2330'></font>
<a name='2331'>
      IF ( found_levels ) THEN<a name='2332'>
<a name='2333'>
         <font color=#447700>!tgs:  Here are the levels that we have from the input for temperature.<a name='2334'></font>
<a name='2335'>
         IF ( flag_soil_levels == 1 ) THEN<a name='2336'>
            DO l = 1 , num_st_levels_input<a name='2337'>
               zhave(l) = st_levels_input(l) / 100.<a name='2338'>
            END DO<a name='2339'>
<a name='2340'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we  want (zs).<a name='2341'></font>
<a name='2342'>
         z_wantt : DO lwant = 1 , num_soil_layers<a name='2343'>
            z_havet : DO lhave = 1 , num_st_levels_input -1<a name='2344'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2345'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2346'>
                  DO j = jts , MIN(jde-1,jte)<a name='2347'>
                     DO i = its , MIN(ide-1,ite)<a name='2348'>
                        tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2349'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant) - zhave(lhave) ) ) / &amp;<a name='2350'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='2351'>
                     END DO<a name='2352'>
                  END DO<a name='2353'>
                  EXIT z_havet<a name='2354'>
               END IF<a name='2355'>
            END DO z_havet<a name='2356'>
         END DO z_wantt<a name='2357'>
<a name='2358'>
         ELSE<a name='2359'>
<a name='2360'>
         <font color=#447700>!  Here are the levels that we have from the input for temperature.  The input levels plus<a name='2361'></font>
         <font color=#447700>!  two more: the skin temperature at 0 cm, and the annual mean  temperature at 300 cm.<a name='2362'></font>
<a name='2363'>
         zhave(1) = 0.<a name='2364'>
         DO l = 1 , num_st_levels_input<a name='2365'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='2366'>
         END DO<a name='2367'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='2368'>
<a name='2369'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2370'></font>
<a name='2371'>
         z_wantt_2: DO lwant = 1 , num_soil_layers<a name='2372'>
            z_havet_2 : DO lhave = 1 , num_st_levels_input +2 -1<a name='2373'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2374'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2375'>
                  DO j = jts , MIN(jde-1,jte)<a name='2376'>
                     DO i = its , MIN(ide-1,ite)<a name='2377'>
                        tslb(i,lwant,j)= ( st_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2378'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant) - zhave(lhave) ) ) / &amp;<a name='2379'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='2380'>
                     END DO<a name='2381'>
                  END DO<a name='2382'>
                  EXIT z_havet_2<a name='2383'>
               END IF<a name='2384'>
            END DO z_havet_2<a name='2385'>
         END DO z_wantt_2<a name='2386'>
<a name='2387'>
      END IF<a name='2388'>
<a name='2389'>
<font color=#447700>!tgs:<a name='2390'></font>
      IF ( flag_soil_levels == 1 ) THEN<a name='2391'>
         DO l = 1 , num_sm_levels_input<a name='2392'>
            zhave(l) = sm_levels_input(l) / 100.<a name='2393'>
         END DO<a name='2394'>
<a name='2395'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2396'></font>
<a name='2397'>
      z_wantm : DO lwant = 1 , num_soil_layers<a name='2398'>
         z_havem : DO lhave = 1 , num_sm_levels_input -1<a name='2399'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2400'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2401'>
               DO j = jts , MIN(jde-1,jte)<a name='2402'>
                  DO i = its , MIN(ide-1,ite)<a name='2403'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2404'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant) - zhave(lhave) ) ) / &amp;<a name='2405'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='2406'>
                    if(smois(i,lwant,j)&lt;=0.0) smois(i,lwant,j) = 0.005<a name='2407'>
                  END DO<a name='2408'>
               END DO<a name='2409'>
               EXIT z_havem<a name='2410'>
            END IF<a name='2411'>
         END DO z_havem<a name='2412'>
      END DO z_wantm<a name='2413'>
<a name='2414'>
      ELSE<a name='2415'>
         <font color=#447700>!  Here are the levels that we have from the input for moisture.  The  input levels plus<a name='2416'></font>
         <font color=#447700>!  two more: a value at 0 cm and one at 300 cm.  The 0 cm value is  taken to be identical<a name='2417'></font>
         <font color=#447700>!  to the most shallow layer's value.  Similarly, the 300 cm value is  taken to be the same<a name='2418'></font>
         <font color=#447700>!  as the most deep layer's value.<a name='2419'></font>
<a name='2420'>
         zhave(1) = 0.<a name='2421'>
         DO l = 1 , num_sm_levels_input<a name='2422'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='2423'>
         END DO<a name='2424'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='2425'>
<a name='2426'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2427'></font>
<a name='2428'>
         z_wantm_2 : DO lwant = 1 , num_soil_layers<a name='2429'>
            z_havem_2 : DO lhave = 1 , num_sm_levels_input +2 -1<a name='2430'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2431'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2432'>
                  DO j = jts , MIN(jde-1,jte)<a name='2433'>
                     DO i = its , MIN(ide-1,ite)<a name='2434'>
                        smois(i,lwant,j)= ( sm_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2435'>
                                            sm_input(i,lhave+1,j) * ( zs (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2436'>
                                                                    ( zhave(lhave+1) - zhave(lhave) )<a name='2437'>
                     if(smois(i,lwant,j)&lt;=0.0) smois(i,lwant,j) = 0.005<a name='2438'>
                     END DO<a name='2439'>
                  END DO<a name='2440'>
                  EXIT z_havem_2<a name='2441'>
               END IF<a name='2442'>
            END DO z_havem_2<a name='2443'>
         END DO z_wantm_2<a name='2444'>
       ENDIF<a name='2445'>
<a name='2446'>
         <font color=#447700>!  Any liquid soil moisture to worry about?<a name='2447'></font>
<a name='2448'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='2449'>
<a name='2450'>
            zhave(1) = 0.<a name='2451'>
            DO l = 1 , num_sw_levels_input<a name='2452'>
               zhave(l+1) = sw_levels_input(l) / 100.<a name='2453'>
            END DO<a name='2454'>
            zhave(num_sw_levels_input+2) = 300. / 100.<a name='2455'>
<a name='2456'>
            <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2457'></font>
<a name='2458'>
            z_wantw : DO lwant = 1 , num_soil_layers<a name='2459'>
               z_havew : DO lhave = 1 , num_sw_levels_input +2 -1<a name='2460'>
                  IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2461'>
                       ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2462'>
                     DO j = jts , MIN(jde-1,jte)<a name='2463'>
                        DO i = its , MIN(ide-1,ite)<a name='2464'>
                           sh2o(i,lwant,j)= ( sw_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2465'>
                                               sw_input(i,lhave+1,j) * ( zs (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2466'>
                                                                       ( zhave(lhave+1) - zhave(lhave) )<a name='2467'>
                        END DO<a name='2468'>
                     END DO<a name='2469'>
                     EXIT z_havew<a name='2470'>
                  END IF<a name='2471'>
               END DO z_havew<a name='2472'>
            END DO z_wantw<a name='2473'>
<a name='2474'>
         END IF<a name='2475'>
<a name='2476'>
<a name='2477'>
         <font color=#447700>!  Over water, put in reasonable values for soil temperature and  moisture.  These won't be<a name='2478'></font>
         <font color=#447700>!  used, but they will make a more continuous plot.<a name='2479'></font>
<a name='2480'>
         IF ( flag_sst .EQ. 1 ) THEN<a name='2481'>
            DO j = jts , MIN(jde-1,jte)<a name='2482'>
               DO i = its , MIN(ide-1,ite)<a name='2483'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2484'>
                     DO l = 1 , num_soil_layers<a name='2485'>
                        tslb(i,l,j)= sst(i,j)<a name='2486'>
                        smois(i,l,j)= 1.0<a name='2487'>
                        sh2o (i,l,j)= 1.0<a name='2488'>
                     END DO<a name='2489'>
                  END IF<a name='2490'>
               END DO<a name='2491'>
            END DO<a name='2492'>
         ELSE<a name='2493'>
            DO j = jts , MIN(jde-1,jte)<a name='2494'>
               DO i = its , MIN(ide-1,ite)<a name='2495'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2496'>
                     DO l = 1 , num_soil_layers<a name='2497'>
                        tslb(i,l,j)= tsk(i,j)<a name='2498'>
                        smois(i,l,j)= 1.0<a name='2499'>
                        sh2o (i,l,j)= 1.0<a name='2500'>
                     END DO<a name='2501'>
                  END IF<a name='2502'>
               END DO<a name='2503'>
            END DO<a name='2504'>
         END IF<a name='2505'>
<a name='2506'>
         DEALLOCATE (zhave)<a name='2507'>
<a name='2508'>
      END IF<a name='2509'>
<a name='2510'>
   END SUBROUTINE init_soil_4_real<a name='2511'>
<a name='2512'>
<A NAME='INIT_SOIL_7_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_7_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2513'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_7_real</font> ( tsk , tmn , smois , sh2o , tslb , &amp; <A href='../../call_to/INIT_SOIL_7_REAL.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_SOIL_7_REAL.html' TARGET='index'>1</A><a name='2514'>
                                 st_input , sm_input , sw_input , landmask , sst ,     &amp;<a name='2515'>
                                 zs , dzs ,                                            &amp;<a name='2516'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='2517'>
                                 num_soil_layers , num_st_levels_input ,               &amp;<a name='2518'>
                                 num_sm_levels_input ,  num_sw_levels_input ,          &amp;<a name='2519'>
                                 num_st_levels_alloc , num_sm_levels_alloc ,           &amp;<a name='2520'>
                                 num_sw_levels_alloc ,                                 &amp;<a name='2521'>
                                 flag_sst , flag_soil_layers , flag_soil_levels ,      &amp;<a name='2522'>
                                 ids , ide , jds , jde , kds , kde ,                   &amp;<a name='2523'>
                                 ims , ime , jms , jme , kms , kme ,                   &amp;<a name='2524'>
                                 its , ite , jts , jte , kts , kte )<a name='2525'>
<a name='2526'>
      <font color=#447700>! for soil temperature and moisture initialization for the PX LSM<a name='2527'></font>
<a name='2528'>
      IMPLICIT NONE<a name='2529'>
<a name='2530'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='2531'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='2532'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='2533'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='2534'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='2535'>
                              its , ite , jts , jte , kts , kte<a name='2536'>
<a name='2537'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soil_layers, flag_soil_levels<a name='2538'>
<a name='2539'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='2540'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='2541'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='2542'>
<a name='2543'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='2544'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='2545'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='2546'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='2547'>
<a name='2548'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='2549'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='2550'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='2551'>
<a name='2552'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='2553'>
<a name='2554'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='2555'>
<a name='2556'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave , num<a name='2557'>
      REAL    :: temp<a name='2558'>
      LOGICAL :: found_levels<a name='2559'>
<a name='2560'>
      <font color=#447700>!  Are there any soil temp and moisture levels - ya know, they are mandatory.<a name='2561'></font>
<a name='2562'>
      num = num_st_levels_input * num_sm_levels_input<a name='2563'>
<a name='2564'>
      IF ( num .GE. 1 ) THEN<a name='2565'>
<a name='2566'>
         <font color=#447700>!  Ordered levels that we have data for.<a name='2567'></font>
<a name='2568'>
         ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input) +2) )<a name='2569'>
<a name='2570'>
         <font color=#447700>!  Sort the levels for temperature.<a name='2571'></font>
         outert : DO lout = 1 , num_st_levels_input-1<a name='2572'>
            innert : DO lin = lout+1 , num_st_levels_input<a name='2573'>
               IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='2574'>
                  temp = st_levels_input(lout)<a name='2575'>
                  st_levels_input(lout) = st_levels_input(lin)<a name='2576'>
                  st_levels_input(lin) = NINT(temp)<a name='2577'>
                  DO j = jts , MIN(jde-1,jte)<a name='2578'>
                     DO i = its , MIN(ide-1,ite)<a name='2579'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2580'>
                        temp = st_input(i,lout+1,j)<a name='2581'>
                        st_input(i,lout+1,j) = st_input(i,lin+1,j)<a name='2582'>
                        st_input(i,lin+1,j) = temp<a name='2583'>
                     END DO<a name='2584'>
                  END DO<a name='2585'>
               END IF<a name='2586'>
            END DO innert<a name='2587'>
         END DO outert<a name='2588'>
         DO j = jts , MIN(jde-1,jte)<a name='2589'>
            DO i = its , MIN(ide-1,ite)<a name='2590'>
               IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2591'>
               st_input(i,1,j) = tsk(i,j)<a name='2592'>
               st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='2593'>
            END DO<a name='2594'>
         END DO<a name='2595'>
<a name='2596'>
         <font color=#447700>!  Sort the levels for moisture.<a name='2597'></font>
<a name='2598'>
         outerm: DO lout = 1 , num_sm_levels_input-1<a name='2599'>
            innerm : DO lin = lout+1 , num_sm_levels_input<a name='2600'>
              IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='2601'>
                  temp = sm_levels_input(lout)<a name='2602'>
                  sm_levels_input(lout) = sm_levels_input(lin)<a name='2603'>
                  sm_levels_input(lin) = NINT(temp)<a name='2604'>
                  DO j = jts , MIN(jde-1,jte)<a name='2605'>
                     DO i = its , MIN(ide-1,ite)<a name='2606'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2607'>
                        temp = sm_input(i,lout+1,j)<a name='2608'>
                        sm_input(i,lout+1,j) = sm_input(i,lin+1,j)<a name='2609'>
                        sm_input(i,lin+1,j) = temp<a name='2610'>
                     END DO<a name='2611'>
                  END DO<a name='2612'>
               END IF<a name='2613'>
            END DO innerm<a name='2614'>
         END DO outerm<a name='2615'>
         DO j = jts , MIN(jde-1,jte)<a name='2616'>
            DO i = its , MIN(ide-1,ite)<a name='2617'>
               IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2618'>
               sm_input(i,1,j) = sm_input(i,2,j)<a name='2619'>
               sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='2620'>
            END DO<a name='2621'>
         END DO<a name='2622'>
<a name='2623'>
         <font color=#447700>!  Sort the levels for liquid moisture.<a name='2624'></font>
<a name='2625'>
         outerw: DO lout = 1 , num_sw_levels_input-1<a name='2626'>
            innerw : DO lin = lout+1 , num_sw_levels_input<a name='2627'>
               IF ( sw_levels_input(lout) .GT. sw_levels_input(lin) ) THEN<a name='2628'>
                  temp = sw_levels_input(lout)<a name='2629'>
                  sw_levels_input(lout) = sw_levels_input(lin)<a name='2630'>
                  sw_levels_input(lin) = NINT(temp)<a name='2631'>
                  DO j = jts , MIN(jde-1,jte)<a name='2632'>
                     DO i = its , MIN(ide-1,ite)<a name='2633'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2634'>
                        temp = sw_input(i,lout+1,j)<a name='2635'>
                        sw_input(i,lout+1,j) = sw_input(i,lin+1,j)<a name='2636'>
                        sw_input(i,lin+1,j) = temp<a name='2637'>
                     END DO<a name='2638'>
                  END DO<a name='2639'>
               END IF<a name='2640'>
            END DO innerw<a name='2641'>
         END DO outerw<a name='2642'>
        IF ( num_sw_levels_input .GT. 1 ) THEN<a name='2643'>
            DO j = jts , MIN(jde-1,jte)<a name='2644'>
               DO i = its , MIN(ide-1,ite)<a name='2645'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2646'>
                  sw_input(i,1,j) = sw_input(i,2,j)<a name='2647'>
                  sw_input(i,num_sw_levels_input+2,j) = sw_input(i,num_sw_levels_input+1,j)<a name='2648'>
               END DO<a name='2649'>
            END DO<a name='2650'>
         END IF<a name='2651'>
<a name='2652'>
         found_levels = .TRUE.<a name='2653'>
<a name='2654'>
      ELSE IF ( ( num .LE. 0 ) .AND. (  start_date .NE. current_date ) ) THEN<a name='2655'>
<a name='2656'>
         found_levels = .FALSE.<a name='2657'>
<a name='2658'>
      ELSE<a name='2659'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_7_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1442"> ( &amp;<a name='2660'>
         'No input soil level data (temperature, moisture or liquid, or all are missing). Required for PX LSM.' )<a name='2661'>
      END IF<a name='2662'>
<a name='2663'>
      <font color=#447700>!  Is it OK to continue?<a name='2664'></font>
<a name='2665'>
      IF ( found_levels ) THEN<a name='2666'>
<a name='2667'>
         <font color=#447700>!  Here are the levels that we have from the input for temperature.  The input levels plus<a name='2668'></font>
         <font color=#447700>!  two more: the skin temperature at 0 cm, and the annual mean temperature at 300 cm.<a name='2669'></font>
<a name='2670'>
         zhave(1) = 0.<a name='2671'>
         DO l = 1 , num_st_levels_input<a name='2672'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='2673'>
        END DO<a name='2674'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='2675'>
<a name='2676'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2677'></font>
<a name='2678'>
         z_wantt : DO lwant = 1 , num_soil_layers<a name='2679'>
            z_havet : DO lhave = 1 , num_st_levels_input +2 -1<a name='2680'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2681'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2682'>
                  DO j = jts , MIN(jde-1,jte)<a name='2683'>
                     DO i = its , MIN(ide-1,ite)<a name='2684'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2685'>
                        tslb(i,lwant,j)= ( st_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2686'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2687'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='2688'>
                     END DO<a name='2689'>
                  END DO<a name='2690'>
                  EXIT z_havet<a name='2691'>
               END IF<a name='2692'>
            END DO z_havet<a name='2693'>
         END DO z_wantt<a name='2694'>
<a name='2695'>
         <font color=#447700>!  Here are the levels that we have from the input for moisture.  The input levels plus<a name='2696'></font>
         <font color=#447700>!  two more: a value at 0 cm and one at 300 cm.  The 0 cm value is taken to be identical<a name='2697'></font>
         <font color=#447700>!  to the most shallow layer's value.  Similarly, the 300 cm value is taken to be the same<a name='2698'></font>
         <font color=#447700>!  as the most deep layer's value.<a name='2699'></font>
<a name='2700'>
         zhave(1) = 0.<a name='2701'>
         DO l = 1 , num_sm_levels_input<a name='2702'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='2703'>
         END DO<a name='2704'>
        zhave(num_sm_levels_input+2) = 300. / 100.<a name='2705'>
<a name='2706'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2707'></font>
<a name='2708'>
         z_wantm : DO lwant = 1 , num_soil_layers<a name='2709'>
            z_havem : DO lhave = 1 , num_sm_levels_input +2 -1<a name='2710'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2711'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2712'>
                  DO j = jts , MIN(jde-1,jte)<a name='2713'>
                     DO i = its , MIN(ide-1,ite)<a name='2714'>
                        IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2715'>
                        smois(i,lwant,j)= ( sm_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2716'>
                                            sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2717'>
                                                                    ( zhave(lhave+1) - zhave(lhave) )<a name='2718'>
                     END DO<a name='2719'>
                  END DO<a name='2720'>
                  EXIT z_havem<a name='2721'>
               END IF<a name='2722'>
            END DO z_havem<a name='2723'>
         END DO z_wantm<a name='2724'>
<a name='2725'>
         <font color=#447700>!  Any liquid soil moisture to worry about?<a name='2726'></font>
<a name='2727'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='2728'>
<a name='2729'>
            zhave(1) = 0.<a name='2730'>
            DO l = 1 , num_sw_levels_input<a name='2731'>
               zhave(l+1) = sw_levels_input(l) / 100.<a name='2732'>
            END DO<a name='2733'>
            zhave(num_sw_levels_input+2) = 300. / 100.<a name='2734'>
<a name='2735'>
          <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='2736'></font>
<a name='2737'>
            z_wantw : DO lwant = 1 , num_soil_layers<a name='2738'>
               z_havew : DO lhave = 1 , num_sw_levels_input +2 -1<a name='2739'>
                  IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='2740'>
                       ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='2741'>
                     DO j = jts , MIN(jde-1,jte)<a name='2742'>
                        DO i = its , MIN(ide-1,ite)<a name='2743'>
                           IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2744'>
                           sh2o(i,lwant,j)= ( sw_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='2745'>
                                               sw_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='2746'>
                                                                       ( zhave(lhave+1) - zhave(lhave) )<a name='2747'>
                        END DO<a name='2748'>
                     END DO<a name='2749'>
                     EXIT z_havew<a name='2750'>
                  END IF<a name='2751'>
               END DO z_havew<a name='2752'>
            END DO z_wantw<a name='2753'>
<a name='2754'>
         END IF<a name='2755'>
<a name='2756'>
<a name='2757'>
        <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='2758'></font>
        <font color=#447700>!  used, but they will make a more continuous plot.<a name='2759'></font>
<a name='2760'>
     DO j = jts , MIN(jde-1,jte)<a name='2761'>
        DO i = its , MIN(ide-1,ite)<a name='2762'>
             IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2763'>
             tslb(i,1,j)= tsk(i,j)<a name='2764'>
             tslb(i,2,j)= tmn(i,j)<a name='2765'>
        END DO<a name='2766'>
     END DO<a name='2767'>
<a name='2768'>
         IF ( flag_sst .EQ. 1 ) THEN<a name='2769'>
            DO j = jts , MIN(jde-1,jte)<a name='2770'>
               DO i = its , MIN(ide-1,ite)<a name='2771'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2772'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2773'>
                     DO l = 1 , num_soil_layers<a name='2774'>
                        tslb(i,l,j)= sst(i,j)<a name='2775'>
                        smois(i,l,j)= 1.0<a name='2776'>
                        sh2o (i,l,j)= 1.0<a name='2777'>
                     END DO<a name='2778'>
                  END IF<a name='2779'>
               END DO<a name='2780'>
            END DO<a name='2781'>
         ELSE<a name='2782'>
            DO j = jts , MIN(jde-1,jte)<a name='2783'>
               DO i = its , MIN(ide-1,ite)<a name='2784'>
                  IF ( skip_middle_points_t ( ids , ide , jds , jde , i , j , em_width , hold_ups ) ) CYCLE <a name='2785'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2786'>
                     DO l = 1 , num_soil_layers<a name='2787'>
                        tslb(i,l,j)= tsk(i,j)<a name='2788'>
                        smois(i,l,j)= 1.0<a name='2789'>
                        sh2o (i,l,j)= 1.0<a name='2790'>
                     END DO<a name='2791'>
                  END IF<a name='2792'>
               END DO<a name='2793'>
            END DO<a name='2794'>
         END IF<a name='2795'>
<a name='2796'>
         DEALLOCATE (zhave)<a name='2797'>
<a name='2798'>
      END IF<a name='2799'>
<a name='2800'>
   END SUBROUTINE init_soil_7_real<a name='2801'>
<font color=#447700>!------------SSIB (fds 06/2010)-----------------------------<a name='2802'></font>
<A NAME='INIT_SOIL_8_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_8_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2803'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_8_real</font> ( tsk , tmn , smois , sh2o , tslb , &amp;,<A href='../../call_from/INIT_SOIL_8_REAL.html' TARGET='index'>4</A><a name='2804'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='2805'>
                                 zs , dzs , &amp;<a name='2806'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='2807'>
           num_soil_layers , num_st_levels_input , num_sm_levels_input ,  num_sw_levels_input , &amp;<a name='2808'>
                             num_st_levels_alloc , num_sm_levels_alloc ,  num_sw_levels_alloc , &amp;<a name='2809'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='2810'>
                                 st000010, st010200, sm000010, sm010200, &amp;<a name='2811'>
                                 st010040 , st040100 , st100200, &amp;<a name='2812'>
                                 sm010040 , sm040100 , sm100200, &amp;<a name='2813'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='2814'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='2815'>
                                 its , ite , jts , jte , kts , kte )<a name='2816'>
<a name='2817'>
      IMPLICIT NONE<a name='2818'>
<a name='2819'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='2820'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='2821'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='2822'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='2823'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='2824'>
                              its , ite , jts , jte , kts , kte<a name='2825'>
<a name='2826'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soil_layers , flag_soil_levels<a name='2827'>
<a name='2828'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='2829'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='2830'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='2831'>
<a name='2832'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='2833'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='2834'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='2835'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='2836'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: st000010, st010200, st010040 , st040100 , st100200<a name='2837'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: sm000010, sm010200, sm010040 , sm040100 , sm100200<a name='2838'>
<a name='2839'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='2840'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='2841'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='2842'>
<a name='2843'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='2844'>
<a name='2845'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='2846'>
<a name='2847'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave , num<a name='2848'>
      REAL :: temp<a name='2849'>
      LOGICAL :: found_levels<a name='2850'>
<a name='2851'>
      found_levels = .false.<a name='2852'>
<a name='2853'>
<font color=#447700>!      write(message, FMT='(A)') ' Prepare SSiB LSM soil fields'<a name='2854'></font>
<font color=#447700>!fds (06/2010)<a name='2855'></font>
<font color=#447700>!-- SSiB needs NCEP/NCAR reanalysis soil temperature and moisture at 0-10cm and 10-200cm --<a name='2856'></font>
      IF ( flag_soil_layers == 1 ) THEN<a name='2857'>
                  DO j = jts , MIN(jde-1,jte)<a name='2858'>
                     DO i = its , MIN(ide-1,ite)<a name='2859'>
                        tslb(i,1,j) = st000010(i,j)<a name='2860'>
                        tslb(i,2,j) = st010040(i,j)<a name='2861'>
                        tslb(i,3,j) = st040100(i,j)<a name='2862'>
                        smois(i,1,j) = sm000010(i,j)<a name='2863'>
                        smois(i,2,j) = sm010040(i,j)<a name='2864'>
                        smois(i,3,j) = sm040100(i,j)<a name='2865'>
<font color=#447700>! temporary fix (JD) for missing 4-layer input - use 2 instead<a name='2866'></font>
                        if(tslb(i,2,j) .lt. 10.)tslb(i,2,j) = st000010(i,j)<a name='2867'>
                        if(smois(i,2,j) .lt. 0.01)smois(i,2,j) = sm000010(i,j)<a name='2868'>
                        if(tslb(i,3,j) .lt. 10.)tslb(i,3,j) = st010200(i,j)<a name='2869'>
                        if(smois(i,3,j) .lt. 0.01)smois(i,3,j) = sm010200(i,j)<a name='2870'>
                     END DO<a name='2871'>
                  END DO<a name='2872'>
      ELSE<a name='2873'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_8_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1100"> ( 0 , 'SSiB LSM needs 0-10 cm soil t')<a name='2874'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_8_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1101"> ( 0 , 'SSiB LSM needs 0-10 cm soil m')<a name='2875'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_8_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1102"> ( 0 , 'SSiB LSM needs 10-200 cm soil t')<a name='2876'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_8_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1103"> ( 0 , 'SSiB LSM needs 10-200 cm soil m')<a name='2877'>
      ENDIF<a name='2878'>
<a name='2879'>
         <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='2880'></font>
         <font color=#447700>!  used, but they will make a more continuous plot.<a name='2881'></font>
<a name='2882'>
         IF ( flag_sst .EQ. 1 ) THEN<a name='2883'>
            DO j = jts , MIN(jde-1,jte)<a name='2884'>
               DO i = its , MIN(ide-1,ite)<a name='2885'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2886'>
                     DO l = 1 , num_soil_layers<a name='2887'>
                        tslb(i,l,j)= sst(i,j)<a name='2888'>
                        smois(i,l,j)= 1.0<a name='2889'>
                        sh2o (i,l,j)= 1.0<a name='2890'>
                     END DO<a name='2891'>
                  END IF<a name='2892'>
               END DO<a name='2893'>
            END DO<a name='2894'>
         ELSE<a name='2895'>
            DO j = jts , MIN(jde-1,jte)<a name='2896'>
               DO i = its , MIN(ide-1,ite)<a name='2897'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='2898'>
                     DO l = 1 , num_soil_layers<a name='2899'>
                        tslb(i,l,j)= tsk(i,j)<a name='2900'>
                        smois(i,l,j)= 1.0<a name='2901'>
                        sh2o (i,l,j)= 1.0<a name='2902'>
                     END DO<a name='2903'>
                  END IF<a name='2904'>
               END DO<a name='2905'>
            END DO<a name='2906'>
         END IF<a name='2907'>
<a name='2908'>
   END SUBROUTINE init_soil_8_real<a name='2909'>
<font color=#447700>!--------------------------------------------------------<a name='2910'></font>
<a name='2911'>
<A NAME='AGGREGATE_CATEGORIES_PART1'><A href='../../html_code/share/module_soil_pre.F.html#AGGREGATE_CATEGORIES_PART1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2912'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>aggregate_categories_part1</font>  ( landuse_frac , iswater , num_veg_cat , mminlu ) <A href='../../call_to/AGGREGATE_CATEGORIES_PART1.html' TARGET='index'>1</A>,<A href='../../call_from/AGGREGATE_CATEGORIES_PART1.html' TARGET='index'>2</A><a name='2913'>
      IMPLICIT NONE<a name='2914'>
      INTEGER , INTENT(IN) :: iswater<a name='2915'>
      INTEGER , INTENT(IN) :: num_veg_cat<a name='2916'>
      CHARACTER (LEN=4) , INTENT(IN) :: mminlu<a name='2917'>
      REAL , DIMENSION(1:num_veg_cat) , INTENT(INOUT):: landuse_frac<a name='2918'>
<a name='2919'>
      <font color=#447700>!  Local variables<a name='2920'></font>
<a name='2921'>
      INTEGER , PARAMETER :: num_special_bins =  3 <font color=#447700>! grass, shrubs, trees; add a new line in the "cib" array if updating this<a name='2922'></font>
      INTEGER , PARAMETER :: max_cats_per_bin =  8 <font color=#447700>! larger than max num of cats inside each of the special bins<a name='2923'></font>
                                                   <font color=#447700>! So, no more than 8 total tree categories that we need to consider.<a name='2924'></font>
      INTEGER , PARAMETER :: fl               = -1 <font color=#447700>! Flag value so that we know this is not a valid category to consider.<a name='2925'></font>
      INTEGER , DIMENSION ( max_cats_per_bin * num_special_bins ) :: cib_usgs = &amp;<a name='2926'>
      (/  2 ,  3 ,  4 ,  5 ,  6 ,  7 , 10 , fl , &amp; <font color=#447700>! grass<a name='2927'></font>
          8 ,  9 , fl , fl , fl , fl , fl , fl , &amp; <font color=#447700>! shrubs <a name='2928'></font>
         11 , 12 , 13 , 14 , 15 , fl , fl , fl /)  <font color=#447700>! trees<a name='2929'></font>
      INTEGER , DIMENSION ( max_cats_per_bin * num_special_bins ) :: cib_modis = &amp;<a name='2930'>
      (/  9 , 10 , 12 , 14 , fl , fl , fl , fl , &amp; <font color=#447700>! grass<a name='2931'></font>
          6 ,  7 ,  8 , fl , fl , fl , fl , fl , &amp; <font color=#447700>! shrubs <a name='2932'></font>
          1 ,  2 ,  3 ,  4 ,  5 , fl , fl , fl /)  <font color=#447700>! trees<a name='2933'></font>
 <a name='2934'>
      IF      ( mminlu(1:4) .EQ. 'USGS' ) THEN<a name='2935'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#AGGREGATE_CATEGORIES_PART2'>aggregate_categories_part2</A><A href='../../html_code/share/module_soil_pre.F.html#AGGREGATE_CATEGORIES_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AGGREGATE_CATEGORIES_PART2_1">  ( landuse_frac , iswater , num_veg_cat , &amp;<a name='2936'>
                                            num_special_bins , max_cats_per_bin , fl , cib_usgs  )<a name='2937'>
      ELSE IF ( mminlu(1:4) .EQ. 'MODI' ) THEN<a name='2938'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#AGGREGATE_CATEGORIES_PART2'>aggregate_categories_part2</A><A href='../../html_code/share/module_soil_pre.F.html#AGGREGATE_CATEGORIES_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AGGREGATE_CATEGORIES_PART2_2">  ( landuse_frac , iswater , num_veg_cat , &amp;<a name='2939'>
                                            num_special_bins , max_cats_per_bin , fl , cib_modis )<a name='2940'>
      END IF<a name='2941'>
<a name='2942'>
   END SUBROUTINE aggregate_categories_part1<a name='2943'>
<a name='2944'>
<A NAME='AGGREGATE_CATEGORIES_PART2'><A href='../../html_code/share/module_soil_pre.F.html#AGGREGATE_CATEGORIES_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2945'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>aggregate_categories_part2</font>  ( landuse_frac , iswater , num_veg_cat , &amp; <A href='../../call_to/AGGREGATE_CATEGORIES_PART2.html' TARGET='index'>2</A><a name='2946'>
                                            num_special_bins , max_cats_per_bin , fl , cib )<a name='2947'>
      IMPLICIT NONE<a name='2948'>
<a name='2949'>
      INTEGER , INTENT(IN) :: iswater<a name='2950'>
      INTEGER , INTENT(IN) :: num_veg_cat<a name='2951'>
      REAL , DIMENSION(1:num_veg_cat) , INTENT(INOUT):: landuse_frac<a name='2952'>
      INTEGER , INTENT(IN) :: num_special_bins , max_cats_per_bin , fl<a name='2953'>
      INTEGER , DIMENSION ( max_cats_per_bin * num_special_bins ) , INTENT(IN) :: cib<a name='2954'>
<a name='2955'>
      <font color=#447700>!  Local variables<a name='2956'></font>
<a name='2957'>
      REAL , DIMENSION(1:num_veg_cat) :: landuse_frac_work <font color=#447700>! copy of the input array, allows us to be wreckless<a name='2958'></font>
      INTEGER , DIMENSION ( max_cats_per_bin , num_special_bins ) :: cats_in_bin<a name='2959'>
      INTEGER :: ib , ic <font color=#447700>! indexes for the bin and the category loops<a name='2960'></font>
      REAL    , DIMENSION ( num_special_bins ) :: bin_max_val , bin_sum <font color=#447700>! max category value in this bin, sum of all cats in this bin<a name='2961'></font>
      INTEGER , DIMENSION ( num_special_bins ) :: bin_max_idx <font color=#447700>! index of this maximum category in this bin<a name='2962'></font>
      INTEGER :: bin_work , bin_orig <font color=#447700>! the bin from whence the maximum hails, respectively for the aggregated and the original data<a name='2963'></font>
      INTEGER :: max_cat_orig , max_cat_work<a name='2964'>
      REAL    :: max_val_orig , max_val_work<a name='2965'>
<a name='2966'>
      <font color=#447700>!  Find the max in the original.  If it is &gt;= 50%, no need to even be in here.<a name='2967'></font>
<a name='2968'>
      DO ic = 1 , num_veg_cat<a name='2969'>
         IF ( landuse_frac(ic) .GE. 0.5 ) THEN<a name='2970'>
            RETURN<a name='2971'>
         END IF<a name='2972'>
      END DO<a name='2973'>
<a name='2974'>
      <font color=#447700>!  Put the categories in the bin into a 2d array.<a name='2975'></font>
<a name='2976'>
      cats_in_bin = RESHAPE ( cib , (/  max_cats_per_bin , num_special_bins /) )<a name='2977'>
<a name='2978'>
      <font color=#447700>!  Make a copy of the incoming array so that we can eventually diff our working copy with<a name='2979'></font>
      <font color=#447700>!  the original.<a name='2980'></font>
<a name='2981'>
      landuse_frac_work = landuse_frac<a name='2982'>
<a name='2983'>
      <font color=#447700>!  Loop over each of the special bins that we know about.  Find the max values and the locations of such.<a name='2984'></font>
<a name='2985'>
      DO ib = 1 , num_special_bins<a name='2986'>
<a name='2987'>
         <font color=#447700>!  For this bin, we know about specific categories.  We get the sum of all of those<a name='2988'></font>
         <font color=#447700>!  categories that we know about for this bin, and we keep track of which category<a name='2989'></font>
         <font color=#447700>!  is dominant.<a name='2990'></font>
<a name='2991'>
         bin_sum    (ib) =  0<a name='2992'>
         bin_max_val(ib) = fl<a name='2993'>
<a name='2994'>
         cat_loop_accumulate : DO ic = 1 , max_cats_per_bin<a name='2995'>
            <a name='2996'>
            <font color=#447700>!  Have we run out of valid categories in this bin?  For example, we would not necessarily have<a name='2997'></font>
            <font color=#447700>!  the same number of tree categories as there are grass categories.<a name='2998'></font>
      <a name='2999'>
            IF      ( cats_in_bin(ic,ib) .EQ. fl ) THEN<a name='3000'>
               EXIT cat_loop_accumulate<a name='3001'>
            END IF<a name='3002'>
<a name='3003'>
            bin_sum(ib) = bin_sum(ib) + landuse_frac(cats_in_bin(ic,ib))<a name='3004'>
<a name='3005'>
            IF ( landuse_frac(cats_in_bin(ic,ib)) .GT. bin_max_val(ib) ) THEN<a name='3006'>
               bin_max_val(ib) = landuse_frac(cats_in_bin(ic,ib))<a name='3007'>
               bin_max_idx(ib) = cats_in_bin(ic,ib)<a name='3008'>
            END IF<a name='3009'>
<a name='3010'>
         END DO cat_loop_accumulate<a name='3011'>
<a name='3012'>
         cat_loop_assign : DO ic = 1 , max_cats_per_bin<a name='3013'>
            <a name='3014'>
            <font color=#447700>!  Plow through each cat in the bin.  If we find the dominant one, he gets the total sum.  If we land on<a name='3015'></font>
            <font color=#447700>!  the other guys in the bin, they get set back to zero to maintain the original aggregate influence.<a name='3016'></font>
      <a name='3017'>
            IF      ( cats_in_bin(ic,ib) .EQ. fl ) THEN<a name='3018'>
               EXIT cat_loop_assign<a name='3019'>
            ELSE IF ( cats_in_bin(ic,ib) .EQ. bin_max_idx(ib) ) THEN<a name='3020'>
               landuse_frac_work(cats_in_bin(ic,ib)) = bin_sum(ib)<a name='3021'>
            ELSE<a name='3022'>
               landuse_frac_work(cats_in_bin(ic,ib)) = 0<a name='3023'>
            END IF<a name='3024'>
<a name='3025'>
         END DO cat_loop_assign<a name='3026'>
<a name='3027'>
      END DO<a name='3028'>
<a name='3029'>
      <font color=#447700>!  Now we loop through the categorical data, and get the max+location for the original input data and the<a name='3030'></font>
      <font color=#447700>!  modified work data.  Water is not allowed to be a "max" category unless it is greater than 50%.  We hit <a name='3031'></font>
      <font color=#447700>!  that test up at the top already, so we can toss out water willy nilly here.<a name='3032'></font>
<a name='3033'>
      max_cat_orig = fl<a name='3034'>
      max_val_orig =  0<a name='3035'>
      max_cat_work = fl<a name='3036'>
      max_val_work =  0<a name='3037'>
<a name='3038'>
      DO ic = 1 , num_veg_cat<a name='3039'>
         IF ( ic .EQ. iswater ) THEN<a name='3040'>
            CYCLE<a name='3041'>
         END IF<a name='3042'>
         IF ( landuse_frac(ic) .GT. max_val_orig ) THEN<a name='3043'>
            max_val_orig = landuse_frac(ic)<a name='3044'>
            max_cat_orig = ic<a name='3045'>
         END IF<a name='3046'>
         IF ( landuse_frac_work(ic) .GT. max_val_work ) THEN<a name='3047'>
            max_val_work = landuse_frac_work(ic)<a name='3048'>
            max_cat_work = ic<a name='3049'>
         END IF<a name='3050'>
      END DO<a name='3051'>
<a name='3052'>
      <font color=#447700>!  Find the bin for the maximimum value of the original data.<a name='3053'></font>
<a name='3054'>
      bin_orig = -1<a name='3055'>
      bin_loop_orig : DO ib = 1 , num_special_bins<a name='3056'>
         cat_loop_orig : DO ic = 1 , max_cats_per_bin<a name='3057'>
            IF      ( cats_in_bin(ic,ib) .EQ. fl           ) THEN<a name='3058'>
               EXIT cat_loop_orig<a name='3059'>
            ELSE IF ( cats_in_bin(ic,ib) .EQ. max_cat_orig ) THEN<a name='3060'>
               bin_orig = ib<a name='3061'>
               EXIT bin_loop_orig<a name='3062'>
            END IF<a name='3063'>
         END DO cat_loop_orig<a name='3064'>
      END DO bin_loop_orig<a name='3065'>
<a name='3066'>
      <font color=#447700>!  Find the bin for the maximimum value of the aggregated data.<a name='3067'></font>
<a name='3068'>
      bin_work = -1<a name='3069'>
      bin_loop_work : DO ib = 1 , num_special_bins<a name='3070'>
         cat_loop_work : DO ic = 1 , max_cats_per_bin<a name='3071'>
            IF      ( cats_in_bin(ic,ib) .EQ. fl           ) THEN<a name='3072'>
               EXIT cat_loop_work<a name='3073'>
            ELSE IF ( cats_in_bin(ic,ib) .EQ. max_cat_work ) THEN<a name='3074'>
               bin_work = ib<a name='3075'>
               EXIT bin_loop_work<a name='3076'>
            END IF<a name='3077'>
         END DO cat_loop_work<a name='3078'>
      END DO bin_loop_work<a name='3079'>
<a name='3080'>
      <font color=#447700>!  So the big question is, did the aggregation change the bin?  If the aggregation does not change the resulting<a name='3081'></font>
      <font color=#447700>!  bin, then we leave everything alone.  However, if there would be a change in the eventual bin chosen by<a name='3082'></font>
      <font color=#447700>!  the simple dominant-category method, then we become pro-active interventionists and rectify this heinous<a name='3083'></font>
      <font color=#447700>!  injustice foisted upon the lowly flora.<a name='3084'></font>
<a name='3085'>
      IF ( bin_work .EQ. bin_orig ) THEN<a name='3086'>
         <font color=#447700>!  No op, we do nothing.<a name='3087'></font>
      ELSE<a name='3088'>
         DO ic = 1 , max_cats_per_bin<a name='3089'>
            landuse_frac(cats_in_bin(ic,bin_work)) = landuse_frac_work(cats_in_bin(ic,bin_work))<a name='3090'>
         END DO<a name='3091'>
      END IF<a name='3092'>
            <a name='3093'>
   END SUBROUTINE aggregate_categories_part2<a name='3094'>
<a name='3095'>
END MODULE module_soil_pre<a name='3096'>
<a name='3097'>
<A NAME='SKIP_MIDDLE_POINTS_T'><A href='../../html_code/share/module_soil_pre.F.html#SKIP_MIDDLE_POINTS_T' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3098'>
<font color=#993300>FUNCTION </font><font color=#cc0000>skip_middle_points_t</font> ( ids , ide , jds , jde , &amp;,<A href='../../call_from/SKIP_MIDDLE_POINTS_T.html' TARGET='index'>2</A><a name='3099'>
                                i_in , j_in , width ,   &amp;<a name='3100'>
                                subtleties_exist )      &amp;<a name='3101'>
                       RESULT ( skip_it )<a name='3102'>
 <a name='3103'>
   IMPLICIT NONE<a name='3104'>
<a name='3105'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde<a name='3106'>
   INTEGER , INTENT(IN) :: i_in , j_in , width<a name='3107'>
   LOGICAL , INTENT(IN) :: subtleties_exist<a name='3108'>
   <a name='3109'>
   LOGICAL              :: skip_it<a name='3110'>
<a name='3111'>
   INTEGER , PARAMETER :: slop = 0<a name='3112'>
<a name='3113'>
   IF ( ( subtleties_exist ) .OR. ( ide .EQ. 3 ) .OR. ( jde .EQ. 3 ) ) THEN<a name='3114'>
      skip_it = .FALSE.<a name='3115'>
   ELSE<a name='3116'>
      IF ( ( i_in .GE. ids+width+slop ) .AND. ( i_in .LE. ide-1-width-slop )   .AND. &amp;<a name='3117'>
           ( j_in .GE. jds+width+slop ) .AND. ( j_in .LE. jde-1-width-slop ) ) THEN<a name='3118'>
         skip_it = .TRUE.<a name='3119'>
      ELSE<a name='3120'>
         skip_it = .FALSE.<a name='3121'>
      END IF<a name='3122'>
   END IF<a name='3123'>
<a name='3124'>
END FUNCTION skip_middle_points_t<a name='3125'>
<a name='3126'>
#else<a name='3127'>
<a name='3128'>
<A NAME='MODULE_SOIL_PRE'><A href='../../html_code/share/module_soil_pre.F.html#MODULE_SOIL_PRE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3129'>
<font color=#993300>MODULE </font><font color=#cc0000>module_soil_pre</font> <A href='../../call_to/MODULE_SOIL_PRE.html' TARGET='index'>5</A><a name='3130'>
<a name='3131'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/module_soil_pre.F.html#SKIP_MIDDLE_POINTS_T' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_27"><a name='3132'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/module_soil_pre.F.html#SKIP_MIDDLE_POINTS_T' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_195"><a name='3133'>
<a name='3134'>
CONTAINS<a name='3135'>
<a name='3136'>
<A NAME='ADJUST_FOR_SEAICE_PRE'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3137'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_for_seaice_pre</font> ( xice , landmask , tsk , ivgtyp , vegcat , lu_index , &amp;,<A href='../../call_from/ADJUST_FOR_SEAICE_PRE.html' TARGET='index'>6</A><a name='3138'>
                                      xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='3139'>
                                      soilcbot , tmn , &amp;<a name='3140'>
                                      seaice_threshold , &amp;<a name='3141'>
                                      fractional_seaice, &amp;<a name='3142'>
                                      num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='3143'>
                                      iswater , isice , &amp;<a name='3144'>
                                      scheme , &amp;<a name='3145'>
                                      ids , ide , jds , jde , kds , kde , &amp;<a name='3146'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='3147'>
                                      its , ite , jts , jte , kts , kte )<a name='3148'>
<a name='3149'>
      IMPLICIT NONE<a name='3150'>
<a name='3151'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='3152'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='3153'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='3154'>
                              iswater , isice<a name='3155'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat , scheme<a name='3156'>
<a name='3157'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landusef<a name='3158'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(INOUT):: soilctop<a name='3159'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(INOUT):: soilcbot<a name='3160'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='3161'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask , xice , tsk , lu_index , &amp;<a name='3162'>
                                                           vegcat, xland , soilcat , tmn<a name='3163'>
      REAL , INTENT(IN) :: seaice_threshold<a name='3164'>
<a name='3165'>
      INTEGER :: i , j , num_seaice_changes , loop<a name='3166'>
      CHARACTER (LEN=132) :: message<a name='3167'>
<a name='3168'>
<a name='3169'>
      integer, intent(in) :: fractional_seaice<a name='3170'>
      real                :: xice_threshold<a name='3171'>
<a name='3172'>
      IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='3173'>
         xice_threshold = 0.5<a name='3174'>
      ELSEIF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3175'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1443">("NMM cannot use FRACTIONAL_SEAICE = 1")<a name='3176'>
         xice_threshold = 0.02<a name='3177'>
      ENDIF<a name='3178'>
<a name='3179'>
      fix_seaice : SELECT CASE ( scheme )<a name='3180'>
<a name='3181'>
         CASE ( SLABSCHEME )<a name='3182'>
            DO j = jts , MIN(jde-1,jte)<a name='3183'>
               DO i = its , MIN(ide-1,ite)<a name='3184'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='3185'>
                     xice(i,j) = 0.<a name='3186'>
                     num_seaice_changes = num_seaice_changes + 1<a name='3187'>
                  END IF<a name='3188'>
               END DO<a name='3189'>
            END DO<a name='3190'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='3191'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='3192'>
               'Total pre number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='3193'>
               num_seaice_changes<a name='3194'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1104"> ( 0 , message )<a name='3195'>
            END IF<a name='3196'>
            num_seaice_changes = 0<a name='3197'>
            DO j = jts , MIN(jde-1,jte)<a name='3198'>
               DO i = its , MIN(ide-1,ite)<a name='3199'>
                  IF ( ( xice(i,j) .GE. xice_threshold ) .OR. &amp;<a name='3200'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='3201'>
                     IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='3202'>
                        xice(i,j) = 1.0<a name='3203'>
                     ENDIF<a name='3204'>
                     num_seaice_changes = num_seaice_changes + 1<a name='3205'>
                     tmn(i,j) = 271.4<a name='3206'>
                     vegcat(i,j)=isice<a name='3207'>
                     lu_index(i,j)=ivgtyp(i,j)<a name='3208'>
                     landmask(i,j)=1.<a name='3209'>
                     xland(i,j)=1.<a name='3210'>
                     DO loop=1,num_veg_cat<a name='3211'>
                        landusef(i,loop,j)=0.<a name='3212'>
                     END DO<a name='3213'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='3214'>
<a name='3215'>
                     isltyp(i,j) = 16<a name='3216'>
                     soilcat(i,j)=isltyp(i,j)<a name='3217'>
                     DO loop=1,num_soil_top_cat<a name='3218'>
                        soilctop(i,loop,j)=0<a name='3219'>
                     END DO<a name='3220'>
                     DO loop=1,num_soil_bot_cat<a name='3221'>
                        soilcbot(i,loop,j)=0<a name='3222'>
                     END DO<a name='3223'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='3224'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='3225'>
                  ELSE<a name='3226'>
                     xice(i,j) = 0.0<a name='3227'>
                  END IF<a name='3228'>
               END DO<a name='3229'>
            END DO<a name='3230'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='3231'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='3232'>
               'Total pre number of sea ice location changes (water to land) = ', num_seaice_changes<a name='3233'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_PRE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1105"> ( 0 , message )<a name='3234'>
            END IF<a name='3235'>
<a name='3236'>
         CASE ( LSMSCHEME )<a name='3237'>
         CASE ( RUCLSMSCHEME )<a name='3238'>
<a name='3239'>
      END SELECT fix_seaice<a name='3240'>
<a name='3241'>
   END SUBROUTINE adjust_for_seaice_pre<a name='3242'>
<a name='3243'>
<A NAME='ADJUST_FOR_SEAICE_POST'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3244'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_for_seaice_post</font> ( xice , landmask , tsk , ivgtyp , vegcat , lu_index , &amp;,<A href='../../call_from/ADJUST_FOR_SEAICE_POST.html' TARGET='index'>11</A><a name='3245'>
                                      xland , landusef , isltyp , soilcat , soilctop , &amp;<a name='3246'>
                                      soilcbot , tmn , &amp;<a name='3247'>
                                      tslb , smois , sh2o , &amp;<a name='3248'>
                                      seaice_threshold , &amp;<a name='3249'>
                                      fractional_seaice, &amp;<a name='3250'>
                                      num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='3251'>
                                      num_soil_layers , &amp;<a name='3252'>
                                      iswater , isice , &amp;<a name='3253'>
                                      scheme , &amp;<a name='3254'>
                                      ids , ide , jds , jde , kds , kde , &amp;<a name='3255'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='3256'>
                                      its , ite , jts , jte , kts , kte )<a name='3257'>
<a name='3258'>
      IMPLICIT NONE<a name='3259'>
<a name='3260'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='3261'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='3262'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='3263'>
                              iswater , isice<a name='3264'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat , scheme<a name='3265'>
      INTEGER , INTENT(IN) :: num_soil_layers<a name='3266'>
<a name='3267'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landusef<a name='3268'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(INOUT):: soilctop<a name='3269'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(INOUT):: soilcbot<a name='3270'>
      REAL , DIMENSION(ims:ime,1:num_soil_layers,jms:jme) , INTENT(INOUT):: tslb , smois , sh2o<a name='3271'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='3272'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask , xice , tsk , lu_index , &amp;<a name='3273'>
                                                           vegcat, xland , soilcat , tmn<a name='3274'>
      REAL , INTENT(IN) :: seaice_threshold<a name='3275'>
      REAL :: total_depth , mid_point_depth<a name='3276'>
<a name='3277'>
      INTEGER :: i , j , num_seaice_changes , loop<a name='3278'>
      CHARACTER (LEN=132) :: message<a name='3279'>
<a name='3280'>
      integer, intent(in) :: fractional_seaice<a name='3281'>
      real                :: xice_threshold<a name='3282'>
      IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='3283'>
         xice_threshold = 0.5<a name='3284'>
      ELSEIF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3285'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1444">("NMM cannot use FRACTIONAL_SEAICE = 1")<a name='3286'>
         xice_threshold = 0.02<a name='3287'>
      ENDIF<a name='3288'>
      fix_seaice : SELECT CASE ( scheme )<a name='3289'>
<a name='3290'>
         CASE ( SLABSCHEME )<a name='3291'>
<a name='3292'>
<font color=#447700>!SBAO<a name='3293'></font>
         CASE ( LSMSCHEME, GFDLSLAB )<a name='3294'>
            DO j = jts , MIN(jde-1,jte)<a name='3295'>
               DO i = its , MIN(ide-1,ite)<a name='3296'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='3297'>
                     xice(i,j) = 0.<a name='3298'>
                     num_seaice_changes = num_seaice_changes + 1<a name='3299'>
                  END IF<a name='3300'>
               END DO<a name='3301'>
            END DO<a name='3302'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='3303'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='3304'>
               'Total post number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='3305'>
               num_seaice_changes<a name='3306'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1106"> ( 0 , message )<a name='3307'>
            END IF<a name='3308'>
            num_seaice_changes = 0<a name='3309'>
            DO j = jts , MIN(jde-1,jte)<a name='3310'>
               DO i = its , MIN(ide-1,ite)<a name='3311'>
                  IF ( ( xice(i,j) .GE. xice_threshold ) .OR. &amp;<a name='3312'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN<a name='3313'>
                     IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='3314'>
                        xice(i,j) = 1.0<a name='3315'>
                     ENDIF<a name='3316'>
                     num_seaice_changes = num_seaice_changes + 1<a name='3317'>
                     tmn(i,j) = 271.16<a name='3318'>
                     vegcat(i,j)=isice<a name='3319'>
                     lu_index(i,j)=ivgtyp(i,j)<a name='3320'>
                     landmask(i,j)=1.<a name='3321'>
                     xland(i,j)=1.<a name='3322'>
                     DO loop=1,num_veg_cat<a name='3323'>
                        landusef(i,loop,j)=0.<a name='3324'>
                     END DO<a name='3325'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='3326'>
<a name='3327'>
                     isltyp(i,j) = 16<a name='3328'>
                     soilcat(i,j)=isltyp(i,j)<a name='3329'>
                     DO loop=1,num_soil_top_cat<a name='3330'>
                        soilctop(i,loop,j)=0<a name='3331'>
                     END DO<a name='3332'>
                     DO loop=1,num_soil_bot_cat<a name='3333'>
                        soilcbot(i,loop,j)=0<a name='3334'>
                     END DO<a name='3335'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='3336'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='3337'>
<a name='3338'>
                     total_depth = 3. <font color=#447700>! ice is 3 m deep, num_soil_layers equispaced layers<a name='3339'></font>
                     DO loop = 1,num_soil_layers<a name='3340'>
                        mid_point_depth=(total_depth/num_soil_layers)/2. + &amp;<a name='3341'>
                                        (loop-1)*(total_depth/num_soil_layers)<a name='3342'>
                        tslb(i,loop,j) = ( (total_depth-mid_point_depth)*tsk(i,j) + &amp;<a name='3343'>
                                            mid_point_depth*tmn(i,j) ) / total_depth<a name='3344'>
                     END DO<a name='3345'>
<a name='3346'>
                     DO loop=1,num_soil_layers<a name='3347'>
                        smois(i,loop,j) = 1.0<a name='3348'>
                        sh2o(i,loop,j)  = 0.0<a name='3349'>
                     END DO<a name='3350'>
                  ELSE<a name='3351'>
                     xice(i,j) = 0.0<a name='3352'>
                  END IF<a name='3353'>
               END DO<a name='3354'>
            END DO<a name='3355'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='3356'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='3357'>
               'Total post number of sea ice location changes (water to land) = ', num_seaice_changes<a name='3358'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1107"> ( 0 , message )<a name='3359'>
            END IF<a name='3360'>
<a name='3361'>
         CASE ( RUCLSMSCHEME )<a name='3362'>
            DO j = jts , MIN(jde-1,jte)<a name='3363'>
               DO i = its , MIN(ide-1,ite)<a name='3364'>
                  IF ( xice(i,j) .GT. 200.0 ) THEN<a name='3365'>
                     xice(i,j) = 0.<a name='3366'>
                     num_seaice_changes = num_seaice_changes + 1<a name='3367'>
                  END IF<a name='3368'>
               END DO<a name='3369'>
            END DO<a name='3370'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='3371'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='3372'>
               'Total post number of sea ice locations removed (due to FLAG values) = ', &amp;<a name='3373'>
               num_seaice_changes<a name='3374'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1108"> ( 0 , message )<a name='3375'>
            END IF<a name='3376'>
            num_seaice_changes = 0<a name='3377'>
            DO j = jts , MIN(jde-1,jte)<a name='3378'>
               DO i = its , MIN(ide-1,ite)<a name='3379'>
                  IF ( ( xice(i,j) .GE. xice_threshold ) .OR. &amp;<a name='3380'>
                       ( ( landmask(i,j) .LT. 0.5 ) .AND. ( tsk(i,j) .LT. seaice_threshold ) ) ) THEN <a name='3381'>
<a name='3382'>
                     IF ( FRACTIONAL_SEAICE == 0 ) THEN<a name='3383'>
                        xice(i,j) = 1.0<a name='3384'>
                     ELSE<a name='3385'>
                        xice(i,j)=max(0.25,xice(i,j))<a name='3386'>
                     ENDIF<a name='3387'>
                     num_seaice_changes = num_seaice_changes + 1<a name='3388'>
                     if(landmask(i,j) .LT. 0.5 )tmn(i,j) = 271.4<a name='3389'>
                     vegcat(i,j)=isice<a name='3390'>
                     ivgtyp(i,j)=isice<a name='3391'>
                     lu_index(i,j)=isice<a name='3392'>
                     landmask(i,j)=1.<a name='3393'>
                     xland(i,j)=1.<a name='3394'>
                     DO loop=1,num_veg_cat<a name='3395'>
                        landusef(i,loop,j)=0.<a name='3396'>
                     END DO<a name='3397'>
                     landusef(i,ivgtyp(i,j),j)=1.<a name='3398'>
<a name='3399'>
                     isltyp(i,j) = 16<a name='3400'>
                     soilcat(i,j)=isltyp(i,j)<a name='3401'>
                     DO loop=1,num_soil_top_cat<a name='3402'>
                        soilctop(i,loop,j)=0<a name='3403'>
                     END DO<a name='3404'>
                     DO loop=1,num_soil_bot_cat<a name='3405'>
                        soilcbot(i,loop,j)=0<a name='3406'>
                     END DO<a name='3407'>
                     soilctop(i,isltyp(i,j),j)=1.<a name='3408'>
                     soilcbot(i,isltyp(i,j),j)=1.<a name='3409'>
<a name='3410'>
                 total_depth = 3. <font color=#447700>! ice is 3 m deep, num_soil_layers equispaced layers<a name='3411'></font>
                       tslb(i,1,j) = tsk(i,j)<a name='3412'>
                       tslb(i,num_soil_layers,j) = tmn(i,j)<a name='3413'>
                     DO loop = 2,num_soil_layers-1<a name='3414'>
                        mid_point_depth=(total_depth/num_soil_layers)/4. + &amp;<a name='3415'>
                                        (loop-2)*(total_depth/num_soil_layers)<a name='3416'>
                        tslb(i,loop,j) = ( (total_depth-mid_point_depth)*tsk(i,j) + &amp;<a name='3417'>
                                            mid_point_depth*tmn(i,j) ) / total_depth<a name='3418'>
                     END DO<a name='3419'>
<a name='3420'>
                     DO loop=1,num_soil_layers<a name='3421'>
                        smois(i,loop,j) = 1.0<a name='3422'>
                        sh2o(i,loop,j)  = 0.0<a name='3423'>
                     END DO<a name='3424'>
                  ELSE IF ( xice(i,j) .LT. xice_threshold ) THEN<a name='3425'>
                     xice(i,j) = 0.<a name='3426'>
                  END IF<a name='3427'>
               END DO<a name='3428'>
            END DO<a name='3429'>
            IF ( num_seaice_changes .GT. 0 ) THEN<a name='3430'>
               WRITE ( message , FMT='(A,I6)' ) &amp;<a name='3431'>
               'Total post number of sea ice location changes (water to land) = ', num_seaice_changes<a name='3432'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_FOR_SEAICE_POST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1109"> ( 0 , message )<a name='3433'>
            END IF<a name='3434'>
<a name='3435'>
      END SELECT fix_seaice<a name='3436'>
<a name='3437'>
   END SUBROUTINE adjust_for_seaice_post<a name='3438'>
<a name='3439'>
<A NAME='PROCESS_PERCENT_CAT_NEW'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3440'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_percent_cat_new</font> ( landmask ,  &amp; <A href='../../call_to/PROCESS_PERCENT_CAT_NEW.html' TARGET='index'>2</A>,<A href='../../call_from/PROCESS_PERCENT_CAT_NEW.html' TARGET='index'>14</A><a name='3441'>
                                landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='3442'>
                                isltyp , ivgtyp , &amp;<a name='3443'>
                                num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='3444'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='3445'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='3446'>
                                its , ite , jts , jte , kts , kte , &amp;<a name='3447'>
                                iswater )<a name='3448'>
<a name='3449'>
      IMPLICIT NONE<a name='3450'>
<a name='3451'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='3452'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='3453'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='3454'>
                              iswater<a name='3455'>
      INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='3456'>
      REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landuse_frac<a name='3457'>
      REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(IN):: soil_top_cat<a name='3458'>
      REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(IN):: soil_bot_cat<a name='3459'>
      INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='3460'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: landmask<a name='3461'>
<a name='3462'>
      INTEGER :: i , j , l , ll, dominant_index<a name='3463'>
      REAL :: dominant_value<a name='3464'>
<a name='3465'>
#if ( WRF_CHEM == 1 )<a name='3466'>
<font color=#447700>!      REAL :: lwthresh = .99<a name='3467'></font>
      REAL :: lwthresh = .50<a name='3468'>
#else<a name='3469'>
      REAL :: lwthresh = .50<a name='3470'>
#endif<a name='3471'>
<a name='3472'>
      INTEGER , PARAMETER :: iswater_soil = 14<a name='3473'>
      INTEGER :: iforce<a name='3474'>
      CHARACTER (LEN=1024) :: message<a name='3475'>
<a name='3476'>
      <font color=#447700>!  Sanity check on the 50/50 points<a name='3477'></font>
<a name='3478'>
      DO j = jts , MIN(jde-1,jte)<a name='3479'>
         DO i = its , MIN(ide-1,ite)<a name='3480'>
            dominant_value = landuse_frac(i,iswater,j)<a name='3481'>
            IF ( dominant_value .EQ. lwthresh ) THEN<a name='3482'>
               DO l = 1 , num_veg_cat<a name='3483'>
                  IF ( l .EQ. iswater ) CYCLE<a name='3484'>
                  IF ( landuse_frac(i,l,j) .EQ. lwthresh ) THEN<a name='3485'>
                write(message, FMT='(I4,I4,A,I4,A,F12.4)') i,j,' water and category ',l,' both at 50%, landmask is ',landmask(i,j)<a name='3486'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1375"> ( message )<a name='3487'>
                     landuse_frac(i,l,j) = lwthresh - .01<a name='3488'>
                     landuse_frac(i,iswater,j) = 1. - (lwthresh + 0.01)<a name='3489'>
                  END IF<a name='3490'>
               END DO<a name='3491'>
            END IF<a name='3492'>
         END DO<a name='3493'>
      END DO<a name='3494'>
<a name='3495'>
      <font color=#447700>!  Compute the dominant VEGETATION INDEX.<a name='3496'></font>
<a name='3497'>
      DO j = jts , MIN(jde-1,jte)<a name='3498'>
         DO i = its , MIN(ide-1,ite)<a name='3499'>
            dominant_value = landuse_frac(i,1,j)<a name='3500'>
            dominant_index = 1<a name='3501'>
            DO l = 2 , num_veg_cat<a name='3502'>
               IF        ( l .EQ. iswater ) THEN<a name='3503'>
                  <font color=#447700>! wait a bit<a name='3504'></font>
               ELSE IF ( ( l .NE. iswater ) .AND. ( landuse_frac(i,l,j) .GT. dominant_value ) ) THEN<a name='3505'>
                  dominant_value = landuse_frac(i,l,j)<a name='3506'>
                  dominant_index = l<a name='3507'>
               END IF<a name='3508'>
            END DO<a name='3509'>
            IF ( landuse_frac(i,iswater,j) .GT. lwthresh ) THEN<a name='3510'>
               dominant_value = landuse_frac(i,iswater,j)<a name='3511'>
               dominant_index = iswater<a name='3512'>
#if 0<a name='3513'>
si needs to beef up consistency checks before we can use this part<a name='3514'>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh) .AND. &amp;<a name='3515'>
                      ( dominant_value .EQ. lwthresh) ) THEN<a name='3516'>
               <font color=#447700>! no op<a name='3517'></font>
#else<a name='3518'>
ELSEIF((landuse_frac(i,iswater,j).EQ.lwthresh).AND.(dominant_value.EQ.lwthresh).and.(dominant_index.LT.iswater))THEN<a name='3519'>
write(message,*)'temporary SI landmask fix'<a name='3520'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1376">(trim(message))<a name='3521'>
<font color=#447700>! no op<a name='3522'></font>
ELSEIF((landuse_frac(i,iswater,j).EQ.lwthresh).AND.(dominant_value.EQ.lwthresh).and.(dominant_index.GT.iswater))THEN<a name='3523'>
write(message,*)'temporary SI landmask fix'<a name='3524'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1377">(trim(message))<a name='3525'>
dominant_value = landuse_frac(i,iswater,j)<a name='3526'>
dominant_index = iswater<a name='3527'>
#endif<a name='3528'>
            ELSE IF ( ( landuse_frac(i,iswater,j) .EQ. lwthresh ) .AND. &amp;<a name='3529'>
                      ( dominant_value .LT. lwthresh ) ) THEN<a name='3530'>
               dominant_value = landuse_frac(i,iswater,j)<a name='3531'>
               dominant_index = iswater<a name='3532'>
            END IF<a name='3533'>
            IF      ( dominant_index .EQ. iswater ) THEN<a name='3534'>
if(landmask(i,j).gt.lwthresh) then<a name='3535'>
write(message,*) 'changing to water at point ',i,j<a name='3536'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1378">(trim(message))<a name='3537'>
write(message,*)  nint(landuse_frac(i,:,j)*100)<a name='3538'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1379">(trim(message))<a name='3539'>
endif<a name='3540'>
               landmask(i,j) = 0<a name='3541'>
            ELSE IF ( dominant_index .NE. iswater ) THEN<a name='3542'>
if(landmask(i,j).lt.lwthresh) then<a name='3543'>
write(message,*) 'changing to land at point ',i,j<a name='3544'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1380">(trim(message))<a name='3545'>
write(message,*) nint(landuse_frac(i,:,j)*100)<a name='3546'>
call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1381">(trim(message))<a name='3547'>
endif<a name='3548'>
               landmask(i,j) = 1<a name='3549'>
            END IF<a name='3550'>
            ivgtyp(i,j) = dominant_index<a name='3551'>
         END DO<a name='3552'>
      END DO<a name='3553'>
<a name='3554'>
      <font color=#447700>!  Compute the dominant SOIL TEXTURE INDEX, TOP.<a name='3555'></font>
<a name='3556'>
      iforce = 0<a name='3557'>
      DO i = its , MIN(ide-1,ite)<a name='3558'>
         DO j = jts , MIN(jde-1,jte)<a name='3559'>
            dominant_value = soil_top_cat(i,1,j)<a name='3560'>
            dominant_index = 1<a name='3561'>
            IF ( landmask(i,j) .GT. lwthresh ) THEN<a name='3562'>
               DO l = 2 , num_soil_top_cat<a name='3563'>
                  IF ( ( l .NE. iswater_soil ) .AND. ( soil_top_cat(i,l,j) .GT. dominant_value ) ) THEN<a name='3564'>
                     dominant_value = soil_top_cat(i,l,j)<a name='3565'>
                     dominant_index = l<a name='3566'>
                  END IF<a name='3567'>
               END DO<a name='3568'>
               IF ( dominant_value .LT. 0.01 ) THEN<a name='3569'>
                  iforce = iforce + 1<a name='3570'>
                  WRITE ( message , FMT = '(A,I4,I4)' ) &amp;<a name='3571'>
                  'based on landuse, changing soil to land at point ',i,j<a name='3572'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1110">(1,message)<a name='3573'>
<font color=#447700>!atec             WRITE ( message , FMT = '(16(i3,1x))' ) &amp;<a name='3574'></font>
<font color=#447700>!atec             1, 2, 3, 4, 5, 6, 7, 8, 9, 10,11,12, 13, 14, 15, 16<a name='3575'></font>
<font color=#447700>!atec             CALL wrf_debug(1,message)<a name='3576'></font>
<font color=#447700>!atec             WRITE ( message , FMT = '(16(i3,1x))' ) &amp;<a name='3577'></font>
<font color=#447700>!atec             nint(soil_top_cat(i,:,j)*100)<a name='3578'></font>
<font color=#447700>!atec             CALL wrf_debug(1,message)<a name='3579'></font>
                  dominant_index = 8<a name='3580'>
               END IF<a name='3581'>
            ELSE<a name='3582'>
               dominant_index = iswater_soil<a name='3583'>
            END IF<a name='3584'>
            isltyp(i,j) = dominant_index<a name='3585'>
         END DO<a name='3586'>
      END DO<a name='3587'>
<a name='3588'>
if(iforce.ne.0)then<a name='3589'>
WRITE(message,FMT='(A,I4,A,I6)' ) &amp;<a name='3590'>
'forcing artificial silty clay loam at ',iforce,' points, out of ',&amp;<a name='3591'>
(MIN(ide-1,ite)-its+1)*(MIN(jde-1,jte)-jts+1)<a name='3592'>
CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1111">(0,message)<a name='3593'>
endif<a name='3594'>
<a name='3595'>
   END SUBROUTINE process_percent_cat_new<a name='3596'>
<a name='3597'>
<A NAME='PROCESS_SOIL_REAL'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3598'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_soil_real</font> ( tsk , tmn , &amp;,<A href='../../call_from/PROCESS_SOIL_REAL.html' TARGET='index'>33</A><a name='3599'>
                                landmask , sst , &amp;<a name='3600'>
                                st_input , sm_input , sw_input , st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='3601'>
                                zs , dzs , tslb , smois , sh2o , &amp;<a name='3602'>
                                flag_sst , flag_soilt000, flag_soilm000, &amp;<a name='3603'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='3604'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='3605'>
                                its , ite , jts , jte , kts , kte , &amp;<a name='3606'>
                                sf_surface_physics , num_soil_layers , real_data_init_type , &amp;<a name='3607'>
                                num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='3608'>
                                num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc )<a name='3609'>
<a name='3610'>
      IMPLICIT NONE<a name='3611'>
<a name='3612'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='3613'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='3614'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='3615'>
                              sf_surface_physics , num_soil_layers , real_data_init_type , &amp;<a name='3616'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='3617'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc<a name='3618'>
<a name='3619'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilm000<a name='3620'>
<a name='3621'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='3622'>
<a name='3623'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='3624'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='3625'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='3626'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='3627'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='3628'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='3629'>
<a name='3630'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='3631'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='3632'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='3633'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='3634'>
<a name='3635'>
      INTEGER :: i , j , l , dominant_index , num_soil_cat , num_veg_cat<a name='3636'>
      REAL :: dominant_value<a name='3637'>
<a name='3638'>
      <font color=#447700>!  Initialize the soil depth, and the soil temperature and moisture.<a name='3639'></font>
<a name='3640'>
      IF      ( ( sf_surface_physics .EQ. SLABSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='3641'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1'>init_soil_depth_1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_1_3"> ( zs , dzs , num_soil_layers )<a name='3642'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_REAL'>init_soil_1_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_1_REAL_2"> ( tsk , tmn , tslb , zs , dzs , num_soil_layers , real_data_init_type , &amp;<a name='3643'>
                                 landmask , sst , flag_sst , &amp;<a name='3644'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='3645'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='3646'>
                                 its , ite , jts , jte , kts , kte )<a name='3647'>
<a name='3648'>
      ELSE IF ( ( sf_surface_physics .EQ. LSMSCHEME .or. sf_surface_physics .eq. 88 ) .AND. &amp;<a name='3649'>
                ( num_soil_layers .GT. 1 ) ) THEN<a name='3650'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_5"> ( zs , dzs , num_soil_layers )<a name='3651'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL'>init_soil_2_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_REAL_3"> ( tsk , tmn , smois , sh2o , tslb , &amp;<a name='3652'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='3653'>
                                 zs , dzs , &amp;<a name='3654'>
                                 st_levels_input , sm_levels_input , sw_levels_input ,&amp;<a name='3655'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='3656'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='3657'>
                                 flag_sst , flag_soilt000 , flag_soilm000, &amp;<a name='3658'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='3659'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='3660'>
                                 its , ite , jts , jte , kts , kte )<a name='3661'>
<font color=#447700>!        CALL init_soil_old ( tsk , tmn , &amp;<a name='3662'></font>
<font color=#447700>!                             smois , tslb , zs , dzs , num_soil_layers , &amp;<a name='3663'></font>
<font color=#447700>!                             st000010_input , st010040_input , st040100_input , st100200_input , &amp;<a name='3664'></font>
<font color=#447700>!                             st010200_input , &amp;<a name='3665'></font>
<font color=#447700>!                             sm000010_input , sm010040_input , sm040100_input , sm100200_input , &amp;<a name='3666'></font>
<font color=#447700>!                             sm010200_input , &amp;<a name='3667'></font>
<font color=#447700>!                             landmask_input , sst_input , &amp;<a name='3668'></font>
<font color=#447700>!                             ids , ide , jds , jde , kds , kde , &amp;<a name='3669'></font>
<font color=#447700>!                             ims , ime , jms , jme , kms , kme , &amp;<a name='3670'></font>
<font color=#447700>!                             its , ite , jts , jte , kts , kte )<a name='3671'></font>
      ELSE IF ( ( sf_surface_physics .EQ. NOAHMPSCHEME .or. sf_surface_physics .eq. 88 ) .AND. &amp;<a name='3672'>
                ( num_soil_layers .GT. 1 ) ) THEN<a name='3673'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_6"> ( zs , dzs , num_soil_layers )<a name='3674'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL'>init_soil_2_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_REAL_4"> ( tsk , tmn , smois , sh2o , tslb , &amp;<a name='3675'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='3676'>
                                 zs , dzs , &amp;<a name='3677'>
                                 st_levels_input , sm_levels_input , sw_levels_input ,&amp;<a name='3678'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='3679'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='3680'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='3681'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='3682'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='3683'>
                                 its , ite , jts , jte , kts , kte )<a name='3684'>
#if 0<a name='3685'>
<font color=#447700>!CLM<a name='3686'></font>
      ELSE IF ( ( sf_surface_physics .EQ. CLMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='3687'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_4'>init_soil_depth_4</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_4_2"> ( zs , dzs , num_soil_layers )<a name='3688'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL'>init_soil_4_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_4_REAL_2"> ( tsk , tmn , smois , sh2o , tslb , &amp;<a name='3689'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='3690'>
                                 zs , dzs , &amp;<a name='3691'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='3692'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='3693'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='3694'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='3695'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='3696'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='3697'>
                                 its , ite , jts , jte , kts , kte )<a name='3698'>
<font color=#447700>!        CALL init_soil_old ( tsk , tmn , &amp;<a name='3699'></font>
<font color=#447700>!                             smois , tslb , zs , dzs , num_soil_layers , &amp;<a name='3700'></font>
<font color=#447700>!                             st000010_input , st010040_input , st040100_input , st100200_input , &amp;<a name='3701'></font>
<font color=#447700>!                             st010200_input , &amp;<a name='3702'></font>
<font color=#447700>!                             sm000010_input , sm010040_input , sm040100_input , sm100200_input , &amp;<a name='3703'></font>
<font color=#447700>!                             sm010200_input , &amp;<a name='3704'></font>
<font color=#447700>!                             landmask_input , sst_input , &amp;<a name='3705'></font>
<font color=#447700>!                             ids , ide , jds , jde , kds , kde , &amp;<a name='3706'></font>
<font color=#447700>!                             ims , ime , jms , jme , kms , kme , &amp;<a name='3707'></font>
<font color=#447700>!                             its , ite , jts , jte , kts , kte )<a name='3708'></font>
#endif<a name='3709'>
      ELSE IF ( ( sf_surface_physics .EQ. RUCLSMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='3710'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3'>init_soil_depth_3</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_3_3"> ( zs , dzs , num_soil_layers )<a name='3711'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL'>init_soil_3_real</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_3_REAL_3"> ( tsk , tmn , smois , tslb , &amp;<a name='3712'>
                                 st_input , sm_input , landmask , sst , &amp;<a name='3713'>
                                 zs , dzs , &amp;<a name='3714'>
                                 st_levels_input , sm_levels_input , &amp;<a name='3715'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input , &amp;<a name='3716'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='3717'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='3718'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='3719'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='3720'>
                                 its , ite , jts , jte , kts , kte )<a name='3721'>
      END IF<a name='3722'>
<a name='3723'>
   END SUBROUTINE process_soil_real<a name='3724'>
<a name='3725'>
<A NAME='PROCESS_SOIL_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3726'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>process_soil_ideal</font> ( xland,xice,vegfra,snow,canwat,  &amp;,<A href='../../call_from/PROCESS_SOIL_IDEAL.html' TARGET='index'>14</A><a name='3727'>
                                   ivgtyp,isltyp,tslb,smois, &amp;<a name='3728'>
                                   tsk,tmn,zs,dzs,           &amp;<a name='3729'>
                                   num_soil_layers,          &amp;<a name='3730'>
                                   sf_surface_physics ,      &amp;<a name='3731'>
                                   ids,ide, jds,jde, kds,kde,&amp;<a name='3732'>
                                   ims,ime, jms,jme, kms,kme,&amp;<a name='3733'>
                                   its,ite, jts,jte, kts,kte )<a name='3734'>
<a name='3735'>
      IMPLICIT NONE<a name='3736'>
<a name='3737'>
      INTEGER, INTENT(IN) ::ids,ide, jds,jde, kds,kde,  &amp;<a name='3738'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='3739'>
                            its,ite, jts,jte, kts,kte<a name='3740'>
<a name='3741'>
      INTEGER, INTENT(IN) :: num_soil_layers , sf_surface_physics<a name='3742'>
<a name='3743'>
      REAL, DIMENSION( ims:ime, num_soil_layers, jms:jme ) , INTENT(INOUT) :: smois, tslb<a name='3744'>
<a name='3745'>
      REAL, DIMENSION(num_soil_layers), INTENT(OUT) :: dzs,zs<a name='3746'>
<a name='3747'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT) :: tsk, tmn<a name='3748'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: xland, snow, canwat, xice, vegfra<a name='3749'>
      INTEGER, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: ivgtyp, isltyp<a name='3750'>
<a name='3751'>
      <font color=#447700>!  Local variables.<a name='3752'></font>
<a name='3753'>
      INTEGER :: itf,jtf<a name='3754'>
<a name='3755'>
      itf=MIN(ite,ide-1)<a name='3756'>
      jtf=MIN(jte,jde-1)<a name='3757'>
<a name='3758'>
      IF      ( ( sf_surface_physics .EQ. SLABSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='3759'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1'>init_soil_depth_1</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_1_4"> ( zs , dzs , num_soil_layers )<a name='3760'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_IDEAL'>init_soil_1_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_1_IDEAL_2">(tsk,tmn,tslb,xland,                      &amp;<a name='3761'>
                                ivgtyp,zs,dzs,num_soil_layers,           &amp;<a name='3762'>
                                ids,ide, jds,jde, kds,kde,               &amp;<a name='3763'>
                                ims,ime, jms,jme, kms,kme,               &amp;<a name='3764'>
                                its,ite, jts,jte, kts,kte                )<a name='3765'>
      ELSE IF ( ( sf_surface_physics .EQ. LSMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='3766'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_7"> ( zs , dzs , num_soil_layers )<a name='3767'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL'>init_soil_2_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_IDEAL_3"> ( xland,xice,vegfra,snow,canwat,         &amp;<a name='3768'>
                                  ivgtyp,isltyp,tslb,smois,tmn,          &amp;<a name='3769'>
                                  num_soil_layers,                       &amp;<a name='3770'>
                                  ids,ide, jds,jde, kds,kde,             &amp;<a name='3771'>
                                  ims,ime, jms,jme, kms,kme,             &amp;<a name='3772'>
                                  its,ite, jts,jte, kts,kte              )<a name='3773'>
      ELSE IF ( ( sf_surface_physics .EQ. NOAHMPSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='3774'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2'>init_soil_depth_2</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_2_8"> ( zs , dzs , num_soil_layers )<a name='3775'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL'>init_soil_2_ideal</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_2_IDEAL_4"> ( xland,xice,vegfra,snow,canwat,         &amp;<a name='3776'>
                                  ivgtyp,isltyp,tslb,smois,tmn,          &amp;<a name='3777'>
                                  num_soil_layers,                       &amp;<a name='3778'>
                                  ids,ide, jds,jde, kds,kde,             &amp;<a name='3779'>
                                  ims,ime, jms,jme, kms,kme,             &amp;<a name='3780'>
                                  its,ite, jts,jte, kts,kte              )<a name='3781'>
      ELSE IF ( ( sf_surface_physics .EQ. RUCLSMSCHEME ) .AND. ( num_soil_layers .GT. 1 ) ) THEN<a name='3782'>
         CALL <A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3'>init_soil_depth_3</A><A href='../../html_code/share/module_soil_pre.F.html#PROCESS_SOIL_IDEAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_SOIL_DEPTH_3_4"> ( zs , dzs , num_soil_layers )<a name='3783'>
<a name='3784'>
      END IF<a name='3785'>
<a name='3786'>
   END SUBROUTINE process_soil_ideal<a name='3787'>
<a name='3788'>
<A NAME='ADJUST_SOIL_TEMP_NEW'><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3789'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_soil_temp_new</font> ( tmn , sf_surface_physics , &amp; <A href='../../call_to/ADJUST_SOIL_TEMP_NEW.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_SOIL_TEMP_NEW.html' TARGET='index'>4</A><a name='3790'>
                                 tsk , ter , toposoil , landmask , flag_toposoil , &amp;<a name='3791'>
                                      st000010 ,      st010040 ,      st040100 ,      st100200 ,      st010200 , &amp;<a name='3792'>
                                 flag_st000010 , flag_st010040 , flag_st040100 , flag_st100200 , flag_st010200 , &amp;<a name='3793'>
                                      soilt000 ,      soilt005 ,      soilt020 ,      soilt040 ,      soilt160 ,      soilt300 , &amp;<a name='3794'>
                                 flag_soilt000 , flag_soilt005 , flag_soilt020 , flag_soilt040 , flag_soilt160 , flag_soilt300 , &amp;<a name='3795'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='3796'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='3797'>
                                 its , ite , jts , jte , kts , kte )<a name='3798'>
<a name='3799'>
      IMPLICIT NONE<a name='3800'>
<a name='3801'>
      INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='3802'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='3803'>
                              its , ite , jts , jte , kts , kte<a name='3804'>
<a name='3805'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN)    :: ter , toposoil , landmask<a name='3806'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tmn , tsk<a name='3807'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: st000010 , st010040 , st040100 , st100200 , st010200<a name='3808'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: soilt000 , soilt005 , soilt020 , soilt040 , soilt160 , soilt300<a name='3809'>
<a name='3810'>
      INTEGER , INTENT(IN) :: flag_st000010 , flag_st010040 , flag_st040100 , flag_st100200 , flag_st010200<a name='3811'>
      INTEGER , INTENT(IN) :: flag_soilt000 , flag_soilt005 , flag_soilt020 , flag_soilt040 , flag_soilt160 , flag_soilt300<a name='3812'>
      INTEGER , INTENT(IN) :: sf_surface_physics , flag_toposoil<a name='3813'>
<a name='3814'>
      INTEGER :: i , j<a name='3815'>
<a name='3816'>
      REAL :: soil_elev_min_val ,  soil_elev_max_val , soil_elev_min_dif , soil_elev_max_dif<a name='3817'>
<a name='3818'>
      <font color=#447700>!  Do we have a soil field with which to modify soil temperatures?<a name='3819'></font>
<a name='3820'>
      IF ( flag_toposoil .EQ. 1 ) THEN<a name='3821'>
<a name='3822'>
         DO j = jts , MIN(jde-1,jte)<a name='3823'>
            DO i = its , MIN(ide-1,ite)<a name='3824'>
<a name='3825'>
               <font color=#447700>!  Is the toposoil field OK, or is it a subversive soil elevation field.  We can tell<a name='3826'></font>
               <font color=#447700>!  usually by looking at values.  Anything less than -1000 m (lower than the Dead Sea) is<a name='3827'></font>
               <font color=#447700>!  bad.  Anything larger than 10 km (taller than Everest) is toast.  Also, anything where<a name='3828'></font>
               <font color=#447700>!  the difference between the soil elevation and the terrain is greater than 3 km means<a name='3829'></font>
               <font color=#447700>!  that the soil data is either all zeros or that the data are inconsistent.  Any of these<a name='3830'></font>
               <font color=#447700>!  three conditions is grievous enough to induce a WRF fatality.  However, if they are at<a name='3831'></font>
               <font color=#447700>!  a water point, then we can safely ignore them.<a name='3832'></font>
<a name='3833'>
               soil_elev_min_val = toposoil(i,j)<a name='3834'>
               soil_elev_max_val = toposoil(i,j)<a name='3835'>
               soil_elev_min_dif = ter(i,j) - toposoil(i,j)<a name='3836'>
               soil_elev_max_dif = ter(i,j) - toposoil(i,j)<a name='3837'>
<a name='3838'>
               IF      ( ( soil_elev_min_val .LT. -1000 ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='3839'>
                  CYCLE<a name='3840'>
               ELSE IF ( ( soil_elev_min_val .LT. -1000 ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='3841'>
<font color=#447700>!print *,'no soil temperature elevation adjustment, soil height too small = ',toposoil(i,j)<a name='3842'></font>
cycle<a name='3843'>
<font color=#447700>!                 CALL wrf_error_fatal ( 'TOPOSOIL values have large negative values &lt; -1000 m, unrealistic.' )<a name='3844'></font>
               ENDIF<a name='3845'>
<a name='3846'>
               IF      ( ( soil_elev_max_val .GT. 10000 ) .AND. ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='3847'>
                  CYCLE<a name='3848'>
               ELSE IF ( ( soil_elev_max_val .GT. 10000 ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='3849'>
print *,'no soil temperature elevation adjustment, soil height too high = ',toposoil(i,j)<a name='3850'>
cycle<a name='3851'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1445"> ( 'TOPOSOIL values have large positive values &gt; 10,000 m , unrealistic.' )<a name='3852'>
               ENDIF<a name='3853'>
<a name='3854'>
               IF      ( ( ( soil_elev_min_dif .LT. -3000 ) .OR. ( soil_elev_max_dif .GT. 3000 ) ) .AND. &amp;<a name='3855'>
                           ( landmask(i,j) .LT. 0.5 ) ) THEN<a name='3856'>
                  CYCLE<a name='3857'>
               ELSE IF ( ( ( soil_elev_min_dif .LT. -3000 ) .OR. ( soil_elev_max_dif .GT. 3000 ) ) .AND. &amp;<a name='3858'>
                           ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='3859'>
print *,'no soil temperature elevation adjustment, diff of soil height and terrain = ',ter(i,j) - toposoil(i,j)<a name='3860'>
cycle<a name='3861'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#ADJUST_SOIL_TEMP_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1446"> ( 'TOPOSOIL difference with terrain elevation differs by more than 3000 m, unrealistic' )<a name='3862'>
               ENDIF<a name='3863'>
<a name='3864'>
               <font color=#447700>!  For each of the fields that we would like to modify, check to see if it came in from the SI.<a name='3865'></font>
               <font color=#447700>!  If so, then use a -6.5 K/km lapse rate (based on the elevation diffs).  We only adjust when we<a name='3866'></font>
               <font color=#447700>!  are not at a water point.<a name='3867'></font>
<a name='3868'>
               IF (landmask(i,j) .GT. 0.5 ) THEN<a name='3869'>
<a name='3870'>
                  IF ( sf_surface_physics .EQ. SLABSCHEME .OR. sf_surface_physics .EQ. PXLSMSCHEME ) THEN<a name='3871'>
                     tmn(i,j) = tmn(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3872'>
                  END IF<a name='3873'>
<a name='3874'>
                  tsk(i,j) = tsk(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3875'>
<a name='3876'>
                  IF ( flag_st000010 .EQ. 1 ) THEN<a name='3877'>
                     st000010(i,j) = st000010(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3878'>
                  END IF<a name='3879'>
                  IF ( flag_st010040 .EQ. 1 ) THEN<a name='3880'>
                     st010040(i,j) = st010040(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3881'>
                  END IF<a name='3882'>
                  IF ( flag_st040100 .EQ. 1 ) THEN<a name='3883'>
                     st040100(i,j) = st040100(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3884'>
                  END IF<a name='3885'>
                  IF ( flag_st100200 .EQ. 1 ) THEN<a name='3886'>
                     st100200(i,j) = st100200(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3887'>
                  END IF<a name='3888'>
                  IF ( flag_st010200 .EQ. 1 ) THEN<a name='3889'>
                     st010200(i,j) = st010200(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3890'>
                  END IF<a name='3891'>
<a name='3892'>
                  IF ( flag_soilt000 .EQ. 1 ) THEN<a name='3893'>
                     soilt000(i,j) = soilt000(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3894'>
                  END IF<a name='3895'>
                  IF ( flag_soilt005 .EQ. 1 ) THEN<a name='3896'>
                     soilt005(i,j) = soilt005(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3897'>
                  END IF<a name='3898'>
                  IF ( flag_soilt020 .EQ. 1 ) THEN<a name='3899'>
                     soilt020(i,j) = soilt020(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3900'>
                  END IF<a name='3901'>
                  IF ( flag_soilt040 .EQ. 1 ) THEN<a name='3902'>
                     soilt040(i,j) = soilt040(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3903'>
                  END IF<a name='3904'>
                  IF ( flag_soilt160 .EQ. 1 ) THEN<a name='3905'>
                     soilt160(i,j) = soilt160(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3906'>
                  END IF<a name='3907'>
                  IF ( flag_soilt300 .EQ. 1 ) THEN<a name='3908'>
                     soilt300(i,j) = soilt300(i,j) - 0.0065 * ( ter(i,j) - toposoil(i,j) )<a name='3909'>
                  END IF<a name='3910'>
<a name='3911'>
               END IF<a name='3912'>
            END DO<a name='3913'>
         END DO<a name='3914'>
<a name='3915'>
      END IF<a name='3916'>
<a name='3917'>
   END SUBROUTINE adjust_soil_temp_new<a name='3918'>
<a name='3919'>
<a name='3920'>
<A NAME='INIT_SOIL_DEPTH_1'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3921'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_1</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_1.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_1.html' TARGET='index'>2</A><a name='3922'>
<a name='3923'>
      IMPLICIT NONE<a name='3924'>
<a name='3925'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='3926'>
<a name='3927'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='3928'>
<a name='3929'>
      INTEGER                   ::      l<a name='3930'>
<a name='3931'>
      CHARACTER (LEN=132) :: message<a name='3932'>
<a name='3933'>
      <font color=#447700>!  Define layers (top layer = 0.01 m).  Double the thicknesses at each step (dzs values).<a name='3934'></font>
      <font color=#447700>!  The distance from the ground level to the midpoint of the layer is given by zs.<a name='3935'></font>
<a name='3936'>
      <font color=#447700>!    -------   Ground Level   ----------      ||      ||   ||  ||<a name='3937'></font>
      <font color=#447700>!                                             ||      ||   ||  || zs(1) = 0.005 m<a name='3938'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||      ||   ||  \/<a name='3939'></font>
      <font color=#447700>!                                             ||      ||   ||<a name='3940'></font>
      <font color=#447700>!    -----------------------------------      ||  ||  ||   \/   dzs(1) = 0.01 m<a name='3941'></font>
      <font color=#447700>!                                             ||  ||  ||<a name='3942'></font>
      <font color=#447700>!                                             ||  ||  || zs(2) = 0.02<a name='3943'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||  ||  \/<a name='3944'></font>
      <font color=#447700>!                                             ||  ||<a name='3945'></font>
      <font color=#447700>!                                             ||  ||<a name='3946'></font>
      <font color=#447700>!    -----------------------------------  ||  ||  \/   dzs(2) = 0.02 m<a name='3947'></font>
      <font color=#447700>!                                         ||  ||<a name='3948'></font>
      <font color=#447700>!                                         ||  ||<a name='3949'></font>
      <font color=#447700>!                                         ||  ||<a name='3950'></font>
      <font color=#447700>!                                         ||  || zs(3) = 0.05<a name='3951'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --   ||  \/<a name='3952'></font>
      <font color=#447700>!                                         ||<a name='3953'></font>
      <font color=#447700>!                                         ||<a name='3954'></font>
      <font color=#447700>!                                         ||<a name='3955'></font>
      <font color=#447700>!                                         ||<a name='3956'></font>
      <font color=#447700>!    -----------------------------------  \/   dzs(3) = 0.04 m<a name='3957'></font>
<a name='3958'>
      IF ( num_soil_layers .NE. 5 ) THEN<a name='3959'>
         write(message,FMT= '(A)') 'Usually, the 5-layer diffusion uses 5 layers.  Change this in the namelist.'<a name='3960'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1447"> ( message )<a name='3961'>
      END IF<a name='3962'>
<a name='3963'>
      dzs(1)=.01<a name='3964'>
      zs(1)=.5*dzs(1)<a name='3965'>
<a name='3966'>
      DO l=2,num_soil_layers<a name='3967'>
         dzs(l)=2*dzs(l-1)<a name='3968'>
         zs(l)=zs(l-1)+.5*dzs(l-1)+.5*dzs(l)<a name='3969'>
      ENDDO<a name='3970'>
<a name='3971'>
   END SUBROUTINE init_soil_depth_1<a name='3972'>
<a name='3973'>
<A NAME='INIT_SOIL_DEPTH_2'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3974'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_2</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_2.html' TARGET='index'>8</A>,<A href='../../call_from/INIT_SOIL_DEPTH_2.html' TARGET='index'>2</A><a name='3975'>
<a name='3976'>
      IMPLICIT NONE<a name='3977'>
<a name='3978'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='3979'>
<a name='3980'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='3981'>
<a name='3982'>
      INTEGER                   ::      l<a name='3983'>
<a name='3984'>
      CHARACTER (LEN=132) :: message<a name='3985'>
<a name='3986'>
      dzs = (/ 0.1 , 0.3 , 0.6 , 1.0 /)<a name='3987'>
<a name='3988'>
      IF ( num_soil_layers .NE. 4 ) THEN<a name='3989'>
         write(message,FMT='(A)') 'Usually, the LSM uses 4 layers.  Change this in the namelist.'<a name='3990'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1448"> ( message )<a name='3991'>
      END IF<a name='3992'>
<a name='3993'>
      zs(1)=.5*dzs(1)<a name='3994'>
<a name='3995'>
      DO l=2,num_soil_layers<a name='3996'>
         zs(l)=zs(l-1)+.5*dzs(l-1)+.5*dzs(l)<a name='3997'>
      ENDDO<a name='3998'>
<a name='3999'>
   END SUBROUTINE init_soil_depth_2<a name='4000'>
<a name='4001'>
<A NAME='INIT_SOIL_DEPTH_3'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4002'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_3</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_3.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_DEPTH_3.html' TARGET='index'>2</A><a name='4003'>
<a name='4004'>
      IMPLICIT NONE<a name='4005'>
<a name='4006'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='4007'>
<a name='4008'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='4009'>
<a name='4010'>
      INTEGER                   ::      l<a name='4011'>
<a name='4012'>
      CHARACTER (LEN=132) :: message<a name='4013'>
<a name='4014'>
<font color=#447700>! in RUC LSM ZS - soil levels, and DZS - soil layer thicknesses, not used<a name='4015'></font>
<font color=#447700>! ZS is specified in the namelist: num_soil_layers = 6 or 9.<a name='4016'></font>
<font color=#447700>! Other options with number of levels are possible, but<a name='4017'></font>
<font color=#447700>! WRF users should change consistently the namelist entry with the<a name='4018'></font>
<font color=#447700>!    ZS array in this subroutine.<a name='4019'></font>
<a name='4020'>
     IF ( num_soil_layers .EQ. 6) THEN<a name='4021'>
      zs  = (/ 0.00 , 0.05 , 0.20 , 0.40 , 1.60 , 3.00 /)<a name='4022'>
<font color=#447700>!      dzs = (/ 0.00 , 0.125, 0.175 , 0.70 , 1.30 , 1.40 /)<a name='4023'></font>
     ELSEIF ( num_soil_layers .EQ. 9) THEN<a name='4024'>
      zs  = (/ 0.00 , 0.01 , 0.04 , 0.10 , 0.30, 0.60, 1.00 , 1.60, 3.00 /)<a name='4025'>
<font color=#447700>!      zs  = (/ 0.00 , 0.05 , 0.20 , 0.40 , 0.60, 1.00, 1.60 , 2.20, 3.00 /)<a name='4026'></font>
<font color=#447700>!      dzs = (/ 0.00 , 0.125, 0.175 , 0.70 , 1.30 , 1.40 /)<a name='4027'></font>
     ENDIF<a name='4028'>
<a name='4029'>
      IF ( num_soil_layers .EQ. 4 .OR. num_soil_layers .EQ. 5 ) THEN<a name='4030'>
         WRITE(message,FMT= '(A)')'Usually, the RUC LSM uses 6, 9 or more levels.  Change this in the namelist.'<a name='4031'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1449"> ( message )<a name='4032'>
      END IF<a name='4033'>
<a name='4034'>
   END SUBROUTINE init_soil_depth_3<a name='4035'>
<a name='4036'>
#if 0<a name='4037'>
<font color=#447700>!CLM  added by Jiming Jin for NMM<a name='4038'></font>
<A NAME='INIT_SOIL_DEPTH_4'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_DEPTH_4' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4039'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_depth_4</font> ( zs , dzs , num_soil_layers ) <A href='../../call_to/INIT_SOIL_DEPTH_4.html' TARGET='index'>2</A><a name='4040'>
<a name='4041'>
      IMPLICIT NONE<a name='4042'>
<a name='4043'>
      INTEGER, INTENT(IN) :: num_soil_layers<a name='4044'>
<a name='4045'>
      REAL, DIMENSION(1:num_soil_layers), INTENT(OUT)  ::  zs,dzs<a name='4046'>
      REAL, PARAMETER :: scalez = 0.025<a name='4047'>
<a name='4048'>
      INTEGER                   ::      l<a name='4049'>
<a name='4050'>
      <font color=#447700>!  Define layers (top layer = 0.01 m).  Double the thicknesses at each<a name='4051'></font>
      <font color=#447700>!  step (dzs values).<a name='4052'></font>
      <font color=#447700>!  The distance from the ground level to the midpoint of the layer is<a name='4053'></font>
      <font color=#447700>!  given by zs.<a name='4054'></font>
<a name='4055'>
      <font color=#447700>!    -------   Ground Level   ----------      ||      ||   ||  ||<a name='4056'></font>
      <font color=#447700>!                                             ||      ||   ||  || zs(1) =<a name='4057'></font>
      <font color=#447700>!                                             0.005 m<a name='4058'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||      ||   ||  \/<a name='4059'></font>
      <font color=#447700>!                                             ||      ||   ||<a name='4060'></font>
      <font color=#447700>!    -----------------------------------      ||  ||  ||   \/   dzs(1) =<a name='4061'></font>
      <font color=#447700>!    0.01 m<a name='4062'></font>
      <font color=#447700>!                                             ||  ||  ||<a name='4063'></font>
      <font color=#447700>!                                             ||  ||  || zs(2) = 0.02<a name='4064'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --       ||  ||  \/<a name='4065'></font>
      <font color=#447700>!                                             ||  ||<a name='4066'></font>
      <font color=#447700>!                                             ||  ||<a name='4067'></font>
      <font color=#447700>!    -----------------------------------  ||  ||  \/   dzs(2) = 0.02 m<a name='4068'></font>
      <font color=#447700>!                                         ||  ||<a name='4069'></font>
      <font color=#447700>!                                         ||  ||<a name='4070'></font>
      <font color=#447700>!                                         ||  ||<a name='4071'></font>
      <font color=#447700>!                                         ||  || zs(3) = 0.05<a name='4072'></font>
      <font color=#447700>!    --  --  --  --  --  --  --  --  --   ||  \/<a name='4073'></font>
      <font color=#447700>!                                         ||<a name='4074'></font>
      <font color=#447700>!                                         ||<a name='4075'></font>
      <font color=#447700>!                                         ||<a name='4076'></font>
      <font color=#447700>!                                         ||<a name='4077'></font>
      <font color=#447700>!    -----------------------------------  \/   dzs(3) = 0.04 m<a name='4078'></font>
<a name='4079'>
      do l = 1, num_soil_layers<a name='4080'>
         zs(l) = scalez*(exp(0.5*(l-0.5))-1.)    <font color=#447700>!node depths<a name='4081'></font>
      enddo<a name='4082'>
       dzs(1) = 0.5*(zs(1)+zs(2))             <font color=#447700>!thickness b/n two interfaces<a name='4083'></font>
       do l = 2,num_soil_layers-1<a name='4084'>
         dzs(l)= 0.5*(zs(l+1)-zs(l-1))<a name='4085'>
       enddo<a name='4086'>
       dzs(num_soil_layers) = zs(num_soil_layers)-zs(num_soil_layers-1)<a name='4087'>
<a name='4088'>
   END SUBROUTINE init_soil_depth_4<a name='4089'>
#endif<a name='4090'>
<a name='4091'>
<A NAME='INIT_SOIL_1_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4092'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_1_real</font> ( tsk , tmn , tslb , zs , dzs , &amp; <A href='../../call_to/INIT_SOIL_1_REAL.html' TARGET='index'>2</A><a name='4093'>
                                 num_soil_layers , real_data_init_type , &amp;<a name='4094'>
                                 landmask , sst , flag_sst , &amp;<a name='4095'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='4096'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='4097'>
                                 its , ite , jts , jte , kts , kte )<a name='4098'>
<a name='4099'>
      IMPLICIT NONE<a name='4100'>
<a name='4101'>
      INTEGER , INTENT(IN) :: num_soil_layers , real_data_init_type , &amp;<a name='4102'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='4103'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='4104'>
                              its , ite , jts , jte , kts , kte<a name='4105'>
<a name='4106'>
      INTEGER , INTENT(IN) :: flag_sst<a name='4107'>
<a name='4108'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='4109'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tsk , tmn<a name='4110'>
<a name='4111'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='4112'>
<a name='4113'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb<a name='4114'>
<a name='4115'>
      INTEGER :: i , j , l<a name='4116'>
<a name='4117'>
      <font color=#447700>!  Soil temperature is linearly interpolated between the skin temperature (taken to be at a<a name='4118'></font>
      <font color=#447700>!  depth of 0.5 cm) and the deep soil, annual temperature (taken to be at a depth of 23 cm).<a name='4119'></font>
      <font color=#447700>!  The tslb(i,1,j) is the skin temperature, and the tslb(i,num_soil_layers,j) level is the<a name='4120'></font>
      <font color=#447700>!  annual mean temperature.<a name='4121'></font>
<a name='4122'>
      DO j = jts , MIN(jde-1,jte)<a name='4123'>
         DO i = its , MIN(ide-1,ite)<a name='4124'>
            IF ( landmask(i,j) .GT. 0.5 ) THEN<a name='4125'>
               DO l = 1 , num_soil_layers<a name='4126'>
                  tslb(i,l,j)= ( tsk(i,j) * ( zs(num_soil_layers) - zs(l) )   + &amp;<a name='4127'>
                                 tmn(i,j) * ( zs(              l) - zs(1) ) ) / &amp;<a name='4128'>
                                            ( zs(num_soil_layers) - zs(1) )<a name='4129'>
               END DO<a name='4130'>
            ELSE<a name='4131'>
               IF ( ( real_data_init_type .EQ. 1 ) .AND. ( flag_sst .EQ. 1 ) ) THEN<a name='4132'>
                  DO l = 1 , num_soil_layers<a name='4133'>
                     tslb(i,l,j)= sst(i,j)<a name='4134'>
                  END DO<a name='4135'>
               ELSE<a name='4136'>
                  DO l = 1 , num_soil_layers<a name='4137'>
                     tslb(i,l,j)= tsk(i,j)<a name='4138'>
                  END DO<a name='4139'>
               END IF<a name='4140'>
            END IF<a name='4141'>
         END DO<a name='4142'>
      END DO<a name='4143'>
<a name='4144'>
   END SUBROUTINE init_soil_1_real<a name='4145'>
<a name='4146'>
<A NAME='INIT_SOIL_1_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_1_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4147'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_1_ideal</font>(tsk,tmn,tslb,xland,             &amp; <A href='../../call_to/INIT_SOIL_1_IDEAL.html' TARGET='index'>2</A><a name='4148'>
                       ivgtyp,ZS,DZS,num_soil_layers,           &amp;<a name='4149'>
                       ids,ide, jds,jde, kds,kde,               &amp;<a name='4150'>
                       ims,ime, jms,jme, kms,kme,               &amp;<a name='4151'>
                       its,ite, jts,jte, kts,kte                )<a name='4152'>
<a name='4153'>
      IMPLICIT NONE<a name='4154'>
<a name='4155'>
      INTEGER, INTENT(IN   )    ::      ids,ide, jds,jde, kds,kde, &amp;<a name='4156'>
                                        ims,ime, jms,jme, kms,kme, &amp;<a name='4157'>
                                        its,ite, jts,jte, kts,kte<a name='4158'>
<a name='4159'>
      INTEGER, INTENT(IN   )    ::      num_soil_layers<a name='4160'>
<a name='4161'>
      REAL, DIMENSION( ims:ime , 1 , jms:jme ), INTENT(OUT) :: tslb<a name='4162'>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(OUT) :: xland<a name='4163'>
      INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(OUT) :: ivgtyp<a name='4164'>
<a name='4165'>
      REAL, DIMENSION(1:), INTENT(IN) :: dzs,zs<a name='4166'>
<a name='4167'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(IN) :: tsk, tmn<a name='4168'>
<a name='4169'>
      <font color=#447700>!  Lcal variables.<a name='4170'></font>
<a name='4171'>
      INTEGER :: l,j,i,itf,jtf<a name='4172'>
<a name='4173'>
      itf=MIN(ite,ide-1)<a name='4174'>
      jtf=MIN(jte,jde-1)<a name='4175'>
<a name='4176'>
      IF (num_soil_layers.NE.1)THEN<a name='4177'>
         DO j=jts,jtf<a name='4178'>
            DO l=1,num_soil_layers<a name='4179'>
               DO i=its,itf<a name='4180'>
                 tslb(i,l,j)=( tsk(i,j)*(zs(num_soil_layers)-zs(l)) + tmn(i,j)*(zs(l)-zs(1)) ) / &amp;<a name='4181'>
                             ( zs(num_soil_layers)-zs(1) )<a name='4182'>
               ENDDO<a name='4183'>
            ENDDO<a name='4184'>
         ENDDO<a name='4185'>
      ENDIF<a name='4186'>
      DO j=jts,jtf<a name='4187'>
         DO i=its,itf<a name='4188'>
           xland(i,j)  = 2<a name='4189'>
           ivgtyp(i,j) = 7<a name='4190'>
         ENDDO<a name='4191'>
      ENDDO<a name='4192'>
<a name='4193'>
   END SUBROUTINE init_soil_1_ideal<a name='4194'>
<a name='4195'>
<A NAME='INIT_SOIL_2_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4196'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_2_real</font> ( tsk , tmn , smois , sh2o , tslb , &amp; <A href='../../call_to/INIT_SOIL_2_REAL.html' TARGET='index'>4</A>,<A href='../../call_from/INIT_SOIL_2_REAL.html' TARGET='index'>6</A><a name='4197'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='4198'>
                                 zs , dzs , &amp;<a name='4199'>
                                 st_levels_input , sm_levels_input ,sw_levels_input , &amp;<a name='4200'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  num_sw_levels_input , &amp;<a name='4201'>
                                 num_st_levels_alloc , num_sm_levels_alloc ,  num_sw_levels_alloc , &amp;<a name='4202'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='4203'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='4204'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='4205'>
                                 its , ite , jts , jte , kts , kte )<a name='4206'>
<a name='4207'>
      IMPLICIT NONE<a name='4208'>
<a name='4209'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='4210'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='4211'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='4212'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='4213'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='4214'>
                              its , ite , jts , jte , kts , kte<a name='4215'>
<a name='4216'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilm000<a name='4217'>
<a name='4218'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='4219'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='4220'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='4221'>
<a name='4222'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='4223'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='4224'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='4225'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='4226'>
<a name='4227'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='4228'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='4229'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='4230'>
<a name='4231'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='4232'>
<a name='4233'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='4234'>
<a name='4235'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave , num<a name='4236'>
      REAL :: temp<a name='4237'>
      LOGICAL :: found_levels<a name='4238'>
<a name='4239'>
      CHARACTER (LEN=132) :: message<a name='4240'>
<a name='4241'>
      <font color=#447700>!  Are there any soil temp and moisture levels - ya know, they are mandatory.<a name='4242'></font>
<a name='4243'>
      num = num_st_levels_input * num_sm_levels_input<a name='4244'>
<a name='4245'>
      IF ( num .GE. 1 ) THEN<a name='4246'>
<a name='4247'>
         <font color=#447700>!  Ordered levels that we have data for.<a name='4248'></font>
         IF ( flag_soilt000 .eq. 1 ) THEN<a name='4249'>
           write(message, FMT='(A)') ' Assume RUC LSM 6-level input'<a name='4250'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1382"> ( message )<a name='4251'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input)  ) )<a name='4252'>
         ELSE<a name='4253'>
           write(message, FMT='(A)') ' Assume Noah LSM input'<a name='4254'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1383"> ( message )<a name='4255'>
         ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input) +2) )<a name='4256'>
         END IF<a name='4257'>
<a name='4258'>
<a name='4259'>
         <font color=#447700>!  Sort the levels for temperature.<a name='4260'></font>
<font color=#447700>!print*,'num_st_levels_input, st_levels_input', num_st_levels_input, st_levels_input<a name='4261'></font>
<font color=#447700>!print*,'num_sm_levels_input,num_sw_levels_input',num_sm_levels_input,num_sw_levels_input<a name='4262'></font>
<a name='4263'>
         outert : DO lout = 1 , num_st_levels_input-1<a name='4264'>
            innert : DO lin = lout+1 , num_st_levels_input<a name='4265'>
               IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='4266'>
                  temp = st_levels_input(lout)<a name='4267'>
                  st_levels_input(lout) = st_levels_input(lin)<a name='4268'>
                  st_levels_input(lin) = NINT(temp)<a name='4269'>
                  DO j = jts , MIN(jde-1,jte)<a name='4270'>
                     DO i = its , MIN(ide-1,ite)<a name='4271'>
                        temp = st_input(i,lout+1,j)<a name='4272'>
                        st_input(i,lout+1,j) = st_input(i,lin+1,j)<a name='4273'>
                        st_input(i,lin+1,j) = temp<a name='4274'>
                     END DO<a name='4275'>
                  END DO<a name='4276'>
               END IF<a name='4277'>
            END DO innert<a name='4278'>
         END DO outert<a name='4279'>
<font color=#447700>!tgs add IF<a name='4280'></font>
      IF ( flag_soilt000 .NE. 1 ) THEN<a name='4281'>
         DO j = jts , MIN(jde-1,jte)<a name='4282'>
            DO i = its , MIN(ide-1,ite)<a name='4283'>
               st_input(i,1,j) = tsk(i,j)<a name='4284'>
               st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='4285'>
            END DO<a name='4286'>
         END DO<a name='4287'>
      ENDIF<a name='4288'>
<a name='4289'>
<a name='4290'>
#if ( NMM_CORE == 1 )<a name='4291'>
<font color=#447700>!new<a name='4292'></font>
<font color=#447700>!       write(0,*) 'st_input(1) in init_soil_2_real'<a name='4293'></font>
<font color=#447700>!	DO J=MIN(jde-1,jte),JTS, -MIN(jde-1,jte)/15<a name='4294'></font>
<font color=#447700>!       write(0,616) (st_input(I,1,J),I=its , MIN(ide-1,ite),MIN(ide-1,ite)/10)<a name='4295'></font>
<font color=#447700>!	ENDDO<a name='4296'></font>
<a name='4297'>
<font color=#447700>!       write(0,*) 'st_input(2) in init_soil_2_real'<a name='4298'></font>
<font color=#447700>!	DO J=MIN(jde-1,jte),JTS, -MIN(jde-1,jte)/15<a name='4299'></font>
<font color=#447700>!       write(0,616) (st_input(I,2,J),I=its , MIN(ide-1,ite),MIN(ide-1,ite)/10)<a name='4300'></font>
<font color=#447700>!	ENDDO<a name='4301'></font>
<a name='4302'>
  616	format(20(f4.0,1x))<a name='4303'>
#endif<a name='4304'>
<a name='4305'>
         <font color=#447700>!  Sort the levels for moisture.<a name='4306'></font>
<a name='4307'>
         outerm: DO lout = 1 , num_sm_levels_input-1<a name='4308'>
            innerm : DO lin = lout+1 , num_sm_levels_input<a name='4309'>
               IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='4310'>
                  temp = sm_levels_input(lout)<a name='4311'>
                  sm_levels_input(lout) = sm_levels_input(lin)<a name='4312'>
                  sm_levels_input(lin) = NINT(temp)<a name='4313'>
                  DO j = jts , MIN(jde-1,jte)<a name='4314'>
                     DO i = its , MIN(ide-1,ite)<a name='4315'>
                        temp = sm_input(i,lout+1,j)<a name='4316'>
                        sm_input(i,lout+1,j) = sm_input(i,lin+1,j)<a name='4317'>
                        sm_input(i,lin+1,j) = temp<a name='4318'>
                     END DO<a name='4319'>
                  END DO<a name='4320'>
               END IF<a name='4321'>
            END DO innerm<a name='4322'>
         END DO outerm<a name='4323'>
<font color=#447700>!tgs add IF<a name='4324'></font>
      IF ( flag_soilm000 .NE. 1 ) THEN<a name='4325'>
         DO j = jts , MIN(jde-1,jte)<a name='4326'>
            DO i = its , MIN(ide-1,ite)<a name='4327'>
               sm_input(i,1,j) = sm_input(i,2,j)<a name='4328'>
               sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='4329'>
            END DO<a name='4330'>
         END DO<a name='4331'>
      ENDIF<a name='4332'>
<a name='4333'>
         <font color=#447700>!  Sort the levels for liquid moisture.<a name='4334'></font>
<a name='4335'>
         outerw: DO lout = 1 , num_sw_levels_input-1<a name='4336'>
            innerw : DO lin = lout+1 , num_sw_levels_input<a name='4337'>
               IF ( sw_levels_input(lout) .GT. sw_levels_input(lin) ) THEN<a name='4338'>
                  temp = sw_levels_input(lout)<a name='4339'>
                  sw_levels_input(lout) = sw_levels_input(lin)<a name='4340'>
                  sw_levels_input(lin) = NINT(temp)<a name='4341'>
                  DO j = jts , MIN(jde-1,jte)<a name='4342'>
                     DO i = its , MIN(ide-1,ite)<a name='4343'>
                        temp = sw_input(i,lout+1,j)<a name='4344'>
                        sw_input(i,lout+1,j) = sw_input(i,lin+1,j)<a name='4345'>
                        sw_input(i,lin+1,j) = temp<a name='4346'>
                     END DO<a name='4347'>
                  END DO<a name='4348'>
               END IF<a name='4349'>
            END DO innerw<a name='4350'>
         END DO outerw<a name='4351'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='4352'>
           IF ( flag_soilm000 .NE. 1 ) THEN<a name='4353'>
            DO j = jts , MIN(jde-1,jte)<a name='4354'>
               DO i = its , MIN(ide-1,ite)<a name='4355'>
                  sw_input(i,1,j) = sw_input(i,2,j)<a name='4356'>
                  sw_input(i,num_sw_levels_input+2,j) = sw_input(i,num_sw_levels_input+1,j)<a name='4357'>
               END DO<a name='4358'>
            END DO<a name='4359'>
           ENDIF<a name='4360'>
         END IF<a name='4361'>
<a name='4362'>
         found_levels = .TRUE.<a name='4363'>
<a name='4364'>
      ELSE IF ( ( num .LE. 0 ) .AND. (  start_date .NE. current_date ) ) THEN<a name='4365'>
<a name='4366'>
         found_levels = .FALSE.<a name='4367'>
<a name='4368'>
      ELSE<a name='4369'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1450"> ( &amp;<a name='4370'>
         'No input soil level data (temperature, moisture or liquid, or all are missing). Required for LSM.' )<a name='4371'>
      END IF<a name='4372'>
<a name='4373'>
      <font color=#447700>!  Is it OK to continue?<a name='4374'></font>
<a name='4375'>
      IF ( found_levels ) THEN<a name='4376'>
<a name='4377'>
<font color=#447700>!tgs add IF<a name='4378'></font>
      IF ( flag_soilt000 .NE.1) THEN<a name='4379'>
<font color=#447700>!tgs initialize from Noah data<a name='4380'></font>
         <font color=#447700>!  Here are the levels that we have from the input for temperature.  The input levels plus<a name='4381'></font>
         <font color=#447700>!  two more: the skin temperature at 0 cm, and the annual mean temperature at 300 cm.<a name='4382'></font>
<a name='4383'>
         zhave(1) = 0.<a name='4384'>
         DO l = 1 , num_st_levels_input<a name='4385'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='4386'>
         END DO<a name='4387'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='4388'>
<a name='4389'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='4390'></font>
<a name='4391'>
         z_wantt : DO lwant = 1 , num_soil_layers<a name='4392'>
            z_havet : DO lhave = 1 , num_st_levels_input +2 -1<a name='4393'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4394'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4395'>
                  DO j = jts , MIN(jde-1,jte)<a name='4396'>
                     DO i = its , MIN(ide-1,ite)<a name='4397'>
                        tslb(i,lwant,j)= ( st_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4398'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4399'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='4400'>
                     END DO<a name='4401'>
                  END DO<a name='4402'>
                  EXIT z_havet<a name='4403'>
               END IF<a name='4404'>
            END DO z_havet<a name='4405'>
         END DO z_wantt<a name='4406'>
<a name='4407'>
     ELSE<a name='4408'>
<a name='4409'>
<font color=#447700>!tgs initialize from RUCLSM data<a name='4410'></font>
         DO l = 1 , num_st_levels_input<a name='4411'>
            zhave(l) = st_levels_input(l) / 100.<a name='4412'>
         END DO<a name='4413'>
<a name='4414'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='4415'></font>
<a name='4416'>
<a name='4417'>
      z_wantt_2 : DO lwant = 1 , num_soil_layers<a name='4418'>
         z_havet_2 : DO lhave = 1 , num_st_levels_input -1<a name='4419'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4420'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4421'>
               DO j = jts , MIN(jde-1,jte)<a name='4422'>
                  DO i = its , MIN(ide-1,ite)<a name='4423'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4424'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4425'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='4426'>
                  END DO<a name='4427'>
               END DO<a name='4428'>
               EXIT z_havet_2<a name='4429'>
            END IF<a name='4430'>
         END DO z_havet_2<a name='4431'>
      END DO z_wantt_2<a name='4432'>
<a name='4433'>
      ENDIF<a name='4434'>
<a name='4435'>
<a name='4436'>
      IF ( flag_soilm000 .NE. 1 ) THEN<a name='4437'>
<font color=#447700>!tgs initialize from Noah<a name='4438'></font>
         <font color=#447700>!  Here are the levels that we have from the input for moisture.  The input levels plus<a name='4439'></font>
         <font color=#447700>!  two more: a value at 0 cm and one at 300 cm.  The 0 cm value is taken to be identical<a name='4440'></font>
         <font color=#447700>!  to the most shallow layer's value.  Similarly, the 300 cm value is taken to be the same<a name='4441'></font>
         <font color=#447700>!  as the most deep layer's value.<a name='4442'></font>
<a name='4443'>
         zhave(1) = 0.<a name='4444'>
         DO l = 1 , num_sm_levels_input<a name='4445'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='4446'>
         END DO<a name='4447'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='4448'>
<a name='4449'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='4450'></font>
<a name='4451'>
         z_wantm : DO lwant = 1 , num_soil_layers<a name='4452'>
            z_havem : DO lhave = 1 , num_sm_levels_input +2 -1<a name='4453'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4454'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4455'>
                  DO j = jts , MIN(jde-1,jte)<a name='4456'>
                     DO i = its , MIN(ide-1,ite)<a name='4457'>
                        smois(i,lwant,j)= ( sm_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4458'>
                                            sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4459'>
                                                                    ( zhave(lhave+1) - zhave(lhave) )<a name='4460'>
                     END DO<a name='4461'>
                  END DO<a name='4462'>
                  EXIT z_havem<a name='4463'>
               END IF<a name='4464'>
            END DO z_havem<a name='4465'>
         END DO z_wantm<a name='4466'>
<a name='4467'>
     ELSE<a name='4468'>
<a name='4469'>
<font color=#447700>!tgs  initialize from RUCLSM data<a name='4470'></font>
         DO l = 1 , num_sm_levels_input<a name='4471'>
            zhave(l) = sm_levels_input(l) / 100.<a name='4472'>
         END DO<a name='4473'>
<a name='4474'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='4475'></font>
<a name='4476'>
      z_wantm_2 : DO lwant = 1 , num_soil_layers<a name='4477'>
         z_havem_2 : DO lhave = 1 , num_sm_levels_input -1<a name='4478'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4479'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4480'>
               DO j = jts , MIN(jde-1,jte)<a name='4481'>
                  DO i = its , MIN(ide-1,ite)<a name='4482'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4483'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4484'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='4485'>
                  END DO<a name='4486'>
               END DO<a name='4487'>
               EXIT z_havem_2<a name='4488'>
             END IF<a name='4489'>
         END DO z_havem_2<a name='4490'>
      END DO z_wantm_2<a name='4491'>
<a name='4492'>
     ENDIF<a name='4493'>
         <font color=#447700>!  Any liquid soil moisture to worry about?<a name='4494'></font>
<a name='4495'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='4496'>
<a name='4497'>
      IF ( flag_soilm000 .NE. 1 ) THEN<a name='4498'>
            zhave(1) = 0.<a name='4499'>
            DO l = 1 , num_sw_levels_input<a name='4500'>
               zhave(l+1) = sw_levels_input(l) / 100.<a name='4501'>
            END DO<a name='4502'>
            zhave(num_sw_levels_input+2) = 300. / 100.<a name='4503'>
<a name='4504'>
            <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='4505'></font>
<a name='4506'>
            z_wantw : DO lwant = 1 , num_soil_layers<a name='4507'>
               z_havew : DO lhave = 1 , num_sw_levels_input +2 -1<a name='4508'>
                  IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4509'>
                       ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4510'>
                     DO j = jts , MIN(jde-1,jte)<a name='4511'>
                        DO i = its , MIN(ide-1,ite)<a name='4512'>
                           sh2o(i,lwant,j)= ( sw_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4513'>
                                               sw_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4514'>
                                                                       ( zhave(lhave+1) - zhave(lhave) )<a name='4515'>
                        END DO<a name='4516'>
                     END DO<a name='4517'>
                     EXIT z_havew<a name='4518'>
                  END IF<a name='4519'>
               END DO z_havew<a name='4520'>
            END DO z_wantw<a name='4521'>
     ELSE<a name='4522'>
<a name='4523'>
<font color=#447700>!tgs  initialize from RUCLSM data<a name='4524'></font>
         DO l = 1 , num_sw_levels_input<a name='4525'>
            zhave(l) = sw_levels_input(l) / 100.<a name='4526'>
         END DO<a name='4527'>
<a name='4528'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want<a name='4529'></font>
      <font color=#447700>!  (zs).<a name='4530'></font>
<a name='4531'>
      z_wantw_2 : DO lwant = 1 , num_soil_layers<a name='4532'>
         z_havew_2 : DO lhave = 1 , num_sw_levels_input -1<a name='4533'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4534'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4535'>
               DO j = jts , MIN(jde-1,jte)<a name='4536'>
                  DO i = its , MIN(ide-1,ite)<a name='4537'>
                     sh2o(i,lwant,j)= ( sw_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4538'>
                                         sw_input(i,lhave+1,j) * ( zs   (lwant) - zhave(lhave) ) ) / &amp;<a name='4539'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='4540'>
                  END DO<a name='4541'>
               END DO<a name='4542'>
               EXIT z_havew_2<a name='4543'>
             END IF<a name='4544'>
         END DO z_havew_2<a name='4545'>
      END DO z_wantw_2<a name='4546'>
<a name='4547'>
     ENDIF<a name='4548'>
         END IF<a name='4549'>
<a name='4550'>
<a name='4551'>
         <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='4552'></font>
         <font color=#447700>!  used, but they will make a more continuous plot.<a name='4553'></font>
<a name='4554'>
         IF ( flag_sst .EQ. 1 ) THEN<a name='4555'>
            DO j = jts , MIN(jde-1,jte)<a name='4556'>
               DO i = its , MIN(ide-1,ite)<a name='4557'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='4558'>
                     DO l = 1 , num_soil_layers<a name='4559'>
                        tslb(i,l,j)= sst(i,j)<a name='4560'>
<font color=#447700>!tgs add line for tsk<a name='4561'></font>
                        tsk(i,j)    = sst(i,j)<a name='4562'>
                        smois(i,l,j)= 1.0<a name='4563'>
                        sh2o (i,l,j)= 1.0<a name='4564'>
                     END DO<a name='4565'>
                  END IF<a name='4566'>
               END DO<a name='4567'>
            END DO<a name='4568'>
         ELSE<a name='4569'>
            DO j = jts , MIN(jde-1,jte)<a name='4570'>
               DO i = its , MIN(ide-1,ite)<a name='4571'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='4572'>
                     DO l = 1 , num_soil_layers<a name='4573'>
                        tslb(i,l,j)= tsk(i,j)<a name='4574'>
                        smois(i,l,j)= 1.0<a name='4575'>
                        sh2o (i,l,j)= 1.0<a name='4576'>
                     END DO<a name='4577'>
                  END IF<a name='4578'>
               END DO<a name='4579'>
            END DO<a name='4580'>
         END IF<a name='4581'>
<a name='4582'>
         DEALLOCATE (zhave)<a name='4583'>
<a name='4584'>
      END IF<a name='4585'>
<a name='4586'>
   END SUBROUTINE init_soil_2_real<a name='4587'>
<a name='4588'>
<A NAME='INIT_SOIL_2_IDEAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_2_IDEAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4589'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_2_ideal</font> ( xland,xice,vegfra,snow,canwat,     &amp; <A href='../../call_to/INIT_SOIL_2_IDEAL.html' TARGET='index'>4</A><a name='4590'>
                     ivgtyp,isltyp,tslb,smois,tmn,                  &amp;<a name='4591'>
                     num_soil_layers,                               &amp;<a name='4592'>
                     ids,ide, jds,jde, kds,kde,                     &amp;<a name='4593'>
                     ims,ime, jms,jme, kms,kme,                     &amp;<a name='4594'>
                     its,ite, jts,jte, kts,kte                      )<a name='4595'>
<a name='4596'>
      IMPLICIT NONE<a name='4597'>
<a name='4598'>
      INTEGER, INTENT(IN) ::ids,ide, jds,jde, kds,kde,  &amp;<a name='4599'>
                            ims,ime, jms,jme, kms,kme,  &amp;<a name='4600'>
                            its,ite, jts,jte, kts,kte<a name='4601'>
<a name='4602'>
      INTEGER, INTENT(IN) ::num_soil_layers<a name='4603'>
<a name='4604'>
      REAL, DIMENSION( ims:ime, num_soil_layers, jms:jme ) , INTENT(OUT) :: smois, tslb<a name='4605'>
<a name='4606'>
      REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT)  :: xland, snow, canwat, xice, vegfra, tmn<a name='4607'>
<a name='4608'>
      INTEGER, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT) :: ivgtyp, isltyp<a name='4609'>
<a name='4610'>
      INTEGER :: icm,jcm,itf,jtf<a name='4611'>
      INTEGER ::  i,j,l<a name='4612'>
<a name='4613'>
      itf=min0(ite,ide-1)<a name='4614'>
      jtf=min0(jte,jde-1)<a name='4615'>
<a name='4616'>
      icm = ide/2<a name='4617'>
      jcm = jde/2<a name='4618'>
<a name='4619'>
      DO j=jts,jtf<a name='4620'>
         DO l=1,num_soil_layers<a name='4621'>
            DO i=its,itf<a name='4622'>
<a name='4623'>
               smois(i,1,j)=0.10<a name='4624'>
               smois(i,2,j)=0.10<a name='4625'>
               smois(i,3,j)=0.10<a name='4626'>
               smois(i,4,j)=0.10<a name='4627'>
<a name='4628'>
               tslb(i,1,j)=295.<a name='4629'>
               tslb(i,2,j)=297.<a name='4630'>
               tslb(i,3,j)=293.<a name='4631'>
               tslb(i,4,j)=293.<a name='4632'>
<a name='4633'>
            ENDDO<a name='4634'>
         ENDDO<a name='4635'>
      ENDDO<a name='4636'>
<a name='4637'>
      DO j=jts,jtf<a name='4638'>
         DO i=its,itf<a name='4639'>
            xland(i,j)  =   2<a name='4640'>
            tmn(i,j)    = 294.<a name='4641'>
            xice(i,j)   =   0.<a name='4642'>
            vegfra(i,j) =   0.<a name='4643'>
            snow(i,j)   =   0.<a name='4644'>
            canwat(i,j) =   0.<a name='4645'>
            ivgtyp(i,j) =   7<a name='4646'>
            isltyp(i,j) =   8<a name='4647'>
         ENDDO<a name='4648'>
      ENDDO<a name='4649'>
<a name='4650'>
   END SUBROUTINE init_soil_2_ideal<a name='4651'>
<a name='4652'>
<A NAME='INIT_SOIL_3_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4653'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_3_real</font> ( tsk , tmn , smois , tslb , &amp; <A href='../../call_to/INIT_SOIL_3_REAL.html' TARGET='index'>3</A>,<A href='../../call_from/INIT_SOIL_3_REAL.html' TARGET='index'>6</A><a name='4654'>
                                 st_input , sm_input , landmask, sst, &amp;<a name='4655'>
                                 zs , dzs , &amp;<a name='4656'>
                                 st_levels_input , sm_levels_input , &amp;<a name='4657'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  &amp;<a name='4658'>
                                 num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='4659'>
                                 flag_sst , flag_soilt000 , flag_soilm000 , &amp;<a name='4660'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='4661'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='4662'>
                                 its , ite , jts , jte , kts , kte )<a name='4663'>
<a name='4664'>
      IMPLICIT NONE<a name='4665'>
<a name='4666'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='4667'>
                              num_st_levels_input , num_sm_levels_input , &amp;<a name='4668'>
                              num_st_levels_alloc , num_sm_levels_alloc , &amp;<a name='4669'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='4670'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='4671'>
                              its , ite , jts , jte , kts , kte<a name='4672'>
<a name='4673'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soilt000, flag_soilm000<a name='4674'>
<a name='4675'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='4676'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='4677'>
<a name='4678'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='4679'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='4680'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='4681'>
<a name='4682'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='4683'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='4684'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='4685'>
<a name='4686'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois<a name='4687'>
<a name='4688'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='4689'>
<a name='4690'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave<a name='4691'>
      REAL :: temp<a name='4692'>
<a name='4693'>
      <font color=#447700>!  Allocate the soil layer array used for interpolating.<a name='4694'></font>
<a name='4695'>
      IF ( ( num_st_levels_input .LE. 0 ) .OR. &amp;<a name='4696'>
           ( num_sm_levels_input .LE. 0 ) ) THEN<a name='4697'>
         PRINT '(A)','No input soil level data (either temperature or moisture, or both are missing).  Required for RUC LSM.'<a name='4698'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_3_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1451"> ( 'no soil data' )<a name='4699'>
      ELSE<a name='4700'>
         IF ( flag_soilt000 .eq. 1 ) THEN<a name='4701'>
           PRINT '(A)',' Assume RUC LSM 6-level input'<a name='4702'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input)  ) )<a name='4703'>
         ELSE<a name='4704'>
           PRINT '(A)',' Assume non-RUC LSM input'<a name='4705'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_soil_layers)  ) )<a name='4706'>
         END IF<a name='4707'>
      END IF<a name='4708'>
<a name='4709'>
      <font color=#447700>!  Sort the levels for temperature.<a name='4710'></font>
<a name='4711'>
      outert : DO lout = 1 , num_st_levels_input-1<a name='4712'>
         innert : DO lin = lout+1 , num_st_levels_input<a name='4713'>
            IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='4714'>
               temp = st_levels_input(lout)<a name='4715'>
               st_levels_input(lout) = st_levels_input(lin)<a name='4716'>
               st_levels_input(lin) = NINT(temp)<a name='4717'>
               DO j = jts , MIN(jde-1,jte)<a name='4718'>
                  DO i = its , MIN(ide-1,ite)<a name='4719'>
                     temp = st_input(i,lout,j)<a name='4720'>
                     st_input(i,lout,j) = st_input(i,lin,j)<a name='4721'>
                     st_input(i,lin,j) = temp<a name='4722'>
                  END DO<a name='4723'>
               END DO<a name='4724'>
            END IF<a name='4725'>
         END DO innert<a name='4726'>
      END DO outert<a name='4727'>
<a name='4728'>
      IF ( flag_soilt000 .NE. 1 ) THEN<a name='4729'>
      DO j = jts , MIN(jde-1,jte)<a name='4730'>
         DO i = its , MIN(ide-1,ite)<a name='4731'>
            st_input(i,1,j) = tsk(i,j)<a name='4732'>
            st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='4733'>
         END DO<a name='4734'>
      END DO<a name='4735'>
      END IF<a name='4736'>
<a name='4737'>
      <font color=#447700>!  Sort the levels for moisture.<a name='4738'></font>
<a name='4739'>
      outerm: DO lout = 1 , num_sm_levels_input-1<a name='4740'>
         innerm : DO lin = lout+1 , num_sm_levels_input<a name='4741'>
            IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='4742'>
               temp = sm_levels_input(lout)<a name='4743'>
               sm_levels_input(lout) = sm_levels_input(lin)<a name='4744'>
               sm_levels_input(lin) = NINT(temp)<a name='4745'>
               DO j = jts , MIN(jde-1,jte)<a name='4746'>
                  DO i = its , MIN(ide-1,ite)<a name='4747'>
                     temp = sm_input(i,lout,j)<a name='4748'>
                     sm_input(i,lout,j) = sm_input(i,lin,j)<a name='4749'>
                     sm_input(i,lin,j) = temp<a name='4750'>
                  END DO<a name='4751'>
               END DO<a name='4752'>
            END IF<a name='4753'>
         END DO innerm<a name='4754'>
      END DO outerm<a name='4755'>
<a name='4756'>
      IF ( flag_soilm000 .NE. 1 ) THEN<a name='4757'>
      DO j = jts , MIN(jde-1,jte)<a name='4758'>
         DO i = its , MIN(ide-1,ite)<a name='4759'>
            sm_input(i,1,j) = sm_input(i,2,j)<a name='4760'>
            sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='4761'>
         END DO<a name='4762'>
      END DO<a name='4763'>
      END IF<a name='4764'>
<a name='4765'>
      <font color=#447700>!  Here are the levels that we have from the input for temperature.<a name='4766'></font>
<a name='4767'>
      IF ( flag_soilt000 .EQ. 1 ) THEN<a name='4768'>
         DO l = 1 , num_st_levels_input<a name='4769'>
            zhave(l) = st_levels_input(l) / 100.<a name='4770'>
         END DO<a name='4771'>
<a name='4772'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='4773'></font>
<a name='4774'>
      z_wantt : DO lwant = 1 , num_soil_layers<a name='4775'>
         z_havet : DO lhave = 1 , num_st_levels_input -1<a name='4776'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4777'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4778'>
               DO j = jts , MIN(jde-1,jte)<a name='4779'>
                  DO i = its , MIN(ide-1,ite)<a name='4780'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4781'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4782'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='4783'>
                  END DO<a name='4784'>
               END DO<a name='4785'>
               EXIT z_havet<a name='4786'>
            END IF<a name='4787'>
         END DO z_havet<a name='4788'>
      END DO z_wantt<a name='4789'>
<a name='4790'>
      ELSE<a name='4791'>
<a name='4792'>
         zhave(1) = 0.<a name='4793'>
         DO l = 1 , num_st_levels_input<a name='4794'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='4795'>
         END DO<a name='4796'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='4797'>
<a name='4798'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='4799'></font>
<a name='4800'>
      z_wantt_2 : DO lwant = 1 , num_soil_layers<a name='4801'>
         z_havet_2 : DO lhave = 1 , num_st_levels_input +2<a name='4802'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4803'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4804'>
               DO j = jts , MIN(jde-1,jte)<a name='4805'>
                  DO i = its , MIN(ide-1,ite)<a name='4806'>
                     tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4807'>
                                        st_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4808'>
                                                                ( zhave(lhave+1) - zhave(lhave) )<a name='4809'>
                  END DO<a name='4810'>
               END DO<a name='4811'>
               EXIT z_havet_2<a name='4812'>
            END IF<a name='4813'>
         END DO z_havet_2<a name='4814'>
      END DO z_wantt_2<a name='4815'>
<a name='4816'>
      END IF<a name='4817'>
<a name='4818'>
      <font color=#447700>!  Here are the levels that we have from the input for moisture.<a name='4819'></font>
<a name='4820'>
      IF ( flag_soilm000 .EQ. 1 ) THEN<a name='4821'>
         DO l = 1 , num_sm_levels_input<a name='4822'>
            zhave(l) = sm_levels_input(l) / 100.<a name='4823'>
         END DO<a name='4824'>
<a name='4825'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='4826'></font>
<a name='4827'>
      z_wantm : DO lwant = 1 , num_soil_layers<a name='4828'>
         z_havem : DO lhave = 1 , num_sm_levels_input -1<a name='4829'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4830'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4831'>
               DO j = jts , MIN(jde-1,jte)<a name='4832'>
                  DO i = its , MIN(ide-1,ite)<a name='4833'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4834'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4835'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='4836'>
                  END DO<a name='4837'>
               END DO<a name='4838'>
               EXIT z_havem<a name='4839'>
            END IF<a name='4840'>
         END DO z_havem<a name='4841'>
      END DO z_wantm<a name='4842'>
<a name='4843'>
      ELSE<a name='4844'>
<a name='4845'>
         zhave(1) = 0.<a name='4846'>
         DO l = 1 , num_sm_levels_input<a name='4847'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='4848'>
         END DO<a name='4849'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='4850'>
<a name='4851'>
      z_wantm_2 : DO lwant = 1 , num_soil_layers<a name='4852'>
         z_havem_2 : DO lhave = 1 , num_sm_levels_input +2<a name='4853'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='4854'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='4855'>
               DO j = jts , MIN(jde-1,jte)<a name='4856'>
                  DO i = its , MIN(ide-1,ite)<a name='4857'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='4858'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant  ) - zhave(lhave) ) ) / &amp;<a name='4859'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='4860'>
                  END DO<a name='4861'>
               END DO<a name='4862'>
               EXIT z_havem_2<a name='4863'>
            END IF<a name='4864'>
         END DO z_havem_2<a name='4865'>
      END DO z_wantm_2<a name='4866'>
<a name='4867'>
      END IF<a name='4868'>
      <font color=#447700>!  Over water, put in reasonable values for soil temperature and moisture.  These won't be<a name='4869'></font>
      <font color=#447700>!  used, but they will make a more continuous plot.<a name='4870'></font>
<a name='4871'>
      IF ( flag_sst .EQ. 1 ) THEN<a name='4872'>
         DO j = jts , MIN(jde-1,jte)<a name='4873'>
            DO i = its , MIN(ide-1,ite)<a name='4874'>
               IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='4875'>
                  DO l = 1 , num_soil_layers<a name='4876'>
                     tslb(i,l,j) = sst(i,j)<a name='4877'>
                     tsk(i,j)    = sst(i,j)<a name='4878'>
                     smois(i,l,j)= 1.0<a name='4879'>
                  END DO<a name='4880'>
               END IF<a name='4881'>
            END DO<a name='4882'>
         END DO<a name='4883'>
      ELSE<a name='4884'>
         DO j = jts , MIN(jde-1,jte)<a name='4885'>
            DO i = its , MIN(ide-1,ite)<a name='4886'>
               IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='4887'>
                  DO l = 1 , num_soil_layers<a name='4888'>
                     tslb(i,l,j)= tsk(i,j)<a name='4889'>
                     smois(i,l,j)= 1.0<a name='4890'>
                  END DO<a name='4891'>
               END IF<a name='4892'>
            END DO<a name='4893'>
         END DO<a name='4894'>
      END IF<a name='4895'>
<a name='4896'>
      DEALLOCATE (zhave)<a name='4897'>
<a name='4898'>
   END SUBROUTINE init_soil_3_real<a name='4899'>
<a name='4900'>
#if 0<a name='4901'>
<font color=#447700>! CLM  added by Jiming Jin<a name='4902'></font>
<a name='4903'>
<A NAME='INIT_SOIL_4_REAL'><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4904'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_soil_4_real</font> ( tsk , tmn , smois , sh2o , tslb , &amp; <A href='../../call_to/INIT_SOIL_4_REAL.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_SOIL_4_REAL.html' TARGET='index'>6</A><a name='4905'>
                                 st_input , sm_input , sw_input , landmask , sst , &amp;<a name='4906'>
                                 zs , dzs , &amp;<a name='4907'>
                                 st_levels_input , sm_levels_input , sw_levels_input , &amp;<a name='4908'>
                                 num_soil_layers , num_st_levels_input , num_sm_levels_input ,  num_sw_levels_input , &amp;<a name='4909'>
                                 num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='4910'>
                                 flag_sst , flag_soil_layers , flag_soil_levels , &amp;<a name='4911'>
                                 ids , ide , jds , jde , kds , kde , &amp;<a name='4912'>
                                 ims , ime , jms , jme , kms , kme , &amp;<a name='4913'>
                                 its , ite , jts , jte , kts , kte )<a name='4914'>
<a name='4915'>
      IMPLICIT NONE<a name='4916'>
<a name='4917'>
      INTEGER , INTENT(IN) :: num_soil_layers , &amp;<a name='4918'>
                              num_st_levels_input , num_sm_levels_input , num_sw_levels_input , &amp;<a name='4919'>
                              num_st_levels_alloc , num_sm_levels_alloc , num_sw_levels_alloc , &amp;<a name='4920'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='4921'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='4922'>
                              its , ite , jts , jte , kts , kte<a name='4923'>
<a name='4924'>
      INTEGER , INTENT(IN) :: flag_sst, flag_soil_layers, flag_soil_levels<a name='4925'>
<a name='4926'>
      INTEGER , DIMENSION(1:num_st_levels_input) , INTENT(INOUT) :: st_levels_input<a name='4927'>
      INTEGER , DIMENSION(1:num_sm_levels_input) , INTENT(INOUT) :: sm_levels_input<a name='4928'>
      INTEGER , DIMENSION(1:num_sw_levels_input) , INTENT(INOUT) :: sw_levels_input<a name='4929'>
<a name='4930'>
      REAL , DIMENSION(ims:ime,1:num_st_levels_alloc,jms:jme) , INTENT(INOUT) :: st_input<a name='4931'>
      REAL , DIMENSION(ims:ime,1:num_sm_levels_alloc,jms:jme) , INTENT(INOUT) :: sm_input<a name='4932'>
      REAL , DIMENSION(ims:ime,1:num_sw_levels_alloc,jms:jme) , INTENT(INOUT) :: sw_input<a name='4933'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: landmask , sst<a name='4934'>
<a name='4935'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: tmn<a name='4936'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(INOUT) :: tsk<a name='4937'>
      REAL , DIMENSION(num_soil_layers) :: zs , dzs<a name='4938'>
<a name='4939'>
      REAL , DIMENSION(ims:ime,num_soil_layers,jms:jme) , INTENT(OUT) :: tslb , smois , sh2o<a name='4940'>
<a name='4941'>
      REAL , ALLOCATABLE , DIMENSION(:) :: zhave<a name='4942'>
<a name='4943'>
      INTEGER :: i , j , l , lout , lin , lwant , lhave , num<a name='4944'>
      REAL :: temp<a name='4945'>
      LOGICAL :: found_levels<a name='4946'>
<a name='4947'>
      CHARACTER (LEN=132) :: message<a name='4948'>
<a name='4949'>
      <font color=#447700>!  Are there any soil temp and moisture levels - ya know, they are<a name='4950'></font>
      <font color=#447700>!  mandatory.<a name='4951'></font>
<a name='4952'>
      num = num_st_levels_input * num_sm_levels_input<a name='4953'>
<a name='4954'>
      IF ( num .GE. 1 ) THEN<a name='4955'>
<a name='4956'>
         <font color=#447700>!  Ordered levels that we have data for.  <a name='4957'></font>
<a name='4958'>
<font color=#447700>!tgs add option to initialize from RUCLSM<a name='4959'></font>
         IF ( flag_soil_levels == 1 ) THEN<a name='4960'>
           write(message, FMT='(A)') ' Assume CLM input'<a name='4961'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1384"> ( message )<a name='4962'>
           ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input)  ) )<a name='4963'>
         ELSE<a name='4964'>
           write(message, FMT='(A)') ' Assume non-CLM input'<a name='4965'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1385"> ( message )<a name='4966'>
        ALLOCATE ( zhave( MAX(num_st_levels_input,num_sm_levels_input,num_sw_levels_input) +2) )<a name='4967'>
      <font color=#447700>!   ALLOCATE ( zhave( MAX(num_st_levels_input,num_soil_layers)  ) )<a name='4968'></font>
         END IF<a name='4969'>
<a name='4970'>
<a name='4971'>
         <font color=#447700>!  Sort the levels for temperature.<a name='4972'></font>
<a name='4973'>
         outert : DO lout = 1 , num_st_levels_input-1<a name='4974'>
            innert : DO lin = lout+1 , num_st_levels_input<a name='4975'>
               IF ( st_levels_input(lout) .GT. st_levels_input(lin) ) THEN<a name='4976'>
                  temp = st_levels_input(lout)<a name='4977'>
                  st_levels_input(lout) = st_levels_input(lin)<a name='4978'>
                  st_levels_input(lin) = NINT(temp)<a name='4979'>
                  DO j = jts , MIN(jde-1,jte)<a name='4980'>
                     DO i = its , MIN(ide-1,ite)<a name='4981'>
                        temp = st_input(i,lout+1,j)<a name='4982'>
                        st_input(i,lout+1,j) = st_input(i,lin+1,j)<a name='4983'>
                        st_input(i,lin+1,j) = temp<a name='4984'>
                     END DO<a name='4985'>
                  END DO<a name='4986'>
               END IF<a name='4987'>
            END DO innert<a name='4988'>
         END DO outert<a name='4989'>
<font color=#447700>!tgs add IF<a name='4990'></font>
      IF ( flag_soil_layers == 1 ) THEN<a name='4991'>
         DO j = jts , MIN(jde-1,jte)<a name='4992'>
            DO i = its , MIN(ide-1,ite)<a name='4993'>
               st_input(i,1,j) = tsk(i,j)<a name='4994'>
               st_input(i,num_st_levels_input+2,j) = tmn(i,j)<a name='4995'>
            END DO<a name='4996'>
         END DO<a name='4997'>
      ENDIF<a name='4998'>
        <font color=#447700>!  Sort the levels for moisture.<a name='4999'></font>
<a name='5000'>
        outerm: DO lout = 1 , num_sm_levels_input-1<a name='5001'>
            innerm : DO lin = lout+1 , num_sm_levels_input<a name='5002'>
               IF ( sm_levels_input(lout) .GT. sm_levels_input(lin) ) THEN<a name='5003'>
                  temp = sm_levels_input(lout)<a name='5004'>
                  sm_levels_input(lout) = sm_levels_input(lin)<a name='5005'>
                  sm_levels_input(lin) = NINT(temp)<a name='5006'>
                  DO j = jts , MIN(jde-1,jte)<a name='5007'>
                     DO i = its , MIN(ide-1,ite)<a name='5008'>
                        temp = sm_input(i,lout+1,j)<a name='5009'>
                        sm_input(i,lout+1,j) = sm_input(i,lin+1,j)<a name='5010'>
                        sm_input(i,lin+1,j) = temp<a name='5011'>
                     END DO<a name='5012'>
                  END DO<a name='5013'>
               END IF<a name='5014'>
            END DO innerm<a name='5015'>
         END DO outerm<a name='5016'>
<font color=#447700>!tgs add IF<a name='5017'></font>
      IF ( flag_soil_layers == 1 ) THEN<a name='5018'>
         DO j = jts , MIN(jde-1,jte)<a name='5019'>
            DO i = its , MIN(ide-1,ite)<a name='5020'>
               sm_input(i,1,j) = sm_input(i,2,j)<a name='5021'>
               sm_input(i,num_sm_levels_input+2,j) = sm_input(i,num_sm_levels_input+1,j)<a name='5022'>
            END DO<a name='5023'>
         END DO<a name='5024'>
      ENDIF<a name='5025'>
<a name='5026'>
         <font color=#447700>!  Sort the levels for liquid moisture.<a name='5027'></font>
<a name='5028'>
         outerw: DO lout = 1 , num_sw_levels_input-1<a name='5029'>
            innerw : DO lin = lout+1 , num_sw_levels_input<a name='5030'>
               IF ( sw_levels_input(lout) .GT. sw_levels_input(lin) ) THEN<a name='5031'>
                  temp = sw_levels_input(lout)<a name='5032'>
                  sw_levels_input(lout) = sw_levels_input(lin)<a name='5033'>
                  sw_levels_input(lin) = NINT(temp)<a name='5034'>
                  DO j = jts , MIN(jde-1,jte)<a name='5035'>
                     DO i = its , MIN(ide-1,ite)<a name='5036'>
                        temp = sw_input(i,lout+1,j)<a name='5037'>
                        sw_input(i,lout+1,j) = sw_input(i,lin+1,j)<a name='5038'>
                        sw_input(i,lin+1,j) = temp<a name='5039'>
                     END DO<a name='5040'>
                  END DO<a name='5041'>
               END IF<a name='5042'>
            END DO innerw<a name='5043'>
         END DO outerw<a name='5044'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='5045'>
            DO j = jts , MIN(jde-1,jte)<a name='5046'>
               DO i = its , MIN(ide-1,ite)<a name='5047'>
                  sw_input(i,1,j) = sw_input(i,2,j)<a name='5048'>
                  sw_input(i,num_sw_levels_input+2,j) = sw_input(i,num_sw_levels_input+1,j)<a name='5049'>
               END DO<a name='5050'>
            END DO<a name='5051'>
         END IF<a name='5052'>
<a name='5053'>
         found_levels = .TRUE.<a name='5054'>
<a name='5055'>
      ELSE IF ( ( num .LE. 0 ) .AND. (  start_date .NE. current_date ) ) THEN<a name='5056'>
<a name='5057'>
         found_levels = .FALSE.<a name='5058'>
<a name='5059'>
      ELSE<a name='5060'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_soil_pre.F.html#INIT_SOIL_4_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1452"> ( &amp;<a name='5061'>
         'No input soil level data (temperature, moisture or liquid, or all are missing). Required for LSM.' )<a name='5062'>
      END IF<a name='5063'>
<a name='5064'>
      <font color=#447700>!  Is it OK to continue?<a name='5065'></font>
<a name='5066'>
      IF ( found_levels ) THEN<a name='5067'>
<a name='5068'>
         <font color=#447700>!tgs:  Here are the levels that we have from the input for temperature.<a name='5069'></font>
<a name='5070'>
         IF ( flag_soil_levels == 1 ) THEN<a name='5071'>
            DO l = 1 , num_st_levels_input<a name='5072'>
               zhave(l) = st_levels_input(l) / 100.<a name='5073'>
            END DO<a name='5074'>
<a name='5075'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we  want (zs).<a name='5076'></font>
<a name='5077'>
         z_wantt : DO lwant = 1 , num_soil_layers<a name='5078'>
            z_havet : DO lhave = 1 , num_st_levels_input -1<a name='5079'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='5080'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='5081'>
                  DO j = jts , MIN(jde-1,jte)<a name='5082'>
                     DO i = its , MIN(ide-1,ite)<a name='5083'>
                        tslb(i,lwant,j)= ( st_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='5084'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant) - zhave(lhave) ) ) / &amp;<a name='5085'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='5086'>
                     END DO<a name='5087'>
                  END DO<a name='5088'>
                  EXIT z_havet<a name='5089'>
               END IF<a name='5090'>
            END DO z_havet<a name='5091'>
         END DO z_wantt<a name='5092'>
<a name='5093'>
         ELSE<a name='5094'>
<a name='5095'>
         <font color=#447700>!  Here are the levels that we have from the input for temperature.  The input levels plus<a name='5096'></font>
         <font color=#447700>!  two more: the skin temperature at 0 cm, and the annual mean  temperature at 300 cm.<a name='5097'></font>
<a name='5098'>
         zhave(1) = 0.<a name='5099'>
         DO l = 1 , num_st_levels_input<a name='5100'>
            zhave(l+1) = st_levels_input(l) / 100.<a name='5101'>
         END DO<a name='5102'>
         zhave(num_st_levels_input+2) = 300. / 100.<a name='5103'>
<a name='5104'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='5105'></font>
<a name='5106'>
         z_wantt_2: DO lwant = 1 , num_soil_layers<a name='5107'>
            z_havet_2 : DO lhave = 1 , num_st_levels_input +2 -1<a name='5108'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='5109'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='5110'>
                  DO j = jts , MIN(jde-1,jte)<a name='5111'>
                     DO i = its , MIN(ide-1,ite)<a name='5112'>
                        tslb(i,lwant,j)= ( st_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='5113'>
                                           st_input(i,lhave+1,j) * ( zs   (lwant) - zhave(lhave) ) ) / &amp;<a name='5114'>
                                                                   ( zhave(lhave+1) - zhave(lhave) )<a name='5115'>
                     END DO<a name='5116'>
                  END DO<a name='5117'>
                  EXIT z_havet_2<a name='5118'>
               END IF<a name='5119'>
            END DO z_havet_2<a name='5120'>
         END DO z_wantt_2<a name='5121'>
<a name='5122'>
      END IF<a name='5123'>
<a name='5124'>
<font color=#447700>!tgs:<a name='5125'></font>
      IF ( flag_soil_levels == 1 ) THEN<a name='5126'>
         DO l = 1 , num_sm_levels_input<a name='5127'>
            zhave(l) = sm_levels_input(l) / 100.<a name='5128'>
         END DO<a name='5129'>
<a name='5130'>
      <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='5131'></font>
<a name='5132'>
      z_wantm : DO lwant = 1 , num_soil_layers<a name='5133'>
         z_havem : DO lhave = 1 , num_sm_levels_input -1<a name='5134'>
            IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='5135'>
                 ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='5136'>
               DO j = jts , MIN(jde-1,jte)<a name='5137'>
                  DO i = its , MIN(ide-1,ite)<a name='5138'>
                     smois(i,lwant,j)= ( sm_input(i,lhave,j ) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='5139'>
                                         sm_input(i,lhave+1,j) * ( zs   (lwant) - zhave(lhave) ) ) / &amp;<a name='5140'>
                                                                 ( zhave(lhave+1) - zhave(lhave) )<a name='5141'>
                    if(smois(i,lwant,j)&lt;=0.0) smois(i,lwant,j) = 0.005<a name='5142'>
                  END DO<a name='5143'>
               END DO<a name='5144'>
               EXIT z_havem<a name='5145'>
            END IF<a name='5146'>
         END DO z_havem<a name='5147'>
      END DO z_wantm<a name='5148'>
<a name='5149'>
      ELSE<a name='5150'>
         <font color=#447700>!  Here are the levels that we have from the input for moisture.  The  input levels plus<a name='5151'></font>
         <font color=#447700>!  two more: a value at 0 cm and one at 300 cm.  The 0 cm value is  taken to be identical<a name='5152'></font>
         <font color=#447700>!  to the most shallow layer's value.  Similarly, the 300 cm value is  taken to be the same<a name='5153'></font>
         <font color=#447700>!  as the most deep layer's value.<a name='5154'></font>
<a name='5155'>
         zhave(1) = 0.<a name='5156'>
         DO l = 1 , num_sm_levels_input<a name='5157'>
            zhave(l+1) = sm_levels_input(l) / 100.<a name='5158'>
         END DO<a name='5159'>
         zhave(num_sm_levels_input+2) = 300. / 100.<a name='5160'>
<a name='5161'>
         <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='5162'></font>
<a name='5163'>
         z_wantm_2 : DO lwant = 1 , num_soil_layers<a name='5164'>
            z_havem_2 : DO lhave = 1 , num_sm_levels_input +2 -1<a name='5165'>
               IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='5166'>
                    ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='5167'>
                  DO j = jts , MIN(jde-1,jte)<a name='5168'>
                     DO i = its , MIN(ide-1,ite)<a name='5169'>
                        smois(i,lwant,j)= ( sm_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='5170'>
                                            sm_input(i,lhave+1,j) * ( zs (lwant  ) - zhave(lhave) ) ) / &amp;<a name='5171'>
                                                                    ( zhave(lhave+1) - zhave(lhave) )<a name='5172'>
                     if(smois(i,lwant,j)&lt;=0.0) smois(i,lwant,j) = 0.005<a name='5173'>
                     END DO<a name='5174'>
                  END DO<a name='5175'>
                  EXIT z_havem_2<a name='5176'>
               END IF<a name='5177'>
            END DO z_havem_2<a name='5178'>
         END DO z_wantm_2<a name='5179'>
       ENDIF<a name='5180'>
<a name='5181'>
         <font color=#447700>!  Any liquid soil moisture to worry about?<a name='5182'></font>
<a name='5183'>
         IF ( num_sw_levels_input .GT. 1 ) THEN<a name='5184'>
<a name='5185'>
            zhave(1) = 0.<a name='5186'>
            DO l = 1 , num_sw_levels_input<a name='5187'>
               zhave(l+1) = sw_levels_input(l) / 100.<a name='5188'>
            END DO<a name='5189'>
            zhave(num_sw_levels_input+2) = 300. / 100.<a name='5190'>
<a name='5191'>
            <font color=#447700>!  Interpolate between the layers we have (zhave) and those that we want (zs).<a name='5192'></font>
<a name='5193'>
            z_wantw : DO lwant = 1 , num_soil_layers<a name='5194'>
               z_havew : DO lhave = 1 , num_sw_levels_input +2 -1<a name='5195'>
                  IF ( ( zs(lwant) .GE. zhave(lhave  ) ) .AND. &amp;<a name='5196'>
                       ( zs(lwant) .LE. zhave(lhave+1) ) ) THEN<a name='5197'>
                     DO j = jts , MIN(jde-1,jte)<a name='5198'>
                        DO i = its , MIN(ide-1,ite)<a name='5199'>
                           sh2o(i,lwant,j)= ( sw_input(i,lhave  ,j) * ( zhave(lhave+1) - zs   (lwant) ) + &amp;<a name='5200'>
                                               sw_input(i,lhave+1,j) * ( zs (lwant  ) - zhave(lhave) ) ) / &amp;<a name='5201'>
                                                                       ( zhave(lhave+1) - zhave(lhave) )<a name='5202'>
                        END DO<a name='5203'>
                     END DO<a name='5204'>
                     EXIT z_havew<a name='5205'>
                  END IF<a name='5206'>
               END DO z_havew<a name='5207'>
            END DO z_wantw<a name='5208'>
<a name='5209'>
         END IF<a name='5210'>
<a name='5211'>
<a name='5212'>
         <font color=#447700>!  Over water, put in reasonable values for soil temperature and  moisture.  These won't be<a name='5213'></font>
         <font color=#447700>!  used, but they will make a more continuous plot.<a name='5214'></font>
<a name='5215'>
         IF ( flag_sst .EQ. 1 ) THEN<a name='5216'>
            DO j = jts , MIN(jde-1,jte)<a name='5217'>
               DO i = its , MIN(ide-1,ite)<a name='5218'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='5219'>
                     DO l = 1 , num_soil_layers<a name='5220'>
                        tslb(i,l,j)= sst(i,j)<a name='5221'>
                        smois(i,l,j)= 1.0<a name='5222'>
                        sh2o (i,l,j)= 1.0<a name='5223'>
                     END DO<a name='5224'>
                  END IF<a name='5225'>
               END DO<a name='5226'>
            END DO<a name='5227'>
         ELSE<a name='5228'>
            DO j = jts , MIN(jde-1,jte)<a name='5229'>
               DO i = its , MIN(ide-1,ite)<a name='5230'>
                  IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='5231'>
                     DO l = 1 , num_soil_layers<a name='5232'>
                        tslb(i,l,j)= tsk(i,j)<a name='5233'>
                        smois(i,l,j)= 1.0<a name='5234'>
                        sh2o (i,l,j)= 1.0<a name='5235'>
                     END DO<a name='5236'>
                  END IF<a name='5237'>
               END DO<a name='5238'>
            END DO<a name='5239'>
         END IF<a name='5240'>
<a name='5241'>
         DEALLOCATE (zhave)<a name='5242'>
<a name='5243'>
      END IF<a name='5244'>
<a name='5245'>
   END SUBROUTINE init_soil_4_real<a name='5246'>
#endif<a name='5247'>
<a name='5248'>
END MODULE module_soil_pre<a name='5249'>
<a name='5250'>
#endif<a name='5251'>
</pre></body></html>