<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<a name='2'>
<A NAME='MED_NEST_MOVE'><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_nest_move</font> ( parent, nest ) <A href='../../call_to/MED_NEST_MOVE.html' TARGET='index'>1</A>,<A href='../../call_from/MED_NEST_MOVE.html' TARGET='index'>57</A><a name='4'>
  <font color=#447700>! Driver layer<a name='5'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_389">, ONLY : domain, get_ijk_from_grid, adjust_domain_dims_for_move<a name='6'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_59">, ONLY : max_nests<a name='7'>
   USE module_utility<a name='8'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_71"><a name='9'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_250">, ONLY : grid_config_rec_type, model_config_rec, model_to_grid_config_rec<a name='10'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_181"><a name='11'>
<font color=#447700>!   USE module_io_domain<a name='12'></font>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>! defined(STUBMPI)<a name='13'></font>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_189">, ONLY : wrf_dm_move_nest,nest_task_offsets,mpi_comm_to_kid,mpi_comm_to_mom, which_kid<a name='14'>
#endif<a name='15'>
   IMPLICIT NONE<a name='16'>
   TYPE(domain) , POINTER                     :: parent, nest, grid<a name='17'>
   INTEGER dx, dy, origdy       <font color=#447700>! number of parent domain points to move<a name='18'></font>
#ifdef MOVE_NESTS<a name='19'>
  <font color=#447700>! Local <a name='20'></font>
   CHARACTER*256 mess<a name='21'>
   INTEGER i, j, k, p, parent_grid_ratio<a name='22'>
   INTEGER px, py       <font color=#447700>! number and direction of nd points to move<a name='23'></font>
   INTEGER                         :: ids , ide , jds , jde , kds , kde , &amp;<a name='24'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='25'>
                                      ips , ipe , jps , jpe , kps , kpe<a name='26'>
   INTEGER ierr, fid, comzilla, kid<a name='27'>
#if ( HWRF == 1 )<a name='28'>
   REAL,PARAMETER           :: con_g       =9.80665e+0<font color=#447700>! gravity             (m/s2)<a name='29'></font>
   REAL,PARAMETER           :: con_rd      =2.8705e+2 <font color=#447700>! gas constant air    (J/kg/K)<a name='30'></font>
   REAL                     :: TLAP,TBAR,EPSI<a name='31'>
#endif<a name='32'>
   LOGICAL input_from_hires<a name='33'>
   LOGICAL saved_restart_value<a name='34'>
   TYPE (grid_config_rec_type)   :: config_flags<a name='35'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='36'>
   LOGICAL, EXTERNAL :: should_not_move<a name='37'>
#if ( HWRF == 1 )<a name='38'>
<font color=#447700>!XUEJIN added for HWRFx<a name='39'></font>
   INTEGER                  :: idum1,idum2 <a name='40'>
   INTEGER                  :: ITS,ITE,JTS,JTE,KTS,KTE<a name='41'>
#else<a name='42'>
<font color=#447700>!<a name='43'></font>
#endif<a name='44'>
<a name='45'>
   INTERFACE<a name='46'>
     SUBROUTINE med_interp_domain ( parent , nest )<a name='47'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_390">, ONLY : domain<a name='48'>
        IMPLICIT NONE<a name='49'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='50'>
     END SUBROUTINE med_interp_domain<a name='51'>
<font color=#447700>!#if ( HWRF == 1 )X<a name='52'></font>
<font color=#447700>! XUEJIN added this directive here to exclude the ARW code<a name='53'></font>
<font color=#447700>!#else<a name='54'></font>
     SUBROUTINE start_domain ( grid , allowed_to_move )<a name='55'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_391">, ONLY : domain<a name='56'>
        IMPLICIT NONE<a name='57'>
        TYPE(domain) :: grid<a name='58'>
        LOGICAL, INTENT(IN) :: allowed_to_move<a name='59'>
     END SUBROUTINE start_domain<a name='60'>
<font color=#447700>!#endif<a name='61'></font>
#if ( EM_CORE == 1 )<a name='62'>
     SUBROUTINE shift_domain_em ( grid, disp_x, disp_y  &amp;<a name='63'>
<font color=#447700>!<a name='64'></font>
# include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_1"><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='65'>
<font color=#447700>!<a name='66'></font>
                           )<a name='67'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_392">, ONLY : domain<a name='68'>
        USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_182"><a name='69'>
        IMPLICIT NONE<a name='70'>
        INTEGER disp_x, disp_y<a name='71'>
        TYPE(domain) , POINTER                 :: grid<a name='72'>
# include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_2"><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='73'>
     END SUBROUTINE shift_domain_em<a name='74'>
#endif<a name='75'>
#if ( NMM_CORE == 1 )<a name='76'>
     SUBROUTINE med_nest_egrid_configure ( parent , nest )<a name='77'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_393"><a name='78'>
        IMPLICIT NONE<a name='79'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='80'>
     END SUBROUTINE med_nest_egrid_configure<a name='81'>
<a name='82'>
     SUBROUTINE med_construct_egrid_weights ( parent , nest )<a name='83'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_394"><a name='84'>
        IMPLICIT NONE<a name='85'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='86'>
     END SUBROUTINE med_construct_egrid_weights<a name='87'>
<a name='88'>
     SUBROUTINE BASE_STATE_PARENT ( Z3d,Q3d,T3d,PSTD,        &amp;<a name='89'>
                                    PINT,T,Q,CWM,            &amp;<a name='90'>
                                    FIS,QSH,PD,PDTOP,PTOP,   &amp;<a name='91'>
                                    ETA1,ETA2,               &amp;<a name='92'>
                                    DETA1,DETA2,             &amp;<a name='93'>
                                    IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='94'>
                                    IMS,IME,JMS,JME,KMS,KME, &amp;<a name='95'>
                                    IPS,IPE,JPS,JPE,KPS,KPE  )<a name='96'>
<font color=#447700>!<a name='97'></font>
#if ( HWRF == 1 )<a name='98'>
<font color=#447700>!XUEJIN added for HWRFx<a name='99'></font>
         USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_114"><a name='100'>
#else<a name='101'>
<font color=#447700>! <a name='102'></font>
#endif<a name='103'>
         IMPLICIT NONE<a name='104'>
         INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='105'>
         INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='106'>
         INTEGER,    INTENT(IN   )                            :: IPS,IPE,JPS,JPE,KPS,KPE<a name='107'>
         REAL,       INTENT(IN   )                            :: PDTOP,PTOP<a name='108'>
         REAL, DIMENSION(KMS:KME),                 INTENT(IN) :: ETA1,ETA2,DETA1,DETA2<a name='109'>
         REAL, DIMENSION(IMS:IME,JMS:JME),         INTENT(IN) :: FIS,PD,QSH<a name='110'>
         REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME), INTENT(IN) :: PINT,T,Q,CWM<a name='111'>
         REAL, DIMENSION(KMS:KME)                , INTENT(OUT):: PSTD<a name='112'>
         REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME), INTENT(OUT):: Z3d,Q3d,T3d<a name='113'>
<a name='114'>
     END SUBROUTINE BASE_STATE_PARENT<a name='115'>
<a name='116'>
     SUBROUTINE NEST_TERRAIN ( nest, config_flags )<a name='117'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_395">, ONLY : domain<a name='118'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_251">, ONLY : grid_config_rec_type<a name='119'>
       IMPLICIT NONE<a name='120'>
       TYPE(domain) , POINTER                        :: nest<a name='121'>
       TYPE(grid_config_rec_type) , INTENT(IN)       :: config_flags<a name='122'>
     END SUBROUTINE NEST_TERRAIN<a name='123'>
<a name='124'>
     SUBROUTINE med_init_domain_constants_nmm ( parent, nest )<a name='125'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_396">, ONLY : domain<a name='126'>
        IMPLICIT NONE<a name='127'>
        TYPE(domain) , POINTER                    :: parent , nest<a name='128'>
     END SUBROUTINE med_init_domain_constants_nmm<a name='129'>
<a name='130'>
     SUBROUTINE shift_domain_nmm ( grid, disp_x, disp_y &amp;<a name='131'>
<font color=#447700>!<a name='132'></font>
# include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_3"><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='133'>
<font color=#447700>!<a name='134'></font>
                           )<a name='135'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_397"><a name='136'>
        IMPLICIT NONE<a name='137'>
        INTEGER disp_x, disp_y<a name='138'>
        TYPE(domain) , POINTER                 :: grid<a name='139'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_4"><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='140'>
     END SUBROUTINE shift_domain_nmm<a name='141'>
#endif<a name='142'>
#if ( HWRF == 1 )<a name='143'>
<font color=#447700>! XUEJIN added this directive here to exclude the ARW code<a name='144'></font>
#else<a name='145'>
     LOGICAL FUNCTION time_for_move ( parent , nest , dx , dy )<a name='146'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_398">, ONLY : domain<a name='147'>
        IMPLICIT NONE<a name='148'>
        TYPE(domain) , POINTER    :: parent , nest<a name='149'>
        INTEGER, INTENT(OUT)      :: dx , dy<a name='150'>
     END FUNCTION time_for_move<a name='151'>
#endif<a name='152'>
<a name='153'>
#if ( HWRF == 1 )<a name='154'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='155'>
<font color=#447700>!     LOGICAL FUNCTION nest_roam ( parent , nest , dx , dy )  !REPLACED BY KWON<a name='156'></font>
<font color=#447700>!<a name='157'></font>
     LOGICAL FUNCTION direction_of_move ( parent , nest , dx , dy )<a name='158'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_399">, ONLY : domain<a name='159'>
        IMPLICIT NONE<a name='160'>
        TYPE(domain) , POINTER    :: parent , nest<a name='161'>
        INTEGER, INTENT(OUT)      :: dx , dy<a name='162'>
     END FUNCTION direction_of_move<a name='163'>
<font color=#447700>!<a name='164'></font>
<font color=#447700>!     END FUNCTION nest_roam                                  !REPLACED BY KWON<a name='165'></font>
#endif<a name='166'>
#endif<a name='167'>
<a name='168'>
#if ( HWRF == 1 )<a name='169'>
<font color=#447700>! XUEJIN added this directive here to exclude the ARW code<a name='170'></font>
#else<a name='171'>
     SUBROUTINE  input_terrain_rsmas ( grid ,                  &amp;<a name='172'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='173'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='174'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='175'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_400">, ONLY : domain<a name='176'>
       IMPLICIT NONE<a name='177'>
       TYPE ( domain ) :: grid<a name='178'>
       INTEGER                           :: ids , ide , jds , jde , kds , kde , &amp;<a name='179'>
                                            ims , ime , jms , jme , kms , kme , &amp;<a name='180'>
                                            ips , ipe , jps , jpe , kps , kpe<a name='181'>
     END SUBROUTINE input_terrain_rsmas<a name='182'>
     SUBROUTINE med_nest_feedback ( parent , nest , config_flags )<a name='183'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_401">, ONLY : domain<a name='184'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_252">, ONLY : grid_config_rec_type<a name='185'>
        IMPLICIT NONE<a name='186'>
       TYPE (domain), POINTER ::  nest , parent<a name='187'>
       TYPE (grid_config_rec_type) config_flags<a name='188'>
     END SUBROUTINE med_nest_feedback<a name='189'>
     SUBROUTINE  blend_terrain ( ter_interpolated , ter_input , &amp;<a name='190'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='191'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='192'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='193'>
       IMPLICIT NONE<a name='194'>
       INTEGER                           :: ids , ide , jds , jde , kds , kde , &amp;<a name='195'>
                                            ims , ime , jms , jme , kms , kme , &amp;<a name='196'>
                                            ips , ipe , jps , jpe , kps , kpe<a name='197'>
       REAL , DIMENSION(ims:ime,jms:jme) :: ter_interpolated<a name='198'>
       REAL , DIMENSION(ims:ime,jms:jme) :: ter_input<a name='199'>
     END SUBROUTINE blend_terrain<a name='200'>
     SUBROUTINE  copy_3d_field ( ter_interpolated , ter_input , &amp;<a name='201'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='202'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='203'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='204'>
       IMPLICIT NONE<a name='205'>
       INTEGER                           :: ids , ide , jds , jde , kds , kde , &amp;<a name='206'>
                                            ims , ime , jms , jme , kms , kme , &amp;<a name='207'>
                                            ips , ipe , jps , jpe , kps , kpe<a name='208'>
       REAL , DIMENSION(ims:ime,jms:jme) :: ter_interpolated<a name='209'>
       REAL , DIMENSION(ims:ime,jms:jme) :: ter_input<a name='210'>
     END SUBROUTINE copy_3d_field<a name='211'>
#endif<a name='212'>
   END INTERFACE<a name='213'>
<a name='214'>
  <font color=#447700>! set grid pointer for code in deref_kludge (if used)<a name='215'></font>
   grid =&gt; nest<a name='216'>
<a name='217'>
   IF ( should_not_move( nest%id ) ) THEN<a name='218'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1182">( 'Nest movement is disabled because of namelist settings' )<a name='219'>
      RETURN<a name='220'>
   ENDIF<a name='221'>
<a name='222'>
<font color=#447700>! if the nest has stopped don't do all this<a name='223'></font>
   IF ( WRFU_ClockIsStopTime(nest%domain_clock ,rc=ierr) ) RETURN<a name='224'>
<a name='225'>
<font color=#447700>! mask should be defined in nest domain<a name='226'></font>
<a name='227'>
#if ( HWRF == 1 )<a name='228'>
  check_direction_of_move: IF ( direction_of_move ( parent , nest , dx, dy ) ) THEN<a name='229'>
#else<a name='230'>
  check_for_move: IF ( time_for_move ( parent , nest , dx, dy ) ) THEN<a name='231'>
#endif<a name='232'>
<a name='233'>
#if ( EM_CORE == 1 )<a name='234'>
     IF ( (dx .gt. 1 .or. dx .lt. -1 ) .or.  &amp;<a name='235'>
          (dy .gt. 1 .or. dy .lt. -1 ) ) THEN<a name='236'>
       WRITE(mess,*)' invalid move: dx, dy ', dx, dy<a name='237'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1356">( mess )<a name='238'>
     ENDIF<a name='239'>
#endif<a name='240'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='241'>
     IF(MOD(dy,2) .NE. 0)THEN<a name='242'>
       origdy = dy<a name='243'>
       dy=dy+sign(1,dy)<a name='244'>
       WRITE(mess,*)'WARNING: DY REDEFINED FOR THE NMM CORE AND RE-SET FROM ',origdy,' TO MASS POINT dy=',dy<a name='245'>
       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_983">(1,mess)<a name='246'>
     ENDIF<a name='247'>
<a name='248'>
     IF ( dx .gt. 1 .or. dx .lt. -1 .or. dy .gt. 2 .or. dy .lt. -2 ) THEN<a name='249'>
3038 format("med_nest_move: TRIED TO SHIFT TOO FAR: dx must be in [-1,1] and dy in [-2,2] but dx=",I0," and dy=",I0)<a name='250'>
       WRITE(mess,3038) dx,dy<a name='251'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1357">( mess )<a name='252'>
     ENDIF<a name='253'>
#endif<a name='254'>
<a name='255'>
     IF (  wrf_dm_on_monitor() ) THEN<a name='256'>
       WRITE(mess,*)' moving ',grid%id,dx,dy<a name='257'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1183">(mess)<a name='258'>
     ENDIF<a name='259'>
<a name='260'>
     CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_103"> (  grid ,                   &amp;<a name='261'>
                               ids, ide, jds, jde, kds, kde,    &amp;<a name='262'>
                               ims, ime, jms, jme, kms, kme,    &amp;<a name='263'>
                               ips, ipe, jps, jpe, kps, kpe    )<a name='264'>
<a name='265'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MOVE_NEST'>wrf_dm_move_nest</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MOVE_NEST_1"> ( parent, nest%intermediate_grid, dx, dy )<a name='266'>
<a name='267'>
     CALL <A href='../../html_code/frame/module_domain.F.html#ADJUST_DOMAIN_DIMS_FOR_MOVE'>adjust_domain_dims_for_move</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_DOMAIN_DIMS_FOR_MOVE_1">( nest%intermediate_grid , dx, dy )<a name='268'>
<a name='269'>
     CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_104"> (  grid ,                   &amp;<a name='270'>
                               ids, ide, jds, jde, kds, kde,    &amp;<a name='271'>
                               ims, ime, jms, jme, kms, kme,    &amp;<a name='272'>
                               ips, ipe, jps, jpe, kps, kpe    )<a name='273'>
<a name='274'>
     grid =&gt; nest <a name='275'>
<a name='276'>
#if ( EM_CORE == 1 )<a name='277'>
     CALL <A href='../../html_code/dyn_em/shift_domain_em.F.html#SHIFT_DOMAIN_EM'>shift_domain_em</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHIFT_DOMAIN_EM_1">( grid, dx, dy  &amp;<a name='278'>
<font color=#447700>!<a name='279'></font>
# include "<A href='../../html_code/include/actual_new_args.inc.html'>actual_new_args.inc</A>"<A NAME="actual_new_args.inc_5"><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='280'>
<font color=#447700>!<a name='281'></font>
                           )<a name='282'>
#endif<a name='283'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='284'>
     CALL <A href='../../html_code/dyn_nmm/shift_domain_nmm.F.html#SHIFT_DOMAIN_NMM'>shift_domain_nmm</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHIFT_DOMAIN_NMM_1">( grid, dx, dy &amp;<a name='285'>
<font color=#447700>!<a name='286'></font>
# include "<A href='../../html_code/include/actual_new_args.inc.html'>actual_new_args.inc</A>"<A NAME="actual_new_args.inc_6"><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='287'>
<font color=#447700>!<a name='288'></font>
                          )<a name='289'>
#endif<a name='290'>
<a name='291'>
     px = grid%parent_grid_ratio*dx<a name='292'>
     py = grid%parent_grid_ratio*dy<a name='293'>
<a name='294'>
     grid%i_parent_start = grid%i_parent_start + px / grid%parent_grid_ratio <a name='295'>
     grid%j_parent_start = grid%j_parent_start + py / grid%parent_grid_ratio<a name='296'>
<a name='297'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>! defined(STUBMPI)<a name='298'></font>
     IF ( (parent%active_this_task .OR. grid%active_this_task) ) THEN<a name='299'>
       IF ( parent%active_this_task ) THEN<a name='300'>
         comzilla = mpi_comm_to_kid( which_kid( grid%id ) , parent%id )<a name='301'>
       ELSE<a name='302'>
         comzilla = mpi_comm_to_mom( grid%id )<a name='303'>
       ENDIF<a name='304'>
       CALL BYTE_BCAST_FROM_ROOT( grid%i_parent_start, IWORDSIZE, nest_task_offsets(nest%id), comzilla )  <font color=#447700>!<a name='305'></font>
       CALL BYTE_BCAST_FROM_ROOT( grid%j_parent_start, IWORDSIZE, nest_task_offsets(nest%id), comzilla )  <font color=#447700>!<a name='306'></font>
     ENDIF<a name='307'>
<a name='308'>
     CALL nl_set_i_parent_start( grid%id, grid%i_parent_start )<a name='309'>
     CALL nl_set_j_parent_start( grid%id, grid%j_parent_start )<a name='310'>
<a name='311'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_31">(grid%id)<a name='312'>
     IF ( wrf_dm_on_monitor() ) THEN<a name='313'>
       write(mess,*)  &amp;<a name='314'>
         'Grid ',grid%id,' New SW corner (in parent x and y):',grid%i_parent_start, grid%j_parent_start<a name='315'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1184">(TRIM(mess))<a name='316'>
     ENDIF<a name='317'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_31">(grid%id)<a name='318'>
#endif<a name='319'>
<a name='320'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='321'>
<a name='322'>
<font color=#447700>!----------------------------------------------------------------------------<a name='323'></font>
<font color=#447700>!  initialize shifted domain configurations including setting up wbd,sbd, etc<a name='324'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='325'></font>
<a name='326'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE'>med_nest_egrid_configure</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_EGRID_CONFIGURE_3"> ( parent , nest )<a name='327'>
<a name='328'>
<font color=#447700>!-------------------------------------------------------------------------<a name='329'></font>
<font color=#447700>!  initialize shifted domain lat-lons and determine weights<a name='330'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='331'></font>
<a name='332'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS'>med_construct_egrid_weights</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_CONSTRUCT_EGRID_WEIGHTS_3"> ( parent, nest )<a name='333'>
<a name='334'>
<font color=#447700>!<a name='335'></font>
<font color=#447700>!   Set new terrain. Since some terrain adjustment is done within the interpolation calls<a name='336'></font>
<font color=#447700>!   at the next step, the new terrain over the nested domain has to be called here.<a name='337'></font>
<font color=#447700>!<a name='338'></font>
<a name='339'>
    CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_82"> ( nest%id , model_config_rec , config_flags )<a name='340'>
<a name='341'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN'>NEST_TERRAIN</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEST_TERRAIN_2"> ( nest, config_flags )<a name='342'>
<a name='343'>
    CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_105"> ( nest ,                   &amp;<a name='344'>
                             ids, ide, jds, jde, kds, kde,    &amp;<a name='345'>
                             ims, ime, jms, jme, kms, kme,    &amp;<a name='346'>
                             ips, ipe, jps, jpe, kps, kpe    )<a name='347'>
<a name='348'>
    IF ( nest%active_this_task ) THEN<a name='349'>
#if ( HWRF == 1 )<a name='350'>
<font color=#447700>!   adjust pint &amp; pressure depth due to height change in nest_terrain<a name='351'></font>
<font color=#447700>!     assume lapse rate of 6.1K/1km<a name='352'></font>
      TLAP=6.1/(con_g*1000.)<a name='353'>
    DO J = MAX(JPS,JDS-PY), MIN(JPE,JDE-1-PY)<a name='354'>
     DO I = MAX(IPS,IDS-PX), MIN(IPE,IDE-1-PX)<a name='355'>
       if(  nest%fis(I,J).ne.nest%hres_fis(I,J) ) then<a name='356'>
       if( nest%T(I,J,1).gt.150. .and. nest%T(I,J,1).lt.400.) then<a name='357'>
       TBAR=ALOG(1.0+TLAP*(nest%fis(I,J)-nest%hres_fis(I,J)) /nest%T(I,J,1))<a name='358'>
       EPSI=TBAR/(con_rd*TLAP)<a name='359'>
<font color=#447700>!      recover pint from pressure depth after move, then adjust for diff topo<a name='360'></font>
       nest%PINT(I,J,1)=nest%PD(I,J)+nest%pdtop+nest%pt<a name='361'>
       nest%PINT(I,J,1)=nest%PINT(I,J,1)*EXP(EPSI)<a name='362'>
       nest%PD(I,J)=nest%PINT(I,J,1)-nest%pdtop-nest%pt  <a name='363'>
<font color=#447700>!       WRITE(0,*)I,J,nest%nmm_PD(I,J),nest%nmm_PINT(I,1,J),nest%nmm_FIS(I,J),nest%nmm_hres_fis(I,J),nest%nmm_pdtop,nest%nmm_pt, &amp;<a name='364'></font>
<font color=#447700>!       'change pd,ptint'<a name='365'></font>
       endif<a name='366'>
       endif<a name='367'>
     ENDDO<a name='368'>
    ENDDO<a name='369'>
#endif<a name='370'>
<a name='371'>
    DO J = JPS, MIN(JPE,JDE-1)<a name='372'>
      DO I = IPS, MIN(IPE,IDE-1)<a name='373'>
       nest%fis(I,J)=nest%hres_fis(I,J)<a name='374'>
     ENDDO<a name='375'>
    ENDDO<a name='376'>
    ENDIF<a name='377'>
<a name='378'>
<font color=#447700>!<a name='379'></font>
<font color=#447700>!  De-reference dimension information stored in the grid data structure.<a name='380'></font>
<font color=#447700>!<a name='381'></font>
<font color=#447700>!  From the hybrid, construct the GPMs on isobaric surfaces and then interpolate those<a name='382'></font>
<font color=#447700>!  values on to the nested domain. 23 standard prssure levels are assumed here. For<a name='383'></font>
<font color=#447700>!  levels below ground, lapse rate atmosphere is assumed before the use of vertical<a name='384'></font>
<font color=#447700>!  spline interpolation<a name='385'></font>
<font color=#447700>!<a name='386'></font>
<a name='387'>
    CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_106"> ( parent ,                   &amp;<a name='388'>
                             ids, ide, jds, jde, kds, kde,    &amp;<a name='389'>
                             ims, ime, jms, jme, kms, kme,    &amp;<a name='390'>
                             ips, ipe, jps, jpe, kps, kpe    )<a name='391'>
<a name='392'>
    <font color=#447700>! CALL BASE_STATE_PARENT ( parent%Z3d,parent%Q3d,parent%T3d,parent%PSTD,  &amp;<a name='393'></font>
    <font color=#447700>!                          parent%PINT,parent%T,parent%Q,parent%CWM,      &amp;<a name='394'></font>
    <font color=#447700>!                          parent%FIS,parent%QSH,parent%PD,parent%pdtop,parent%pt,   &amp;<a name='395'></font>
    <font color=#447700>!                          parent%ETA1,parent%ETA2,                               &amp;<a name='396'></font>
    <font color=#447700>!                          parent%DETA1,parent%DETA2,                             &amp;<a name='397'></font>
    <font color=#447700>!                          IDS,IDE,JDS,JDE,KDS,KDE,                                       &amp;<a name='398'></font>
    <font color=#447700>!                          IMS,IME,JMS,JME,KMS,KME,                                       &amp;<a name='399'></font>
    <font color=#447700>!                          IPS,IPE,JPS,JPE,KPS,KPE                                        )<a name='400'></font>
<a name='401'>
<font color=#447700>!   Initialize some more constants required especially for terrain adjustment processes<a name='402'></font>
<a name='403'>
    nest%PSTD=parent%PSTD<a name='404'>
    nest%KZMAX=KME<a name='405'>
    parent%KZMAX=KME  <font color=#447700>! just for safety<a name='406'></font>
<a name='407'>
<font color=#447700>!    write(0,*) " nest%imask_nostag "<a name='408'></font>
<font color=#447700>!    write(0,"(3X,1X,1000(I3))") (I, I = IPS, MIN(IPE,IDE-1) )<a name='409'></font>
    DO J = MIN(JPE,JDE-1), JPS, -1<a name='410'>
       IF ( MOD(J,2) /= 0 ) THEN<a name='411'>
<font color=#447700>!    write(0,"(I3,1X,1000(I3))") J, (nest%imask_nostag(I,J), I = IPS, MIN(IPE,IDE-1) )<a name='412'></font>
       ELSE<a name='413'>
<font color=#447700>!    write(0,"(I3,3X,1000(I3))") J, (nest%imask_nostag(I,J), I = IPS, MIN(IPE,IDE-1) )<a name='414'></font>
       END IF<a name='415'>
    ENDDO<a name='416'>
<a name='417'>
#endif<a name='418'>
<a name='419'>
     CALL <A href='../../html_code/share/mediation_interp_domain.F.html#MED_INTERP_DOMAIN'>med_interp_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INTERP_DOMAIN_5">( parent, nest )<a name='420'>
<a name='421'>
#if ( EM_CORE == 1 )<a name='422'>
     CALL nl_get_input_from_hires( nest%id , input_from_hires ) <a name='423'>
     IF ( input_from_hires ) THEN<a name='424'>
<a name='425'>
       IF ( nest%active_this_task ) THEN<a name='426'>
<font color=#447700>! store horizontally interpolated terrain in temp location<a name='427'></font>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_7"> ( nest%ht_fine , nest%ht , &amp;<a name='428'>
                             ids , ide , jds , jde , 1   , 1   , &amp;<a name='429'>
                             ims , ime , jms , jme , 1   , 1   , &amp;<a name='430'>
                             ips , ipe , jps , jpe , 1   , 1   )<a name='431'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_8"> ( nest%mub_fine , nest%mub , &amp;<a name='432'>
                             ids , ide , jds , jde , 1   , 1   , &amp;<a name='433'>
                             ims , ime , jms , jme , 1   , 1   , &amp;<a name='434'>
                             ips , ipe , jps , jpe , 1   , 1   )<a name='435'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_9"> ( nest%phb_fine , nest%phb , &amp;<a name='436'>
                             ids , ide , jds , jde , kds , kde , &amp;<a name='437'>
                             ims , ime , jms , jme , kms , kme , &amp;<a name='438'>
                             ips , ipe , jps , jpe , kps , kpe )<a name='439'>
<a name='440'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS'>input_terrain_rsmas</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_TERRAIN_RSMAS_2"> ( nest,                               &amp;<a name='441'>
                                   ids , ide , jds , jde , 1   , 1   , &amp;<a name='442'>
                                   ims , ime , jms , jme , 1   , 1   , &amp;<a name='443'>
                                   ips , ipe , jps , jpe , 1   , 1   )<a name='444'>
<a name='445'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN'>blend_terrain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLEND_TERRAIN_5"> ( nest%ht_fine , nest%ht , &amp;<a name='446'>
                             ids , ide , jds , jde , 1   , 1   , &amp;<a name='447'>
                             ims , ime , jms , jme , 1   , 1   , &amp;<a name='448'>
                             ips , ipe , jps , jpe , 1   , 1   )<a name='449'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN'>blend_terrain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLEND_TERRAIN_6"> ( nest%mub_fine , nest%mub , &amp;<a name='450'>
                             ids , ide , jds , jde , 1   , 1   , &amp;<a name='451'>
                             ims , ime , jms , jme , 1   , 1   , &amp;<a name='452'>
                             ips , ipe , jps , jpe , 1   , 1   )<a name='453'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN'>blend_terrain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLEND_TERRAIN_7"> ( nest%phb_fine , nest%phb , &amp;<a name='454'>
                             ids , ide , jds , jde , kds , kde , &amp;<a name='455'>
                             ims , ime , jms , jme , kms , kme , &amp;<a name='456'>
                             ips , ipe , jps , jpe , kps , kpe )<a name='457'>
       ENDIF<a name='458'>
<font color=#447700>!<a name='459'></font>
       CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_83"> ( parent%id , model_config_rec , config_flags )<a name='460'>
<a name='461'>
       CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK'>med_nest_feedback</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_FEEDBACK_4"> ( parent , nest , config_flags )<a name='462'>
       parent%imask_nostag = 1<a name='463'>
       parent%imask_xstag = 1<a name='464'>
       parent%imask_ystag = 1<a name='465'>
       parent%imask_xystag = 1<a name='466'>
<a name='467'>
<font color=#447700>! start_domain will key off "restart". Even if this is a restart run<a name='468'></font>
<font color=#447700>! we don't want it to here. Save the value, set it to false, and restore afterwards<a name='469'></font>
       saved_restart_value = config_flags%restart<a name='470'>
       config_flags%restart = .FALSE.<a name='471'>
       grid%restart = .FALSE.<a name='472'>
       CALL nl_set_restart ( 1, .FALSE. )<a name='473'>
       grid%press_adj = .FALSE.<a name='474'>
       CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_13"> ( parent , .FALSE. )<a name='475'>
       config_flags%restart = saved_restart_value<a name='476'>
       grid%restart = saved_restart_value<a name='477'>
       CALL nl_set_restart ( 1,  saved_restart_value )<a name='478'>
<a name='479'>
     ENDIF<a name='480'>
#endif<a name='481'>
<a name='482'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='483'>
<font color=#447700>!------------------------------------------------------------------------------<a name='484'></font>
<font color=#447700>!  set up constants (module_initialize_real.F for the shifted nmm domain)<a name='485'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='486'></font>
<a name='487'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM'>med_init_domain_constants_nmm</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INIT_DOMAIN_CONSTANTS_NMM_3"> ( parent, nest )<a name='488'>
<a name='489'>
#endif<a name='490'>
<a name='491'>
<font color=#447700>!<a name='492'></font>
<font color=#447700>! masks associated with nest will have been set by shift_domain_em above<a name='493'></font>
     nest%moved = .true.<a name='494'>
<font color=#447700>! start_domain will key off "restart". Even if this is a restart run<a name='495'></font>
<font color=#447700>! we don't want it to here. Save the value, set it to false, and restore afterwards<a name='496'></font>
     saved_restart_value = config_flags%restart<a name='497'>
     config_flags%restart = .FALSE.<a name='498'>
     CALL nl_set_restart ( 1, .FALSE. )<a name='499'>
     grid%restart = .FALSE.<a name='500'>
#if ( EM_CORE == 1 )<a name='501'>
     nest%press_adj = .FALSE.<a name='502'>
#endif<a name='503'>
<a name='504'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>! defined(STUBMPI)<a name='505'></font>
<a name='506'>
     IF ( nest%active_this_task ) THEN<a name='507'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_32">(nest%id)<a name='508'>
       CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_14"> ( nest , .FALSE. )<a name='509'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_32"><a name='510'>
     ENDIF<a name='511'>
#endif<a name='512'>
     config_flags%restart = saved_restart_value<a name='513'>
     grid%restart = saved_restart_value<a name='514'>
     CALL nl_set_restart ( 1,  saved_restart_value )<a name='515'>
     nest%moved = .false.<a name='516'>
      <a name='517'>
<font color=#447700>!<a name='518'></font>
<font color=#447700>! copy time level 2 to time level 1 in new regions of multi-time level fields<a name='519'></font>
<font color=#447700>! this should be registry generated.<a name='520'></font>
<font color=#447700>!<a name='521'></font>
#if ( EM_CORE == 1 )<a name='522'>
     IF ( nest%active_this_task ) THEN<a name='523'>
      do k = kms,kme<a name='524'>
        where ( nest%imask_xstag  .EQ. 1 ) nest%u_1(:,k,:)   = nest%u_2(:,k,:)<a name='525'>
        where ( nest%imask_ystag  .EQ. 1 ) nest%v_1(:,k,:)   = nest%v_2(:,k,:)<a name='526'>
        where ( nest%imask_nostag .EQ. 1 ) nest%t_1(:,k,:)   = nest%t_2(:,k,:)<a name='527'>
        where ( nest%imask_nostag .EQ. 1 ) nest%w_1(:,k,:)   = nest%w_2(:,k,:)<a name='528'>
        where ( nest%imask_nostag .EQ. 1 ) nest%ph_1(:,k,:)  = nest%ph_2(:,k,:)<a name='529'>
        where ( nest%imask_nostag .EQ. 1 ) nest%tke_1(:,k,:) = nest%tke_2(:,k,:)<a name='530'>
      enddo<a name='531'>
      where ( nest%imask_nostag .EQ. 1 ) nest%mu_1(:,:)  = nest%mu_2(:,:)<a name='532'>
     ENDIF<a name='533'>
#endif<a name='534'>
<font color=#447700>!<a name='535'></font>
#if ( HWRF == 1 )<a name='536'>
   ENDIF check_direction_of_move<a name='537'>
#else<a name='538'>
   ENDIF check_for_move<a name='539'>
#endif<a name='540'>
<a name='541'>
#endif<a name='542'>
END SUBROUTINE med_nest_move<a name='543'>
<a name='544'>
<A NAME='TIME_FOR_MOVE2'><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='545'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>time_for_move2</font> ( parent , grid , move_cd_x, move_cd_y ),<A href='../../call_from/TIME_FOR_MOVE2.html' TARGET='index'>53</A><a name='546'>
  <font color=#447700>! Driver layer<a name='547'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_402">, ONLY : domain, domain_clock_get, get_ijk_from_grid, adjust_domain_dims_for_move<a name='548'>
<font color=#447700>!   USE module_configure<a name='549'></font>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_60">, ONLY : max_moves<a name='550'>
   USE <A href='../../html_code/share/module_compute_geop.F.html#MODULE_COMPUTE_GEOP'>module_compute_geop</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMPUTE_GEOP_1"><a name='551'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_190">, ONLY : wrf_dm_max_real, wrf_dm_move_nest<a name='552'>
   USE module_utility<a name='553'>
   USE <A href='../../html_code/frame/module_streams.F.html#MODULE_STREAMS'>module_streams</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STREAMS_11">, ONLY : compute_vortex_center_alarm<a name='554'>
   IMPLICIT NONE<a name='555'>
<font color=#447700>! Arguments<a name='556'></font>
   TYPE(domain) , POINTER    :: parent, grid<a name='557'>
   INTEGER, INTENT(OUT)      :: move_cd_x , move_cd_y<a name='558'>
#ifdef MOVE_NESTS<a name='559'>
<font color=#447700>! Local<a name='560'></font>
   INTEGER  num_moves, rc<a name='561'>
   INTEGER  move_interval , move_id<a name='562'>
   TYPE(WRFU_Time) :: ct, st<a name='563'>
   TYPE(WRFU_TimeInterval) :: ti<a name='564'>
   CHARACTER*256 mess, timestr<a name='565'>
   INTEGER     :: ids, ide, jds, jde, kds, kde, &amp;<a name='566'>
                  ims, ime, jms, jme, kms, kme, &amp;<a name='567'>
                  ips, ipe, jps, jpe, kps, kpe<a name='568'>
   INTEGER :: is, ie, js, je, ierr<a name='569'>
   REAL    :: ipbar, pbar, jpbar, fact<a name='570'>
   REAL    :: last_vc_i , last_vc_j<a name='571'>
<a name='572'>
   REAL, ALLOCATABLE, DIMENSION(:,:) :: height_l, height<a name='573'>
   REAL, ALLOCATABLE, DIMENSION(:,:) :: psfc, xlat, xlong, terrain<a name='574'>
   REAL :: minh, maxh<a name='575'>
   INTEGER :: mini, minj, maxi, maxj, i, j, pgr, irad<a name='576'>
   REAL :: disp_x, disp_y, lag, radius, center_i, center_j, dx<a name='577'>
   REAL :: dijsmooth, vmax, vmin, a, b<a name='578'>
   REAL :: dc_i, dc_j   <font color=#447700>! domain center<a name='579'></font>
   REAL :: maxws, ws<a name='580'>
   REAL :: pmin<a name='581'>
   INTEGER imploc, jmploc <a name='582'>
<a name='583'>
   INTEGER :: fje, fjs, fie, fis, fimloc, fjmloc, imloc, jmloc<a name='584'>
   INTEGER :: i_parent_start, j_parent_start<a name='585'>
   INTEGER :: max_vortex_speed, vortex_interval  <font color=#447700>! meters per second and seconds<a name='586'></font>
   INTEGER :: track_level<a name='587'>
   REAL    :: rsmooth = 100000.  <font color=#447700>! in meters<a name='588'></font>
<a name='589'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='590'>
<a name='591'>
character*256 message, message2<a name='592'>
<a name='593'>
<font color=#447700>!#define MOVING_DIAGS<a name='594'></font>
# ifdef VORTEX_CENTER<a name='595'>
<a name='596'>
<a name='597'>
   CALL nl_get_parent_grid_ratio ( grid%id , pgr )<a name='598'>
   CALL nl_get_i_parent_start    ( grid%id , i_parent_start )<a name='599'>
   CALL nl_get_j_parent_start    ( grid%id , j_parent_start )<a name='600'>
   CALL nl_get_track_level       ( grid%id , track_level )<a name='601'>
<a name='602'>
<font color=#447700>!  WRITE(mess,*)'Vortex is tracked at ', track_level<a name='603'></font>
<font color=#447700>!  CALL wrf_message(mess)<a name='604'></font>
<a name='605'>
   CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_107"> (  grid ,                        &amp;<a name='606'>
                             ids, ide, jds, jde, kds, kde, &amp;<a name='607'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='608'>
                             ips, ipe, jps, jpe, kps, kpe  )<a name='609'>
<a name='610'>
<font color=#447700>! If the alarm is ringing, recompute the Vortex Center (VC); otherwise<a name='611'></font>
<font color=#447700>! use the previous position of VC.  VC is not recomputed ever step to<a name='612'></font>
<font color=#447700>! save on cost for global collection of height field and broadcast<a name='613'></font>
<font color=#447700>! of new center.<a name='614'></font>
<a name='615'>
#  ifdef MOVING_DIAGS<a name='616'>
write(message,*)'Check to see if COMPUTE_VORTEX_CENTER_ALARM is ringing? '<a name='617'>
call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_984">(1,message)<a name='618'>
#  endif<a name='619'>
   CALL nl_get_parent_grid_ratio ( grid%id , pgr )<a name='620'>
   CALL nl_get_dx ( grid%id , dx )<a name='621'>
<a name='622'>
   IF ( WRFU_AlarmIsRinging( grid%alarms( COMPUTE_VORTEX_CENTER_ALARM ), rc=rc ) ) THEN<a name='623'>
<a name='624'>
#  ifdef MOVING_DIAGS<a name='625'>
     write(message,*)'COMPUTE_VORTEX_CENTER_ALARM is ringing  '<a name='626'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_985">(1,message)<a name='627'>
#  endif<a name='628'>
     CALL WRFU_AlarmRingerOff( grid%alarms( COMPUTE_VORTEX_CENTER_ALARM ), rc=rc )<a name='629'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_74">( grid, current_timestr=timestr )<a name='630'>
<a name='631'>
     last_vc_i = grid%vc_i<a name='632'>
     last_vc_j = grid%vc_j<a name='633'>
<a name='634'>
     ALLOCATE ( height_l ( ims:ime , jms:jme ), STAT=ierr )<a name='635'>
     IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1358"> ('allocating height_l in time_for_move2')<a name='636'>
     IF ( wrf_dm_on_monitor() ) THEN<a name='637'>
       ALLOCATE ( height   ( ids:ide , jds:jde ), STAT=ierr )<a name='638'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1359"> ('allocating height in time_for_move2')<a name='639'>
       ALLOCATE ( psfc     ( ids:ide , jds:jde ), STAT=ierr )<a name='640'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1360"> ('allocating psfc in time_for_move2')<a name='641'>
       ALLOCATE ( xlat     ( ids:ide , jds:jde ), STAT=ierr )<a name='642'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1361"> ('allocating xlat in time_for_move2')<a name='643'>
       ALLOCATE ( xlong    ( ids:ide , jds:jde ), STAT=ierr )<a name='644'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1362"> ('allocating xlong in time_for_move2')<a name='645'>
       ALLOCATE ( terrain  ( ids:ide , jds:jde ), STAT=ierr )<a name='646'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1363"> ('allocating terrain in time_for_move2')<a name='647'>
     ELSE<a name='648'>
       ALLOCATE ( height   ( 1:1 , 1:1 ), STAT=ierr )<a name='649'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1364"> ('allocating height in time_for_move2')<a name='650'>
       ALLOCATE ( psfc     ( 1:1 , 1:1 ), STAT=ierr )<a name='651'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1365"> ('allocating psfc in time_for_move2')<a name='652'>
       ALLOCATE ( xlat     ( 1:1 , 1:1 ), STAT=ierr )<a name='653'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1366"> ('allocating xlat in time_for_move2')<a name='654'>
       ALLOCATE ( xlong    ( 1:1 , 1:1 ), STAT=ierr )<a name='655'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1367"> ('allocating xlong in time_for_move2')<a name='656'>
       ALLOCATE ( terrain  ( 1:1 , 1:1 ), STAT=ierr )<a name='657'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1368"> ('allocating terrain in time_for_move2')<a name='658'>
     ENDIF<a name='659'>
<a name='660'>
#  if (EM_CORE == 1)<a name='661'>
     CALL <A href='../../html_code/share/module_compute_geop.F.html#COMPUTE_500MB_HEIGHT'>compute_500mb_height</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_500MB_HEIGHT_1"> ( grid%ph_2 , grid%phb, grid%p, grid%pb, height_l , &amp;<a name='662'>
                                 track_level,                  &amp;<a name='663'>
                                 ids, ide, jds, jde, kds, kde, &amp;<a name='664'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='665'>
                                 ips, ipe, jps, jpe, kps, kpe  )<a name='666'>
#  endif<a name='667'>
<a name='668'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_13"> ( height_l , height , grid%domdesc, "z", "xy", &amp;<a name='669'>
                                     ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='670'>
                                     ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='671'>
                                     ips, ipe   , jps , jpe   , 1 , 1   )<a name='672'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_14"> ( grid%psfc , psfc , grid%domdesc, "z", "xy", &amp;<a name='673'>
                                     ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='674'>
                                     ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='675'>
                                     ips, ipe   , jps , jpe   , 1 , 1   )<a name='676'>
#if(NMM_CORE==1)<a name='677'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_15"> ( grid%hlat , xlat , grid%domdesc, "z", "xy", &amp;<a name='678'>
                                     ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='679'>
                                     ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='680'>
                                     ips, ipe   , jps , jpe   , 1 , 1   )<a name='681'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_16"> ( grid%hlon , xlong , grid%domdesc, "z", "xy", &amp;<a name='682'>
                                     ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='683'>
                                     ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='684'>
                                     ips, ipe   , jps , jpe   , 1 , 1   )<a name='685'>
#else<a name='686'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_17"> ( grid%xlat , xlat , grid%domdesc, "z", "xy", &amp;<a name='687'>
                                     ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='688'>
                                     ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='689'>
                                     ips, ipe   , jps , jpe   , 1 , 1   )<a name='690'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_18"> ( grid%xlong , xlong , grid%domdesc, "z", "xy", &amp;<a name='691'>
                                     ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='692'>
                                     ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='693'>
                                     ips, ipe   , jps , jpe   , 1 , 1   )<a name='694'>
#endif<a name='695'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_19"> ( grid%ht , terrain , grid%domdesc, "z", "xy", &amp;<a name='696'>
                                     ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='697'>
                                     ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='698'>
                                     ips, ipe   , jps , jpe   , 1 , 1   )<a name='699'>
<a name='700'>
<font color=#447700>! calculate max wind speed<a name='701'></font>
     maxws = 0.<a name='702'>
     do j = jps, jpe<a name='703'>
       do i = ips, ipe<a name='704'>
         ws = grid%u10(i,j) * grid%u10(i,j) + grid%v10(i,j) * grid%v10(i,j)<a name='705'>
         if ( ws &gt; maxws ) maxws = ws<a name='706'>
       enddo<a name='707'>
     enddo<a name='708'>
     maxws = sqrt ( maxws )<a name='709'>
     maxws = wrf_dm_max_real ( maxws )<a name='710'>
<a name='711'>
     monitor_only : IF ( wrf_dm_on_monitor() ) THEN<a name='712'>
<a name='713'>
<font color=#447700>!<a name='714'></font>
<font color=#447700>! This vortex center finding code adapted from the Hurricane version of MM5,<a name='715'></font>
<font color=#447700>! Courtesy:<a name='716'></font>
<font color=#447700>!<a name='717'></font>
<font color=#447700>!   Shuyi Chen et al., Rosenstiel School of Marine and Atmos. Sci., U. Miami.<a name='718'></font>
<font color=#447700>!   Spring, 2005<a name='719'></font>
<font color=#447700>!<a name='720'></font>
<font color=#447700>! Get the first guess vortex center about which we do our search<a name='721'></font>
<font color=#447700>! as mini and minh; minimum value is minh<a name='722'></font>
<font color=#447700>!<a name='723'></font>
<a name='724'>
       CALL nl_get_vortex_interval( grid%id , vortex_interval )<a name='725'>
       CALL nl_get_max_vortex_speed( grid%id , max_vortex_speed )<a name='726'>
<a name='727'>
       IF ( grid%vc_i &lt; 0. .AND. grid%vc_j &lt; 0. ) THEN<a name='728'>
          <font color=#447700>! first time through<a name='729'></font>
          is = ids<a name='730'>
          ie = ide-1<a name='731'>
          js = jds<a name='732'>
          je = jde-1<a name='733'>
       ELSE<a name='734'>
          <font color=#447700>! limit the search to an area around the vortex<a name='735'></font>
          <font color=#447700>! that is limited by max_vortex_speed (default 40) meters per second from<a name='736'></font>
          <font color=#447700>! previous location over vortex_interval (default 15 mins)<a name='737'></font>
<a name='738'>
          is = max( grid%vc_i - 60 * vortex_interval * max_vortex_speed / dx , 1.0 * ids )<a name='739'>
          js = max( grid%vc_j - 60 * vortex_interval * max_vortex_speed / dx , 1.0 * jds )<a name='740'>
          ie = min( grid%vc_i + 60 * vortex_interval * max_vortex_speed / dx , 1.0 * (ide-1) )<a name='741'>
          je = min( grid%vc_j + 60 * vortex_interval * max_vortex_speed / dx , 1.0 * (jde-1) )<a name='742'>
<a name='743'>
       ENDIF<a name='744'>
<a name='745'>
#  ifdef MOVING_DIAGS<a name='746'>
write(message,*)'search set around last position '<a name='747'>
call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_986">(1,message)<a name='748'>
write(message,*)'   is, ids-1,  ie,  ide-1 ', is, ids-1, ie, ide-1<a name='749'>
call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_987">(1,message)<a name='750'>
write(message,*)'   js, jds-1,  je,  jde-1 ', js, jds-1, je, jde-1<a name='751'>
call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_988">(1,message)<a name='752'>
#  endif<a name='753'>
<a name='754'>
       imploc = -1<a name='755'>
       jmploc = -1<a name='756'>
<a name='757'>
       <font color=#447700>! find minimum psfc<a name='758'></font>
       pmin = 99999999.0     <font color=#447700>! make this very large to be sure we find a minumum<a name='759'></font>
       DO j = js, je<a name='760'>
       DO i = is, ie<a name='761'>
         <font color=#447700>! adjust approximately to sea level pressure (same as below: ATCF)<a name='762'></font>
         psfc(i,j)=psfc(i,j)+11.38*terrain(i,j)<a name='763'>
         IF ( psfc(i,j) .LT. pmin ) THEN<a name='764'>
           pmin = psfc(i,j)<a name='765'>
           imploc = i<a name='766'>
           jmploc = j<a name='767'>
         ENDIF<a name='768'>
       ENDDO<a name='769'>
       ENDDO<a name='770'>
<a name='771'>
       IF ( imploc .EQ. -1 .OR. jmploc .EQ. -1 ) THEN  <font color=#447700>! if we fail to find a min there is something seriously wrong<a name='772'></font>
         WRITE(mess,*)'i,j,is,ie,js,je,imploc,jmploc ',i,j,is,ie,js,je,imploc,jmploc<a name='773'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1185">(mess)<a name='774'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1369">('time_for_move2: Method failure searching for minimum psfc.')<a name='775'>
       ENDIF<a name='776'>
<a name='777'>
       imloc = -1<a name='778'>
       jmloc = -1<a name='779'>
       maxi = -1<a name='780'>
       maxj = -1<a name='781'>
<a name='782'>
       <font color=#447700>! find local min, max<a name='783'></font>
       vmin =  99999999.0<a name='784'>
       vmax = -99999999.0<a name='785'>
       DO j = js, je<a name='786'>
       DO i = is, ie<a name='787'>
         IF ( height(i,j) .LT. vmin ) THEN<a name='788'>
           vmin = height(i,j)<a name='789'>
           imloc = i<a name='790'>
           jmloc = j<a name='791'>
         ENDIF<a name='792'>
         IF ( height(i,j) .GT. vmax ) THEN<a name='793'>
           vmax = height(i,j)<a name='794'>
           maxi = i<a name='795'>
           maxj = j<a name='796'>
         ENDIF<a name='797'>
       ENDDO<a name='798'>
       ENDDO<a name='799'>
<a name='800'>
       IF ( imloc .EQ. -1 .OR. jmloc .EQ. -1 .OR. maxi .EQ. -1 .OR. maxj .EQ. -1 ) THEN<a name='801'>
         WRITE(mess,*)'i,j,is,ie,js,je,imloc,jmloc,maxi,maxj ',i,j,is,ie,js,je,imloc,jmloc,maxi,maxj<a name='802'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1186">(mess)<a name='803'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1370">('time_for_move2: Method failure searching max/min of height.')<a name='804'>
       ENDIF<a name='805'>
<a name='806'>
       fimloc = imloc<a name='807'>
       fjmloc = jmloc<a name='808'>
<a name='809'>
       if ( grid%xi .EQ. -1. ) grid%xi = fimloc<a name='810'>
       if ( grid%xj .EQ. -1. ) grid%xj = fjmloc<a name='811'>
<a name='812'>
       dijsmooth = rsmooth / dx<a name='813'>
<a name='814'>
       fjs = max(fjmloc-dijsmooth,1.0)<a name='815'>
       fje = min(fjmloc+dijsmooth,jde-2.0)<a name='816'>
       fis = max(fimloc-dijsmooth,1.0)<a name='817'>
       fie = min(fimloc+dijsmooth,ide-2.0)<a name='818'>
       js = fjs<a name='819'>
       je = fje<a name='820'>
       is = fis<a name='821'>
       ie = fie<a name='822'>
<a name='823'>
       vmin =  1000000.0<a name='824'>
       vmax = -1000000.0<a name='825'>
       DO j = js, je<a name='826'>
       DO i = is, ie<a name='827'>
         IF ( height(i,j) .GT. vmax ) THEN<a name='828'>
           vmax = height(i,j)<a name='829'>
         ENDIF<a name='830'>
       ENDDO<a name='831'>
       ENDDO<a name='832'>
<a name='833'>
       pbar  = 0.0<a name='834'>
       ipbar = 0.0<a name='835'>
       jpbar = 0.0<a name='836'>
<a name='837'>
       do j=js,je<a name='838'>
          do i=is,ie<a name='839'>
             fact = vmax - height(i,j)<a name='840'>
             pbar  = pbar + fact<a name='841'>
             ipbar = ipbar + fact*(i-is)<a name='842'>
             jpbar = jpbar + fact*(j-js)<a name='843'>
          enddo<a name='844'>
       enddo<a name='845'>
<a name='846'>
      IF ( pbar .NE. 0. ) THEN<a name='847'>
<a name='848'>
<font color=#447700>!     Compute an adjusted, smoothed, vortex center location in cross<a name='849'></font>
<font color=#447700>!     point index space.<a name='850'></font>
<font color=#447700>!     Time average. A is coef for old information; B is new<a name='851'></font>
<font color=#447700>!     If pbar is zero then just skip this, leave xi and xj alone,<a name='852'></font>
<font color=#447700>!     result will be no movement.<a name='853'></font>
         a = 0.0<a name='854'>
         b = 1.0<a name='855'>
         grid%xi =  (a * grid%xi + b * (is + ipbar / pbar))  / ( a + b )<a name='856'>
         grid%xj =  (a * grid%xj + b * (js + jpbar / pbar))  / ( a + b )<a name='857'>
<a name='858'>
         grid%vc_i = grid%xi + .5<a name='859'>
         grid%vc_j = grid%xj + .5<a name='860'>
<a name='861'>
<a name='862'>
      ENDIF<a name='863'>
<a name='864'>
#  ifdef MOVING_DIAGS<a name='865'>
write(message,*)'computed grid%vc_i, grid%vc_j ',grid%vc_i, grid%vc_j<a name='866'>
call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_989">(1,message)<a name='867'>
i = grid%vc_i ; j = grid%vc_j ; height( i,j ) = height(i,j) * 1.2   <font color=#447700>!mark the center<a name='868'></font>
CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_75">( grid, current_timestr=message2 )<a name='869'>
WRITE ( message , FMT = '(A," on domain ",I3)' ) TRIM(message2), grid%id<a name='870'>
#  endif<a name='871'>
<a name='872'>
<font color=#447700>! <a name='873'></font>
        i = INT(grid%xi+.5)<a name='874'>
        j = INT(grid%xj+.5)<a name='875'>
        write(mess,'("ATCF"," ",A19," ",f8.2," ",f8.2," ",f6.1," ",f6.1)')                &amp;<a name='876'>
                                       timestr(1:19),                               &amp;<a name='877'>
                                       xlat(i,j),                                   &amp;<a name='878'>
                                       xlong(i,j),                                  &amp;<a name='879'>
                                       0.01*pmin,                                   &amp;<a name='880'>
<font color=#447700>!already computed above                0.01*pmin+0.1138*terrain(imploc,jmploc),     &amp;<a name='881'></font>
                                       maxws*1.94<a name='882'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1187">(TRIM(mess))<a name='883'>
                            <a name='884'>
<a name='885'>
<a name='886'>
     ENDIF monitor_only<a name='887'>
<a name='888'>
     DEALLOCATE ( psfc )<a name='889'>
     DEALLOCATE ( xlat )<a name='890'>
     DEALLOCATE ( xlong )<a name='891'>
     DEALLOCATE ( terrain )<a name='892'>
     DEALLOCATE ( height )<a name='893'>
     DEALLOCATE ( height_l )<a name='894'>
<a name='895'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_152">( grid%vc_i , 1 )<a name='896'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_153">( grid%vc_j , 1 )<a name='897'>
<a name='898'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_154">( pmin , 1 )<a name='899'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_66">( imploc , 1 )<a name='900'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_67">( jmploc , 1 )<a name='901'>
<a name='902'>
#  ifdef MOVING_DIAGS<a name='903'>
write(message,*)'after bcast : grid%vc_i, grid%vc_j ',grid%vc_i, grid%vc_j<a name='904'>
call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_990">(1,message)<a name='905'>
#  endif<a name='906'>
<a name='907'>
<a name='908'>
   ENDIF   <font color=#447700>! COMPUTE_VORTEX_CENTER_ALARM ringing<a name='909'></font>
<a name='910'>
#  ifdef MOVING_DIAGS<a name='911'>
write(message,*)'After ENDIF : grid%vc_i, grid%vc_j ',grid%vc_i, grid%vc_j<a name='912'>
call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_991">(1,message)<a name='913'>
#  endif<a name='914'>
<a name='915'>
   dc_i = (ide-ids+1)/2.    <font color=#447700>! domain center<a name='916'></font>
   dc_j = (jde-jds+1)/2.<a name='917'>
<a name='918'>
   disp_x = grid%vc_i - dc_i * 1.0<a name='919'>
   disp_y = grid%vc_j - dc_j * 1.0<a name='920'>
<a name='921'>
#if 0<a name='922'>
<font color=#447700>! This appears to be an old, redundant, and perhaps even misnamed parameter. <a name='923'></font>
<font color=#447700>! Remove it from the namelist and Registry and just hard code it to <a name='924'></font>
<font color=#447700>! the default of 6. JM 20050721<a name='925'></font>
   CALL nl_get_vortex_search_radius( 1, irad )<a name='926'>
#else<a name='927'>
   irad = 6<a name='928'>
#endif<a name='929'>
<a name='930'>
   radius = irad<a name='931'>
<a name='932'>
   if ( disp_x .GT. 0 ) disp_x = min( disp_x , radius )<a name='933'>
   if ( disp_y .GT. 0 ) disp_y = min( disp_y , radius )<a name='934'>
<a name='935'>
   if ( disp_x .LT. 0 ) disp_x = max( disp_x , -radius )<a name='936'>
   if ( disp_y .LT. 0 ) disp_y = max( disp_y , -radius )<a name='937'>
<a name='938'>
   move_cd_x = int ( disp_x  / pgr )<a name='939'>
   move_cd_y = int ( disp_y  / pgr )<a name='940'>
<a name='941'>
   IF ( move_cd_x .GT. 0 ) move_cd_x = min ( move_cd_x , 1 )<a name='942'>
   IF ( move_cd_y .GT. 0 ) move_cd_y = min ( move_cd_y , 1 )<a name='943'>
   IF ( move_cd_x .LT. 0 ) move_cd_x = max ( move_cd_x , -1 )<a name='944'>
   IF ( move_cd_y .LT. 0 ) move_cd_y = max ( move_cd_y , -1 )<a name='945'>
<a name='946'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_76">( grid, current_timestr=timestr )<a name='947'>
<a name='948'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='949'>
     WRITE(mess,*)timestr(1:19),' vortex center (in nest x and y): ',grid%vc_i, grid%vc_j<a name='950'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1188">(TRIM(mess))<a name='951'>
     WRITE(mess,*)timestr(1:19),' grid   center (in nest x and y): ',     dc_i,      dc_j<a name='952'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1189">(TRIM(mess))<a name='953'>
     WRITE(mess,*)timestr(1:19),' disp          : ',   disp_x,    disp_y<a name='954'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1190">(TRIM(mess))<a name='955'>
     WRITE(mess,*)timestr(1:19),' move (rel cd) : ',move_cd_x, move_cd_y<a name='956'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1191">(TRIM(mess))<a name='957'>
   ENDIF<a name='958'>
<a name='959'>
   grid%vc_i = grid%vc_i - move_cd_x * pgr<a name='960'>
   grid%vc_j = grid%vc_j - move_cd_y * pgr<a name='961'>
<a name='962'>
#  ifdef MOVING_DIAGS<a name='963'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='964'>
write(mess,*)' changing grid%vc_i,  move_cd_x * pgr ', grid%vc_i, move_cd_x * pgr, move_cd_x, pgr<a name='965'>
call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_992">(1,mess)<a name='966'>
   ENDIF<a name='967'>
#  endif<a name='968'>
<a name='969'>
   IF ( ( move_cd_x .NE. 0 ) .OR. ( move_cd_y .NE. 0 ) ) THEN<a name='970'>
     time_for_move2 = .TRUE.<a name='971'>
   ELSE<a name='972'>
     time_for_move2 = .FALSE.<a name='973'>
   ENDIF<a name='974'>
<a name='975'>
# else<a name='976'>
<font color=#447700>! from namelist<a name='977'></font>
   move_cd_x = 0<a name='978'>
   move_cd_y = 0<a name='979'>
   time_for_move2 = .FALSE.<a name='980'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_77">( grid, current_time=ct, start_time=st )<a name='981'>
   CALL nl_get_num_moves( 1, num_moves )<a name='982'>
   IF ( num_moves .GT. max_moves ) THEN<a name='983'>
     WRITE(mess,*)'time_for_moves2: num_moves (',num_moves,') .GT. max_moves (',max_moves,')'<a name='984'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1371">( TRIM(mess) )<a name='985'>
   ENDIF<a name='986'>
   DO i = 1, num_moves<a name='987'>
     CALL nl_get_move_id( i, move_id )<a name='988'>
     IF ( move_id .EQ. grid%id ) THEN<a name='989'>
       CALL nl_get_move_interval( i, move_interval )<a name='990'>
       IF ( move_interval .LT. 999999999 ) THEN<a name='991'>
         CALL WRFU_TimeIntervalSet ( ti, M=move_interval, rc=rc )<a name='992'>
         IF ( ct .GE. st + ti ) THEN<a name='993'>
           CALL nl_get_move_cd_x ( i, move_cd_x )<a name='994'>
           CALL nl_get_move_cd_y ( i, move_cd_y )<a name='995'>
           CALL nl_set_move_interval ( i, 999999999 )<a name='996'>
           time_for_move2 = .TRUE.<a name='997'>
           EXIT<a name='998'>
         ENDIF<a name='999'>
       ENDIF<a name='1000'>
     ENDIF<a name='1001'>
   ENDDO<a name='1002'>
# endif<a name='1003'>
   RETURN<a name='1004'>
#else<a name='1005'>
   time_for_move2 = .FALSE.<a name='1006'>
#endif<a name='1007'>
END FUNCTION time_for_move2<a name='1008'>
<a name='1009'>
<A NAME='TIME_FOR_MOVE'><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1010'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>time_for_move</font> ( parent , grid , move_cd_x, move_cd_y ),<A href='../../call_from/TIME_FOR_MOVE.html' TARGET='index'>14</A><a name='1011'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_403">, ONLY : domain, get_ijk_from_grid, adjust_domain_dims_for_move<a name='1012'>
<font color=#447700>!   USE module_configure<a name='1013'></font>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_191">, ONLY : wrf_dm_move_nest<a name='1014'>
USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_72"><a name='1015'>
   USE module_utility<a name='1016'>
   IMPLICIT NONE<a name='1017'>
<font color=#447700>! arguments<a name='1018'></font>
   TYPE(domain) , POINTER    :: parent, grid, par, nst<a name='1019'>
   INTEGER, INTENT(OUT)      :: move_cd_x , move_cd_y<a name='1020'>
#ifdef MOVE_NESTS<a name='1021'>
<font color=#447700>! local<a name='1022'></font>
   INTEGER     :: corral_dist, kid<a name='1023'>
   INTEGER     :: dw, de, ds, dn, pgr<a name='1024'>
   INTEGER     :: would_move_x, would_move_y<a name='1025'>
   INTEGER     :: cids, cide, cjds, cjde, ckds, ckde, &amp;<a name='1026'>
                  cims, cime, cjms, cjme, ckms, ckme, &amp;<a name='1027'>
                  cips, cipe, cjps, cjpe, ckps, ckpe, &amp;<a name='1028'>
                  nids, nide, njds, njde, nkds, nkde, &amp;<a name='1029'>
                  nims, nime, njms, njme, nkms, nkme, &amp;<a name='1030'>
                  nips, nipe, njps, njpe, nkps, nkpe<a name='1031'>
   REAL        :: xtime, time_to_move<a name='1032'>
<font color=#447700>! interface<a name='1033'></font>
   INTERFACE<a name='1034'>
     LOGICAL FUNCTION time_for_move2 ( parent , nest , dx , dy )<a name='1035'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_404">, ONLY : domain<a name='1036'>
        TYPE(domain) , POINTER    :: parent , nest<a name='1037'>
        INTEGER, INTENT(OUT)      :: dx , dy<a name='1038'>
     END FUNCTION time_for_move2<a name='1039'>
   END INTERFACE<a name='1040'>
<font color=#447700>! executable<a name='1041'></font>
<font color=#447700>! <a name='1042'></font>
<font color=#447700>! Simplifying assumption: domains in moving nest simulations have only <a name='1043'></font>
<font color=#447700>! one parent and only one child.<a name='1044'></font>
<a name='1045'>
   IF   ( grid%num_nests .GT. 1 ) THEN<a name='1046'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1372"> ( 'domains in moving nest simulations can have only 1 nest' )<a name='1047'>
   ENDIF<a name='1048'>
   kid = 1<a name='1049'>
<a name='1050'>
#if ( EM_CORE == 1 )<a name='1051'>
<font color=#447700>!  Check if it is time to move the nest<a name='1052'></font>
      xtime = grid%xtime<a name='1053'>
      CALL nl_get_time_to_move ( grid%id , time_to_move )<a name='1054'>
      if ( xtime .lt. time_to_move ) then<a name='1055'>
         time_for_move = .FALSE.<a name='1056'>
         move_cd_x = 0<a name='1057'>
         move_cd_y = 0<a name='1058'>
<font color=#447700>!        write(0,*) 'it is not the time to move ', xtime, time_to_move<a name='1059'></font>
         return<a name='1060'>
      endif<a name='1061'>
#endif<a name='1062'>
<font color=#447700>! <a name='1063'></font>
<font color=#447700>! find out if this is the innermost nest (will not have kids)<a name='1064'></font>
   IF   ( grid%num_nests .EQ. 0 ) THEN<a name='1065'>
     <font color=#447700>! code that executes on innermost nest<a name='1066'></font>
     time_for_move = time_for_move2 ( parent , grid , move_cd_x, move_cd_y )<a name='1067'>
<a name='1068'>
     <font color=#447700>! Make sure the parent can move before allowing the nest to approach<a name='1069'></font>
     <font color=#447700>! its boundary<a name='1070'></font>
     par =&gt; grid%parents(1)%ptr<a name='1071'>
     nst =&gt; grid<a name='1072'>
<a name='1073'>
     would_move_x = move_cd_x <a name='1074'>
     would_move_y = move_cd_y<a name='1075'>
<a name='1076'>
     <font color=#447700>! top of until loop<a name='1077'></font>
100  CONTINUE<a name='1078'>
       CALL nl_get_corral_dist ( nst%id , corral_dist )<a name='1079'>
       CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_108"> (  nst ,                               &amp;<a name='1080'>
                                 nids, nide, njds, njde, nkds, nkde, &amp;<a name='1081'>
                                 nims, nime, njms, njme, nkms, nkme, &amp;<a name='1082'>
                                 nips, nipe, njps, njpe, nkps, nkpe  )<a name='1083'>
       CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_109"> (  par ,                               &amp;<a name='1084'>
                                 cids, cide, cjds, cjde, ckds, ckde, &amp;<a name='1085'>
                                 cims, cime, cjms, cjme, ckms, ckme, &amp;<a name='1086'>
                                 cips, cipe, cjps, cjpe, ckps, ckpe  )<a name='1087'>
       CALL nl_get_parent_grid_ratio ( nst%id , pgr )<a name='1088'>
       <font color=#447700>! perform measurements...<a name='1089'></font>
       <font color=#447700>!  from western boundary<a name='1090'></font>
       dw = nst%i_parent_start + would_move_x - cids<a name='1091'>
       <font color=#447700>!  from southern boundary<a name='1092'></font>
       ds = nst%j_parent_start + would_move_y - cjds<a name='1093'>
       <font color=#447700>!  from eastern boundary<a name='1094'></font>
       de = cide - ( nst%i_parent_start + (nide-nids+1)/pgr + would_move_x )<a name='1095'>
       <font color=#447700>!  from northern boundary<a name='1096'></font>
       dn = cjde - ( nst%j_parent_start + (njde-njds+1)/pgr + would_move_y )<a name='1097'>
<a name='1098'>
       <font color=#447700>! would this generate a move on the parent?<a name='1099'></font>
       would_move_x = 0<a name='1100'>
       would_move_y = 0<a name='1101'>
       if ( dw .LE. corral_dist ) would_move_x = would_move_x - 1<a name='1102'>
       if ( de .LE. corral_dist ) would_move_x = would_move_x + 1<a name='1103'>
       if ( ds .LE. corral_dist ) would_move_y = would_move_y - 1<a name='1104'>
       if ( dn .LE. corral_dist ) would_move_y = would_move_y + 1<a name='1105'>
<a name='1106'>
     IF ( par%id .EQ. 1 ) THEN<a name='1107'>
         IF ( would_move_x .NE. 0 .AND. move_cd_x .NE. 0 ) THEN<a name='1108'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1192">('MOAD can not move. Cancelling nest move in X')<a name='1109'>
           if ( grid%num_nests .eq. 0 ) grid%vc_i = grid%vc_i + move_cd_x * pgr  <font color=#447700>! cancel effect of move<a name='1110'></font>
           move_cd_x = 0<a name='1111'>
         ENDIF<a name='1112'>
         IF ( would_move_y .NE. 0 .AND. move_cd_y .NE. 0 ) THEN<a name='1113'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1193">('MOAD can not move. Cancelling nest move in Y')<a name='1114'>
           if ( grid%num_nests .eq. 0 ) grid%vc_j = grid%vc_j + move_cd_y * pgr  <font color=#447700>! cancel effect of move<a name='1115'></font>
           move_cd_y = 0<a name='1116'>
         ENDIF<a name='1117'>
     ELSE<a name='1118'>
         nst =&gt; par<a name='1119'>
         par =&gt; nst%parents(1)%ptr<a name='1120'>
         GOTO 100<a name='1121'>
     ENDIF<a name='1122'>
<a name='1123'>
<font color=#447700>! bottom of until loop<a name='1124'></font>
     time_for_move = ( move_cd_x .NE. 0 ) .OR. ( move_cd_y .NE. 0 )<a name='1125'>
<a name='1126'>
   ELSE<a name='1127'>
     <font color=#447700>! code that executes on parent to see if parent needs to move<a name='1128'></font>
     <font color=#447700>! get closest number of cells we'll allow nest edge to approach parent bdy<a name='1129'></font>
     CALL nl_get_corral_dist ( grid%nests(kid)%ptr%id , corral_dist )<a name='1130'>
     <font color=#447700>! get dims<a name='1131'></font>
     CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_110"> (  grid%nests(kid)%ptr ,               &amp;<a name='1132'>
                               nids, nide, njds, njde, nkds, nkde, &amp;<a name='1133'>
                               nims, nime, njms, njme, nkms, nkme, &amp;<a name='1134'>
                               nips, nipe, njps, njpe, nkps, nkpe  )<a name='1135'>
     CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_111"> (  grid ,                              &amp;<a name='1136'>
                               cids, cide, cjds, cjde, ckds, ckde, &amp;<a name='1137'>
                               cims, cime, cjms, cjme, ckms, ckme, &amp;<a name='1138'>
                               cips, cipe, cjps, cjpe, ckps, ckpe  )<a name='1139'>
     CALL nl_get_parent_grid_ratio ( grid%nests(kid)%ptr%id , pgr )<a name='1140'>
     <font color=#447700>! perform measurements...<a name='1141'></font>
     <font color=#447700>!  from western boundary<a name='1142'></font>
     dw = grid%nests(kid)%ptr%i_parent_start - 1<a name='1143'>
     <font color=#447700>!  from southern boundary<a name='1144'></font>
     ds = grid%nests(kid)%ptr%j_parent_start - 1<a name='1145'>
     <font color=#447700>!  from eastern boundary<a name='1146'></font>
     de = cide - ( grid%nests(kid)%ptr%i_parent_start + (nide-nids+1)/pgr )<a name='1147'>
     <font color=#447700>!  from northern boundary<a name='1148'></font>
     dn = cjde - ( grid%nests(kid)%ptr%j_parent_start + (njde-njds+1)/pgr )<a name='1149'>
<a name='1150'>
     <font color=#447700>! move this domain (the parent containing the moving nest)<a name='1151'></font>
     <font color=#447700>! in a direction that reestablishes the distance from <a name='1152'></font>
     <font color=#447700>! the boundary.<a name='1153'></font>
     move_cd_x = 0<a name='1154'>
     move_cd_y = 0<a name='1155'>
     if ( dw .LE. corral_dist ) move_cd_x = move_cd_x - 1<a name='1156'>
     if ( de .LE. corral_dist ) move_cd_x = move_cd_x + 1<a name='1157'>
     if ( ds .LE. corral_dist ) move_cd_y = move_cd_y - 1<a name='1158'>
     if ( dn .LE. corral_dist ) move_cd_y = move_cd_y + 1<a name='1159'>
<a name='1160'>
     time_for_move = ( move_cd_x .NE. 0 ) .OR. ( move_cd_y .NE. 0 )<a name='1161'>
<a name='1162'>
     IF ( time_for_move ) THEN<a name='1163'>
       IF ( grid%id .EQ. 1 ) THEN<a name='1164'>
<a name='1165'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1194">( 'DANGER: Nest has moved too close to boundary of outermost domain.' )<a name='1166'>
         time_for_move = .FALSE.<a name='1167'>
<a name='1168'>
       ELSE<a name='1169'>
         <font color=#447700>! need to adjust the intermediate domain of the nest in relation to this<a name='1170'></font>
         <font color=#447700>! domain since we're moving<a name='1171'></font>
<a name='1172'>
         CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MOVE_NEST'>wrf_dm_move_nest</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MOVE_NEST_2"> ( grid , grid%nests(kid)%ptr%intermediate_grid , -move_cd_x*pgr, -move_cd_y*pgr )<a name='1173'>
         CALL <A href='../../html_code/frame/module_domain.F.html#ADJUST_DOMAIN_DIMS_FOR_MOVE'>adjust_domain_dims_for_move</A><A href='../../html_code/share/mediation_nest_move.F.html#TIME_FOR_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_DOMAIN_DIMS_FOR_MOVE_2">( grid%nests(kid)%ptr%intermediate_grid , -move_cd_x*pgr, -move_cd_y*pgr )<a name='1174'>
         grid%nests(kid)%ptr%i_parent_start = grid%nests(kid)%ptr%i_parent_start - move_cd_x*pgr<a name='1175'>
         grid%nests(kid)%ptr%j_parent_start = grid%nests(kid)%ptr%j_parent_start - move_cd_y*pgr<a name='1176'>
<a name='1177'>
         CALL nl_set_i_parent_start( grid%nests(kid)%ptr%id, grid%nests(kid)%ptr%i_parent_start )<a name='1178'>
         CALL nl_set_j_parent_start( grid%nests(kid)%ptr%id, grid%nests(kid)%ptr%j_parent_start )<a name='1179'>
<a name='1180'>
       ENDIF<a name='1181'>
     ENDIF <a name='1182'>
<a name='1183'>
   ENDIF<a name='1184'>
<a name='1185'>
   RETURN<a name='1186'>
#else<a name='1187'>
   time_for_move = .FALSE.<a name='1188'>
#endif<a name='1189'>
END FUNCTION time_for_move<a name='1190'>
<a name='1191'>
<font color=#447700>! Put any tests for non-moving options or conditions in here<a name='1192'></font>
<A NAME='SHOULD_NOT_MOVE'><A href='../../html_code/share/mediation_nest_move.F.html#SHOULD_NOT_MOVE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1193'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>should_not_move</font> ( id ),<A href='../../call_from/SHOULD_NOT_MOVE.html' TARGET='index'>7</A><a name='1194'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/mediation_nest_move.F.html#SHOULD_NOT_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_183"><a name='1195'>
<font color=#447700>!  USE module_configure<a name='1196'></font>
  IMPLICIT NONE<a name='1197'>
  INTEGER, INTENT(IN) :: id<a name='1198'>
 <font color=#447700>! Local<a name='1199'></font>
  LOGICAL retval<a name='1200'>
  INTEGER cu_physics, ra_sw_physics, ra_lw_physics, sf_urban_physics, sf_surface_physics, obs_nudge_opt<a name='1201'>
<a name='1202'>
  retval = .FALSE.<a name='1203'>
<font color=#447700>! check for GD ensemble cumulus, which can not move<a name='1204'></font>
  CALL nl_get_cu_physics( id , cu_physics )<a name='1205'>
  IF ( cu_physics .EQ. GDSCHEME ) THEN<a name='1206'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#SHOULD_NOT_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1195">('Grell cumulus can not be specified with moving nests. Movement disabled.')<a name='1207'>
    retval = .TRUE.<a name='1208'>
  ENDIF<a name='1209'>
<font color=#447700>! check for CAM radiation scheme , which can not move<a name='1210'></font>
  CALL nl_get_ra_sw_physics( id , ra_sw_physics )<a name='1211'>
  IF ( ra_sw_physics .EQ. CAMSWSCHEME ) THEN<a name='1212'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#SHOULD_NOT_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1196">('CAM SW radiation can not be specified with moving nests. Movement disabled.')<a name='1213'>
    retval = .TRUE.<a name='1214'>
  ENDIF<a name='1215'>
  CALL nl_get_ra_lw_physics( id , ra_lw_physics )<a name='1216'>
  IF ( ra_lw_physics .EQ. CAMLWSCHEME ) THEN<a name='1217'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#SHOULD_NOT_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1197">('CAM LW radiation can not be specified with moving nests. Movement disabled.')<a name='1218'>
    retval = .TRUE.<a name='1219'>
  ENDIF<a name='1220'>
<font color=#447700>! check for urban canopy Noah LSM, which can not move<a name='1221'></font>
  CALL nl_get_sf_urban_physics( id , sf_urban_physics )<a name='1222'>
  IF ( sf_urban_physics .EQ. 1 .OR. sf_urban_physics .EQ. 2 ) THEN<a name='1223'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#SHOULD_NOT_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1198">('UCMs Noah LSM can not be specified with moving nests. Movement disabled.')<a name='1224'>
    retval = .TRUE.<a name='1225'>
  ENDIF<a name='1226'>
<font color=#447700>! check for PX lsm scheme, which can not move<a name='1227'></font>
  CALL nl_get_sf_surface_physics( id , sf_surface_physics )<a name='1228'>
  IF ( sf_surface_physics .EQ. PXLSMSCHEME ) THEN<a name='1229'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#SHOULD_NOT_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1199">('PX LSM can not be specified with moving nests. Movement disabled.')<a name='1230'>
    retval = .TRUE.<a name='1231'>
  ENDIF<a name='1232'>
#if ( EM_CORE == 1 )<a name='1233'>
<font color=#447700>! check for observation nudging, which can not move<a name='1234'></font>
  CALL nl_get_obs_nudge_opt( id , obs_nudge_opt )<a name='1235'>
  IF ( obs_nudge_opt .EQ. 1 ) THEN<a name='1236'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#SHOULD_NOT_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1200">('Observation nudging can not be specified with moving nests. Movement disabled.')<a name='1237'>
    retval = .TRUE.<a name='1238'>
  ENDIF<a name='1239'>
#endif<a name='1240'>
  should_not_move = retval<a name='1241'>
END FUNCTION<a name='1242'>
<a name='1243'>
#if ( HWRF == 1 )<a name='1244'>
<A NAME='DIRECTION_OF_MOVE2'><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1245'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>direction_of_move2</font> ( parent , grid , move_cd_x, move_cd_y ),<A href='../../call_from/DIRECTION_OF_MOVE2.html' TARGET='index'>22</A><a name='1246'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_405"><a name='1247'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_253"><a name='1248'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_192"><a name='1249'>
   IMPLICIT NONE<a name='1250'>
<font color=#447700>! arguments<a name='1251'></font>
   TYPE(domain) , POINTER    :: parent, grid, kid<a name='1252'>
   LOGICAL, EXTERNAL         :: wrf_dm_on_monitor<a name='1253'>
   INTEGER, INTENT(OUT)      :: move_cd_x , move_cd_y<a name='1254'>
   CHARACTER*256 mess<a name='1255'>
<font color=#447700>! local<a name='1256'></font>
   INTEGER     :: corral_dist, ikid<a name='1257'>
   INTEGER     :: dw, de, ds, dn, idum, jdum<a name='1258'>
   INTEGER     :: cids, cide, cjds, cjde, ckds, ckde, &amp;<a name='1259'>
                  cims, cime, cjms, cjme, ckms, ckme, &amp;<a name='1260'>
                  cips, cipe, cjps, cjpe, ckps, ckpe, &amp;<a name='1261'>
                  nids, nide, njds, njde, nkds, nkde, &amp;<a name='1262'>
                  nims, nime, njms, njme, nkms, nkme, &amp;<a name='1263'>
                  nips, nipe, njps, njpe, nkps, nkpe<a name='1264'>
   real :: dx,dy,kid_ic,kid_jc,my_ic,my_jc,pgr,pgrn,hr,two_dt,when,before,after<a name='1265'>
   real, parameter :: pmult=1.35<a name='1266'>
   integer :: inew,jnew,ierr,comzilla,itmp_pos,itmp_neg<a name='1267'>
   integer :: corral_x, corral_y, min_corral_x, min_corral_y<a name='1268'>
   logical :: abort,mvnest_l<a name='1269'>
<a name='1270'>
<font color=#447700>! PURPOSE: DECIDE THE DIRECTION OF MOVE<a name='1271'></font>
<font color=#447700>!    Three modes:<a name='1272'></font>
<font color=#447700>!        vortex_tracker=3 -- use results of STATS_FOR_MOVE to follow<a name='1273'></font>
<font color=#447700>!          the vortex center.  If the vortex is more than 3 X<a name='1274'></font>
<font color=#447700>!          gridpoints or 6 Y gridpoints from the center, then<a name='1275'></font>
<font color=#447700>!          move to follow it.  This is the HWRF-X algorithm.<a name='1276'></font>
<font color=#447700>!        vortex_tracker=2 -- follow this domain's nest.  Only works<a name='1277'></font>
<font color=#447700>!          if this domain has a nest, otherwise this domain is<a name='1278'></font>
<font color=#447700>!          stationary.  If the nest domain is more than 3 X<a name='1279'></font>
<font color=#447700>!          gridpoints or 6 Y gridpoints from the center, then move<a name='1280'></font>
<font color=#447700>!          to follow it. (Added by Sam Trahan, April 1, 2011)<a name='1281'></font>
<font color=#447700>!        vortex_tracker=4 -- more advanced tracker that is less likely<a name='1282'></font>
<font color=#447700>!          to jump to other low pressure systems, and less confused<a name='1283'></font>
<font color=#447700>!          by MSLP noise.  (Added by Sam Trahan, September, 2011.)<a name='1284'></font>
<font color=#447700>! RETURN VALUE: TRUE if domain should move, FALSE otherwise.<a name='1285'></font>
<font color=#447700>! OUTPUTS:<a name='1286'></font>
<font color=#447700>!        move_cd_x = number of parent gridpoints to move in X<a name='1287'></font>
<font color=#447700>!        move_cd_y = number of parent gridpoints to move in Y<a name='1288'></font>
<font color=#447700>!        grid%moved = TRUE if domain should move, FALSE otherwise.<a name='1289'></font>
<font color=#447700>! AUTHOR: XUEJIN ZHANG, October 12, 2009<a name='1290'></font>
<font color=#447700>! MODIFIED: XUEJIN ZHANG, February 28, 2010<a name='1291'></font>
<font color=#447700>! MODIFIED: SAM TRAHAN, April 1, 2011 to add vortex_tracker, and the<a name='1292'></font>
<font color=#447700>!         nest-following vortex tracker (option 2)<a name='1293'></font>
<a name='1294'>
   if(grid%id==1) then<a name='1295'>
      min_corral_x=7<a name='1296'>
      min_corral_y=12<a name='1297'>
   else<a name='1298'>
      min_corral_x=5<a name='1299'>
      min_corral_y=5<a name='1300'>
   endif<a name='1301'>
<a name='1302'>
   abort=.false. <font color=#447700>! will be set to .true. if any safety checks fail<a name='1303'></font>
   <font color=#447700>! INITIALIZE NEST MOTION TO DISABLED<a name='1304'></font>
   move_cd_x=0<a name='1305'>
   move_cd_y=0<a name='1306'>
   direction_of_move2 = .false.<a name='1307'>
   grid%moved = .false.<a name='1308'>
<a name='1309'>
   <font color=#447700>! Simplifying assumption: domains in moving nest simulations have<a name='1310'></font>
   <font color=#447700>! only one parent and only one child.<a name='1311'></font>
   if(grid%num_nests .gt. 1) then<a name='1312'>
      write(mess,'("d",I0,": not moving because it has more than one nest")') grid%id<a name='1313'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1201">(trim(mess))<a name='1314'>
      abort=.true.<a name='1315'>
   endif<a name='1316'>
<a name='1317'>
   <font color=#447700>! Switch off nest motion if we're at the analysis time or 6hr forecast<a name='1318'></font>
   if(grid%nomove_freq_hr&gt;0) then<a name='1319'>
      hr=(grid%ntsd*grid%dt)/3600.0<a name='1320'>
      when=anint(hr/grid%nomove_freq_hr)*grid%nomove_freq_hr<a name='1321'>
<a name='1322'>
      before=when-3.0/60.0-grid%dt*2.0/3600.0<a name='1323'>
      after=when+grid%dt*2.0/3600.0<a name='1324'>
<a name='1325'>
      if(hr&gt;before.and.hr&lt;after) then<a name='1326'>
         abort=.true.<a name='1327'>
         write(mess,'("d",I0,": cannot move: forecast hour too close to a ",F0.3,"-hourly time")') grid%id,grid%nomove_freq_hr<a name='1328'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1202">(trim(mess))<a name='1329'>
      endif<a name='1330'>
   endif<a name='1331'>
<a name='1332'>
   <font color=#447700>!  SWITCH OFF NEST MOTION IF TOO CLOSE TO ANY OF THE BOUNDARIES<a name='1333'></font>
<a name='1334'>
   corral_x = max(min_corral_x,grid%corral_x)<a name='1335'>
   corral_y = max(min_corral_y,grid%corral_y)<a name='1336'>
<a name='1337'>
   corral_dist=(grid%ed31+grid%parent_grid_ratio-1)/grid%parent_grid_ratio<a name='1338'>
   IF(grid%i_parent_start .le. corral_x) then<a name='1339'>
      abort=.true.<a name='1340'>
      write(mess,'("d",I0,": cannot move: too close to parent d",I0," -X boundary")') grid%id,parent%id<a name='1341'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1203">(trim(mess))<a name='1342'>
   ELSEIF((grid%i_parent_start+corral_dist) .ge. parent%ed31 - corral_x)THEN  <a name='1343'>
      abort=.true.<a name='1344'>
      write(mess,'("d",I0,": cannot move: too close to parent d",I0," +X boundary")') grid%id,parent%id<a name='1345'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1204">(trim(mess))<a name='1346'>
  ENDIF<a name='1347'>
<a name='1348'>
   corral_dist=(grid%ed32+grid%parent_grid_ratio-1)/grid%parent_grid_ratio<a name='1349'>
   IF(grid%j_parent_start .le. corral_y) THEN<a name='1350'>
      abort=.true.<a name='1351'>
      write(mess,'("d",I0,": cannot move: too close to parent d",I0," -Y boundary")') grid%id,parent%id<a name='1352'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1205">(trim(mess))<a name='1353'>
   ELSEIF((grid%j_parent_start+corral_dist) .ge. parent%ed32 - corral_y)THEN<a name='1354'>
      abort=.true.<a name='1355'>
      write(mess,'("d",I0,": cannot move: too close to parent d",I0," +Y boundary")') grid%id,parent%id<a name='1356'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1206">(trim(mess))<a name='1357'>
   ENDIF<a name='1358'>
   <font color=#447700>!<a name='1359'></font>
   <font color=#447700>!  DETERMINE AUTOMATICALLY THE DIRECTION OF GRID MOTION<a name='1360'></font>
   <font color=#447700>!<a name='1361'></font>
<a name='1362'>
   IF ( .NOT. grid%active_this_task ) grid%mvnest = .FALSE.   <font color=#447700>! prevent inactive grids from turning on movement<a name='1363'></font>
   IF ( (parent%active_this_task .OR. grid%active_this_task) ) THEN<a name='1364'>
     IF ( parent%active_this_task ) THEN<a name='1365'>
       comzilla = mpi_comm_to_kid( which_kid( grid%id ) , parent%id )<a name='1366'>
     ELSE<a name='1367'>
       comzilla = mpi_comm_to_mom( grid%id )<a name='1368'>
     ENDIF<a name='1369'>
     CALL MPI_Allreduce( grid%mvnest , mvnest_l, 1, MPI_LOGICAL, MPI_LOR, comzilla, ierr )<a name='1370'>
     grid%mvnest = mvnest_l<a name='1371'>
   ENDIF<a name='1372'>
<a name='1373'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_33">(grid%id)<a name='1374'>
<a name='1375'>
   can_move: if(grid%num_moves.eq.-99 .and. grid%mvnest .and. .not. abort) then<a name='1376'>
<a name='1377'>
      if(wrf_dm_on_monitor() .and. .not. abort) then<a name='1378'>
         WRITE(mess,*)'vortex tracking: id,mvnest,num_moves,num_nests: ', &amp;<a name='1379'>
              grid%id,grid%mvnest,grid%num_moves,grid%num_nests<a name='1380'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_993">(1,mess)<a name='1381'>
         <a name='1382'>
         WRITE(mess,*)'vortex tracking: xloc_1,xloc_2,yloc_y,yloc_2,vortex_tracker: ', &amp;<a name='1383'>
              grid%XLOC_1,grid%XLOC_2,grid%YLOC_1,grid%YLOC_2,grid%vortex_tracker<a name='1384'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_994">(1,mess)<a name='1385'>
      endif<a name='1386'>
<a name='1387'>
      nest_following: IF(grid%vortex_tracker==2)THEN<a name='1388'>
         <font color=#447700>! Follow child<a name='1389'></font>
         pgr=grid%parent_grid_ratio+0.01<a name='1390'>
         pgrn=grid%parent_grid_ratio-0.01<a name='1391'>
         <a name='1392'>
         kid=&gt;grid%nests(1)%ptr <font color=#447700>! find my kid<a name='1393'></font>
         <a name='1394'>
         <font color=#447700>! find my center location<a name='1395'></font>
         my_ic = grid%ed31/2.0<a name='1396'>
         my_jc = grid%ed32/2.0<a name='1397'>
         <a name='1398'>
         <font color=#447700>! find my kid's center location in my grid<a name='1399'></font>
         kid_ic = kid%i_parent_start + kid%ed31/2.0/kid%parent_grid_ratio - 1<a name='1400'>
         kid_jc = kid%j_parent_start + kid%ed32/2.0/kid%parent_grid_ratio - 1<a name='1401'>
         <a name='1402'>
         <font color=#447700>! How far is the kid's center from my center?<a name='1403'></font>
         dx=kid_ic-my_ic<a name='1404'>
         dy=kid_jc-my_jc<a name='1405'>
<a name='1406'>
         if(wrf_dm_on_monitor()) then<a name='1407'>
            write(mess,'("d",I0," following nest d",I0,": parent ",F0.1,"x",F0.1," nest ",F0.1,"x",F0.1," move ",F0.1,"x",F0.1)') &amp;<a name='1408'>
                 grid%id,kid%id,my_ic,my_jc,kid_ic,kid_jc,dx,dy<a name='1409'>
            call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_995">(1,trim(mess))<a name='1410'>
         endif<a name='1411'>
<a name='1412'>
         <font color=#447700>! Now decide where to move based on relative center locations.<a name='1413'></font>
         if(dx&lt;-pgr) then<a name='1414'>
            move_cd_x=-1<a name='1415'>
         elseif(dx&gt;pgr) then<a name='1416'>
            move_cd_x=1<a name='1417'>
         endif<a name='1418'>
<a name='1419'>
         if(dy&gt;2.*pgr) then<a name='1420'>
            move_cd_y=2<a name='1421'>
         elseif(dy&lt;-2.*pgr) then<a name='1422'>
            move_cd_y=-2<a name='1423'>
         endif<a name='1424'>
<a name='1425'>
         <font color=#447700>! REDUCE EXTRANEOUS MOTION<a name='1426'></font>
<a name='1427'>
         <font color=#447700>! If we're only moving in the X direction, or only in the Y<a name='1428'></font>
         <font color=#447700>! direction, then require that the difference in center<a name='1429'></font>
         <font color=#447700>! locations be slightly more than one parent gridpoint before<a name='1430'></font>
         <font color=#447700>! moving.<a name='1431'></font>
<a name='1432'>
         <font color=#447700>! This prevents the situation where d03 is moving diagonally,<a name='1433'></font>
         <font color=#447700>! and d02 will move once the X direction and then later on in<a name='1434'></font>
         <font color=#447700>! the Y direction.  Instead, it will perform a single move in<a name='1435'></font>
         <font color=#447700>! the X&amp;Y direction.<a name='1436'></font>
         if(move_cd_x==0 .and. move_cd_y/=0) then<a name='1437'>
            <font color=#447700>! Only moving in Y direction.<a name='1438'></font>
            if(dy&gt;-2.*pmult*pgrn .and. dy&lt;2.*pmult*pgrn) then<a name='1439'>
               <font color=#447700>! Child has not moved 2*pmult parent points yet.<a name='1440'></font>
               move_cd_y=0<a name='1441'>
            endif<a name='1442'>
         endif<a name='1443'>
         if(move_cd_x/=0 .and. move_cd_y==0) then<a name='1444'>
            <font color=#447700>! Only moving in X direction.<a name='1445'></font>
            if(dx&gt;-pmult*pgrn .and. dx&lt;pmult*pgrn) then<a name='1446'>
               <font color=#447700>! Child has not moved pmult parent points yet.<a name='1447'></font>
               move_cd_x=0<a name='1448'>
            endif<a name='1449'>
         endif<a name='1450'>
<a name='1451'>
         <font color=#447700>! Inform the user.<a name='1452'></font>
         if(wrf_dm_on_monitor()) then<a name='1453'>
            if(move_cd_x/=0 .or. move_cd_y/=0) then<a name='1454'>
               write(mess,'("d",I0," moving x",SP,I0," y",I0,SS," to follow d",I0)') &amp;<a name='1455'>
                    grid%id,move_cd_x,move_cd_y,kid%id<a name='1456'>
               call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_996">(1,trim(mess))<a name='1457'>
            endif<a name='1458'>
         endif<a name='1459'>
      endif nest_following<a name='1460'>
      revised_nest_motion: if(grid%vortex_tracker&gt;3) then<a name='1461'>
         if((grid%XLOC_1-grid%XLOC_2) .GE. 3) then<a name='1462'>
            move_cd_x=-1<a name='1463'>
         elseif((grid%XLOC_2-grid%XLOC_1) .GE. 3) then<a name='1464'>
            move_cd_x=1<a name='1465'>
         else<a name='1466'>
            move_cd_x=0<a name='1467'>
         endif<a name='1468'>
         if((grid%YLOC_2-grid%YLOC_1) .GE. 6) then<a name='1469'>
            move_cd_y=2<a name='1470'>
         elseif((grid%YLOC_1-grid%YLOC_2) .GE. 6) then<a name='1471'>
            move_cd_y=-2<a name='1472'>
         else<a name='1473'>
            move_cd_y=0<a name='1474'>
         endif<a name='1475'>
         if(wrf_dm_on_monitor()) then<a name='1476'>
            if(move_cd_x/=0 .or. move_cd_y/=0) then<a name='1477'>
               write(mess,'("d",I0," moving x",SP,I0," y",I0,SS," to follow vortex")') &amp;<a name='1478'>
                    grid%id,move_cd_x,move_cd_y<a name='1479'>
               call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_997">(1,trim(mess))<a name='1480'>
            endif<a name='1481'>
         endif<a name='1482'>
      endif revised_nest_motion<a name='1483'>
      vortex_following: IF(grid%vortex_tracker==3 .or. grid%vortex_tracker==1)THEN<a name='1484'>
         IF((grid%XLOC_1-grid%XLOC_2) .GE. 3)THEN <a name='1485'>
            move_cd_x  = -1<a name='1486'>
            IF((grid%YLOC_2-grid%YLOC_1) .GE. 3)THEN<a name='1487'>
               move_cd_y  = +1 <font color=#447700>! will be changed to 2 automatically by caller<a name='1488'></font>
            ENDIF<a name='1489'>
         ELSE IF((grid%XLOC_2-grid%XLOC_1) .GE. 3)THEN        <a name='1490'>
            move_cd_x  = +1 <a name='1491'>
            IF((grid%YLOC_2-grid%YLOC_1) .GE. 3)THEN<a name='1492'>
               move_cd_y  = -1 <font color=#447700>! will be changed to -2 automatically by caller<a name='1493'></font>
            ENDIF<a name='1494'>
         ELSE IF ((grid%YLOC_2-grid%YLOC_1) .GE. 3 .and. grid%vortex_tracker==1) THEN<a name='1495'>
            <font color=#447700>! Original HWRF tracker had a less sensitive north motion test.<a name='1496'></font>
            <font color=#447700>! Only one parent gridpoint of north distance is required.  The<a name='1497'></font>
            <font color=#447700>! nest will actually move two parent gridpoints though.<a name='1498'></font>
            move_cd_y  = 2<a name='1499'>
         ELSE IF ((grid%YLOC_2-grid%YLOC_1) .GE. 6)THEN <a name='1500'>
            move_cd_y  = 2 <a name='1501'>
         ELSE IF ((grid%YLOC_1-grid%YLOC_2) .GE. 6)THEN    <font color=#447700>! wait for the move<a name='1502'></font>
            move_cd_y  = -2 <a name='1503'>
         ENDIF<a name='1504'>
<a name='1505'>
         if(wrf_dm_on_monitor()) then<a name='1506'>
            if(move_cd_x/=0 .or. move_cd_y/=0) then<a name='1507'>
               write(mess,'("d",I0," moving x",SP,I0," y",I0,SS," to follow vortex")') &amp;<a name='1508'>
                    grid%id,move_cd_x,move_cd_y<a name='1509'>
               call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_998">(1,trim(mess))<a name='1510'>
            endif<a name='1511'>
         endif<a name='1512'>
      ENDIF vortex_following<a name='1513'>
   endif can_move<a name='1514'>
<a name='1515'>
   <font color=#447700>! Abort motion if any child domain would end up within this<a name='1516'></font>
   <font color=#447700>! domain's corral distance or outside of this domain.<a name='1517'></font>
   nest_safety: IF ( grid%num_nests .GT. 0 .and. ( move_cd_x/=0 .or. move_cd_y/=0 ) ) THEN<a name='1518'>
     abort=.false.<a name='1519'>
     nest_loop: do ikid=1,grid%num_nests<a name='1520'>
        kid=&gt;grid%nests(ikid)%ptr<a name='1521'>
        inew=kid%i_parent_start-move_cd_x*kid%parent_grid_ratio<a name='1522'>
        jnew=kid%j_parent_start-move_cd_y*kid%parent_grid_ratio<a name='1523'>
        <a name='1524'>
        corral_dist=(kid%ed31+kid%parent_grid_ratio-1)/kid%parent_grid_ratio<a name='1525'>
        corral_x = max(min_corral_x,grid%corral_x)<a name='1526'>
        corral_y = max(min_corral_y,grid%corral_y)<a name='1527'>
        IF(inew &lt;= corral_x)THEN  <a name='1528'>
           abort=.true.<a name='1529'>
           write(mess,'("d",I0,": cannot move: nest d",I0," would be too close to -X bdy")') grid%id,kid%id<a name='1530'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1207">(mess)<a name='1531'>
        ELSEIF((inew+corral_dist) &gt;= grid%ed31 - corral_x) THEN<a name='1532'>
           abort=.true.<a name='1533'>
           write(mess,'("d",I0,": cannot move: nest d",I0," would be too close to +X bdy")') grid%id,kid%id<a name='1534'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1208">(mess)<a name='1535'>
        ENDIF<a name='1536'>
<a name='1537'>
        corral_dist=(kid%ed32+kid%parent_grid_ratio-1)/kid%parent_grid_ratio<a name='1538'>
        IF(jnew .le. corral_y)THEN<a name='1539'>
           abort=.true.<a name='1540'>
           write(mess,'("d",I0,": cannot move: nest d",I0," would be too close to -Y bdy")') grid%id,kid%id<a name='1541'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1209">(mess)<a name='1542'>
        ELSEIF((jnew+corral_dist) .ge. grid%ed32 - corral_y) THEN<a name='1543'>
           abort=.true.<a name='1544'>
           write(mess,'("d",I0,": cannot move: nest d",I0," would be too close to +Y bdy")') grid%id,kid%id<a name='1545'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1210">(mess)<a name='1546'>
        ENDIF<a name='1547'>
     enddo nest_loop<a name='1548'>
  ENDIF nest_safety<a name='1549'>
<a name='1550'>
  if(abort) then<a name='1551'>
     grid%mvnest=.false.<a name='1552'>
     move_cd_x=0<a name='1553'>
     move_cd_y=0<a name='1554'>
     grid%moved=.false.<a name='1555'>
     direction_of_move2=.false.<a name='1556'>
     grid%mvnest=.false.<a name='1557'>
     write(mess,'("d",I0,"; motion has been aborted.")') grid%id<a name='1558'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1211">(mess)<a name='1559'>
  endif<a name='1560'>
  <a name='1561'>
  IF ( .NOT. grid%active_this_task ) THEN<a name='1562'>
    grid%mvnest = .FALSE.   <font color=#447700>! prevent inactive grids from turning on movement<a name='1563'></font>
    grid%move_cd_x = 0<a name='1564'>
    grid%move_cd_y = 0<a name='1565'>
  ENDIF<a name='1566'>
 <a name='1567'>
  IF ( (parent%active_this_task .OR. grid%active_this_task) ) THEN<a name='1568'>
    CALL MPI_Allreduce( grid%mvnest , mvnest_l, 1, MPI_LOGICAL, MPI_LOR, comzilla, ierr )<a name='1569'>
    grid%mvnest = mvnest_l<a name='1570'>
    CALL MPI_Allreduce( move_cd_x , itmp_pos, 1, MPI_INTEGER, MPI_MAX, comzilla, ierr )<a name='1571'>
    CALL MPI_Allreduce( move_cd_x , itmp_neg, 1, MPI_INTEGER, MPI_MIN, comzilla, ierr )<a name='1572'>
    IF ( itmp_pos .NE. 0 ) THEN<a name='1573'>
      move_cd_x = itmp_pos<a name='1574'>
    ELSE <a name='1575'>
      move_cd_x = itmp_neg<a name='1576'>
    ENDIF<a name='1577'>
    CALL MPI_Allreduce( move_cd_y , itmp_pos, 1, MPI_INTEGER, MPI_MAX, comzilla, ierr )<a name='1578'>
    CALL MPI_Allreduce( move_cd_y , itmp_neg, 1, MPI_INTEGER, MPI_MIN, comzilla, ierr )<a name='1579'>
    IF ( itmp_pos .NE. 0 ) THEN<a name='1580'>
      move_cd_y = itmp_pos<a name='1581'>
    ELSE <a name='1582'>
      move_cd_y = itmp_neg<a name='1583'>
    ENDIF<a name='1584'>
  ENDIF<a name='1585'>
<a name='1586'>
  if(move_cd_x/=0 .or. move_cd_y/=0) then<a name='1587'>
     direction_of_move2 = .true.<a name='1588'>
     grid%moved = .true.<a name='1589'>
     if(grid%vortex_tracker==2) then<a name='1590'>
        grid%ntime0 = grid%ntsd<a name='1591'>
     else<a name='1592'>
        <font color=#447700>! other vortex trackers set NTIME0 in STATS_FOR_MOVE<a name='1593'></font>
     endif<a name='1594'>
  endif<a name='1595'>
<a name='1596'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_33">(grid%id)<a name='1597'>
  <a name='1598'>
  RETURN<a name='1599'>
<a name='1600'>
END FUNCTION direction_of_move2<a name='1601'>
<a name='1602'>
<a name='1603'>
<A NAME='DIRECTION_OF_MOVE'><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1604'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>direction_of_move</font> ( parent , grid , move_cd_x, move_cd_y ),<A href='../../call_from/DIRECTION_OF_MOVE.html' TARGET='index'>20</A><a name='1605'>
<a name='1606'>
<font color=#447700>! AUTHOR: XUEJIN ZHANG<a name='1607'></font>
<font color=#447700>! ORIGINAL DATE: 10/12/2009<a name='1608'></font>
<font color=#447700>! Modified: 2/28/2010<a name='1609'></font>
<font color=#447700>! PURPOSE: DEICDE THE DIRECTION OF MOVE<a name='1610'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_406"><a name='1611'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_254"><a name='1612'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_193"><a name='1613'>
   IMPLICIT NONE<a name='1614'>
<font color=#447700>! arguments<a name='1615'></font>
   TYPE(domain) , POINTER    :: parent, grid, par, nst<a name='1616'>
   INTEGER, INTENT(OUT)      :: move_cd_x , move_cd_y<a name='1617'>
<font color=#447700>! local<a name='1618'></font>
   INTEGER     :: corral_dist, kid<a name='1619'>
   INTEGER     :: dw, de, ds, dn, pgr<a name='1620'>
   INTEGER     :: would_move_x, would_move_y<a name='1621'>
   INTEGER     :: cids, cide, cjds, cjde, ckds, ckde, &amp;<a name='1622'>
                  cims, cime, cjms, cjme, ckms, ckme, &amp;<a name='1623'>
                  cips, cipe, cjps, cjpe, ckps, ckpe, &amp;<a name='1624'>
                  nids, nide, njds, njde, nkds, nkde, &amp;<a name='1625'>
                  nims, nime, njms, njme, nkms, nkme, &amp;<a name='1626'>
                  nips, nipe, njps, njpe, nkps, nkpe<a name='1627'>
   INTEGER                          :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1628'>
   INTEGER                          :: IMS,IME,JMS,JME,KMS,KME<a name='1629'>
   INTEGER                          :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1630'>
   INTEGER                          :: IpS,IpE,JpS,JpE,KpS,KpE<a name='1631'>
   INTEGER comzilla<a name='1632'>
   character*255 :: message<a name='1633'>
<font color=#447700>! interface<a name='1634'></font>
   INTERFACE<a name='1635'>
     LOGICAL FUNCTION direction_of_move2 ( parent , nest , dx , dy )<a name='1636'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_407"><a name='1637'>
        USE module_utility<a name='1638'>
        TYPE(domain) , POINTER    :: parent , nest<a name='1639'>
        INTEGER, INTENT(OUT)      :: dx , dy<a name='1640'>
     END FUNCTION direction_of_move2<a name='1641'>
     SUBROUTINE G2T2H_new( IIH,JJH,                            &amp; <font color=#447700>! output grid index and weights <a name='1642'></font>
                           HBWGT1,HBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='1643'></font>
                           HBWGT3,HBWGT4,                      &amp;<a name='1644'>
                           I_PARENT_START,J_PARENT_START,      &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1645'></font>
                           RATIO,                              &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1646'></font>
                           IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='1647'></font>
                           IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='1648'>
                           ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1649'>
      IMPLICIT NONE<a name='1650'>
      INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1651'>
      INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='1652'>
      INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1653'>
      INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='1654'>
      INTEGER,    INTENT(IN   )                            :: RATIO<a name='1655'>
      REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='1656'>
      INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIH,JJH<a name='1657'>
     END SUBROUTINE G2T2H_new<a name='1658'>
     SUBROUTINE G2T2V_new( IIV,JJV,                            &amp; <font color=#447700>! output grid index and weights <a name='1659'></font>
                           VBWGT1,VBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='1660'></font>
                           VBWGT3,VBWGT4,                      &amp;<a name='1661'>
                           I_PARENT_START,J_PARENT_START,      &amp; <font color=#447700>! nest start I and J in parent domain  <a name='1662'></font>
                           RATIO,                              &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1663'></font>
                           IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='1664'></font>
                           IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='1665'>
                           ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1666'>
      IMPLICIT NONE<a name='1667'>
      INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1668'>
      INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='1669'>
      INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1670'>
      INTEGER,    INTENT(IN   )                            :: I_PARENT_START,J_PARENT_START<a name='1671'>
      INTEGER,    INTENT(IN   )                            :: RATIO<a name='1672'>
      REAL,    DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: VBWGT1,VBWGT2,VBWGT3,VBWGT4<a name='1673'>
      INTEGER, DIMENSION(IMS:IME,JMS:JME),    INTENT(OUT)  :: IIV,JJV<a name='1674'>
     END SUBROUTINE G2T2V_new<a name='1675'>
     subroutine init_hnear(iih,jjh,hbwgt1,hbwgt2,hbwgt3,hbwgt4, &amp;<a name='1676'>
          hnear_i,hnear_j,                     &amp;<a name='1677'>
          IDS,IDE,JDS,JDE,KDS,KDE,             &amp;<a name='1678'>
          IMS,IME,JMS,JME,KMS,KME,             &amp;<a name='1679'>
          ITS,ITE,JTS,JTE,KTS,KTE)<a name='1680'>
       implicit none<a name='1681'>
       integer, intent(in) :: ids,ide,jds,jde,kds,kde, &amp;<a name='1682'>
            ims,ime,jms,jme,kms,kme, &amp;<a name='1683'>
            its,ite,jts,jte,kts,kte, &amp;<a name='1684'>
            iih(ims:ime,jms:jme), jjh(ims:ime,jms:jme)<a name='1685'>
       integer, intent(out), dimension(ims:ime,jms:jme) :: hnear_i,hnear_j<a name='1686'>
       real, dimension(ims:ime,jms:jme), intent(in) :: hbwgt1, hbwgt2, hbwgt3, hbwgt4<a name='1687'>
     end subroutine init_hnear<a name='1688'>
   END INTERFACE<a name='1689'>
<font color=#447700>! executable<a name='1690'></font>
<font color=#447700>! <a name='1691'></font>
<font color=#447700>! Simplifying assumption: moving domains in moving nest simulations have only <a name='1692'></font>
<font color=#447700>! one parent and only one child.<a name='1693'></font>
<a name='1694'>
   IF   ( grid%num_nests .GT. 1 ) THEN<a name='1695'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1373"> ( 'domains in moving nest simulations can have only 1 nest' )<a name='1696'>
   ENDIF<a name='1697'>
   kid = 1<a name='1698'>
   write(message,*) 'grid%num_nests=',grid%num_nests<a name='1699'>
   call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_999">(5,message)<a name='1700'>
<a name='1701'>
   direction_of_move = direction_of_move2 ( parent , grid , move_cd_x, move_cd_y )<a name='1702'>
<a name='1703'>
<font color=#447700>! any nest grid needs to know if grid is moving<a name='1704'></font>
   IF ( grid%id .GT. 1 .AND. grid%num_nests .GT. 0 ) THEN<a name='1705'>
     IF ( (.NOT. (grid%active_this_task .AND. grid%nests(kid)%ptr%active_this_task) ) .AND. &amp;<a name='1706'>
                 (grid%active_this_task .OR.  grid%nests(kid)%ptr%active_this_task) ) THEN<a name='1707'>
       IF ( grid%active_this_task ) THEN<a name='1708'>
         comzilla = mpi_comm_to_kid( kid , grid%id )<a name='1709'>
       ELSE<a name='1710'>
         comzilla = mpi_comm_to_mom( grid%nests(kid)%ptr%id )<a name='1711'>
       ENDIF<a name='1712'>
       CALL BYTE_BCAST( move_cd_x, IWORDSIZE, comzilla )  <font color=#447700>!<a name='1713'></font>
       CALL BYTE_BCAST( move_cd_y, IWORDSIZE, comzilla )  <font color=#447700>!<a name='1714'></font>
     ENDIF<a name='1715'>
     direction_of_move = ( move_cd_x .NE. 0 ) .OR. ( move_cd_y .NE. 0 )<a name='1716'>
   ENDIF<a name='1717'>
<a name='1718'>
   if(grid%vortex_tracker == 1) then<a name='1719'>
      return <font color=#447700>! Old HWRF tracker has nothing more to do.<a name='1720'></font>
   endif<a name='1721'>
<a name='1722'>
<font color=#447700>!<a name='1723'></font>
<font color=#447700>! find out if this is the innermost nest (will not have kids)<a name='1724'></font>
   IF   ( grid%num_nests .EQ. 0 ) THEN<a name='1725'>
      <font color=#447700>! code that executes on innermost nest<a name='1726'></font>
<a name='1727'>
     direction_of_move = ( move_cd_x .NE. 0 ) .OR. ( move_cd_y .NE. 0 )<a name='1728'>
<a name='1729'>
   ELSE<a name='1730'>
     <font color=#447700>! move this domain (the parent containing the moving nest)<a name='1731'></font>
     <font color=#447700>! in a direction that reestablishes the distance from <a name='1732'></font>
     <font color=#447700>! the boundary.<a name='1733'></font>
     move_domain: IF ( direction_of_move ) THEN<a name='1734'>
        no_nests: IF ( grid%id .EQ. 1 ) THEN<a name='1735'>
<a name='1736'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1212">( 'DANGER: Nest has moved too close to boundary of outermost domain.' )<a name='1737'>
         move_cd_x = 0<a name='1738'>
         move_cd_y = 0<a name='1739'>
         direction_of_move = .FALSE.<a name='1740'>
<a name='1741'>
       ELSE<a name='1742'>
<a name='1743'>
          CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_112"> (  grid%nests(kid)%ptr ,               &amp;<a name='1744'>
               nids, nide, njds, njde, nkds, nkde, &amp;<a name='1745'>
               nims, nime, njms, njme, nkms, nkme, &amp;<a name='1746'>
               nips, nipe, njps, njpe, nkps, nkpe  )<a name='1747'>
          CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_113"> (  grid ,                              &amp;<a name='1748'>
               cids, cide, cjds, cjde, ckds, ckde, &amp;<a name='1749'>
               cims, cime, cjms, cjme, ckms, ckme, &amp;<a name='1750'>
               cips, cipe, cjps, cjpe, ckps, ckpe  )<a name='1751'>
          CALL nl_get_parent_grid_ratio ( grid%nests(kid)%ptr%id , pgr )<a name='1752'>
          <font color=#447700>! need to adjust the intermediate domain of the nest in relation to this<a name='1753'></font>
          <font color=#447700>! domain since we're moving<a name='1754'></font>
          IF(MOD(move_cd_y,2) .NE. 0)THEN<a name='1755'>
            move_cd_y=move_cd_y+sign(1,move_cd_y)<a name='1756'>
             WRITE(message,*)'WARNING: move_cd_y REDEFINED FOR THE NMM CORE AND RE-SET TO MASS POINT move_cd_y=',move_cd_y<a name='1757'>
             call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1000">(1,message)<a name='1758'>
          ENDIF<a name='1759'>
<a name='1760'>
         IF (grid%active_this_task .OR.  grid%nests(kid)%ptr%active_this_task ) THEN<a name='1761'>
           IF ( grid%active_this_task ) THEN<a name='1762'>
             comzilla = mpi_comm_to_kid( kid , grid%id )<a name='1763'>
           ELSE<a name='1764'>
             comzilla = mpi_comm_to_mom( grid%nests(kid)%ptr%id )<a name='1765'>
           ENDIF<a name='1766'>
<a name='1767'>
           CALL BYTE_BCAST( grid%nests(kid)%ptr%i_parent_start, IWORDSIZE, comzilla )  <font color=#447700>!<a name='1768'></font>
           CALL BYTE_BCAST( grid%nests(kid)%ptr%j_parent_start, IWORDSIZE, comzilla )  <font color=#447700>!<a name='1769'></font>
           CALL BYTE_BCAST( move_cd_x, IWORDSIZE, comzilla )  <font color=#447700>!<a name='1770'></font>
           CALL BYTE_BCAST( move_cd_y, IWORDSIZE, comzilla )  <font color=#447700>!<a name='1771'></font>
<a name='1772'>
         ENDIF<a name='1773'>
<a name='1774'>
         CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MOVE_NEST'>wrf_dm_move_nest</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MOVE_NEST_3"> ( grid , grid%nests(kid)%ptr%intermediate_grid , -move_cd_x*pgr, -move_cd_y*pgr )<a name='1775'>
         CALL <A href='../../html_code/frame/module_domain.F.html#ADJUST_DOMAIN_DIMS_FOR_MOVE'>adjust_domain_dims_for_move</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_DOMAIN_DIMS_FOR_MOVE_3">( grid%nests(kid)%ptr%intermediate_grid , -move_cd_x*pgr, -move_cd_y*pgr )<a name='1776'>
         grid%nests(kid)%ptr%i_parent_start = grid%nests(kid)%ptr%i_parent_start - move_cd_x*pgr<a name='1777'>
         write(message,*)'grid%nests(kid)%ptr%i_parent_start =',grid%nests(kid)%ptr%i_parent_start,grid%nests(kid)%ptr%id<a name='1778'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1001">(1,message)<a name='1779'>
<a name='1780'>
         grid%nests(kid)%ptr%j_parent_start = grid%nests(kid)%ptr%j_parent_start - move_cd_y*pgr<a name='1781'>
         write(message,*)'grid%nests(kid)%ptr%j_parent_start =',grid%nests(kid)%ptr%j_parent_start,grid%nests(kid)%ptr%id<a name='1782'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1002">(1,message)<a name='1783'>
<a name='1784'>
         CALL nl_set_i_parent_start( grid%nests(kid)%ptr%id, grid%nests(kid)%ptr%i_parent_start )<a name='1785'>
         CALL nl_set_j_parent_start( grid%nests(kid)%ptr%id, grid%nests(kid)%ptr%j_parent_start )<a name='1786'>
<a name='1787'>
         IF ( grid%nests(kid)%ptr%active_this_task ) THEN<a name='1788'>
          IDS = grid%nests(kid)%ptr%sd31<a name='1789'>
          IDE = grid%nests(kid)%ptr%ed31<a name='1790'>
          JDS = grid%nests(kid)%ptr%sd32<a name='1791'>
          JDE = grid%nests(kid)%ptr%ed32<a name='1792'>
          KDS = grid%nests(kid)%ptr%sd33<a name='1793'>
          KDE = grid%nests(kid)%ptr%ed33<a name='1794'>
<a name='1795'>
          IMS = grid%nests(kid)%ptr%sm31<a name='1796'>
          IME = grid%nests(kid)%ptr%em31<a name='1797'>
          JMS = grid%nests(kid)%ptr%sm32<a name='1798'>
          JME = grid%nests(kid)%ptr%em32<a name='1799'>
          KMS = grid%nests(kid)%ptr%sm33<a name='1800'>
          KME = grid%nests(kid)%ptr%em33<a name='1801'>
<a name='1802'>
          ITS  = grid%nests(kid)%ptr%sp31<a name='1803'>
          ITE  = grid%nests(kid)%ptr%ep31<a name='1804'>
          JTS  = grid%nests(kid)%ptr%sp32<a name='1805'>
          JTE  = grid%nests(kid)%ptr%ep32<a name='1806'>
          KTS  = grid%nests(kid)%ptr%sp33<a name='1807'>
          KTE  = grid%nests(kid)%ptr%ep33<a name='1808'>
<a name='1809'>
          CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2H_NEW'>G2T2H_new</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G2T2H_NEW_2">(    grid%nests(kid)%ptr%IIH,grid%nests(kid)%ptr%JJH,                            &amp; <font color=#447700>! output grid index in parent grid<a name='1810'></font>
                        grid%nests(kid)%ptr%HBWGT1,grid%nests(kid)%ptr%HBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='1811'></font>
                        grid%nests(kid)%ptr%HBWGT3,grid%nests(kid)%ptr%HBWGT4,                      &amp;<a name='1812'>
                        grid%nests(kid)%ptr%I_PARENT_START,grid%nests(kid)%ptr%J_PARENT_START,      &amp; <font color=#447700>! nest start I, J in parent domain<a name='1813'></font>
                        3,                              &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1814'></font>
                        IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='1815'></font>
                        IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='1816'>
                        ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1817'>
          CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#G2T2V_NEW'>G2T2V_new</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="G2T2V_NEW_2">(    grid%nests(kid)%ptr%IIV,grid%nests(kid)%ptr%JJV,                            &amp; <font color=#447700>! output grid index in parent grid<a name='1818'></font>
                        grid%nests(kid)%ptr%VBWGT1,grid%nests(kid)%ptr%VBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='1819'></font>
                        grid%nests(kid)%ptr%VBWGT3,grid%nests(kid)%ptr%VBWGT4,                      &amp;<a name='1820'>
                        grid%nests(kid)%ptr%I_PARENT_START,grid%nests(kid)%ptr%J_PARENT_START,      &amp; <font color=#447700>! nest start I, J in parent domain<a name='1821'></font>
                        3,                              &amp; <font color=#447700>! Ratio of parent and child grid ( always = 3 for NMM)<a name='1822'></font>
                        IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='1823'></font>
                        IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='1824'>
                        ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1825'>
          CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#INIT_HNEAR'>init_hnear</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_HNEAR_2">(    grid%nests(kid)%ptr%IIH,grid%nests(kid)%ptr%JJH,                            &amp; <font color=#447700>! output grid index in parent grid<a name='1826'></font>
                        grid%nests(kid)%ptr%HBWGT1,grid%nests(kid)%ptr%HBWGT2,                      &amp; <font color=#447700>! output weights in terms of parent grid<a name='1827'></font>
                        grid%nests(kid)%ptr%HBWGT3,grid%nests(kid)%ptr%HBWGT4,                      &amp;<a name='1828'>
                        grid%nests(kid)%ptr%hnear_i,grid%nests(kid)%ptr%hnear_j,                    &amp;<a name='1829'>
                        IDS,IDE,JDS,JDE,KDS,KDE,            &amp; <font color=#447700>! target (nest) dimensions<a name='1830'></font>
                        IMS,IME,JMS,JME,KMS,KME,            &amp;<a name='1831'>
                        ITS,ITE,JTS,JTE,KTS,KTE      )<a name='1832'>
         ENDIF<a name='1833'>
<a name='1834'>
       ENDIF no_nests<a name='1835'>
       if(grid%vortex_tracker == 6 .or. grid%vortex_tracker == 7) then<a name='1836'>
            <font color=#447700>! Update storm center gridpoint location, radius from<a name='1837'></font>
            <font color=#447700>! storm center and angle to storm center:<a name='1838'></font>
            call <A href='../../html_code/dyn_nmm/module_tracker.F.html#NMM_MED_TRACKER_POST_MOVE'>nmm_med_tracker_post_move</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NMM_MED_TRACKER_POST_MOVE_1">(grid)<a name='1839'>
       endif<a name='1840'>
<a name='1841'>
       if(grid%swath_mode==1) then<a name='1842'>
          <font color=#447700>! Will need to update area of interest after domain shift:<a name='1843'></font>
          grid%update_interest=.true.<a name='1844'>
          <a name='1845'>
          <font color=#447700>! Parent must also update area of interest after its nest<a name='1846'></font>
          <font color=#447700>! moves if the parent has interest_kids set:<a name='1847'></font>
          if(parent%interest_kids/=0) then<a name='1848'>
38           format('grid ',I2,' updating grid ',I2,' area of interest due to nest motion')<a name='1849'>
             write(message,38) grid%id,parent%id<a name='1850'>
             call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1003">(1,trim(message))<a name='1851'>
             parent%update_interest=.true.<a name='1852'>
          else<a name='1853'>
39           format('grid ',I2,' not updating grid ',I2,' area of interest because interest_kids is 0')<a name='1854'>
             write(message,39) grid%id,parent%id<a name='1855'>
             call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_nest_move.F.html#DIRECTION_OF_MOVE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_1004">(1,trim(message))<a name='1856'>
          endif<a name='1857'>
       endif<a name='1858'>
     ENDIF move_domain<a name='1859'>
<a name='1860'>
   ENDIF<a name='1861'>
<a name='1862'>
   RETURN<a name='1863'>
END FUNCTION direction_of_move<a name='1864'>
#endif<a name='1865'>
<a name='1866'>
<a name='1867'>
<A NAME='RECONCILE_NEST_POSITIONS_OVER_TASKS'><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1868'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>reconcile_nest_positions_over_tasks</font> ( grid ) <A href='../../call_to/RECONCILE_NEST_POSITIONS_OVER_TASKS.html' TARGET='index'>1</A>,<A href='../../call_from/RECONCILE_NEST_POSITIONS_OVER_TASKS.html' TARGET='index'>8</A><a name='1869'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_61">, ONLY : max_nests, max_domains<a name='1870'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_408">, ONLY : domain, find_grid_by_id<a name='1871'>
   USE module_utility<a name='1872'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_255">, ONLY : grid_config_rec_type, model_config_rec, model_to_grid_config_rec<a name='1873'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_184"><a name='1874'>
#ifdef DM_PARALLEL<a name='1875'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_194">, ONLY : wrf_dm_move_nest, nest_task_offsets,mpi_comm_to_kid,mpi_comm_to_mom, which_kid &amp;<a name='1876'>
                        ,comm_start, nest_pes_x, nest_pes_y,local_communicator<a name='1877'>
   IMPLICIT NONE<a name='1878'>
   TYPE(domain) , POINTER                     :: grid, result_grid<a name='1879'>
<font color=#447700>!local<a name='1880'></font>
   INTEGER kid<a name='1881'>
   INTEGER itask<a name='1882'>
   INTEGER max_dom, id<a name='1883'>
   INTEGER buf(max_domains,2)<a name='1884'>
<a name='1885'>
   CALL nl_get_max_dom( 1 , max_dom )<a name='1886'>
   IF ( grid%num_nests .GT. 1 ) THEN<a name='1887'>
    IF ( grid%active_this_task ) THEN<a name='1888'>
     DO kid = 1, max_nests<a name='1889'>
     <font color=#447700>! which task is active?<a name='1890'></font>
       IF ( ASSOCIATED( grid%nests(kid)%ptr ) ) THEN<a name='1891'>
          <font color=#447700>! check to see if the starting task for the nest is within the range of tasks<a name='1892'></font>
          <font color=#447700>! of the parent's local communicator; that task should be the root of the bcast on this grid's (the parent's) communicator<a name='1893'></font>
          <font color=#447700>! since it is active in both the parent and nest and should have valid parent_start information;<a name='1894'></font>
          <font color=#447700>! otoh, if it is outside then the parent and nest are not sharing processors<a name='1895'></font>
          itask = comm_start( grid%nests(kid)%ptr%id ) - comm_start( grid%id )<a name='1896'>
          buf(:,1) = model_config_rec%i_parent_start<a name='1897'>
          buf(:,2) = model_config_rec%j_parent_start<a name='1898'>
          IF ( itask .GE. 0 .AND. itask .LT. nest_pes_x(grid%id)*nest_pes_y(grid%id) ) THEN<a name='1899'>
            CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_34">(grid%id)<a name='1900'>
            CALL BYTE_BCAST_FROM_ROOT( buf, 2*max_domains*IWORDSIZE, itask, local_communicator)<a name='1901'>
            CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_34"><a name='1902'>
          ENDIF<a name='1903'>
          DO id = 1, max_dom<a name='1904'>
            CALL <A href='../../html_code/frame/module_domain.F.html#FIND_GRID_BY_ID'>find_grid_by_id</A><A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_GRID_BY_ID_7"> ( id, grid%nests(kid)%ptr, result_grid )<a name='1905'>
            IF ( ASSOCIATED(result_grid) .AND. .NOT. result_grid%active_this_task ) THEN<a name='1906'>
              model_config_rec%i_parent_start(id) = buf(id,1)<a name='1907'>
              model_config_rec%j_parent_start(id) = buf(id,2)<a name='1908'>
              result_grid%i_parent_start = model_config_rec%i_parent_start(id)<a name='1909'>
              result_grid%j_parent_start = model_config_rec%j_parent_start(id)<a name='1910'>
            ENDIF<a name='1911'>
          ENDDO<a name='1912'>
       END IF<a name='1913'>
     END DO<a name='1914'>
    ENDIF<a name='1915'>
   ENDIF<a name='1916'>
#endif<a name='1917'>
END SUBROUTINE reconcile_nest_positions_over_tasks<a name='1918'>
<a name='1919'>
</pre></body></html>