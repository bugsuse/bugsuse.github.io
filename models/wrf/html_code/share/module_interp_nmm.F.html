<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>! FCOPY, ICOPY, etc.: C pre-processor macros for C-&gt;N and N-&gt;C<a name='2'></font>
<font color=#447700>! horizontal interpolation.  These exist solely to reduce code<a name='3'></font>
<font color=#447700>! complexity.<a name='4'></font>
<a name='5'>
<font color=#447700>! Copy from C array to N array:<a name='6'></font>
#define FCOPY(N,C,i,j,k) \<a name='7'>
  N(k,i-nits+1)=W1(i,j)*C(II(i,j)  ,JJ(i,j)  ,k)  \<a name='8'>
  +W2(i,j)*C(II(i,j)+1,JJ(i,j)  ,k)  \<a name='9'>
  +W3(i,j)*C(II(i,j)+a,JJ(i,j)-1,k)  \<a name='10'>
  +W4(i,j)*C(II(i,j)+a,JJ(i,j)+1,k)<a name='11'>
<a name='12'>
<font color=#447700>! Copy from C array to (k,used) indexed N array:<a name='13'></font>
#define uFCOPY(N,C,i,j,k) \<a name='14'>
  N(k,used)=W1(i,j)*C(II(i,j)  ,JJ(i,j)  ,k)  \<a name='15'>
  +W2(i,j)*C(II(i,j)+1,JJ(i,j)  ,k)  \<a name='16'>
  +W3(i,j)*C(II(i,j)+a,JJ(i,j)-1,k)  \<a name='17'>
  +W4(i,j)*C(II(i,j)+a,JJ(i,j)+1,k)<a name='18'>
<a name='19'>
<font color=#447700>! ICOPY: Grab from C array, but do not assign:<a name='20'></font>
#define ICOPY(C,i,j,k) \<a name='21'>
   (W1(i,j)*C(II(i,j)  ,JJ(i,j)  ,k)  \<a name='22'>
  + W2(i,j)*C(II(i,j)+1,JJ(i,j)  ,k)  \<a name='23'>
  + W3(i,j)*C(II(i,j)+a,JJ(i,j)-1,k)  \<a name='24'>
  + W4(i,j)*C(II(i,j)+a,JJ(i,j)+1,k))<a name='25'>
<a name='26'>
<font color=#447700>! IKJCOPY: grab from IKJ C array, do not assign:<a name='27'></font>
#define IKJCOPY(C,i,k,j) \<a name='28'>
   (W1(i,j)*C(II(i,j)  ,k,JJ(i,j)  )  \<a name='29'>
  + W2(i,j)*C(II(i,j)+1,k,JJ(i,j)  )  \<a name='30'>
  + W3(i,j)*C(II(i,j)+a,k,JJ(i,j)-1)  \<a name='31'>
  + W4(i,j)*C(II(i,j)+a,k,JJ(i,j)+1))<a name='32'>
<a name='33'>
<font color=#447700>! ICOPY2D: grab from IJ C array, do not assign:<a name='34'></font>
#define ICOPY2D(C,i,j) \<a name='35'>
   (W1(i,j)*C(II(i,j)  ,JJ(i,j)  )  \<a name='36'>
  + W2(i,j)*C(II(i,j)+1,JJ(i,j)  )  \<a name='37'>
  + W3(i,j)*C(II(i,j)+a,JJ(i,j)-1)  \<a name='38'>
  + W4(i,j)*C(II(i,j)+a,JJ(i,j)+1))<a name='39'>
<a name='40'>
<font color=#447700>! Copying from N array to C array:<a name='41'></font>
#define UPCOPY(C,N,i,j,k,ni,nj) \<a name='42'>
  C(k,i-istart+1)=(N(ni,nj+2,k) \<a name='43'>
 + N(ni-a  ,nj+1,k)+ N(ni+1-a,nj+1,k) \<a name='44'>
 + N(ni-1,nj  ,k)+ N(ni,nj  ,k)  + N(ni+1,nj  ,k) \<a name='45'>
 + N(ni-a  ,nj-1,k)+ N(ni+1-a,nj-1,k) \<a name='46'>
 +  N(ni,nj-2,k) \<a name='47'>
  ) / 9<a name='48'>
<a name='49'>
<font color=#447700>! Average to C points from N points without assignment:<a name='50'></font>
#define NGRAB(N,ni,nj,nk) \<a name='51'>
(N(ni,nj+2,nk) \<a name='52'>
 + N(ni-a  ,nj+1,nk)+ N(ni+1-a,nj+1,nk)\<a name='53'>
 + N(ni-1,nj  ,nk)  + N(ni,nj  ,nk)  + N(ni+1,nj  ,nk)\<a name='54'>
 + N(ni-a  ,nj-1,nk)+ N(ni+1-a,nj-1,nk)\<a name='55'>
 +  N(ni,nj-2,nk) \<a name='56'>
  ) / 9<a name='57'>
<a name='58'>
<font color=#447700>! Average to C points from N points without assignment on an IKJ grid:<a name='59'></font>
#define NGRABIKJ(N,ni,nk,nj) \<a name='60'>
(N(ni,nk,nj+2) \<a name='61'>
 + N(ni-a  ,nk,nj+1)+ N(ni+1-a,nk,nj+1)   \<a name='62'>
 + N(ni-1,nk,nj  )  + N(ni,nk,nj  )  + N(ni+1,nk,nj  )\<a name='63'>
 + N(ni-a  ,nk,nj-1)+ N(ni+1-a,nk,nj-1)\<a name='64'>
 +  N(ni,nk,nj-2) \<a name='65'>
  ) / 9<a name='66'>
<a name='67'>
<font color=#447700>! Average to C points from N points without assignment, no vertical levels:<a name='68'></font>
#define NGRAB2D(N,ni,nj) \<a name='69'>
(N(ni,nj+2) \<a name='70'>
 + N(ni-a  ,nj+1)+ N(ni+1-a,nj+1)\<a name='71'>
 + N(ni-1,nj  )  + N(ni,nj  )  + N(ni+1,nj  )\<a name='72'>
 + N(ni-a  ,nj-1)+ N(ni+1-a,nj-1)\<a name='73'>
 +  N(ni,nj-2) \<a name='74'>
  ) / 9<a name='75'>
<a name='76'>
<font color=#447700>! Copying from N array to I array:<a name='77'></font>
#define N2ICOPY(C,N,i,j,k,ni,nj) \<a name='78'>
  C(i,j,k)=( N(ni,nj+2,k) \<a name='79'>
 + N(ni-a  ,nj+1,k)+ N(ni+1-a,nj+1,k) \<a name='80'>
 + N(ni-1,nj  ,k)+ N(ni,nj  ,k)  + N(ni+1,nj  ,k) \<a name='81'>
 + N(ni-a  ,nj-1,k)+ N(ni+1-a,nj-1,k) \<a name='82'>
 +  N(ni,nj-2,k) \<a name='83'>
  ) / 9<a name='84'>
<a name='85'>
<font color=#447700>! Maximum value from N array to C array:<a name='86'></font>
#define N2I_SET_MAX(C,N,i,j,k,ni,nj) \<a name='87'>
  C(i,j,k)=max(C(i,j,k),max(N(ni,nj+2,k),   \<a name='88'>
  max(N(ni-1,nj  ,k),max(N(ni,nj  ,k),  max(N(ni+1,nj  ,k),\<a name='89'>
  max(N(ni-a  ,nj-1,k),max(N(ni+1-a,nj-1,k),\<a name='90'>
 N(ni,nj-2,k) )))))))<a name='91'>
<a name='92'>
<font color=#447700>! Maximum value from N array to C array:<a name='93'></font>
#define N2I_SET_MAX_IJ(C,N,i,j,ni,nj) \<a name='94'>
  C(i,j)=max(C(i,j), max(N(ni,nj+2),\<a name='95'>
 max(N(ni-1,nj  ),max(N(ni,nj  ),  max(N(ni+1,nj  ),  \<a name='96'>
   max(N(ni-a  ,nj-1),max(N(ni+1-a,nj-1), \<a name='97'>
    N(ni,nj-2) )))))))<a name='98'>
       <a name='99'>
<a name='100'>
<A NAME='MODULE_INTERP_NMM'><A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='101'>
<font color=#993300>module </font><font color=#cc0000>module_interp_nmm</font> <A href='../../call_to/MODULE_INTERP_NMM.html' TARGET='index'>24</A><a name='102'>
  use <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/module_interp_nmm.F.html#module_interp_nmm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_117">, only: g, R_D, p608<a name='103'>
  implicit none<a name='104'>
<a name='105'>
  private<a name='106'>
  public :: find_kpres<a name='107'>
<a name='108'>
  public :: nmm_interp_pd, nmm_keep_pd, nmm_method_linear<a name='109'>
<a name='110'>
  public :: c2b_fulldom, c2n_fulldom, n2c_fulldom<a name='111'>
  public :: n2c_max2d, n2c_max3d<a name='112'>
  public :: c2b_fulldom_new, n2c_fulldom_new<a name='113'>
  public :: c2b_mass, c2n_mass, n2c_mass<a name='114'>
  public :: c2n_massikj, n2c_massikj<a name='115'>
  public :: c2b_copy3d, c2n_copy3d, n2c_copy3d<a name='116'>
<a name='117'>
  public :: c2b_copy2d, c2n_copy2d, n2c_copy2d, c2n_copy2d_nomask<a name='118'>
  public :: c2b_near2d, c2n_near2d, n2c_near2d<a name='119'>
  public :: c2b_inear2d, c2n_inear2d, n2c_inear2d<a name='120'>
<a name='121'>
  public :: c2n_near3dikj, c2n_sst, c2n_near3d<a name='122'>
<a name='123'>
<font color=#447700>! unimplemented:  public :: nmm_method_quadratic, nmm_method_spline_log, nmm_method_copy, nmm_method_spline<a name='124'></font>
<a name='125'>
<font color=#447700>!  integer, parameter :: nmm_method_copy = 5<a name='126'></font>
<font color=#447700>!  integer, parameter :: nmm_method_spline_log = 4<a name='127'></font>
<font color=#447700>!  integer, parameter :: nmm_method_spline = 3<a name='128'></font>
<font color=#447700>!  integer, parameter :: nmm_method_quadratic = 2<a name='129'></font>
<a name='130'>
  integer, parameter :: nmm_method_linear = 1<a name='131'>
<a name='132'>
  integer, parameter :: nmm_interp_pd = 1<a name='133'>
  integer, parameter :: nmm_keep_pd = 0<a name='134'>
<a name='135'>
  <font color=#447700>! Constants from the original base_state_parent:<a name='136'></font>
  REAL, PARAMETER :: LAPSR=6.5E-3, GI=1./G,D608=0.608<a name='137'>
  REAL, PARAMETER :: COEF3=287.05*GI*LAPSR, COEF2=-1./COEF3<a name='138'>
  REAL, PARAMETER :: TRG=2.0*R_D*GI,LAPSI=1.0/LAPSR<a name='139'>
  REAL, PARAMETER :: P_REF=103000.<a name='140'>
<a name='141'>
  integer, parameter :: EConst=0, ECopy=1, EExtrap=2 <font color=#447700>! MUST match module_dm<a name='142'></font>
<a name='143'>
contains<a name='144'>
  <font color=#447700>! ********************************************************************<a name='145'></font>
  <font color=#447700>! subs *_NEAR2D -- horizontally interpolate via nearest neighbor<a name='146'></font>
  <font color=#447700>! method, but do not vertically interpolate.  Only handles 2D H grid<a name='147'></font>
  <font color=#447700>! arrays.<a name='148'></font>
  <font color=#447700>! ********************************************************************<a name='149'></font>
<a name='150'>
<A NAME='C2B_NEAR2D'><A href='../../html_code/share/module_interp_nmm.F.html#C2B_NEAR2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='151'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2b_near2d</font> (inear,jnear,cfield,         &amp; <A href='../../call_to/C2B_NEAR2D.html' TARGET='index'>1</A><a name='152'>
       fbxs,fbxe,fbys,fbye,                  &amp;<a name='153'>
       cims, cime, cjms, cjme,   &amp;<a name='154'>
       nids, nide, njds, njde,   &amp;<a name='155'>
       nims, nime, njms, njme,   &amp;<a name='156'>
       nits, nite, njts, njte)<a name='157'>
    implicit none<a name='158'>
    integer, parameter :: bdyw = 1<a name='159'>
<a name='160'>
    integer, intent(in):: &amp;<a name='161'>
         cims, cime, cjms, cjme,   &amp;<a name='162'>
         nids, nide, njds, njde,   &amp;<a name='163'>
         nims, nime, njms, njme,   &amp;<a name='164'>
         nits, nite, njts, njte<a name='165'>
<a name='166'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: inear,jnear<a name='167'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme)<a name='168'>
<a name='169'>
    <font color=#447700>! Output field boundary info:<a name='170'></font>
    real,dimension(nims:nime,bdyw) :: fbys,fbye<a name='171'>
    real,dimension(njms:njme,bdyw) :: fbxs,fbxe<a name='172'>
<a name='173'>
    integer :: j,i,a,nx,nz,ck,k,j1,j2,add<a name='174'>
    real :: weight<a name='175'>
<a name='176'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='177'>
<a name='178'>
    j1=max(njts-1,njds)<a name='179'>
    if(mod(j1,2)/=1)   j1=j1+1<a name='180'>
<a name='181'>
    j2=min(njte+1,njde-1)<a name='182'>
    if(mod(j2,2)/=1)   j2=j2-1<a name='183'>
<a name='184'>
    if(nits==1) then<a name='185'>
       i=1<a name='186'>
       do j=j1,j2,2<a name='187'>
          fbxs(j,1)=cfield(inear(i,j),jnear(i,j))<a name='188'>
       enddo<a name='189'>
    endif<a name='190'>
    if(nite&gt;=nide-1) then<a name='191'>
       i=nide-1<a name='192'>
       do j=j1,j2,2<a name='193'>
          fbxe(j,1)=cfield(inear(i,j),jnear(i,j))<a name='194'>
       enddo<a name='195'>
    endif<a name='196'>
    if(njts==1) then<a name='197'>
       j=1<a name='198'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='199'>
          fbys(i,1)=cfield(inear(i,j),jnear(i,j))<a name='200'>
       enddo<a name='201'>
    endif<a name='202'>
    if(njte&gt;=njde-1) then<a name='203'>
       j=njde-1<a name='204'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='205'>
          fbye(i,1)=cfield(inear(i,j),jnear(i,j))<a name='206'>
       enddo<a name='207'>
    endif<a name='208'>
  end subroutine c2b_near2d<a name='209'>
<a name='210'>
<A NAME='N2C_NEAR2D'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_NEAR2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='211'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_near2d</font> (&amp; <A href='../../call_to/N2C_NEAR2D.html' TARGET='index'>1</A><a name='212'>
       cfield,nfield,ipos,jpos,  &amp;<a name='213'>
       cids, cide, cjds, cjde,   &amp;<a name='214'>
       cims, cime, cjms, cjme,   &amp;<a name='215'>
       cits, cite, cjts, cjte,   &amp;<a name='216'>
       nids, nide, njds, njde,   &amp;<a name='217'>
       nims, nime, njms, njme,   &amp;<a name='218'>
       nits, nite, njts, njte)<a name='219'>
    implicit none<a name='220'>
    integer, intent(in) :: &amp;<a name='221'>
         cids, cide, cjds, cjde,   &amp;<a name='222'>
         cims, cime, cjms, cjme,   &amp;<a name='223'>
         cits, cite, cjts, cjte,   &amp;<a name='224'>
         nids, nide, njds, njde,   &amp;<a name='225'>
         nims, nime, njms, njme,   &amp;<a name='226'>
         nits, nite, njts, njte,   &amp;<a name='227'>
         ipos,jpos<a name='228'>
    real, intent(out) :: cfield(cims:cime,cjms:cjme)<a name='229'>
    real, intent(in) :: nfield(nims:nime,njms:njme)<a name='230'>
<a name='231'>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='232'></font>
    integer :: nz,jstart,jend,istart,iend,ni,nj,a,i,j<a name='233'>
<a name='234'>
    jstart=MAX(jpos+1,cjts)<a name='235'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='236'>
<a name='237'>
    bigj: do j=jstart,jend<a name='238'>
       a=mod(j,2)<a name='239'>
       istart=MAX(ipos+a,cits)<a name='240'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='241'>
       nj = (j-jpos)*nrj + 1<a name='242'>
<a name='243'>
       iloop: do i=istart,iend<a name='244'>
          ni = (i-ipos)*nri + 2 - a<a name='245'>
          cfield(i,j)=nfield(ni,nj)<a name='246'>
       enddo iloop<a name='247'>
    enddo bigj<a name='248'>
  end subroutine n2c_near2d<a name='249'>
<a name='250'>
<A NAME='C2N_NEAR2D'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_NEAR2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='251'>
    <font color=#993300>subroutine </font><font color=#cc0000>c2n_near2d</font> (inear,jnear,    &amp; <A href='../../call_to/C2N_NEAR2D.html' TARGET='index'>1</A><a name='252'>
       cfield,nfield,imask,     &amp;<a name='253'>
       cims, cime, cjms, cjme,   &amp;<a name='254'>
       nids, nide, njds, njde,   &amp;<a name='255'>
       nims, nime, njms, njme,   &amp;<a name='256'>
       nits, nite, njts, njte)<a name='257'>
    implicit none<a name='258'>
<a name='259'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: inear,jnear<a name='260'>
<a name='261'>
    integer, intent(in):: cims, cime, cjms, cjme,   &amp;<a name='262'>
         nids, nide, njds, njde,   &amp;<a name='263'>
         nims, nime, njms, njme,   &amp;<a name='264'>
         nits, nite, njts, njte<a name='265'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='266'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme)<a name='267'>
    real, intent(out) :: nfield(nims:nime,njms:njme)<a name='268'>
<a name='269'>
    integer :: j,i,a,nx<a name='270'>
<a name='271'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='272'>
<a name='273'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='274'>
       interploop: do i=max(nids,nits),min(nide-1,nite)<a name='275'>
          if(imask(i,j)/=0) cycle interploop<a name='276'>
          nfield(i,j)=cfield(inear(i,j),jnear(i,j))<a name='277'>
       enddo interploop<a name='278'>
    end do bigj<a name='279'>
  end subroutine c2n_near2d<a name='280'>
<a name='281'>
<A NAME='C2N_NEAR3D'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_NEAR3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='282'>
    <font color=#993300>subroutine </font><font color=#cc0000>c2n_near3d</font> (inear,jnear,    &amp; <A href='../../call_to/C2N_NEAR3D.html' TARGET='index'>1</A><a name='283'>
       cfield,nfield,imask,     &amp;<a name='284'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='285'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='286'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='287'>
       nits, nite, njts, njte, nkts, nkte)<a name='288'>
    implicit none<a name='289'>
<a name='290'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: inear,jnear<a name='291'>
<a name='292'>
    integer, intent(in):: cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='293'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='294'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='295'>
         nits, nite, njts, njte, nkts, nkte<a name='296'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='297'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme,ckms:ckme)<a name='298'>
    real, intent(out) :: nfield(nims:nime,njms:njme,nkms:nkme)<a name='299'>
<a name='300'>
    integer :: j,i,a,nx,k<a name='301'>
<a name='302'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='303'>
<a name='304'>
    bigk: do k=nkds,nkde<a name='305'>
       bigj: do j=max(njds,njts),min(njde-1,njte)<a name='306'>
          interploop: do i=max(nids,nits),min(nide-1,nite)<a name='307'>
             if(imask(i,j)/=0) cycle interploop<a name='308'>
             nfield(i,j,k)=cfield(inear(i,j),jnear(i,j),k)<a name='309'>
          enddo interploop<a name='310'>
       end do bigj<a name='311'>
    enddo bigk<a name='312'>
  end subroutine c2n_near3d<a name='313'>
<a name='314'>
<A NAME='C2N_NEAR3DIKJ'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_NEAR3DIKJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='315'>
    <font color=#993300>subroutine </font><font color=#cc0000>c2n_near3dikj</font> (inear,jnear,    &amp; <A href='../../call_to/C2N_NEAR3DIKJ.html' TARGET='index'>1</A><a name='316'>
       cfield,nfield,imask,     &amp;<a name='317'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='318'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='319'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='320'>
       nits, nite, njts, njte, nkts, nkte)<a name='321'>
    implicit none<a name='322'>
<a name='323'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: inear,jnear<a name='324'>
<a name='325'>
    integer, intent(in):: cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='326'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='327'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='328'>
         nits, nite, njts, njte, nkts, nkte<a name='329'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='330'>
    real, intent(in) :: cfield(cims:cime,ckms:ckme,cjms:cjme)<a name='331'>
    real, intent(out) :: nfield(nims:nime,nkms:nkme,njms:njme)<a name='332'>
<a name='333'>
    integer :: j,i,a,nx,k<a name='334'>
<a name='335'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='336'>
<a name='337'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='338'>
       bigk: do k=nkds,nkde<a name='339'>
          interploop: do i=max(nids,nits),min(nide-1,nite)<a name='340'>
             if(imask(i,j)/=0) cycle interploop<a name='341'>
             nfield(i,k,j)=cfield(inear(i,j),k,jnear(i,j))<a name='342'>
          enddo interploop<a name='343'>
       enddo bigk<a name='344'>
    end do bigj<a name='345'>
  end subroutine c2n_near3dikj<a name='346'>
<a name='347'>
<A NAME='C2N_SST'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_SST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='348'>
    <font color=#993300>subroutine </font><font color=#cc0000>c2n_sst</font> (inear,jnear,    &amp; <A href='../../call_to/C2N_SST.html' TARGET='index'>1</A><a name='349'>
       cfield,nfield,     &amp;<a name='350'>
       cims, cime, cjms, cjme,   &amp;<a name='351'>
       nids, nide, njds, njde,   &amp;<a name='352'>
       nims, nime, njms, njme,   &amp;<a name='353'>
       nits, nite, njts, njte)<a name='354'>
    implicit none<a name='355'>
<a name='356'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: inear,jnear<a name='357'>
<a name='358'>
    integer, intent(in):: cims, cime, cjms, cjme,   &amp;<a name='359'>
         nids, nide, njds, njde,   &amp;<a name='360'>
         nims, nime, njms, njme,   &amp;<a name='361'>
         nits, nite, njts, njte<a name='362'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme)<a name='363'>
    real, intent(out) :: nfield(nims:nime,njms:njme)<a name='364'>
<a name='365'>
    integer :: j,i,a,nx<a name='366'>
<a name='367'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='368'>
<a name='369'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='370'>
       interploop: do i=max(nids,nits),min(nide-1,nite)<a name='371'>
          nfield(i,j)=cfield(inear(i,j),jnear(i,j))<a name='372'>
       enddo interploop<a name='373'>
    end do bigj<a name='374'>
  end subroutine c2n_sst<a name='375'>
<a name='376'>
  <font color=#447700>! ********************************************************************<a name='377'></font>
  <font color=#447700>! subs *_INEAR2D -- horizontally interpolate integers via nearest<a name='378'></font>
  <font color=#447700>! neighbor method, but do not vertically interpolate.  Only handles<a name='379'></font>
  <font color=#447700>! 2D H grid integer arrays.<a name='380'></font>
  <font color=#447700>! ********************************************************************<a name='381'></font>
<a name='382'>
<A NAME='C2B_INEAR2D'><A href='../../html_code/share/module_interp_nmm.F.html#C2B_INEAR2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='383'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2b_inear2d</font> (inear,jnear,cfield,         &amp; <A href='../../call_to/C2B_INEAR2D.html' TARGET='index'>1</A><a name='384'>
       fbxs,fbxe,fbys,fbye,                  &amp;<a name='385'>
       cims, cime, cjms, cjme,   &amp;<a name='386'>
       nids, nide, njds, njde,   &amp;<a name='387'>
       nims, nime, njms, njme,   &amp;<a name='388'>
       nits, nite, njts, njte)<a name='389'>
    implicit none<a name='390'>
    integer, parameter :: bdyw = 1<a name='391'>
<a name='392'>
    integer, intent(in):: &amp;<a name='393'>
         cims, cime, cjms, cjme,   &amp;<a name='394'>
         nids, nide, njds, njde,   &amp;<a name='395'>
         nims, nime, njms, njme,   &amp;<a name='396'>
         nits, nite, njts, njte<a name='397'>
<a name='398'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: inear,jnear<a name='399'>
    integer, intent(in) :: cfield(cims:cime,cjms:cjme)<a name='400'>
<a name='401'>
    <font color=#447700>! Output field boundary info:<a name='402'></font>
    integer,dimension(nims:nime,bdyw) :: fbys,fbye<a name='403'>
    integer,dimension(njms:njme,bdyw) :: fbxs,fbxe<a name='404'>
<a name='405'>
    integer :: j,i,a,nx,nz,ck,k,j1,j2,add<a name='406'>
<a name='407'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='408'>
<a name='409'>
    j1=max(njts-1,njds)<a name='410'>
    if(mod(j1,2)/=1)   j1=j1+1<a name='411'>
<a name='412'>
    j2=min(njte+1,njde-1)<a name='413'>
    if(mod(j2,2)/=1)   j2=j2-1<a name='414'>
<a name='415'>
    if(nits==1) then<a name='416'>
       i=1<a name='417'>
       do j=j1,j2,2<a name='418'>
          fbxs(j,1)=cfield(inear(i,j),jnear(i,j))<a name='419'>
       enddo<a name='420'>
    endif<a name='421'>
    if(nite&gt;=nide-1) then<a name='422'>
       i=nide-1<a name='423'>
       do j=j1,j2,2<a name='424'>
          fbxe(j,1)=cfield(inear(i,j),jnear(i,j))<a name='425'>
       enddo<a name='426'>
    endif<a name='427'>
    if(njts==1) then<a name='428'>
       j=1<a name='429'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='430'>
          fbys(i,1)=cfield(inear(i,j),jnear(i,j))<a name='431'>
       enddo<a name='432'>
    endif<a name='433'>
    if(njte&gt;=njde-1) then<a name='434'>
       j=njde-1<a name='435'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='436'>
          fbye(i,1)=cfield(inear(i,j),jnear(i,j))<a name='437'>
       enddo<a name='438'>
    endif<a name='439'>
  end subroutine c2b_inear2d<a name='440'>
<a name='441'>
<A NAME='N2C_INEAR2D'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_INEAR2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='442'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_inear2d</font> (&amp; <A href='../../call_to/N2C_INEAR2D.html' TARGET='index'>1</A><a name='443'>
       cfield,nfield,ipos,jpos,  &amp;<a name='444'>
       cids, cide, cjds, cjde,   &amp;<a name='445'>
       cims, cime, cjms, cjme,   &amp;<a name='446'>
       cits, cite, cjts, cjte,   &amp;<a name='447'>
       nids, nide, njds, njde,   &amp;<a name='448'>
       nims, nime, njms, njme,   &amp;<a name='449'>
       nits, nite, njts, njte)<a name='450'>
    implicit none<a name='451'>
    integer, intent(in) :: &amp;<a name='452'>
         cids, cide, cjds, cjde,   &amp;<a name='453'>
         cims, cime, cjms, cjme,   &amp;<a name='454'>
         cits, cite, cjts, cjte,   &amp;<a name='455'>
         nids, nide, njds, njde,   &amp;<a name='456'>
         nims, nime, njms, njme,   &amp;<a name='457'>
         nits, nite, njts, njte,   &amp;<a name='458'>
         ipos,jpos<a name='459'>
    integer, intent(out) :: cfield(cims:cime,cjms:cjme)<a name='460'>
    integer, intent(in) :: nfield(nims:nime,njms:njme)<a name='461'>
<a name='462'>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='463'></font>
    integer :: nz,jstart,jend,istart,iend,ni,nj,a,i,j<a name='464'>
<a name='465'>
    jstart=MAX(jpos+1,cjts)<a name='466'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='467'>
<a name='468'>
    bigj: do j=jstart,jend<a name='469'>
       a=mod(j,2)<a name='470'>
       istart=MAX(ipos+a,cits)<a name='471'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='472'>
       nj = (j-jpos)*nrj + 1<a name='473'>
<a name='474'>
       iloop: do i=istart,iend<a name='475'>
          ni = (i-ipos)*nri + 2 - a<a name='476'>
          cfield(i,j)=nfield(ni,nj)<a name='477'>
       enddo iloop<a name='478'>
    enddo bigj<a name='479'>
  end subroutine n2c_inear2d<a name='480'>
<a name='481'>
<A NAME='C2N_INEAR2D'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_INEAR2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='482'>
    <font color=#993300>subroutine </font><font color=#cc0000>c2n_inear2d</font> (inear,jnear,    &amp; <A href='../../call_to/C2N_INEAR2D.html' TARGET='index'>1</A><a name='483'>
       cfield,nfield,imask,     &amp;<a name='484'>
       cims, cime, cjms, cjme,   &amp;<a name='485'>
       nids, nide, njds, njde,   &amp;<a name='486'>
       nims, nime, njms, njme,   &amp;<a name='487'>
       nits, nite, njts, njte)<a name='488'>
    implicit none<a name='489'>
<a name='490'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: inear,jnear<a name='491'>
<a name='492'>
    integer, intent(in):: cims, cime, cjms, cjme,   &amp;<a name='493'>
         nids, nide, njds, njde,   &amp;<a name='494'>
         nims, nime, njms, njme,   &amp;<a name='495'>
         nits, nite, njts, njte<a name='496'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='497'>
    integer, intent(in) :: cfield(cims:cime,cjms:cjme)<a name='498'>
    integer, intent(out) :: nfield(nims:nime,njms:njme)<a name='499'>
<a name='500'>
    integer :: j,i,a,nx<a name='501'>
<a name='502'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='503'>
<a name='504'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='505'>
       interploop: do i=max(nids,nits),min(nide-1,nite)<a name='506'>
          if(imask(i,j)/=0) cycle interploop<a name='507'>
          nfield(i,j)=cfield(inear(i,j),jnear(i,j))<a name='508'>
       enddo interploop<a name='509'>
    end do bigj<a name='510'>
  end subroutine c2n_inear2d<a name='511'>
<a name='512'>
  <font color=#447700>! ********************************************************************<a name='513'></font>
  <font color=#447700>! subs *_COPY2D -- horizontally interpolate but do not vertically<a name='514'></font>
  <font color=#447700>! interpolate.  Only handles 2D arrays (H or V grid).<a name='515'></font>
  <font color=#447700>! ********************************************************************<a name='516'></font>
<a name='517'>
<A NAME='C2B_COPY2D'><A href='../../html_code/share/module_interp_nmm.F.html#C2B_COPY2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='518'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2b_copy2d</font> (II,JJ,W1,W2,W3,W4,cfield,         &amp; <A href='../../call_to/C2B_COPY2D.html' TARGET='index'>3</A><a name='519'>
       fbxs,fbxe,fbys,fbye,                  &amp;<a name='520'>
       cims, cime, cjms, cjme,   &amp;<a name='521'>
       nids, nide, njds, njde,   &amp;<a name='522'>
       nims, nime, njms, njme,   &amp;<a name='523'>
       nits, nite, njts, njte, hgrid)<a name='524'>
    implicit none<a name='525'>
    integer, parameter :: bdyw = 1<a name='526'>
<a name='527'>
    integer, intent(in):: &amp;<a name='528'>
         cims, cime, cjms, cjme,   &amp;<a name='529'>
         nids, nide, njds, njde,   &amp;<a name='530'>
         nims, nime, njms, njme,   &amp;<a name='531'>
         nits, nite, njts, njte<a name='532'>
    logical, intent(in) :: hgrid<a name='533'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='534'>
         W1,W2,W3,W4<a name='535'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='536'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme)<a name='537'>
<a name='538'>
    <font color=#447700>! Output field boundary info:<a name='539'></font>
    real,dimension(nims:nime,bdyw) :: fbys,fbye<a name='540'>
    real,dimension(njms:njme,bdyw) :: fbxs,fbxe<a name='541'>
<a name='542'>
    integer :: j,i,a,nx,nz,ck,k,j1,j2,add<a name='543'>
    real :: weight<a name='544'>
<a name='545'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='546'>
<a name='547'>
    if(hgrid) then<a name='548'>
       a=1<a name='549'>
    else<a name='550'>
       a=0<a name='551'>
    endif<a name='552'>
<a name='553'>
    j1=max(njts-1,njds)<a name='554'>
    if(mod(j1,2)/=a)   j1=j1+1<a name='555'>
<a name='556'>
    j2=min(njte+1,njde-1)<a name='557'>
    if(mod(j2,2)/=a)   j2=j2-1<a name='558'>
<a name='559'>
    if(nits==1) then<a name='560'>
       i=1<a name='561'>
       do j=j1,j2,2<a name='562'>
          if(hgrid) then<a name='563'>
             a=1-mod(JJ(i,j),2)<a name='564'>
          else<a name='565'>
             a=mod(JJ(i,j),2)<a name='566'>
          endif<a name='567'>
          fbxs(j,1)=ICOPY2D(cfield,i,j)<a name='568'>
       enddo<a name='569'>
    endif<a name='570'>
    if(nite&gt;=nide-1) then<a name='571'>
       i=nide-1<a name='572'>
       do j=j1,j2,2<a name='573'>
          if(hgrid) then<a name='574'>
             a=1-mod(JJ(i,j),2)<a name='575'>
          else<a name='576'>
             a=mod(JJ(i,j),2)<a name='577'>
          endif<a name='578'>
          fbxe(j,1)=ICOPY2D(cfield,i,j)<a name='579'>
       enddo<a name='580'>
    endif<a name='581'>
    if(njts==1) then<a name='582'>
       j=1<a name='583'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='584'>
          if(hgrid) then<a name='585'>
             a=1-mod(JJ(i,j),2)<a name='586'>
          else<a name='587'>
             a=mod(JJ(i,j),2)<a name='588'>
          endif<a name='589'>
          fbys(i,1)=ICOPY2D(cfield,i,j)<a name='590'>
       enddo<a name='591'>
    endif<a name='592'>
    if(njte&gt;=njde-1) then<a name='593'>
       j=njde-1<a name='594'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='595'>
          if(hgrid) then<a name='596'>
             a=1-mod(JJ(i,j),2)<a name='597'>
          else<a name='598'>
             a=mod(JJ(i,j),2)<a name='599'>
          endif<a name='600'>
          fbye(i,1)=ICOPY2D(cfield,i,j)<a name='601'>
       enddo<a name='602'>
    endif<a name='603'>
  end subroutine c2b_copy2d<a name='604'>
<A NAME='N2C_COPY2D'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_COPY2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='605'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_copy2d</font> (&amp; <A href='../../call_to/N2C_COPY2D.html' TARGET='index'>4</A><a name='606'>
       cfield,nfield,ipos,jpos,  &amp;<a name='607'>
       cids, cide, cjds, cjde,   &amp;<a name='608'>
       cims, cime, cjms, cjme,   &amp;<a name='609'>
       cits, cite, cjts, cjte,   &amp;<a name='610'>
       nids, nide, njds, njde,   &amp;<a name='611'>
       nims, nime, njms, njme,   &amp;<a name='612'>
       nits, nite, njts, njte, &amp;<a name='613'>
       hgrid)<a name='614'>
    implicit none<a name='615'>
    integer, intent(in) :: &amp;<a name='616'>
         cids, cide, cjds, cjde,   &amp;<a name='617'>
         cims, cime, cjms, cjme,   &amp;<a name='618'>
         cits, cite, cjts, cjte,   &amp;<a name='619'>
         nids, nide, njds, njde,   &amp;<a name='620'>
         nims, nime, njms, njme,   &amp;<a name='621'>
         nits, nite, njts, njte,   &amp;<a name='622'>
         ipos,jpos<a name='623'>
    real, intent(out) :: cfield(cims:cime,cjms:cjme)<a name='624'>
    real, intent(in) :: nfield(nims:nime,njms:njme)<a name='625'>
    logical, intent(in) :: hgrid<a name='626'>
<a name='627'>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='628'></font>
    integer :: nz,jstart,jend,istart,iend,ni,nj,a,i,j<a name='629'>
<a name='630'>
    jstart=MAX(jpos+1,cjts)<a name='631'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='632'>
<a name='633'>
    bigj: do j=jstart,jend<a name='634'>
          a=mod(j,2)<a name='635'>
          if(.not.hgrid) then<a name='636'>
             a=1-a<a name='637'>
          endif<a name='638'>
       istart=MAX(ipos+a,cits)<a name='639'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='640'>
       nj = (j-jpos)*nrj + 1<a name='641'>
<a name='642'>
       iloop: do i=istart,iend<a name='643'>
          ni = (i-ipos)*nri + 2 - a<a name='644'>
          cfield(i,j)=NGRAB2D(nfield,ni,nj)<a name='645'>
       enddo iloop<a name='646'>
    enddo bigj <a name='647'>
 end subroutine n2c_copy2d<a name='648'>
<a name='649'>
<A NAME='N2C_MAX2D'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_MAX2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='650'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_max2d</font> (&amp; <A href='../../call_to/N2C_MAX2D.html' TARGET='index'>1</A><a name='651'>
       cfield,nfield,ipos,jpos,  &amp;<a name='652'>
       cids, cide, cjds, cjde,   &amp;<a name='653'>
       cims, cime, cjms, cjme,   &amp;<a name='654'>
       cits, cite, cjts, cjte,   &amp;<a name='655'>
       nids, nide, njds, njde,   &amp;<a name='656'>
       nims, nime, njms, njme,   &amp;<a name='657'>
       nits, nite, njts, njte, &amp;<a name='658'>
       hgrid)<a name='659'>
    implicit none<a name='660'>
    integer, intent(in) :: &amp;<a name='661'>
         cids, cide, cjds, cjde,   &amp;<a name='662'>
         cims, cime, cjms, cjme,   &amp;<a name='663'>
         cits, cite, cjts, cjte,   &amp;<a name='664'>
         nids, nide, njds, njde,   &amp;<a name='665'>
         nims, nime, njms, njme,   &amp;<a name='666'>
         nits, nite, njts, njte,   &amp;<a name='667'>
         ipos,jpos<a name='668'>
    real, intent(out) :: cfield(cims:cime,cjms:cjme)<a name='669'>
    real, intent(in) :: nfield(nims:nime,njms:njme)<a name='670'>
    logical, intent(in) :: hgrid<a name='671'>
<a name='672'>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='673'></font>
    integer :: nz,jstart,jend,istart,iend,ni,nj,a,i,j<a name='674'>
<a name='675'>
    jstart=MAX(jpos+1,cjts)<a name='676'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='677'>
<a name='678'>
    bigj: do j=jstart,jend<a name='679'>
          a=mod(j,2)<a name='680'>
          if(.not.hgrid) then<a name='681'>
             a=1-a<a name='682'>
          endif<a name='683'>
       istart=MAX(ipos+a,cits)<a name='684'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='685'>
       nj = (j-jpos)*nrj + 1<a name='686'>
<a name='687'>
       iloop: do i=istart,iend<a name='688'>
          ni = (i-ipos)*nri + 2 - a<a name='689'>
          N2I_SET_MAX_IJ(cfield,nfield,i,j,ni,nj)<a name='690'>
       enddo iloop<a name='691'>
    enddo bigj <a name='692'>
  end subroutine n2c_max2d<a name='693'>
<a name='694'>
<A NAME='C2N_COPY2D'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='695'>
    <font color=#993300>subroutine </font><font color=#cc0000>c2n_copy2d</font> (II,JJ,W1,W2,W3,W4,    &amp; <A href='../../call_to/C2N_COPY2D.html' TARGET='index'>3</A><a name='696'>
       cfield,nfield,imask,     &amp;<a name='697'>
       cims, cime, cjms, cjme,   &amp;<a name='698'>
       nids, nide, njds, njde,   &amp;<a name='699'>
       nims, nime, njms, njme,   &amp;<a name='700'>
       nits, nite, njts, njte, hgrid)<a name='701'>
    implicit none<a name='702'>
    logical, intent(in) :: hgrid<a name='703'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='704'>
         W1,W2,W3,W4<a name='705'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='706'>
<a name='707'>
    integer, intent(in):: cims, cime, cjms, cjme,   &amp;<a name='708'>
         nids, nide, njds, njde,   &amp;<a name='709'>
         nims, nime, njms, njme,   &amp;<a name='710'>
         nits, nite, njts, njte<a name='711'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='712'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme)<a name='713'>
    real, intent(out) :: nfield(nims:nime,njms:njme)<a name='714'>
<a name='715'>
    integer :: j,i,a,nx<a name='716'>
<a name='717'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='718'>
<a name='719'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='720'>
       interploop: do i=max(nids,nits),min(nide-1,nite)<a name='721'>
          if(imask(i,j)/=0) cycle interploop<a name='722'>
          if(hgrid) then<a name='723'>
             a=1-mod(JJ(i,j),2)<a name='724'>
          else<a name='725'>
             a=mod(JJ(i,j),2)<a name='726'>
          endif<a name='727'>
          nfield(i,j)=ICOPY2D(cfield,i,j)<a name='728'>
       enddo interploop<a name='729'>
    end do bigj<a name='730'>
  end subroutine c2n_copy2d<a name='731'>
<a name='732'>
<A NAME='C2N_COPY2D_NOMASK'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY2D_NOMASK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='733'>
    <font color=#993300>subroutine </font><font color=#cc0000>c2n_copy2d_nomask</font> (II,JJ,W1,W2,W3,W4,    &amp; <A href='../../call_to/C2N_COPY2D_NOMASK.html' TARGET='index'>1</A><a name='734'>
       cfield,nfield,     &amp;<a name='735'>
       cims, cime, cjms, cjme,   &amp;<a name='736'>
       nids, nide, njds, njde,   &amp;<a name='737'>
       nims, nime, njms, njme,   &amp;<a name='738'>
       nits, nite, njts, njte, hgrid)<a name='739'>
    implicit none<a name='740'>
    logical, intent(in) :: hgrid<a name='741'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='742'>
         W1,W2,W3,W4<a name='743'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='744'>
<a name='745'>
    integer, intent(in):: cims, cime, cjms, cjme,   &amp;<a name='746'>
         nids, nide, njds, njde,   &amp;<a name='747'>
         nims, nime, njms, njme,   &amp;<a name='748'>
         nits, nite, njts, njte<a name='749'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme)<a name='750'>
    real, intent(out) :: nfield(nims:nime,njms:njme)<a name='751'>
<a name='752'>
    integer :: j,i,a,nx<a name='753'>
<a name='754'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='755'>
<a name='756'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='757'>
       interploop: do i=max(nids,nits),min(nide-1,nite)<a name='758'>
          if(hgrid) then<a name='759'>
             a=1-mod(JJ(i,j),2)<a name='760'>
          else<a name='761'>
             a=mod(JJ(i,j),2)<a name='762'>
          endif<a name='763'>
          nfield(i,j)=ICOPY2D(cfield,i,j)<a name='764'>
       enddo interploop<a name='765'>
    end do bigj<a name='766'>
  end subroutine c2n_copy2d_nomask<a name='767'>
<a name='768'>
<a name='769'>
  <font color=#447700>! ********************************************************************<a name='770'></font>
  <font color=#447700>! subs *_COPY3D -- horizontally interpolate but do not vertically<a name='771'></font>
  <font color=#447700>! interpolate<a name='772'></font>
  <font color=#447700>! ********************************************************************<a name='773'></font>
<a name='774'>
<A NAME='C2B_COPY3D'><A href='../../html_code/share/module_interp_nmm.F.html#C2B_COPY3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='775'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2b_copy3d</font>  (II,JJ,W1,W2,W3,W4,cfield,         &amp; <A href='../../call_to/C2B_COPY3D.html' TARGET='index'>2</A><a name='776'>
       fbxs,fbxe,fbys,fbye,                  &amp;<a name='777'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='778'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='779'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='780'>
       nits, nite, njts, njte, nkts, nkte, hgrid)<a name='781'>
    implicit none<a name='782'>
    integer, parameter :: bdyw = 1<a name='783'>
    logical, intent(in) :: hgrid<a name='784'>
    integer, intent(in):: &amp;<a name='785'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='786'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='787'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='788'>
         nits, nite, njts, njte, nkts, nkte<a name='789'>
<a name='790'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='791'>
         W1,W2,W3,W4<a name='792'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='793'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme,ckms:ckme)<a name='794'>
<a name='795'>
    <font color=#447700>! Output field boundary info:<a name='796'></font>
    real,dimension(nims:nime,nkms:nkme,bdyw) :: fbys,fbye<a name='797'>
    real,dimension(njms:njme,nkms:nkme,bdyw) :: fbxs,fbxe<a name='798'>
<a name='799'>
    integer :: j,i,a,nx,nz,ck,k,j1,j2<a name='800'>
    real :: weight<a name='801'>
<a name='802'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='803'>
    nz=nkde-nkds+1<a name='804'>
<a name='805'>
    j1=max(njts-1,njds)<a name='806'>
    if(mod(j1,2)/=0)   j1=j1+1<a name='807'>
<a name='808'>
    j2=min(njte+1,njde-1)<a name='809'>
    if(mod(j2,2)/=0)   j2=j2-1<a name='810'>
<a name='811'>
    if(nits==1) then<a name='812'>
       i=1<a name='813'>
       do j=j1,j2,2<a name='814'>
          if(hgrid) then<a name='815'>
             a=1-mod(JJ(i,j),2)<a name='816'>
          else<a name='817'>
             a=mod(JJ(i,j),2)<a name='818'>
          endif<a name='819'>
          kloop1: do k=nkds,min(nkde,nkte)<a name='820'>
             fbxs(j,k,1)=ICOPY(cfield,i,j,k)<a name='821'>
          enddo kloop1<a name='822'>
       enddo<a name='823'>
    endif<a name='824'>
    if(nite&gt;=nide-1) then<a name='825'>
       i=nide-1<a name='826'>
       do j=j1,j2,2<a name='827'>
          if(hgrid) then<a name='828'>
             a=1-mod(JJ(i,j),2)<a name='829'>
          else<a name='830'>
             a=mod(JJ(i,j),2)<a name='831'>
          endif<a name='832'>
          kloop2: do k=nkds,min(nkde,nkte)<a name='833'>
             fbxe(j,k,1)=ICOPY(cfield,i,j,k)<a name='834'>
          enddo kloop2<a name='835'>
       enddo<a name='836'>
    endif<a name='837'>
    if(njts==1) then<a name='838'>
       j=1<a name='839'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='840'>
          if(hgrid) then<a name='841'>
             a=1-mod(JJ(i,j),2)<a name='842'>
          else<a name='843'>
             a=mod(JJ(i,j),2)<a name='844'>
          endif<a name='845'>
          kloop3: do k=nkts,min(nkde,nkte)<a name='846'>
             fbys(i,k,1)=ICOPY(cfield,i,j,k)<a name='847'>
          enddo kloop3<a name='848'>
       enddo<a name='849'>
    endif<a name='850'>
    if(njte&gt;=njde-1) then<a name='851'>
       j=njde-1<a name='852'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='853'>
          if(hgrid) then<a name='854'>
             a=1-mod(JJ(i,j),2)<a name='855'>
          else<a name='856'>
             a=mod(JJ(i,j),2)<a name='857'>
          endif<a name='858'>
          kloop4: do k=nkts,min(nkde,nkte)<a name='859'>
             fbye(i,k,1)=ICOPY(cfield,i,j,k)<a name='860'>
          enddo kloop4<a name='861'>
       enddo<a name='862'>
    endif<a name='863'>
  end subroutine c2b_copy3d<a name='864'>
  <a name='865'>
<A NAME='N2C_COPY3D'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_COPY3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='866'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_copy3d</font> (&amp; <A href='../../call_to/N2C_COPY3D.html' TARGET='index'>2</A><a name='867'>
       cfield,nfield,ipos,jpos,  &amp;<a name='868'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='869'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='870'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='871'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='872'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='873'>
       nits, nite, njts, njte, nkts, nkte,   &amp;<a name='874'>
       hgrid)<a name='875'>
    implicit none<a name='876'>
    logical, intent(in) :: hgrid<a name='877'>
    integer, intent(in) :: &amp;<a name='878'>
         cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='879'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='880'>
         cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='881'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='882'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='883'>
         nits, nite, njts, njte, nkts, nkte,   &amp;<a name='884'>
         ipos,jpos<a name='885'>
    real, intent(out) :: cfield(cims:cime,cjms:cjme,ckms:ckme)<a name='886'>
    real, intent(in) :: nfield(nims:nime,njms:njme,nkms:nkme)<a name='887'>
<a name='888'>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='889'></font>
    integer :: nx,nz,jstart,jend,istart,iend,ni,nj,a,i,j,k,nk<a name='890'>
    real :: weight<a name='891'>
<a name='892'>
    nx=min(nide-2,nite)-max(nids+1,nits)+1<a name='893'>
    nz=nkde-nkds+1<a name='894'>
<a name='895'>
    jstart=MAX(jpos+1,cjts)<a name='896'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='897'>
<a name='898'>
    bigj: do j=jstart,jend<a name='899'>
       if(hgrid) then<a name='900'>
          a=mod(j,2)<a name='901'>
       else<a name='902'>
          a=1-mod(j,2)<a name='903'>
       endif<a name='904'>
       istart=MAX(ipos+a,cits)<a name='905'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='906'>
       nj = (j-jpos)*nrj + 1<a name='907'>
<a name='908'>
       iloop: do i=istart,iend<a name='909'>
          do k=nkds,nkde<a name='910'>
             ni = (i-ipos)*nri + 2 - a<a name='911'>
             cfield(i,j,k)=NGRAB(nfield,ni,nj,k)<a name='912'>
          enddo<a name='913'>
       enddo iloop<a name='914'>
    enddo bigj<a name='915'>
  end subroutine n2c_copy3d<a name='916'>
<a name='917'>
<A NAME='N2C_MAX3D'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_MAX3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='918'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_max3d</font> (&amp; <A href='../../call_to/N2C_MAX3D.html' TARGET='index'>1</A><a name='919'>
       cfield,nfield,ipos,jpos,  &amp;<a name='920'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='921'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='922'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='923'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='924'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='925'>
       nits, nite, njts, njte, nkts, nkte,   &amp;<a name='926'>
       hgrid)<a name='927'>
    implicit none<a name='928'>
    logical, intent(in) :: hgrid<a name='929'>
    integer, intent(in) :: &amp;<a name='930'>
         cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='931'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='932'>
         cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='933'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='934'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='935'>
         nits, nite, njts, njte, nkts, nkte,   &amp;<a name='936'>
         ipos,jpos<a name='937'>
    real, intent(out) :: cfield(cims:cime,cjms:cjme,ckms:ckme)<a name='938'>
    real, intent(in) :: nfield(nims:nime,njms:njme,nkms:nkme)<a name='939'>
<a name='940'>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='941'></font>
    integer :: nx,nz,jstart,jend,istart,iend,ni,nj,a,i,j,k,nk<a name='942'>
    real :: weight<a name='943'>
<a name='944'>
    nx=min(nide-2,nite)-max(nids+1,nits)+1<a name='945'>
    nz=nkde-nkds+1<a name='946'>
<a name='947'>
    jstart=MAX(jpos+1,cjts)<a name='948'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='949'>
<a name='950'>
    bigj: do j=jstart,jend<a name='951'>
       if(hgrid) then<a name='952'>
          a=mod(j,2)<a name='953'>
       else<a name='954'>
          a=1-mod(j,2)<a name='955'>
       endif<a name='956'>
       istart=MAX(ipos+a,cits)<a name='957'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='958'>
       nj = (j-jpos)*nrj + 1<a name='959'>
<a name='960'>
       iloop: do i=istart,iend<a name='961'>
          do k=nkds,nkde<a name='962'>
             ni = (i-ipos)*nri + 2 - a<a name='963'>
             N2I_SET_MAX(cfield,nfield,i,j,k,ni,nj)<a name='964'>
          enddo<a name='965'>
       enddo iloop<a name='966'>
    enddo bigj<a name='967'>
  end subroutine n2c_max3d<a name='968'>
<a name='969'>
<A NAME='C2N_COPY3D'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='970'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2n_copy3d</font> (II,JJ,W1,W2,W3,W4,    &amp; <A href='../../call_to/C2N_COPY3D.html' TARGET='index'>2</A><a name='971'>
       cfield,nfield,imask,      &amp;<a name='972'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='973'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='974'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='975'>
       nits, nite, njts, njte, nkts, nkte,   &amp;<a name='976'>
       hgrid)<a name='977'>
    implicit none<a name='978'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='979'>
         W1,W2,W3,W4<a name='980'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='981'>
    logical, intent(in) :: hgrid<a name='982'>
    integer, intent(in):: cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='983'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='984'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='985'>
         nits, nite, njts, njte, nkts, nkte<a name='986'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='987'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme,ckms:ckme)<a name='988'>
    real, intent(out) :: nfield(nims:nime,njms:njme,nkms:nkme)<a name='989'>
<a name='990'>
    integer :: j,i,a,nx,nz,k<a name='991'>
<a name='992'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='993'>
    nz=nkde-nkds+1<a name='994'>
<a name='995'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='996'>
       interploop: do i=max(nids,nits),min(nide-1,nite)<a name='997'>
          if(imask(i,j)/=0) cycle interploop<a name='998'>
          kinterploop: do k=nkds,nkde<a name='999'>
             if(hgrid) then<a name='1000'>
                a=1-mod(JJ(i,j),2)<a name='1001'>
             else<a name='1002'>
                a=mod(JJ(i,j),2)<a name='1003'>
             endif<a name='1004'>
             nfield(i,j,k) = ICOPY(cfield,i,j,k)<a name='1005'>
          enddo kinterploop<a name='1006'>
       enddo interploop<a name='1007'>
    end do bigj<a name='1008'>
  end subroutine c2n_copy3d<a name='1009'>
<a name='1010'>
  <font color=#447700>! ********************************************************************<a name='1011'></font>
  <font color=#447700>! subs *_MASS -- horizontally and vertically interpolate.  Vertical<a name='1012'></font>
  <font color=#447700>! interpolation uses the iinfo and winfo arrays (and equivalent<a name='1013'></font>
  <font color=#447700>! boundary arrays) generated in the *_fulldom subroutines.<a name='1014'></font>
  <font color=#447700>! ********************************************************************<a name='1015'></font>
<a name='1016'>
<A NAME='C2B_MASS'><A href='../../html_code/share/module_interp_nmm.F.html#C2B_MASS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1017'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2b_mass</font> (II,JJ,W1,W2,W3,W4,cfield,         &amp; <A href='../../call_to/C2B_MASS.html' TARGET='index'>1</A>,<A href='../../call_from/C2B_MASS.html' TARGET='index'>1</A><a name='1018'>
       ibxs,ibxe,ibys,ibye,                  &amp;<a name='1019'>
       wbxs,wbxe,wbys,wbye,                  &amp;<a name='1020'>
       fbxs,fbxe,fbys,fbye,                  &amp;<a name='1021'>
       emethod,evalue,                       &amp;<a name='1022'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1023'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1024'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1025'>
       nits, nite, njts, njte, nkts, nkte)<a name='1026'>
    use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/module_interp_nmm.F.html#C2B_MASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_19">, only: kpres<a name='1027'>
    implicit none<a name='1028'>
    integer, parameter :: bdyw = 1<a name='1029'>
<a name='1030'>
    integer, intent(in):: &amp;<a name='1031'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1032'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1033'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1034'>
         nits, nite, njts, njte, nkts, nkte<a name='1035'>
<a name='1036'>
    integer, intent(in) :: emethod <font color=#447700>! extrapolation method<a name='1037'></font>
    real, intent(in) :: evalue<a name='1038'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='1039'>
         W1,W2,W3,W4<a name='1040'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='1041'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme,ckms:ckme)<a name='1042'>
<a name='1043'>
    <font color=#447700>! Output field boundary info:<a name='1044'></font>
    real,dimension(nims:nime,nkms:nkme,bdyw) :: fbys,fbye<a name='1045'>
    real,dimension(njms:njme,nkms:nkme,bdyw) :: fbxs,fbxe<a name='1046'>
<a name='1047'>
    <font color=#447700>! Weights and indices:<a name='1048'></font>
    real,dimension(nims:nime,nkms:nkme,bdyw) :: wbys,wbye<a name='1049'>
    real,dimension(njms:njme,nkms:nkme,bdyw) :: wbxs,wbxe<a name='1050'>
    integer,dimension(nims:nime,nkms:nkme,bdyw) :: ibys,ibye<a name='1051'>
    integer,dimension(njms:njme,nkms:nkme,bdyw) :: ibxs,ibxe<a name='1052'>
<a name='1053'>
    integer :: j,i,a,nx,nz,ck,k,j1,j2<a name='1054'>
    real :: weight<a name='1055'>
<a name='1056'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='1057'>
    nz=nkde-nkds+1<a name='1058'>
<a name='1059'>
    j1=max(njts-1,njds)<a name='1060'>
    if(mod(j1,2)/=1)   j1=j1+1<a name='1061'>
<a name='1062'>
    j2=min(njte+1,njde-1)<a name='1063'>
    if(mod(j2,2)/=1)   j2=j2-1<a name='1064'>
<a name='1065'>
    if(nits==1) then<a name='1066'>
       i=1<a name='1067'>
       do j=j1,j2,2<a name='1068'>
          a=1-mod(JJ(i,j),2)<a name='1069'>
          kcopy1: do k=min(nkde,nkte),kpres+1,-1<a name='1070'>
             fbxs(j,k,1) = ICOPY(cfield,i,j,k)<a name='1071'>
          enddo kcopy1<a name='1072'>
          kloop1: do k=kpres,nkds,-1<a name='1073'>
             weight=wbxs(j,k,1)<a name='1074'>
             ck=ibxs(j,k,1)<a name='1075'>
             <a name='1076'>
             if(ck&gt;1) then<a name='1077'>
                fbxs(j,k,1) = &amp;<a name='1078'>
                     ICOPY(cfield,i,j,ck)   * weight + &amp;<a name='1079'>
                     ICOPY(cfield,i,j,ck-1) * (1.0-weight)<a name='1080'>
             else<a name='1081'>
                <font color=#447700>! Extrapolate<a name='1082'></font>
                if(emethod==EConst) then<a name='1083'>
                   fbxs(j,k,1)=evalue<a name='1084'>
                else if(emethod==ECopy) then<a name='1085'>
                   fbxs(j,k,1)=ICOPY(cfield,i,j,1)<a name='1086'>
                else <font color=#447700>! assume 2: linear extrap<a name='1087'></font>
                   fbxs(j,k,1)=evalue * weight + &amp;<a name='1088'>
                               ICOPY(cfield,i,j,1) * (1.0-weight)<a name='1089'>
                endif<a name='1090'>
             endif<a name='1091'>
          enddo kloop1<a name='1092'>
       enddo<a name='1093'>
    endif<a name='1094'>
    if(nite&gt;=nide-1) then<a name='1095'>
       i=nide-1<a name='1096'>
       do j=j1,j2,2<a name='1097'>
          a=1-mod(JJ(i,j),2)<a name='1098'>
          kcopy2: do k=min(nkde,nkte),kpres+1,-1<a name='1099'>
             fbxe(j,k,1)=ICOPY(cfield,i,j,k)<a name='1100'>
          enddo kcopy2<a name='1101'>
          kloop2: do k=kpres,nkds,-1<a name='1102'>
             weight=wbxe(j,k,1)<a name='1103'>
             ck=ibxe(j,k,1)<a name='1104'>
<a name='1105'>
             if(ck&gt;1) then<a name='1106'>
                fbxe(j,k,1) = &amp;<a name='1107'>
                     ICOPY(cfield,i,j,ck)   * weight + &amp;<a name='1108'>
                     ICOPY(cfield,i,j,ck-1) * (1.0-weight)<a name='1109'>
             else<a name='1110'>
                <font color=#447700>! Extrapolate<a name='1111'></font>
                if(emethod==EConst) then<a name='1112'>
                   fbxe(j,k,1)=evalue<a name='1113'>
                else if(emethod==ECopy) then<a name='1114'>
                   fbxe(j,k,1)=ICOPY(cfield,i,j,1)<a name='1115'>
                else <font color=#447700>! assume 2: linear extrap<a name='1116'></font>
                   fbxe(j,k,1)=evalue * weight + &amp;<a name='1117'>
                        ICOPY(cfield,i,j,1) * (1.0-weight)<a name='1118'>
                endif<a name='1119'>
             endif<a name='1120'>
          enddo kloop2<a name='1121'>
       enddo<a name='1122'>
    endif<a name='1123'>
    if(njts==1) then<a name='1124'>
       j=1<a name='1125'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='1126'>
          a=1-mod(JJ(i,j),2)<a name='1127'>
          kcopy3: do k=min(nkde,nkte),kpres+1,-1<a name='1128'>
             fbys(i,k,1) = ICOPY(cfield,i,j,k)<a name='1129'>
          enddo kcopy3<a name='1130'>
          kloop3: do k=kpres,nkds,-1<a name='1131'>
             weight=wbys(i,k,1)<a name='1132'>
             ck=ibys(i,k,1)<a name='1133'>
<a name='1134'>
             if(ck&gt;1) then<a name='1135'>
                fbys(i,k,1) = &amp;<a name='1136'>
                     ICOPY(cfield,i,j,ck)   * weight + &amp;<a name='1137'>
                     ICOPY(cfield,i,j,ck-1) * (1.0-weight)<a name='1138'>
             else<a name='1139'>
                <font color=#447700>! Extrapolate<a name='1140'></font>
                if(emethod==EConst) then<a name='1141'>
                   fbys(i,k,1)=evalue<a name='1142'>
                else if(emethod==ECopy) then<a name='1143'>
                   fbys(i,k,1)=ICOPY(cfield,i,j,1)<a name='1144'>
                else <font color=#447700>! assume 2: linear extrap<a name='1145'></font>
                   fbys(i,k,1)=evalue*weight + &amp;<a name='1146'>
                        ICOPY(cfield,i,j,1)*(1.0-weight)<a name='1147'>
                endif<a name='1148'>
             endif<a name='1149'>
          enddo kloop3<a name='1150'>
       enddo<a name='1151'>
    endif<a name='1152'>
    if(njte&gt;=njde-1) then<a name='1153'>
       j=njde-1<a name='1154'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='1155'>
          a=1-mod(JJ(i,j),2)<a name='1156'>
          kcopy4: do k=min(nkde,nkte),kpres+1,-1<a name='1157'>
             fbye(i,k,1) = ICOPY(cfield,i,j,k)<a name='1158'>
          enddo kcopy4<a name='1159'>
          kloop4: do k=kpres,nkds,-1<a name='1160'>
             weight=wbye(i,k,1)<a name='1161'>
             ck=ibye(i,k,1)<a name='1162'>
<a name='1163'>
             if(ck&gt;1) then<a name='1164'>
                fbye(i,k,1) = &amp;<a name='1165'>
                     ICOPY(cfield,i,j,ck)   * weight + &amp;<a name='1166'>
                     ICOPY(cfield,i,j,ck-1) * (1.0-weight)<a name='1167'>
             else<a name='1168'>
                if(emethod==EConst) then<a name='1169'>
                   fbye(i,k,1)=evalue<a name='1170'>
                else if(emethod==ECopy) then<a name='1171'>
                   fbye(i,k,1)=ICOPY(cfield,i,j,1)<a name='1172'>
                else <font color=#447700>! assume 2: linear extrap<a name='1173'></font>
                   fbye(i,k,1)=evalue*weight + &amp;<a name='1174'>
                        ICOPY(cfield,i,j,1)*(1.0-weight)<a name='1175'>
                endif<a name='1176'>
             endif<a name='1177'>
          enddo kloop4<a name='1178'>
       enddo<a name='1179'>
    endif<a name='1180'>
<a name='1181'>
  end subroutine c2b_mass<a name='1182'>
<a name='1183'>
<A NAME='N2C_MASS'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_MASS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1184'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_mass</font> (&amp; <A href='../../call_to/N2C_MASS.html' TARGET='index'>1</A>,<A href='../../call_from/N2C_MASS.html' TARGET='index'>1</A><a name='1185'>
       cfield,nfield,iinfo,winfo,ipos,jpos,  &amp;<a name='1186'>
       emethod, evalue,                      &amp;<a name='1187'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='1188'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1189'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='1190'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1191'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1192'>
       nits, nite, njts, njte, nkts, nkte)<a name='1193'>
    use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/module_interp_nmm.F.html#N2C_MASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_20">, only: kpres<a name='1194'>
    implicit none<a name='1195'>
    integer, intent(in) :: &amp;<a name='1196'>
         cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='1197'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1198'>
         cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='1199'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1200'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1201'>
         nits, nite, njts, njte, nkts, nkte,   &amp;<a name='1202'>
         ipos,jpos, emethod<a name='1203'>
    real, intent(in) :: evalue<a name='1204'>
    real, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: winfo<a name='1205'>
    integer, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: iinfo<a name='1206'>
    real, intent(out) :: cfield(cims:cime,cjms:cjme,ckms:ckme)<a name='1207'>
    real, intent(in) :: nfield(nims:nime,njms:njme,nkms:nkme)<a name='1208'>
<a name='1209'>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='1210'></font>
    integer :: nz,jstart,jend,istart,iend,ni,nj,a,i,j,k,nk<a name='1211'>
    real :: weight<a name='1212'>
<a name='1213'>
    nz=nkde-nkds+1<a name='1214'>
<a name='1215'>
    jstart=MAX(jpos+1,cjts)<a name='1216'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='1217'>
<a name='1218'>
    kcopy: do k=ckde,kpres+1,-1<a name='1219'>
       jcopy: do j=jstart,jend<a name='1220'>
          a=mod(j,2)<a name='1221'>
          istart=MAX(ipos+a,cits)<a name='1222'>
          iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='1223'>
          nj = (j-jpos)*nrj + 1<a name='1224'>
          icopy: do i=istart,iend<a name='1225'>
             ni = (i-ipos)*nri + 2 - a<a name='1226'>
             cfield(i,j,k) = NGRAB(nfield,ni,nj,k)<a name='1227'>
          enddo icopy<a name='1228'>
       enddo jcopy<a name='1229'>
    enddo kcopy<a name='1230'>
<a name='1231'>
    bigj: do j=jstart,jend<a name='1232'>
          a=mod(j,2)<a name='1233'>
       istart=MAX(ipos+a,cits)<a name='1234'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='1235'>
       nj = (j-jpos)*nrj + 1<a name='1236'>
<a name='1237'>
       iloop: do i=istart,iend<a name='1238'>
          ni = (i-ipos)*nri + 2 - a<a name='1239'>
          kinterploop: do k=kpres,ckds,-1<a name='1240'>
             weight=winfo(i,j,k)<a name='1241'>
             nk=iinfo(i,j,k)<a name='1242'>
<a name='1243'>
             if(nk&gt;1) then<a name='1244'>
                cfield(i,j,k) = &amp;<a name='1245'>
                     NGRAB(nfield,ni,nj,nk)   * weight + &amp;<a name='1246'>
<font color=#447700>! pjj/cray - source line limit in Cray compiler<a name='1247'></font>
             NGRAB(nfield,ni,nj,nk-1) &amp;<a name='1248'>
             * (1.0-weight)<a name='1249'>
             else<a name='1250'>
                <font color=#447700>! Extrapolate<a name='1251'></font>
                if(emethod==EConst) then<a name='1252'>
                   cfield(i,j,k)=evalue<a name='1253'>
                elseif(emethod==ECopy) then<a name='1254'>
                   cfield(i,j,k)=NGRAB(nfield,ni,nj,1)<a name='1255'>
                else <font color=#447700>! Assume 2: linear extrap<a name='1256'></font>
                   cfield(i,j,k)=evalue*weight + &amp;<a name='1257'>
                        NGRAB(nfield,ni,nj,1)*(1.0-weight)<a name='1258'>
                endif<a name='1259'>
             endif<a name='1260'>
          end do kinterploop<a name='1261'>
       enddo iloop<a name='1262'>
    enddo bigj<a name='1263'>
  end subroutine n2c_mass<a name='1264'>
<a name='1265'>
<A NAME='N2C_MASSIKJ'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_MASSIKJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1266'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_massikj</font> (&amp; <A href='../../call_to/N2C_MASSIKJ.html' TARGET='index'>1</A>,<A href='../../call_from/N2C_MASSIKJ.html' TARGET='index'>1</A><a name='1267'>
       cfield,nfield,iinfo,winfo,ipos,jpos,  &amp;<a name='1268'>
       emethod, evalue,                      &amp;<a name='1269'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='1270'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1271'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='1272'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1273'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1274'>
       nits, nite, njts, njte, nkts, nkte)<a name='1275'>
    use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/module_interp_nmm.F.html#N2C_MASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_21">, only: kpres<a name='1276'>
    implicit none<a name='1277'>
    integer, intent(in) :: &amp;<a name='1278'>
         cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='1279'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1280'>
         cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='1281'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1282'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1283'>
         nits, nite, njts, njte, nkts, nkte,   &amp;<a name='1284'>
         ipos,jpos, emethod<a name='1285'>
    real, intent(in) :: evalue<a name='1286'>
    real, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: winfo<a name='1287'>
    integer, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: iinfo<a name='1288'>
    real, intent(out) :: cfield(cims:cime,ckms:ckme,cjms:cjme)<a name='1289'>
    real, intent(in) :: nfield(nims:nime,nkms:nkme,njms:njme)<a name='1290'>
<a name='1291'>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='1292'></font>
    integer :: nz,jstart,jend,istart,iend,ni,nj,a,i,j,k,nk<a name='1293'>
    real :: weight<a name='1294'>
<a name='1295'>
    nz=nkde-nkds+1<a name='1296'>
<a name='1297'>
    jstart=MAX(jpos+1,cjts)<a name='1298'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='1299'>
<a name='1300'>
    bigj: do j=jstart,jend<a name='1301'>
          a=mod(j,2)<a name='1302'>
       istart=MAX(ipos+a,cits)<a name='1303'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='1304'>
       nj = (j-jpos)*nrj + 1<a name='1305'>
<a name='1306'>
       kcopyloop: do k=nkde,kpres+1,-1<a name='1307'>
          icopyloop: do i=istart,iend<a name='1308'>
             ni = (i-ipos)*nri + 2 - a<a name='1309'>
             cfield(i,k,j) = NGRABIKJ(nfield,ni,k,nj)<a name='1310'>
          enddo icopyloop<a name='1311'>
       enddo kcopyloop<a name='1312'>
<a name='1313'>
       kinterploop: do k=kpres+1,nkds,-1<a name='1314'>
          iloop: do i=istart,iend<a name='1315'>
             ni = (i-ipos)*nri + 2 - a<a name='1316'>
             weight=winfo(i,j,k)<a name='1317'>
             nk=iinfo(i,j,k)<a name='1318'>
<a name='1319'>
             if(nk&gt;1) then<a name='1320'>
                cfield(i,k,j) = &amp;<a name='1321'>
                     NGRABIKJ(nfield,ni,nk,nj) * weight + &amp;<a name='1322'>
<font color=#447700>! pjj/cray - source line limit in Cray compiler<a name='1323'></font>
             NGRABIKJ(nfield,ni,nk-1,nj) &amp;<a name='1324'>
             * (1.0-weight)<a name='1325'>
             else<a name='1326'>
                <font color=#447700>! Extrapolate<a name='1327'></font>
                if(emethod==EConst) then<a name='1328'>
                   cfield(i,k,j)=evalue<a name='1329'>
                elseif(emethod==ECopy) then<a name='1330'>
                   cfield(i,k,j)=NGRABIKJ(nfield,ni,1,nj)<a name='1331'>
                else <font color=#447700>! Assume 2: linear extrap<a name='1332'></font>
                   cfield(i,k,j)=evalue*weight + &amp;<a name='1333'>
                        NGRABIKJ(nfield,ni,1,nj)*(1.0-weight)<a name='1334'>
                endif<a name='1335'>
             endif<a name='1336'>
          enddo iloop<a name='1337'>
       end do kinterploop<a name='1338'>
    enddo bigj<a name='1339'>
  end subroutine n2c_massikj<a name='1340'>
<a name='1341'>
<A NAME='C2N_MASS'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_MASS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1342'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2n_mass</font> (II,JJ,W1,W2,W3,W4,    &amp; <A href='../../call_to/C2N_MASS.html' TARGET='index'>1</A>,<A href='../../call_from/C2N_MASS.html' TARGET='index'>2</A><a name='1343'>
       cfield,nfield,iinfo,winfo,imask,      &amp;<a name='1344'>
       emethod, evalue,                      &amp;<a name='1345'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1346'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1347'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1348'>
       nits, nite, njts, njte, nkts, nkte)<a name='1349'>
    use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/module_interp_nmm.F.html#C2N_MASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_22">, only: kpres<a name='1350'>
    implicit none<a name='1351'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='1352'>
         W1,W2,W3,W4<a name='1353'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='1354'>
<a name='1355'>
    integer, intent(in):: cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1356'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1357'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1358'>
         nits, nite, njts, njte, nkts, nkte, emethod<a name='1359'>
    real, intent(in) :: evalue<a name='1360'>
    real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: winfo<a name='1361'>
    integer, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: iinfo<a name='1362'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='1363'>
    real, intent(in) :: cfield(cims:cime,cjms:cjme,ckms:ckme)<a name='1364'>
    real, intent(out) :: nfield(nims:nime,njms:njme,nkms:nkme)<a name='1365'>
    character*255 :: message<a name='1366'>
    integer :: j,i,a,nx,nz,ck,k<a name='1367'>
    real :: weight<a name='1368'>
<a name='1369'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='1370'>
    nz=nkde-nkds+1<a name='1371'>
    if(kpres&lt;=nkds .or. kpres&gt;=nkde) then<a name='1372'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#C2N_MASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1390">('invalid kpres: outside domain bounds')<a name='1373'>
    end if<a name='1374'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='1375'>
       interploop: do i=max(nids,nits),min(nide-1,nite)<a name='1376'>
          if(imask(i,j)/=0) cycle interploop<a name='1377'>
          a=1-mod(JJ(i,j),2)<a name='1378'>
          kcopyloop: do k=nkde,kpres+1,-1<a name='1379'>
             nfield(i,j,k)=ICOPY(cfield,i,j,k)<a name='1380'>
             <font color=#447700>!weight=winfo(i,j,k)<a name='1381'></font>
             ck=iinfo(i,j,k)<a name='1382'>
<font color=#447700>!              if(1.-weight&gt;1e-5) then<a name='1383'></font>
<font color=#447700>! 2000            format(I0,", ",I0,", ",I0,": invalid weight at constant pressure level: w=",F0.5," i=",I0)<a name='1384'></font>
<font color=#447700>!                 write(message,2000) i,j,k, weight,ck<a name='1385'></font>
<font color=#447700>!                 call wrf_error_fatal(message)<a name='1386'></font>
<font color=#447700>!              endif<a name='1387'></font>
<font color=#447700>!              if(ck/=k) then<a name='1388'></font>
<font color=#447700>! 2001            format(I0,", ",I0,", ",I0,": invalid iinfo at constant pressure level: w=",F0.5," i=",I0)<a name='1389'></font>
<font color=#447700>!                 write(message,2000) i,j,k, weight,ck<a name='1390'></font>
<font color=#447700>!                 call wrf_error_fatal(message)<a name='1391'></font>
<font color=#447700>!              endif<a name='1392'></font>
          enddo kcopyloop<a name='1393'>
          kinterploop: do k=kpres,nkds,-1<a name='1394'>
             weight=winfo(i,j,k)<a name='1395'>
             ck=iinfo(i,j,k)<a name='1396'>
<a name='1397'>
             if(ck&gt;1) then<a name='1398'>
                nfield(i,j,k) = &amp;<a name='1399'>
                     ICOPY(cfield,i,j,ck)   * weight + &amp;<a name='1400'>
                     ICOPY(cfield,i,j,ck-1) * (1.0-weight)<a name='1401'>
             else                <a name='1402'>
                <font color=#447700>! Extrapolate<a name='1403'></font>
                if(emethod==EConst) then<a name='1404'>
                   nfield(i,j,k)=evalue<a name='1405'>
                elseif(emethod==ECopy) then<a name='1406'>
                   nfield(i,j,k)=ICOPY(cfield,i,j,1)<a name='1407'>
                else <font color=#447700>! Assume 2: linear extrap<a name='1408'></font>
                   nfield(i,j,k)=evalue*weight + &amp;<a name='1409'>
                        ICOPY(cfield,i,j,1)*(1.0-weight)<a name='1410'>
                endif<a name='1411'>
             endif<a name='1412'>
          enddo kinterploop<a name='1413'>
       enddo interploop<a name='1414'>
    end do bigj<a name='1415'>
<a name='1416'>
  end subroutine c2n_mass<a name='1417'>
<a name='1418'>
<A NAME='C2N_MASSIKJ'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_MASSIKJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1419'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2n_massikj</font> (II,JJ,W1,W2,W3,W4, &amp; <A href='../../call_to/C2N_MASSIKJ.html' TARGET='index'>1</A>,<A href='../../call_from/C2N_MASSIKJ.html' TARGET='index'>1</A><a name='1420'>
       cfield,nfield,iinfo,winfo,imask,      &amp;<a name='1421'>
       emethod, evalue,                      &amp;<a name='1422'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1423'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1424'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1425'>
       nits, nite, njts, njte, nkts, nkte)<a name='1426'>
    use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/module_interp_nmm.F.html#C2N_MASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_23">, only: kpres<a name='1427'>
    implicit none<a name='1428'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='1429'>
         W1,W2,W3,W4<a name='1430'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='1431'>
<a name='1432'>
    integer, intent(in):: cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1433'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1434'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1435'>
         nits, nite, njts, njte, nkts, nkte, emethod<a name='1436'>
    real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: winfo<a name='1437'>
    integer, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: iinfo<a name='1438'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='1439'>
    real, intent(in) :: cfield(cims:cime,ckms:ckme,cjms:cjme)<a name='1440'>
    real, intent(out) :: nfield(nims:nime,nkms:nkme,njms:njme)<a name='1441'>
    real, intent(In) :: evalue<a name='1442'>
<a name='1443'>
    integer :: j,i,a,nx,nz,ck,k<a name='1444'>
    real :: weight<a name='1445'>
<a name='1446'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='1447'>
    nz=nkde-nkds+1<a name='1448'>
<a name='1449'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='1450'>
       interploop: do i=max(nids,nits),min(nide-1,nite)<a name='1451'>
          if(imask(i,j)/=0) cycle interploop<a name='1452'>
          a=1-mod(JJ(i,j),2)<a name='1453'>
          kcopyloop: do k=nkde,kpres+1,-1<a name='1454'>
             nfield(i,k,j)=IKJCOPY(cfield,i,k,j)<a name='1455'>
          end do kcopyloop<a name='1456'>
          kinterploop: do k=kpres,nkds,-1<a name='1457'>
             weight=winfo(i,j,k)<a name='1458'>
             ck=iinfo(i,j,k)<a name='1459'>
<a name='1460'>
             if(ck&gt;1) then<a name='1461'>
                nfield(i,k,j) = &amp;<a name='1462'>
                     IKJCOPY(cfield,i,ck,j)   * weight + &amp;<a name='1463'>
                     IKJCOPY(cfield,i,ck-1,j) * (1.0-weight)<a name='1464'>
             else<a name='1465'>
                <font color=#447700>! Extrapolate<a name='1466'></font>
                if(emethod==EConst) then<a name='1467'>
                   nfield(i,k,j)=evalue<a name='1468'>
                elseif(emethod==ECopy) then<a name='1469'>
                   nfield(i,k,j)=IKJCOPY(cfield,i,1,j)<a name='1470'>
                else <font color=#447700>! Assume 2: linear extrapolation<a name='1471'></font>
                   nfield(i,k,j)=evalue * weight + &amp;<a name='1472'>
                               IKJCOPY(cfield,i,1,j) * (1.0-weight)<a name='1473'>
                endif<a name='1474'>
             endif<a name='1475'>
          enddo kinterploop<a name='1476'>
       enddo interploop<a name='1477'>
    end do bigj<a name='1478'>
<a name='1479'>
  end subroutine c2n_massikj<a name='1480'>
<a name='1481'>
<A NAME='FIND_KPRES'><A href='../../html_code/share/module_interp_nmm.F.html#FIND_KPRES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1482'>
  <font color=#993300>subroutine </font><font color=#cc0000>find_kpres</font>(kpres, eta2, kds,kde, kms,kme) <A href='../../call_to/FIND_KPRES.html' TARGET='index'>3</A>,<A href='../../call_from/FIND_KPRES.html' TARGET='index'>1</A><a name='1483'>
    <font color=#447700>! Find the level at which the pressure/sigma transition occurs.<a name='1484'></font>
    <font color=#447700>! All levels above this are pure pressure levels, whereas kpres<a name='1485'></font>
    <font color=#447700>! and below are sigma.<a name='1486'></font>
    integer, intent(out) :: kpres<a name='1487'>
    real, intent(in) :: eta2(kms:kme)<a name='1488'>
    integer, intent(in) :: kds,kde, kms,kme<a name='1489'>
<a name='1490'>
    integer :: k<a name='1491'>
<a name='1492'>
    k=kde-1<a name='1493'>
    do while(eta2(k) &lt; 1e-5 .and. eta2(k-1) &lt; 1e-5)<a name='1494'>
       k=k-1<a name='1495'>
       if(k&lt;=kds) then<a name='1496'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#FIND_KPRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1391">('New NMM interpolation routines do not work in a constant pressure space.')<a name='1497'>
       endif<a name='1498'>
    enddo<a name='1499'>
    kpres=k<a name='1500'>
  end subroutine find_kpres<a name='1501'>
<a name='1502'>
  <font color=#447700>! ********************************************************************<a name='1503'></font>
  <font color=#447700>! subs *_FULLDOM -- recalculates PD and PINT based on FIS if<a name='1504'></font>
  <font color=#447700>! requested.  Also, generates vertical interpolation arrays for use<a name='1505'></font>
  <font color=#447700>! in later interpolations and interpolates T and Q while doing so.<a name='1506'></font>
  <font color=#447700>! ********************************************************************<a name='1507'></font>
<a name='1508'>
<A NAME='N2C_FULLDOM'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_FULLDOM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1509'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_fulldom</font>  (                  &amp;,<A href='../../call_from/N2C_FULLDOM.html' TARGET='index'>1</A><a name='1510'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='1511'>
       cfis,cpint,ct,cpd,cq,                 &amp;<a name='1512'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='1513'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1514'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='1515'>
       nfis,npint,nt,npd,nq,                 &amp;<a name='1516'>
       ipos,jpos,                            &amp;<a name='1517'>
<font color=#447700>!       nri,nrj                               &amp;<a name='1518'></font>
       out_iinfo,out_winfo,                  &amp;<a name='1519'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1520'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1521'>
       nits, nite, njts, njte, nkts, nkte, kpres)<a name='1522'>
<a name='1523'>
    implicit none<a name='1524'>
<a name='1525'>
    integer, intent(in) :: ipos,jpos<a name='1526'>
<font color=#447700>!    integer, intent(in) :: nri,nrj<a name='1527'></font>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='1528'></font>
<a name='1529'>
    integer, intent(in):: &amp;<a name='1530'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1531'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1532'>
         nits, nite, njts, njte, nkts, nkte,   kpres<a name='1533'>
    integer, intent(in):: &amp;<a name='1534'>
         cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='1535'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1536'>
         cits, cite, cjts, cjte, ckts, ckte<a name='1537'>
    real, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: cT,cQ,cPINT<a name='1538'>
    real, intent(inout), dimension(cims:cime,cjms:cjme,1) :: cPD,cFIS<a name='1539'>
<a name='1540'>
    real, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: out_winfo<a name='1541'>
    integer, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: out_iinfo<a name='1542'>
<a name='1543'>
    real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: nT,nQ<a name='1544'>
    real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: nPINT<a name='1545'>
    real, intent(in), dimension(nims:nime,njms:njme,1) :: nFIS<a name='1546'>
    real, intent(in), dimension(nims:nime,njms:njme,1) :: nPD<a name='1547'>
<a name='1548'>
    real, intent(in), dimension(nkms:nkme) :: eta1,eta2,deta1,deta2<a name='1549'>
    real, intent(in) :: ptop,pdtop<a name='1550'>
<a name='1551'>
    real, dimension(1,nite-nits+1) :: inFIS,inPD,icFIS,icPD<a name='1552'>
    real, dimension(nkde-1,nite-nits+1) :: inT0,inQ,icT,icQ, qinfo,winfo<a name='1553'>
    real, dimension(nkde,nite-nits+1) :: inPINT,icPINT<a name='1554'>
    integer, dimension(nkde-1,nite-nits+1) :: iinfo<a name='1555'>
    integer :: nx,nz,k,i,a,j, istart,iend,jstart,jend, ni,nj,jprint,itest,jtest<a name='1556'>
    character*255 :: message<a name='1557'>
    logical bad, warned<a name='1558'>
<a name='1559'>
    warned=.false. <font color=#447700>! allow one P&gt;PSTD message<a name='1560'></font>
<a name='1561'>
    nx=min(cide-2,cite)-max(cids+1,cits)+1<a name='1562'>
    nz=ckde-ckds+1<a name='1563'>
<a name='1564'>
    jstart=MAX(jpos+1,cjts)<a name='1565'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='1566'>
<a name='1567'>
    bigj: do j=jstart,jend<a name='1568'>
       nj = (j-jpos)*nrj + 1<a name='1569'>
<a name='1570'>
       a=mod(j,2)<a name='1571'>
       istart=MAX(ipos+a,cits)<a name='1572'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='1573'>
       nx=iend-istart+1<a name='1574'>
<a name='1575'>
       <font color=#447700>! STEP 1: Copy coarse and fine nest data into <a name='1576'></font>
       <font color=#447700>! temporary arrays, reordering dimensions:<a name='1577'></font>
       qtloop: do k=ckts,ckte-1<a name='1578'>
          do i=istart,iend<a name='1579'>
             ni = (i-ipos)*nri + 2 - a<a name='1580'>
<a name='1581'>
             UPCOPY(inT0,nT,i,j,k,ni,nj)<a name='1582'>
             UPCOPY(inQ,nQ,i,j,k,ni,nj)<a name='1583'>
             UPCOPY(inPINT,nPINT,i,j,k,ni,nj)<a name='1584'>
          enddo<a name='1585'>
       enddo qtloop<a name='1586'>
<a name='1587'>
       k=nkte<a name='1588'>
       loop2d: do i=istart,iend<a name='1589'>
          ni = (i-ipos)*nri + 2 - a<a name='1590'>
<a name='1591'>
          UPCOPY(inPINT,nPINT,i,j,k,ni,nj)<a name='1592'>
          UPCOPY(inPD,nPD,i,j,1,ni,nj)<a name='1593'>
          UPCOPY(inFIS,nFIS,i,j,1,ni,nj)<a name='1594'>
<a name='1595'>
          icPD(1,i-istart+1)=cPD(i,j,1)<a name='1596'>
<font color=#447700>!          icPD(1,i-istart+1)=use_this_pd(i,j,1)<a name='1597'></font>
          icFIS(1,i-istart+1)=cFIS(i,j,1)<a name='1598'>
       enddo loop2d<a name='1599'>
<a name='1600'>
       <font color=#447700>! Step 2: Interpolate coarse grid to fine grid in reordered<a name='1601'></font>
       <font color=#447700>! arrays:<a name='1602'></font>
       call <A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q'>interp_T_PD_Q</A><A href='../../html_code/share/module_interp_nmm.F.html#N2C_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_T_PD_Q_1">(nmm_method_linear, nmm_keep_pd, nx,nz, &amp;<a name='1603'>
            deta1,deta2,eta1,eta2,ptop,pdtop, kpres, &amp;<a name='1604'>
            inFIS,icFIS, inPINT,icPINT, inT0, icT, inPD,icPD, inQ,icQ, &amp;<a name='1605'>
            iinfo, winfo, warned)<a name='1606'>
<a name='1607'>
       <font color=#447700>! Step 3: Copy back from reordered arrays to final nest arrays:<a name='1608'></font>
<a name='1609'>
       qtloop2: do k=ckts,max(ckte-1,ckde-1)<a name='1610'>
          do i=istart,iend<a name='1611'>
             cT(i,j,k)=icT(k,i-istart+1)<a name='1612'>
             cQ(i,j,k)=icQ(k,i-istart+1)<a name='1613'>
          enddo<a name='1614'>
       enddo qtloop2<a name='1615'>
<a name='1616'>
       izloop: do k=ckts,max(ckte-1,ckde-1)<a name='1617'>
          ixloop: do i=istart,iend<a name='1618'>
             out_iinfo(i,j,k)=iinfo(k,i-istart+1)<a name='1619'>
             out_winfo(i,j,k)=winfo(k,i-istart+1)<a name='1620'>
          enddo ixloop<a name='1621'>
       enddo izloop<a name='1622'>
<a name='1623'>
       iendloop: do i=istart,iend<a name='1624'>
          out_iinfo(i,j,nkde)=nkde<a name='1625'>
          out_winfo(i,j,nkde)=1.0<a name='1626'>
       end do iendloop<a name='1627'>
<a name='1628'>
       k=nkte+1<a name='1629'>
       loop2d2: do i=istart,iend<a name='1630'>
          cPD(i,j,1)=icPD(1,i-istart+1)<a name='1631'>
       enddo loop2d2<a name='1632'>
    end do bigj<a name='1633'>
  end subroutine n2c_fulldom<a name='1634'>
<a name='1635'>
<A NAME='N2C_FULLDOM_NEW'><A href='../../html_code/share/module_interp_nmm.F.html#N2C_FULLDOM_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1636'>
  <font color=#993300>subroutine </font><font color=#cc0000>n2c_fulldom_new</font> (               &amp; <A href='../../call_to/N2C_FULLDOM_NEW.html' TARGET='index'>1</A>,<A href='../../call_from/N2C_FULLDOM_NEW.html' TARGET='index'>1</A><a name='1637'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='1638'>
       cfis,cpint,ct,cpd,cq,                 &amp;<a name='1639'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='1640'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1641'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='1642'>
       nfis,npint,nt,npd,nq,                 &amp;<a name='1643'>
       ipos,jpos,                            &amp;<a name='1644'>
<font color=#447700>!       nri,nrj                               &amp;<a name='1645'></font>
       out_iinfo,out_winfo,                  &amp;<a name='1646'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1647'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1648'>
       nits, nite, njts, njte, nkts, nkte, kpres)<a name='1649'>
<a name='1650'>
    implicit none<a name='1651'>
<a name='1652'>
    integer, intent(in) :: ipos,jpos<a name='1653'>
<font color=#447700>!    integer, intent(in) :: nri,nrj<a name='1654'></font>
    integer, parameter :: nri=3, nrj=3 <font color=#447700>! parent:nest ratio, must be 3 in NMM<a name='1655'></font>
<a name='1656'>
    integer, intent(in):: &amp;<a name='1657'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1658'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1659'>
         nits, nite, njts, njte, nkts, nkte,   kpres<a name='1660'>
    integer, intent(in):: &amp;<a name='1661'>
         cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='1662'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1663'>
         cits, cite, cjts, cjte, ckts, ckte<a name='1664'>
    real, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: cT,cQ,cPINT<a name='1665'>
    real, intent(inout), dimension(cims:cime,cjms:cjme,1) :: cPD,cFIS<a name='1666'>
<a name='1667'>
    real, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: out_winfo<a name='1668'>
    integer, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: out_iinfo<a name='1669'>
<a name='1670'>
    real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: nT,nQ<a name='1671'>
    real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: nPINT<a name='1672'>
    real, intent(in), dimension(nims:nime,njms:njme,1) :: nFIS<a name='1673'>
    real, intent(in), dimension(nims:nime,njms:njme,1) :: nPD<a name='1674'>
<a name='1675'>
    real, intent(in), dimension(nkms:nkme) :: eta1,eta2,deta1,deta2<a name='1676'>
    real, intent(in) :: ptop,pdtop<a name='1677'>
<a name='1678'>
    real, dimension(1,nite-nits+1) :: inFIS,inPD,icFIS,icPD<a name='1679'>
    real, dimension(kpres+1,nite-nits+1) :: inT0,inQ,icT,icQ, qinfo,winfo<a name='1680'>
    real, dimension(kpres+2,nite-nits+1) :: inPINT,icPINT<a name='1681'>
    integer, dimension(kpres+1,nite-nits+1) :: iinfo<a name='1682'>
    integer :: nx,nz,k,i,a,j, istart,iend,jstart,jend, ni,nj,jprint,itest,jtest<a name='1683'>
    character*255 :: message<a name='1684'>
    logical bad, warned<a name='1685'>
<a name='1686'>
    warned=.false. <font color=#447700>! Allow one P&gt;PSTD message<a name='1687'></font>
<a name='1688'>
    nx=min(cide-2,cite)-max(cids+1,cits)+1<a name='1689'>
    nz=ckde-ckds+1<a name='1690'>
<a name='1691'>
    jstart=MAX(jpos+1,cjts)<a name='1692'>
    jend=MIN(jpos+(njde-njds)/nrj-1,cjte)<a name='1693'>
<a name='1694'>
    bigj: do j=jstart,jend<a name='1695'>
       nj = (j-jpos)*nrj + 1<a name='1696'>
<a name='1697'>
       a=mod(j,2)<a name='1698'>
       istart=MAX(ipos+a,cits)<a name='1699'>
       iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='1700'>
       nx=iend-istart+1<a name='1701'>
<a name='1702'>
       <font color=#447700>! STEP 1: Copy coarse and fine nest data into <a name='1703'></font>
       <font color=#447700>! temporary arrays, reordering dimensions:<a name='1704'></font>
       qtloop: do k=ckts,kpres+1<a name='1705'>
          do i=istart,iend<a name='1706'>
             ni = (i-ipos)*nri + 2 - a<a name='1707'>
<a name='1708'>
             UPCOPY(inT0,nT,i,j,k,ni,nj)<a name='1709'>
             UPCOPY(inQ,nQ,i,j,k,ni,nj)<a name='1710'>
             UPCOPY(inPINT,nPINT,i,j,k,ni,nj)<a name='1711'>
          enddo<a name='1712'>
       enddo qtloop<a name='1713'>
<a name='1714'>
       k=kpres+1<a name='1715'>
       loop2d: do i=istart,iend<a name='1716'>
          ni = (i-ipos)*nri + 2 - a<a name='1717'>
<a name='1718'>
          UPCOPY(inPINT,nPINT,i,j,k,ni,nj)<a name='1719'>
          UPCOPY(inPD,nPD,i,j,1,ni,nj)<a name='1720'>
          UPCOPY(inFIS,nFIS,i,j,1,ni,nj)<a name='1721'>
<a name='1722'>
          icPD(1,i-istart+1)=cPD(i,j,1)<a name='1723'>
<font color=#447700>!          icPD(1,i-istart+1)=use_this_pd(i,j,1)<a name='1724'></font>
          icFIS(1,i-istart+1)=cFIS(i,j,1)<a name='1725'>
       enddo loop2d<a name='1726'>
<a name='1727'>
       <font color=#447700>! Step 2: Interpolate coarse grid to fine grid in reordered<a name='1728'></font>
       <font color=#447700>! arrays:<a name='1729'></font>
       call <A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES'>interp_T_PD_Q_kpres</A><A href='../../html_code/share/module_interp_nmm.F.html#N2C_FULLDOM_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_T_PD_Q_KPRES_1">(nmm_method_linear, nmm_keep_pd, nx,nz, &amp;<a name='1730'>
            deta1,deta2,eta1,eta2,ptop,pdtop, kpres, kpres+2, &amp;<a name='1731'>
            inFIS,icFIS, inPINT,icPINT, inT0, icT, inPD,icPD, inQ,icQ, &amp;<a name='1732'>
            iinfo, winfo, warned)<a name='1733'>
<a name='1734'>
       <font color=#447700>! Step 3: Copy back from reordered arrays to final nest arrays:<a name='1735'></font>
<a name='1736'>
       qtloop2: do k=ckts,kpres+1<a name='1737'>
          do i=istart,iend<a name='1738'>
             cT(i,j,k)=icT(k,i-istart+1)<a name='1739'>
             cQ(i,j,k)=icQ(k,i-istart+1)<a name='1740'>
          enddo<a name='1741'>
       enddo qtloop2<a name='1742'>
<a name='1743'>
       izloop: do k=ckts,kpres+1<a name='1744'>
          ixloop: do i=istart,iend<a name='1745'>
             out_iinfo(i,j,k)=iinfo(k,i-istart+1)<a name='1746'>
             out_winfo(i,j,k)=winfo(k,i-istart+1)<a name='1747'>
          enddo ixloop<a name='1748'>
       enddo izloop<a name='1749'>
<a name='1750'>
       k=nkte+1<a name='1751'>
       loop2d2: do i=istart,iend<a name='1752'>
          cPD(i,j,1)=icPD(1,i-istart+1)<a name='1753'>
       enddo loop2d2<a name='1754'>
    end do bigj<a name='1755'>
<a name='1756'>
    kcopy: do k=kpres+1,ckde-1<a name='1757'>
       jcopy: do j=jstart,jend<a name='1758'>
          nj = (j-jpos)*nrj + 1<a name='1759'>
          <a name='1760'>
          a=mod(j,2)<a name='1761'>
          istart=MAX(ipos+a,cits)<a name='1762'>
          iend=MIN(ipos+(nide-nids)/nri-1,cite)<a name='1763'>
          icopy: do i=istart,iend<a name='1764'>
             ni = (i-ipos)*nri + 2 - a<a name='1765'>
             cT(i,j,k)=NGRAB(nT,ni,nj,k)<a name='1766'>
             cQ(i,j,k)=NGRAB(nQ,ni,nj,k)<a name='1767'>
             out_iinfo(i,j,k)=k<a name='1768'>
             out_winfo(i,j,k)=1.0<a name='1769'>
          enddo icopy<a name='1770'>
          if(k==ckde-1) then<a name='1771'>
             icopy2: do i=istart,iend<a name='1772'>
                out_iinfo(i,j,nkde)=nkde<a name='1773'>
                out_winfo(i,j,nkde)=1.0<a name='1774'>
             enddo icopy2<a name='1775'>
          endif<a name='1776'>
       end do jcopy<a name='1777'>
    end do kcopy<a name='1778'>
  end subroutine n2c_fulldom_new<a name='1779'>
<a name='1780'>
<A NAME='C2B_FULLDOM'><A href='../../html_code/share/module_interp_nmm.F.html#C2B_FULLDOM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1781'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2b_fulldom</font>  (II,JJ,W1,W2,W3,W4,&amp;,<A href='../../call_from/C2B_FULLDOM.html' TARGET='index'>2</A><a name='1782'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='1783'>
       cfis,cpint,ct,cpd,cq,    nfis,        &amp;<a name='1784'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1785'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1786'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1787'>
       nits, nite, njts, njte, nkts, nkte,   &amp;<a name='1788'>
       kpres,                                &amp;<a name='1789'>
       ibxs,    ibxe,    ibys,    ibye,      &amp;<a name='1790'>
       wbxs,    wbxe,    wbys,    wbye,      &amp;<a name='1791'>
       pdbxs,   pdbxe,   pdbys,   pdbye,     &amp;<a name='1792'>
       tbxs,    tbxe,    tbys,    tbye,      &amp;<a name='1793'>
       qbxs,    qbxe,    qbys,    qbye)<a name='1794'>
    implicit none<a name='1795'>
    integer, intent(in):: &amp;<a name='1796'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1797'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='1798'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='1799'>
         nits, nite, njts, njte, nkts, nkte<a name='1800'>
<a name='1801'>
    integer, parameter :: bdyw=1<a name='1802'>
<a name='1803'>
    <font color=#447700>! Domain info:<a name='1804'></font>
    real, intent(in), dimension(nims:nime,njms:njme) :: W1,W2,W3,W4<a name='1805'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='1806'>
    real, intent(in), dimension(nkms:nkme) :: eta1,eta2,deta1,deta2<a name='1807'>
    real, intent(in) :: ptop,pdtop<a name='1808'>
    integer, intent(in) :: kpres<a name='1809'>
<a name='1810'>
    <font color=#447700>! Parent fields:<a name='1811'></font>
    real, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: cT,cQ,cPINT<a name='1812'>
    real, intent(in), dimension(cims:cime,cjms:cjme,1) :: cPD,cFIS<a name='1813'>
<a name='1814'>
    <font color=#447700>! Nest terrain info:<a name='1815'></font>
    real, intent(in), dimension(nims:nime,njms:njme,1) :: nFIS<a name='1816'>
<a name='1817'>
    <font color=#447700>! T, Q, PINT, PD boundary info:<a name='1818'></font>
    real,dimension(nims:nime,nkms:nkme,bdyw) :: tbys,tbye,qbys,qbye<a name='1819'>
    real,dimension(njms:njme,nkms:nkme,bdyw) :: tbxs,tbxe,qbxs,qbxe<a name='1820'>
    real,dimension(nims:nime,1,bdyw) :: pdbys,pdbye<a name='1821'>
    real,dimension(njms:njme,1,bdyw) :: pdbxs,pdbxe<a name='1822'>
<a name='1823'>
    <font color=#447700>! Weights and indices:<a name='1824'></font>
    real,dimension(nims:nime,nkms:nkme,bdyw) :: wbys,wbye<a name='1825'>
    real,dimension(njms:njme,nkms:nkme,bdyw) :: wbxs,wbxe<a name='1826'>
    integer,dimension(nims:nime,nkms:nkme,bdyw) :: ibys,ibye<a name='1827'>
    integer,dimension(njms:njme,nkms:nkme,bdyw) :: ibxs,ibxe<a name='1828'>
<a name='1829'>
    integer :: i,j,k,a,b,nx,nz,used,j1,j2,used1<a name='1830'>
<a name='1831'>
    real, dimension(1,2*(nite-nits+5)+2*(njte-njts+5)) :: inFIS,inPD,icFIS,icPD<a name='1832'>
    real, dimension(nkde-1,2*(nite-nits+5)+2*(njte-njts+5)) :: inT,inQ,icT,icQ,winfo<a name='1833'>
    integer, dimension(nkde-1,2*(nite-nits+5)+2*(njte-njts+5)) :: iinfo<a name='1834'>
    real, dimension(nkde,2*(nite-nits+5)+2*(njte-njts+5)) :: inPINT,icPINT<a name='1835'>
    logical :: warned<a name='1836'>
<a name='1837'>
    warned=.false. <font color=#447700>! Allow one P&gt;PSTD message<a name='1838'></font>
<a name='1839'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='1840'>
    nz=nkde-nkds+1<a name='1841'>
<a name='1842'>
    j1=max(njts-1,njds)<a name='1843'>
    if(mod(j1,2)/=1)   j1=j1+1<a name='1844'>
<a name='1845'>
    j2=min(njte+1,njde-1)<a name='1846'>
    if(mod(j2,2)/=1)   j2=j2-1<a name='1847'>
<a name='1848'>
    used=0<a name='1849'>
    bdyloop: do b=1,4<a name='1850'>
       if_xbdy: if(b==1 .or. b==2) then<a name='1851'>
          if(b==1) then<a name='1852'>
             if(nits/=1) cycle bdyloop<a name='1853'>
             i=1<a name='1854'>
          endif<a name='1855'>
          if(b==2) then<a name='1856'>
             if(nite&lt;nide-1) cycle bdyloop<a name='1857'>
             i=nide-1<a name='1858'>
          endif<a name='1859'>
          do j=j1,j2,2<a name='1860'>
             a=1-mod(JJ(i,j),2)<a name='1861'>
             used=used+1<a name='1862'>
             do k=nkts,nkte-1<a name='1863'>
                uFCOPY(icT,cT,i,j,k)<a name='1864'>
                uFCOPY(icQ,cQ,i,j,k)<a name='1865'>
                uFCOPY(icPINT,cPINT,i,j,k)<a name='1866'>
             enddo<a name='1867'>
                <a name='1868'>
             k=nkte<a name='1869'>
             a=1-mod(JJ(i,j),2)<a name='1870'>
<a name='1871'>
             uFCOPY(icPINT,cPINT,i,j,k)<a name='1872'>
             uFCOPY(icPD,cPD,i,j,1)<a name='1873'>
             uFCOPY(icFIS,cFIS,i,j,1)<a name='1874'>
<a name='1875'>
             inFIS(1,used)=nFIS(i,j,1)<a name='1876'>
<a name='1877'>
          enddo<a name='1878'>
       endif if_xbdy<a name='1879'>
       if_ybdy: if(b==3 .or. b==4) then<a name='1880'>
          if(b==3) then<a name='1881'>
             if(njts/=1) cycle bdyloop<a name='1882'>
             j=1<a name='1883'>
          endif<a name='1884'>
          if(b==4) then<a name='1885'>
             if(njte&lt;njde-1) cycle bdyloop<a name='1886'>
             j=njde-1<a name='1887'>
          endif<a name='1888'>
          do i=max(nits-1,nids),min(nite+1,nide-1)<a name='1889'>
             used=used+1<a name='1890'>
             do k=nkts,nkte-1<a name='1891'>
                a=1-mod(JJ(i,j),2)<a name='1892'>
                uFCOPY(icT,cT,i,j,k)<a name='1893'>
                uFCOPY(icQ,cQ,i,j,k)<a name='1894'>
                uFCOPY(icPINT,cPINT,i,j,k)<a name='1895'>
             enddo<a name='1896'>
                <a name='1897'>
             k=nkte<a name='1898'>
             a=1-mod(JJ(i,j),2)<a name='1899'>
<a name='1900'>
             uFCOPY(icPINT,cPINT,i,j,k)<a name='1901'>
             uFCOPY(icPD,cPD,i,j,1)<a name='1902'>
             uFCOPY(icFIS,cFIS,i,j,1)<a name='1903'>
<a name='1904'>
             inFIS(1,used)=nFIS(i,j,1)<a name='1905'>
          enddo<a name='1906'>
       endif if_ybdy<a name='1907'>
    enddo bdyloop<a name='1908'>
<a name='1909'>
    if(used==0) then<a name='1910'>
       <font color=#447700>! No boundary points on this tile so we are done<a name='1911'></font>
       return<a name='1912'>
    endif<a name='1913'>
<a name='1914'>
    call <A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES'>interp_T_PD_Q_kpres</A><A href='../../html_code/share/module_interp_nmm.F.html#C2B_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_T_PD_Q_KPRES_2">(nmm_method_linear, nmm_interp_pd, used,nz, &amp;<a name='1915'>
         deta1,deta2,eta1,eta2,ptop,pdtop, kpres, nz, &amp;<a name='1916'>
         icFIS,inFIS, icPINT,inPINT, icT, inT, icPD,inPD, icQ,inQ, &amp;<a name='1917'>
         iinfo, winfo, warned)<a name='1918'>
<a name='1919'>
    used1=used<a name='1920'>
    used=0<a name='1921'>
<a name='1922'>
    if_bxs: if(nits==1) then<a name='1923'>
       i=1<a name='1924'>
       do j=j1,j2,2<a name='1925'>
          used=used+1<a name='1926'>
          do k=nkts,nkte-1<a name='1927'>
             tbxs(j,k,1)=inT(k,used)<a name='1928'>
             qbxs(j,k,1)=inQ(k,used)<a name='1929'>
             ibxs(j,k,1)=iinfo(k,used)<a name='1930'>
             wbxs(j,k,1)=winfo(k,used)<a name='1931'>
          enddo<a name='1932'>
          ibxs(j,nkde,1)=nkde<a name='1933'>
          wbxs(j,nkde,1)=1.0<a name='1934'>
          pdbxs(j,1,1)=inPD(1,used)<a name='1935'>
       enddo<a name='1936'>
    endif if_bxs<a name='1937'>
<a name='1938'>
    if_bxe: if(nite&gt;=nide-1) then<a name='1939'>
       i=nide-1<a name='1940'>
       do j=j1,j2,2<a name='1941'>
          used=used+1<a name='1942'>
          do k=nkts,nkte-1<a name='1943'>
             tbxe(j,k,1)=inT(k,used)<a name='1944'>
             qbxe(j,k,1)=inQ(k,used)<a name='1945'>
             ibxe(j,k,1)=iinfo(k,used)<a name='1946'>
             wbxe(j,k,1)=winfo(k,used)<a name='1947'>
          enddo<a name='1948'>
          ibxe(j,nkde,1)=nkde<a name='1949'>
          wbxe(j,nkde,1)=1.0<a name='1950'>
          pdbxe(j,1,1)=inPD(1,used)<a name='1951'>
       enddo<a name='1952'>
    endif if_bxe<a name='1953'>
<a name='1954'>
    if_bys: if(njts==1) then<a name='1955'>
       j=1<a name='1956'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='1957'>
          used=used+1<a name='1958'>
          do k=nkts,nkte-1<a name='1959'>
             tbys(i,k,1)=inT(k,used)<a name='1960'>
             qbys(i,k,1)=inQ(k,used)<a name='1961'>
             ibys(i,k,1)=iinfo(k,used)<a name='1962'>
             wbys(i,k,1)=winfo(k,used)<a name='1963'>
          enddo<a name='1964'>
          ibys(i,nkde,1)=nkde<a name='1965'>
          wbys(i,nkde,1)=1.0<a name='1966'>
          pdbys(i,1,1)=inPD(1,used)<a name='1967'>
       enddo<a name='1968'>
    endif if_bys<a name='1969'>
<a name='1970'>
    if_bye: if(njte&gt;=njde-1) then<a name='1971'>
       j=njde-1<a name='1972'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='1973'>
          used=used+1<a name='1974'>
          do k=nkts,nkte-1<a name='1975'>
             tbye(i,k,1)=inT(k,used)<a name='1976'>
             qbye(i,k,1)=inQ(k,used)<a name='1977'>
             ibye(i,k,1)=iinfo(k,used)<a name='1978'>
             wbye(i,k,1)=winfo(k,used)<a name='1979'>
          enddo<a name='1980'>
          ibye(i,nkde,1)=nkde<a name='1981'>
          wbye(i,nkde,1)=1.0<a name='1982'>
          pdbye(i,1,1)=inPD(1,used)<a name='1983'>
       enddo<a name='1984'>
    endif if_bye<a name='1985'>
<a name='1986'>
    if(used/=used1) then<a name='1987'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#C2B_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1392">('Number of input and output points does not match.')<a name='1988'>
    endif<a name='1989'>
<a name='1990'>
  end subroutine c2b_fulldom<a name='1991'>
<a name='1992'>
  <font color=#447700>! ####################################################################<a name='1993'></font>
<a name='1994'>
<A NAME='C2B_FULLDOM_NEW'><A href='../../html_code/share/module_interp_nmm.F.html#C2B_FULLDOM_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1995'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2b_fulldom_new</font>  (II,JJ,W1,W2,W3,W4,&amp; <A href='../../call_to/C2B_FULLDOM_NEW.html' TARGET='index'>1</A>,<A href='../../call_from/C2B_FULLDOM_NEW.html' TARGET='index'>2</A><a name='1996'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='1997'>
       cfis,cpint,ct,cpd,cq,    nfis,        &amp;<a name='1998'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='1999'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='2000'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='2001'>
       nits, nite, njts, njte, nkts, nkte,   &amp;<a name='2002'>
       kpres,                                &amp;<a name='2003'>
       ibxs,    ibxe,    ibys,    ibye,      &amp;<a name='2004'>
       wbxs,    wbxe,    wbys,    wbye,      &amp;<a name='2005'>
       pdbxs,   pdbxe,   pdbys,   pdbye,     &amp;<a name='2006'>
       tbxs,    tbxe,    tbys,    tbye,      &amp;<a name='2007'>
       qbxs,    qbxe,    qbys,    qbye)<a name='2008'>
    implicit none<a name='2009'>
    integer, intent(in):: &amp;<a name='2010'>
         cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='2011'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='2012'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='2013'>
         nits, nite, njts, njte, nkts, nkte<a name='2014'>
<a name='2015'>
    integer, parameter :: bdyw=1<a name='2016'>
<a name='2017'>
    <font color=#447700>! Domain info:<a name='2018'></font>
    real, intent(in), dimension(nims:nime,njms:njme) :: W1,W2,W3,W4<a name='2019'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='2020'>
    real, intent(in), dimension(nkms:nkme) :: eta1,eta2,deta1,deta2<a name='2021'>
    real, intent(in) :: ptop,pdtop<a name='2022'>
    integer, intent(in) :: kpres<a name='2023'>
<a name='2024'>
    <font color=#447700>! Parent fields:<a name='2025'></font>
    real, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: cT,cQ,cPINT<a name='2026'>
    real, intent(in), dimension(cims:cime,cjms:cjme,1) :: cPD,cFIS<a name='2027'>
<a name='2028'>
    <font color=#447700>! Nest terrain info:<a name='2029'></font>
    real, intent(in), dimension(nims:nime,njms:njme,1) :: nFIS<a name='2030'>
<a name='2031'>
    <font color=#447700>! T, Q, PINT, PD boundary info:<a name='2032'></font>
    real,dimension(nims:nime,nkms:nkme,bdyw) :: tbys,tbye,qbys,qbye<a name='2033'>
    real,dimension(njms:njme,nkms:nkme,bdyw) :: tbxs,tbxe,qbxs,qbxe<a name='2034'>
    real,dimension(nims:nime,1,bdyw) :: pdbys,pdbye<a name='2035'>
    real,dimension(njms:njme,1,bdyw) :: pdbxs,pdbxe<a name='2036'>
<a name='2037'>
    <font color=#447700>! Weights and indices:<a name='2038'></font>
    real,dimension(nims:nime,nkms:nkme,bdyw) :: wbys,wbye<a name='2039'>
    real,dimension(njms:njme,nkms:nkme,bdyw) :: wbxs,wbxe<a name='2040'>
    integer,dimension(nims:nime,nkms:nkme,bdyw) :: ibys,ibye<a name='2041'>
    integer,dimension(njms:njme,nkms:nkme,bdyw) :: ibxs,ibxe<a name='2042'>
<a name='2043'>
    integer :: i,j,k,a,b,nx,nz,used,j1,j2,used1<a name='2044'>
<a name='2045'>
    real, dimension(1,2*(nite-nits+5)+2*(njte-njts+5)) :: inFIS,inPD,icFIS,icPD<a name='2046'>
    real, dimension(kpres+1,2*(nite-nits+5)+2*(njte-njts+5)) :: inT,inQ,icT,icQ,winfo<a name='2047'>
    integer, dimension(kpres+1,2*(nite-nits+5)+2*(njte-njts+5)) :: iinfo<a name='2048'>
    real, dimension(kpres+2,2*(nite-nits+5)+2*(njte-njts+5)) :: inPINT,icPINT<a name='2049'>
    logical :: warned<a name='2050'>
<a name='2051'>
    warned=.false. <font color=#447700>! Allow one P&gt;PSTD message<a name='2052'></font>
<a name='2053'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='2054'>
    nz=nkde-nkds+1<a name='2055'>
<a name='2056'>
    j1=max(njts-1,njds)<a name='2057'>
    if(mod(j1,2)/=1)   j1=j1+1<a name='2058'>
<a name='2059'>
    j2=min(njte+1,njde-1)<a name='2060'>
    if(mod(j2,2)/=1)   j2=j2-1<a name='2061'>
<a name='2062'>
    used=0<a name='2063'>
    bdyloop: do b=1,4<a name='2064'>
       if_xbdy: if(b==1 .or. b==2) then<a name='2065'>
          if(b==1) then<a name='2066'>
             if(nits/=1) cycle bdyloop<a name='2067'>
             i=1<a name='2068'>
          endif<a name='2069'>
          if(b==2) then<a name='2070'>
             if(nite&lt;nide-1) cycle bdyloop<a name='2071'>
             i=nide-1<a name='2072'>
          endif<a name='2073'>
          do j=j1,j2,2<a name='2074'>
             used=used+1<a name='2075'>
             do k=nkts,kpres+1<a name='2076'>
                a=1-mod(JJ(i,j),2)<a name='2077'>
                uFCOPY(icT,cT,i,j,k)<a name='2078'>
                uFCOPY(icQ,cQ,i,j,k)<a name='2079'>
                uFCOPY(icPINT,cPINT,i,j,k)<a name='2080'>
             enddo<a name='2081'>
                <a name='2082'>
             k=kpres+2<a name='2083'>
             a=1-mod(JJ(i,j),2)<a name='2084'>
<a name='2085'>
             uFCOPY(icPINT,cPINT,i,j,k)<a name='2086'>
             uFCOPY(icPD,cPD,i,j,1)<a name='2087'>
             uFCOPY(icFIS,cFIS,i,j,1)<a name='2088'>
<a name='2089'>
             inFIS(1,used)=nFIS(i,j,1)<a name='2090'>
<a name='2091'>
          enddo<a name='2092'>
       endif if_xbdy<a name='2093'>
       if_ybdy: if(b==3 .or. b==4) then<a name='2094'>
          if(b==3) then<a name='2095'>
             if(njts/=1) cycle bdyloop<a name='2096'>
             j=1<a name='2097'>
          endif<a name='2098'>
          if(b==4) then<a name='2099'>
             if(njte&lt;njde-1) cycle bdyloop<a name='2100'>
             j=njde-1<a name='2101'>
          endif<a name='2102'>
          do i=max(nits-1,nids),min(nite+1,nide-1)<a name='2103'>
             used=used+1<a name='2104'>
             do k=nkts,kpres+1<a name='2105'>
                a=1-mod(JJ(i,j),2)<a name='2106'>
                uFCOPY(icT,cT,i,j,k)<a name='2107'>
                uFCOPY(icQ,cQ,i,j,k)<a name='2108'>
                uFCOPY(icPINT,cPINT,i,j,k)<a name='2109'>
             enddo<a name='2110'>
                <a name='2111'>
             k=kpres+2<a name='2112'>
             a=1-mod(JJ(i,j),2)<a name='2113'>
<a name='2114'>
             uFCOPY(icPINT,cPINT,i,j,k)<a name='2115'>
             uFCOPY(icPD,cPD,i,j,1)<a name='2116'>
             uFCOPY(icFIS,cFIS,i,j,1)<a name='2117'>
<a name='2118'>
             inFIS(1,used)=nFIS(i,j,1)<a name='2119'>
          enddo<a name='2120'>
       endif if_ybdy<a name='2121'>
    enddo bdyloop<a name='2122'>
<a name='2123'>
    if(used==0) then<a name='2124'>
       <font color=#447700>! No boundary points on this tile so we are done<a name='2125'></font>
       return<a name='2126'>
    endif<a name='2127'>
<a name='2128'>
    call <A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES'>interp_T_PD_Q_kpres</A><A href='../../html_code/share/module_interp_nmm.F.html#C2B_FULLDOM_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_T_PD_Q_KPRES_3">(nmm_method_linear, nmm_interp_pd, used,nz, &amp;<a name='2129'>
         deta1,deta2,eta1,eta2,ptop,pdtop, kpres, kpres+2, &amp;<a name='2130'>
         icFIS,inFIS, icPINT,inPINT, icT, inT, icPD,inPD, icQ,inQ, &amp;<a name='2131'>
         iinfo, winfo, warned)<a name='2132'>
<a name='2133'>
    used1=used<a name='2134'>
    used=0<a name='2135'>
<a name='2136'>
    if_bxs: if(nits==1) then<a name='2137'>
       i=1<a name='2138'>
       do j=j1,j2,2<a name='2139'>
          used=used+1<a name='2140'>
          do k=nkts,kpres<a name='2141'>
             tbxs(j,k,1)=inT(k,used)<a name='2142'>
             qbxs(j,k,1)=inQ(k,used)<a name='2143'>
             ibxs(j,k,1)=iinfo(k,used)<a name='2144'>
             wbxs(j,k,1)=winfo(k,used)<a name='2145'>
          enddo<a name='2146'>
          ibxs(j,nkde,1)=nkde<a name='2147'>
          wbxs(j,nkde,1)=1.0<a name='2148'>
          pdbxs(j,1,1)=inPD(1,used)<a name='2149'>
       enddo<a name='2150'>
       do k=kpres+1,nkde-1<a name='2151'>
          do j=j1,j2,2<a name='2152'>
             a=1-mod(JJ(i,j),2)<a name='2153'>
             tbxs(j,k,1)=ICOPY(cT,i,j,k)<a name='2154'>
             qbxs(j,k,1)=ICOPY(cQ,i,j,k)<a name='2155'>
             ibxs(j,k,1)=k<a name='2156'>
             wbxs(j,k,1)=1.0<a name='2157'>
          enddo<a name='2158'>
       enddo<a name='2159'>
    endif if_bxs<a name='2160'>
<a name='2161'>
    if_bxe: if(nite&gt;=nide-1) then<a name='2162'>
       i=nide-1<a name='2163'>
       do j=j1,j2,2<a name='2164'>
          used=used+1<a name='2165'>
          do k=nkts,kpres<a name='2166'>
             tbxe(j,k,1)=inT(k,used)<a name='2167'>
             qbxe(j,k,1)=inQ(k,used)<a name='2168'>
             ibxe(j,k,1)=iinfo(k,used)<a name='2169'>
             wbxe(j,k,1)=winfo(k,used)<a name='2170'>
          enddo<a name='2171'>
          ibxe(j,nkde,1)=nkde<a name='2172'>
          wbxe(j,nkde,1)=1.0<a name='2173'>
          pdbxe(j,1,1)=inPD(1,used)<a name='2174'>
       enddo<a name='2175'>
       do k=kpres+1,nkde-1<a name='2176'>
          do j=j1,j2,2<a name='2177'>
             a=1-mod(JJ(i,j),2)<a name='2178'>
             tbxe(j,k,1)=ICOPY(cT,i,j,k)<a name='2179'>
             qbxe(j,k,1)=ICOPY(cQ,i,j,k)<a name='2180'>
             ibxe(j,k,1)=k<a name='2181'>
             wbxe(j,k,1)=1.0<a name='2182'>
          enddo<a name='2183'>
       enddo<a name='2184'>
    endif if_bxe<a name='2185'>
<a name='2186'>
    if_bys: if(njts==1) then<a name='2187'>
       j=1<a name='2188'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='2189'>
          used=used+1<a name='2190'>
          do k=nkts,kpres<a name='2191'>
             tbys(i,k,1)=inT(k,used)<a name='2192'>
             qbys(i,k,1)=inQ(k,used)<a name='2193'>
             ibys(i,k,1)=iinfo(k,used)<a name='2194'>
             wbys(i,k,1)=winfo(k,used)<a name='2195'>
          enddo<a name='2196'>
          ibys(i,nkde,1)=nkde<a name='2197'>
          wbys(i,nkde,1)=1.0<a name='2198'>
          pdbys(i,1,1)=inPD(1,used)<a name='2199'>
       enddo<a name='2200'>
       do k=kpres+1,nkde-1<a name='2201'>
          do i=max(nits-1,nids),min(nite+1,nide-1)<a name='2202'>
             a=1-mod(JJ(i,j),2)<a name='2203'>
             tbys(i,k,1)=ICOPY(cT,i,j,k)<a name='2204'>
             qbys(i,k,1)=ICOPY(cQ,i,j,k)<a name='2205'>
             ibys(i,k,1)=k<a name='2206'>
             wbys(i,k,1)=1.0<a name='2207'>
          enddo<a name='2208'>
       enddo<a name='2209'>
    endif if_bys<a name='2210'>
<a name='2211'>
    if_bye: if(njte&gt;=njde-1) then<a name='2212'>
       j=njde-1<a name='2213'>
       do i=max(nits-1,nids),min(nite+1,nide-1)<a name='2214'>
          used=used+1<a name='2215'>
          do k=nkts,kpres<a name='2216'>
             tbye(i,k,1)=inT(k,used)<a name='2217'>
             qbye(i,k,1)=inQ(k,used)<a name='2218'>
             ibye(i,k,1)=iinfo(k,used)<a name='2219'>
             wbye(i,k,1)=winfo(k,used)<a name='2220'>
          enddo<a name='2221'>
          ibye(i,nkde,1)=nkde<a name='2222'>
          wbye(i,nkde,1)=1.0<a name='2223'>
          pdbye(i,1,1)=inPD(1,used)<a name='2224'>
       enddo<a name='2225'>
       do k=kpres+1,nkde-1<a name='2226'>
          do i=max(nits-1,nids),min(nite+1,nide-1)<a name='2227'>
             a=1-mod(JJ(i,j),2)<a name='2228'>
             tbye(i,k,1)=ICOPY(cT,i,j,k)<a name='2229'>
             qbye(i,k,1)=ICOPY(cQ,i,j,k)<a name='2230'>
             ibye(i,k,1)=k<a name='2231'>
             wbye(i,k,1)=1.0<a name='2232'>
          enddo<a name='2233'>
       enddo<a name='2234'>
    endif if_bye<a name='2235'>
<a name='2236'>
    if(used/=used1) then<a name='2237'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#C2B_FULLDOM_NEW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1393">('Number of input and output points does not match.')<a name='2238'>
    endif<a name='2239'>
<a name='2240'>
  end subroutine c2b_fulldom_new<a name='2241'>
<a name='2242'>
  <font color=#447700>! ####################################################################<a name='2243'></font>
<a name='2244'>
<A NAME='C2N_FULLDOM'><A href='../../html_code/share/module_interp_nmm.F.html#C2N_FULLDOM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2245'>
  <font color=#993300>subroutine </font><font color=#cc0000>c2n_fulldom</font>  (II,JJ,W1,W2,W3,W4,&amp; <A href='../../call_to/C2N_FULLDOM.html' TARGET='index'>1</A>,<A href='../../call_from/C2N_FULLDOM.html' TARGET='index'>1</A><a name='2246'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='2247'>
       cfis,cpint,ct,cpd,cq,                 &amp;<a name='2248'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='2249'>
       nfis,npint,nt,npd,nq,                 &amp;<a name='2250'>
       out_iinfo,out_winfo,imask,&amp;<a name='2251'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='2252'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='2253'>
       nits, nite, njts, njte, nkts, nkte, kpres)<a name='2254'>
    implicit none<a name='2255'>
    integer, intent(in):: cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='2256'>
         nids, nide, njds, njde, nkds, nkde,   &amp;<a name='2257'>
         nims, nime, njms, njme, nkms, nkme,   &amp;<a name='2258'>
         nits, nite, njts, njte, nkts, nkte, kpres<a name='2259'>
    real, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: cT,cQ,cPINT<a name='2260'>
    real, intent(in), dimension(cims:cime,cjms:cjme,1) :: cPD,cFIS<a name='2261'>
<a name='2262'>
    real, intent(out), dimension(nims:nime,njms:njme,nkms:nkme) :: out_winfo<a name='2263'>
    integer, intent(out), dimension(nims:nime,njms:njme,nkms:nkme) :: out_iinfo<a name='2264'>
<a name='2265'>
    real, intent(out), dimension(nims:nime,njms:njme,nkms:nkme) :: nT,nQ<a name='2266'>
    real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: nPINT<a name='2267'>
    real, intent(in), dimension(nims:nime,njms:njme,1) :: nFIS<a name='2268'>
    real, intent(inout), dimension(nims:nime,njms:njme,1) :: nPD<a name='2269'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='2270'>
<a name='2271'>
    real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='2272'>
         W1,W2,W3,W4<a name='2273'>
    integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='2274'>
<a name='2275'>
    real, intent(in), dimension(nkms:nkme) :: eta1,eta2,deta1,deta2<a name='2276'>
    real, intent(in) :: ptop,pdtop<a name='2277'>
<a name='2278'>
    real, dimension(1,nite-nits+1) :: inFIS,inPD,icFIS,icPD<a name='2279'>
    real, dimension(nkde-1,nite-nits+1) :: inT,inQ,icT,icQ,winfo<a name='2280'>
    integer, dimension(nkde-1,nite-nits+1) :: iinfo<a name='2281'>
    real, dimension(nkde,nite-nits+1) :: inPINT,icPINT<a name='2282'>
<a name='2283'>
    real :: pdcheck<a name='2284'>
    integer :: i,j,k,a, nx,nz,used<a name='2285'>
    logical :: badbad, warned<a name='2286'>
<a name='2287'>
    warned=.false. <font color=#447700>! Allow one P&gt;PSTD message<a name='2288'></font>
<a name='2289'>
    nx=min(nide-1,nite)-max(nids,nits)+1<a name='2290'>
    nz=nkde-nkds+1<a name='2291'>
<a name='2292'>
    bigj: do j=max(njds,njts),min(njde-1,njte)<a name='2293'>
       <font color=#447700>! STEP 1: Copy coarse and fine nest data into <a name='2294'></font>
       <font color=#447700>! temporary arrays, reordering dimensions:<a name='2295'></font>
       used=0<a name='2296'>
       iloop1: do i=max(nids,nits),min(nide-1,nite)<a name='2297'>
          if(imask(i,j)/=0) cycle iloop1<a name='2298'>
          used=used+1<a name='2299'>
<a name='2300'>
          qtloop: do k=nkts,nkte-1<a name='2301'>
             a=1-mod(JJ(i,j),2)<a name='2302'>
             uFCOPY(icT,cT,i,j,k)<a name='2303'>
             uFCOPY(icQ,cQ,i,j,k)<a name='2304'>
             uFCOPY(icPINT,cPINT,i,j,k)<a name='2305'>
          enddo qtloop<a name='2306'>
<a name='2307'>
          k=nkte<a name='2308'>
          a=1-mod(JJ(i,j),2)<a name='2309'>
<a name='2310'>
          uFCOPY(icPINT,cPINT,i,j,k)<a name='2311'>
          uFCOPY(icPD,cPD,i,j,1)<a name='2312'>
          uFCOPY(icFIS,cFIS,i,j,1)<a name='2313'>
<a name='2314'>
<font color=#447700>!           nPD(i,j,1)=use_this_pd(i,j,1) ! FIXME: remove this line<a name='2315'></font>
 <font color=#447700>!           if(nPD(i,j,1)&gt; 1.3e5 .or. nPD(i,j,1)&lt;2e4) then<a name='2316'></font>
 <font color=#447700>! 3131         format('Invalid input nest PD in C2N interpolation: PD(',I0,',',I0,') = ',F0.7)<a name='2317'></font>
 <font color=#447700>!              write(0,3131) i,j,nPD(i,j,1)<a name='2318'></font>
 <font color=#447700>!              call wrf_error_fatal('Invalid input nest PD')<a name='2319'></font>
 <font color=#447700>!           endif<a name='2320'></font>
          inPD(1,used)=nPD(i,j,1)<a name='2321'>
          inFIS(1,used)=nFIS(i,j,1)<a name='2322'>
       enddo iloop1<a name='2323'>
<a name='2324'>
       <font color=#447700>! Step 2: Interpolate coarse grid to fine grid in reordered<a name='2325'></font>
       <font color=#447700>! arrays:<a name='2326'></font>
       <a name='2327'>
       if(used==0) then<a name='2328'>
          <font color=#447700>! No points in this row require interpolation, so we're done<a name='2329'></font>
          <font color=#447700>! with this row:<a name='2330'></font>
          cycle bigj<a name='2331'>
       else<a name='2332'>
          call <A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q'>interp_T_PD_Q</A><A href='../../html_code/share/module_interp_nmm.F.html#C2N_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_T_PD_Q_2">(nmm_method_linear, nmm_interp_pd, used,nz, &amp;<a name='2333'>
               deta1,deta2,eta1,eta2,ptop,pdtop,kpres, &amp;<a name='2334'>
               icFIS,inFIS, icPINT,inPINT, icT, inT, icPD,inPD, icQ,inQ, &amp;<a name='2335'>
               iinfo, winfo, warned)<a name='2336'>
       endif<a name='2337'>
<a name='2338'>
       <font color=#447700>! Step 3: Copy back from reordered arrays to final nest arrays:<a name='2339'></font>
       used=0<a name='2340'>
       iloop2: do i=max(nids,nits),min(nide-1,nite)<a name='2341'>
          if(imask(i,j)/=0) cycle iloop2<a name='2342'>
          used=used+1<a name='2343'>
<a name='2344'>
          qtloop2: do k=nkts,nkte-1<a name='2345'>
             nT(i,j,k)=inT(k,used)<a name='2346'>
             nQ(i,j,k)=inQ(k,used)<a name='2347'>
             nQ(i,j,k)=inQ(k,used)<a name='2348'>
          enddo qtloop2<a name='2349'>
<a name='2350'>
          izloop: do k=nkts,nkte-1<a name='2351'>
             out_iinfo(i,j,k)=iinfo(k,used)<a name='2352'>
             out_winfo(i,j,k)=winfo(k,used)<a name='2353'>
          enddo izloop<a name='2354'>
          out_iinfo(i,j,nkde)=nkde<a name='2355'>
          out_winfo(i,j,nkde)=1.0<a name='2356'>
<a name='2357'>
          k=nkte+1<a name='2358'>
          a=1-mod(JJ(i,j),2)<a name='2359'>
          nPD(i,j,1)=inPD(1,used)<a name='2360'>
          pdcheck=npd(i,j,1)+ptop+pdtop<a name='2361'>
 <font color=#447700>!          if(pdcheck&lt;50000.0 .or. pdcheck&gt;105000.0) then<a name='2362'></font>
 <font color=#447700>! 3131         format('Invalid output nest PD in C2N interpolation: PD(',I0,',',I0,') = ',F0.7,' which is ',F0.7,' Pa')<a name='2363'></font>
 <font color=#447700>!              write(0,3131) i,j,nPD(i,j,1),pdcheck<a name='2364'></font>
 <font color=#447700>!              call wrf_error_fatal('Invalid output nest PD')<a name='2365'></font>
 <font color=#447700>!          endif<a name='2366'></font>
       enddo iloop2<a name='2367'>
    enddo bigj<a name='2368'>
<a name='2369'>
  end subroutine c2n_fulldom<a name='2370'>
<a name='2371'>
  <font color=#447700>! ********************************************************************<a name='2372'></font>
  <font color=#447700>! INTERP_T_PD_Q -- this is the actual vertical interpolation<a name='2373'></font>
  <font color=#447700>! subroutine, the implementation of the *_fulldom subroutines.  It<a name='2374'></font>
  <font color=#447700>! takes arrays of atmospheric columns, with no knowledge of the<a name='2375'></font>
  <font color=#447700>! horizontal layout of those columns.  This routine will recalculate<a name='2376'></font>
  <font color=#447700>! PD if requested, then generate interpolation information and<a name='2377'></font>
  <font color=#447700>! interpolate T and Q, within each atmospheric column.  <a name='2378'></font>
  <font color=#447700>!<a name='2379'></font>
  <font color=#447700>! Other variables are handled by the various other c2n, n2c and c2b<a name='2380'></font>
  <font color=#447700>! routines in this module.  PD, T and Q are handled specially since<a name='2381'></font>
  <font color=#447700>! they are critical to the stability of the hydrostatic solver, and<a name='2382'></font>
  <font color=#447700>! hence have more expensive extrapolation and mass rebalancing<a name='2383'></font>
  <font color=#447700>! methods.<a name='2384'></font>
  <font color=#447700>!<a name='2385'></font>
  <font color=#447700>! Since this routine has no knowledge of the horizontal layout of<a name='2386'></font>
  <font color=#447700>! the atmospheric columns it is given, the columns do not have to<a name='2387'></font>
  <font color=#447700>! lie on an I- or J-row.  The boundary interpolation routines take<a name='2388'></font>
  <font color=#447700>! advantage of that and provide all boundary information to this<a name='2389'></font>
  <font color=#447700>! routine in a single call.  Of course, the caller must handle all<a name='2390'></font>
  <font color=#447700>! horizontal interpolation.<a name='2391'></font>
  <font color=#447700>! ********************************************************************<a name='2392'></font>
<a name='2393'>
<A NAME='INTERP_T_PD_Q'><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2394'>
  <font color=#993300>subroutine </font><font color=#cc0000>interp_T_PD_Q</font>(method, pd_interp, nx, nz, &amp; <A href='../../call_to/INTERP_T_PD_Q.html' TARGET='index'>2</A>,<A href='../../call_from/INTERP_T_PD_Q.html' TARGET='index'>6</A><a name='2395'>
       deta1,deta2, eta1,eta2, ptop,pdtop, kpres,     &amp;<a name='2396'>
       fisA,fisB, pintA,pintB, tA,tB, pdA,pdB, qA,qB, &amp;<a name='2397'>
       iinfo, winfo, warned)<a name='2398'>
    implicit none<a name='2399'>
<a name='2400'>
    integer, intent(in) :: pd_interp,method, kpres<a name='2401'>
    <font color=#447700>!      real, intent(in) :: dtA,dtB<a name='2402'></font>
<a name='2403'>
    <font color=#447700>! Coordinate system definitions must be the same for all domains:<a name='2404'></font>
    real, intent(in) :: deta1(nz),deta2(nz),eta1(nz),eta2(nz),ptop,pdtop<a name='2405'>
    integer, intent(in) :: nx,nz<a name='2406'>
<a name='2407'>
    <font color=#447700>! Surface height and mass field information for source (A):<a name='2408'></font>
    real, intent(in) :: fisA(nx),tA(nz-1,nx),pdA(nx),qA(nz-1,nx),pintA(nz,nx)<a name='2409'>
<a name='2410'>
    <font color=#447700>! Surface height and mass field information for target (B):<a name='2411'></font>
    real, intent(inout) :: fisB(nx),tB(nz-1,nx),pdB(nx),qB(nz-1,nx),pintB(nz,nx)<a name='2412'>
<a name='2413'>
    <font color=#447700>! Interpolation or extrapolation information for use in other<a name='2414'></font>
    <font color=#447700>! calls later on:<a name='2415'></font>
    real, intent(out) :: winfo(nz-1,nx)<a name='2416'>
    integer, intent(out) :: iinfo(nz-1,nx)<a name='2417'>
    logical, intent(inout) :: warned<a name='2418'>
<a name='2419'>
    <font color=#447700>! ==================== Local variables ====================<a name='2420'></font>
<a name='2421'>
    character*255 :: message<a name='2422'>
    integer :: ix,iz,izA,izB,xpr<a name='2423'>
    real :: zA,zB,znext,apelp,rtopp,dz,weight,A,B,pstd1,z,pstd2,pstd12<a name='2424'>
    real :: tsfc(nx), slp(nx), zmslp(nx), z0mid(nx), zbelow(nx), &amp;<a name='2425'>
            tbelow(nx), RHbelow(nx)<a name='2426'>
    real :: pb,pb1,pb2,pa,pa1,pa2,pnext,pa3, wnum,wdenom, QC, P0<a name='2427'>
<a name='2428'>
    <font color=#447700>! Constants from UPP params.f for RH calculation (all mks):<a name='2429'></font>
    real, parameter :: PQ0=379.90516<a name='2430'>
    real, parameter :: A2=17.2693882<a name='2431'>
    real, parameter :: A3=273.16<a name='2432'>
    real, parameter :: A4=35.86<a name='2433'>
    real, parameter :: RHmin=1.0E-6     <font color=#447700>! minimal RH bound<a name='2434'></font>
<a name='2435'>
    if(method/=nmm_method_linear) then<a name='2436'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1394">('only linear interpolation is supported')<a name='2437'>
    endif<a name='2438'>
<a name='2439'>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2440'></font>
    <font color=#447700>!! Step 1: calculate near-surface values !!!!!!!!!!!!!!!!!!!!!<a name='2441'></font>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2442'></font>
<a name='2443'>
    pstd1=p_ref <font color=#447700>! pstd(1) from base_state_parent<a name='2444'></font>
    <font color=#447700>! pstd(2) from base_state_parent:<a name='2445'></font>
    pstd2=eta1(2)*pdtop + eta2(2)*(p_ref-pdtop-ptop) + ptop<a name='2446'>
    pstd12=exp((alog(pstd1)+alog(pstd2))*0.5)<a name='2447'>
<a name='2448'>
    do ix=1,nx<a name='2449'>
       <font color=#447700>! These calculations are from base_state_parent:<a name='2450'></font>
       APELP    = (pintA(2,ix)+pintA(1,ix))<a name='2451'>
       RTOPP    = TRG*tA(1,ix)*(1.0+qA(1,ix)*P608)/APELP<a name='2452'>
       DZ       = RTOPP*(DETA1(1)*PDTOP+DETA2(1)*pdA(ix))<a name='2453'>
<a name='2454'>
       Z0MID(ix) = fisA(ix)/g + dz/2<a name='2455'>
<a name='2456'>
       zA=fisA(ix)/g<a name='2457'>
<a name='2458'>
       TSFC(ix) = TA(1,ix)*(1.+D608*QA(1,ix)) &amp;<a name='2459'>
            + LAPSR*(zA + zA+dz)*0.5<a name='2460'>
<a name='2461'>
       A         = LAPSR*zA/TSFC(ix)<a name='2462'>
       SLP(ix)  = PINTA(1,ix)*(1-A)**COEF2    <font color=#447700>! sea level pressure <a name='2463'></font>
       B         = (pstd1/SLP(ix))**COEF3<a name='2464'>
       ZMSLP(ix)= TSFC(ix)*LAPSI*(1.0 - B)   <font color=#447700>! Height at 1030. mb level<a name='2465'></font>
<a name='2466'>
       TBELOW(ix) = TA(1,ix) + LAPSR*(Z0MID(ix)-ZMSLP(ix))<a name='2467'>
       <a name='2468'>
       <font color=#447700>! Calculate lowest level RH.  This calculation is from UPP<a name='2469'></font>
       <font color=#447700>! CALRH.f:<a name='2470'></font>
       P0=pdA(ix)+ptop+pdtop <font color=#447700>! Use hydrostatic lowest model level P<a name='2471'></font>
       QC=PQ0/P0*EXP(A2*(TA(1,ix)-A3)/(TA(1,ix)-A4))<a name='2472'>
       RHbelow(ix)=max(RHmin,min(1.0,QA(1,ix)/QC))<a name='2473'>
    enddo<a name='2474'>
<a name='2475'>
<a name='2476'>
<a name='2477'>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2478'></font>
    <font color=#447700>!! Step 2: figure out the new surface pressures !!!!!!!!!!!!!!<a name='2479'></font>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2480'></font>
<a name='2481'>
<a name='2482'>
<a name='2483'>
    if_pd_interp: if(pd_interp==nmm_keep_pd) then<a name='2484'>
       <font color=#447700>! PD interpolation is turned off, so we use the original PD.<a name='2485'></font>
    elseif(pd_interp==nmm_interp_pd) then<a name='2486'>
       <font color=#447700>! PD interpolation is requested.  As with the old base_state_parent,<a name='2487'></font>
       <font color=#447700>! determine PD by interpolating or extrapolating the non-hydrostatic<a name='2488'></font>
       <font color=#447700>! pressure field (PINT) in source grid to the surface height of the<a name='2489'></font>
       <font color=#447700>! target grid.  <a name='2490'></font>
       xloop: do ix=1,nx<a name='2491'>
          if(pintA(1,ix)&gt;p_ref) then<a name='2492'>
             <font color=#447700>! Cannot extrapolate PD below ground because pressure is<a name='2493'></font>
             <font color=#447700>! unrealistically high.  Follow base_state_parent method:<a name='2494'></font>
             <font color=#447700>! when this happens, assign input pressure to output <a name='2495'></font>
             <font color=#447700>! pressure.<a name='2496'></font>
             if(.not.warned) then<a name='2497'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE2'>wrf_message2</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE2_7">('WARNING: NESTED DOMAIN PRESSURE AT LOWEST LEVEL HIGHER THAN PSTD')<a name='2498'>
                write(message,*) 'PINT(1),PD(1),PSTD(1)',pintA(1,ix),pdA(ix),p_ref<a name='2499'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE2'>wrf_message2</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE2_8">(message)<a name='2500'>
                warned=.true.<a name='2501'>
             endif<a name='2502'>
             pdB(ix)=pdA(ix)<a name='2503'>
             cycle xloop<a name='2504'>
          endif<a name='2505'>
<a name='2506'>
          zA=fisA(ix)/g<a name='2507'>
          zB=fisB(ix)/g<a name='2508'>
<a name='2509'>
          if(zB&lt;zA) then<a name='2510'>
             <font color=#447700>! Need to extrapolate PD below ground.<a name='2511'></font>
             <font color=#447700>! Follow base_state_parent method: <a name='2512'></font>
             <font color=#447700>!   For pressures between pint(1) and 1030 mbar, interpolate<a name='2513'></font>
             iz=1<a name='2514'>
             weight=abs((zB-zmslp(ix))/(zA-zmslp(ix)))<a name='2515'>
             pdB(ix) = exp(weight*log(pdA(ix)+pdtop+ptop) + &amp;<a name='2516'>
                        (1.0-weight)*log(P_REF)) &amp;<a name='2517'>
                        - pdtop - ptop<a name='2518'>
<font color=#447700>!             write(0,*) 'WARNING: extrapolating below ground at ix=',ix<a name='2519'></font>
<font color=#447700>!1302         format('Extrap at ix=',I0,' zA=',F0.3,' zB=',F0.3,' zmslp=',F0.3,' weight=',F0.3,' pdB+pdtop+ptop=',F0.3,' pintA=',F0.3,' pdA(ix)+pdtop+ptop=',F0.3,' P_REF=',F0.3)<a name='2520'></font>
<font color=#447700>!             write(0,1302) ix,zA,zB,zmslp(ix),weight,pdB(ix)+pdtop+ptop,pintA(1,ix),pdA(ix)+pdtop+ptop,P_REF<a name='2521'></font>
             cycle xloop<a name='2522'>
          endif<a name='2523'>
<a name='2524'>
          <font color=#447700>! PD in grid B lies above ground in grid A.  Find out where by<a name='2525'></font>
          <font color=#447700>! walking up from the ground until we find the two levels the<a name='2526'></font>
          <font color=#447700>! pressure lies between.<a name='2527'></font>
          znext=-9e9<a name='2528'>
          z=zA<a name='2529'>
          do iz=1,nz-1<a name='2530'>
             <font color=#447700>! Calculations from base_state_parent:<a name='2531'></font>
             APELP    = (pintA(iz+1,ix)+pintA(iz,ix))<a name='2532'>
             RTOPP    = TRG*tA(iz,ix)*(1.0+qA(iz,ix)*P608)/APELP<a name='2533'>
             DZ       = RTOPP*(DETA1(iz)*PDTOP+DETA2(iz)*pdA(ix))<a name='2534'>
             znext=z+dz<a name='2535'>
<a name='2536'>
             if(znext&gt;zB) then<a name='2537'>
                <font color=#447700>! Interpolate between these two levels<a name='2538'></font>
                weight=(zB-z)/dz<a name='2539'>
                pdB(ix) = exp(weight*log(pintA(iz+1,ix)) + &amp;<a name='2540'>
                              (1.0-weight)*log(pintA(iz,ix))) &amp;<a name='2541'>
                      - pdtop - ptop<a name='2542'>
<font color=#447700>!                if(iz&gt;1) then<a name='2543'></font>
<font color=#447700>!                   write(0,*) 'WARNING: interpolate above ground at ix=',ix<a name='2544'></font>
<font color=#447700>!1303               format('Interp at ix=',I0,' with iz=',I0,' zA=',F0.3,' zB=',F0.3,' zmslp=',F0.3,' weight=',F0.3,' pdB+pdtop+ptop=',F0.3,' pintA=',F0.3,' pdA(ix)+pdtop+ptop=',F0.3,' P_REF=',F0.3)<a name='2545'></font>
<font color=#447700>!                   write(0,1303) ix,iz,zA,zB,zmslp(ix),weight,pdB(ix)+pdtop+ptop,pintA(1,ix),pdA(ix)+pdtop+ptop,P_REF<a name='2546'></font>
<font color=#447700>!                endif<a name='2547'></font>
                cycle xloop<a name='2548'>
             else<a name='2549'>
                z=znext<a name='2550'>
             endif<a name='2551'>
<a name='2552'>
          enddo<a name='2553'>
<a name='2554'>
201       format('interp_T_PD_Q: Target domain surface height ',F0.4,'m is higher than the model top ',F0.4,'m of the source domain.  ABORTING')<a name='2555'>
          write(message,201) zB,znext<a name='2556'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1395">(message)<a name='2557'>
       enddo xloop<a name='2558'>
    else<a name='2559'>
202    format('Invalid value ',I0,' for pd_interp in interp_T_PD_Q')<a name='2560'>
       write(message,202) pd_interp<a name='2561'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1396">(message)<a name='2562'>
    endif if_pd_interp<a name='2563'>
<a name='2564'>
<a name='2565'>
<a name='2566'>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2567'></font>
    <font color=#447700>!! Step 3: interpolate T and Q in pressure space !!!!!!!!!!!!!<a name='2568'></font>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2569'></font>
<a name='2570'>
<a name='2571'>
<a name='2572'>
    outer: do ix=1,nx<a name='2573'>
       <font color=#447700>! For constant pressure levels, do a straight level-by-level copy:<a name='2574'></font>
       iz=nz-1<a name='2575'>
       copyloop: do while(iz&gt;kpres)<a name='2576'>
          tB(iz,ix)=tA(iz,ix)<a name='2577'>
          qB(iz,ix)=qA(iz,ix)<a name='2578'>
<a name='2579'>
          <font color=#447700>! Save interpolation information<a name='2580'></font>
          iinfo(iz,ix)=iz<a name='2581'>
          winfo(iz,ix)=1.0<a name='2582'>
<a name='2583'>
          iz=iz-1<a name='2584'>
       enddo copyloop<a name='2585'>
<a name='2586'>
       <font color=#447700>! For sigma levels where target domain lies within source,<a name='2587'></font>
       <font color=#447700>! interpolate from top down, stopping when we go below ground<a name='2588'></font>
       <font color=#447700>! in the source domain.<a name='2589'></font>
       izA=iz<a name='2590'>
       izB=iz<a name='2591'>
<a name='2592'>
       <font color=#447700>! FIXME: REMOVE THIS CHECK<a name='2593'></font>
       if(iz&gt;nz) then<a name='2594'>
          <font color=#447700>! Make sure the entire vertical extent isn't sigma levels:<a name='2595'></font>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1397">('ERROR: WRF-NMM does not support pure sigma levels (only sigma-pressure hybrid)')<a name='2596'>
       endif<a name='2597'>
<a name='2598'>
       pB2=log(eta1(izB)*pdtop + eta2(izB)*pdB(ix) + ptop)<a name='2599'>
       pB1=log(eta1(izB+1)*pdtop + eta2(izB+1)*pdB(ix) + ptop)<a name='2600'>
       pB=(pB2+pB1)*0.5<a name='2601'>
<a name='2602'>
       pA2=log(eta1(izA)*pdtop + eta2(izA)*pdA(ix) + ptop)<a name='2603'>
       pA1=log(eta1(izA+1)*pdtop + eta2(izA+1)*pdA(ix) + ptop)<a name='2604'>
       pA=(pA2+pA1)*0.5<a name='2605'>
<a name='2606'>
       <font color=#447700>! Find the lowest mass level izA that is above pB<a name='2607'></font>
       interpinit: do while(izA&gt;1)<a name='2608'>
          pA3=log(eta1(izA-1)*pdtop + eta2(izA-1)*pdA(ix) + ptop)<a name='2609'>
          pnext=(pA2+pA3)*0.5<a name='2610'>
          wdenom=pnext-pA<a name='2611'>
          wnum=pnext-pb<a name='2612'>
          if(pA&lt;=pB .and. wnum&gt;1e-5) then<a name='2613'>
             exit interpinit<a name='2614'>
          else<a name='2615'>
             pA1=pA2<a name='2616'>
             pA2=pa3<a name='2617'>
             izA=izA-1<a name='2618'>
             pA=pnext<a name='2619'>
          endif<a name='2620'>
       enddo interpinit<a name='2621'>
<a name='2622'>
       <font color=#447700>! Loop over all remaining B points, interpolating to them.<a name='2623'></font>
       interploop: do while(izB&gt;0 .and. izA&gt;1)<a name='2624'>
          <font color=#447700>! Find the source domain levels that this target domain level lies between:<a name='2625'></font>
          zinterp: do while(izA&gt;1)<a name='2626'>
             if(pnext&gt;=pB) then<a name='2627'>
                <font color=#447700>! We found the two levels, so interpolate and move on to<a name='2628'></font>
                <font color=#447700>! the next target level:<a name='2629'></font>
                weight=max(0.,wnum/wdenom)<a name='2630'>
                tB(izB,ix)=weight*tA(izA,ix) + (1.0-weight)*tA(izA-1,ix)<a name='2631'>
                qB(izB,ix)=weight*qA(izA,ix) + (1.0-weight)*qA(izA-1,ix)<a name='2632'>
<a name='2633'>
                <font color=#447700>! Save interpolation info<a name='2634'></font>
                iinfo(izB,ix)=izA    <font color=#447700>! upper level<a name='2635'></font>
                winfo(izB,ix)=weight <font color=#447700>! linear interpolation weight<a name='2636'></font>
<a name='2637'>
                <font color=#447700>! We interpolated to a B point, so go to the next one:<a name='2638'></font>
                pB1=pB2<a name='2639'>
                izB=izB-1<a name='2640'>
                if(izB&gt;0) then<a name='2641'>
                   pB2=log(eta1(izB)*pdtop + eta2(izB)*pdB(ix) + ptop)<a name='2642'>
                   pB=(pb1+pb2)*0.5<a name='2643'>
                else<a name='2644'>
                   exit interploop<a name='2645'>
                endif<a name='2646'>
                wnum=pnext-pb<a name='2647'>
                <a name='2648'>
                exit zinterp<a name='2649'>
             else<a name='2650'>
                izA=izA-1<a name='2651'>
                pA1=pA2<a name='2652'>
                pA2=pa3<a name='2653'>
                pA=pnext<a name='2654'>
                if(izA&gt;1) then<a name='2655'>
                   pA3=log(eta1(izA-1)*pdtop + eta2(izA-1)*pdA(ix) + ptop)<a name='2656'>
                   pnext=(pA2+pA3)*0.5<a name='2657'>
                   wdenom=pnext-pa<a name='2658'>
                   wnum=pnext-pb<a name='2659'>
                else<a name='2660'>
                   exit interploop<a name='2661'>
                endif<a name='2662'>
             endif<a name='2663'>
          enddo zinterp<a name='2664'>
       enddo interploop<a name='2665'>
<a name='2666'>
       <font color=#447700>! Follow what base_state_parent did for temperature:<a name='2667'></font>
       <font color=#447700>! interpolate between the second to last level and P_REF using<a name='2668'></font>
       <font color=#447700>! a lapse rate atmosphere.  For Q, we use constant RH below<a name='2669'></font>
       <font color=#447700>! ground, as suggested by Greg Thompson.<a name='2670'></font>
       extraploop: do while(izB&gt;=1)<a name='2671'>
          <font color=#447700>! Decide extrapolation weight:<a name='2672'></font>
          weight=(pB-pA)/(pstd12-pA)<a name='2673'>
<a name='2674'>
          <font color=#447700>! Extrapolate Q by copying lowest sigma layer value:<a name='2675'></font>
          <font color=#447700>!qB(izB,ix)=qA(1,ix)<a name='2676'></font>
<a name='2677'>
          <font color=#447700>! Extrapolate Q by linearly interpolating between 0 and surface value:<a name='2678'></font>
          <font color=#447700>!qB(izB,ix)=(1.0-weight)*qA(1,ix)<a name='2679'></font>
<a name='2680'>
          <font color=#447700>! Extrapolate T using a lapse rate atmosphere<a name='2681'></font>
          tB(izB,ix)=weight*tbelow(ix) + (1.0-weight)*tA(1,ix)<a name='2682'>
<a name='2683'>
          <font color=#447700>! Extrapolate Q using constant RH below ground, as suggested<a name='2684'></font>
          <font color=#447700>! by Greg Thompson.  This is the inversion of the RH<a name='2685'></font>
          <font color=#447700>! calculation used earlier in this function:<a name='2686'></font>
          P0=eta1(izB)*pdtop + eta2(izB)*pdB(ix) + ptop<a name='2687'>
          QC=PQ0/P0*EXP(A2*(TB(izB,ix)-A3)/(TB(izB,ix)-A4))<a name='2688'>
          QB(izB,ix)=QC*RHbelow(ix)<a name='2689'>
<a name='2690'>
          <font color=#447700>! Save extrapolation information<a name='2691'></font>
          iinfo(izB,ix)=0<a name='2692'>
          winfo(izB,ix)=weight<a name='2693'>
<a name='2694'>
          <font color=#447700>! Move to the next B level<a name='2695'></font>
          izB=izB-1<a name='2696'>
          if(izB&gt;0) then<a name='2697'>
             pB1=pB2<a name='2698'>
             pB2=log(eta1(izB)*pdtop + eta2(izB)*pdB(ix) + ptop)<a name='2699'>
             pB=(pb1+pb2)*0.5<a name='2700'>
          endif<a name='2701'>
       enddo extraploop<a name='2702'>
    enddo outer<a name='2703'>
  end subroutine interp_T_PD_Q<a name='2704'>
<a name='2705'>
<A NAME='INTERP_T_PD_Q_KPRES'><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2706'>
  <font color=#993300>subroutine </font><font color=#cc0000>interp_T_PD_Q_kpres</font>(method, pd_interp, nx, nz, &amp; <A href='../../call_to/INTERP_T_PD_Q_KPRES.html' TARGET='index'>3</A>,<A href='../../call_from/INTERP_T_PD_Q_KPRES.html' TARGET='index'>6</A><a name='2707'>
       deta1,deta2, eta1,eta2, ptop,pdtop, kpres, nz2,     &amp;<a name='2708'>
       fisA,fisB, pintA,pintB, tA,tB, pdA,pdB, qA,qB, &amp;<a name='2709'>
       iinfo, winfo, warned)<a name='2710'>
    implicit none<a name='2711'>
<a name='2712'>
    integer, intent(in) :: pd_interp,method, kpres, nz2<a name='2713'>
    <font color=#447700>!      real, intent(in) :: dtA,dtB<a name='2714'></font>
<a name='2715'>
    <font color=#447700>! Coordinate system definitions must be the same for all domains:<a name='2716'></font>
    real, intent(in) :: deta1(nz),deta2(nz),eta1(nz),eta2(nz),ptop,pdtop<a name='2717'>
    integer, intent(in) :: nx,nz<a name='2718'>
<a name='2719'>
    <font color=#447700>! Surface height and mass field information for source (A):<a name='2720'></font>
    real, intent(in) :: fisA(nx),tA(nz2-1,nx),pdA(nx),qA(nz2-1,nx),pintA(nz2,nx)<a name='2721'>
<a name='2722'>
    <font color=#447700>! Surface height and mass field information for target (B):<a name='2723'></font>
    real, intent(inout) :: fisB(nx),tB(nz2-1,nx),pdB(nx),qB(nz2-1,nx),pintB(nz2,nx)<a name='2724'>
<a name='2725'>
    <font color=#447700>! Interpolation or extrapolation information for use in other<a name='2726'></font>
    <font color=#447700>! calls later on:<a name='2727'></font>
    real, intent(out) :: winfo(nz2-1,nx)<a name='2728'>
    integer, intent(out) :: iinfo(nz2-1,nx)<a name='2729'>
<a name='2730'>
    logical, intent(inout) :: warned<a name='2731'>
<a name='2732'>
    <font color=#447700>! ==================== Local variables ====================<a name='2733'></font>
<a name='2734'>
    character*255 :: message<a name='2735'>
    integer :: ix,iz,izA,izB,xpr<a name='2736'>
    real :: zA,zB,znext,apelp,rtopp,dz,weight,A,B,pstd1,z,pstd2,pstd12<a name='2737'>
    real :: tsfc(nx), slp(nx), zmslp(nx), z0mid(nx), zbelow(nx), &amp;<a name='2738'>
            tbelow(nx), RHbelow(nx)<a name='2739'>
    real :: pb,pb1,pb2,pa,pa1,pa2,pnext,pa3, wnum,wdenom, QC, P0<a name='2740'>
<a name='2741'>
    <font color=#447700>! Constants from UPP params.f for RH calculation (all mks):<a name='2742'></font>
    real, parameter :: PQ0=379.90516<a name='2743'>
    real, parameter :: A2=17.2693882<a name='2744'>
    real, parameter :: A3=273.16<a name='2745'>
    real, parameter :: A4=35.86<a name='2746'>
    real, parameter :: RHmin=1.0E-6     <font color=#447700>! minimal RH bound<a name='2747'></font>
<a name='2748'>
    if(method/=nmm_method_linear) then<a name='2749'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1398">('only linear interpolation is supported')<a name='2750'>
    endif<a name='2751'>
<a name='2752'>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2753'></font>
    <font color=#447700>!! Step 1: calculate near-surface values !!!!!!!!!!!!!!!!!!!!!<a name='2754'></font>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2755'></font>
<a name='2756'>
<a name='2757'>
<a name='2758'>
    pstd1=p_ref <font color=#447700>! pstd(1) from base_state_parent<a name='2759'></font>
    <font color=#447700>! pstd(2) from base_state_parent:<a name='2760'></font>
    pstd2=eta1(2)*pdtop + eta2(2)*(p_ref-pdtop-ptop) + ptop<a name='2761'>
    pstd12=exp((alog(pstd1)+alog(pstd2))*0.5)<a name='2762'>
<a name='2763'>
    do ix=1,nx<a name='2764'>
       <font color=#447700>! These calculations are from base_state_parent:<a name='2765'></font>
       APELP    = (pintA(2,ix)+pintA(1,ix))<a name='2766'>
       RTOPP    = TRG*tA(1,ix)*(1.0+qA(1,ix)*P608)/APELP<a name='2767'>
       DZ       = RTOPP*(DETA1(1)*PDTOP+DETA2(1)*pdA(ix))<a name='2768'>
<a name='2769'>
       Z0MID(ix) = fisA(ix)/g + dz/2<a name='2770'>
<a name='2771'>
       zA=fisA(ix)/g<a name='2772'>
<a name='2773'>
       TSFC(ix) = TA(1,ix)*(1.+D608*QA(1,ix)) &amp;<a name='2774'>
            + LAPSR*(zA + zA+dz)*0.5<a name='2775'>
<a name='2776'>
       A         = LAPSR*zA/TSFC(ix)<a name='2777'>
       SLP(ix)  = PINTA(1,ix)*(1-A)**COEF2    <font color=#447700>! sea level pressure <a name='2778'></font>
       B         = (pstd1/SLP(ix))**COEF3<a name='2779'>
       ZMSLP(ix)= TSFC(ix)*LAPSI*(1.0 - B)   <font color=#447700>! Height at 1030. mb level<a name='2780'></font>
<a name='2781'>
       TBELOW(ix) = TA(1,ix) + LAPSR*(Z0MID(ix)-ZMSLP(ix))<a name='2782'>
       <a name='2783'>
       <font color=#447700>! Calculate lowest level RH.  This calculation is from UPP<a name='2784'></font>
       <font color=#447700>! CALRH.f:<a name='2785'></font>
       P0=pdA(ix)+ptop+pdtop <font color=#447700>! Use hydrostatic lowest model level P<a name='2786'></font>
       QC=PQ0/P0*EXP(A2*(TA(1,ix)-A3)/(TA(1,ix)-A4))<a name='2787'>
       RHbelow(ix)=max(RHmin,min(1.0,QA(1,ix)/QC))<a name='2788'>
    enddo<a name='2789'>
<a name='2790'>
<a name='2791'>
<a name='2792'>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2793'></font>
    <font color=#447700>!! Step 2: figure out the new surface pressures !!!!!!!!!!!!!!<a name='2794'></font>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2795'></font>
<a name='2796'>
<a name='2797'>
<a name='2798'>
    if_pd_interp: if(pd_interp==nmm_keep_pd) then<a name='2799'>
       <font color=#447700>! PD interpolation is turned off, so we use the original PD.<a name='2800'></font>
    elseif(pd_interp==nmm_interp_pd) then<a name='2801'>
       <font color=#447700>! PD interpolation is requested.  As with the old base_state_parent,<a name='2802'></font>
       <font color=#447700>! determine PD by interpolating or extrapolating the non-hydrostatic<a name='2803'></font>
       <font color=#447700>! pressure field (PINT) in source grid to the surface height of the<a name='2804'></font>
       <font color=#447700>! target grid.  <a name='2805'></font>
       xloop: do ix=1,nx<a name='2806'>
          if(pintA(1,ix)&gt;p_ref) then<a name='2807'>
             <font color=#447700>! Cannot extrapolate PD below ground because pressure is<a name='2808'></font>
             <font color=#447700>! unrealistically high.  Follow base_state_parent method:<a name='2809'></font>
             <font color=#447700>! when this happens, assign input pressure to output <a name='2810'></font>
             <font color=#447700>! pressure.<a name='2811'></font>
             if(.not.warned) then<a name='2812'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE2'>wrf_message2</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE2_9">('WARNING: NESTED DOMAIN PRESSURE AT LOWEST LEVEL HIGHER THAN PSTD')<a name='2813'>
                WRITE(message,*) 'PINT(1),PD(1),PSTD(1)',pintA(1,ix),pdA(ix),p_ref<a name='2814'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE2'>wrf_message2</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE2_10">(message)<a name='2815'>
                warned=.true.<a name='2816'>
             endif<a name='2817'>
             pdB(ix)=pdA(ix)<a name='2818'>
             cycle xloop<a name='2819'>
          endif<a name='2820'>
<a name='2821'>
          zA=fisA(ix)/g<a name='2822'>
          zB=fisB(ix)/g<a name='2823'>
<a name='2824'>
          if(zB&lt;zA) then<a name='2825'>
             <font color=#447700>! Need to extrapolate PD below ground.<a name='2826'></font>
             <font color=#447700>! Follow base_state_parent method: <a name='2827'></font>
             <font color=#447700>!   For pressures between pint(1) and 1030 mbar, interpolate<a name='2828'></font>
             iz=1<a name='2829'>
             weight=abs((zB-zmslp(ix))/(zA-zmslp(ix)))<a name='2830'>
             pdB(ix) = exp(weight*log(pdA(ix)+pdtop+ptop) + &amp;<a name='2831'>
                        (1.0-weight)*log(P_REF)) &amp;<a name='2832'>
                        - pdtop - ptop<a name='2833'>
<font color=#447700>!             write(0,*) 'WARNING: extrapolating below ground at ix=',ix<a name='2834'></font>
<font color=#447700>!1302         format('Extrap at ix=',I0,' zA=',F0.3,' zB=',F0.3,' zmslp=',F0.3,' weight=',F0.3,' pdB+pdtop+ptop=',F0.3,' pintA=',F0.3,' pdA(ix)+pdtop+ptop=',F0.3,' P_REF=',F0.3)<a name='2835'></font>
<font color=#447700>!             write(0,1302) ix,zA,zB,zmslp(ix),weight,pdB(ix)+pdtop+ptop,pintA(1,ix),pdA(ix)+pdtop+ptop,P_REF<a name='2836'></font>
             cycle xloop<a name='2837'>
          endif<a name='2838'>
<a name='2839'>
          <font color=#447700>! PD in grid B lies above ground in grid A.  Find out where by<a name='2840'></font>
          <font color=#447700>! walking up from the ground until we find the two levels the<a name='2841'></font>
          <font color=#447700>! pressure lies between.<a name='2842'></font>
          znext=-9e9<a name='2843'>
          z=zA<a name='2844'>
          do iz=1,nz2-1<a name='2845'>
             <font color=#447700>! Calculations from base_state_parent:<a name='2846'></font>
             APELP    = (pintA(iz+1,ix)+pintA(iz,ix))<a name='2847'>
             RTOPP    = TRG*tA(iz,ix)*(1.0+qA(iz,ix)*P608)/APELP<a name='2848'>
             DZ       = RTOPP*(DETA1(iz)*PDTOP+DETA2(iz)*pdA(ix))<a name='2849'>
             znext=z+dz<a name='2850'>
<a name='2851'>
             if(znext&gt;zB) then<a name='2852'>
                <font color=#447700>! Interpolate between these two levels<a name='2853'></font>
                weight=(zB-z)/dz<a name='2854'>
                pdB(ix) = exp(weight*log(pintA(iz+1,ix)) + &amp;<a name='2855'>
                              (1.0-weight)*log(pintA(iz,ix))) &amp;<a name='2856'>
                      - pdtop - ptop<a name='2857'>
<font color=#447700>!                if(iz&gt;1) then<a name='2858'></font>
<font color=#447700>!                   write(0,*) 'WARNING: interpolate above ground at ix=',ix<a name='2859'></font>
<font color=#447700>!1303               format('Interp at ix=',I0,' with iz=',I0,' zA=',F0.3,' zB=',F0.3,' zmslp=',F0.3,' weight=',F0.3,' pdB+pdtop+ptop=',F0.3,' pintA=',F0.3,' pdA(ix)+pdtop+ptop=',F0.3,' P_REF=',F0.3)<a name='2860'></font>
<font color=#447700>!                   write(0,1303) ix,iz,zA,zB,zmslp(ix),weight,pdB(ix)+pdtop+ptop,pintA(1,ix),pdA(ix)+pdtop+ptop,P_REF<a name='2861'></font>
<font color=#447700>!                endif<a name='2862'></font>
                cycle xloop<a name='2863'>
             else<a name='2864'>
                z=znext<a name='2865'>
             endif<a name='2866'>
<a name='2867'>
          enddo<a name='2868'>
<a name='2869'>
201       format('interp_T_PD_Q_kpres: Target domain surface height ',F0.4,'m is higher than the model top ',F0.4,'m of the source domain.  ABORTING')<a name='2870'>
          write(message,201) zB,znext<a name='2871'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1399">(message)<a name='2872'>
       enddo xloop<a name='2873'>
    else<a name='2874'>
202    format('Invalid value ',I0,' for pd_interp in interp_T_PD_Q')<a name='2875'>
       write(message,202) pd_interp<a name='2876'>
       call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1400">(message)<a name='2877'>
    endif if_pd_interp<a name='2878'>
<a name='2879'>
<a name='2880'>
<a name='2881'>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2882'></font>
    <font color=#447700>!! Step 3: interpolate T and Q in pressure space !!!!!!!!!!!!!<a name='2883'></font>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2884'></font>
<a name='2885'>
<a name='2886'>
<a name='2887'>
    outer: do ix=1,nx<a name='2888'>
       <font color=#447700>! For constant pressure levels, do a straight level-by-level copy:<a name='2889'></font>
       iz=nz2-1<a name='2890'>
       copyloop: do while(iz&gt;kpres)<a name='2891'>
          tB(iz,ix)=tA(iz,ix)<a name='2892'>
          qB(iz,ix)=qA(iz,ix)<a name='2893'>
<a name='2894'>
          <font color=#447700>! Save interpolation information<a name='2895'></font>
          iinfo(iz,ix)=iz<a name='2896'>
          winfo(iz,ix)=1.0<a name='2897'>
<a name='2898'>
          iz=iz-1<a name='2899'>
       enddo copyloop<a name='2900'>
<a name='2901'>
       <font color=#447700>! For sigma levels where target domain lies within source,<a name='2902'></font>
       <font color=#447700>! interpolate from top down, stopping when we go below ground<a name='2903'></font>
       <font color=#447700>! in the source domain.<a name='2904'></font>
       izA=iz<a name='2905'>
       izB=iz<a name='2906'>
<a name='2907'>
       <font color=#447700>! FIXME: REMOVE THIS CHECK<a name='2908'></font>
       if(iz&gt;nz2) then<a name='2909'>
          <font color=#447700>! Make sure the entire vertical extent isn't sigma levels:<a name='2910'></font>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_nmm.F.html#INTERP_T_PD_Q_KPRES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1401">('ERROR: WRF-NMM does not support pure sigma levels (only sigma-pressure hybrid)')<a name='2911'>
       endif<a name='2912'>
<a name='2913'>
       pB2=log(eta1(izB)*pdtop + eta2(izB)*pdB(ix) + ptop)<a name='2914'>
       pB1=log(eta1(izB+1)*pdtop + eta2(izB+1)*pdB(ix) + ptop)<a name='2915'>
       pB=(pB2+pB1)*0.5<a name='2916'>
<a name='2917'>
       pA2=log(eta1(izA)*pdtop + eta2(izA)*pdA(ix) + ptop)<a name='2918'>
       pA1=log(eta1(izA+1)*pdtop + eta2(izA+1)*pdA(ix) + ptop)<a name='2919'>
       pA=(pA2+pA1)*0.5<a name='2920'>
<a name='2921'>
       <font color=#447700>! Find the lowest mass level izA that is above pB<a name='2922'></font>
       interpinit: do while(izA&gt;1)<a name='2923'>
          pA3=log(eta1(izA-1)*pdtop + eta2(izA-1)*pdA(ix) + ptop)<a name='2924'>
          pnext=(pA2+pA3)*0.5<a name='2925'>
          wdenom=pnext-pA<a name='2926'>
          wnum=pnext-pb<a name='2927'>
          if(pA&lt;=pB .and. wnum&gt;1e-5) then<a name='2928'>
             exit interpinit<a name='2929'>
          else<a name='2930'>
             pA1=pA2<a name='2931'>
             pA2=pa3<a name='2932'>
             izA=izA-1<a name='2933'>
             pA=pnext<a name='2934'>
          endif<a name='2935'>
       enddo interpinit<a name='2936'>
<a name='2937'>
       <font color=#447700>! Loop over all remaining B points, interpolating to them.<a name='2938'></font>
       interploop: do while(izB&gt;0 .and. izA&gt;1)<a name='2939'>
          <font color=#447700>! Find the source domain levels that this target domain level lies between:<a name='2940'></font>
          zinterp: do while(izA&gt;1)<a name='2941'>
             if(pnext&gt;=pB) then<a name='2942'>
                <font color=#447700>! We found the two levels, so interpolate and move on to<a name='2943'></font>
                <font color=#447700>! the next target level:<a name='2944'></font>
                weight=max(0.,wnum/wdenom)<a name='2945'>
                tB(izB,ix)=weight*tA(izA,ix) + (1.0-weight)*tA(izA-1,ix)<a name='2946'>
                qB(izB,ix)=weight*qA(izA,ix) + (1.0-weight)*qA(izA-1,ix)<a name='2947'>
<a name='2948'>
                <font color=#447700>! Save interpolation info<a name='2949'></font>
                iinfo(izB,ix)=izA    <font color=#447700>! upper level<a name='2950'></font>
                winfo(izB,ix)=weight <font color=#447700>! linear interpolation weight<a name='2951'></font>
<a name='2952'>
                <font color=#447700>! We interpolated to a B point, so go to the next one:<a name='2953'></font>
                pB1=pB2<a name='2954'>
                izB=izB-1<a name='2955'>
                if(izB&gt;0) then<a name='2956'>
                   pB2=log(eta1(izB)*pdtop + eta2(izB)*pdB(ix) + ptop)<a name='2957'>
                   pB=(pb1+pb2)*0.5<a name='2958'>
                else<a name='2959'>
                   exit interploop<a name='2960'>
                endif<a name='2961'>
                wnum=pnext-pb<a name='2962'>
                <a name='2963'>
                exit zinterp<a name='2964'>
             else<a name='2965'>
                izA=izA-1<a name='2966'>
                pA1=pA2<a name='2967'>
                pA2=pa3<a name='2968'>
                pA=pnext<a name='2969'>
                if(izA&gt;1) then<a name='2970'>
                   pA3=log(eta1(izA-1)*pdtop + eta2(izA-1)*pdA(ix) + ptop)<a name='2971'>
                   pnext=(pA2+pA3)*0.5<a name='2972'>
                   wdenom=pnext-pa<a name='2973'>
                   wnum=pnext-pb<a name='2974'>
                else<a name='2975'>
                   exit interploop<a name='2976'>
                endif<a name='2977'>
             endif<a name='2978'>
          enddo zinterp<a name='2979'>
       enddo interploop<a name='2980'>
<a name='2981'>
       <font color=#447700>! Follow what base_state_parent did for temperature:<a name='2982'></font>
       <font color=#447700>! interpolate between the second to last level and P_REF using<a name='2983'></font>
       <font color=#447700>! a lapse rate atmosphere.  For Q, we use constant RH below<a name='2984'></font>
       <font color=#447700>! ground, as suggested by Greg Thompson.<a name='2985'></font>
       extraploop: do while(izB&gt;=1)<a name='2986'>
          <font color=#447700>! Decide extrapolation weight:<a name='2987'></font>
          weight=(pB-pA)/(pstd12-pA)<a name='2988'>
<a name='2989'>
          <font color=#447700>! Extrapolate Q by copying lowest sigma layer value:<a name='2990'></font>
          <font color=#447700>!qB(izB,ix)=qA(1,ix)<a name='2991'></font>
<a name='2992'>
          <font color=#447700>! Extrapolate Q by linearly interpolating between 0 and surface value:<a name='2993'></font>
          <font color=#447700>!qB(izB,ix)=(1.0-weight)*qA(1,ix)<a name='2994'></font>
<a name='2995'>
          <font color=#447700>! Extrapolate T using a lapse rate atmosphere<a name='2996'></font>
          tB(izB,ix)=weight*tbelow(ix) + (1.0-weight)*tA(1,ix)<a name='2997'>
<a name='2998'>
          <font color=#447700>! Extrapolate Q using constant RH below ground, as suggested<a name='2999'></font>
          <font color=#447700>! by Greg Thompson.  This is the inversion of the RH<a name='3000'></font>
          <font color=#447700>! calculation used earlier in this function:<a name='3001'></font>
          P0=eta1(izB)*pdtop + eta2(izB)*pdB(ix) + ptop<a name='3002'>
          QC=PQ0/P0*EXP(A2*(TB(izB,ix)-A3)/(TB(izB,ix)-A4))<a name='3003'>
          QB(izB,ix)=QC*RHbelow(ix)<a name='3004'>
<a name='3005'>
          <font color=#447700>! Save extrapolation information<a name='3006'></font>
          iinfo(izB,ix)=0<a name='3007'>
          winfo(izB,ix)=weight<a name='3008'>
<a name='3009'>
          <font color=#447700>! Move to the next B level<a name='3010'></font>
          izB=izB-1<a name='3011'>
          if(izB&gt;0) then<a name='3012'>
             pB1=pB2<a name='3013'>
             pB2=log(eta1(izB)*pdtop + eta2(izB)*pdB(ix) + ptop)<a name='3014'>
             pB=(pb1+pb2)*0.5<a name='3015'>
          endif<a name='3016'>
       enddo extraploop<a name='3017'>
    enddo outer<a name='3018'>
  end subroutine interp_T_PD_Q_kpres<a name='3019'>
end module module_interp_nmm<a name='3020'>
<a name='3021'>
<font color=#447700>! ********************************************************************<a name='3022'></font>
<font color=#447700>! subs EXT_*_FULLDOM -- simple wrappers around module_interp_nmm's<a name='3023'></font>
<font color=#447700>! *_FULLDOM routines.  These exist solely to allow module_dm to<a name='3024'></font>
<font color=#447700>! interface with this module -- this is needed because the WRF build<a name='3025'></font>
<font color=#447700>! scripts compile module_dm before module_interp_nmm.<a name='3026'></font>
<font color=#447700>! ********************************************************************<a name='3027'></font>
<a name='3028'>
<A NAME='EXT_C2N_FULLDOM'><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2N_FULLDOM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3029'>
<font color=#993300>subroutine </font><font color=#cc0000>ext_c2n_fulldom</font>  (II,JJ,W1,W2,W3,W4,&amp; <A href='../../call_to/EXT_C2N_FULLDOM.html' TARGET='index'>1</A>,<A href='../../call_from/EXT_C2N_FULLDOM.html' TARGET='index'>4</A><a name='3030'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='3031'>
       cpint,ct,cpd,cq,                 &amp;<a name='3032'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3033'>
       npint,nt,npd,nq,                 &amp;<a name='3034'>
       out_iinfo,out_winfo,imask,&amp;<a name='3035'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3036'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3037'>
       nits, nite, njts, njte, nkts, nkte)<a name='3038'>
  <font color=#447700>! This subroutine is an alias for c2n_fulldom.  It exists to allow<a name='3039'></font>
  <font color=#447700>! the routine to be called from module_dm<a name='3040'></font>
  use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2N_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_24">, only: parent_fis, nest_fis, kpres<a name='3041'>
  use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2N_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_22">, only: c2n_fulldom, find_kpres<a name='3042'>
  implicit none<a name='3043'>
  integer, intent(in):: cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3044'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3045'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3046'>
       nits, nite, njts, njte, nkts, nkte<a name='3047'>
  real, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: cT,cQ,cPINT<a name='3048'>
  real, intent(in), dimension(cims:cime,cjms:cjme,1) :: cPD<a name='3049'>
<a name='3050'>
  real, intent(out), dimension(nims:nime,njms:njme,nkms:nkme) :: out_winfo<a name='3051'>
  integer, intent(out), dimension(nims:nime,njms:njme,nkms:nkme) :: out_iinfo<a name='3052'>
<a name='3053'>
  real, intent(out), dimension(nims:nime,njms:njme,nkms:nkme) :: nT,nQ<a name='3054'>
  real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: nPINT<a name='3055'>
  real, intent(inout), dimension(nims:nime,njms:njme,1) :: nPD<a name='3056'>
  integer, intent(in), dimension(nims:nime,njms:njme) :: imask<a name='3057'>
<a name='3058'>
  real, intent(in), dimension(nims:nime,njms:njme) :: &amp;<a name='3059'>
       W1,W2,W3,W4<a name='3060'>
  integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='3061'>
<a name='3062'>
  real, intent(in), dimension(nkms:nkme) :: eta1,eta2,deta1,deta2<a name='3063'>
  real, intent(in) :: ptop,pdtop<a name='3064'>
  integer :: i,j,k<a name='3065'>
  logical :: badbad<a name='3066'>
<a name='3067'>
  call <A href='../../html_code/share/module_interp_nmm.F.html#FIND_KPRES'>find_kpres</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2N_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_KPRES_1">(kpres,eta2,nkds,nkde,nkms,nkme)<a name='3068'>
  call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_FULLDOM'>c2n_fulldom</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2N_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_FULLDOM_1">(II,JJ,W1,W2,W3,W4,&amp;<a name='3069'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='3070'>
       parent_fis,cpint,ct,cpd,cq,           &amp;<a name='3071'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3072'>
       nest_fis,npint,nt,npd,nq,             &amp;<a name='3073'>
       out_iinfo,out_winfo,imask,            &amp;<a name='3074'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3075'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3076'>
       nits, nite, njts, njte, nkts, nkte,   &amp;<a name='3077'>
       kpres)<a name='3078'>
<a name='3079'>
end subroutine ext_c2n_fulldom<a name='3080'>
<a name='3081'>
<A NAME='EXT_N2C_FULLDOM'><A href='../../html_code/share/module_interp_nmm.F.html#EXT_N2C_FULLDOM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3082'>
<font color=#993300>subroutine </font><font color=#cc0000>ext_n2c_fulldom</font>  ( &amp; <A href='../../call_to/EXT_N2C_FULLDOM.html' TARGET='index'>1</A>,<A href='../../call_from/EXT_N2C_FULLDOM.html' TARGET='index'>4</A><a name='3083'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='3084'>
       cpint,ct,cpd,cq,                 &amp;<a name='3085'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='3086'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3087'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='3088'>
       npint,nt,npd,nq,                 &amp;<a name='3089'>
       ipos,jpos,                            &amp;<a name='3090'>
       out_iinfo,out_winfo,      &amp;<a name='3091'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3092'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3093'>
       nits, nite, njts, njte, nkts, nkte)<a name='3094'>
  <font color=#447700>! This subroutine is an alias for n2c_fulldom.  It exists to allow<a name='3095'></font>
  <font color=#447700>! the routine to be called from module_dm<a name='3096'></font>
  use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_N2C_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_25">, only: parent_fis, nest_fis, kpres<a name='3097'>
  use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_N2C_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_23">, only: n2c_fulldom, find_kpres, n2c_fulldom_new<a name='3098'>
  implicit none<a name='3099'>
  integer, intent(in):: cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3100'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='3101'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='3102'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3103'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3104'>
       nits, nite, njts, njte, nkts, nkte,   &amp;<a name='3105'>
       ipos, jpos <font color=#447700>! nest start loctions within parent<a name='3106'></font>
  real, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: cT,cQ,cPINT<a name='3107'>
  real, intent(inout), dimension(cims:cime,cjms:cjme,1) :: cPD<a name='3108'>
<a name='3109'>
  real, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: out_winfo<a name='3110'>
  integer, intent(out), dimension(cims:cime,cjms:cjme,ckms:ckme) :: out_iinfo<a name='3111'>
<a name='3112'>
  real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: nT,nQ<a name='3113'>
  real, intent(in), dimension(nims:nime,njms:njme,nkms:nkme) :: nPINT<a name='3114'>
  real, intent(in), dimension(nims:nime,njms:njme,1) :: nPD<a name='3115'>
<a name='3116'>
  real, intent(in), dimension(nkms:nkme) :: eta1,eta2,deta1,deta2<a name='3117'>
  real, intent(in) :: ptop,pdtop<a name='3118'>
<a name='3119'>
  call <A href='../../html_code/share/module_interp_nmm.F.html#FIND_KPRES'>find_kpres</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_N2C_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_KPRES_2">(kpres,eta2,nkds,nkde,nkms,nkme)<a name='3120'>
  call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_FULLDOM_NEW'>n2c_fulldom_new</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_N2C_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_FULLDOM_NEW_1">( &amp;<a name='3121'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='3122'>
       parent_fis,cpint,ct,cpd,cq,           &amp;<a name='3123'>
       cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='3124'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3125'>
       cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='3126'>
       nest_fis,npint,nt,npd,nq,             &amp;<a name='3127'>
       ipos,jpos,                            &amp;<a name='3128'>
       out_iinfo,out_winfo,                  &amp;<a name='3129'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3130'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3131'>
       nits, nite, njts, njte, nkts, nkte, kpres)<a name='3132'>
end subroutine ext_n2c_fulldom<a name='3133'>
<a name='3134'>
<A NAME='EXT_C2B_FULLDOM'><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2B_FULLDOM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3135'>
<font color=#993300>subroutine </font><font color=#cc0000>ext_c2b_fulldom</font>  (II,JJ,W1,W2,W3,W4,&amp; <A href='../../call_to/EXT_C2B_FULLDOM.html' TARGET='index'>1</A>,<A href='../../call_from/EXT_C2B_FULLDOM.html' TARGET='index'>4</A><a name='3136'>
     deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='3137'>
     cpint,ct,cpd,cq,                      &amp;<a name='3138'>
     cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3139'>
     nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3140'>
     nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3141'>
     nits, nite, njts, njte, nkts, nkte,   &amp;<a name='3142'>
     ibxs,    ibxe,    ibys,    ibye,      &amp;<a name='3143'>
     wbxs,    wbxe,    wbys,    wbye,      &amp;<a name='3144'>
     pdbxs,   pdbxe,   pdbys,   pdbye,     &amp;<a name='3145'>
     tbxs,    tbxe,    tbys,    tbye,      &amp;<a name='3146'>
     qbxs,    qbxe,    qbys,    qbye)<a name='3147'>
  use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2B_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_24">, only: c2b_fulldom, find_kpres, c2b_fulldom_new<a name='3148'>
  use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2B_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_26">, only: parent_fis, nest_fis, kpres<a name='3149'>
  implicit none<a name='3150'>
  integer, intent(in):: &amp;<a name='3151'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3152'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3153'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3154'>
       nits, nite, njts, njte, nkts, nkte<a name='3155'>
  integer, parameter :: bdyw = 1<a name='3156'>
  <font color=#447700>! Domain info:<a name='3157'></font>
  real, intent(in), dimension(nims:nime,njms:njme) :: W1,W2,W3,W4<a name='3158'>
  integer, intent(in), dimension(nims:nime,njms:njme) :: II,JJ<a name='3159'>
  real, intent(in), dimension(nkms:nkme) :: eta1,eta2,deta1,deta2<a name='3160'>
  real, intent(in) :: ptop,pdtop<a name='3161'>
<a name='3162'>
  <font color=#447700>! Parent fields:<a name='3163'></font>
  real, intent(in), dimension(cims:cime,cjms:cjme,ckms:ckme) :: cT,cQ,cPINT<a name='3164'>
  real, intent(in), dimension(cims:cime,cjms:cjme,1) :: cPD<a name='3165'>
<a name='3166'>
  <font color=#447700>! T, Q, PINT, PD boundary info:<a name='3167'></font>
  real,dimension(nims:nime,nkms:nkme,bdyw) :: tbys,tbye,qbys,qbye<a name='3168'>
  real,dimension(njms:njme,nkms:nkme,bdyw) :: tbxs,tbxe,qbxs,qbxe<a name='3169'>
  real,dimension(nims:nime,1,bdyw) :: pdbys,pdbye<a name='3170'>
  real,dimension(njms:njme,1,bdyw) :: pdbxs,pdbxe<a name='3171'>
  <a name='3172'>
  <font color=#447700>! Weights and indices:<a name='3173'></font>
  real,dimension(nims:nime,nkms:nkme,bdyw) :: wbys,wbye<a name='3174'>
  real,dimension(njms:njme,nkms:nkme,bdyw) :: wbxs,wbxe<a name='3175'>
  integer,dimension(nims:nime,nkms:nkme,bdyw) :: ibys,ibye<a name='3176'>
  integer,dimension(njms:njme,nkms:nkme,bdyw) :: ibxs,ibxe<a name='3177'>
<a name='3178'>
  call <A href='../../html_code/share/module_interp_nmm.F.html#FIND_KPRES'>find_kpres</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2B_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_KPRES_3">(kpres,eta2,nkds,nkde,nkms,nkme)<a name='3179'>
  call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_FULLDOM_NEW'>c2b_fulldom_new</A><A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2B_FULLDOM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_FULLDOM_NEW_1">    (II,JJ,W1,W2,W3,W4,&amp;<a name='3180'>
       deta1,deta2, eta1,eta2, ptop,pdtop,   &amp;<a name='3181'>
       parent_fis,cpint,ct,cpd,cq,nest_fis,  &amp;<a name='3182'>
       cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='3183'>
       nids, nide, njds, njde, nkds, nkde,   &amp;<a name='3184'>
       nims, nime, njms, njme, nkms, nkme,   &amp;<a name='3185'>
       nits, nite, njts, njte, nkts, nkte,   &amp;<a name='3186'>
       kpres,                                &amp;<a name='3187'>
       ibxs,    ibxe,    ibys,    ibye,      &amp;<a name='3188'>
       wbxs,    wbxe,    wbys,    wbye,      &amp;<a name='3189'>
       pdbxs,   pdbxe,   pdbys,   pdbye,     &amp;<a name='3190'>
       tbxs,    tbxe,    tbys,    tbye,      &amp;<a name='3191'>
       qbxs,    qbxe,    qbys,    qbye)<a name='3192'>
end subroutine ext_c2b_fulldom<a name='3193'>
</pre></body></html>