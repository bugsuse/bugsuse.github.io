<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!<a name='2'></font>
<font color=#447700>!WRF:MEDIATION_LAYER:IO<a name='3'></font>
<font color=#447700>!<a name='4'></font>
#if (DA_CORE <font color=#447700>!= 1)<a name='5'></font>
<a name='6'>
<A NAME='MED_CALC_MODEL_TIME'><A href='../../html_code/share/mediation_integrate.F.html#MED_CALC_MODEL_TIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_calc_model_time</font> ( grid , config_flags ) <A href='../../call_to/MED_CALC_MODEL_TIME.html' TARGET='index'>1</A>,<A href='../../call_from/MED_CALC_MODEL_TIME.html' TARGET='index'>3</A><a name='8'>
  <font color=#447700>! Driver layer<a name='9'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_CALC_MODEL_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_331">    , ONLY : domain, domain_clock_get<a name='10'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_CALC_MODEL_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_208"> , ONLY : grid_config_rec_type<a name='11'>
  <font color=#447700>! Model layer<a name='12'></font>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_CALC_MODEL_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_16"><a name='13'>
<a name='14'>
   IMPLICIT NONE<a name='15'>
<a name='16'>
  <font color=#447700>! Arguments<a name='17'></font>
   TYPE(domain)                               :: grid<a name='18'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='19'>
<a name='20'>
  <font color=#447700>! Local data<a name='21'></font>
   REAL                                       :: time <a name='22'>
<a name='23'>
<font color=#447700>! this is now handled by with calls to time manager<a name='24'></font>
<font color=#447700>!   time = head_grid%dt * head_grid%total_time_steps<a name='25'></font>
<font color=#447700>!   CALL calc_current_date (grid%id, time)<a name='26'></font>
<a name='27'>
<a name='28'>
END SUBROUTINE med_calc_model_time<a name='29'>
<a name='30'>
<A NAME='MED_BEFORE_SOLVE_IO'><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='31'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_before_solve_io</font> ( grid , config_flags ) <A href='../../call_to/MED_BEFORE_SOLVE_IO.html' TARGET='index'>1</A>,<A href='../../call_from/MED_BEFORE_SOLVE_IO.html' TARGET='index'>27</A><a name='32'>
  <font color=#447700>! Driver layer<a name='33'></font>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_179"><a name='34'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_332">    , ONLY : domain, domain_clock_get<a name='35'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_209"> , ONLY : grid_config_rec_type<a name='36'>
   USE <A href='../../html_code/frame/module_streams.F.html#MODULE_STREAMS'>module_streams</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STREAMS_9"><a name='37'>
  <font color=#447700>! Model layer<a name='38'></font>
   USE module_utility<a name='39'>
<a name='40'>
   IMPLICIT NONE<a name='41'>
<a name='42'>
  <font color=#447700>! Arguments<a name='43'></font>
   TYPE(domain)                               :: grid<a name='44'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='45'>
  <font color=#447700>! Local<a name='46'></font>
   INTEGER                                    :: ialarm<a name='47'>
   INTEGER                                    :: rc<a name='48'>
   TYPE(WRFU_Time) :: currTime, startTime<a name='49'>
#if ( HWRF == 1 )<a name='50'>
   INTEGER :: hr, min, sec, ms,julyr,julday<a name='51'>
   REAL :: GMT<a name='52'>
#endif<a name='53'>
<a name='54'>
   CHARACTER*256          :: message<a name='55'>
<a name='56'>
<a name='57'>
 CALL WRFU_ClockGet( grid%domain_clock, CurrTime=currTime, StartTime=startTime )<a name='58'>
<a name='59'>
 IF( (WRFU_AlarmIsRinging( grid%alarms( HISTORY_ALARM ), rc=rc ) .AND. &amp;<a name='60'>
     (grid%dfi_write_dfi_history .OR. grid%dfi_stage == DFI_FST .OR. grid%dfi_opt == DFI_NODFI) )) THEN<a name='61'>
     IF       ( ( config_flags%restart )                    .AND. &amp;<a name='62'>
                ( config_flags%write_hist_at_0h_rst )       .AND. &amp;<a name='63'>
                ( currTime .EQ. startTime )                       ) THEN<a name='64'>
#if ( NMM_CORE == 1 )<a name='65'>
<font color=#447700>! NMM-only: outputs boundary arrays of certain variables:<a name='66'></font>
<font color=#447700>!      call med_boundary_out(grid,config_flags)<a name='67'></font>
#endif<a name='68'>
<a name='69'>
<a name='70'>
       <font color=#447700>!  output history at beginning of restart if alarm is ringing<a name='71'></font>
       CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT'>med_hist_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_HIST_OUT_2"> ( grid , HISTORY_ALARM, config_flags )<a name='72'>
      <a name='73'>
     ELSE IF  ( ( config_flags%restart )                    .AND. &amp;<a name='74'>
                ( .NOT. config_flags%write_hist_at_0h_rst ) .AND. &amp;<a name='75'>
                ( currTime .EQ. startTime )                       ) THEN<a name='76'>
       <font color=#447700>!  we do not do anything<a name='77'></font>
     ELSE<a name='78'>
       CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT'>med_hist_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_HIST_OUT_3"> ( grid , HISTORY_ALARM, config_flags )<a name='79'>
       <a name='80'>
     END IF<a name='81'>
     CALL WRFU_AlarmRingerOff( grid%alarms( HISTORY_ALARM ), rc=rc )<a name='82'>
   ELSE IF  ( (config_flags%restart) .AND. ( currTime .EQ. startTime ) .AND. &amp;<a name='83'>
              ( config_flags%write_hist_at_0h_rst ) ) THEN<a name='84'>
     <font color=#447700>!  output history at beginning of restart even if alarm is not ringing<a name='85'></font>
     CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT'>med_hist_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_HIST_OUT_4"> ( grid , HISTORY_ALARM, config_flags )<a name='86'>
     CALL WRFU_AlarmRingerOff( grid%alarms( HISTORY_ALARM ), rc=rc )<a name='87'>
   ENDIF<a name='88'>
<a name='89'>
   IF( WRFU_AlarmIsRinging( grid%alarms( INPUTOUT_ALARM ), rc=rc ) ) THEN<a name='90'>
     CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT'>med_filter_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_FILTER_OUT_1">  ( grid , config_flags )<a name='91'>
     CALL WRFU_AlarmRingerOff( grid%alarms( INPUTOUT_ALARM ), rc=rc )<a name='92'>
   ENDIF<a name='93'>
<a name='94'>
   DO ialarm = first_auxhist, last_auxhist<a name='95'>
     IF ( .FALSE.) THEN<a name='96'>
       rc = 1  <font color=#447700>! dummy statement<a name='97'></font>
     ELSE IF( WRFU_AlarmIsRinging( grid%alarms( ialarm ), rc=rc ) ) THEN<a name='98'>
<font color=#447700>!----------------------------------------------------------------------<a name='99'></font>
<font color=#447700>! RASM Climate Diagnostics - JR, AS, MS  - October 2016<a name='100'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='101'></font>
       IF  ( (ialarm .EQ.  AUXHIST5_ALARM) .AND. (config_flags%restart) .AND. ( currTime .EQ. startTime ) ) THEN<a name='102'>
         <font color=#447700>!  no AVG history output on the first time of the restart<a name='103'></font>
       ELSE IF  ( (ialarm .EQ.  AUXHIST6_ALARM) .AND. (config_flags%restart) .AND. ( currTime .EQ. startTime ) ) THEN<a name='104'>
         <font color=#447700>!  no DIURNAL history output on the first time of the restart<a name='105'></font>
       ELSE IF ( grid%dfi_stage == DFI_FST .OR. grid%dfi_opt == DFI_NODFI ) THEN<a name='106'>
         CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT'>med_hist_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_HIST_OUT_5"> ( grid , ialarm, config_flags )<a name='107'>
       ENDIF<a name='108'>
<font color=#447700>!----------------------------------------------------------------------<a name='109'></font>
<font color=#447700>! end RASM Climate Diagnostics<a name='110'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='111'></font>
       CALL WRFU_AlarmRingerOff( grid%alarms( ialarm ), rc=rc )<a name='112'>
     ENDIF<a name='113'>
   ENDDO<a name='114'>
<a name='115'>
   DO ialarm = first_auxinput, last_auxinput<a name='116'>
     IF ( .FALSE.) THEN<a name='117'>
       rc = 1  <font color=#447700>! dummy statement<a name='118'></font>
#if ( WRF_CHEM == 1 )<a name='119'>
<font color=#447700>! - Get chemistry data<a name='120'></font>
     ELSE IF( ialarm .EQ. AUXINPUT5_ALARM .AND. config_flags%chem_opt &gt; 0 ) THEN<a name='121'>
       IF( config_flags%emiss_inpt_opt /= 0 ) THEN<a name='122'>
         IF( WRFU_AlarmIsRinging( grid%alarms( ialarm ), rc=rc ) .OR.  &amp;<a name='123'>
         ((config_flags%restart) .AND. ( currTime .EQ. startTime ))) THEN<a name='124'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_943">(15,' CALL med_read_wrf_chem_emiss ')<a name='125'>
           CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS'>med_read_wrf_chem_emiss</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_EMISS_1"> ( grid , config_flags )<a name='126'>
           CALL WRFU_AlarmRingerOff( grid%alarms( ialarm ), rc=rc )<a name='127'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_944">(15,' Back from CALL med_read_wrf_chem_emiss ')<a name='128'>
         ENDIF<a name='129'>
       ELSE<a name='130'>
         IF( WRFU_AlarmIsRinging( grid%alarms( ialarm ), rc=rc ) ) THEN<a name='131'>
           CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN'>med_auxinput_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AUXINPUT_IN_1"> ( grid, ialarm, config_flags )<a name='132'>
           CALL WRFU_AlarmRingerOff( grid%alarms( ialarm ), rc=rc )<a name='133'>
         ENDIF<a name='134'>
       ENDIF<a name='135'>
     ELSE IF(( ialarm .EQ. AUXINPUT7_ALARM .AND. config_flags%chem_opt &gt; 0 ) .or.  &amp;<a name='136'>
             ( ialarm .EQ. AUXINPUT7_ALARM .AND. config_flags%tracer_opt &gt; 0 ) )THEN<a name='137'>
       IF( config_flags%biomass_burn_opt /= 0 ) THEN<a name='138'>
         IF( WRFU_AlarmIsRinging( grid%alarms( ialarm ), rc=rc ) .OR.  &amp;<a name='139'>
         ((config_flags%restart) .AND. ( currTime .EQ. startTime ))) THEN<a name='140'>
           CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN'>med_auxinput_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AUXINPUT_IN_2"> ( grid, ialarm, config_flags )<a name='141'>
           WRITE ( message , FMT='(A,i3,A,i3)') 'Input data processed for aux input ',&amp;<a name='142'>
                  ialarm - first_auxinput + 1, ' for domain ',grid%id<a name='143'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_945"> ( 15 , message )<a name='144'>
           CALL WRFU_AlarmRingerOff( grid%alarms( ialarm ), rc=rc )<a name='145'>
         ENDIF<a name='146'>
       ELSE<a name='147'>
        IF( WRFU_AlarmIsRinging( grid%alarms( ialarm ), rc=rc ) ) THEN<a name='148'>
          CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN'>med_auxinput_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AUXINPUT_IN_3"> ( grid, ialarm, config_flags )<a name='149'>
          CALL WRFU_AlarmRingerOff( grid%alarms( ialarm ), rc=rc )<a name='150'>
        ENDIF<a name='151'>
       ENDIF<a name='152'>
     ELSE IF( ialarm .EQ. AUXINPUT13_ALARM .AND. config_flags%chem_opt &gt; 0 ) THEN<a name='153'>
       IF( config_flags%emiss_opt_vol /= 0 ) THEN<a name='154'>
         IF( WRFU_AlarmIsRinging( grid%alarms( ialarm ), rc=rc ) ) THEN<a name='155'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_946">(15,' CALL med_read_wrf_volc_emiss ')<a name='156'>
           CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS'>med_read_wrf_volc_emiss</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_VOLC_EMISS_1"> ( grid , config_flags )<a name='157'>
           CALL WRFU_AlarmRingerOff( grid%alarms( ialarm ), rc=rc )<a name='158'>
           call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_947">(15,' Back from CALL med_read_wrf_volc_emiss ')<a name='159'>
         ENDIF<a name='160'>
       ELSE<a name='161'>
         IF( WRFU_AlarmIsRinging( grid%alarms( ialarm ), rc=rc ) ) THEN<a name='162'>
           CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN'>med_auxinput_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AUXINPUT_IN_4"> ( grid, ialarm, config_flags )<a name='163'>
           CALL WRFU_AlarmRingerOff( grid%alarms( ialarm ), rc=rc )<a name='164'>
         ENDIF<a name='165'>
       ENDIF<a name='166'>
#endif<a name='167'>
#if ( EM_CORE == 1 )<a name='168'>
     ELSE IF( ialarm .EQ. AUXINPUT11_ALARM ) THEN<a name='169'>
       IF( config_flags%obs_nudge_opt .EQ. 1) THEN<a name='170'>
         CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_FDDAOBS_IN'>med_fddaobs_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_FDDAOBS_IN_1"> ( grid , config_flags )<a name='171'>
       ENDIF<a name='172'>
#endif<a name='173'>
     ELSE IF( WRFU_AlarmIsRinging( grid%alarms( ialarm ), rc=rc ) ) THEN<a name='174'>
       CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN'>med_auxinput_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AUXINPUT_IN_5"> ( grid, ialarm, config_flags )<a name='175'>
       WRITE ( message , FMT='(A,i3,A,i3)' )  'Input data processed for aux input ' , &amp;<a name='176'>
          ialarm - first_auxinput + 1, ' for domain ',grid%id<a name='177'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_948"> ( 0 , message )<a name='178'>
       CALL WRFU_AlarmRingerOff( grid%alarms( ialarm ), rc=rc )<a name='179'>
     ENDIF<a name='180'>
   ENDDO<a name='181'>
<a name='182'>
<font color=#447700>! - RESTART OUTPUT<a name='183'></font>
   CALL WRFU_ClockGet( grid%domain_clock, CurrTime=currTime, StartTime=startTime )<a name='184'>
   IF ( ( WRFU_AlarmIsRinging( grid%alarms( RESTART_ALARM ), rc=rc ) ) .AND. &amp;<a name='185'>
        ( currTime .NE. startTime ) ) THEN<a name='186'>
#if ( HWRF == 1 )<a name='187'>
<font color=#447700>!zhang's doing<a name='188'></font>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_44">( grid, current_time=CurrTime )<a name='189'>
     CALL WRFU_TimeGet( CurrTime, YY=julyr, dayOfYear=julday, H=hr, M=min, S=sec, MS=ms, rc=rc)<a name='190'>
     gmt=hr+real(min)/60.+real(sec)/3600.+real(ms)/(1000*3600)<a name='191'>
      if (grid%id .eq. 2) call <A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT'>med_namelist_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NAMELIST_OUT_1"> ( grid , config_flags )<a name='192'>
<font color=#447700>!end of zhang's doing<a name='193'></font>
#endif<a name='194'>
     IF ( grid%id .EQ. 1 ) THEN<a name='195'>
       <font color=#447700>! Only the parent initiates the restart writing. Otherwise, different<a name='196'></font>
       <font color=#447700>! domains may be written out at different times and with different <a name='197'></font>
       <font color=#447700>! time stamps in the file names.<a name='198'></font>
       CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT'>med_restart_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_RESTART_OUT_2"> ( grid , config_flags )<a name='199'>
     ENDIF<a name='200'>
     CALL WRFU_AlarmRingerOff( grid%alarms( RESTART_ALARM ), rc=rc )<a name='201'>
   ELSE<a name='202'>
     CALL WRFU_AlarmRingerOff( grid%alarms( RESTART_ALARM ), rc=rc )<a name='203'>
   ENDIF<a name='204'>
<a name='205'>
<font color=#447700>! - Look for boundary data after writing out history and restart files<a name='206'></font>
   CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN'>med_latbound_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_LATBOUND_IN_1"> ( grid , config_flags )<a name='207'>
<a name='208'>
   RETURN<a name='209'>
END SUBROUTINE med_before_solve_io<a name='210'>
<a name='211'>
<A NAME='MED_AFTER_SOLVE_IO'><A href='../../html_code/share/mediation_integrate.F.html#MED_AFTER_SOLVE_IO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='212'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_after_solve_io</font> ( grid , config_flags ) <A href='../../call_to/MED_AFTER_SOLVE_IO.html' TARGET='index'>1</A>,<A href='../../call_from/MED_AFTER_SOLVE_IO.html' TARGET='index'>5</A><a name='213'>
  <font color=#447700>! Driver layer<a name='214'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AFTER_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_333">    , ONLY : domain<a name='215'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AFTER_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_47"><a name='216'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AFTER_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_210"> , ONLY : grid_config_rec_type<a name='217'>
  <font color=#447700>! Model layer<a name='218'></font>
<a name='219'>
   IMPLICIT NONE<a name='220'>
<a name='221'>
  <font color=#447700>! Arguments<a name='222'></font>
   TYPE(domain)                               :: grid<a name='223'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='224'>
<a name='225'>
   <font color=#447700>! Compute time series variables<a name='226'></font>
   CALL <A href='../../html_code/share/wrf_timeseries.F.html#CALC_TS'>calc_ts</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AFTER_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_TS_1">(grid)<a name='227'>
<a name='228'>
   <font color=#447700>! Compute track variables <a name='229'></font>
   CALL <A href='../../html_code/share/track_driver.F.html#TRACK_DRIVER'>track_driver</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AFTER_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRACK_DRIVER_1">(grid)<a name='230'>
<a name='231'>
   RETURN<a name='232'>
END SUBROUTINE med_after_solve_io<a name='233'>
<a name='234'>
<A NAME='MED_PRE_NEST_INITIAL'><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='235'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_pre_nest_initial</font> ( parent , newid , config_flags ) <A href='../../call_to/MED_PRE_NEST_INITIAL.html' TARGET='index'>1</A>,<A href='../../call_from/MED_PRE_NEST_INITIAL.html' TARGET='index'>11</A><a name='236'>
  <font color=#447700>! Driver layer<a name='237'></font>
#ifdef MOVE_NESTS<a name='238'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_334">    , ONLY : domain, domain_clock_get<a name='239'>
#else<a name='240'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_335">    , ONLY : domain<a name='241'>
#endif<a name='242'>
#ifdef ESMFIO<a name='243'>
   USE module_utility   , ONLY : WRFU_Time <a name='244'>
#else<a name='245'>
   USE module_utility   , ONLY : WRFU_Time, WRFU_TimeEQ<a name='246'>
#endif<a name='247'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_48"><a name='248'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_24"><a name='249'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_211"> , ONLY : grid_config_rec_type<a name='250'>
  <font color=#447700>! Model layer<a name='251'></font>
<a name='252'>
   IMPLICIT NONE<a name='253'>
<a name='254'>
  <font color=#447700>! Arguments<a name='255'></font>
   TYPE(domain) , POINTER                      :: parent<a name='256'>
   INTEGER, INTENT(IN)                         :: newid<a name='257'>
   TYPE (grid_config_rec_type) , INTENT(INOUT) :: config_flags<a name='258'>
   TYPE (grid_config_rec_type)                 :: nest_config_flags<a name='259'>
<a name='260'>
  <font color=#447700>! Local<a name='261'></font>
   INTEGER                :: itmp, fid, ierr, icnt<a name='262'>
   CHARACTER*256          :: rstname, message, timestr<a name='263'>
<a name='264'>
   TYPE(WRFU_Time)        :: strt_time, cur_time<a name='265'>
<a name='266'>
#ifdef MOVE_NESTS<a name='267'>
<a name='268'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_45">( parent, current_timestr=timestr, start_time=strt_time, current_time=cur_time )<a name='269'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_11"> ( rstname , config_flags%rst_inname , newid , 2 , timestr )<a name='270'>
<a name='271'>
#ifdef ESMFIO<a name='272'>
    IF ( config_flags%restart .AND. (cur_time .EQ. strt_time) ) THEN<a name='273'>
#else<a name='274'>
    IF ( config_flags%restart .AND. WRFU_TimeEQ(cur_time,strt_time) ) THEN<a name='275'>
#endif<a name='276'>
     WRITE(message,*)'RESTART: nest, opening ',TRIM(rstname),' for reading header information only'<a name='277'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1149"> ( message )<a name='278'>
  <font color=#447700>! note that the parent pointer is not strictly correct, but nest is not allocated yet and<a name='279'></font>
  <font color=#447700>! only the i/o communicator fields are used from "parent" (and those are dummies in current<a name='280'></font>
  <font color=#447700>! implementation.<a name='281'></font>
     CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_11"> ( fid , TRIM(rstname) , parent , config_flags , "DATASET=RESTART", ierr )<a name='282'>
     IF ( ierr .NE. 0 ) THEN<a name='283'>
       WRITE( message , '("program wrf: error opening ",A32," for reading")') TRIM(rstname)<a name='284'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1332"> ( message )<a name='285'>
     ENDIF<a name='286'>
<a name='287'>
  <font color=#447700>! update the values of parent_start that were read in from the namelist (nest may have moved)<a name='288'></font>
     CALL wrf_get_dom_ti_integer ( fid , 'I_PARENT_START' ,  itmp  , 1 , icnt, ierr )<a name='289'>
     IF ( ierr .EQ. 0 ) THEN<a name='290'>
       config_flags%i_parent_start = itmp<a name='291'>
       CALL nl_set_i_parent_start ( newid , config_flags%i_parent_start )<a name='292'>
     ENDIF<a name='293'>
     CALL wrf_get_dom_ti_integer ( fid , 'J_PARENT_START' ,  itmp  , 1 , icnt, ierr )<a name='294'>
     IF ( ierr .EQ. 0 ) THEN<a name='295'>
       config_flags%j_parent_start = itmp<a name='296'>
       CALL nl_set_j_parent_start ( newid , config_flags%j_parent_start )<a name='297'>
     ENDIF<a name='298'>
<a name='299'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_26"> ( fid , config_flags , "DATASET=RESTART" )<a name='300'>
   ENDIF<a name='301'>
#endif<a name='302'>
<a name='303'>
END SUBROUTINE med_pre_nest_initial<a name='304'>
<a name='305'>
<a name='306'>
<A NAME='MED_NEST_INITIAL'><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='307'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_nest_initial</font> ( parent , nest , config_flags ) <A href='../../call_to/MED_NEST_INITIAL.html' TARGET='index'>2</A>,<A href='../../call_from/MED_NEST_INITIAL.html' TARGET='index'>110</A><a name='308'>
  <font color=#447700>! Driver layer<a name='309'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_336">    , ONLY : domain , domain_clock_get , get_ijk_from_grid<a name='310'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_49"><a name='311'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_25"><a name='312'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_212"> , ONLY : grid_config_rec_type<a name='313'>
   USE module_utility<a name='314'>
#ifdef DM_PARALLEL<a name='315'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_178">, ONLY : local_communicator,                                     &amp;<a name='316'>
                         mpi_comm_to_mom, mpi_comm_to_kid, which_kid<a name='317'>
#endif<a name='318'>
  <font color=#447700>! Model layer<a name='319'></font>
<a name='320'>
   IMPLICIT NONE<a name='321'>
<a name='322'>
  <font color=#447700>! Arguments<a name='323'></font>
   TYPE(domain) , POINTER                     :: parent, nest<a name='324'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='325'>
   TYPE (grid_config_rec_type)                :: nest_config_flags<a name='326'>
<a name='327'>
  <font color=#447700>! Local<a name='328'></font>
   LOGICAL, EXTERNAL      :: wrf_dm_on_monitor<a name='329'>
   TYPE(WRFU_Time)        :: strt_time, cur_time<a name='330'>
   CHARACTER * 256        :: rstname , timestr<a name='331'>
   CHARACTER * 256        :: message<a name='332'>
   INTEGER                :: fid<a name='333'>
   INTEGER                :: ierr<a name='334'>
   INTEGER                :: i , j, rc<a name='335'>
   INTEGER                :: ids , ide , jds , jde , kds , kde , &amp;<a name='336'>
                             ims , ime , jms , jme , kms , kme , &amp;<a name='337'>
                             ips , ipe , jps , jpe , kps , kpe<a name='338'>
<a name='339'>
#if (EM_CORE == 1)<a name='340'>
#ifdef MOVE_NESTS<a name='341'>
   TYPE (WRFU_TimeInterval) :: interval, TimeSinceStart<a name='342'>
   INTEGER :: vortex_interval , n<a name='343'>
#endif<a name='344'>
   INTEGER                :: save_itimestep <font color=#447700>! This is a kludge, correct fix will <a name='345'></font>
                                            <font color=#447700>! involve integrating the time-step<a name='346'></font>
                                            <font color=#447700>! counting into the time manager.<a name='347'></font>
                                            <font color=#447700>! JM 20040604<a name='348'></font>
   REAL, ALLOCATABLE, DIMENSION(:,:) ::   save_acsnow             &amp;<a name='349'>
                                         ,save_acsnom             &amp;<a name='350'>
                                         ,save_cuppt              &amp;<a name='351'>
                                         ,save_rainc              &amp;<a name='352'>
                                         ,save_rainnc             &amp;<a name='353'>
                                         ,save_sfcevp             &amp;<a name='354'>
                                         ,save_sfcrunoff          &amp;<a name='355'>
                                         ,save_udrunoff<a name='356'>
<a name='357'>
<a name='358'>
   INTERFACE<a name='359'>
     SUBROUTINE med_interp_domain ( parent , nest )<a name='360'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_337">       , ONLY : domain<a name='361'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='362'>
     END SUBROUTINE med_interp_domain<a name='363'>
<a name='364'>
    <font color=#447700>!KAL<a name='365'></font>
     SUBROUTINE init_domain_vert_nesting ( parent, nest, use_baseparam_fr_nml )<a name='366'>
    <font color=#447700>!KAL this is a driver to initialize the vertical coordinates for the nest when vertical nesting is used.<a name='367'></font>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_338">, ONLY : domain<a name='368'>
       IMPLICIT NONE<a name='369'>
       TYPE(domain), POINTER                      :: parent, nest<a name='370'>
       LOGICAL                                    :: use_baseparam_fr_nml<a name='371'>
     END SUBROUTINE init_domain_vert_nesting<a name='372'>
<a name='373'>
     SUBROUTINE med_interp_domain_small ( parent , nest )<a name='374'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_339">       , ONLY : domain<a name='375'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='376'>
     END SUBROUTINE med_interp_domain_small<a name='377'>
<a name='378'>
     SUBROUTINE med_initialdata_input_ptr( nest , config_flags )<a name='379'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_340">       , ONLY : domain<a name='380'>
        USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_213">    , ONLY : grid_config_rec_type<a name='381'>
        TYPE (grid_config_rec_type), INTENT(IN) :: config_flags<a name='382'>
        TYPE(domain) , POINTER :: nest<a name='383'>
     END SUBROUTINE med_initialdata_input_ptr<a name='384'>
<a name='385'>
     SUBROUTINE med_nest_feedback ( parent , nest , config_flags )<a name='386'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_341">        , ONLY : domain<a name='387'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_214">     , ONLY : grid_config_rec_type<a name='388'>
       TYPE (domain), POINTER ::  nest , parent<a name='389'>
       TYPE (grid_config_rec_type), INTENT(IN) :: config_flags<a name='390'>
     END SUBROUTINE med_nest_feedback<a name='391'>
<a name='392'>
     SUBROUTINE start_domain ( grid , allowed_to_move )<a name='393'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_342">       , ONLY : domain<a name='394'>
        TYPE(domain) :: grid<a name='395'>
        LOGICAL, INTENT(IN) :: allowed_to_move<a name='396'>
     END SUBROUTINE start_domain<a name='397'>
<a name='398'>
     SUBROUTINE  blend_terrain ( ter_interpolated , ter_input , &amp;<a name='399'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='400'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='401'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='402'>
       INTEGER                           :: ids , ide , jds , jde , kds , kde , &amp;<a name='403'>
                                            ims , ime , jms , jme , kms , kme , &amp;<a name='404'>
                                            ips , ipe , jps , jpe , kps , kpe<a name='405'>
       REAL , DIMENSION(ims:ime,jms:jme) :: ter_interpolated<a name='406'>
       REAL , DIMENSION(ims:ime,jms:jme) :: ter_input<a name='407'>
     END SUBROUTINE blend_terrain<a name='408'>
<a name='409'>
     SUBROUTINE  copy_3d_field ( ter_interpolated , ter_input , &amp;<a name='410'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='411'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='412'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='413'>
       INTEGER                           :: ids , ide , jds , jde , kds , kde , &amp;<a name='414'>
                                            ims , ime , jms , jme , kms , kme , &amp;<a name='415'>
                                            ips , ipe , jps , jpe , kps , kpe<a name='416'>
       REAL , DIMENSION(ims:ime,jms:jme) :: ter_interpolated<a name='417'>
       REAL , DIMENSION(ims:ime,jms:jme) :: ter_input<a name='418'>
     END SUBROUTINE copy_3d_field<a name='419'>
<a name='420'>
     SUBROUTINE  input_terrain_rsmas ( grid ,                  &amp;<a name='421'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='422'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='423'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='424'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_343">        , ONLY : domain<a name='425'>
       TYPE ( domain ) :: grid<a name='426'>
       INTEGER                           :: ids , ide , jds , jde , kds , kde , &amp;<a name='427'>
                                            ims , ime , jms , jme , kms , kme , &amp;<a name='428'>
                                            ips , ipe , jps , jpe , kps , kpe<a name='429'>
     END SUBROUTINE input_terrain_rsmas<a name='430'>
<a name='431'>
     SUBROUTINE wrf_tsin ( grid , ierr )<a name='432'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_344"><a name='433'>
        TYPE ( domain ), INTENT(INOUT) :: grid<a name='434'>
        INTEGER, INTENT(INOUT) :: ierr<a name='435'>
     END SUBROUTINE wrf_tsin<a name='436'>
<a name='437'>
   END INTERFACE<a name='438'>
<a name='439'>
   CALL <A href='../../html_code/share/interp_fcn.F.html#INTERP_INIT'>interp_init</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_INIT_1"><a name='440'>
<a name='441'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_46">( parent, start_time=strt_time, current_time=cur_time )<a name='442'>
<a name='443'>
   IF ( .not. ( config_flags%restart .AND. strt_time .EQ. cur_time ) ) THEN<a name='444'>
     nest%first_force = .true.<a name='445'>
<a name='446'>
     IF ( nest%active_this_task ) THEN<a name='447'>
<font color=#447700>! initialize nest with interpolated data from the parent<a name='448'></font>
       nest%imask_nostag = 1<a name='449'>
       nest%imask_xstag = 1<a name='450'>
       nest%imask_ystag = 1<a name='451'>
       nest%imask_xystag = 1<a name='452'>
     ENDIF<a name='453'>
<a name='454'>
#ifdef MOVE_NESTS<a name='455'>
     parent%nest_pos = parent%ht<a name='456'>
     where ( parent%nest_pos .gt. 0. ) parent%nest_pos = parent%nest_pos + 500.  <font color=#447700>! make a cliff<a name='457'></font>
#endif<a name='458'>
<a name='459'>
<font color=#447700>! initialize some other constants (and 1d arrays in z)<a name='460'></font>
     CALL <A href='../../html_code/share/mediation_integrate.F.html#INIT_DOMAIN_CONSTANTS'>init_domain_constants</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_DOMAIN_CONSTANTS_1"> ( parent, nest )<a name='461'>
<a name='462'>
     if (nest%e_vert /= parent%e_vert) then<a name='463'>
         <font color=#447700>! set up coordinate variables for nest with vertical grid refinement (1d variables in z are done later in med_interp_domain)<a name='464'></font>
       CALL <A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_VERT_NESTING'>init_domain_vert_nesting</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_DOMAIN_VERT_NESTING_1"> ( parent, nest, config_flags%use_baseparam_fr_nml )<a name='465'>
     endif<a name='466'>
<a name='467'>
<a name='468'>
<font color=#447700>! fill in entire fine grid domain with interpolated coarse grid data<a name='469'></font>
     CALL <A href='../../html_code/share/mediation_interp_domain.F.html#MED_INTERP_DOMAIN'>med_interp_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INTERP_DOMAIN_2">( parent, nest )<a name='470'>
<a name='471'>
<font color=#447700>!  De-reference dimension information stored in the grid data structure.<a name='472'></font>
     CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_100"> (  nest ,                   &amp;<a name='473'>
                               ids, ide, jds, jde, kds, kde,    &amp;<a name='474'>
                               ims, ime, jms, jme, kms, kme,    &amp;<a name='475'>
                               ips, ipe, jps, jpe, kps, kpe    )<a name='476'>
  <a name='477'>
<font color=#447700>! get the nest config flags<a name='478'></font>
     CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_63"> ( nest%id , model_config_rec , nest_config_flags )<a name='479'>
<a name='480'>
     IF ( nest_config_flags%input_from_file .OR. nest_config_flags%input_from_hires ) THEN<a name='481'>
<a name='482'>
       WRITE(message,FMT='(A,I2,A)') '*** Initializing nest domain #',nest%id,&amp;<a name='483'>
                                      ' from an input file. ***'<a name='484'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_949"> ( 0 , message )<a name='485'>
<a name='486'>
<font color=#447700>! Store horizontally interpolated terrain-based fields in temp location if the input<a name='487'></font>
<font color=#447700>! data is from a pristine, un-cycled model input file.  For the original topo from<a name='488'></font>
<font color=#447700>! the real program, we will need to adjust the terrain (and a couple of other base-<a name='489'></font>
<font color=#447700>! state fields) so reflect the smoothing and matching between the parent and child<a name='490'></font>
<font color=#447700>! domains.<a name='491'></font>
<a name='492'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_2"> ( nest%ht_int  , nest%ht , &amp;<a name='493'>
                             ids , ide , jds , jde , 1   , 1   , &amp;<a name='494'>
                             ims , ime , jms , jme , 1   , 1   , &amp;<a name='495'>
                             ips , ipe , jps , jpe , 1   , 1   )<a name='496'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_3"> ( nest%mub_fine , nest%mub , &amp;<a name='497'>
                             ids , ide , jds , jde , 1   , 1   , &amp;<a name='498'>
                             ims , ime , jms , jme , 1   , 1   , &amp;<a name='499'>
                             ips , ipe , jps , jpe , 1   , 1   )<a name='500'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_4"> ( nest%phb_fine , nest%phb , &amp;<a name='501'>
                             ids , ide , jds , jde , kds , kde , &amp;<a name='502'>
                             ims , ime , jms , jme , kms , kme , &amp;<a name='503'>
                             ips , ipe , jps , jpe , kps , kpe )<a name='504'>
<a name='505'>
       IF ( nest_config_flags%input_from_file ) THEN<a name='506'>
<font color=#447700>! read input from dataset<a name='507'></font>
          CALL <A href='../../html_code/share/mediation_wrfmain.F.html#MED_INITIALDATA_INPUT_PTR'>med_initialdata_input_ptr</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INITIALDATA_INPUT_PTR_1">( nest , nest_config_flags )<a name='508'>
<a name='509'>
       ELSE IF ( nest_config_flags%input_from_hires ) THEN<a name='510'>
<font color=#447700>! read in high res topography<a name='511'></font>
          CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS'>input_terrain_rsmas</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_TERRAIN_RSMAS_1"> ( nest,                               &amp;<a name='512'>
                                      ids , ide , jds , jde , 1   , 1   , &amp;<a name='513'>
                                      ims , ime , jms , jme , 1   , 1   , &amp;<a name='514'>
                                      ips , ipe , jps , jpe , 1   , 1   )<a name='515'>
       ENDIF<a name='516'>
<a name='517'>
       <font color=#447700>! save elevation and mub for temp and qv adjustment<a name='518'></font>
<a name='519'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_5"> ( nest%ht_fine , nest%ht , &amp;<a name='520'>
                             ids , ide , jds , jde , 1   , 1   , &amp;<a name='521'>
                             ims , ime , jms , jme , 1   , 1   , &amp;<a name='522'>
                             ips , ipe , jps , jpe , 1   , 1   )<a name='523'>
       CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_6"> ( nest%mub_save , nest%mub , &amp;<a name='524'>
                             ids , ide , jds , jde , 1   , 1   , &amp;<a name='525'>
                             ims , ime , jms , jme , 1   , 1   , &amp;<a name='526'>
                             ips , ipe , jps , jpe , 1   , 1   )<a name='527'>
<a name='528'>
<font color=#447700>! blend parent and nest fields: terrain, mub, and phb.  The ht, mub and phb are used in start_domain.<a name='529'></font>
<a name='530'>
       IF ( nest%save_topo_from_real == 1 ) THEN<a name='531'>
          CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN'>blend_terrain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLEND_TERRAIN_2"> ( nest%ht_int  , nest%ht , &amp;<a name='532'>
                                ids , ide , jds , jde , 1   , 1   , &amp;<a name='533'>
                                ims , ime , jms , jme , 1   , 1   , &amp;<a name='534'>
                                ips , ipe , jps , jpe , 1   , 1   )<a name='535'>
          CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN'>blend_terrain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLEND_TERRAIN_3"> ( nest%mub_fine , nest%mub , &amp;<a name='536'>
                                ids , ide , jds , jde , 1   , 1   , &amp;<a name='537'>
                                ims , ime , jms , jme , 1   , 1   , &amp;<a name='538'>
                                ips , ipe , jps , jpe , 1   , 1   )<a name='539'>
          CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN'>blend_terrain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLEND_TERRAIN_4"> ( nest%phb_fine , nest%phb , &amp;<a name='540'>
                                ids , ide , jds , jde , kds , kde , &amp;<a name='541'>
                                ims , ime , jms , jme , kms , kme , &amp;<a name='542'>
                                ips , ipe , jps , jpe , kps , kpe )<a name='543'>
       ENDIF<a name='544'>
<a name='545'>
       <font color=#447700>!  adjust temp and qv<a name='546'></font>
<a name='547'>
       CALL <A href='../../html_code/dyn_em/nest_init_utils.F.html#ADJUST_TEMPQV'>adjust_tempqv</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_TEMPQV_1"> ( nest%mub , nest%mub_save , &amp;<a name='548'>
                            nest%c3h , nest%c4h , nest%znw , nest%p_top , &amp;<a name='549'>
                            nest%t_2 , nest%p , nest%moist(ims,kms,jms,P_QV) , &amp;<a name='550'>
                            ids , ide , jds , jde , kds , kde , &amp;<a name='551'>
                            ims , ime , jms , jme , kms , kme , &amp;<a name='552'>
                            ips , ipe , jps , jpe , kps , kpe )<a name='553'>
<a name='554'>
     ELSE<a name='555'>
       WRITE(message,FMT='(A,I2,A,I2,A)') '*** Initializing nest domain #',nest%id,&amp;<a name='556'>
                                     ' by horizontally interpolating parent domain #' ,parent%id, &amp;<a name='557'>
                                     '. ***'<a name='558'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_950"> ( 0 , message )<a name='559'>
<a name='560'>
#if (DA_CORE <font color=#447700>!= 1)<a name='561'></font>
       <font color=#447700>! For nests without an input file, we still need to read time series locations<a name='562'></font>
       <font color=#447700>!   from the tslist file<a name='563'></font>
       IF ( nest%active_this_task) THEN<a name='564'>
          CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_22">( nest%id )<a name='565'>
          CALL <A href='../../html_code/share/wrf_tsin.F.html#WRF_TSIN'>wrf_tsin</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_TSIN_2">( nest , ierr )<a name='566'>
          CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_22"><a name='567'>
       ENDIF<a name='568'>
#endif<a name='569'>
     END IF<a name='570'>
<a name='571'>
<font color=#447700>! feedback, mostly for this new terrain, but it is the safe thing to do<a name='572'></font>
     parent%ht_coarse = parent%ht<a name='573'>
<a name='574'>
     CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK'>med_nest_feedback</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_FEEDBACK_3"> ( parent , nest , config_flags )<a name='575'>
<a name='576'>
<font color=#447700>! This is the new interpolation for specific 3d arrays that are sensitive to the<a name='577'></font>
<font color=#447700>! topography diffs betwixt the CG and the FG.<a name='578'></font>
     IF ( config_flags%nest_interp_coord .EQ. 1 ) THEN<a name='579'>
       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_951">(1,'mediation_integrate.F, calling   med_interp_domain_small')<a name='580'>
       CALL <A href='../../html_code/share/mediation_interp_domain.F.html#MED_INTERP_DOMAIN_SMALL'>med_interp_domain_small</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INTERP_DOMAIN_SMALL_1">( parent, nest )<a name='581'>
       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_952">(1,'mediation_integrate.F, back from med_interp_domain_small')<a name='582'>
     END IF<a name='583'>
<a name='584'>
<font color=#447700>! set some other initial fields, fill out halos, base fields; re-do parent due<a name='585'></font>
<font color=#447700>! to new terrain elevation from feedback<a name='586'></font>
<a name='587'>
     IF ( nest%active_this_task) THEN<a name='588'>
       nest%imask_nostag = 1<a name='589'>
       nest%imask_xstag = 1<a name='590'>
       nest%imask_ystag = 1<a name='591'>
       nest%imask_xystag = 1<a name='592'>
       nest%press_adj = .TRUE.<a name='593'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_23">( nest%id )<a name='594'>
       CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_8"> ( nest , .TRUE. )<a name='595'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_23"><a name='596'>
     ENDIF<a name='597'>
<a name='598'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>! defined(STUBMPI)<a name='599'></font>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_24">( parent%id )<a name='600'>
     CALL MPI_Barrier( local_communicator, ierr )     <a name='601'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_24"><a name='602'>
#endif<a name='603'>
<a name='604'>
     IF ( parent%active_this_task ) THEN<a name='605'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_25">( parent%id )<a name='606'>
<font color=#447700>! kludge: 20040604<a name='607'></font>
     CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_101"> (  parent ,                   &amp;<a name='608'>
                               ids, ide, jds, jde, kds, kde,    &amp;<a name='609'>
                               ims, ime, jms, jme, kms, kme,    &amp;<a name='610'>
                               ips, ipe, jps, jpe, kps, kpe    )<a name='611'>
  <a name='612'>
     ALLOCATE( save_acsnow(ims:ime,jms:jme) )<a name='613'>
     ALLOCATE( save_acsnom(ims:ime,jms:jme) )<a name='614'>
     ALLOCATE( save_cuppt(ims:ime,jms:jme) )<a name='615'>
     ALLOCATE( save_rainc(ims:ime,jms:jme) )<a name='616'>
     ALLOCATE( save_rainnc(ims:ime,jms:jme) )<a name='617'>
     ALLOCATE( save_sfcevp(ims:ime,jms:jme) )<a name='618'>
     ALLOCATE( save_sfcrunoff(ims:ime,jms:jme) )<a name='619'>
     ALLOCATE( save_udrunoff(ims:ime,jms:jme) )<a name='620'>
     save_acsnow       = parent%acsnow<a name='621'>
     save_acsnom       = parent%acsnom<a name='622'>
     save_cuppt        = parent%cuppt<a name='623'>
     save_rainc        = parent%rainc<a name='624'>
     save_rainnc       = parent%rainnc<a name='625'>
     save_sfcevp       = parent%sfcevp<a name='626'>
     save_sfcrunoff    = parent%sfcrunoff<a name='627'>
     save_udrunoff     = parent%udrunoff<a name='628'>
     save_itimestep    = parent%itimestep<a name='629'>
     parent%imask_nostag = 1<a name='630'>
     parent%imask_xstag = 1<a name='631'>
     parent%imask_ystag = 1<a name='632'>
     parent%imask_xystag = 1<a name='633'>
<a name='634'>
     parent%press_adj = .FALSE.<a name='635'>
     CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_9"> ( parent , .TRUE. )<a name='636'>
<a name='637'>
     parent%acsnow     = save_acsnow<a name='638'>
     parent%acsnom     = save_acsnom<a name='639'>
     parent%cuppt      = save_cuppt<a name='640'>
     parent%rainc      = save_rainc<a name='641'>
     parent%rainnc     = save_rainnc<a name='642'>
     parent%sfcevp     = save_sfcevp<a name='643'>
     parent%sfcrunoff  = save_sfcrunoff<a name='644'>
     parent%udrunoff   = save_udrunoff<a name='645'>
     parent%itimestep  = save_itimestep<a name='646'>
     DEALLOCATE( save_acsnow )<a name='647'>
     DEALLOCATE( save_acsnom )<a name='648'>
     DEALLOCATE( save_cuppt )<a name='649'>
     DEALLOCATE( save_rainc )<a name='650'>
     DEALLOCATE( save_rainnc )<a name='651'>
     DEALLOCATE( save_sfcevp )<a name='652'>
     DEALLOCATE( save_sfcrunoff )<a name='653'>
     DEALLOCATE( save_udrunoff )<a name='654'>
<font color=#447700>! end of kludge: 20040604<a name='655'></font>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_25"><a name='656'>
     ENDIF<a name='657'>
<a name='658'>
  ELSE  <font color=#447700>! restart<a name='659'></font>
<a name='660'>
<font color=#447700>!TODO -- have to look at restarts yet<a name='661'></font>
<a name='662'>
     IF ( wrf_dm_on_monitor() ) CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_6"><a name='663'>
<a name='664'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_47">( nest, current_timestr=timestr )<a name='665'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_12"> ( rstname , config_flags%rst_inname , nest%id , 2 , timestr )<a name='666'>
<a name='667'>
     WRITE(message,*)'RESTART: nest, opening ',TRIM(rstname),' for reading'<a name='668'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1150"> ( message )<a name='669'>
     CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_64"> ( nest%id , model_config_rec , nest_config_flags )<a name='670'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_12"> ( fid , TRIM(rstname) , nest , nest_config_flags , "DATASET=RESTART", ierr )<a name='671'>
     IF ( ierr .NE. 0 ) THEN<a name='672'>
       WRITE( message , '("program wrf: error opening ",A32," for reading")') TRIM(rstname)<a name='673'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1333"> ( message )<a name='674'>
     ENDIF<a name='675'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#INPUT_RESTART'>input_restart</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_RESTART_1"> ( fid,   nest , nest_config_flags , ierr )<a name='676'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_27"> ( fid , nest_config_flags , "DATASET=RESTART" )<a name='677'>
<a name='678'>
     IF ( wrf_dm_on_monitor() ) THEN<a name='679'>
       WRITE ( message , FMT = '("processing restart file for domain ",I8)' ) nest%id<a name='680'>
       CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_6"> ( TRIM(message) )<a name='681'>
     ENDIF<a name='682'>
<a name='683'>
     nest%imask_nostag = 1<a name='684'>
     nest%imask_xstag = 1<a name='685'>
     nest%imask_ystag = 1<a name='686'>
     nest%imask_xystag = 1<a name='687'>
     nest%press_adj = .FALSE.<a name='688'>
     CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_10"> ( nest , .TRUE. )<a name='689'>
#ifndef MOVE_NESTS<a name='690'>
<font color=#447700>! this doesn't need to be done for moving nests, since ht_coarse is part of the restart<a name='691'></font>
     parent%ht_coarse = parent%ht<a name='692'>
#else<a name='693'>
#  if 1<a name='694'>
<font color=#447700>! In case of a restart, assume that the movement has already occurred in the previous<a name='695'></font>
<font color=#447700>! run and turn off the alarm for the starting time. We must impose a requirement that the<a name='696'></font>
<font color=#447700>! run be restarted on-interval.  Test for that and print a warning if it isn't.<a name='697'></font>
<font color=#447700>! Note, simulation_start, etc. should be available as metadata in the restart file, and<a name='698'></font>
<font color=#447700>! these will have gotten, set, and retrievable as rconfig data been set in share/input_wrf.F<a name='699'></font>
<font color=#447700>! using the nl_get routines below.  JM 20060314<a name='700'></font>
<a name='701'>
     CALL nl_get_vortex_interval ( nest%id , vortex_interval )<a name='702'>
     CALL WRFU_TimeIntervalSet( interval, M=vortex_interval, rc=rc )<a name='703'>
<a name='704'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_48">( nest, timeSinceSimulationStart=TimeSinceStart )<a name='705'>
     n = WRFU_TimeIntervalDIVQuot( TimeSinceStart , interval )<a name='706'>
     IF ( ( interval * n ) .NE. TimeSinceStart ) THEN<a name='707'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1151">('WARNING: Restart is not on a vortex_interval time boundary.')<a name='708'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1152">('The code will work but results will not agree exactly with a ')<a name='709'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1153">('a run that was done straight-through, without a restart.') <a name='710'>
     ENDIF<a name='711'>
<font color=#447700>!! In case of a restart, assume that the movement has already occurred in the previous<a name='712'></font>
<font color=#447700>!! run and turn off the alarm for the starting time. We must impose a requirement that the<a name='713'></font>
<font color=#447700>!! run be restarted on-interval.  Test for that and print a warning if it isn't.<a name='714'></font>
<font color=#447700>!! Note, simulation_start, etc. should be available as metadata in the restart file, and<a name='715'></font>
<font color=#447700>!! these will have gotten, set, and retrievable as rconfig data been set in share/input_wrf.F<a name='716'></font>
<font color=#447700>!! using the nl_get routines below.  JM 20060314<a name='717'></font>
<font color=#447700>!     CALL WRFU_AlarmRingerOff( nest%alarms( COMPUTE_VORTEX_CENTER_ALARM ), rc=rc )<a name='718'></font>
<a name='719'>
#  else<a name='720'>
<font color=#447700>! this code, currently commented out, is an attempt to have the<a name='721'></font>
<font color=#447700>! vortex centering interval be set according to simulation start<a name='722'></font>
<font color=#447700>! time (rather than run start time) in case of a restart. But<a name='723'></font>
<font color=#447700>! there are other problems (the WRF clock is currently using<a name='724'></font>
<font color=#447700>! run-start as it's start time) so the alarm still would not fire<a name='725'></font>
<font color=#447700>! right if the model were started off-interval.  Leave it here and<a name='726'></font>
<font color=#447700>! enable when the clock is changed to use sim-start for start time.<a name='727'></font>
<font color=#447700>! JM 20060314<a name='728'></font>
     CALL nl_get_vortex_interval ( nest%id , vortex_interval )<a name='729'>
     CALL WRFU_TimeIntervalSet( interval, M=vortex_interval, rc=rc )<a name='730'>
<a name='731'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_49">( nest, timeSinceSimulationStart=TimeSinceStart )<a name='732'>
<a name='733'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_ALARM_CREATE'>domain_alarm_create</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_ALARM_CREATE_1">( nest,  COMPUTE_VORTEX_CENTER_ALARM, interval  )<a name='734'>
     CALL WRFU_AlarmEnable( nest%alarms( COMPUTE_VORTEX_CENTER_ALARM ), rc=rc )<a name='735'>
     n = WRFU_TimeIntervalDIVQuot( TimeSinceStart , interval )<a name='736'>
     IF ( ( interval * n ) .EQ. TimeSinceStart ) THEN<a name='737'>
       CALL WRFU_AlarmRingerOn( nest%alarms( COMPUTE_VORTEX_CENTER_ALARM ), rc=rc )<a name='738'>
     ELSE <a name='739'>
       CALL WRFU_AlarmRingerOff( nest%alarms( COMPUTE_VORTEX_CENTER_ALARM ), rc=rc )<a name='740'>
     ENDIF<a name='741'>
#  endif<a name='742'>
#endif<a name='743'>
<a name='744'>
  ENDIF<a name='745'>
<a name='746'>
#endif<a name='747'>
<a name='748'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='749'>
<font color=#447700>!===================================================================================<a name='750'></font>
<font color=#447700>!  Added for the NMM core. This is gopal's doing.<a name='751'></font>
<font color=#447700>!===================================================================================<a name='752'></font>
<a name='753'>
   INTERFACE<a name='754'>
<a name='755'>
     SUBROUTINE med_nest_egrid_configure ( parent , nest )<a name='756'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_345">       , ONLY : domain<a name='757'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='758'>
     END SUBROUTINE med_nest_egrid_configure <a name='759'>
<a name='760'>
     SUBROUTINE med_construct_egrid_weights ( parent , nest )<a name='761'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_346">       , ONLY : domain<a name='762'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='763'>
     END SUBROUTINE med_construct_egrid_weights<a name='764'>
<a name='765'>
     SUBROUTINE BASE_STATE_PARENT ( Z3d,Q3d,T3d,PSTD,        &amp;<a name='766'>
                                    PINT,T,Q,CWM,            &amp;<a name='767'>
                                    FIS,QSH,PD,PDTOP,PTOP,   &amp;<a name='768'>
                                    ETA1,ETA2,               &amp;<a name='769'>
                                    DETA1,DETA2,             &amp;<a name='770'>
                                    IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='771'>
                                    IMS,IME,JMS,JME,KMS,KME, &amp;<a name='772'>
                                    IPS,IPE,JPS,JPE,KPS,KPE  )<a name='773'>
<font color=#447700>!<a name='774'></font>
<a name='775'>
         USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_112"><a name='776'>
         IMPLICIT NONE<a name='777'>
         INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='778'>
         INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='779'>
         INTEGER,    INTENT(IN   )                            :: IPS,IPE,JPS,JPE,KPS,KPE<a name='780'>
         REAL,       INTENT(IN   )                            :: PDTOP,PTOP<a name='781'>
         REAL, DIMENSION(KMS:KME),                 INTENT(IN) :: ETA1,ETA2,DETA1,DETA2<a name='782'>
         REAL, DIMENSION(IMS:IME,JMS:JME),         INTENT(IN) :: FIS,PD,QSH<a name='783'>
         REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME), INTENT(IN) :: PINT,T,Q,CWM<a name='784'>
         REAL, DIMENSION(KMS:KME)                , INTENT(OUT):: PSTD<a name='785'>
         REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME), INTENT(OUT):: Z3d,Q3d,T3d<a name='786'>
<a name='787'>
     END SUBROUTINE BASE_STATE_PARENT<a name='788'>
<a name='789'>
     SUBROUTINE NEST_TERRAIN ( nest, config_flags )<a name='790'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_347">        , ONLY : domain<a name='791'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_215">     , ONLY : grid_config_rec_type<a name='792'>
       TYPE(domain) , POINTER                        :: nest<a name='793'>
       TYPE(grid_config_rec_type) , INTENT(IN)       :: config_flags<a name='794'>
     END SUBROUTINE NEST_TERRAIN<a name='795'>
<a name='796'>
    SUBROUTINE med_interp_domain ( parent , nest )<a name='797'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_348">       , ONLY : domain<a name='798'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='799'>
    END SUBROUTINE med_interp_domain<a name='800'>
<a name='801'>
    SUBROUTINE med_init_domain_constants_nmm ( parent, nest )<a name='802'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_349">       , ONLY : domain<a name='803'>
        TYPE(domain) , POINTER                    :: parent , nest<a name='804'>
    END SUBROUTINE med_init_domain_constants_nmm<a name='805'>
<a name='806'>
    SUBROUTINE start_domain ( grid , allowed_to_move )<a name='807'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_350">       , ONLY : domain<a name='808'>
        TYPE(domain) :: grid<a name='809'>
        LOGICAL, INTENT(IN) :: allowed_to_move<a name='810'>
    END SUBROUTINE start_domain<a name='811'>
<a name='812'>
   END INTERFACE<a name='813'>
<a name='814'>
#if ( HWRF == 1 )<a name='815'>
<font color=#447700>!zhang's doing test<a name='816'></font>
   if (config_flags%restart .or. nest%analysis) then<a name='817'>
   nest%first_force = .true.<a name='818'>
   else<a name='819'>
   nest%first_force = .false.<a name='820'>
   endif<a name='821'>
<font color=#447700>!end of zhang's doing<a name='822'></font>
<a name='823'>
   <font color=#447700>! Do we run the MOIST and SCALAR interp/smooth functions? (u=(), d=(), f=() and s=())<a name='824'></font>
<a name='825'>
   <font color=#447700>! Only run it if a non-bulk scheme is in use, since bulk schemes do<a name='826'></font>
   <font color=#447700>! not use MOIST and SCALAR as prognostic variables (they are<a name='827'></font>
   <font color=#447700>! recalculated on the fly every timestep):<a name='828'></font>
<font color=#447700>!zhang's doing for analysis option<a name='829'></font>
  IF(.not. nest%analysis .and. .not. config_flags%restart)THEN    <font color=#447700>! initialize for cold-start<a name='830'></font>
#endif<a name='831'>
<a name='832'>
<font color=#447700>!----------------------------------------------------------------------------<a name='833'></font>
<font color=#447700>!  initialize nested domain configurations including setting up wbd,sbd, etc <a name='834'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='835'></font>
<a name='836'>
   CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE'>med_nest_egrid_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_EGRID_CONFIGURE_1"> ( parent , nest )<a name='837'>
<a name='838'>
<font color=#447700>!-------------------------------------------------------------------------<a name='839'></font>
<font color=#447700>!  initialize lat-lons and determine weights <a name='840'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='841'></font>
<a name='842'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS'>med_construct_egrid_weights</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_CONSTRUCT_EGRID_WEIGHTS_1"> ( parent, nest )<a name='843'>
<font color=#447700>!<a name='844'></font>
<font color=#447700>!<a name='845'></font>
<font color=#447700>!  De-reference dimension information stored in the grid data structure.<a name='846'></font>
<font color=#447700>!<a name='847'></font>
<font color=#447700>!  From the hybrid, construct the GPMs on isobaric surfaces and then interpolate those<a name='848'></font>
<font color=#447700>!  values on to the nested domain. 23 standard prssure levels are assumed here. For<a name='849'></font>
<font color=#447700>!  levels below ground, lapse rate atmosphere is assumed before the use of vertical<a name='850'></font>
<font color=#447700>!  spline interpolation <a name='851'></font>
<font color=#447700>!<a name='852'></font>
<a name='853'>
<a name='854'>
    IDS = parent%sd31<a name='855'>
    IDE = parent%ed31<a name='856'>
    JDS = parent%sd32<a name='857'>
    JDE = parent%ed32<a name='858'>
    KDS = parent%sd33<a name='859'>
    KDE = parent%ed33<a name='860'>
<a name='861'>
    IMS = parent%sm31<a name='862'>
    IME = parent%em31<a name='863'>
    JMS = parent%sm32<a name='864'>
    JME = parent%em32<a name='865'>
    KMS = parent%sm33<a name='866'>
    KME = parent%em33<a name='867'>
<a name='868'>
    IPS = parent%sp31<a name='869'>
    IPE = parent%ep31<a name='870'>
    JPS = parent%sp32<a name='871'>
    JPE = parent%ep32<a name='872'>
    KPS = parent%sp33<a name='873'>
    KPE = parent%ep33<a name='874'>
<a name='875'>
    <font color=#447700>! CALL BASE_STATE_PARENT ( parent%Z3d,parent%Q3d,parent%T3d,parent%PSTD,  &amp;<a name='876'></font>
    <font color=#447700>!                          parent%PINT,parent%T,parent%Q,parent%CWM,      &amp;<a name='877'></font>
    <font color=#447700>!                          parent%FIS,parent%QSH,parent%PD,parent%pdtop,parent%pt,   &amp;<a name='878'></font>
    <font color=#447700>!                          parent%ETA1,parent%ETA2,                               &amp;<a name='879'></font>
    <font color=#447700>!                          parent%DETA1,parent%DETA2,                             &amp;<a name='880'></font>
    <font color=#447700>!                          IDS,IDE,JDS,JDE,KDS,KDE,                                       &amp;<a name='881'></font>
    <font color=#447700>!                          IMS,IME,JMS,JME,KMS,KME,                                       &amp;<a name='882'></font>
    <font color=#447700>!                          IPS,IPE,JPS,JPE,KPS,KPE                                        )<a name='883'></font>
<a name='884'>
<font color=#447700>!  <a name='885'></font>
<font color=#447700>!   Set new terrain. Since some terrain adjustment is done within the interpolation calls<a name='886'></font>
<font color=#447700>!   at the next step, the new terrain over the nested domain has to be called here.<a name='887'></font>
<font color=#447700>!<a name='888'></font>
    IDS = nest%sd31<a name='889'>
    IDE = nest%ed31<a name='890'>
    JDS = nest%sd32<a name='891'>
    JDE = nest%ed32<a name='892'>
    KDS = nest%sd33<a name='893'>
    KDE = nest%ed33<a name='894'>
<a name='895'>
    IMS = nest%sm31<a name='896'>
    IME = nest%em31<a name='897'>
    JMS = nest%sm32<a name='898'>
    JME = nest%em32<a name='899'>
    KMS = nest%sm33<a name='900'>
    KME = nest%em33<a name='901'>
<a name='902'>
    IPS = nest%sp31<a name='903'>
    IPE = nest%ep31<a name='904'>
    JPS = nest%sp32<a name='905'>
    JPE = nest%ep32<a name='906'>
    KPS = nest%sp33<a name='907'>
    KPE = nest%ep33<a name='908'>
<a name='909'>
<a name='910'>
    IF ( nest%active_this_task ) THEN<a name='911'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#NEST_TERRAIN'>NEST_TERRAIN</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NEST_TERRAIN_1"> ( nest, config_flags )<a name='912'>
    ENDIF<a name='913'>
<a name='914'>
<font color=#447700>!   Initialize some more constants required especially for terrain adjustment processes<a name='915'></font>
<a name='916'>
    IF ( nest%active_this_task .AND. parent%active_this_task ) THEN<a name='917'>
    nest%PSTD=parent%PSTD<a name='918'>
    ENDIF<a name='919'>
#ifdef DM_PARALLEL<a name='920'>
    IF ( nest%active_this_task .OR. parent%active_this_task ) THEN<a name='921'>
      IF ( parent%active_this_task ) THEN<a name='922'>
        CALL BYTE_BCAST( parent%PSTD, KME*RWORDSIZE, mpi_comm_to_kid( which_kid( nest%id ) , parent%id ) )<a name='923'>
      ELSE<a name='924'>
        CALL BYTE_BCAST( nest%PSTD, KME*RWORDSIZE, mpi_comm_to_mom( nest%id ) )<a name='925'>
      ENDIF<a name='926'>
    ENDIF<a name='927'>
#endif<a name='928'>
<a name='929'>
    IF ( nest%active_this_task ) THEN<a name='930'>
      nest%KZMAX=KME<a name='931'>
      parent%KZMAX=KME  <font color=#447700>! just for safety<a name='932'></font>
<a name='933'>
      DO J = JPS, MIN(JPE,JDE-1)<a name='934'>
        DO I = IPS, MIN(IPE,IDE-1)<a name='935'>
         nest%fis(I,J)=nest%hres_fis(I,J)<a name='936'>
       ENDDO<a name='937'>
      ENDDO<a name='938'>
<a name='939'>
<font color=#447700>!--------------------------------------------------------------------------<a name='940'></font>
<font color=#447700>!  interpolation call<a name='941'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='942'></font>
<a name='943'>
<font color=#447700>! initialize nest with interpolated data from the parent<a name='944'></font>
<a name='945'>
      nest%imask_nostag = 0 <a name='946'>
      nest%imask_xstag  = 0 <a name='947'>
      nest%imask_ystag  = 0 <a name='948'>
      nest%imask_xystag = 0 <a name='949'>
    ENDIF<a name='950'>
<a name='951'>
#if ( HWRF == 1 )<a name='952'>
   CALL <A href='../../html_code/share/mediation_interp_domain.F.html#MED_INTERP_DOMAIN'>med_interp_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INTERP_DOMAIN_3">( parent, nest )<a name='953'>
#else<a name='954'>
    CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_50">( parent, start_time=strt_time, current_time=cur_time )<a name='955'>
<a name='956'>
    IF ( .not. ( config_flags%restart .AND. strt_time .EQ. cur_time ) ) THEN<a name='957'>
<a name='958'>
write(0,*)__FILE__,__LINE__,parent%id,nest%id<a name='959'>
     CALL <A href='../../html_code/share/mediation_interp_domain.F.html#MED_INTERP_DOMAIN'>med_interp_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INTERP_DOMAIN_4">( parent, nest )<a name='960'>
write(0,*)__FILE__,__LINE__<a name='961'>
<a name='962'>
    ELSE<a name='963'>
<a name='964'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_51">( nest, current_timestr=timestr )<a name='965'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_13"> ( rstname , config_flags%rst_inname , nest%id , 2 , timestr )<a name='966'>
<a name='967'>
     WRITE(message,*)'RESTART: nest, opening ',TRIM(rstname),' for reading'<a name='968'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1154"> ( message )<a name='969'>
     CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_65"> ( nest%id , model_config_rec , nest_config_flags )<a name='970'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_13"> ( fid , TRIM(rstname) , nest , nest_config_flags , "DATASET=RESTART", ierr )<a name='971'>
     IF ( ierr .NE. 0 ) THEN<a name='972'>
       WRITE( message , '("program wrf: error opening ",A32," for reading")') TRIM(rstname)<a name='973'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1334"> ( message )<a name='974'>
     ENDIF<a name='975'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#INPUT_RESTART'>input_restart</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_RESTART_2"> ( fid,   nest , nest_config_flags , ierr )<a name='976'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_28"> ( fid , nest_config_flags , "DATASET=RESTART" )<a name='977'>
<a name='978'>
    END IF<a name='979'>
<a name='980'>
#endif<a name='981'>
<font color=#447700>!------------------------------------------------------------------------------<a name='982'></font>
<font color=#447700>!  set up constants (module_initialize_real.F for nested nmm domain)<a name='983'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='984'></font>
<a name='985'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM'>med_init_domain_constants_nmm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INIT_DOMAIN_CONSTANTS_NMM_1"> ( parent, nest )<a name='986'>
<a name='987'>
<font color=#447700>!--------------------------------------------------------------------------------------<a name='988'></font>
<font color=#447700>! set some other initial fields, fill out halos, etc. <a name='989'></font>
<font color=#447700>!--------------------------------------------------------------------------------------<a name='990'></font>
<a name='991'>
    IF ( nest%active_this_task) THEN<a name='992'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_26">( nest%id )<a name='993'>
      CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_11"> ( nest, .TRUE.)<a name='994'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_26"><a name='995'>
    ENDIF<a name='996'>
    <a name='997'>
<a name='998'>
#if ( HWRF == 1 )<a name='999'>
<font color=#447700>!zhang's doing: else for analysis or restart option<a name='1000'></font>
<a name='1001'>
<font color=#447700>!zhang test<a name='1002'></font>
    CALL nl_set_isice ( nest%id , config_flags%isice )   <a name='1003'>
    CALL nl_set_isoilwater ( nest%id , config_flags%isoilwater )   <a name='1004'>
    CALL nl_set_isurban ( nest%id , config_flags%isurban )   <a name='1005'>
    CALL nl_set_gmt    ( nest%id , config_flags%gmt    )   <a name='1006'>
    CALL nl_set_julyr (nest%id, config_flags%julyr)       <a name='1007'>
    CALL nl_set_julday ( nest%id , config_flags%julday )<a name='1008'>
<font color=#447700>!zhang test ends<a name='1009'></font>
    IF ( nest%active_this_task) THEN<a name='1010'>
     CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_66"> ( nest%id , model_config_rec , nest_config_flags )<a name='1011'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_27">( nest%id )<a name='1012'>
     CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT'>med_analysis_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_ANALYSIS_OUT_1"> ( nest, nest_config_flags )<a name='1013'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_27"><a name='1014'>
    ENDIF<a name='1015'>
<a name='1016'>
   ELSE<a name='1017'>
<a name='1018'>
<font color=#447700>!------------------------------------------------------------------------------------<a name='1019'></font>
<font color=#447700>!  read in analysis (equivalent of restart for the nested domains)<a name='1020'></font>
<font color=#447700>!------------------------------------------------------------------------------------<a name='1021'></font>
<a name='1022'>
<font color=#447700>!zhang's doing<a name='1023'></font>
  IF ( nest%active_this_task) THEN<a name='1024'>
  IF( nest%analysis .and. .not. config_flags%restart)THEN<a name='1025'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_28">( nest%id )<a name='1026'>
   CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN'>med_analysis_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_ANALYSIS_IN_1"> ( nest, config_flags )<a name='1027'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_28"><a name='1028'>
  ELSE IF (config_flags%restart)THEN<a name='1029'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_29">( nest%id )<a name='1030'>
   CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN'>med_restart_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_RESTART_IN_1"> ( nest, config_flags )<a name='1031'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_29"><a name='1032'>
  ENDIF<a name='1033'>
  ENDIF<a name='1034'>
<font color=#447700>!end of zhang's doing<a name='1035'></font>
<a name='1036'>
<font color=#447700>!----------------------------------------------------------------------------<a name='1037'></font>
<font color=#447700>!  initialize nested domain configurations including setting up wbd,sbd, etc<a name='1038'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='1039'></font>
<a name='1040'>
   CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_NEST_EGRID_CONFIGURE'>med_nest_egrid_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_EGRID_CONFIGURE_2"> ( parent , nest )<a name='1041'>
<a name='1042'>
<font color=#447700>!-------------------------------------------------------------------------<a name='1043'></font>
<font color=#447700>!  initialize lat-lons and determine weights (overwrite for safety)<a name='1044'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='1045'></font>
<a name='1046'>
   CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_CONSTRUCT_EGRID_WEIGHTS'>med_construct_egrid_weights</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_CONSTRUCT_EGRID_WEIGHTS_2"> ( parent, nest )<a name='1047'>
<a name='1048'>
   nest%imask_nostag = 0<a name='1049'>
   nest%imask_xstag  = 0<a name='1050'>
   nest%imask_ystag  = 0<a name='1051'>
   nest%imask_xystag = 0<a name='1052'>
<a name='1053'>
<font color=#447700>!------------------------------------------------------------------------------<a name='1054'></font>
<font color=#447700>!  set up constants (module_initialize_real.F for nested nmm domain)<a name='1055'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1056'></font>
<a name='1057'>
    CALL <A href='../../html_code/dyn_nmm/NMM_NEST_UTILS1.F.html#MED_INIT_DOMAIN_CONSTANTS_NMM'>med_init_domain_constants_nmm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INIT_DOMAIN_CONSTANTS_NMM_2"> ( parent, nest )<a name='1058'>
<a name='1059'>
<font color=#447700>!--------------------------------------------------------------------------------------<a name='1060'></font>
<font color=#447700>! set some other initial fields, fill out halos, etc. (again, safety sake only)<a name='1061'></font>
<font color=#447700>! Also, in order to accomodate some physics initialization after nest move, set<a name='1062'></font>
<font color=#447700>! analysis back to false for future use<a name='1063'></font>
<font color=#447700>!--------------------------------------------------------------------------------------<a name='1064'></font>
<a name='1065'>
<a name='1066'>
  IF ( nest%active_this_task) THEN<a name='1067'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_30">( nest%id )<a name='1068'>
    CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_12"> ( nest, .TRUE.)<a name='1069'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_30"><a name='1070'>
  ENDIF<a name='1071'>
<a name='1072'>
    nest%analysis=.FALSE.<a name='1073'>
    CALL nl_set_analysis( nest%id, nest%analysis)<a name='1074'>
<a name='1075'>
  ENDIF<a name='1076'>
<a name='1077'>
#endif<a name='1078'>
<a name='1079'>
<font color=#447700>!===================================================================================<a name='1080'></font>
<font color=#447700>!  Added for the NMM core. End of gopal's doing.<a name='1081'></font>
<font color=#447700>!===================================================================================<a name='1082'></font>
#endif<a name='1083'>
  RETURN<a name='1084'>
END SUBROUTINE med_nest_initial<a name='1085'>
<a name='1086'>
<A NAME='INIT_DOMAIN_CONSTANTS'><A href='../../html_code/share/mediation_integrate.F.html#INIT_DOMAIN_CONSTANTS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1087'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>init_domain_constants</font> ( parent , nest ) <A href='../../call_to/INIT_DOMAIN_CONSTANTS.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_DOMAIN_CONSTANTS.html' TARGET='index'>2</A><a name='1088'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#INIT_DOMAIN_CONSTANTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_351">    , ONLY : domain<a name='1089'>
   IMPLICIT NONE<a name='1090'>
   TYPE(domain) :: parent , nest<a name='1091'>
#if (EM_CORE == 1)<a name='1092'>
   CALL <A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_CONSTANTS_EM'>init_domain_constants_em</A><A href='../../html_code/share/mediation_integrate.F.html#INIT_DOMAIN_CONSTANTS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_DOMAIN_CONSTANTS_EM_2"> ( parent, nest )<a name='1093'>
#endif<a name='1094'>
END SUBROUTINE init_domain_constants<a name='1095'>
<a name='1096'>
<a name='1097'>
<A NAME='MED_NEST_FORCE'><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1098'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_nest_force</font> ( parent , nest ) <A href='../../call_to/MED_NEST_FORCE.html' TARGET='index'>1</A>,<A href='../../call_from/MED_NEST_FORCE.html' TARGET='index'>7</A><a name='1099'>
  <font color=#447700>! Driver layer<a name='1100'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_352">    , ONLY : domain<a name='1101'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_50"><a name='1102'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_216"> , ONLY : grid_config_rec_type<a name='1103'>
  <font color=#447700>! Model layer<a name='1104'></font>
  <font color=#447700>! External<a name='1105'></font>
   USE module_utility<a name='1106'>
<a name='1107'>
   IMPLICIT NONE<a name='1108'>
<a name='1109'>
  <font color=#447700>! Arguments<a name='1110'></font>
   TYPE(domain) , POINTER                     :: parent, nest<a name='1111'>
  <font color=#447700>! Local<a name='1112'></font>
   INTEGER                                    :: idum1 , idum2 , fid, rc<a name='1113'>
<a name='1114'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='1115'>
   INTEGER                  :: IDS,IDE,JDS,JDE,KDS,KDE     <font color=#447700>! gopal<a name='1116'></font>
   INTEGER                  :: IMS,IME,JMS,JME,KMS,KME<a name='1117'>
   INTEGER                  :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1118'>
#endif<a name='1119'>
<a name='1120'>
   INTERFACE<a name='1121'>
     SUBROUTINE med_force_domain ( parent , nest )<a name='1122'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_353">       , ONLY : domain<a name='1123'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='1124'>
     END SUBROUTINE med_force_domain<a name='1125'>
     SUBROUTINE med_interp_domain ( parent , nest )<a name='1126'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_354">       , ONLY : domain<a name='1127'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='1128'>
     END SUBROUTINE med_interp_domain<a name='1129'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='1130'>
<font color=#447700>!===================================================================================<a name='1131'></font>
<font color=#447700>!  Added for the NMM core. This is gopal's doing.<a name='1132'></font>
<font color=#447700>!===================================================================================<a name='1133'></font>
<a name='1134'>
     SUBROUTINE BASE_STATE_PARENT ( Z3d,Q3d,T3d,PSTD,        &amp;<a name='1135'>
                                    PINT,T,Q,CWM,            &amp;<a name='1136'>
                                    FIS,QSH,PD,PDTOP,PTOP,   &amp;<a name='1137'>
                                    ETA1,ETA2,               &amp;<a name='1138'>
                                    DETA1,DETA2,             &amp;<a name='1139'>
                                    IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='1140'>
                                    IMS,IME,JMS,JME,KMS,KME, &amp;<a name='1141'>
                                    ITS,ITE,JTS,JTE,KTS,KTE  )<a name='1142'>
<font color=#447700>!<a name='1143'></font>
<a name='1144'>
         USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_113"><a name='1145'>
         IMPLICIT NONE<a name='1146'>
         INTEGER,    INTENT(IN   )                            :: IDS,IDE,JDS,JDE,KDS,KDE<a name='1147'>
         INTEGER,    INTENT(IN   )                            :: IMS,IME,JMS,JME,KMS,KME<a name='1148'>
         INTEGER,    INTENT(IN   )                            :: ITS,ITE,JTS,JTE,KTS,KTE<a name='1149'>
         REAL,       INTENT(IN   )                            :: PDTOP,PTOP<a name='1150'>
         REAL, DIMENSION(KMS:KME),                 INTENT(IN) :: ETA1,ETA2,DETA1,DETA2<a name='1151'>
         REAL, DIMENSION(IMS:IME,JMS:JME),         INTENT(IN) :: FIS,PD,QSH<a name='1152'>
         REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME), INTENT(IN) :: PINT,T,Q,CWM<a name='1153'>
         REAL, DIMENSION(KMS:KME)                , INTENT(OUT):: PSTD<a name='1154'>
         REAL, DIMENSION(IMS:IME,JMS:JME,KMS:KME), INTENT(OUT):: Z3d,Q3d,T3d<a name='1155'>
<a name='1156'>
     END SUBROUTINE BASE_STATE_PARENT<a name='1157'>
<a name='1158'>
#endif<a name='1159'>
   END INTERFACE<a name='1160'>
<a name='1161'>
#if (NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='1162'>
<a name='1163'>
<font color=#447700>!  De-reference dimension information stored in the grid data structure.<a name='1164'></font>
<a name='1165'>
    IDS = parent%sd31<a name='1166'>
    IDE = parent%ed31<a name='1167'>
    JDS = parent%sd32<a name='1168'>
    JDE = parent%ed32<a name='1169'>
    KDS = parent%sd33<a name='1170'>
    KDE = parent%ed33<a name='1171'>
<a name='1172'>
    IMS = parent%sm31<a name='1173'>
    IME = parent%em31<a name='1174'>
    JMS = parent%sm32<a name='1175'>
    JME = parent%em32<a name='1176'>
    KMS = parent%sm33<a name='1177'>
    KME = parent%em33<a name='1178'>
<a name='1179'>
    ITS = parent%sp31<a name='1180'>
    ITE = parent%ep31<a name='1181'>
    JTS = parent%sp32<a name='1182'>
    JTE = parent%ep32<a name='1183'>
    KTS = parent%sp33<a name='1184'>
    KTE = parent%ep33<a name='1185'>
<a name='1186'>
<a name='1187'>
    <font color=#447700>! CALL BASE_STATE_PARENT ( parent%Z3d,parent%Q3d,parent%T3d,parent%PSTD, &amp;<a name='1188'></font>
    <font color=#447700>!                          parent%PINT,parent%T,parent%Q,parent%CWM,     &amp;<a name='1189'></font>
    <font color=#447700>!                          parent%FIS,parent%QSH,parent%PD,parent%pdtop,parent%pt,  &amp;<a name='1190'></font>
    <font color=#447700>!                          parent%ETA1,parent%ETA2,                              &amp;<a name='1191'></font>
    <font color=#447700>!                          parent%DETA1,parent%DETA2,                            &amp;<a name='1192'></font>
    <font color=#447700>!                          IDS,IDE,JDS,JDE,KDS,KDE,                                      &amp;<a name='1193'></font>
    <font color=#447700>!                          IMS,IME,JMS,JME,KMS,KME,                                      &amp;<a name='1194'></font>
    <font color=#447700>!                          ITS,ITE,JTS,JTE,KTS,KTE                                       )<a name='1195'></font>
<a name='1196'>
#endif<a name='1197'>
<a name='1198'>
   IF ( .NOT. WRFU_ClockIsStopTime(nest%domain_clock ,rc=rc) ) THEN<a name='1199'>
<font color=#447700>! initialize nest with interpolated data from the parent<a name='1200'></font>
     IF ( nest%active_this_task ) THEN<a name='1201'>
       nest%imask_nostag = 1<a name='1202'>
       nest%imask_xstag = 1<a name='1203'>
       nest%imask_ystag = 1<a name='1204'>
       nest%imask_xystag = 1<a name='1205'>
     ENDIF<a name='1206'>
     CALL <A href='../../html_code/share/mediation_force_domain.F.html#MED_FORCE_DOMAIN'>med_force_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_FORCE_DOMAIN_1">( parent, nest )<a name='1207'>
   ENDIF<a name='1208'>
<a name='1209'>
<font color=#447700>! might also have calls here to do input from a file into the nest<a name='1210'></font>
<a name='1211'>
   RETURN<a name='1212'>
END SUBROUTINE med_nest_force<a name='1213'>
<a name='1214'>
<A NAME='MED_NEST_FEEDBACK'><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1215'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_nest_feedback</font> ( parent , nest , config_flags ) <A href='../../call_to/MED_NEST_FEEDBACK.html' TARGET='index'>4</A>,<A href='../../call_from/MED_NEST_FEEDBACK.html' TARGET='index'>6</A><a name='1216'>
  <font color=#447700>! Driver layer<a name='1217'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_355">    , ONLY : domain , get_ijk_from_grid<a name='1218'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_51"><a name='1219'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_217"> , ONLY : grid_config_rec_type<a name='1220'>
  <font color=#447700>! Model layer<a name='1221'></font>
  <font color=#447700>! External<a name='1222'></font>
   USE module_utility<a name='1223'>
   IMPLICIT NONE<a name='1224'>
<a name='1225'>
<a name='1226'>
  <font color=#447700>! Arguments<a name='1227'></font>
   TYPE(domain) , POINTER                     :: parent, nest<a name='1228'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1229'>
  <font color=#447700>! Local<a name='1230'></font>
   INTEGER                                    :: idum1 , idum2 , fid, rc<a name='1231'>
   INTEGER                         :: ids , ide , jds , jde , kds , kde , &amp;<a name='1232'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='1233'>
                                      ips , ipe , jps , jpe , kps , kpe<a name='1234'>
   INTEGER i,j<a name='1235'>
<a name='1236'>
   INTERFACE<a name='1237'>
     SUBROUTINE med_feedback_domain ( parent , nest )<a name='1238'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_356">       , ONLY : domain<a name='1239'>
        TYPE(domain) , POINTER                 :: parent , nest<a name='1240'>
     END SUBROUTINE med_feedback_domain<a name='1241'>
   END INTERFACE<a name='1242'>
<a name='1243'>
<font color=#447700>! feedback nest to the parent<a name='1244'></font>
    IF ( config_flags%feedback .NE. 0 ) THEN<a name='1245'>
      CALL <A href='../../html_code/share/mediation_feedback_domain.F.html#MED_FEEDBACK_DOMAIN'>med_feedback_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_FEEDBACK_DOMAIN_2">( parent, nest )<a name='1246'>
#ifdef MOVE_NESTS<a name='1247'>
      IF ( parent%active_this_task) THEN<a name='1248'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_102"> (  parent ,                         &amp;<a name='1249'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='1250'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='1251'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='1252'>
<font color=#447700>! gopal's change- added ifdef<a name='1253'></font>
#if ( EM_CORE == 1 )<a name='1254'>
      DO j = jps, MIN(jpe,jde-1)<a name='1255'>
      DO i = ips, MIN(ipe,ide-1)<a name='1256'>
        IF      ( parent%nest_pos(i,j) .EQ. 9021000. ) THEN<a name='1257'>
          parent%nest_pos(i,j) = parent%ht(i,j)*1.5 + 1000.<a name='1258'>
        ELSE IF ( parent%ht(i,j) .NE. 0. ) THEN<a name='1259'>
          parent%nest_pos(i,j) = parent%ht(i,j) + 500.<a name='1260'>
        ELSE <a name='1261'>
          parent%nest_pos(i,j) = 0.<a name='1262'>
        ENDIF<a name='1263'>
      ENDDO<a name='1264'>
      ENDDO<a name='1265'>
#endif<a name='1266'>
      ENDIF<a name='1267'>
#endif<a name='1268'>
    END IF<a name='1269'>
<a name='1270'>
   RETURN<a name='1271'>
END SUBROUTINE med_nest_feedback<a name='1272'>
<a name='1273'>
<A NAME='MED_LAST_SOLVE_IO'><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1274'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_last_solve_io</font> ( grid , config_flags ) <A href='../../call_to/MED_LAST_SOLVE_IO.html' TARGET='index'>2</A>,<A href='../../call_from/MED_LAST_SOLVE_IO.html' TARGET='index'>10</A><a name='1275'>
  <font color=#447700>! Driver layer<a name='1276'></font>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_180"><a name='1277'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_357">    , ONLY : domain, domain_clock_get<a name='1278'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_218"> , ONLY : grid_config_rec_type<a name='1279'>
   USE module_utility<a name='1280'>
   USE <A href='../../html_code/frame/module_streams.F.html#MODULE_STREAMS'>module_streams</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STREAMS_10"><a name='1281'>
  <font color=#447700>! Model layer<a name='1282'></font>
<a name='1283'>
   IMPLICIT NONE<a name='1284'>
<a name='1285'>
  <font color=#447700>! Arguments<a name='1286'></font>
   TYPE(domain)                               :: grid<a name='1287'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1288'>
  <font color=#447700>! Local<a name='1289'></font>
   INTEGER                                    :: rc<a name='1290'>
#if ( HWRF == 1 )<a name='1291'>
<font color=#447700>!zhang's doing<a name='1292'></font>
   TYPE(WRFU_Time) :: CurrTime  <font color=#447700>!zhang new<a name='1293'></font>
   INTEGER :: hr, min, sec, ms,julyr,julday<a name='1294'>
   REAL :: GMT<a name='1295'>
<font color=#447700>!end of zhang's doing<a name='1296'></font>
#endif<a name='1297'>
<a name='1298'>
<font color=#447700>! #if (EM_CORE == 1)<a name='1299'></font>
   IF( WRFU_AlarmIsRinging( grid%alarms( HISTORY_ALARM ), rc=rc ) .AND. &amp;<a name='1300'>
       (grid%dfi_write_dfi_history .OR. grid%dfi_stage == DFI_FST .OR. grid%dfi_opt == DFI_NODFI) ) THEN<a name='1301'>
<font color=#447700>! #else<a name='1302'></font>
<font color=#447700>!    IF( WRFU_AlarmIsRinging( grid%alarms( HISTORY_ALARM ), rc=rc )) THEN<a name='1303'></font>
<font color=#447700>! #endif<a name='1304'></font>
     CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT'>med_hist_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_HIST_OUT_6"> ( grid , HISTORY_ALARM , config_flags )<a name='1305'>
   ENDIF<a name='1306'>
<a name='1307'>
   IF( WRFU_AlarmIsRinging( grid%alarms( INPUTOUT_ALARM ), rc=rc ) ) THEN<a name='1308'>
     CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT'>med_filter_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_FILTER_OUT_2">  ( grid , config_flags )<a name='1309'>
   ENDIF<a name='1310'>
<a name='1311'>
<font color=#447700>! registry-generated file of the following <a name='1312'></font>
<font color=#447700>!   IF( WRFU_AlarmIsRinging( grid%alarms( AUXHIST1_ALARM ), rc=rc ) ) THEN<a name='1313'></font>
<font color=#447700>!     CALL med_hist_out ( grid , AUXHIST1_ALARM , config_flags )<a name='1314'></font>
<font color=#447700>!   ENDIF<a name='1315'></font>
   IF ( grid%dfi_stage == DFI_FST .OR. grid%dfi_opt == DFI_NODFI ) THEN<a name='1316'>
#include "<A href='../../html_code/include/med_last_solve_io.inc.html'>med_last_solve_io.inc</A>"<A NAME="med_last_solve_io.inc_1"><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1317'>
   END IF<a name='1318'>
<a name='1319'>
<font color=#447700>! - RESTART OUTPUT<a name='1320'></font>
   IF( WRFU_AlarmIsRinging( grid%alarms( RESTART_ALARM ), rc=rc ) ) THEN<a name='1321'>
#if ( HWRF == 1 )<a name='1322'>
<font color=#447700>!zhang's doing<a name='1323'></font>
<font color=#447700>!zhang new     CALL ESMF_TimeGet( grid%current_time, YY=julyr, dayOfYear=julday, H=hr, M=min, S=sec, MS=ms, rc=rc)<a name='1324'></font>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_52">( grid, current_time=CurrTime )<a name='1325'>
     CALL WRFU_TimeGet( CurrTime, YY=julyr, dayOfYear=julday, H=hr, M=min, S=sec, MS=ms, rc=rc)<a name='1326'>
     gmt=hr+real(min)/60.+real(sec)/3600.+real(ms)/(1000*3600)<a name='1327'>
      if (grid%id .eq. 2) call <A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT'>med_namelist_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NAMELIST_OUT_2"> ( grid , config_flags )<a name='1328'>
<font color=#447700>!end of zhang's doing<a name='1329'></font>
#endif<a name='1330'>
     IF ( grid%id .EQ. 1 ) THEN<a name='1331'>
       CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT'>med_restart_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_RESTART_OUT_3"> ( grid , config_flags )<a name='1332'>
     ENDIF<a name='1333'>
   ENDIF<a name='1334'>
<a name='1335'>
   <font color=#447700>! Write out time series<a name='1336'></font>
   CALL <A href='../../html_code/share/wrf_timeseries.F.html#WRITE_TS'>write_ts</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_TS_1">( grid )<a name='1337'>
<a name='1338'>
   RETURN<a name='1339'>
END SUBROUTINE med_last_solve_io<a name='1340'>
<a name='1341'>
#endif<a name='1342'>
<a name='1343'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1344'></font>
<a name='1345'>
#if ( HWRF == 1 )<a name='1346'>
<font color=#447700>!==================================================================================<a name='1347'></font>
<font color=#447700>!  Added for the NMM 3d var. This is simply an extension of med_restart_out.<a name='1348'></font>
<font color=#447700>!  The file is simply called wrfanal***. This is gopal's doing<a name='1349'></font>
<font color=#447700>!===================================================================================<a name='1350'></font>
<font color=#447700>!<a name='1351'></font>
<A NAME='MED_ANALYSIS_IN'><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1352'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_analysis_in</font> ( grid , config_flags ) <A href='../../call_to/MED_ANALYSIS_IN.html' TARGET='index'>1</A>,<A href='../../call_from/MED_ANALYSIS_IN.html' TARGET='index'>16</A><a name='1353'>
  <font color=#447700>! Driver layer<a name='1354'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_358">    , ONLY : domain, domain_clock_get<a name='1355'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_26"><a name='1356'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_52"><a name='1357'>
  <font color=#447700>! Model layer<a name='1358'></font>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_219"> , ONLY : grid_config_rec_type<a name='1359'>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_7"><a name='1360'>
<font color=#447700>!zhang   USE WRF_ESMF_MOD<a name='1361'></font>
<a name='1362'>
   IMPLICIT NONE<a name='1363'>
<a name='1364'>
  <font color=#447700>! Arguments<a name='1365'></font>
   TYPE(domain)                               :: grid<a name='1366'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1367'>
<a name='1368'>
  <font color=#447700>! Local<a name='1369'></font>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='1370'>
   CHARACTER*256                          :: rstname , outname<a name='1371'>
   INTEGER                                :: fid , rid<a name='1372'>
   CHARACTER (LEN=256)                    :: message<a name='1373'>
   INTEGER                                :: ierr<a name='1374'>
   INTEGER                                :: myproc<a name='1375'>
<font color=#447700>!zhang old    TYPE(ESMF_Time)                        :: CurrTime<a name='1376'></font>
   TYPE(WRFU_Time)                        :: CurrTime<a name='1377'>
   CHARACTER*80                           :: timestr<a name='1378'>
<a name='1379'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1380'>
     CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_7"><a name='1381'>
   END IF<a name='1382'>
<a name='1383'>
   rid=grid%id<a name='1384'>
<a name='1385'>
<font color=#447700>!zhang's doing   CALL ESMF_ClockGet( grid%domain_clock, CurrTime=CurrTime, rc=ierr )<a name='1386'></font>
<font color=#447700>!zhang's doing   CALL wrf_timetoa ( CurrTime, timestr )<a name='1387'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_53">( grid, current_timestr=timestr )<a name='1388'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_14"> ( rstname ,config_flags%anl_outname, grid%id , 2 , timestr )<a name='1389'>
<a name='1390'>
   WRITE( message , '("med_analysis_in: opening ",A," for reading")' ) TRIM ( rstname )<a name='1391'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_953">( 1 , message )<a name='1392'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_14"> ( rid, TRIM(rstname), grid , &amp;<a name='1393'>
                         config_flags , "DATASET=RESTART", ierr )<a name='1394'>
<a name='1395'>
   IF ( ierr .NE. 0 ) THEN<a name='1396'>
      <font color=#447700>! Could not open the analysis file, so notify user and abort.<a name='1397'></font>
<a name='1398'>
      write(message,'(A,I0,A,A,A)') 'ERROR: Domain ',grid%id,' analysis file ',trim(rstname),' is missing.'<a name='1399'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1335">(message)<a name='1400'>
<a name='1401'>
      <font color=#447700>! It is unsafe to continue with a cold start when the analysis<a name='1402'></font>
      <font color=#447700>! file is missing because the model expects that it is being<a name='1403'></font>
      <font color=#447700>! restart if an analysis=T.  Hence, some variables will not be<a name='1404'></font>
      <font color=#447700>! correctly initialized.<a name='1405'></font>
<a name='1406'>
      <font color=#447700>! Thus, we never reach this line:<a name='1407'></font>
      write(message,'(A,I0,A)') '-------&gt; Domain ',grid%id,' running as a cold start (interp from parent).'<a name='1408'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1155">(message)<a name='1409'>
<a name='1410'>
      if(wrf_dm_on_monitor()) then<a name='1411'>
         WRITE ( message , FMT = '("Failing to read restart for domain ",I8)' ) grid%id<a name='1412'>
         CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_7"> ( TRIM(message) )<a name='1413'>
      endif<a name='1414'>
<a name='1415'>
      return<a name='1416'>
   ELSE<a name='1417'>
      <font color=#447700>! Was able to open the analysis file.  Read it as a restart file.<a name='1418'></font>
<a name='1419'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#INPUT_RESTART'>input_restart</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_RESTART_3"> ( rid, grid , config_flags , ierr )<a name='1420'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='1421'>
         WRITE ( message , FMT = '("Reading restart for domain ",I8)' ) grid%id<a name='1422'>
         CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_8"> ( TRIM(message) )<a name='1423'>
      END IF<a name='1424'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_29"> ( rid , config_flags , "DATASET=RESTART" )<a name='1425'>
   ENDIF<a name='1426'>
<a name='1427'>
   RETURN<a name='1428'>
<a name='1429'>
END SUBROUTINE med_analysis_in<a name='1430'>
<font color=#447700>!=========================================================================================================<a name='1431'></font>
<font color=#447700>!=========================================================================================================<a name='1432'></font>
<A NAME='MED_ANALYSIS_OUT'><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1433'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_analysis_out</font> ( grid , config_flags ) <A href='../../call_to/MED_ANALYSIS_OUT.html' TARGET='index'>1</A>,<A href='../../call_from/MED_ANALYSIS_OUT.html' TARGET='index'>15</A><a name='1434'>
  <font color=#447700>! Driver layer<a name='1435'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_359">    , ONLY : domain, domain_clock_get<a name='1436'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_27"><a name='1437'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_53"><a name='1438'>
  <font color=#447700>! Model layer<a name='1439'></font>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_220"> , ONLY : grid_config_rec_type<a name='1440'>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_8"><a name='1441'>
<font color=#447700>!zhang   USE WRF_ESMF_MOD<a name='1442'></font>
<a name='1443'>
   IMPLICIT NONE<a name='1444'>
<a name='1445'>
  <font color=#447700>! Arguments<a name='1446'></font>
   TYPE(domain)                               :: grid<a name='1447'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1448'>
<a name='1449'>
  <font color=#447700>! Local<a name='1450'></font>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='1451'>
   CHARACTER*256                          :: rstname , outname<a name='1452'>
   INTEGER                                :: fid , rid<a name='1453'>
   CHARACTER (LEN=256)                    :: message<a name='1454'>
   INTEGER                                :: ierr<a name='1455'>
   INTEGER                                :: myproc<a name='1456'>
<font color=#447700>!zhang   TYPE(ESMF_Time)                        :: CurrTime<a name='1457'></font>
   TYPE(WRFU_Time)                        :: CurrTime<a name='1458'>
   CHARACTER*80                           :: timestr<a name='1459'>
<a name='1460'>
   if(.not. config_flags%write_analysis) then<a name='1461'>
      write(message,'("Writing of an analysis file is disabled for domain ",I0," because write_analysis=F")') grid%id<a name='1462'>
      call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_954">(1,message)<a name='1463'>
      return<a name='1464'>
   endif<a name='1465'>
<a name='1466'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1467'>
     CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_8"><a name='1468'>
   END IF<a name='1469'>
<a name='1470'>
   rid=grid%id<a name='1471'>
<a name='1472'>
<font color=#447700>!zhang's doing   CALL ESMF_ClockGet( grid%domain_clock, CurrTime=CurrTime, rc=ierr )<a name='1473'></font>
<font color=#447700>!zhang's doing   CALL wrf_timetoa ( CurrTime, timestr )<a name='1474'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_54">( grid, current_timestr=timestr )<a name='1475'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_15"> ( rstname ,config_flags%anl_outname, grid%id , 2 , timestr )<a name='1476'>
<a name='1477'>
   WRITE( message , '("med_analysis_out: opening ",A," for writing")' ) TRIM ( rstname )<a name='1478'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_955">( 1 , message )<a name='1479'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_21"> ( rid, TRIM(rstname), grid , &amp;<a name='1480'>
                         config_flags , output_restart , "DATASET=RESTART", ierr )<a name='1481'>
<a name='1482'>
   IF ( ierr .NE. 0 ) THEN<a name='1483'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1156">( message )<a name='1484'>
   ENDIF<a name='1485'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#OUTPUT_RESTART'>output_restart</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_RESTART_1"> ( rid, grid , config_flags , ierr )<a name='1486'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1487'>
     WRITE ( message , FMT = '("Writing restart for domain ",I8)' ) grid%id<a name='1488'>
     CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_9"> ( TRIM(message) )<a name='1489'>
   END IF<a name='1490'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ANALYSIS_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_30"> ( rid , config_flags , "DATASET=RESTART" )<a name='1491'>
   RETURN<a name='1492'>
END SUBROUTINE med_analysis_out<a name='1493'>
<a name='1494'>
#endif <a name='1495'>
<a name='1496'>
<A NAME='MED_RESTART_OUT'><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1497'>
RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>med_restart_out</font> ( grid , config_flags ) <A href='../../call_to/MED_RESTART_OUT.html' TARGET='index'>4</A>,<A href='../../call_from/MED_RESTART_OUT.html' TARGET='index'>15</A><a name='1498'>
  <font color=#447700>! Driver layer<a name='1499'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_360">    , ONLY : domain , domain_clock_get<a name='1500'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_28"><a name='1501'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_54"><a name='1502'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_221"> , ONLY : grid_config_rec_type<a name='1503'>
  <font color=#447700>! Model layer<a name='1504'></font>
<font color=#447700>!   USE module_bc_time_utilities<a name='1505'></font>
   USE module_utility<a name='1506'>
<a name='1507'>
   IMPLICIT NONE<a name='1508'>
<a name='1509'>
  <font color=#447700>! Arguments<a name='1510'></font>
   TYPE(domain)                               :: grid<a name='1511'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1512'>
<a name='1513'>
  <font color=#447700>! Local<a name='1514'></font>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='1515'>
   CHARACTER*256                          :: rstname , outname<a name='1516'>
   INTEGER                                :: fid , rid, kid<a name='1517'>
   CHARACTER (LEN=256)                    :: message<a name='1518'>
   INTEGER                                :: ierr<a name='1519'>
   INTEGER                                :: myproc<a name='1520'>
   CHARACTER*80                           :: timestr<a name='1521'>
   TYPE (grid_config_rec_type)            :: kid_config_flags<a name='1522'>
<a name='1523'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1524'>
     CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_9"><a name='1525'>
   END IF<a name='1526'>
<a name='1527'>
<font color=#447700>! take this out - no effect - LPC<a name='1528'></font>
<font color=#447700>!   rid=grid%id !zhang's doing<a name='1529'></font>
<a name='1530'>
   <font color=#447700>! write out this domains restart file first<a name='1531'></font>
<a name='1532'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_55">( grid, current_timestr=timestr )<a name='1533'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_16"> ( rstname , config_flags%rst_outname , grid%id , 2 , timestr )<a name='1534'>
<a name='1535'>
   WRITE( message , '("med_restart_out: opening ",A," for writing")' ) TRIM ( rstname )<a name='1536'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_956">( 1 , message )<a name='1537'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_22"> ( rid, TRIM(rstname), grid , &amp;<a name='1538'>
                         config_flags , output_restart , "DATASET=RESTART", ierr )<a name='1539'>
<a name='1540'>
   IF ( ierr .NE. 0 ) THEN<a name='1541'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1157">( message )<a name='1542'>
   ENDIF<a name='1543'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#OUTPUT_RESTART'>output_restart</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_RESTART_2"> ( rid, grid , config_flags , ierr )<a name='1544'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1545'>
     WRITE ( message , FMT = '("Writing restart for domain ",I8)' ) grid%id<a name='1546'>
     CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_10"> ( TRIM(message) )<a name='1547'>
   END IF<a name='1548'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_31"> ( rid , config_flags , "DATASET=RESTART" )<a name='1549'>
<a name='1550'>
   <font color=#447700>! call recursively for children, (if any)<a name='1551'></font>
   DO kid = 1, max_nests<a name='1552'>
      IF ( ASSOCIATED( grid%nests(kid)%ptr ) ) THEN<a name='1553'>
        CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_67"> ( grid%nests(kid)%ptr%id , model_config_rec , kid_config_flags )<a name='1554'>
        CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT'>med_restart_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_RESTART_OUT_4"> ( grid%nests(kid)%ptr , kid_config_flags ) <a name='1555'>
      ENDIF<a name='1556'>
   ENDDO<a name='1557'>
<a name='1558'>
   RETURN<a name='1559'>
END SUBROUTINE med_restart_out<a name='1560'>
<a name='1561'>
#if ( NMM_CORE == 1 &amp;&amp; NMM_NEST == 1)<a name='1562'>
#ifdef EXTRA_HWRF_DEBUG_STUFF<a name='1563'>
<A NAME='MED_BOUNDARY_OUT'><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1564'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_boundary_out</font> ( grid , config_flags ),<A href='../../call_from/MED_BOUNDARY_OUT.html' TARGET='index'>10</A><a name='1565'>
  <font color=#447700>! Driver layer<a name='1566'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_361">    , ONLY : domain , domain_clock_get<a name='1567'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_29"><a name='1568'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_55"><a name='1569'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_222"> , ONLY : grid_config_rec_type<a name='1570'>
  <font color=#447700>! Model layer<a name='1571'></font>
<font color=#447700>!   USE module_bc_time_utilities<a name='1572'></font>
   USE module_utility<a name='1573'>
   use <A href='../../html_code/frame/module_bdywrite.F.html#MODULE_BDYWRITE'>module_bdywrite</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BDYWRITE_1"><a name='1574'>
<a name='1575'>
   IMPLICIT NONE<a name='1576'>
<a name='1577'>
  <font color=#447700>! Arguments<a name='1578'></font>
   TYPE(domain)                               :: grid<a name='1579'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1580'>
<a name='1581'>
  <font color=#447700>! Local<a name='1582'></font>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='1583'>
   CHARACTER*256                          :: rstname , outname<a name='1584'>
   INTEGER                                :: fid , rid, kid<a name='1585'>
   CHARACTER (LEN=256)                    :: message<a name='1586'>
   INTEGER                                :: ierr<a name='1587'>
   INTEGER                                :: myproc<a name='1588'>
   CHARACTER*80                           :: timestr<a name='1589'>
   TYPE (grid_config_rec_type)            :: kid_config_flags<a name='1590'>
<a name='1591'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1592'>
     CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_10"><a name='1593'>
   END IF<a name='1594'>
<a name='1595'>
<font color=#447700>! take this out - no effect - LPC<a name='1596'></font>
<font color=#447700>!   rid=grid%id !zhang's doing<a name='1597'></font>
<a name='1598'>
   <font color=#447700>! write out this domains boundary file first<a name='1599'></font>
<a name='1600'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_56">( grid, current_timestr=timestr )<a name='1601'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_17"> ( rstname , 'sambdyout_d&lt;domain&gt;_&lt;date&gt;' , grid%id , 2 , timestr )<a name='1602'>
<a name='1603'>
   call <A href='../../html_code/frame/module_bdywrite.F.html#BDYWRITE'>bdywrite</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BDYWRITE_1">(grid,rstname)<a name='1604'>
<a name='1605'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1606'>
     CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_BOUNDARY_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_11">('Sam''s Special Boundary Output (TM)')<a name='1607'>
   END IF<a name='1608'>
   RETURN<a name='1609'>
END SUBROUTINE med_boundary_out<a name='1610'>
#endif<a name='1611'>
#endif<a name='1612'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1613'></font>
<a name='1614'>
#if ( HWRF == 1 )<a name='1615'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1616'></font>
<font color=#447700>!zhang's doing<a name='1617'></font>
<A NAME='MED_RESTART_IN'><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1618'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_restart_in</font> ( grid , config_flags ) <A href='../../call_to/MED_RESTART_IN.html' TARGET='index'>1</A>,<A href='../../call_from/MED_RESTART_IN.html' TARGET='index'>14</A><a name='1619'>
  <font color=#447700>! Driver layer<a name='1620'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_362">    , ONLY : domain, domain_clock_get<a name='1621'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_30"><a name='1622'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_56"><a name='1623'>
  <font color=#447700>! Model layer<a name='1624'></font>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_223"> , ONLY : grid_config_rec_type<a name='1625'>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_9"><a name='1626'>
<a name='1627'>
   IMPLICIT NONE<a name='1628'>
<a name='1629'>
  <font color=#447700>! Arguments<a name='1630'></font>
   TYPE(domain)                               :: grid<a name='1631'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1632'>
<a name='1633'>
  <font color=#447700>! Local<a name='1634'></font>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='1635'>
   CHARACTER*256                          :: rstname , outname<a name='1636'>
   INTEGER                                :: fid , rid<a name='1637'>
   CHARACTER (LEN=256)                    :: message<a name='1638'>
   INTEGER                                :: ierr<a name='1639'>
   INTEGER                                :: myproc<a name='1640'>
<font color=#447700>!zhang old    TYPE(ESMF_Time)                        :: CurrTime<a name='1641'></font>
   TYPE(WRFU_Time)                        :: CurrTime<a name='1642'>
   CHARACTER*80                           :: timestr<a name='1643'>
<a name='1644'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1645'>
     CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_11"><a name='1646'>
   END IF<a name='1647'>
<a name='1648'>
   rid=grid%id<a name='1649'>
<a name='1650'>
<font color=#447700>!zhang's doing   CALL ESMF_ClockGet( grid%domain_clock, CurrTime=CurrTime, rc=ierr )<a name='1651'></font>
<font color=#447700>!zhang's doing   CALL wrf_timetoa ( CurrTime, timestr )<a name='1652'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_57">( grid, current_timestr=timestr )<a name='1653'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_18"> ( rstname ,config_flags%rst_outname, grid%id , 2 , timestr )<a name='1654'>
<a name='1655'>
   WRITE( message , '("med_restart_in: opening ",A," for reading")' ) TRIM ( rstname )<a name='1656'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_957">( 1 , message )<a name='1657'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_15"> ( rid, TRIM(rstname), grid , &amp;<a name='1658'>
                         config_flags , "DATASET=RESTART", ierr )<a name='1659'>
<a name='1660'>
   IF ( ierr .NE. 0 ) THEN<a name='1661'>
<font color=#447700>!    CALL WRF_message( message )<a name='1662'></font>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1336">('NESTED DOMAIN ERROR: FOR ANALYSIS SET TO TRUE, YOU NEED wrfanal FILE')<a name='1663'>
   ENDIF<a name='1664'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#INPUT_RESTART'>input_restart</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_RESTART_4"> ( rid, grid , config_flags , ierr )<a name='1665'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1666'>
     WRITE ( message , FMT = '("Reading restart for domain ",I8)' ) grid%id<a name='1667'>
     CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_12"> ( TRIM(message) )<a name='1668'>
   END IF<a name='1669'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_32"> ( rid , config_flags , "DATASET=RESTART" )<a name='1670'>
   RETURN<a name='1671'>
<a name='1672'>
END SUBROUTINE med_restart_in<a name='1673'>
<font color=#447700>!end of zhang's doing<a name='1674'></font>
#endif<a name='1675'>
<a name='1676'>
<A NAME='MED_HIST_OUT'><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1677'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_hist_out</font> ( grid , stream, config_flags ) <A href='../../call_to/MED_HIST_OUT.html' TARGET='index'>6</A>,<A href='../../call_from/MED_HIST_OUT.html' TARGET='index'>12</A><a name='1678'>
  <font color=#447700>! Driver layer<a name='1679'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_363">    , ONLY : domain<a name='1680'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_57"><a name='1681'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_31"><a name='1682'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_224"> , ONLY : grid_config_rec_type<a name='1683'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_179">, ONLY : intercomm_active<a name='1684'>
<font color=#447700>!   USE module_bc_time_utilities<a name='1685'></font>
   USE module_utility<a name='1686'>
<a name='1687'>
   IMPLICIT NONE<a name='1688'>
  <font color=#447700>! Arguments<a name='1689'></font>
   TYPE(domain)                               :: grid<a name='1690'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1691'>
   INTEGER , INTENT(IN)                       :: stream<a name='1692'>
  <font color=#447700>! Local<a name='1693'></font>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='1694'>
   CHARACTER*256                          :: fname, n2<a name='1695'>
   CHARACTER (LEN=256)                    :: message<a name='1696'>
   INTEGER                                :: ierr<a name='1697'>
<a name='1698'>
   IF ( .NOT. grid%active_this_task ) RETURN<a name='1699'>
<a name='1700'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1701'>
     CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_12"><a name='1702'>
   END IF<a name='1703'>
<a name='1704'>
   IF ( stream .LT. first_history .OR. stream .GT. last_auxhist ) THEN<a name='1705'>
     WRITE(message,*)'med_hist_out: invalid history stream ',stream<a name='1706'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1337">( message )<a name='1707'>
   ENDIF<a name='1708'>
<a name='1709'>
#if ( HWRF == 1 )<a name='1710'>
       <font color=#447700>! HWRF special: auxhist2 and auxhist3 are duplicates of<a name='1711'></font>
       <font color=#447700>! history (0), so there is no point in outputting more than one of<a name='1712'></font>
       <font color=#447700>! them at the same time.  Prefer 0 over 2, and 2 over 3:<a name='1713'></font>
      if ( (stream==HISTORY_ALARM .or. stream==AUXHIST2_ALARM) .and. &amp;<a name='1714'>
           WRFU_AlarmIsRinging( grid%alarms(AUXHIST3_ALARM) ) ) then<a name='1715'>
         CALL WRFU_AlarmRingerOff(grid%alarms(AUXHIST3_ALARM))<a name='1716'>
      endif<a name='1717'>
      if ( stream==HISTORY_ALARM .and. &amp;<a name='1718'>
           WRFU_AlarmIsRinging( grid%alarms(AUXHIST2_ALARM) ) ) then<a name='1719'>
         CALL WRFU_AlarmRingerOff(grid%alarms(AUXHIST2_ALARM))<a name='1720'>
      endif<a name='1721'>
#endif<a name='1722'>
<a name='1723'>
   SELECT CASE( stream )<a name='1724'>
     CASE ( HISTORY_ALARM )<a name='1725'>
       CALL <A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W'>open_hist_w</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_HIST_W_1">( grid, config_flags, stream, HISTORY_ALARM, &amp;<a name='1726'>
                         config_flags%history_outname, grid%oid,    &amp;<a name='1727'>
                         output_history, fname, n2, ierr )<a name='1728'>
       CALL output_history ( grid%oid, grid , config_flags , ierr )<a name='1729'>
<a name='1730'>
<font color=#447700>! registry-generated selections and calls top open_hist_w for aux streams<a name='1731'></font>
#include "<A href='../../html_code/include/med_hist_out_opens.inc.html'>med_hist_out_opens.inc</A>"<A NAME="med_hist_out_opens.inc_2"><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1732'>
<a name='1733'>
   END SELECT<a name='1734'>
<a name='1735'>
   WRITE(message,*)'med_hist_out: opened ',TRIM(fname),' as ',TRIM(n2)<a name='1736'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_958">( 1, message )<a name='1737'>
<a name='1738'>
   grid%nframes(stream) = grid%nframes(stream) + 1<a name='1739'>
<a name='1740'>
   SELECT CASE( stream )<a name='1741'>
     CASE ( HISTORY_ALARM )<a name='1742'>
       IF ( grid%nframes(stream) &gt;= config_flags%frames_per_outfile ) THEN<a name='1743'>
write(0,*)__FILE__,__LINE__,trim(n2)<a name='1744'>
write(0,*)__FILE__,__LINE__,' grid%id ',grid%id,' grid%oid ',grid%oid<a name='1745'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_33"> ( grid%oid , config_flags , n2 ) <a name='1746'>
         grid%oid = 0<a name='1747'>
         grid%nframes(stream) = 0<a name='1748'>
       ENDIF<a name='1749'>
<font color=#447700>! registry-generated selections and calls top close_dataset for aux streams<a name='1750'></font>
#include "<A href='../../html_code/include/med_hist_out_closes.inc.html'>med_hist_out_closes.inc</A>"<A NAME="med_hist_out_closes.inc_3"><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1751'>
<a name='1752'>
   END SELECT<a name='1753'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1754'>
     WRITE ( message , FMT = '("Writing ",A," for domain ",I8)' )TRIM(fname),grid%id<a name='1755'>
     CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_13"> ( TRIM(message) )<a name='1756'>
   END IF<a name='1757'>
<a name='1758'>
#if (NMM_CORE == 1)<a name='1759'>
   <font color=#447700>! Reset tornado genesis fields after output:<a name='1760'></font>
   call <A href='../../html_code/dyn_nmm/module_tornado_genesis.F.html#NMM_REQUEST_TG_RESET'>nmm_request_tg_reset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_HIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NMM_REQUEST_TG_RESET_1">(grid,config_flags,stream)<a name='1761'>
#endif<a name='1762'>
<a name='1763'>
   RETURN<a name='1764'>
END SUBROUTINE med_hist_out<a name='1765'>
<a name='1766'>
#if (DA_CORE <font color=#447700>!= 1)<a name='1767'></font>
<A NAME='MED_FDDAOBS_IN'><A href='../../html_code/share/mediation_integrate.F.html#MED_FDDAOBS_IN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1768'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_fddaobs_in</font> ( grid , config_flags ) <A href='../../call_to/MED_FDDAOBS_IN.html' TARGET='index'>1</A>,<A href='../../call_from/MED_FDDAOBS_IN.html' TARGET='index'>3</A><a name='1769'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FDDAOBS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_364">    , ONLY : domain<a name='1770'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FDDAOBS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_225"> , ONLY : grid_config_rec_type<a name='1771'>
   IMPLICIT NONE<a name='1772'>
   TYPE(domain)                               :: grid<a name='1773'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1774'>
   CALL <A href='../../html_code/share/wrf_fddaobs_in.F.html#WRF_FDDAOBS_IN'>wrf_fddaobs_in</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FDDAOBS_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_FDDAOBS_IN_1">( grid, config_flags )<a name='1775'>
   RETURN<a name='1776'>
END SUBROUTINE med_fddaobs_in<a name='1777'>
#endif<a name='1778'>
<a name='1779'>
<A NAME='MED_AUXINPUT_IN'><A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1780'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_auxinput_in</font> ( grid , stream, config_flags ) <A href='../../call_to/MED_AUXINPUT_IN.html' TARGET='index'>5</A>,<A href='../../call_from/MED_AUXINPUT_IN.html' TARGET='index'>4</A><a name='1781'>
  <font color=#447700>! Driver layer<a name='1782'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_365">    , ONLY : domain<a name='1783'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_32"><a name='1784'>
  <font color=#447700>! Model layer<a name='1785'></font>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_226"> , ONLY : grid_config_rec_type<a name='1786'>
<font color=#447700>!   USE module_bc_time_utilities<a name='1787'></font>
   USE module_utility<a name='1788'>
<a name='1789'>
   IMPLICIT NONE<a name='1790'>
  <font color=#447700>! Arguments<a name='1791'></font>
   TYPE(domain)                               :: grid<a name='1792'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1793'>
   INTEGER , INTENT(IN)                       :: stream<a name='1794'>
  <font color=#447700>! Local<a name='1795'></font>
   CHARACTER (LEN=256)                        :: message<a name='1796'>
   INTEGER :: ierr<a name='1797'>
<a name='1798'>
   IF ( stream .LT. first_auxinput .OR. stream .GT. last_auxinput ) THEN<a name='1799'>
     WRITE(message,*)'med_auxinput_in: invalid input stream ',stream<a name='1800'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1338">( message )<a name='1801'>
   ENDIF<a name='1802'>
<a name='1803'>
   grid%nframes(stream) = grid%nframes(stream) + 1<a name='1804'>
<a name='1805'>
   SELECT CASE( stream )<a name='1806'>
<font color=#447700>! registry-generated file of calls to open filename<a name='1807'></font>
<font color=#447700>!     CASE ( AUXINPUT1_ALARM )<a name='1808'></font>
<font color=#447700>!       CALL open_aux_u( grid, config_flags, stream, AUXINPUT1_ALARM,       &amp;<a name='1809'></font>
<font color=#447700>!                        config_flags%auxinput1_inname, grid%auxinput1_oid, &amp;<a name='1810'></font>
<font color=#447700>!                        input_auxinput1, ierr )<a name='1811'></font>
<font color=#447700>!       CALL input_auxinput1 ( grid%auxinput1_oid, grid , config_flags , ierr )<a name='1812'></font>
#include "<A href='../../html_code/include/med_auxinput_in.inc.html'>med_auxinput_in.inc</A>"<A NAME="med_auxinput_in.inc_4"><A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1813'>
   END SELECT<a name='1814'>
<a name='1815'>
   SELECT CASE( stream )<a name='1816'>
<font color=#447700>! registry-generated selections and calls top close_dataset for aux streams<a name='1817'></font>
#include "<A href='../../html_code/include/med_auxinput_in_closes.inc.html'>med_auxinput_in_closes.inc</A>"<A NAME="med_auxinput_in_closes.inc_5"><A href='../../html_code/share/mediation_integrate.F.html#MED_AUXINPUT_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1818'>
   END SELECT<a name='1819'>
<a name='1820'>
   RETURN<a name='1821'>
END SUBROUTINE med_auxinput_in<a name='1822'>
<a name='1823'>
<A NAME='MED_FILTER_OUT'><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1824'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_filter_out</font> ( grid , config_flags ) <A href='../../call_to/MED_FILTER_OUT.html' TARGET='index'>2</A>,<A href='../../call_from/MED_FILTER_OUT.html' TARGET='index'>14</A><a name='1825'>
  <font color=#447700>! Driver layer<a name='1826'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_366">    , ONLY : domain , domain_clock_get<a name='1827'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_33"><a name='1828'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_58"><a name='1829'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_227"> , ONLY : grid_config_rec_type<a name='1830'>
  <font color=#447700>! Model layer<a name='1831'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_10"><a name='1832'>
<a name='1833'>
   IMPLICIT NONE<a name='1834'>
<a name='1835'>
  <font color=#447700>! Arguments<a name='1836'></font>
   TYPE(domain)                               :: grid<a name='1837'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1838'>
<a name='1839'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='1840'>
   CHARACTER*256                          :: rstname , outname<a name='1841'>
   INTEGER                                :: fid , rid<a name='1842'>
   CHARACTER (LEN=256)                    :: message<a name='1843'>
   INTEGER                                :: ierr<a name='1844'>
   INTEGER                                :: myproc<a name='1845'>
   CHARACTER*80                           :: timestr<a name='1846'>
<a name='1847'>
   IF ( config_flags%write_input ) THEN<a name='1848'>
<a name='1849'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1850'>
     CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_13"><a name='1851'>
   END IF<a name='1852'>
<a name='1853'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_58">( grid, current_timestr=timestr )<a name='1854'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_19"> ( outname , config_flags%input_outname , grid%id , 2 , timestr )<a name='1855'>
<a name='1856'>
     WRITE ( message , '("med_filter_out 1: opening ",A," for writing. ")') TRIM ( outname )<a name='1857'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_959">( 1, message )<a name='1858'>
<a name='1859'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_23"> ( fid, TRIM(outname), grid ,  &amp;<a name='1860'>
                           config_flags , output_input , "DATASET=INPUT", ierr )<a name='1861'>
     IF ( ierr .NE. 0 ) THEN<a name='1862'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1339">( message )<a name='1863'>
     ENDIF<a name='1864'>
<a name='1865'>
     IF ( ierr .NE. 0 ) THEN<a name='1866'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1340">( message )<a name='1867'>
     ENDIF<a name='1868'>
<a name='1869'>
   CALL output_input ( fid, grid , config_flags , ierr )<a name='1870'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_34"> ( fid , config_flags , "DATASET=INPUT" )<a name='1871'>
<a name='1872'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1873'>
     WRITE ( message , FMT = '("Writing filter output for domain ",I8)' ) grid%id<a name='1874'>
     CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_FILTER_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_14"> ( TRIM(message) )<a name='1875'>
   END IF<a name='1876'>
   ENDIF<a name='1877'>
<a name='1878'>
   RETURN<a name='1879'>
END SUBROUTINE med_filter_out<a name='1880'>
<a name='1881'>
<A NAME='MED_LATBOUND_IN'><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1882'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_latbound_in</font> ( grid , config_flags ) <A href='../../call_to/MED_LATBOUND_IN.html' TARGET='index'>1</A>,<A href='../../call_from/MED_LATBOUND_IN.html' TARGET='index'>29</A><a name='1883'>
  <font color=#447700>! Driver layer<a name='1884'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_367">    , ONLY : domain , domain_clock_get, head_grid<a name='1885'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_34"><a name='1886'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_59"><a name='1887'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_228"> , ONLY : grid_config_rec_type<a name='1888'>
  <font color=#447700>! Model layer<a name='1889'></font>
<font color=#447700>!   USE module_bc_time_utilities<a name='1890'></font>
   USE module_utility<a name='1891'>
<a name='1892'>
   IMPLICIT NONE<a name='1893'>
<a name='1894'>
#include "<A href='../../html_code/include/wrf_status_codes.h.html'>wrf_status_codes.h</A>"<A NAME="wrf_status_codes.h_6"><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1895'>
<a name='1896'>
  <font color=#447700>! Arguments<a name='1897'></font>
   TYPE(domain)                               :: grid<a name='1898'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='1899'>
<a name='1900'>
  <font color=#447700>! Local data<a name='1901'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='1902'>
   LOGICAL                                :: lbc_opened<a name='1903'>
   INTEGER                                :: idum1 , idum2 , ierr , open_status , fid, rc<a name='1904'>
   REAL                                   :: bfrq<a name='1905'>
   CHARACTER (LEN=256)                    :: message<a name='1906'>
   CHARACTER (LEN=256)                    :: bdyname<a name='1907'>
   Type (WRFU_Time )                      :: startTime, stopTime, currentTime<a name='1908'>
   Type (WRFU_TimeInterval )              :: stepTime<a name='1909'>
integer myproc,i,j,k<a name='1910'>
#ifdef _MULTI_BDY_FILES_<a name='1911'>
   CHARACTER(LEN=80)                      :: timestr<a name='1912'>
#endif<a name='1913'>
<a name='1914'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_7"><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1915'>
<a name='1916'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_960"> ( 200 , 'in med_latbound_in' )<a name='1917'>
<a name='1918'>
<font color=#447700>! #if (EM_CORE == 1)<a name='1919'></font>
   <font color=#447700>! Avoid trying to re-read the boundary conditions if we are doing DFI integration<a name='1920'></font>
   <font color=#447700>!    and do not expect to find boundary conditions for the current time<a name='1921'></font>
   IF ( (grid%dfi_opt .EQ. DFI_DDFI .OR. grid%dfi_opt .EQ. DFI_TDFI) .AND. grid%dfi_stage .EQ. DFI_FWD ) RETURN<a name='1922'>
<font color=#447700>! #endif<a name='1923'></font>
<a name='1924'>
   IF ( grid%active_this_task .AND. grid%id .EQ. 1 .AND. config_flags%specified .AND. config_flags%io_form_boundary .GT. 0 ) THEN<a name='1925'>
<a name='1926'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_59">( grid, current_time=currentTime, &amp;<a name='1927'>
                                  start_time=startTime,     &amp;<a name='1928'>
                                  stop_time=stopTime,       &amp;<a name='1929'>
                                  time_step=stepTime )<a name='1930'>
<a name='1931'>
<font color=#447700>!jm 20110828<a name='1932'></font>
<font color=#447700>!jm The test below never worked because set_time_time_read_again is never called to store a <a name='1933'></font>
<font color=#447700>!jm time that lbc_read_time can compare with currentTime (see module_bc_time_utilities). This means <a name='1934'></font>
<font color=#447700>!jm lbc_read_time will never return anything but false -- will also generate an ESMF error that the <a name='1935'></font>
<font color=#447700>!jm stored time was never initialized.  Removing that branch from the conditional.<a name='1936'></font>
<font color=#447700>!jm     IF ( ( lbc_read_time( currentTime ) ) .AND. &amp;<a name='1937'></font>
<font color=#447700>!jm          ( currentTime + stepTime .GE. stopTime ) .AND. &amp;<a name='1938'></font>
<font color=#447700>!jm          ( currentTime .NE. startTime ) ) THEN<a name='1939'></font>
<font color=#447700>!jm       CALL wrf_debug( 100 , 'med_latbound_in: Skipping attempt to read lateral boundary file during last time step ' )<a name='1940'></font>
<font color=#447700>!jm<a name='1941'></font>
<font color=#447700>!jm     ELSE IF ( WRFU_AlarmIsRinging( grid%alarms( BOUNDARY_ALARM ), rc=rc ) ) THEN<a name='1942'></font>
<font color=#447700>!jm 20110828<a name='1943'></font>
     IF ( WRFU_AlarmIsRinging( grid%alarms( BOUNDARY_ALARM ), rc=rc ) ) THEN<a name='1944'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_961"> ( 100 , 'in med_latbound_in preparing to read' )<a name='1945'>
       CALL WRFU_AlarmRingerOff( grid%alarms( BOUNDARY_ALARM ), rc=rc )<a name='1946'>
       IF ( wrf_dm_on_monitor() ) CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_14"><a name='1947'>
<a name='1948'>
#ifdef _MULTI_BDY_FILES_<a name='1949'>
       <font color=#447700>! Possibility to have a &lt;date&gt; as part of the bdy_inname.<a name='1950'></font>
       CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_60">( grid, current_timestr=timestr )<a name='1951'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_20"> ( bdyname , config_flags%bdy_inname , grid%id , 2 , timestr )<a name='1952'>
#else<a name='1953'>
<font color=#447700>! typically a &lt;date&gt; wouldn't be part of the bdy_inname, so just pass a dummy<a name='1954'></font>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_21"> ( bdyname , config_flags%bdy_inname , grid%id , 2 , " " )<a name='1955'>
#endif<a name='1956'>
<a name='1957'>
       CALL <A href='../../html_code/frame/module_io.F.html#WRF_INQUIRE_OPENED'>wrf_inquire_opened</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_INQUIRE_OPENED_1">(grid%lbc_fid , TRIM(bdyname) , open_status , ierr ) <a name='1958'>
       IF ( open_status .EQ. WRF_FILE_OPENED_FOR_READ ) THEN<a name='1959'>
         lbc_opened = .TRUE.<a name='1960'>
       ELSE<a name='1961'>
         lbc_opened = .FALSE.<a name='1962'>
       ENDIF<a name='1963'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_382"> ( lbc_opened , LWORDSIZE )<a name='1964'>
       IF ( .NOT. lbc_opened ) THEN<a name='1965'>
#ifdef _MULTI_BDY_FILES_<a name='1966'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_22"> ( bdyname , config_flags%bdy_inname , grid%id , 2 , timestr )<a name='1967'>
#else<a name='1968'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_23"> ( bdyname , config_flags%bdy_inname , grid%id , 2 , " " )<a name='1969'>
#endif<a name='1970'>
          WRITE(message,*)'Opening: ',TRIM(bdyname)<a name='1971'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_962">(100,TRIM(message))<a name='1972'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_16"> ( grid%lbc_fid, TRIM(bdyname) , grid , config_flags , "DATASET=BOUNDARY", ierr )<a name='1973'>
          IF ( ierr .NE. 0 ) THEN<a name='1974'>
            WRITE( message, * ) 'med_latbound_in: error opening ',TRIM(bdyname), ' for reading. IERR = ',ierr<a name='1975'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1341">( message )<a name='1976'>
          ENDIF<a name='1977'>
       ELSE<a name='1978'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_963">( 100 , bdyname // ' is already opened' )<a name='1979'>
       ENDIF<a name='1980'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_964">( 100 , 'med_latbound_in: calling input_boundary ' )<a name='1981'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#INPUT_BOUNDARY'>input_boundary</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_BOUNDARY_1"> ( grid%lbc_fid, grid , config_flags , ierr )<a name='1982'>
<a name='1983'>
<font color=#447700>! #if (EM_CORE == 1)<a name='1984'></font>
       IF ( (config_flags%dfi_opt .NE. DFI_NODFI) .AND. (head_grid%dfi_stage .NE. DFI_FST) ) THEN<a name='1985'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_965">( 100 , 'med_latbound_in: closing boundary file ' )<a name='1986'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_35"> ( grid%lbc_fid , config_flags , "DATASET=BOUNDARY" )<a name='1987'>
       END IF<a name='1988'>
<font color=#447700>! #endif<a name='1989'></font>
<a name='1990'>
       CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_61">( grid, current_time=currentTime )<a name='1991'>
       DO WHILE (currentTime .GE. grid%next_bdy_time )         <font color=#447700>! next_bdy_time is set by input_boundary from bdy file<a name='1992'></font>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_966">( 100 , 'med_latbound_in: calling input_boundary ' )<a name='1993'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#INPUT_BOUNDARY'>input_boundary</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INPUT_BOUNDARY_2"> ( grid%lbc_fid, grid , config_flags , ierr )<a name='1994'>
       ENDDO<a name='1995'>
#ifdef _MULTI_BDY_FILES_<a name='1996'>
       <font color=#447700>! Close the bdy file so that next time around, we'll open it again.<a name='1997'></font>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_36"> ( grid%lbc_fid , config_flags , "DATASET=BOUNDARY" )<a name='1998'>
#endif<a name='1999'>
       CALL WRFU_AlarmSet( grid%alarms( BOUNDARY_ALARM ), RingTime=grid%next_bdy_time, rc=rc )<a name='2000'>
<a name='2001'>
       IF ( ierr .NE. 0 .and. ierr .NE. WRF_WARN_NETCDF ) THEN<a name='2002'>
         WRITE( message, * ) 'med_latbound_in: error reading ',TRIM(bdyname), ' IERR = ',ierr<a name='2003'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1342">( message )<a name='2004'>
       ENDIF<a name='2005'>
       IF ( currentTime .EQ. grid%this_bdy_time ) grid%dtbc = 0.<a name='2006'>
  <a name='2007'>
       IF ( wrf_dm_on_monitor() ) THEN<a name='2008'>
         WRITE ( message , FMT = '("processing lateral boundary for domain ",I8)' ) grid%id<a name='2009'>
         CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_LATBOUND_IN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_15"> ( TRIM(message) )<a name='2010'>
       ENDIF<a name='2011'>
     ENDIF<a name='2012'>
   ENDIF<a name='2013'>
   RETURN<a name='2014'>
END SUBROUTINE med_latbound_in<a name='2015'>
<a name='2016'>
<A NAME='MED_SETUP_STEP'><A href='../../html_code/share/mediation_integrate.F.html#MED_SETUP_STEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2017'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_setup_step</font> ( grid , config_flags ) <A href='../../call_to/MED_SETUP_STEP.html' TARGET='index'>1</A>,<A href='../../call_from/MED_SETUP_STEP.html' TARGET='index'>3</A><a name='2018'>
  <font color=#447700>! Driver layer<a name='2019'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_SETUP_STEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_368">    , ONLY : domain<a name='2020'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_SETUP_STEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_229"> , ONLY : grid_config_rec_type<a name='2021'>
  <font color=#447700>! Model layer<a name='2022'></font>
<a name='2023'>
   IMPLICIT NONE<a name='2024'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2025'></font>
<font color=#447700>!<a name='2026'></font>
<font color=#447700>!The driver layer routine integrate() calls this mediation layer routine<a name='2027'></font>
<font color=#447700>!prior to initiating a time step on the domain specified by the argument<a name='2028'></font>
<font color=#447700>!grid.  This provides the model-layer contributor an opportunity to make<a name='2029'></font>
<font color=#447700>!any pre-time-step initializations that pertain to a particular model<a name='2030'></font>
<font color=#447700>!domain.  In WRF, this routine is used to call<a name='2031'></font>
<font color=#447700>!set_scalar_indices_from_config for the specified domain.<a name='2032'></font>
<font color=#447700>!<a name='2033'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2034'></font>
<a name='2035'>
  <font color=#447700>! Arguments<a name='2036'></font>
   TYPE(domain)                               :: grid<a name='2037'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2038'>
  <font color=#447700>! Local<a name='2039'></font>
   INTEGER                                    :: idum1 , idum2<a name='2040'>
<a name='2041'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/share/mediation_integrate.F.html#MED_SETUP_STEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_20"> ( grid%id , idum1 , idum2 )<a name='2042'>
<a name='2043'>
   RETURN<a name='2044'>
<a name='2045'>
END SUBROUTINE med_setup_step<a name='2046'>
<a name='2047'>
<A NAME='MED_ENDUP_STEP'><A href='../../html_code/share/mediation_integrate.F.html#MED_ENDUP_STEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2048'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_endup_step</font> ( grid , config_flags ) <A href='../../call_to/MED_ENDUP_STEP.html' TARGET='index'>1</A>,<A href='../../call_from/MED_ENDUP_STEP.html' TARGET='index'>2</A><a name='2049'>
  <font color=#447700>! Driver layer<a name='2050'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ENDUP_STEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_369">    , ONLY : domain<a name='2051'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_ENDUP_STEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_230"> , ONLY : grid_config_rec_type, model_config_rec<a name='2052'>
  <font color=#447700>! Model layer<a name='2053'></font>
<a name='2054'>
   IMPLICIT NONE<a name='2055'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2056'></font>
<font color=#447700>!<a name='2057'></font>
<font color=#447700>!The driver layer routine integrate() calls this mediation layer routine<a name='2058'></font>
<font color=#447700>!prior to initiating a time step on the domain specified by the argument<a name='2059'></font>
<font color=#447700>!grid.  This provides the model-layer contributor an opportunity to make<a name='2060'></font>
<font color=#447700>!any pre-time-step initializations that pertain to a particular model<a name='2061'></font>
<font color=#447700>!domain.  In WRF, this routine is used to call<a name='2062'></font>
<font color=#447700>!set_scalar_indices_from_config for the specified domain.<a name='2063'></font>
<font color=#447700>!<a name='2064'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2065'></font>
<a name='2066'>
  <font color=#447700>! Arguments<a name='2067'></font>
   TYPE(domain)                               :: grid<a name='2068'>
   TYPE (grid_config_rec_type) , INTENT(OUT)   :: config_flags<a name='2069'>
  <font color=#447700>! Local<a name='2070'></font>
   INTEGER                                    :: idum1 , idum2<a name='2071'>
<a name='2072'>
   IF ( grid%id .EQ. 1 ) THEN<a name='2073'>
     <font color=#447700>! turn off the restart flag after the first mother-domain step is finished<a name='2074'></font>
     model_config_rec%restart = .FALSE.<a name='2075'>
     config_flags%restart = .FALSE.<a name='2076'>
     CALL nl_set_restart(1, .FALSE.)<a name='2077'>
<a name='2078'>
   ENDIF<a name='2079'>
<a name='2080'>
   RETURN<a name='2081'>
<a name='2082'>
END SUBROUTINE med_endup_step<a name='2083'>
<a name='2084'>
<A NAME='OPEN_AUX_U'><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2085'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>open_aux_u</font> ( grid , config_flags, stream, alarm_id, &amp;,<A href='../../call_from/OPEN_AUX_U.html' TARGET='index'>10</A><a name='2086'>
                        auxinput_inname, oid, insub, ierr )<a name='2087'>
  <font color=#447700>! Driver layer<a name='2088'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_370">    , ONLY : domain , domain_clock_get<a name='2089'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_35"><a name='2090'>
  <font color=#447700>! Model layer<a name='2091'></font>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_231"> , ONLY : grid_config_rec_type<a name='2092'>
<font color=#447700>!   USE module_bc_time_utilities<a name='2093'></font>
   USE module_utility<a name='2094'>
<a name='2095'>
   IMPLICIT NONE<a name='2096'>
  <font color=#447700>! Arguments<a name='2097'></font>
   TYPE(domain)                                :: grid<a name='2098'>
   TYPE (grid_config_rec_type) , INTENT(IN)    :: config_flags<a name='2099'>
   INTEGER ,                     INTENT(IN)    :: stream<a name='2100'>
   INTEGER ,                     INTENT(IN)    :: alarm_id<a name='2101'>
   CHARACTER*(*) ,               INTENT(IN)    :: auxinput_inname<a name='2102'>
   INTEGER ,                     INTENT(INOUT) :: oid<a name='2103'>
   EXTERNAL                                       insub<a name='2104'>
   INTEGER ,                     INTENT(OUT)   :: ierr<a name='2105'>
  <font color=#447700>! Local<a name='2106'></font>
   INTEGER                                :: stream_l<a name='2107'>
   CHARACTER*256                          :: fname, n2<a name='2108'>
   CHARACTER (LEN=256)                    :: message<a name='2109'>
   CHARACTER*80                           :: timestr<a name='2110'>
   TYPE(WRFU_Time)                        :: ST,CT<a name='2111'>
   LOGICAL                                :: adjust<a name='2112'>
<a name='2113'>
   IF ( stream .LT. first_stream .OR. stream .GT. last_stream ) THEN<a name='2114'>
     WRITE(message,*)'open_aux_u: invalid input stream ',stream<a name='2115'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1343">( message )<a name='2116'>
   ENDIF<a name='2117'>
<a name='2118'>
   ierr = 0<a name='2119'>
<a name='2120'>
   IF ( oid .eq. 0 ) THEN<a name='2121'>
     CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_62">( grid, current_time=CT, start_time=ST, &amp;<a name='2122'>
                            current_timestr=timestr )<a name='2123'>
     CALL nl_get_adjust_input_times( grid%id, adjust )<a name='2124'>
     IF ( adjust ) THEN <a name='2125'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#ADJUST_IO_TIMESTR'>adjust_io_timestr</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_IO_TIMESTR_2">( grid%io_intervals( alarm_id ), CT, ST, timestr )<a name='2126'>
     ENDIF<a name='2127'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_24"> ( fname , auxinput_inname, &amp;<a name='2128'>
                                 grid%id , 2 , timestr )<a name='2129'>
     stream_l = stream-auxinput1_only+1<a name='2130'>
     IF ( stream_l .GE. 10 ) THEN<a name='2131'>
       WRITE(n2,'("DATASET=AUXINPUT",I2)')stream_l<a name='2132'>
     ELSE<a name='2133'>
       WRITE(n2,'("DATASET=AUXINPUT",I1)')stream_l<a name='2134'>
     ENDIF<a name='2135'>
     WRITE ( message , '("open_aux_u : opening ",A," for reading. DATASET ",A)') TRIM ( fname ),TRIM(n2)<a name='2136'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_967">( 1, message )<a name='2137'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2138'></font>
<font color=#447700>!<a name='2139'></font>
<font color=#447700>!Open_u_dataset is called rather than open_r_dataset to allow interfaces<a name='2140'></font>
<font color=#447700>!that can do blending or masking to update an existing field. (MCEL IO does this).<a name='2141'></font>
<font color=#447700>!No effect for other interfaces; open_u_dataset is equivalent to open_r_dataset <a name='2142'></font>
<font color=#447700>!in those cases.<a name='2143'></font>
<font color=#447700>!<a name='2144'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2145'></font>
     CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_U_DATASET'>open_u_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_U_DATASET_1"> ( oid, TRIM(fname), grid ,  &amp;<a name='2146'>
                           config_flags , insub , n2, ierr )<a name='2147'>
   ENDIF<a name='2148'>
   IF ( ierr .NE. 0 ) THEN<a name='2149'>
     WRITE ( message , '("open_aux_u : error opening ",A," for reading. ",I3)') &amp;<a name='2150'>
       TRIM ( fname ), ierr<a name='2151'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_AUX_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1158">( message )<a name='2152'>
   ENDIF<a name='2153'>
   RETURN<a name='2154'>
END SUBROUTINE open_aux_u<a name='2155'>
<a name='2156'>
<A NAME='OPEN_HIST_W'><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2157'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>open_hist_w</font> ( grid , config_flags, stream, alarm_id, &amp; <A href='../../call_to/OPEN_HIST_W.html' TARGET='index'>1</A>,<A href='../../call_from/OPEN_HIST_W.html' TARGET='index'>14</A><a name='2158'>
                         hist_outname, oid, outsub, fname, n2, ierr )<a name='2159'>
  <font color=#447700>! Driver layer<a name='2160'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_371">    , ONLY : domain , domain_clock_get<a name='2161'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_36"><a name='2162'>
  <font color=#447700>! Model layer<a name='2163'></font>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_232"> , ONLY : grid_config_rec_type<a name='2164'>
<font color=#447700>!   USE module_bc_time_utilities<a name='2165'></font>
   USE module_utility<a name='2166'>
   IMPLICIT NONE<a name='2167'>
  <font color=#447700>! Arguments<a name='2168'></font>
   TYPE(domain)                                :: grid<a name='2169'>
   TYPE (grid_config_rec_type) , INTENT(IN)    :: config_flags<a name='2170'>
   INTEGER ,                     INTENT(IN)    :: stream<a name='2171'>
   INTEGER ,                     INTENT(IN)    :: alarm_id<a name='2172'>
   CHARACTER*(*) ,               INTENT(IN)    :: hist_outname<a name='2173'>
   INTEGER ,                     INTENT(INOUT) :: oid<a name='2174'>
   EXTERNAL                                       outsub<a name='2175'>
   CHARACTER*(*) ,               INTENT(OUT)   :: fname, n2<a name='2176'>
   INTEGER ,                     INTENT(OUT)   :: ierr<a name='2177'>
  <font color=#447700>! Local<a name='2178'></font>
   INTEGER                                :: len_n2<a name='2179'>
   INTEGER                                :: stream_l<a name='2180'>
   CHARACTER (LEN=256)                    :: message<a name='2181'>
   CHARACTER*80                           :: timestr<a name='2182'>
   TYPE(WRFU_Time)                        :: ST,CT<a name='2183'>
   LOGICAL                                :: adjust<a name='2184'>
<a name='2185'>
   IF ( stream .LT. first_history .OR. stream .GT. last_history ) THEN<a name='2186'>
     WRITE(message,*)'open_hist_w: invalid history stream ',stream<a name='2187'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1344">( message )<a name='2188'>
   ENDIF<a name='2189'>
<a name='2190'>
   ierr = 0<a name='2191'>
<a name='2192'>
   <font color=#447700>! Note that computation of fname and n2 are outside of the oid IF statement <a name='2193'></font>
   <font color=#447700>! since they are OUT args and may be used by callers even if oid/=0.  <a name='2194'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_63">( grid, current_time=CT, start_time=ST, &amp;<a name='2195'>
                          current_timestr=timestr )<a name='2196'>
   CALL nl_get_adjust_output_times( grid%id, adjust )<a name='2197'>
   IF ( adjust ) THEN <a name='2198'>
     CALL <A href='../../html_code/share/module_io_domain.F.html#ADJUST_IO_TIMESTR'>adjust_io_timestr</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADJUST_IO_TIMESTR_3">( grid%io_intervals( alarm_id ), CT, ST, timestr )<a name='2199'>
   ENDIF<a name='2200'>
#if (DA_CORE <font color=#447700>!= 1 &amp;&amp; NMM_CORE != 1)<a name='2201'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2202'></font>
<font color=#447700>! RASM Climate Diagnostics - JR, AS, MS  - October 2016<a name='2203'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2204'></font>
   IF( alarm_id .EQ. AUXHIST5_ALARM .AND. config_flags%mean_diag .EQ. 1 ) THEN<a name='2205'>
      WRITE(message, *) "RASM STATS: MEAN AUXHIST5 oid=", oid, " fname=", trim(fname), " alarmI_id=", alarm_id, " Time_outNow=", timestr<a name='2206'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_968">(200,  message )<a name='2207'>
      WRITE(message, *) "RASM STATS: MEAN AUXHIST5 Time_outbefore =...", trim(grid%OUTDATE_MEAN)<a name='2208'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_969">(200,  message )<a name='2209'>
      timestr = grid%OUTDATE_MEAN  <a name='2210'>
   ELSE IF( alarm_id .EQ. AUXHIST6_ALARM .AND. config_flags%diurnal_diag .EQ. 1 ) THEN<a name='2211'>
      WRITE(message, *) "RASM STATS: DIURNAL AUXHIST6 oid=", oid, " fname=", trim(fname), " alarmI_id=", alarm_id, " Time_outNow=", timestr<a name='2212'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_970">(200,  message )<a name='2213'>
      WRITE(message, *) "RASM STATS: DIURNAL AUXHIST6 Time_outbefore =...", trim(grid%OUTDATE_DIURN)<a name='2214'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_971">(200,  message )<a name='2215'>
      timestr = grid%OUTDATE_DIURN <a name='2216'>
   ENDIF<a name='2217'>
<font color=#447700>!----------------------------------------------------------------------<a name='2218'></font>
<font color=#447700>! end RASM Climate Diagnostics<a name='2219'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='2220'></font>
#endif<a name='2221'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_25"> ( fname , hist_outname, &amp;<a name='2222'>
                               grid%id , 2 , timestr )<a name='2223'>
   stream_l = stream-auxhist1_only+1<a name='2224'>
   IF ( stream .EQ. history_only ) THEN<a name='2225'>
     WRITE(n2,'("DATASET=HISTORY")')<a name='2226'>
   ELSE IF ( stream_l .GE. 10 ) THEN<a name='2227'>
     WRITE(n2,'("DATASET=AUXHIST",I2)')stream_l<a name='2228'>
   ELSE<a name='2229'>
     WRITE(n2,'("DATASET=AUXHIST",I1)')stream_l<a name='2230'>
   ENDIF<a name='2231'>
   IF ( oid .eq. 0 ) THEN<a name='2232'>
     WRITE ( message , '("open_hist_w : opening ",A," for writing. ")') TRIM ( fname )<a name='2233'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_972">( 1, message )<a name='2234'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2235'></font>
<font color=#447700>!<a name='2236'></font>
<font color=#447700>!Open_u_dataset is called rather than open_r_dataset to allow interfaces<a name='2237'></font>
<font color=#447700>!that can do blending or masking to update an existing field. (MCEL IO does this).<a name='2238'></font>
<font color=#447700>!No effect for other interfaces; open_u_dataset is equivalent to open_r_dataset <a name='2239'></font>
<font color=#447700>!in those cases.<a name='2240'></font>
<font color=#447700>!<a name='2241'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2242'></font>
     CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_24"> ( oid, TRIM(fname), grid ,  &amp;<a name='2243'>
                           config_flags , outsub , n2, ierr )<a name='2244'>
   ENDIF<a name='2245'>
   IF ( ierr .NE. 0 ) THEN<a name='2246'>
     WRITE ( message , '("open_hist_w : error opening ",A," for writing. ",I3)') &amp;<a name='2247'>
       TRIM ( fname ), ierr<a name='2248'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#OPEN_HIST_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1159">( message )<a name='2249'>
   ENDIF<a name='2250'>
<a name='2251'>
   RETURN<a name='2252'>
END SUBROUTINE open_hist_w<a name='2253'>
<a name='2254'>
 <a name='2255'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2256'></font>
<a name='2257'>
#if ( WRF_CHEM == 1 )<a name='2258'>
<a name='2259'>
<A NAME='MED_READ_WRF_CHEM_INPUT'><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2260'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_read_wrf_chem_input</font> ( grid , config_flags ) <A href='../../call_to/MED_READ_WRF_CHEM_INPUT.html' TARGET='index'>2</A>,<A href='../../call_from/MED_READ_WRF_CHEM_INPUT.html' TARGET='index'>16</A><a name='2261'>
  <font color=#447700>! Driver layer<a name='2262'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_372">    , ONLY : domain , domain_clock_get<a name='2263'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_37"><a name='2264'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_60"><a name='2265'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_233"> , ONLY : grid_config_rec_type<a name='2266'>
  <font color=#447700>! Model layer<a name='2267'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_11"><a name='2268'>
#ifdef DM_PARALLEL<a name='2269'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_180"><a name='2270'>
#endif<a name='2271'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_17"><a name='2272'>
   USE module_utility<a name='2273'>
<a name='2274'>
   IMPLICIT NONE<a name='2275'>
<a name='2276'>
  <font color=#447700>! Arguments<a name='2277'></font>
   TYPE(domain)                               :: grid<a name='2278'>
<a name='2279'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2280'>
<a name='2281'>
  <font color=#447700>! Local data<a name='2282'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='2283'>
<a name='2284'>
   INTEGER                                :: ierr, efid<a name='2285'>
   REAL                                   :: time, tupdate<a name='2286'>
   real, allocatable :: dumc0(:,:,:)<a name='2287'>
   CHARACTER (LEN=256)                    :: message, current_date_char, date_string<a name='2288'>
   CHARACTER (LEN=256)                    :: inpname<a name='2289'>
<a name='2290'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_8"><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2291'>
<font color=#447700>!   IF ( grid%id .EQ. 1 ) THEN<a name='2292'></font>
<a name='2293'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_64">( grid, current_timestr=current_date_char )<a name='2294'>
<a name='2295'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_17"> ( inpname , config_flags%auxinput12_inname , grid%id , 2 )<a name='2296'>
      WRITE(message,*)'mediation_integrate: med_read_wrf_chem_input: Open file ',TRIM(inpname)<a name='2297'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1160">( TRIM(message) )<a name='2298'>
<a name='2299'>
     if( grid%auxinput12_oid .NE. 0 ) then<a name='2300'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_37"> ( grid%auxinput12_oid , config_flags , "DATASET=AUXINPUT12" )<a name='2301'>
     endif<a name='2302'>
<a name='2303'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_17"> ( grid%auxinput12_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2304'>
                              "DATASET=AUXINPUT12", ierr )<a name='2305'>
        IF ( ierr .NE. 0 ) THEN<a name='2306'>
           WRITE( message , * ) 'med_read_wrf_chem_input error opening ', TRIM( inpname )<a name='2307'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1345">( TRIM( message ) )<a name='2308'>
        ENDIF<a name='2309'>
<a name='2310'>
         WRITE(message,*)'mediation_integrate: med_read_wrf_chem_input: Read chemistry from wrfout at time ',&amp;<a name='2311'>
         TRIM(current_date_char)<a name='2312'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1161">( TRIM(message) )<a name='2313'>
<a name='2314'>
         CALL wrf_debug (100 , 'mediation_integrate: calling input_auxinput12' )<a name='2315'>
         CALL input_auxinput12 ( grid%auxinput12_oid, grid , config_flags , ierr )<a name='2316'>
<a name='2317'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_38"> ( grid%auxinput12_oid , config_flags , "DATASET=AUXINPUT12" )<a name='2318'>
<a name='2319'>
<font color=#447700>!  ENDIF<a name='2320'></font>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_973"> (100 , 'mediation_integrate: med_read_wrf_chem_input: exit' )<a name='2321'>
<a name='2322'>
END SUBROUTINE med_read_wrf_chem_input<a name='2323'>
<font color=#447700>!------------------------------------------------------------------------<a name='2324'></font>
<font color=#447700>! Chemistry emissions input control. Three options are available and are<a name='2325'></font>
<font color=#447700>! set via the namelist variable io_style_emissions:<a name='2326'></font>
<font color=#447700>!<a name='2327'></font>
<font color=#447700>!   0 = Emissions are not read in from a file. They will contain their<a name='2328'></font>
<font color=#447700>!       default values, which can be set in the Registry.<a name='2329'></font>
<font color=#447700>!       (Intended for debugging of chem code)<a name='2330'></font>
<font color=#447700>!<a name='2331'></font>
<font color=#447700>!   1 = Emissions are read in from two 12 hour files that are cycled.<a name='2332'></font>
<font color=#447700>!       With this choice, auxinput5_inname should be set to<a name='2333'></font>
<font color=#447700>!       the value "wrfchemi_hhZ_d&lt;domain&gt;". <a name='2334'></font>
<font color=#447700>!<a name='2335'></font>
<font color=#447700>!   2 = Emissions are read in from files identified by date and that have<a name='2336'></font>
<font color=#447700>!       a length defined by frames_per_auxinput5. Both<a name='2337'></font>
<font color=#447700>!       auxinput5_inname should be set to <a name='2338'></font>
<font color=#447700>!       "wrfchemi_d&lt;domain&gt;_&lt;date&gt;".<a name='2339'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2340'></font>
<A NAME='MED_READ_WRF_CHEM_EMISS'><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2341'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_read_wrf_chem_emiss</font> ( grid , config_flags ) <A href='../../call_to/MED_READ_WRF_CHEM_EMISS.html' TARGET='index'>1</A>,<A href='../../call_from/MED_READ_WRF_CHEM_EMISS.html' TARGET='index'>33</A><a name='2342'>
  <font color=#447700>! Driver layer<a name='2343'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_373">    , ONLY : domain , domain_clock_get<a name='2344'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_38"><a name='2345'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_61"><a name='2346'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_234"> , ONLY : grid_config_rec_type<a name='2347'>
  <font color=#447700>! Model layer<a name='2348'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_12"><a name='2349'>
#ifdef DM_PARALLEL<a name='2350'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_181"><a name='2351'>
#endif<a name='2352'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_18"><a name='2353'>
   USE module_utility<a name='2354'>
<a name='2355'>
   IMPLICIT NONE<a name='2356'>
<a name='2357'>
  <font color=#447700>! Arguments<a name='2358'></font>
   TYPE(domain)                               :: grid<a name='2359'>
<a name='2360'>
<font color=#447700>!  TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2361'></font>
   TYPE (grid_config_rec_type)            :: config_flags<a name='2362'>
   Type (WRFU_Time )                      :: stopTime, currentTime<a name='2363'>
   Type (WRFU_TimeInterval )              :: stepTime<a name='2364'>
<a name='2365'>
  <font color=#447700>! Local data<a name='2366'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='2367'>
<a name='2368'>
   INTEGER                                :: ierr, efid<a name='2369'>
   INTEGER                                :: ihr, ihrdiff, i<a name='2370'>
   REAL                                   :: time, tupdate<a name='2371'>
   real, allocatable :: dumc0(:,:,:)<a name='2372'>
   CHARACTER (LEN=256)                    :: message, current_date_char, date_string<a name='2373'>
   CHARACTER (LEN=256)                    :: inpname<a name='2374'>
<a name='2375'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_9"><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2376'>
<a name='2377'>
     CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_68"> ( grid%id , model_config_rec , config_flags )<a name='2378'>
<a name='2379'>
<font color=#447700>! This "if" should be commented out when using emission files for nested<a name='2380'></font>
<font color=#447700>! domains. Also comment out the "ENDIF" line noted below.<a name='2381'></font>
<font color=#447700>!    IF ( grid%id .EQ. 1 ) THEN  <a name='2382'></font>
<a name='2383'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_65">( grid, current_time=currentTime,          &amp;<a name='2384'>
                                   current_timestr=current_date_char, &amp;<a name='2385'>
                                   stop_time=stopTime,                &amp;<a name='2386'>
                                   time_step=stepTime )<a name='2387'>
<a name='2388'>
      time = float(grid%itimestep) * grid%dt<a name='2389'>
<a name='2390'>
<font color=#447700>!---<a name='2391'></font>
<font color=#447700>! io_style_emissions option 0: no emissions read in...<a name='2392'></font>
<font color=#447700>!---<a name='2393'></font>
      if( config_flags%io_style_emissions == 0 ) then<a name='2394'>
         <font color=#447700>! Do nothing.<a name='2395'></font>
<font color=#447700>!---<a name='2396'></font>
<font color=#447700>! io_style_emissions option 1: cycle through two 12 hour input files...<a name='2397'></font>
<font color=#447700>!---<a name='2398'></font>
      else if( config_flags%io_style_emissions == 1 ) then<a name='2399'>
<a name='2400'>
         tupdate = mod( time, (12. * 3600.) )<a name='2401'>
         read(current_date_char(12:13),'(I2)') ihr<a name='2402'>
         ihr = MOD(ihr,24)<a name='2403'>
         ihrdiff = 0  <a name='2404'>
<a name='2405'>
         IF( tupdate .LT. grid%dt ) THEN<a name='2406'>
            tupdate = 0.<a name='2407'>
         ENDIF<a name='2408'>
         IF( ihr .EQ. 00 .OR. ihr .EQ. 12 ) THEN <a name='2409'>
            tupdate = 0. <a name='2410'>
         ENDIF<a name='2411'>
<a name='2412'>
         IF( currentTime + stepTime .GE. stopTime .AND. &amp;<a name='2413'>
              grid%auxinput5_oid .NE. 0 ) THEN<a name='2414'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_39"> ( grid%auxinput5_oid , config_flags , "DATASET=AUXINPUT5" )<a name='2415'>
            tupdate = 1.<a name='2416'>
         ENDIF<a name='2417'>
<a name='2418'>
<font color=#447700>!        write(message,FMT='(A,F10.1,A)') ' EMISSIONS UPDATE TIME ',time,TRIM(current_date_char(12:13))<a name='2419'></font>
<font color=#447700>!        CALL wrf_message( TRIM(message) )<a name='2420'></font>
<a name='2421'>
         IF ( tupdate .EQ. 0. .AND.  ihr .LT. 12 ) THEN <a name='2422'>
            ihrdiff = ihr  <a name='2423'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_18"> ( inpname , 'wrfchemi_00z' , grid%id , 2 )<a name='2424'>
            WRITE(message,*)'mediation_integrate: med_read_wrf_chem_emissions: Open file ',TRIM(inpname)<a name='2425'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1162">( TRIM(message) )<a name='2426'>
<a name='2427'>
            if( grid%auxinput5_oid .NE. 0 ) then<a name='2428'>
               CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_40"> ( grid%auxinput5_oid , config_flags , "DATASET=AUXINPUT5" )<a name='2429'>
            endif<a name='2430'>
<a name='2431'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_18"> ( grid%auxinput5_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2432'>
                 "DATASET=AUXINPUT5", ierr )<a name='2433'>
            IF ( ierr .NE. 0 ) THEN<a name='2434'>
               WRITE( message , * ) 'med_read_wrf_chem_emissions: error opening ', TRIM( inpname )<a name='2435'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1346">( TRIM( message ) )<a name='2436'>
            ENDIF<a name='2437'>
<a name='2438'>
          ELSE IF ( tupdate .EQ. 0. .AND. ihr .GE. 12 ) THEN<a name='2439'>
             ihrdiff = ihr - 12<a name='2440'>
<a name='2441'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_19"> ( inpname , 'wrfchemi_12z' , grid%id , 2 )<a name='2442'>
            WRITE(message,*)'mediation_integrate: med_read_wrf_chem_emissions: Open file ',TRIM(inpname)<a name='2443'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1163">( TRIM(message) )<a name='2444'>
<a name='2445'>
            if( grid%auxinput5_oid .NE. 0 ) then<a name='2446'>
               CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_41"> ( grid%auxinput5_oid , config_flags , "DATASET=AUXINPUT5" )<a name='2447'>
            endif<a name='2448'>
<a name='2449'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_19"> ( grid%auxinput5_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2450'>
                 "DATASET=AUXINPUT5", ierr )<a name='2451'>
            IF ( ierr .NE. 0 ) THEN<a name='2452'>
               WRITE( message , * ) 'med_read_wrf_chem_emissions: error opening ', TRIM( inpname )<a name='2453'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1347">( TRIM( message ) )<a name='2454'>
            ENDIF<a name='2455'>
          ENDIF<a name='2456'>
<a name='2457'>
         WRITE( message, '(A,2F10.1)' ) ' HOURLY EMISSIONS UPDATE TIME ',time,mod(time,3600.)<a name='2458'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1164">( TRIM(message) )<a name='2459'>
<font color=#447700>!<a name='2460'></font>
<font color=#447700>! hourly updates to emissions<a name='2461'></font>
         IF ( ( mod( time, 3600. ) .LT. grid%dt   ) .AND. &amp;<a name='2462'>
              ( currentTime + stepTime .LT. stopTime ) ) THEN<a name='2463'>
<font color=#447700>!           IF ( wrf_dm_on_monitor() ) CALL start_timing<a name='2464'></font>
<a name='2465'>
            WRITE(message,'(A,A)')'mediation_integrate: med_read_wrf_chem_emissions: Read emissions for time ',TRIM(current_date_char)<a name='2466'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1165">( TRIM(message) )<a name='2467'>
<a name='2468'>
            IF ( tupdate .EQ. 0. .AND. ihrdiff .GT. 0) THEN<a name='2469'>
               IF( ihrdiff .GT. 12) THEN<a name='2470'>
                 WRITE(message,'(A)')'mediation_integrate: med_read_wrf_chem_emissions: Error in emissions time, skipping all times in file '<a name='2471'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1166">( TRIM(message) )<a name='2472'>
               ENDIF<a name='2473'>
               DO i=1,ihrdiff<a name='2474'>
                 WRITE(message,'(A,I4)')'mediation_integrate: med_read_wrf_chem_emissions: Skip emissions ',i<a name='2475'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1167">( TRIM(message) )<a name='2476'>
                 CALL input_auxinput5 ( grid%auxinput5_oid, grid , config_flags , ierr )<a name='2477'>
               ENDDO<a name='2478'>
            ENDIF<a name='2479'>
<a name='2480'>
            CALL wrf_debug (100 , 'mediation_integrate: calling input_auxinput5' )<a name='2481'>
            CALL input_auxinput5 ( grid%auxinput5_oid, grid , config_flags , ierr )<a name='2482'>
         ELSE<a name='2483'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_974"> (100 , 'mediation_integrate: med_read_wrf_chem_emissions: Do not read emissions' )<a name='2484'>
         ENDIF<a name='2485'>
<a name='2486'>
<font color=#447700>!---<a name='2487'></font>
<font color=#447700>! io_style_emissions option 2: use dated emission files whose length is<a name='2488'></font>
<font color=#447700>!                             set via frames_per_auxinput5...<a name='2489'></font>
<font color=#447700>!---<a name='2490'></font>
      else if( config_flags%io_style_emissions == 2 ) then<a name='2491'>
         WRITE(message,*)'mediation_integrate: med_read_wrf_chem_emissions: Read emissions for time ',TRIM(current_date_char)<a name='2492'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1168">( TRIM(message) )<a name='2493'>
<font color=#447700>!<a name='2494'></font>
<font color=#447700>! Code to read hourly emission files...<a name='2495'></font>
<font color=#447700>!<a name='2496'></font>
         if( grid%auxinput5_oid == 0 ) then<a name='2497'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_26">(inpname , grid%emi_inname, grid%id , 2, current_date_char)<a name='2498'>
            WRITE(message,*)'mediation_integrate: med_read_wrf_chem_emissions: Open file ',TRIM(inpname)<a name='2499'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1169">( TRIM(message) )<a name='2500'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_20"> ( grid%auxinput5_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2501'>
                 "DATASET=AUXINPUT5", ierr )<a name='2502'>
            IF ( ierr .NE. 0 ) THEN<a name='2503'>
               WRITE( message , * ) 'med_read_wrf_chem_emissions: error opening ', TRIM( inpname )<a name='2504'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1348">( TRIM( message ) )<a name='2505'>
            ENDIF<a name='2506'>
         end if<a name='2507'>
<font color=#447700>!<a name='2508'></font>
<font color=#447700>! Read the emissions data.<a name='2509'></font>
<font color=#447700>!<a name='2510'></font>
         CALL wrf_debug (100 , 'mediation_integrate: calling input_auxinput5' )<a name='2511'>
         CALL input_auxinput5 ( grid%auxinput5_oid, grid , config_flags , ierr )<a name='2512'>
<font color=#447700>!<a name='2513'></font>
<font color=#447700>! If reached the indicated number of frames in the emissions file, close it.<a name='2514'></font>
<font color=#447700>!<a name='2515'></font>
         grid%emissframes = grid%emissframes + 1<a name='2516'>
         IF ( grid%emissframes &gt;= config_flags%frames_per_auxinput5 ) THEN<a name='2517'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_42"> ( grid%auxinput5_oid , config_flags , "DATASET=AUXINPUT5" )<a name='2518'>
            grid%emissframes = 0<a name='2519'>
            grid%auxinput5_oid = 0<a name='2520'>
         ENDIF<a name='2521'>
<a name='2522'>
<font color=#447700>!---<a name='2523'></font>
<font color=#447700>! unknown io_style_emissions option...<a name='2524'></font>
<font color=#447700>!---<a name='2525'></font>
      else<a name='2526'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1349">("Unknown emission style selected via io_style_emissions.")<a name='2527'>
      end if<a name='2528'>
<a name='2529'>
<font color=#447700>! The following line should be commented out when using emission files<a name='2530'></font>
<font color=#447700>! for nested domains. Also comment out the "if" noted above.<a name='2531'></font>
<font color=#447700>!   ENDIF<a name='2532'></font>
<a name='2533'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_975"> (100 , 'mediation_integrate: med_read_wrf_chem_emissions: exit' )<a name='2534'>
<a name='2535'>
END SUBROUTINE med_read_wrf_chem_emiss<a name='2536'>
<a name='2537'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2538'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2539'></font>
<a name='2540'>
<A NAME='MED_READ_WRF_CHEM_BIOEMISS'><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2541'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_read_wrf_chem_bioemiss</font> ( grid , config_flags ) <A href='../../call_to/MED_READ_WRF_CHEM_BIOEMISS.html' TARGET='index'>19</A>,<A href='../../call_from/MED_READ_WRF_CHEM_BIOEMISS.html' TARGET='index'>16</A><a name='2542'>
  <font color=#447700>! Driver layer<a name='2543'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_374">    , ONLY : domain , domain_clock_get<a name='2544'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_39"><a name='2545'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_62"><a name='2546'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_235"> , ONLY : grid_config_rec_type<a name='2547'>
  <font color=#447700>! Model layer<a name='2548'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_13"><a name='2549'>
#ifdef DM_PARALLEL<a name='2550'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_182"><a name='2551'>
#endif<a name='2552'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_19"><a name='2553'>
   USE module_utility<a name='2554'>
<a name='2555'>
   IMPLICIT NONE<a name='2556'>
<a name='2557'>
  <font color=#447700>! Arguments<a name='2558'></font>
   TYPE(domain)                               :: grid<a name='2559'>
<a name='2560'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2561'>
<a name='2562'>
  <font color=#447700>! Local data<a name='2563'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='2564'>
<a name='2565'>
   INTEGER                                :: ierr, efid<a name='2566'>
   REAL                                   :: time, tupdate<a name='2567'>
   real, allocatable :: dumc0(:,:,:)<a name='2568'>
   CHARACTER (LEN=256)                    :: message, current_date_char, date_string<a name='2569'>
   CHARACTER (LEN=256)                    :: inpname<a name='2570'>
<a name='2571'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_10"><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2572'>
<font color=#447700>!   IF ( grid%id .EQ. 1 ) THEN<a name='2573'></font>
<a name='2574'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_66">( grid, current_timestr=current_date_char )<a name='2575'>
<a name='2576'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_20"> ( inpname , 'wrfbiochemi' , grid%id , 2 )<a name='2577'>
      WRITE(message,*)'mediation_integrate: med_read_wrf_chem_bioemissions: Open file ',TRIM(inpname)<a name='2578'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1170">( TRIM(message) )<a name='2579'>
<a name='2580'>
     if( grid%auxinput6_oid .NE. 0 ) then<a name='2581'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_43"> ( grid%auxinput6_oid , config_flags , "DATASET=AUXINPUT6" )<a name='2582'>
     endif<a name='2583'>
<a name='2584'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_21"> ( grid%auxinput6_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2585'>
                              "DATASET=AUXINPUT6", ierr )<a name='2586'>
        IF ( ierr .NE. 0 ) THEN<a name='2587'>
           WRITE( message , * ) 'med_read_wrf_chem_bioemissions: error opening ', TRIM( inpname )<a name='2588'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1350">( TRIM( message ) )<a name='2589'>
        ENDIF<a name='2590'>
<a name='2591'>
         WRITE(message,*)'mediation_integrate: med_read_wrf_chem_bioemissions: Read biogenic emissions at time ',&amp;<a name='2592'>
         TRIM(current_date_char)<a name='2593'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1171">( TRIM(message) )<a name='2594'>
<a name='2595'>
         CALL wrf_debug (100 , 'mediation_integrate: calling input_auxinput6' )<a name='2596'>
         CALL input_auxinput6 ( grid%auxinput6_oid, grid , config_flags , ierr )<a name='2597'>
<a name='2598'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_44"> ( grid%auxinput6_oid , config_flags , "DATASET=AUXINPUT6" )<a name='2599'>
<a name='2600'>
<font color=#447700>!  ENDIF<a name='2601'></font>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_976"> (100 , 'mediation_integrate: med_read_wrf_chem_bioemissions: exit' )<a name='2602'>
<a name='2603'>
END SUBROUTINE med_read_wrf_chem_bioemiss<a name='2604'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2605'></font>
<A NAME='MED_READ_WRF_CHEM_EMISSOPT4'><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2606'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_read_wrf_chem_emissopt4</font> ( grid , config_flags ),<A href='../../call_from/MED_READ_WRF_CHEM_EMISSOPT4.html' TARGET='index'>16</A><a name='2607'>
  <font color=#447700>! Driver layer<a name='2608'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_375">    , ONLY : domain , domain_clock_get<a name='2609'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_40"><a name='2610'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_63"><a name='2611'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_236"> , ONLY : grid_config_rec_type<a name='2612'>
  <font color=#447700>! Model layer<a name='2613'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_14"><a name='2614'>
#ifdef DM_PARALLEL<a name='2615'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_183"><a name='2616'>
#endif<a name='2617'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_20"><a name='2618'>
   USE module_utility<a name='2619'>
<a name='2620'>
   IMPLICIT NONE<a name='2621'>
<a name='2622'>
  <font color=#447700>! Arguments<a name='2623'></font>
   TYPE(domain)                               :: grid<a name='2624'>
<a name='2625'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2626'>
<a name='2627'>
  <font color=#447700>! Local data<a name='2628'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='2629'>
<a name='2630'>
   INTEGER                                :: ierr, efid<a name='2631'>
   REAL                                   :: time, tupdate<a name='2632'>
   real, allocatable :: dumc0(:,:,:)<a name='2633'>
   CHARACTER (LEN=256)                    :: message, current_date_char, date_string<a name='2634'>
   CHARACTER (LEN=256)                    :: inpname<a name='2635'>
<a name='2636'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_11"><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2637'>
<font color=#447700>!   IF ( grid%id .EQ. 1 ) THEN<a name='2638'></font>
<a name='2639'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_67">( grid, current_timestr=current_date_char )<a name='2640'>
<a name='2641'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_21"> ( inpname , 'wrfchemi' , grid%id , 2 )<a name='2642'>
      WRITE(message,*)'mediation_integrate: med_read_wrf_chem_emissions: Open file ',TRIM(inpname)<a name='2643'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1172">( TRIM(message) )<a name='2644'>
<a name='2645'>
     if( grid%auxinput5_oid .NE. 0 ) then<a name='2646'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_45"> ( grid%auxinput5_oid , config_flags , "DATASET=AUXINPUT5" )<a name='2647'>
     endif<a name='2648'>
<a name='2649'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_22"> ( grid%auxinput5_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2650'>
                              "DATASET=AUXINPUT5", ierr )<a name='2651'>
        IF ( ierr .NE. 0 ) THEN<a name='2652'>
           WRITE( message , * ) 'med_read_wrf_chem_emissions: error opening ', TRIM( inpname )<a name='2653'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1351">( TRIM( message ) )<a name='2654'>
        ENDIF<a name='2655'>
<a name='2656'>
         WRITE(message,*)'mediation_integrate: med_read_wrf_chem_emissions: Read biogenic emissions at time ',&amp;<a name='2657'>
         TRIM(current_date_char)<a name='2658'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1173">( TRIM(message) )<a name='2659'>
<a name='2660'>
         CALL wrf_debug (100 , 'mediation_integrate: calling input_auxinput5' )<a name='2661'>
         CALL input_auxinput5 ( grid%auxinput5_oid, grid , config_flags , ierr )<a name='2662'>
<a name='2663'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_46"> ( grid%auxinput5_oid , config_flags , "DATASET=AUXINPUT5" )<a name='2664'>
<a name='2665'>
<font color=#447700>!  ENDIF<a name='2666'></font>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_977"> (100 , 'mediation_integrate: med_read_wrf_chem_emissions: exit' )<a name='2667'>
<a name='2668'>
END SUBROUTINE med_read_wrf_chem_emissopt4<a name='2669'>
<a name='2670'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2671'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2672'></font>
<a name='2673'>
<A NAME='MED_READ_WRF_CHEM_DMS_EMISS'><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2674'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_read_wrf_chem_dms_emiss</font> ( grid , config_flags ),<A href='../../call_from/MED_READ_WRF_CHEM_DMS_EMISS.html' TARGET='index'>16</A><a name='2675'>
  <font color=#447700>! Driver layer<a name='2676'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_376">    , ONLY : domain , domain_clock_get<a name='2677'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_41"><a name='2678'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_64"><a name='2679'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_237"> , ONLY : grid_config_rec_type<a name='2680'>
  <font color=#447700>! Model layer<a name='2681'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_15"><a name='2682'>
#ifdef DM_PARALLEL<a name='2683'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_184"><a name='2684'>
#endif<a name='2685'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_21"><a name='2686'>
   USE module_utility<a name='2687'>
<a name='2688'>
   IMPLICIT NONE<a name='2689'>
<a name='2690'>
  <font color=#447700>! Arguments<a name='2691'></font>
   TYPE(domain)                               :: grid<a name='2692'>
<a name='2693'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2694'>
<a name='2695'>
  <font color=#447700>! Local data<a name='2696'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='2697'>
<a name='2698'>
   INTEGER                                :: ierr, efid<a name='2699'>
   REAL                                   :: time, tupdate<a name='2700'>
   real, allocatable :: dumc0(:,:,:)<a name='2701'>
   CHARACTER (LEN=256)                    :: message, current_date_char, date_string<a name='2702'>
   CHARACTER (LEN=256)                    :: inpname<a name='2703'>
<a name='2704'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_12"><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2705'>
<font color=#447700>!   IF ( grid%id .EQ. 1 ) THEN<a name='2706'></font>
<a name='2707'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_68">( grid, current_timestr=current_date_char )<a name='2708'>
<a name='2709'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_22"> ( inpname , 'wrfchemi_dms' , grid%id , 2 )<a name='2710'>
      WRITE(message,*)'mediation_integrate: med_read_wrf_chem_dms_emiss: Open file ',TRIM(inpname)<a name='2711'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1174">( TRIM(message) )<a name='2712'>
<a name='2713'>
     if( grid%auxinput7_oid .NE. 0 ) then<a name='2714'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_47"> ( grid%auxinput7_oid , config_flags , "DATASET=AUXINPUT7" )<a name='2715'>
     endif<a name='2716'>
<a name='2717'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_23"> ( grid%auxinput7_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2718'>
                              "DATASET=AUXINPUT7", ierr )<a name='2719'>
        IF ( ierr .NE. 0 ) THEN<a name='2720'>
           WRITE( message , * ) 'med_read_wrf_chem_dms_emiss: error opening ', TRIM( inpname )<a name='2721'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1352">( TRIM( message ) )<a name='2722'>
        ENDIF<a name='2723'>
<a name='2724'>
         WRITE(message,*)'mediation_integrate: med_read_wrf_chem_dms_emiss: Read dms reference fields',&amp;<a name='2725'>
         TRIM(current_date_char)<a name='2726'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1175">( TRIM(message) )<a name='2727'>
<a name='2728'>
         CALL wrf_debug (100 , 'mediation_integrate: calling input_auxinput7' )<a name='2729'>
         CALL input_auxinput7 ( grid%auxinput7_oid, grid , config_flags , ierr )<a name='2730'>
<a name='2731'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_48"> ( grid%auxinput7_oid , config_flags , "DATASET=AUXINPUT7" )<a name='2732'>
<a name='2733'>
<font color=#447700>!  ENDIF<a name='2734'></font>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_DMS_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_978"> (100 , 'mediation_integrate: med_read_wrf_chem_dms_emiss: exit' )<a name='2735'>
 <a name='2736'>
END SUBROUTINE  med_read_wrf_chem_dms_emiss<a name='2737'>
<a name='2738'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2739'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2740'></font>
<a name='2741'>
<A NAME='MED_READ_WRF_CHEM_GOCART_BG'><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2742'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_read_wrf_chem_gocart_bg</font> ( grid , config_flags ) <A href='../../call_to/MED_READ_WRF_CHEM_GOCART_BG.html' TARGET='index'>5</A>,<A href='../../call_from/MED_READ_WRF_CHEM_GOCART_BG.html' TARGET='index'>16</A><a name='2743'>
  <font color=#447700>! Driver layer<a name='2744'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_377">    , ONLY : domain , domain_clock_get<a name='2745'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_42"><a name='2746'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_65"><a name='2747'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_238"> , ONLY : grid_config_rec_type<a name='2748'>
  <font color=#447700>! Model layer<a name='2749'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_16"><a name='2750'>
#ifdef DM_PARALLEL<a name='2751'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_185"><a name='2752'>
#endif<a name='2753'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_22"><a name='2754'>
   USE module_utility<a name='2755'>
<a name='2756'>
   IMPLICIT NONE<a name='2757'>
<a name='2758'>
  <font color=#447700>! Arguments<a name='2759'></font>
   TYPE(domain)                               :: grid<a name='2760'>
<a name='2761'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2762'>
<a name='2763'>
  <font color=#447700>! Local data<a name='2764'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='2765'>
<a name='2766'>
   INTEGER                                :: ierr, efid<a name='2767'>
   REAL                                   :: time, tupdate<a name='2768'>
   real, allocatable :: dumc0(:,:,:)<a name='2769'>
   CHARACTER (LEN=256)                    :: message, current_date_char, date_string<a name='2770'>
   CHARACTER (LEN=256)                    :: inpname<a name='2771'>
<a name='2772'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_13"><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2773'>
<font color=#447700>!   IF ( grid%id .EQ. 1 ) THEN<a name='2774'></font>
<a name='2775'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_69">( grid, current_timestr=current_date_char )<a name='2776'>
<a name='2777'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_23"> ( inpname , 'wrfchemi_gocart_bg' , grid%id , 2 )<a name='2778'>
      WRITE(message,*)'mediation_integrate: med_read_wrf_chem_gocart_bg: Open file ',TRIM(inpname)<a name='2779'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1176">( TRIM(message) )<a name='2780'>
<a name='2781'>
     if( grid%auxinput8_oid .NE. 0 ) then<a name='2782'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_49"> ( grid%auxinput8_oid , config_flags , "DATASET=AUXINPUT8" )<a name='2783'>
     endif<a name='2784'>
<a name='2785'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_24"> ( grid%auxinput8_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2786'>
                              "DATASET=AUXINPUT8", ierr )<a name='2787'>
        IF ( ierr .NE. 0 ) THEN<a name='2788'>
           WRITE( message , * ) 'med_read_wrf_chem_gocart_bg: error opening ', TRIM( inpname )<a name='2789'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1353">( TRIM( message ) )<a name='2790'>
        ENDIF<a name='2791'>
<a name='2792'>
         WRITE(message,*)'mediation_integrate: med_read_wrf_chem_gocart_bg: Read gocart_bg at time ',&amp;<a name='2793'>
         TRIM(current_date_char)<a name='2794'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1177">( TRIM(message) )<a name='2795'>
<a name='2796'>
         CALL wrf_debug (100 , 'mediation_integrate: calling input_auxinput8' )<a name='2797'>
         CALL input_auxinput8 ( grid%auxinput8_oid, grid , config_flags , ierr )<a name='2798'>
<a name='2799'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_50"> ( grid%auxinput8_oid , config_flags , "DATASET=AUXINPUT8" )<a name='2800'>
<a name='2801'>
<font color=#447700>!<a name='2802'></font>
<font color=#447700>!         CALL wrf_global_to_patch_real ( backg_no3_io , grid%backg_no3 , grid%domdesc, ' ' , 'xyz' ,         &amp;<a name='2803'></font>
<font color=#447700>!                                         ids, ide-1 , jds , jde-1 , kds , kde-1, &amp;<a name='2804'></font>
<font color=#447700>!                                         ims, ime   , jms , jme   , kms , kme  , &amp;<a name='2805'></font>
<font color=#447700>!                                         ips, ipe   , jps , jpe   , kps , kpe    )<a name='2806'></font>
<font color=#447700>!<a name='2807'></font>
<font color=#447700>!  ENDIF<a name='2808'></font>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_979"> (100 , 'mediation_integrate: med_read_wrf_chem_gocart_bg: exit' )<a name='2809'>
 <a name='2810'>
END SUBROUTINE  med_read_wrf_chem_gocart_bg<a name='2811'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2812'></font>
<a name='2813'>
<A NAME='MED_READ_WRF_VOLC_EMISS'><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2814'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_read_wrf_volc_emiss</font> ( grid , config_flags ) <A href='../../call_to/MED_READ_WRF_VOLC_EMISS.html' TARGET='index'>1</A>,<A href='../../call_from/MED_READ_WRF_VOLC_EMISS.html' TARGET='index'>16</A><a name='2815'>
  <font color=#447700>! Driver layer<a name='2816'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_378">    , ONLY : domain , domain_clock_get<a name='2817'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_43"><a name='2818'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_66"><a name='2819'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_239"> , ONLY : grid_config_rec_type<a name='2820'>
  <font color=#447700>! Model layer<a name='2821'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_17"><a name='2822'>
#ifdef DM_PARALLEL<a name='2823'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_186"><a name='2824'>
#endif<a name='2825'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_23"><a name='2826'>
   USE module_utility<a name='2827'>
<a name='2828'>
   IMPLICIT NONE<a name='2829'>
<a name='2830'>
  <font color=#447700>! Arguments<a name='2831'></font>
   TYPE(domain)                               :: grid<a name='2832'>
<a name='2833'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2834'>
<a name='2835'>
  <font color=#447700>! Local data<a name='2836'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='2837'>
<a name='2838'>
   INTEGER                                :: ierr, efid<a name='2839'>
   REAL                                   :: time, tupdate<a name='2840'>
   real, allocatable :: dumc0(:,:,:)<a name='2841'>
   CHARACTER (LEN=256)                    :: message, current_date_char, date_string<a name='2842'>
   CHARACTER (LEN=256)                    :: inpname<a name='2843'>
<a name='2844'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_14"><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2845'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_70">( grid, current_timestr=current_date_char )<a name='2846'>
<a name='2847'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_24"> ( inpname , 'wrfchemv' , grid%id , 2 )<a name='2848'>
      WRITE(message,*)'mediation_integrate: med_read_wrf_volc_emiss: Open file ',TRIM(inpname)<a name='2849'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1178">( TRIM(message) )<a name='2850'>
<a name='2851'>
     if( grid%auxinput13_oid .NE. 0 ) then<a name='2852'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_51"> ( grid%auxinput13_oid , config_flags , "DATASET=AUXINPUT13" )<a name='2853'>
     endif<a name='2854'>
<a name='2855'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_25"> ( grid%auxinput13_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2856'>
                              "DATASET=AUXINPUT13", ierr )<a name='2857'>
        IF ( ierr .NE. 0 ) THEN<a name='2858'>
           WRITE( message , * ) 'med_read_wrf_volc_emiss: error opening ', TRIM( inpname )<a name='2859'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1354">( TRIM( message ) )<a name='2860'>
        ENDIF<a name='2861'>
<a name='2862'>
         WRITE(message,*)'mediation_integrate: med_read_wrf_volc_emiss: Read volcanic ash emissions',&amp;<a name='2863'>
         TRIM(current_date_char)<a name='2864'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1179">( TRIM(message) )<a name='2865'>
<a name='2866'>
         CALL wrf_debug (100 , 'mediation_integrate: calling input_auxinput13' )<a name='2867'>
         CALL input_auxinput13 ( grid%auxinput13_oid, grid , config_flags , ierr )<a name='2868'>
<a name='2869'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_52"> ( grid%auxinput13_oid , config_flags , "DATASET=AUXINPUT13" )<a name='2870'>
<a name='2871'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_VOLC_EMISS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_980"> (100 , 'mediation_integrate: med_read_wrf_volc_emiss: exit' )<a name='2872'>
 <a name='2873'>
END SUBROUTINE  med_read_wrf_volc_emiss<a name='2874'>
<a name='2875'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2876'></font>
<A NAME='MED_READ_WRF_CHEM_EMISSOPT3'><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2877'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_read_wrf_chem_emissopt3</font> ( grid , config_flags ) <A href='../../call_to/MED_READ_WRF_CHEM_EMISSOPT3.html' TARGET='index'>5</A>,<A href='../../call_from/MED_READ_WRF_CHEM_EMISSOPT3.html' TARGET='index'>16</A><a name='2878'>
  <font color=#447700>! Driver layer<a name='2879'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_379">    , ONLY : domain , domain_clock_get<a name='2880'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_44"><a name='2881'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_67"><a name='2882'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_240"> , ONLY : grid_config_rec_type<a name='2883'>
  <font color=#447700>! Model layer<a name='2884'></font>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_18"><a name='2885'>
#ifdef DM_PARALLEL<a name='2886'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_187"><a name='2887'>
#endif<a name='2888'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_24"><a name='2889'>
   USE module_utility<a name='2890'>
<a name='2891'>
   IMPLICIT NONE<a name='2892'>
<a name='2893'>
  <font color=#447700>! Arguments<a name='2894'></font>
   TYPE(domain)                               :: grid<a name='2895'>
<a name='2896'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2897'>
<a name='2898'>
  <font color=#447700>! Local data<a name='2899'></font>
   LOGICAL, EXTERNAL                      :: wrf_dm_on_monitor<a name='2900'>
<a name='2901'>
   INTEGER                                :: ierr, efid<a name='2902'>
   REAL                                   :: time, tupdate<a name='2903'>
   real, allocatable :: dumc0(:,:,:)<a name='2904'>
   CHARACTER (LEN=256)                    :: message, current_date_char, date_string<a name='2905'>
   CHARACTER (LEN=256)                    :: inpname<a name='2906'>
<a name='2907'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_15"><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2908'>
<font color=#447700>!   IF ( grid%id .EQ. 1 ) THEN<a name='2909'></font>
<a name='2910'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_71">( grid, current_timestr=current_date_char )<a name='2911'>
<a name='2912'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_25"> ( inpname , 'wrffirechemi' , grid%id , 2 )<a name='2913'>
      WRITE(message,*)'mediation_integrate: med_read_wrf_chem_fireemissions: Open file ',TRIM(inpname)<a name='2914'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1180">( TRIM(message) )<a name='2915'>
<a name='2916'>
     if( grid%auxinput7_oid .NE. 0 ) then<a name='2917'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_53"> ( grid%auxinput7_oid , config_flags , "DATASET=AUXINPUT7" )<a name='2918'>
     endif<a name='2919'>
<a name='2920'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_26"> ( grid%auxinput7_oid, TRIM(inpname) , grid , config_flags, &amp;<a name='2921'>
                              "DATASET=AUXINPUT7", ierr )<a name='2922'>
        IF ( ierr .NE. 0 ) THEN<a name='2923'>
           WRITE( message , * ) 'med_read_wrf_chem_fireemissions: error opening ', TRIM( inpname )<a name='2924'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1355">( TRIM( message ) )<a name='2925'>
        ENDIF<a name='2926'>
<a name='2927'>
         WRITE(message,*)'mediation_integrate: med_read_wrf_chem_fireemissions: Read fire emissions at time ',&amp;<a name='2928'>
         TRIM(current_date_char)<a name='2929'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1181">( TRIM(message) )<a name='2930'>
<a name='2931'>
         CALL wrf_debug (00 , 'mediation_integrate: calling input_auxinput7' )<a name='2932'>
         CALL input_auxinput7 ( grid%auxinput7_oid, grid , config_flags , ierr )<a name='2933'>
<a name='2934'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_54"> ( grid%auxinput7_oid , config_flags , "DATASET=AUXINPUT7" )<a name='2935'>
<a name='2936'>
<font color=#447700>!  ENDIF<a name='2937'></font>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_981"> (00 , 'mediation_integrate: med_read_wrf_chem_fireemissions: exit' )<a name='2938'>
<a name='2939'>
END SUBROUTINE med_read_wrf_chem_emissopt3<a name='2940'>
#endif<a name='2941'>
<a name='2942'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2943'></font>
<a name='2944'>
#if ( HWRF == 1 )<a name='2945'>
<font color=#447700>!zhang's doing for outputing restart namelist parameters<a name='2946'></font>
<A NAME='MED_NAMELIST_OUT'><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2947'>
RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>med_namelist_out</font> ( grid , config_flags ) <A href='../../call_to/MED_NAMELIST_OUT.html' TARGET='index'>3</A>,<A href='../../call_from/MED_NAMELIST_OUT.html' TARGET='index'>10</A><a name='2948'>
  <font color=#447700>! Driver layer<a name='2949'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_380">    , ONLY : domain, domain_clock_get<a name='2950'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_45"><a name='2951'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_68"><a name='2952'>
  <font color=#447700>! Model layer<a name='2953'></font>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_241"> , ONLY : grid_config_rec_type<a name='2954'>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_19"><a name='2955'>
<font color=#447700>!zhang new   USE WRF_ESMF_MOD<a name='2956'></font>
   USE module_utility<a name='2957'>
<font color=#447700>!zhang new ends<a name='2958'></font>
<a name='2959'>
   IMPLICIT NONE<a name='2960'>
<a name='2961'>
  <font color=#447700>! Arguments<a name='2962'></font>
   TYPE(domain), INTENT(IN)                   :: grid<a name='2963'>
   TYPE (grid_config_rec_type) , INTENT(IN)   :: config_flags<a name='2964'>
<a name='2965'>
  <font color=#447700>! Local<a name='2966'></font>
<font color=#447700>!zhang new   TYPE(ESMF_Time)                        :: CurrTime<a name='2967'></font>
   TYPE(WRFU_Time) :: CurrTime<a name='2968'>
   INTEGER                                :: nout,rc,kid<a name='2969'>
   INTEGER                                :: hr, min, sec, ms,julyr,julday<a name='2970'>
   REAL                                   :: GMT<a name='2971'>
   CHARACTER*256                          :: prefix, outname<a name='2972'>
   CHARACTER*80                           :: timestr<a name='2973'>
   LOGICAL                                :: exist<a name='2974'>
   LOGICAL,EXTERNAL :: wrf_dm_on_monitor<a name='2975'>
<a name='2976'>
   TYPE (grid_config_rec_type)            :: kid_config_flags<a name='2977'>
<a name='2978'>
   prefix = "wrfnamelist_d&lt;domain&gt;_&lt;date&gt;"<a name='2979'>
   nout = 99<a name='2980'>
<a name='2981'>
<font color=#447700>!zhang new   CALL ESMF_ClockGet( grid%domain_clock, CurrTime=CurrTime, rc=rc )<a name='2982'></font>
<font color=#447700>!zhang new   CALL wrf_timetoa ( CurrTime, timestr )<a name='2983'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_72">( grid, current_timestr=timestr )<a name='2984'>
<font color=#447700>!zhang new ends<a name='2985'></font>
   CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_27"> ( outname , prefix, grid%id , 2 , timestr )<a name='2986'>
<a name='2987'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='2988'>
<a name='2989'>
   CLOSE (NOUT)<a name='2990'>
   OPEN ( FILE   = trim(outname) , UNIT   = nout, STATUS = 'UNKNOWN', FORM   = 'FORMATTED')<a name='2991'>
<font color=#447700>!zhang new   CALL ESMF_TimeGet( grid%current_time, YY=julyr, dayOfYear=julday, H=hr, M=min, S=sec, MS=ms, rc=rc)<a name='2992'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_73">( grid, current_time=CurrTime )<a name='2993'>
   CALL WRFU_TimeGet( CurrTime, YY=julyr, dayOfYear=julday, H=hr, M=min, S=sec, MS=ms, rc=rc)<a name='2994'>
<font color=#447700>!zhang new ends<a name='2995'></font>
   gmt=hr+real(min)/60.+real(sec)/3600.+real(ms)/(1000*3600)<a name='2996'>
   WRITE(NOUT,*) grid%i_parent_start<a name='2997'>
   WRITE(NOUT,*) grid%j_parent_start<a name='2998'>
   WRITE(NOUT,*) julyr<a name='2999'>
   WRITE(NOUT,*) julday<a name='3000'>
   WRITE(NOUT,*) gmt<a name='3001'>
<a name='3002'>
   CLOSE (NOUT)<a name='3003'>
   ENDIF<a name='3004'>
<a name='3005'>
   <font color=#447700>! call recursively for children, (if any)<a name='3006'></font>
   DO kid = 1, max_nests<a name='3007'>
      IF ( ASSOCIATED( grid%nests(kid)%ptr ) ) THEN<a name='3008'>
        CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_69"> ( grid%nests(kid)%ptr%id , model_config_rec , kid_config_flags )<a name='3009'>
        CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT'>med_namelist_out</A><A href='../../html_code/share/mediation_integrate.F.html#MED_NAMELIST_OUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NAMELIST_OUT_3"> ( grid%nests(kid)%ptr , kid_config_flags )<a name='3010'>
      ENDIF<a name='3011'>
   ENDDO<a name='3012'>
<a name='3013'>
   RETURN<a name='3014'>
END SUBROUTINE med_namelist_out<a name='3015'>
<font color=#447700>!end of zhang's doing<a name='3016'></font>
#endif<a name='3017'>
</pre></body></html>