<HTML> <BODY BGCOLOR=#eedddd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_INTERP_INFO'><A href='../../html_code/share/interp_fcn.F.html#MODULE_INTERP_INFO' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_interp_info</font> <A href='../../call_to/MODULE_INTERP_INFO.html' TARGET='index'>4</A><a name='3'>
     INTEGER , PARAMETER :: NOT_DEFINED_YET    = 0<a name='4'>
     INTEGER , PARAMETER :: BILINEAR           = 1<a name='5'>
     INTEGER , PARAMETER :: SINT               = 2<a name='6'>
     INTEGER , PARAMETER :: NEAREST_NEIGHBOR   = 3<a name='7'>
     INTEGER , PARAMETER :: QUADRATIC          = 4<a name='8'>
     INTEGER , PARAMETER :: SPLINE             = 5<a name='9'>
     INTEGER , PARAMETER :: SINT_NEW           = 12<a name='10'>
<a name='11'>
     INTEGER             :: interp_method_type = 0<a name='12'>
CONTAINS<a name='13'>
<A NAME='INTERP_INFO_INIT'><A href='../../html_code/share/interp_fcn.F.html#INTERP_INFO_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='14'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_info_init</font> <A href='../../call_to/INTERP_INFO_INIT.html' TARGET='index'>1</A><a name='15'>
#if (EM_CORE == 1)<a name='16'>
     CALL nl_get_interp_method_type ( 1 , interp_method_type )<a name='17'>
#else<a name='18'>
     interp_method_type = 2<a name='19'>
#endif<a name='20'>
   END SUBROUTINE interp_info_init<a name='21'>
END MODULE module_interp_info<a name='22'>
<a name='23'>
<font color=#447700>!WRF:MEDIATION_LAYER:INTERPOLATIONFUNCTION<a name='24'></font>
<font color=#447700>!<a name='25'></font>
<font color=#447700>!<a name='26'></font>
<a name='27'>
<font color=#447700>!=========================================================================<a name='28'></font>
<a name='29'>
<A NAME='INTERP_INIT'><A href='../../html_code/share/interp_fcn.F.html#INTERP_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='30'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_init</font> <A href='../../call_to/INTERP_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/INTERP_INIT.html' TARGET='index'>2</A><a name='31'>
      USE <A href='../../html_code/share/interp_fcn.F.html#MODULE_INTERP_INFO'>module_interp_info</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_INFO_1"><a name='32'>
      CALL <A href='../../html_code/share/interp_fcn.F.html#INTERP_INFO_INIT'>interp_info_init</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_INFO_INIT_1"><a name='33'>
   END SUBROUTINE interp_init<a name='34'>
<a name='35'>
<font color=#447700>!=========================================================================<a name='36'></font>
<a name='37'>
#if <font color=#447700>! defined(NMM_CORE) || NMM_CORE!=1<a name='38'></font>
<A NAME='INTERP_FCN'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='39'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn</font>    ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/INTERP_FCN.html' TARGET='index'>2</A>,<A href='../../call_from/INTERP_FCN.html' TARGET='index'>6</A><a name='40'></font>
                              cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='41'>
                              cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='42'>
                              cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='43'>
                              nfld,                                 &amp;  <font color=#447700>! ND field<a name='44'></font>
                              nids, nide, nkds, nkde, njds, njde,   &amp;<a name='45'>
                              nims, nime, nkms, nkme, njms, njme,   &amp;<a name='46'>
                              nits, nite, nkts, nkte, njts, njte,   &amp;<a name='47'>
                              shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='48'></font>
                              imask,                                &amp;  <font color=#447700>! interpolation mask<a name='49'></font>
                              xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='50'></font>
                              ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='51'></font>
                              nri, nrj                              )  <font color=#447700>! Nest ratio, i- and j-directions<a name='52'></font>
<a name='53'>
     USE <A href='../../html_code/share/interp_fcn.F.html#MODULE_INTERP_INFO'>module_interp_info</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_INFO_2">      <a name='54'>
<a name='55'>
     IMPLICIT NONE<a name='56'>
<a name='57'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='58'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='59'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='60'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='61'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='62'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='63'>
                            shw,                                  &amp;<a name='64'>
                            ipos, jpos,                           &amp;<a name='65'>
                            nri, nrj<a name='66'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='67'>
<a name='68'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='69'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='70'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='71'>
<a name='72'>
     IF      ( interp_method_type .EQ. NOT_DEFINED_YET  ) THEN<a name='73'>
        interp_method_type = SINT<a name='74'>
     END IF<a name='75'>
<a name='76'>
     IF      ( interp_method_type .EQ. BILINEAR         ) THEN<a name='77'>
       CALL <A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BLINT'>interp_fcn_blint</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_FCN_BLINT_1"> ( cfld,                                 &amp;  <font color=#447700>! CD field<a name='78'></font>
                               cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='79'>
                               cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='80'>
                               cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='81'>
                               nfld,                                 &amp;  <font color=#447700>! ND field<a name='82'></font>
                               nids, nide, nkds, nkde, njds, njde,   &amp;<a name='83'>
                               nims, nime, nkms, nkme, njms, njme,   &amp;<a name='84'>
                               nits, nite, nkts, nkte, njts, njte,   &amp;<a name='85'>
                               shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='86'></font>
                               imask,                                &amp;  <font color=#447700>! interpolation mask<a name='87'></font>
                               xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='88'></font>
                               ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='89'></font>
                               nri, nrj)                                <font color=#447700>! Nest ratio, i- and j-directions<a name='90'></font>
     ELSE IF ( MOD(interp_method_type,10) .EQ. SINT             ) THEN<a name='91'>
       CALL <A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_SINT'>interp_fcn_sint</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_FCN_SINT_1">  ( cfld,                                 &amp;  <font color=#447700>! CD field<a name='92'></font>
                               cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='93'>
                               cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='94'>
                               cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='95'>
                               nfld,                                 &amp;  <font color=#447700>! ND field<a name='96'></font>
                               nids, nide, nkds, nkde, njds, njde,   &amp;<a name='97'>
                               nims, nime, nkms, nkme, njms, njme,   &amp;<a name='98'>
                               nits, nite, nkts, nkte, njts, njte,   &amp;<a name='99'>
                               shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='100'></font>
                               imask,                                &amp;  <font color=#447700>! interpolation mask<a name='101'></font>
                               xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='102'></font>
                               ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='103'></font>
                               nri, nrj)                                <font color=#447700>! Nest ratio, i- and j-directions<a name='104'></font>
     ELSE IF ( interp_method_type .EQ. NEAREST_NEIGHBOR ) THEN<a name='105'>
       CALL <A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_NN'>interp_fcn_nn</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_FCN_NN_1">    ( cfld,                                 &amp;  <font color=#447700>! CD field<a name='106'></font>
                               cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='107'>
                               cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='108'>
                               cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='109'>
                               nfld,                                 &amp;  <font color=#447700>! ND field<a name='110'></font>
                               nids, nide, nkds, nkde, njds, njde,   &amp;<a name='111'>
                               nims, nime, nkms, nkme, njms, njme,   &amp;<a name='112'>
                               nits, nite, nkts, nkte, njts, njte,   &amp;<a name='113'>
                               shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='114'></font>
                               imask,                                &amp;  <font color=#447700>! interpolation mask<a name='115'></font>
                               xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='116'></font>
                               ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='117'></font>
                               nri, nrj)                                <font color=#447700>! Nest ratio, i- and j-directions<a name='118'></font>
     ELSE IF ( interp_method_type .EQ. QUADRATIC        ) THEN<a name='119'>
       CALL <A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_LAGR'>interp_fcn_lagr</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_FCN_LAGR_1">  ( cfld,                                 &amp;  <font color=#447700>! CD field<a name='120'></font>
                               cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='121'>
                               cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='122'>
                               cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='123'>
                               nfld,                                 &amp;  <font color=#447700>! ND field<a name='124'></font>
                               nids, nide, nkds, nkde, njds, njde,   &amp;<a name='125'>
                               nims, nime, nkms, nkme, njms, njme,   &amp;<a name='126'>
                               nits, nite, nkts, nkte, njts, njte,   &amp;<a name='127'>
                               shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='128'></font>
                               imask,                                &amp;  <font color=#447700>! interpolation mask<a name='129'></font>
                               xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='130'></font>
                               ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='131'></font>
                               nri, nrj)                                <font color=#447700>! Nest ratio, i- and j-directions<a name='132'></font>
     ELSE<a name='133'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1312"> ('Hold on there cowboy, we need to know which interpolation option you want')<a name='134'>
     END IF<a name='135'>
<a name='136'>
   END SUBROUTINE interp_fcn<a name='137'>
<a name='138'>
<font color=#447700>!=========================================================================<a name='139'></font>
<a name='140'>
<font color=#447700>! Overlapping linear horizontal iterpolation for mass, u, and v staggerings.<a name='141'></font>
<a name='142'>
<A NAME='INTERP_FCN_BLINT'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BLINT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='143'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn_blint</font>    ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/INTERP_FCN_BLINT.html' TARGET='index'>1</A><a name='144'></font>
                              cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='145'>
                              cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='146'>
                              cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='147'>
                              nfld,                                 &amp;  <font color=#447700>! ND field<a name='148'></font>
                              nids, nide, nkds, nkde, njds, njde,   &amp;<a name='149'>
                              nims, nime, nkms, nkme, njms, njme,   &amp;<a name='150'>
                              nits, nite, nkts, nkte, njts, njte,   &amp;<a name='151'>
                              shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='152'></font>
                              imask,                                &amp;  <font color=#447700>! interpolation mask<a name='153'></font>
                              xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='154'></font>
                              ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='155'></font>
                              nri, nrj)                                <font color=#447700>! Nest ratio, i- and j-directions<a name='156'></font>
<a name='157'>
     IMPLICIT NONE<a name='158'>
<a name='159'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='160'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='161'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='162'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='163'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='164'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='165'>
                            shw,                                  &amp;<a name='166'>
                            ipos, jpos,                           &amp;<a name='167'>
                            nri, nrj<a name='168'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='169'>
<a name='170'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='171'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='172'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='173'>
<a name='174'>
     <font color=#447700>! Local<a name='175'></font>
<a name='176'>
     INTEGER ci, cj, ck, ni, nj, nk, istag, jstag, ioff, joff, i, j, k<a name='177'>
     REAL :: wx, wy, cfld_ll, cfld_lr, cfld_ul, cfld_ur<a name='178'>
     REAL :: cxp0, cxp1, nx, cyp0, cyp1, ny<a name='179'>
<a name='180'>
     <font color=#447700>!  Fortran functions.  Yes, yes, I know, probably pretty slow.<a name='181'></font>
<a name='182'>
     REAL, EXTERNAL :: nest_loc_of_cg<a name='183'>
     INTEGER, EXTERNAL :: compute_CGLL<a name='184'>
<a name='185'>
     <font color=#447700>!  This stag stuff is to keep us away from the outer most row<a name='186'></font>
     <font color=#447700>!  and column for the unstaggered directions.  We are going to <a name='187'></font>
     <font color=#447700>!  consider "U" an xstag variable and "V" a ystag variable.  The<a name='188'></font>
     <font color=#447700>!  vertical staggering is handled in the actual arguments.  The<a name='189'></font>
     <font color=#447700>!  ckte and nkte are the ending vertical dimensions for computations<a name='190'></font>
     <font color=#447700>!  for this particular variable.<a name='191'></font>
<a name='192'>
     IF ( xstag ) THEN<a name='193'>
        istag = 0 <a name='194'>
        ioff  = 1<a name='195'>
     ELSE<a name='196'>
        istag = 1<a name='197'>
        ioff  = 0<a name='198'>
     END IF<a name='199'>
<a name='200'>
     IF ( ystag ) THEN<a name='201'>
        jstag = 0 <a name='202'>
        joff  = 1<a name='203'>
     ELSE<a name='204'>
        jstag = 1<a name='205'>
        joff  = 0<a name='206'>
     END IF<a name='207'>
<a name='208'>
     <font color=#447700>!  Loop over each j-index on this tile for the nested domain.<a name='209'></font>
<a name='210'>
     j_loop : DO nj = njts, MIN(njde-jstag,njte)<a name='211'>
<a name='212'>
        <font color=#447700>!  This is the lower-left j-index of the CG.<a name='213'></font>
<a name='214'>
        <font color=#447700>!  Example is 3:1 ratio, mass-point staggering.  We have listed six CG values<a name='215'></font>
        <font color=#447700>!  as an example: A, B, C, D, E, F.  For a 3:1 ratio, each of these CG cells has<a name='216'></font>
        <font color=#447700>!  nine associated FG points.<a name='217'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='218'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='219'></font>
        <font color=#447700>!  |         |         |         |<a name='220'></font>
        <font color=#447700>!  | -  D  - | -  E  - | -  F  - |<a name='221'></font>
        <font color=#447700>!  |         |         |         |<a name='222'></font>
        <font color=#447700>!  | 1  2  3 | 4  5  6 | 7  8  9 |<a name='223'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='224'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='225'></font>
        <font color=#447700>!  |         |         |         |<a name='226'></font>
        <font color=#447700>!  | -  A  - | -  B  - | -  C  - |<a name='227'></font>
        <font color=#447700>!  |         |         |         |<a name='228'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='229'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='230'></font>
        <font color=#447700>!  To interpolate to FG point 4, we will use CG points: A, B, D, E.  It is adequate to<a name='231'></font>
        <font color=#447700>!  find the lower left point.  The lower left (LL) point for "4" is "A".  Below<a name='232'></font>
        <font color=#447700>!  are a few more points.<a name='233'></font>
        <font color=#447700>!  2 =&gt; A<a name='234'></font>
        <font color=#447700>!  3 =&gt; A<a name='235'></font>
        <font color=#447700>!  4 =&gt; A<a name='236'></font>
        <font color=#447700>!  5 =&gt; B<a name='237'></font>
        <font color=#447700>!  6 =&gt; B<a name='238'></font>
        <font color=#447700>!  7 =&gt; B<a name='239'></font>
<a name='240'>
        cj = compute_CGLL ( nj , jpos , nrj , jstag )<a name='241'>
        ny = REAL(nj)<a name='242'>
        cyp0 = nest_loc_of_cg ( cj   , jpos , nrj , joff ) <a name='243'>
        cyp1 = nest_loc_of_cg ( cj+1 , jpos , nrj , joff ) <a name='244'>
<a name='245'>
        <font color=#447700>!  What is the weighting for this CG point to the FG point, j-weight only.<a name='246'></font>
<a name='247'>
        wy = ( cyp1 - ny ) / ( cyp1 - cyp0 )<a name='248'>
<a name='249'>
        <font color=#447700>!  Vertical dim of the nest domain.<a name='250'></font>
<a name='251'>
        k_loop : DO nk = nkts, nkte<a name='252'>
<a name='253'>
          <font color=#447700>!  Loop over each i-index on this tile for the nested domain.<a name='254'></font>
<a name='255'>
           i_loop : DO ni = nits, MIN(nide-istag,nite)<a name='256'>
<a name='257'>
              IF ( imask ( ni, nj ) .EQ. 1 ) THEN<a name='258'>
 <a name='259'>
                 <font color=#447700>!  The coarse grid location that is to the lower left of the FG point.<a name='260'></font>
   <a name='261'>
                 ci = compute_CGLL ( ni , ipos , nri , istag )<a name='262'>
                 nx = REAL(ni)<a name='263'>
                 cxp0 = nest_loc_of_cg ( ci   , ipos , nri , ioff ) <a name='264'>
                 cxp1 = nest_loc_of_cg ( ci+1 , ipos , nri , ioff ) <a name='265'>
   <a name='266'>
                 wx = ( cxp1 - nx ) / ( cxp1 - cxp0 )<a name='267'>
   <a name='268'>
                 <font color=#447700>!  The four surrounding CG values.<a name='269'></font>
   <a name='270'>
                 cfld_ll = cfld(ci  ,nk,cj  )<a name='271'>
                 cfld_lr = cfld(ci+1,nk,cj  )<a name='272'>
                 cfld_ul = cfld(ci  ,nk,cj+1)<a name='273'>
                 cfld_ur = cfld(ci+1,nk,cj+1)<a name='274'>
<a name='275'>
                 <font color=#447700>!  Bilinear interpolation in horizontal.<a name='276'></font>
<a name='277'>
                 nfld( ni , nk , nj ) =     wy  * ( cfld_ll * wx + cfld_lr * (1.-wx) ) + &amp;<a name='278'>
                                        (1.-wy) * ( cfld_ul * wx + cfld_ur * (1.-wx) )<a name='279'>
<a name='280'>
              END IF<a name='281'>
           END DO i_loop<a name='282'>
        END DO    k_loop<a name='283'>
     END DO       j_loop<a name='284'>
<a name='285'>
   END SUBROUTINE interp_fcn_blint<a name='286'>
<a name='287'>
<font color=#447700>!=========================================================================<a name='288'></font>
<a name='289'>
<font color=#447700>! Overlapping linear horizontal iterpolation for longitude<a name='290'></font>
<a name='291'>
<A NAME='INTERP_FCN_BLINT_LL'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BLINT_LL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='292'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn_blint_ll</font>    ( cfld_inp,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCN_BLINT_LL.html' TARGET='index'>1</A><a name='293'></font>
                              cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='294'>
                              cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='295'>
                              cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='296'>
                              nfld,                                 &amp;  <font color=#447700>! ND field<a name='297'></font>
                              nids, nide, nkds, nkde, njds, njde,   &amp;<a name='298'>
                              nims, nime, nkms, nkme, njms, njme,   &amp;<a name='299'>
                              nits, nite, nkts, nkte, njts, njte,   &amp;<a name='300'>
                              shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='301'></font>
                              imask,                                &amp;  <font color=#447700>! interpolation mask<a name='302'></font>
                              xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='303'></font>
                              ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='304'></font>
                              nri, nrj,                             &amp;  <font color=#447700>! Nest ratio, i- and j-directions<a name='305'></font>
                              clat_in, nlat_in,                     &amp; <font color=#447700>! CG, FG latitude<a name='306'></font>
                              cinput_from_file, ninput_from_file )    <font color=#447700>! CG, FG T/F input from file<a name='307'></font>
<a name='308'>
     IMPLICIT NONE<a name='309'>
<a name='310'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='311'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='312'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='313'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='314'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='315'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='316'>
                            shw,                                  &amp;<a name='317'>
                            ipos, jpos,                           &amp;<a name='318'>
                            nri, nrj<a name='319'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='320'>
<a name='321'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld_inp, cfld<a name='322'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='323'>
     REAL, DIMENSION ( cims:cime,            cjms:cjme ) :: clat_in<a name='324'>
     REAL, DIMENSION ( nims:nime,            njms:njme ) :: nlat_in<a name='325'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='326'>
     LOGICAL :: cinput_from_file, ninput_from_file<a name='327'>
<a name='328'>
     <font color=#447700>! Local<a name='329'></font>
<a name='330'>
     INTEGER ci, cj, ck, ni, nj, nk, istag, jstag, ioff, joff, i, j, k<a name='331'>
     REAL :: wx, wy, cfld_ll, cfld_lr, cfld_ul, cfld_ur<a name='332'>
     REAL :: cxp0, cxp1, nx, cyp0, cyp1, ny<a name='333'>
     LOGICAL :: probably_by_dateline<a name='334'>
     REAL :: max_lon, min_lon<a name='335'>
     LOGICAL :: probably_by_pole<a name='336'>
     REAL :: max_lat, min_lat<a name='337'>
<a name='338'>
     <font color=#447700>!  Fortran functions.  Yes, yes, I know, probably pretty slow.<a name='339'></font>
<a name='340'>
     REAL, EXTERNAL :: nest_loc_of_cg<a name='341'>
     INTEGER, EXTERNAL :: compute_CGLL<a name='342'>
<a name='343'>
     <font color=#447700>!  This stag stuff is to keep us away from the outer most row<a name='344'></font>
     <font color=#447700>!  and column for the unstaggered directions.  We are going to <a name='345'></font>
     <font color=#447700>!  consider "U" an xstag variable and "V" a ystag variable.  The<a name='346'></font>
     <font color=#447700>!  vertical staggering is handled in the actual arguments.  The<a name='347'></font>
     <font color=#447700>!  ckte and nkte are the ending vertical dimensions for computations<a name='348'></font>
     <font color=#447700>!  for this particular variable.<a name='349'></font>
<a name='350'>
     IF ( xstag ) THEN<a name='351'>
        istag = 0 <a name='352'>
        ioff  = 1<a name='353'>
     ELSE<a name='354'>
        istag = 1<a name='355'>
        ioff  = 0<a name='356'>
     END IF<a name='357'>
<a name='358'>
     IF ( ystag ) THEN<a name='359'>
        jstag = 0 <a name='360'>
        joff  = 1<a name='361'>
     ELSE<a name='362'>
        jstag = 1<a name='363'>
        joff  = 0<a name='364'>
     END IF<a name='365'>
<a name='366'>
     <font color=#447700>!  If this is a projection where the nest is over the pole, and<a name='367'></font>
     <font color=#447700>!  we are using the parent to interpolate the longitudes, then <a name='368'></font>
     <font color=#447700>!  we are going to have longitude troubles.  If this is the case,<a name='369'></font>
     <font color=#447700>!  stop the model right away.<a name='370'></font>
<a name='371'>
     probably_by_pole = .FALSE.<a name='372'>
     max_lat = -90<a name='373'>
     min_lat = +90<a name='374'>
     DO nj = njts, MIN(njde-jstag,njte)<a name='375'>
        DO ni = nits, MIN(nide-istag,nite)<a name='376'>
           max_lat = MAX ( nlat_in(ni,nj) , max_lat )       <a name='377'>
           min_lat = MIN ( nlat_in(ni,nj) , min_lat )       <a name='378'>
        END DO<a name='379'>
     END DO<a name='380'>
<a name='381'>
     IF ( ( max_lat .GT. 85 ) .OR. ( ABS(min_lat) .GT. 85 ) ) THEN<a name='382'>
        probably_by_pole = .TRUE.<a name='383'>
     END IF<a name='384'>
<a name='385'>
     IF ( ( probably_by_pole ) .AND. ( .NOT. ninput_from_file ) ) THEN<a name='386'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BLINT_LL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1313"> ( 'Nest over the pole, single input domain, longitudes will be wrong' )<a name='387'>
     END IF<a name='388'>
<a name='389'>
     <font color=#447700>!  Initialize to NOT being by dateline.<a name='390'></font>
<a name='391'>
     probably_by_dateline = .FALSE.<a name='392'>
     max_lon = -180<a name='393'>
     min_lon = +180<a name='394'>
     DO nj = njts, MIN(njde-jstag,njte)<a name='395'>
        cj = compute_CGLL ( nj , jpos , nrj , jstag )<a name='396'>
        DO ni = nits, MIN(nide-istag,nite)<a name='397'>
           ci = compute_CGLL ( ni , ipos , nri , istag )<a name='398'>
           max_lon = MAX ( cfld_inp(ci,1,cj) , max_lon )       <a name='399'>
           min_lon = MIN ( cfld_inp(ci,1,cj) , min_lon )       <a name='400'>
        END DO<a name='401'>
     END DO<a name='402'>
<a name='403'>
     IF ( max_lon - min_lon .GT. 300 ) THEN<a name='404'>
        probably_by_dateline = .TRUE.<a name='405'>
     END IF<a name='406'>
<a name='407'>
     <font color=#447700>!  Load "continuous" longitude across the date line<a name='408'></font>
<a name='409'>
     DO cj = MIN(cjts-1,cjms), MAX(cjte+1,cjme)<a name='410'>
       DO ci = MIN(cits-1,cims), MAX(cite+1,cime)<a name='411'>
         IF ( ( cfld_inp(ci,ckts,cj) .LT. 0 ) .AND. ( probably_by_dateline ) ) THEN<a name='412'>
           cfld(ci,ckts,cj) = 360 + cfld_inp(ci,ckts,cj)<a name='413'>
         ELSE<a name='414'>
           cfld(ci,ckts,cj) =       cfld_inp(ci,ckts,cj)<a name='415'>
         END IF<a name='416'>
       END DO<a name='417'>
     END DO<a name='418'>
<a name='419'>
     <font color=#447700>!  Loop over each j-index on this tile for the nested domain.<a name='420'></font>
<a name='421'>
     j_loop : DO nj = njts, MIN(njde-jstag,njte)<a name='422'>
<a name='423'>
        <font color=#447700>!  This is the lower-left j-index of the CG.<a name='424'></font>
<a name='425'>
        <font color=#447700>!  Example is 3:1 ratio, mass-point staggering.  We have listed six CG values<a name='426'></font>
        <font color=#447700>!  as an example: A, B, C, D, E, F.  For a 3:1 ratio, each of these CG cells has<a name='427'></font>
        <font color=#447700>!  nine associated FG points.<a name='428'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='429'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='430'></font>
        <font color=#447700>!  |         |         |         |<a name='431'></font>
        <font color=#447700>!  | -  D  - | -  E  - | -  F  - |<a name='432'></font>
        <font color=#447700>!  |         |         |         |<a name='433'></font>
        <font color=#447700>!  | 1  2  3 | 4  5  6 | 7  8  9 |<a name='434'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='435'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='436'></font>
        <font color=#447700>!  |         |         |         |<a name='437'></font>
        <font color=#447700>!  | -  A  - | -  B  - | -  C  - |<a name='438'></font>
        <font color=#447700>!  |         |         |         |<a name='439'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='440'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='441'></font>
        <font color=#447700>!  To interpolate to FG point 4, we will use CG points: A, B, D, E.  It is adequate to<a name='442'></font>
        <font color=#447700>!  find the lower left point.  The lower left (LL) point for "4" is "A".  Below<a name='443'></font>
        <font color=#447700>!  are a few more points.<a name='444'></font>
        <font color=#447700>!  2 =&gt; A<a name='445'></font>
        <font color=#447700>!  3 =&gt; A<a name='446'></font>
        <font color=#447700>!  4 =&gt; A<a name='447'></font>
        <font color=#447700>!  5 =&gt; B<a name='448'></font>
        <font color=#447700>!  6 =&gt; B<a name='449'></font>
        <font color=#447700>!  7 =&gt; B<a name='450'></font>
<a name='451'>
        cj = compute_CGLL ( nj , jpos , nrj , jstag )<a name='452'>
        ny = REAL(nj)<a name='453'>
        cyp0 = nest_loc_of_cg ( cj   , jpos , nrj , joff ) <a name='454'>
        cyp1 = nest_loc_of_cg ( cj+1 , jpos , nrj , joff ) <a name='455'>
<a name='456'>
        <font color=#447700>!  What is the weighting for this CG point to the FG point, j-weight only.<a name='457'></font>
<a name='458'>
        wy = ( cyp1 - ny ) / ( cyp1 - cyp0 )<a name='459'>
<a name='460'>
        <font color=#447700>!  Vertical dim of the nest domain.<a name='461'></font>
<a name='462'>
        k_loop : DO nk = nkts, nkte<a name='463'>
<a name='464'>
          <font color=#447700>!  Loop over each i-index on this tile for the nested domain.<a name='465'></font>
<a name='466'>
           i_loop : DO ni = nits, MIN(nide-istag,nite)<a name='467'>
<a name='468'>
              IF ( imask ( ni, nj ) .EQ. 1 ) THEN<a name='469'>
 <a name='470'>
                 <font color=#447700>!  The coarse grid location that is to the lower left of the FG point.<a name='471'></font>
   <a name='472'>
                 ci = compute_CGLL ( ni , ipos , nri , istag )<a name='473'>
                 nx = REAL(ni)<a name='474'>
                 cxp0 = nest_loc_of_cg ( ci   , ipos , nri , ioff ) <a name='475'>
                 cxp1 = nest_loc_of_cg ( ci+1 , ipos , nri , ioff ) <a name='476'>
   <a name='477'>
                 wx = ( cxp1 - nx ) / ( cxp1 - cxp0 )<a name='478'>
   <a name='479'>
                 <font color=#447700>!  The four surrounding CG values.<a name='480'></font>
   <a name='481'>
                 cfld_ll = cfld(ci  ,nk,cj  )<a name='482'>
                 cfld_lr = cfld(ci+1,nk,cj  )<a name='483'>
                 cfld_ul = cfld(ci  ,nk,cj+1)<a name='484'>
                 cfld_ur = cfld(ci+1,nk,cj+1)<a name='485'>
<a name='486'>
                 <font color=#447700>!  Bilinear interpolation in horizontal.<a name='487'></font>
<a name='488'>
                 nfld( ni , nk , nj ) =     wy  * ( cfld_ll * wx + cfld_lr * (1.-wx) ) + &amp;<a name='489'>
                                        (1.-wy) * ( cfld_ul * wx + cfld_ur * (1.-wx) )<a name='490'>
<a name='491'>
              END IF<a name='492'>
           END DO i_loop<a name='493'>
        END DO    k_loop<a name='494'>
     END DO       j_loop<a name='495'>
<a name='496'>
     <font color=#447700>!  Put nested longitude back into the -180 to 180 range.<a name='497'></font>
<a name='498'>
     DO nj = njts, MIN(njde-jstag,njte)<a name='499'>
        DO ni = nits, MIN(nide-istag,nite)<a name='500'>
           IF ( nfld(ni,nkts,nj) .GT. 180 ) THEN<a name='501'>
              nfld(ni,nkts,nj) = -360 + nfld(ni,nkts,nj)<a name='502'>
           END IF<a name='503'>
        END DO<a name='504'>
    END DO<a name='505'>
<a name='506'>
   END SUBROUTINE interp_fcn_blint_ll<a name='507'>
<a name='508'>
<font color=#447700>!=========================================================================<a name='509'></font>
<a name='510'>
<font color=#447700>! Lagrange interpolating polynomials, set up as a quadratic, with an average of<a name='511'></font>
<font color=#447700>! the overlap.<a name='512'></font>
<a name='513'>
<A NAME='INTERP_FCN_LAGR'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_LAGR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='514'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn_lagr</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/INTERP_FCN_LAGR.html' TARGET='index'>1</A><a name='515'></font>
                                cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='516'>
                                cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='517'>
                                cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='518'>
                                nfld,                                 &amp;  <font color=#447700>! ND field<a name='519'></font>
                                nids, nide, nkds, nkde, njds, njde,   &amp;<a name='520'>
                                nims, nime, nkms, nkme, njms, njme,   &amp;<a name='521'>
                                nits, nite, nkts, nkte, njts, njte,   &amp;<a name='522'>
                                shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='523'></font>
                                imask,                                &amp;  <font color=#447700>! interpolation mask<a name='524'></font>
                                xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='525'></font>
                                ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='526'></font>
                                nri, nrj)                                <font color=#447700>! Nest ratio, i- and j-directions<a name='527'></font>
<a name='528'>
     IMPLICIT NONE<a name='529'>
<a name='530'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='531'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='532'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='533'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='534'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='535'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='536'>
                            shw,                                  &amp;<a name='537'>
                            ipos, jpos,                           &amp;<a name='538'>
                            nri, nrj<a name='539'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='540'>
<a name='541'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='542'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='543'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='544'>
<a name='545'>
     <font color=#447700>! Local<a name='546'></font>
<a name='547'>
     INTEGER ci, cj, ck, ni, nj, nk, istag, jstag, i, j, k<a name='548'>
     REAL :: nx, x0, x1, x2, x3, x<a name='549'>
     REAL :: ny, y0, y1, y2, y3<a name='550'>
     REAL :: cxm1, cxp0, cxp1, cxp2, nfld_m1, nfld_p0, nfld_p1, nfld_p2<a name='551'>
     REAL :: cym1, cyp0, cyp1, cyp2<a name='552'>
     INTEGER :: ioff, joff<a name='553'>
<a name='554'>
     <font color=#447700>!  Fortran functions.<a name='555'></font>
<a name='556'>
     REAL, EXTERNAL :: lagrange_quad_avg<a name='557'>
     REAL, EXTERNAL :: nest_loc_of_cg<a name='558'>
     INTEGER, EXTERNAL :: compute_CGLL<a name='559'>
<a name='560'>
     <font color=#447700>!  This stag stuff is to keep us away from the outer most row<a name='561'></font>
     <font color=#447700>!  and column for the unstaggered directions.  We are going to <a name='562'></font>
     <font color=#447700>!  consider "U" an xstag variable and "V" a ystag variable.  The<a name='563'></font>
     <font color=#447700>!  vertical staggering is handled in the actual arguments.  The<a name='564'></font>
     <font color=#447700>!  ckte and nkte are the ending vertical dimensions for computations<a name='565'></font>
     <font color=#447700>!  for this particular variable.<a name='566'></font>
<a name='567'>
     <font color=#447700>!  The ioff and joff are offsets due to the staggering.  It is a lot<a name='568'></font>
     <font color=#447700>!  simpler with ioff and joff if <a name='569'></font>
     <font color=#447700>!  u var =&gt; ioff=1<a name='570'></font>
     <font color=#447700>!  v var =&gt; joff=1<a name='571'></font>
     <font color=#447700>!  otherwise zero.<a name='572'></font>
     <font color=#447700>!  Note that is OPPOSITE of the istag, jstag vars.  The stag variables are<a name='573'></font>
     <font color=#447700>!  used for the domain dimensions, the offset guys are used in the <a name='574'></font>
     <font color=#447700>!  determination of grid points between the CG and FG<a name='575'></font>
<a name='576'>
     IF ( xstag ) THEN<a name='577'>
        istag = 0 <a name='578'>
        ioff  = 1<a name='579'>
     ELSE<a name='580'>
        istag = 1<a name='581'>
        ioff  = 0<a name='582'>
     END IF<a name='583'>
<a name='584'>
     IF ( ystag ) THEN<a name='585'>
        jstag = 0 <a name='586'>
        joff  = 1<a name='587'>
     ELSE<a name='588'>
        jstag = 1<a name='589'>
        joff  = 0<a name='590'>
     END IF<a name='591'>
<a name='592'>
     <font color=#447700>!  Loop over each j-index on this tile for the nested domain.<a name='593'></font>
<a name='594'>
     j_loop : DO nj = njts, MIN(njde-jstag,njte)<a name='595'>
<a name='596'>
        <font color=#447700>!  This is the lower-left j-index of the CG.<a name='597'></font>
<a name='598'>
        <font color=#447700>!  Example is 3:1 ratio, mass-point staggering.  We have listed sixteen CG values<a name='599'></font>
        <font color=#447700>!  as an example: A through P.  For a 3:1 ratio, each of these CG cells has<a name='600'></font>
        <font color=#447700>!  nine associated FG points.<a name='601'></font>
<a name='602'>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='603'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='604'></font>
        <font color=#447700>!  |         |         |         |         |<a name='605'></font>
        <font color=#447700>!  | -  M  - | -  N  d | -  O  - | -  P  - |<a name='606'></font>
        <font color=#447700>!  |         |         |         |         |<a name='607'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='608'></font>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='609'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='610'></font>
        <font color=#447700>!  |         |         |         |         |<a name='611'></font>
        <font color=#447700>!  | -  I  - | -  J  c | -  K  - | -  L  - |<a name='612'></font>
        <font color=#447700>!  |         |         |         |         |<a name='613'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='614'></font>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='615'></font>
        <font color=#447700>!  | -  1  2 | 3  4  5 | 6  7  8 | -  -  - |<a name='616'></font>
        <font color=#447700>!  |         |         |         |         |<a name='617'></font>
        <font color=#447700>!  | -  E  - | -  F  b | -  G  - | -  H  - |<a name='618'></font>
        <font color=#447700>!  |         |         |         |         |<a name='619'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='620'></font>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='621'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='622'></font>
        <font color=#447700>!  |         |         |         |         |<a name='623'></font>
        <font color=#447700>!  | -  A  - | -  B  a | -  C  - | -  D  - |<a name='624'></font>
        <font color=#447700>!  |         |         |         |         |<a name='625'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='626'></font>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='627'></font>
<a name='628'>
        <font color=#447700>!  To interpolate to FG point 4, 5, or 6 we will use CG points: A through P.  It is<a name='629'></font>
        <font color=#447700>!  sufficient to find the lower left corner of a 4-point interpolation, and then extend <a name='630'></font>
        <font color=#447700>!  each side by one unit.<a name='631'></font>
<a name='632'>
        <font color=#447700>!  Here are the lower left hand corners of the following FG points:<a name='633'></font>
        <font color=#447700>!  1 =&gt; E<a name='634'></font>
        <font color=#447700>!  2 =&gt; E<a name='635'></font>
        <font color=#447700>!  3 =&gt; E<a name='636'></font>
        <font color=#447700>!  4 =&gt; F<a name='637'></font>
        <font color=#447700>!  5 =&gt; F<a name='638'></font>
        <font color=#447700>!  6 =&gt; F<a name='639'></font>
        <font color=#447700>!  7 =&gt; G<a name='640'></font>
        <font color=#447700>!  8 =&gt; G<a name='641'></font>
<a name='642'>
        cj = compute_CGLL ( nj , jpos , nrj , jstag )<a name='643'>
<a name='644'>
        <font color=#447700>!  Vertical dim of the nest domain.<a name='645'></font>
<a name='646'>
        k_loop : DO nk = nkts, nkte<a name='647'>
<a name='648'>
          <font color=#447700>!  Loop over each i-index on this tile for the nested domain.<a name='649'></font>
<a name='650'>
           i_loop : DO ni = nits, MIN(nide-istag,nite)<a name='651'>
 <a name='652'>
              <font color=#447700>!  The coarse grid location that is to the lower left of the FG point.<a name='653'></font>
<a name='654'>
              ci = compute_CGLL ( ni , ipos , nri , istag )<a name='655'>
<a name='656'>
              <font color=#447700>!  To interpolate to point "*" (look in grid cell "F"):<a name='657'></font>
              <font color=#447700>!  1. Use ABC to get a quadratic valid at "a"<a name='658'></font>
              <font color=#447700>!     Use BCD to get a quadratic valid at "a"<a name='659'></font>
              <font color=#447700>!     Average these to get the final value for "a"<a name='660'></font>
              <font color=#447700>!  2. Use EFG to get a quadratic valid at "b"<a name='661'></font>
              <font color=#447700>!     Use FGH to get a quadratic valid at "b"<a name='662'></font>
              <font color=#447700>!     Average these to get the final value for "b"<a name='663'></font>
              <font color=#447700>!  3. Use IJK to get a quadratic valid at "c"<a name='664'></font>
              <font color=#447700>!     Use JKL to get a quadratic valid at "c"<a name='665'></font>
              <font color=#447700>!     Average these to get the final value for "c"<a name='666'></font>
              <font color=#447700>!  4. Use MNO to get a quadratic valid at "d"<a name='667'></font>
              <font color=#447700>!     Use NOP to get a quadratic valid at "d"<a name='668'></font>
              <font color=#447700>!     Average these to get the final value for "d"<a name='669'></font>
              <font color=#447700>!  5. Use abc to get a quadratic valid at "*"<a name='670'></font>
              <font color=#447700>!     Use bcd to get a quadratic valid at "*"<a name='671'></font>
              <font color=#447700>!     Average these to get the final value for "*"<a name='672'></font>
<a name='673'>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='674'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='675'></font>
              <font color=#447700>!  |         |         |         |         |<a name='676'></font>
              <font color=#447700>!  | -  M  - | -  N  d | -  O  - | -  P  - |<a name='677'></font>
              <font color=#447700>!  |         |         |         |         |<a name='678'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='679'></font>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='680'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='681'></font>
              <font color=#447700>!  |         |         |         |         |<a name='682'></font>
              <font color=#447700>!  | -  I  - | -  J  c | -  K  - | -  L  - |<a name='683'></font>
              <font color=#447700>!  |         |         |         |         |<a name='684'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='685'></font>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='686'></font>
              <font color=#447700>!  | -  -  - | -  -  * | -  -  - | -  -  - |<a name='687'></font>
              <font color=#447700>!  |         |         |         |         |<a name='688'></font>
              <font color=#447700>!  | -  E  - | -  F  b | -  G  - | -  H  - |<a name='689'></font>
              <font color=#447700>!  |         |         |         |         |<a name='690'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='691'></font>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='692'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='693'></font>
              <font color=#447700>!  |         |         |         |         |<a name='694'></font>
              <font color=#447700>!  | -  A  - | -  B  a | -  C  - | -  D  - |<a name='695'></font>
              <font color=#447700>!  |         |         |         |         |<a name='696'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='697'></font>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='698'></font>
<a name='699'>
              <font color=#447700>!  Overlapping quadratic interpolation.<a name='700'></font>
<a name='701'>
              IF ( imask ( ni, nj ) .EQ. 1 ) THEN<a name='702'>
<a name='703'>
                 <font color=#447700>!  I-direction location of "*"<a name='704'></font>
<a name='705'>
                 nx = REAL(ni)<a name='706'>
<a name='707'>
                 <font color=#447700>!  I-direction location of "A", "E", "I", "M"<a name='708'></font>
<a name='709'>
                 cxm1 = nest_loc_of_cg ( ci-1 , ipos , nri , ioff ) <a name='710'>
<a name='711'>
                 <font color=#447700>!  I-direction location of "B", "F", "J", "N"<a name='712'></font>
<a name='713'>
                 cxp0 = nest_loc_of_cg ( ci   , ipos , nri , ioff ) <a name='714'>
<a name='715'>
                 <font color=#447700>!  I-direction location of "C", "G", "K", "O"<a name='716'></font>
<a name='717'>
                 cxp1 = nest_loc_of_cg ( ci+1 , ipos , nri , ioff ) <a name='718'>
<a name='719'>
                 <font color=#447700>!  I-direction location of "D", "H", "L", "P"<a name='720'></font>
<a name='721'>
                 cxp2 = nest_loc_of_cg ( ci+2 , ipos , nri , ioff ) <a name='722'>
<a name='723'>
                 <font color=#447700>!  Value at "a"<a name='724'></font>
<a name='725'>
                 nfld_m1 = lagrange_quad_avg ( nx, cxm1, cxp0, cxp1, cxp2, cfld(ci-1,nk,cj-1), cfld(ci+0,nk,cj-1), cfld(ci+1,nk,cj-1), cfld(ci+2,nk,cj-1) )<a name='726'>
<a name='727'>
                 <font color=#447700>!  Value at "b"<a name='728'></font>
<a name='729'>
                 nfld_p0 = lagrange_quad_avg ( nx, cxm1, cxp0, cxp1, cxp2, cfld(ci-1,nk,cj+0), cfld(ci+0,nk,cj+0), cfld(ci+1,nk,cj+0), cfld(ci+2,nk,cj+0) )<a name='730'>
<a name='731'>
                 <font color=#447700>!  Value at "c"<a name='732'></font>
<a name='733'>
                 nfld_p1 = lagrange_quad_avg ( nx, cxm1, cxp0, cxp1, cxp2, cfld(ci-1,nk,cj+1), cfld(ci+0,nk,cj+1), cfld(ci+1,nk,cj+1), cfld(ci+2,nk,cj+1) )<a name='734'>
<a name='735'>
                 <font color=#447700>!  Value at "d"<a name='736'></font>
<a name='737'>
                 nfld_p2 = lagrange_quad_avg ( nx, cxm1, cxp0, cxp1, cxp2, cfld(ci-1,nk,cj+2), cfld(ci+0,nk,cj+2), cfld(ci+1,nk,cj+2), cfld(ci+2,nk,cj+2) )<a name='738'>
<a name='739'>
                 <font color=#447700>!  J-direction location of "*"<a name='740'></font>
<a name='741'>
                 ny = REAL(nj)<a name='742'>
<a name='743'>
                 <font color=#447700>!  J-direction location of "A", "B", "C", "D"<a name='744'></font>
<a name='745'>
                 cym1 = nest_loc_of_cg ( cj-1 , jpos , nrj , joff ) <a name='746'>
<a name='747'>
                 <font color=#447700>!  J-direction location of "E", "F", "G", "H" <a name='748'></font>
<a name='749'>
                 cyp0 = nest_loc_of_cg ( cj   , jpos , nrj , joff ) <a name='750'>
<a name='751'>
                 <font color=#447700>!  J-direction location of "I", "J", "K", "L"<a name='752'></font>
<a name='753'>
                 cyp1 = nest_loc_of_cg ( cj+1 , jpos , nrj , joff ) <a name='754'>
<a name='755'>
                 <font color=#447700>!  J-direction location of "M", "N", "O", "P"<a name='756'></font>
<a name='757'>
                 cyp2 = nest_loc_of_cg ( cj+2 , jpos , nrj , joff ) <a name='758'>
<a name='759'>
                 <font color=#447700>!  Value at "*"<a name='760'></font>
<a name='761'>
                 nfld(ni,nk,nj) = lagrange_quad_avg ( ny, cym1, cyp0, cyp1,    &amp;<a name='762'>
                                                      cyp2, nfld_m1, nfld_p0, nfld_p1, nfld_p2 )<a name='763'>
<a name='764'>
              END IF<a name='765'>
<a name='766'>
           END DO i_loop<a name='767'>
        END DO    k_loop<a name='768'>
     END DO       j_loop<a name='769'>
<a name='770'>
   END SUBROUTINE interp_fcn_lagr<a name='771'>
<a name='772'>
<font color=#447700>!=================================================================================<a name='773'></font>
<a name='774'>
<A NAME='LAGRANGE_QUAD'><A href='../../html_code/share/interp_fcn.F.html#LAGRANGE_QUAD' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='775'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>lagrange_quad</font> ( x , x0, x1, x2, y0, y1, y2 )<a name='776'>
<a name='777'>
     IMPLICIT NONE <a name='778'>
<a name='779'>
     REAL :: x , x0, x1, x2, y0, y1, y2<a name='780'>
<a name='781'>
     <font color=#447700>!  Lagrange = sum     prod    ( x  - xj )<a name='782'></font>
     <font color=#447700>!             i=0,n ( j=0,n    ---------  * yi )<a name='783'></font>
     <font color=#447700>!                     j&lt;&gt;i    ( xi - xj ) <a name='784'></font>
     <a name='785'>
     <font color=#447700>!  For a quadratic, in the above equation, we are setting n=2. Three points<a name='786'></font>
     <font color=#447700>!  required for a quadratic, points x0, x1, x2 (hence n=2).<a name='787'></font>
<a name='788'>
     lagrange_quad = &amp;<a name='789'>
            (x-x1)*(x-x2)*y0 / ( (x0-x1)*(x0-x2) ) + &amp;<a name='790'>
            (x-x0)*(x-x2)*y1 / ( (x1-x0)*(x1-x2) ) + &amp;<a name='791'>
            (x-x0)*(x-x1)*y2 / ( (x2-x0)*(x2-x1) ) <a name='792'>
<a name='793'>
   END FUNCTION lagrange_quad<a name='794'>
<a name='795'>
<font color=#447700>!=================================================================================<a name='796'></font>
<a name='797'>
<A NAME='LAGRANGE_QUAD_AVG'><A href='../../html_code/share/interp_fcn.F.html#LAGRANGE_QUAD_AVG' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='798'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>lagrange_quad_avg</font> ( x , x0, x1, x2, x3, y0, y1, y2, y3 )<a name='799'>
<a name='800'>
     IMPLICIT NONE<a name='801'>
<a name='802'>
     REAL, EXTERNAL :: lagrange_quad<a name='803'>
     REAL :: x , x0, x1, x2, x3, y0, y1, y2, y3<a name='804'>
<a name='805'>
     <font color=#447700>!  Since there are three points required for a quadratic, we compute it twice <a name='806'></font>
     <font color=#447700>!  (once with x0, x1, x2 and once with x1, x2, x3), and then average those values.  This will <a name='807'></font>
     <font color=#447700>!  reduce overshoot.  The "x" point is where we are interpolating TO.<a name='808'></font>
    <a name='809'>
     <font color=#447700>!         x0         x1    x    x2<a name='810'></font>
     <font color=#447700>!                    x1    x    x2         x3<a name='811'></font>
<a name='812'>
     lagrange_quad_avg = &amp; <a name='813'>
<font color=#447700>!      ( lagrange_quad ( x , x0, x1, x2,     y0, y1, y2     )               + &amp;<a name='814'></font>
<font color=#447700>!        lagrange_quad ( x ,     x1, x2, x3,     y1, y2, y3 )               ) / &amp;<a name='815'></font>
<font color=#447700>!        2.<a name='816'></font>
       ( lagrange_quad ( x , x0, x1, x2,     y0, y1, y2     ) * ( x2 - x  ) + &amp;<a name='817'>
         lagrange_quad ( x ,     x1, x2, x3,     y1, y2, y3 ) * ( x  - x1 ) ) / &amp;<a name='818'>
         ( x2 - x1 )<a name='819'>
<a name='820'>
   END FUNCTION lagrange_quad_avg<a name='821'>
<a name='822'>
<font color=#447700>!=================================================================================<a name='823'></font>
<a name='824'>
<A NAME='NEST_LOC_OF_CG'><A href='../../html_code/share/interp_fcn.F.html#NEST_LOC_OF_CG' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='825'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>nest_loc_of_cg</font> ( ci , ipos , nri , ioff )<a name='826'>
<a name='827'>
     <font color=#447700>!  I and J direction equations for mass and momentum values for even<a name='828'></font>
     <font color=#447700>!  and odd ratios: Given that the starting value of the nest in the<a name='829'></font>
     <font color=#447700>!  CG grid cell is defined as (1,1), what is the location of the CG<a name='830'></font>
     <font color=#447700>!  location in FG index units.  Example, for a 2:1 ratio, the location <a name='831'></font>
     <font color=#447700>!  of the mass point T is 1.5 (3:1 ratio = 2, 4:1 ratio = 2.5, etc).<a name='832'></font>
     <font color=#447700>!  Note that for momentum points, the CG U point is defined as "1", the<a name='833'></font>
     <font color=#447700>!  same as the I-direction of the (1,1) location of the FG U point.<a name='834'></font>
     <font color=#447700>!  Same for V, but in the J-direction.<a name='835'></font>
<a name='836'>
     IMPLICIT NONE <a name='837'>
<a name='838'>
     INTEGER :: ci , ipos , nri , ioff<a name='839'>
<a name='840'>
     nest_loc_of_cg = &amp; <a name='841'>
       ( ci - ipos ) * nri + ( 1 - ioff ) * REAL ( nri + 1 ) / 2. + ioff<a name='842'>
<a name='843'>
   END FUNCTION nest_loc_of_cg<a name='844'>
<a name='845'>
<font color=#447700>!=================================================================================<a name='846'></font>
<a name='847'>
<A NAME='COMPUTE_CGLL'><A href='../../html_code/share/interp_fcn.F.html#COMPUTE_CGLL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='848'>
   <font color=#993300>FUNCTION </font><font color=#cc0000>compute_CGLL</font> ( ni , ipos , nri , istag ) RESULT ( CGLL_loc ),<A href='../../call_from/COMPUTE_CGLL.html' TARGET='index'>1</A><a name='849'>
<a name='850'>
      IMPLICIT NONE<a name='851'>
<a name='852'>
      INTEGER , INTENT(IN ) :: ni , ipos , nri , istag<a name='853'>
      INTEGER :: CGLL_loc<a name='854'>
<a name='855'>
      <font color=#447700>!  Local vars<a name='856'></font>
<a name='857'>
      INTEGER :: starting_position , increments_of_CG_cells<a name='858'>
      INTEGER :: location_of_LL_wrt_this_CG<a name='859'>
      INTEGER :: ioff<a name='860'>
      INTEGER , PARAMETER :: MOMENTUM_STAG   = 0<a name='861'>
      INTEGER , PARAMETER :: MASS_POINT_STAG = 1<a name='862'>
<a name='863'>
      starting_position = ipos<a name='864'>
      increments_of_CG_cells = ( ni - 1 ) / nri<a name='865'>
      ioff = MOD ( nri , 2 )<a name='866'>
<a name='867'>
      IF      ( istag .EQ. MOMENTUM_STAG   ) THEN<a name='868'>
         location_of_LL_wrt_this_CG =   MOD ( ( ni - 1 ) , nri )          /   ( nri + ioff )       - istag <font color=#447700>! zero<a name='869'></font>
      ELSE IF ( istag .EQ. MASS_POINT_STAG ) THEN<a name='870'>
         location_of_LL_wrt_this_CG = ( MOD ( ( ni - 1 ) , nri ) + ioff ) / ( ( nri + ioff ) / 2 ) - istag<a name='871'>
      ELSE<a name='872'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#COMPUTE_CGLL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1314"> ( 'Hold on there pard, there are only two staggerings I accept.' )<a name='873'>
      END IF<a name='874'>
<a name='875'>
      CGLL_loc = starting_position + increments_of_CG_cells + location_of_LL_wrt_this_CG<a name='876'>
<font color=#447700>!      WRITE ( 6 , '(a,i4, i4, i4, i4)') 'ni   ipos nri  stag', ni, ipos, nri, istag<a name='877'></font>
<font color=#447700>!      WRITE ( 6 , '(a,i4, i4, i4, i4)') 'strt inc  loc  CGLL', starting_position , increments_of_CG_cells , location_of_LL_wrt_this_CG , CGLL_loc<a name='878'></font>
<font color=#447700>!      print *,' '<a name='879'></font>
<a name='880'>
   END FUNCTION compute_CGLL<a name='881'>
<a name='882'>
<font color=#447700>!=================================================================================<a name='883'></font>
<a name='884'>
<font color=#447700>! Smolarkiewicz positive definite, monotonic transport.<a name='885'></font>
<a name='886'>
<A NAME='INTERP_FCN_SINT'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_SINT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='887'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn_sint</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/INTERP_FCN_SINT.html' TARGET='index'>1</A>,<A href='../../call_from/INTERP_FCN_SINT.html' TARGET='index'>2</A><a name='888'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='889'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='890'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='891'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='892'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='893'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='894'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='895'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='896'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='897'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='898'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='899'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='900'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_SINT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_168"><a name='901'>
<a name='902'>
     IMPLICIT NONE<a name='903'>
<a name='904'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='905'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='906'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='907'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='908'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='909'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='910'>
                            shw,                                  &amp;<a name='911'>
                            ipos, jpos,                           &amp;<a name='912'>
                            nri, nrj<a name='913'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='914'>
<a name='915'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='916'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='917'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='918'>
<a name='919'>
     <font color=#447700>! Local<a name='920'></font>
<a name='921'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, nioff, njoff<a name='922'>
     INTEGER nfx, ior<a name='923'>
     PARAMETER (ior=2)<a name='924'>
     INTEGER nf<a name='925'>
     REAL psca(cims:cime,cjms:cjme,nri*nrj)<a name='926'>
     LOGICAL icmask( cims:cime, cjms:cjme )<a name='927'>
     INTEGER i,j,k<a name='928'>
     INTEGER nrio2, nrjo2<a name='929'>
<a name='930'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='931'></font>
     <font color=#447700>! from the CD tile. <a name='932'></font>
<a name='933'>
     ioff  = 0 ; joff  = 0<a name='934'>
     nioff = 0 ; njoff = 0<a name='935'>
     IF ( xstag ) THEN <a name='936'>
       ioff = (nri-1)/2<a name='937'>
       nioff = nri <a name='938'>
     ENDIF<a name='939'>
     IF ( ystag ) THEN<a name='940'>
       joff = (nrj-1)/2<a name='941'>
       njoff = nrj<a name='942'>
     ENDIF<a name='943'>
<a name='944'>
     nrio2 = nri/2<a name='945'>
     nrjo2 = nrj/2<a name='946'>
<a name='947'>
     nfx = nri * nrj<a name='948'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='949'></font>
   <font color=#447700>!$OMP PRIVATE ( i,j,k,ni,nj,ci,cj,ip,jp,nk,ck,nf,icmask,psca )<a name='950'></font>
     DO k = ckts, ckte<a name='951'>
        icmask = .FALSE.<a name='952'>
        DO nf = 1,nfx<a name='953'>
           DO j = cjms,cjme<a name='954'>
              nj = (j-jpos) * nrj + ( nrjo2 + 1 )  <font color=#447700>! j point on nest<a name='955'></font>
              DO i = cims,cime<a name='956'>
                ni = (i-ipos) * nri + ( nrio2 + 1 )    <font color=#447700>! i point on nest<a name='957'></font>
                if ( ni .ge. nits-nioff-nrio2 .and. &amp;<a name='958'>
                     ni .le. nite+nioff+nrio2 .and. &amp;<a name='959'>
                     nj .ge. njts-njoff-nrjo2 .and. &amp;<a name='960'>
                     nj .le. njte+njoff+nrjo2 ) then<a name='961'>
                  if ( ni.ge.nims.and.ni.le.nime.and.nj.ge.njms.and.nj.le.njme) then<a name='962'>
                    if ( imask(ni,nj) .eq. 1 ) then<a name='963'>
                      icmask( i, j ) = .TRUE.<a name='964'>
                    endif<a name='965'>
                  endif<a name='966'>
                  if ( ni-nioff.ge.nims.and.ni.le.nime.and.nj-njoff.ge.njms.and.nj.le.njme) then<a name='967'>
                    if (ni .ge. nits-nioff .and. nj .ge. njts-njoff ) then<a name='968'>
                      if ( imask(ni-nioff,nj-njoff) .eq. 1) then<a name='969'>
                        icmask( i, j ) = .TRUE.<a name='970'>
                      endif<a name='971'>
                    endif<a name='972'>
                  endif<a name='973'>
                endif<a name='974'>
                psca(i,j,nf) = cfld(i,k,j)<a name='975'>
              ENDDO           <font color=#447700>! i<a name='976'></font>
           ENDDO              <font color=#447700>! j<a name='977'></font>
        ENDDO                 <font color=#447700>! nf<a name='978'></font>
<a name='979'>
<font color=#447700>! tile dims in this call to sint are 1-over to account for the fact<a name='980'></font>
<font color=#447700>! that the number of cells on the nest local subdomain is not <a name='981'></font>
<font color=#447700>! necessarily a multiple of the nest ratio in a given dim.<a name='982'></font>
<font color=#447700>! this could be a little less ham-handed.<a name='983'></font>
<a name='984'>
        CALL <A href='../../html_code/share/sint.F.html#SINT'>sint</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_SINT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINT_1">( psca,                     &amp;<a name='985'>
                   cims, cime, cjms, cjme, icmask,   &amp;<a name='986'>
                   cits-1, cite+1, cjts-1, cjte+1, nrj*nri, xstag, ystag )<a name='987'>
<a name='988'>
        DO nj = njts, njte+joff<a name='989'>
           cj = jpos + (nj-1) / nrj <font color=#447700>! j coord of CD point <a name='990'></font>
           jp = mod ( nj-1 , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='991'></font>
           nk = k<a name='992'>
           ck = nk<a name='993'>
           DO ni = nits, nite+ioff<a name='994'>
               ci = ipos + (ni-1) / nri      <font color=#447700>! i coord of CD point <a name='995'></font>
               ip = mod ( ni-1 , nri )  <font color=#447700>! coord of ND w/i CD point<a name='996'></font>
               if ( ( ni-ioff .ge. nits ) .and. ( nj-joff .ge. njts ) ) then<a name='997'>
                  if ( imask ( ni, nj ) .eq. 1 .or. imask ( ni-ioff, nj-joff ) .eq. 1  ) then<a name='998'>
                    nfld( ni-ioff, nk, nj-joff ) = psca( ci , cj, ip+1 + (jp)*nri )<a name='999'>
                  endif<a name='1000'>
               endif<a name='1001'>
           ENDDO<a name='1002'>
        ENDDO<a name='1003'>
     ENDDO<a name='1004'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1005'></font>
<a name='1006'>
   END SUBROUTINE interp_fcn_sint<a name='1007'>
<a name='1008'>
<font color=#447700>!=========================================================================<a name='1009'></font>
<a name='1010'>
<font color=#447700>!  Nearest neighbor interpolation.<a name='1011'></font>
<a name='1012'>
<A NAME='INTERP_FCN_NN'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_NN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1013'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn_nn</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/INTERP_FCN_NN.html' TARGET='index'>1</A><a name='1014'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1015'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1016'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1017'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='1018'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1019'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1020'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1021'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='1022'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1023'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1024'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1025'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='1026'></font>
     IMPLICIT NONE<a name='1027'>
<a name='1028'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1029'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1030'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1031'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1032'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1033'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1034'>
                            shw,                                  &amp;<a name='1035'>
                            ipos, jpos,                           &amp;<a name='1036'>
                            nri, nrj<a name='1037'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='1038'>
<a name='1039'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='1040'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='1041'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='1042'>
<a name='1043'>
     INTEGER ci, cj, ck, ni, nj, nk<a name='1044'>
<a name='1045'>
     <font color=#447700>! Iterate over the ND tile and assign the values<a name='1046'></font>
     <font color=#447700>! from the CD tile.  This is a trivial implementation <a name='1047'></font>
     <font color=#447700>! of the interp_fcn; just copies the values from the CD into the ND<a name='1048'></font>
<a name='1049'>
     DO nj = njts, njte<a name='1050'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='1051'></font>
        DO nk = nkts, nkte<a name='1052'>
           ck = nk<a name='1053'>
           DO ni = nits, nite<a name='1054'>
              if ( imask ( ni, nj ) .eq. 1 ) then<a name='1055'>
                ci = ipos + (ni-1) / nri      <font color=#447700>! i coord of CD point <a name='1056'></font>
                nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='1057'>
              endif<a name='1058'>
           ENDDO<a name='1059'>
        ENDDO<a name='1060'>
     ENDDO<a name='1061'>
<a name='1062'>
   END SUBROUTINE interp_fcn_nn<a name='1063'>
<a name='1064'>
<font color=#447700>!=========================================================================<a name='1065'></font>
<a name='1066'>
<A NAME='INTERP_FCN_BL'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1067'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn_bl</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/INTERP_FCN_BL.html' TARGET='index'>2</A>,<A href='../../call_from/INTERP_FCN_BL.html' TARGET='index'>2</A><a name='1068'></font>
                              cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1069'>
                              cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1070'>
                              cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1071'>
                              nfld,                                 &amp;  <font color=#447700>! ND field<a name='1072'></font>
                              nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1073'>
                              nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1074'>
                              nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1075'>
                              shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='1076'></font>
                              imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1077'></font>
                              xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1078'></font>
                              ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1079'></font>
                              nri, nrj,                             &amp;  <font color=#447700>! Nest ratio, i- and j-directions<a name='1080'></font>
                              cht, nht,                             &amp;  <font color=#447700>! topography for CG and FG<a name='1081'></font>
                              ct_max_p,nt_max_p,                    &amp;  <font color=#447700>! temperature (K) at max press, want CG value<a name='1082'></font>
                              cght_max_p,nght_max_p,                &amp;  <font color=#447700>! height (m) at max press, want CG value<a name='1083'></font>
                              cmax_p,nmax_p,                        &amp;  <font color=#447700>! max pressure (Pa) in column, want CG value<a name='1084'></font>
                              ct_min_p,nt_min_p,                    &amp;  <font color=#447700>! temperature (K) at min press, want CG value<a name='1085'></font>
                              cght_min_p,nght_min_p,                &amp;  <font color=#447700>! height (m) at min press, want CG value<a name='1086'></font>
                              cmin_p,nmin_p,                        &amp;  <font color=#447700>! min pressure (Pa) in column, want CG value<a name='1087'></font>
                              zn, p_top                             )  <font color=#447700>! eta levels<a name='1088'></font>
     USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_43"><a name='1089'>
<font color=#447700>!    USE module_configure<a name='1090'></font>
     USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_111"> , ONLY : g , r_d, cp, p1000mb, t0<a name='1091'>
<a name='1092'>
     IMPLICIT NONE<a name='1093'>
<a name='1094'>
<a name='1095'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1096'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1097'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1098'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1099'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1100'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1101'>
                            shw,                                  &amp;<a name='1102'>
                            ipos, jpos,                           &amp;<a name='1103'>
                            nri, nrj<a name='1104'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='1105'>
<a name='1106'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='1107'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='1108'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='1109'>
     REAL, DIMENSION ( cims:cime, cjms:cjme ) :: cht, ct_max_p, cght_max_p, cmax_p, ct_min_p, cght_min_p, cmin_p<a name='1110'>
     REAL, DIMENSION ( nims:nime, njms:njme ) :: nht, nt_max_p, nght_max_p, nmax_p, nt_min_p, nght_min_p, nmin_p<a name='1111'>
     REAL, DIMENSION ( ckms:ckme ) :: zn<a name='1112'>
     REAL :: p_top<a name='1113'>
     REAL, EXTERNAL :: v_interp_col<a name='1114'>
<a name='1115'>
     <font color=#447700>! Local<a name='1116'></font>
<a name='1117'>
     INTEGER ci, cj, ni, nj, nk, istag, jstag, i, j, k<a name='1118'>
     REAL :: wx, wy, nprs, cfld_ll, cfld_lr, cfld_ul, cfld_ur<a name='1119'>
     REAL , DIMENSION(ckms:ckme) :: cprs<a name='1120'>
     REAL    :: p00 , t00 , a , tiso , p_surf<a name='1121'>
<a name='1122'>
     <font color=#447700>!  Yes, memory sized to allow "outside the tile" indexing for horiz interpolation.  This<a name='1123'></font>
     <font color=#447700>!  is really an intermediate domain that has quite a bit of usable real estate surrounding<a name='1124'></font>
     <font color=#447700>!  the tile dimensions.<a name='1125'></font>
<a name='1126'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cpb<a name='1127'>
  <a name='1128'>
     <font color=#447700>!  A bit larger than tile sized to allow horizontal interpolation on the CG.<a name='1129'></font>
<a name='1130'>
     REAL, DIMENSION ( cits-2:cite+2, cjts-2:cjte+2 ) :: cfld_max_p, cfld_min_p<a name='1131'>
<a name='1132'>
     <font color=#447700>!  The usual tile size for the FG local array.<a name='1133'></font>
<a name='1134'>
     REAL, DIMENSION ( nits:nite, nkts:nkte, njts:njte ) :: npb<a name='1135'>
<a name='1136'>
     <font color=#447700>!  Get base state constants<a name='1137'></font>
<a name='1138'>
     CALL nl_get_base_pres  ( 1 , p00 )<a name='1139'>
     CALL nl_get_base_temp  ( 1 , t00 )<a name='1140'>
     CALL nl_get_base_lapse ( 1 , a   )<a name='1141'>
     CALL nl_get_iso_temp   ( 1 , tiso )<a name='1142'>
<a name='1143'>
     <font color=#447700>!  This stag stuff is to keep us away from the outer most row<a name='1144'></font>
     <font color=#447700>!  and column for the unstaggered directions.  We are going to <a name='1145'></font>
     <font color=#447700>!  consider "U" an xstag variable and "V" a ystag variable.  The<a name='1146'></font>
     <font color=#447700>!  vertical staggering is handled in the actual arguments.  The<a name='1147'></font>
     <font color=#447700>!  ckte and nkte are the ending vertical dimensions for computations<a name='1148'></font>
     <font color=#447700>!  for this particular variable.<a name='1149'></font>
<a name='1150'>
     IF ( xstag ) THEN<a name='1151'>
        istag = 0 <a name='1152'>
     ELSE<a name='1153'>
        istag = 1<a name='1154'>
     END IF<a name='1155'>
<a name='1156'>
     IF ( ystag ) THEN<a name='1157'>
        jstag = 0 <a name='1158'>
     ELSE<a name='1159'>
        jstag = 1<a name='1160'>
     END IF<a name='1161'>
<a name='1162'>
     <font color=#447700>!  Compute the reference pressure for the CG, function only of constants and elevation.<a name='1163'></font>
     <font color=#447700>!  We extend the i,j range to allow us to do horizontal interpolation.  We only need<a name='1164'></font>
     <font color=#447700>!  one extra grid cell surrounding the nest, and the intermediate domain has plenty of<a name='1165'></font>
     <font color=#447700>!  room with the halos set up for higher-order interpolations.  For intermediate domains,<a name='1166'></font>
     <font color=#447700>!  it turns out that the "domain" size actually fits within the "tile" size.  Yeppers,<a name='1167'></font>
     <font color=#447700>!  that is backwards from what usually happens.  That intermediate domain size is a couple<a name='1168'></font>
     <font color=#447700>!  grid points larger than necessary, and the tile is a couple of grid cells larger still.<a name='1169'></font>
     <font color=#447700>!  For our low-order interpolation, we can use the tile size for the CG, and we will have<a name='1170'></font>
     <font color=#447700>!  plenty of data on our boundaries.<a name='1171'></font>
<a name='1172'>
     DO j = cjts-2 , cjte+2<a name='1173'>
        DO i = cits-2 , cite+2<a name='1174'>
           p_surf = p00 * EXP ( -t00/a + ( (t00/a)**2 - 2.*g*cht(i,j)/a/r_d ) **0.5 )<a name='1175'>
           DO k = ckts , ckte<a name='1176'>
              cpb(i,k,j) = zn(k)*(p_surf - p_top) + p_top  <a name='1177'>
           END DO<a name='1178'>
           IF ( ckte .EQ. ckme ) THEN<a name='1179'>
              cfld_max_p(i,j) = cght_max_p(i,j) * g<a name='1180'>
              cfld_min_p(i,j) = cght_min_p(i,j) * g<a name='1181'>
           ELSE<a name='1182'>
              cfld_max_p(i,j) = ct_max_p(i,j) * (p1000mb/cmax_p(i,j))**(r_d/cp) - t0<a name='1183'>
              cfld_min_p(i,j) = ct_min_p(i,j) * (p1000mb/cmin_p(i,j))**(r_d/cp) - t0<a name='1184'>
           END IF<a name='1185'>
        END DO<a name='1186'>
     END DO<a name='1187'>
<a name='1188'>
     <font color=#447700>!  Compute the reference pressure for the FG. This is actually the size of the entire<a name='1189'></font>
     <font color=#447700>!  domain, not some chopped down piece of intermediate domain, as in the parent<a name='1190'></font>
     <font color=#447700>!  grid.  We do the traditional MAX(dom end -1,tile end), since we know a priori that the<a name='1191'></font>
     <font color=#447700>!  pressure is a mass point field (because the topo elevation is a mass point field).<a name='1192'></font>
<a name='1193'>
     DO j = njts , MIN(njde-1,njte)<a name='1194'>
        DO i = nits , MIN(nide-1,nite)<a name='1195'>
           p_surf = p00 * EXP ( -t00/a + ( (t00/a)**2 - 2.*g*nht(i,j)/a/r_d ) **0.5 )<a name='1196'>
           DO k = nkts , nkte<a name='1197'>
              npb(i,k,j) = zn(k)*(p_surf - p_top) + p_top  <a name='1198'>
           END DO<a name='1199'>
        END DO<a name='1200'>
     END DO<a name='1201'>
<a name='1202'>
     <font color=#447700>!  Loop over each j-index on this tile for the nested domain.<a name='1203'></font>
<a name='1204'>
     j_loop : DO nj = njts, MIN(njde-jstag,njte)<a name='1205'>
<a name='1206'>
        <font color=#447700>!  This is the lower-left j-index of the CG.<a name='1207'></font>
<a name='1208'>
        <font color=#447700>!  Example is 3:1 ratio, mass-point staggering.  We have listed six CG values<a name='1209'></font>
        <font color=#447700>!  as an example: A, B, C, D, E, F.  For a 3:1 ratio, each of these CG cells has<a name='1210'></font>
        <font color=#447700>!  nine associated FG points.<a name='1211'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='1212'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='1213'></font>
        <font color=#447700>!  |         |         |         |<a name='1214'></font>
        <font color=#447700>!  | -  D  - | -  E  - | -  F  - |<a name='1215'></font>
        <font color=#447700>!  |         |         |         |<a name='1216'></font>
        <font color=#447700>!  | 1  2  3 | 4  5  6 | 7  8  9 |<a name='1217'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='1218'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='1219'></font>
        <font color=#447700>!  |         |         |         |<a name='1220'></font>
        <font color=#447700>!  | -  A  - | -  B  - | -  C  - |<a name='1221'></font>
        <font color=#447700>!  |         |         |         |<a name='1222'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - |<a name='1223'></font>
        <font color=#447700>!  |=========|=========|=========|<a name='1224'></font>
        <font color=#447700>!  To interpolate to FG point 4, we will use CG points: A, B, D, E.  It is adequate to<a name='1225'></font>
        <font color=#447700>!  find the lower left point.  The lower left (LL) point for "4" is "A".  Below<a name='1226'></font>
        <font color=#447700>!  are a few more points.<a name='1227'></font>
        <font color=#447700>!  2 =&gt; A<a name='1228'></font>
        <font color=#447700>!  3 =&gt; A<a name='1229'></font>
        <font color=#447700>!  4 =&gt; A<a name='1230'></font>
        <font color=#447700>!  5 =&gt; B<a name='1231'></font>
        <font color=#447700>!  6 =&gt; B<a name='1232'></font>
        <font color=#447700>!  7 =&gt; B<a name='1233'></font>
        <font color=#447700>!  We want an equation that returns the CG LL:<a name='1234'></font>
        <font color=#447700>!  CG LL =   ipos                          (the starting point of the nest in the CG) <a name='1235'></font>
        <font color=#447700>!          + (ni-1)/nri                    (gives us the CG cell, based on the nri-groups of FG cells<a name='1236'></font>
        <font color=#447700>!          - istag                         (a correction term, this is either zero for u in the x-dir, <a name='1237'></font>
        <font color=#447700>!                                           since we are doing an "i" example, or 1 for anything else)<a name='1238'></font>
        <font color=#447700>!          + (MOD(ni-1,nri)+1 + nri/2)/nri (gives us specifically related CG point for each of the nri<a name='1239'></font>
        <font color=#447700>!                                           FG points, for example, we want points "1", "4", and "7" all<a name='1240'></font>
        <font color=#447700>!                                           to point to the CG at the left for the LL point)<a name='1241'></font>
        <font color=#447700>!  For grid points 4, 5, 6, we want the CG LL (sans the first two terms) to be -1, 0, 0 (which<a name='1242'></font>
        <font color=#447700>!  means that the CG point for "4" is to the left, and the CG LL point for "5" and "6"<a name='1243'></font>
        <font color=#447700>!  is in the current CG index.  <a name='1244'></font>
<a name='1245'>
        cj = jpos + (nj-1)/nrj - jstag + (MOD(nj-1,nrj)+1 + nrj/2)/nrj<a name='1246'>
<a name='1247'>
<a name='1248'>
        <font color=#447700>!  What is the weighting for this CG point to the FG point, j-weight only.<a name='1249'></font>
<a name='1250'>
        IF ( ystag ) THEN<a name='1251'>
           wy = 1. - ( REAL(MOD(nj+(nrj-1)/2,nrj)) / REAL(nrj) +  1. / REAL (2 * nrj) )<a name='1252'>
        ELSE<a name='1253'>
           wy = 1. - ( REAL(MOD(nj+(nrj-1)/2,nrj)) / REAL(nrj)                        )<a name='1254'>
        END IF<a name='1255'>
<a name='1256'>
        <font color=#447700>!  Vertical dim of the nest domain.<a name='1257'></font>
<a name='1258'>
        k_loop : DO nk = nkts, nkte<a name='1259'>
<a name='1260'>
          <font color=#447700>!  Loop over each i-index on this tile for the nested domain.<a name='1261'></font>
<a name='1262'>
           i_loop : DO ni = nits, MIN(nide-istag,nite)<a name='1263'>
 <a name='1264'>
              <font color=#447700>!  The coarse grid location that is to the lower left of the FG point.<a name='1265'></font>
<a name='1266'>
              ci = ipos + (ni-1)/nri - istag + (MOD(ni-1,nri)+1 + nri/2)/nri<a name='1267'>
<a name='1268'>
              <font color=#447700>!  Weights in the x-direction.<a name='1269'></font>
<a name='1270'>
              IF ( xstag ) THEN<a name='1271'>
                 wx = 1. - ( REAL(MOD(ni+(nri-1)/2,nri)) / REAL(nri) +  1. / REAL (2 * nri) )<a name='1272'>
              ELSE<a name='1273'>
                 wx = 1. - ( REAL(MOD(ni+(nri-1)/2,nri)) / REAL(nri)                        )<a name='1274'>
              END IF<a name='1275'>
<a name='1276'>
              <font color=#447700>!  The pressure of the FG point.<a name='1277'></font>
<a name='1278'>
              IF      ( ( .NOT. xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='1279'>
                 nprs =   npb(  ni  , nk , nj  ) <a name='1280'>
              ELSE IF ( xstag ) THEN<a name='1281'>
                 nprs = ( npb(  ni-1, nk , nj  ) + npb(  ni  , nk , nj  ) ) * 0.5<a name='1282'>
              ELSE IF ( ystag ) THEN<a name='1283'>
                 nprs = ( npb(  ni  , nk , nj-1) + npb(  ni  , nk , nj  ) ) * 0.5<a name='1284'>
              END IF<a name='1285'>
<a name='1286'>
              <font color=#447700>!  The four surrounding CG values.<a name='1287'></font>
<a name='1288'>
              IF      ( ( .NOT. xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='1289'>
                 cprs(:) =   cpb(ci  ,:,cj  )<a name='1290'>
                 cfld_ll = v_interp_col ( cfld(ci  ,:,cj  ) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci  , cj  , &amp;<a name='1291'>
                                          cfld_max_p(ci  ,cj  ) , cmax_p(ci  ,cj  ) , cfld_min_p(ci  ,cj  ) , cmin_p(ci  ,cj  ) )<a name='1292'>
                 cprs(:) =   cpb(ci+1,:,cj  )<a name='1293'>
                 cfld_lr = v_interp_col ( cfld(ci+1,:,cj  ) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci+1, cj  , &amp;<a name='1294'>
                                          cfld_max_p(ci+1,cj  ) , cmax_p(ci+1,cj  ) , cfld_min_p(ci+1,cj  ) , cmin_p(ci+1,cj  ) )<a name='1295'>
                 cprs(:) =   cpb(ci  ,:,cj+1)<a name='1296'>
                 cfld_ul = v_interp_col ( cfld(ci  ,:,cj+1) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci  , cj+1, &amp;<a name='1297'>
                                          cfld_max_p(ci  ,cj+1) , cmax_p(ci  ,cj+1) , cfld_min_p(ci  ,cj+1) , cmin_p(ci  ,cj+1) )<a name='1298'>
                 cprs(:) =   cpb(ci+1,:,cj+1)<a name='1299'>
                 cfld_ur = v_interp_col ( cfld(ci+1,:,cj+1) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci+1, cj+1, &amp;<a name='1300'>
                                          cfld_max_p(ci+1,cj+1) , cmax_p(ci+1,cj+1) , cfld_min_p(ci+1,cj+1) , cmin_p(ci+1,cj+1) )<a name='1301'>
<a name='1302'>
              ELSE IF ( xstag ) THEN<a name='1303'>
                 cprs(:) = ( cpb(ci  ,:,cj  ) + cpb(ci-1,:,cj  ) )*0.5 <a name='1304'>
                 cfld_ll = v_interp_col ( cfld(ci  ,:,cj  ) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci  , cj  , &amp;<a name='1305'>
                                          cfld_max_p(ci  ,cj  ) , cmax_p(ci  ,cj  ) , cfld_min_p(ci  ,cj  ) , cmin_p(ci  ,cj  ) )<a name='1306'>
                 cprs(:) = ( cpb(ci+1,:,cj  ) + cpb(ci  ,:,cj  ) )*0.5<a name='1307'>
                 cfld_lr = v_interp_col ( cfld(ci+1,:,cj  ) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci+1, cj  , &amp;<a name='1308'>
                                          cfld_max_p(ci+1,cj  ) , cmax_p(ci+1,cj  ) , cfld_min_p(ci+1,cj  ) , cmin_p(ci+1,cj  ) )<a name='1309'>
                 cprs(:) = ( cpb(ci  ,:,cj+1) + cpb(ci-1,:,cj+1) )*0.5<a name='1310'>
                 cfld_ul = v_interp_col ( cfld(ci  ,:,cj+1) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci  , cj+1, &amp;<a name='1311'>
                                          cfld_max_p(ci  ,cj+1) , cmax_p(ci  ,cj+1) , cfld_min_p(ci  ,cj+1) , cmin_p(ci  ,cj+1) )<a name='1312'>
                 cprs(:) = ( cpb(ci+1,:,cj+1) + cpb(ci  ,:,cj+1) )*0.5<a name='1313'>
                 cfld_ur = v_interp_col ( cfld(ci+1,:,cj+1) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci+1, cj+1, &amp;<a name='1314'>
                                          cfld_max_p(ci+1,cj+1) , cmax_p(ci+1,cj+1) , cfld_min_p(ci+1,cj+1) , cmin_p(ci+1,cj+1) )<a name='1315'>
              ELSE IF ( ystag ) THEN<a name='1316'>
                 cprs(:) = ( cpb(ci  ,:,cj  ) + cpb(ci  ,:,cj-1) )*0.5<a name='1317'>
                 cfld_ll = v_interp_col ( cfld(ci  ,:,cj  ) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci  , cj  , &amp;<a name='1318'>
                                          cfld_max_p(ci  ,cj  ) , cmax_p(ci  ,cj  ) , cfld_min_p(ci  ,cj  ) , cmin_p(ci  ,cj  ) )<a name='1319'>
                 cprs(:) = ( cpb(ci+1,:,cj  ) + cpb(ci+1,:,cj-1) )*0.5<a name='1320'>
                 cfld_lr = v_interp_col ( cfld(ci+1,:,cj  ) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci+1, cj  , &amp;<a name='1321'>
                                          cfld_max_p(ci+1,cj  ) , cmax_p(ci+1,cj  ) , cfld_min_p(ci+1,cj  ) , cmin_p(ci+1,cj  ) )<a name='1322'>
                 cprs(:) = ( cpb(ci  ,:,cj+1) + cpb(ci  ,:,cj  ) )*0.5<a name='1323'>
                 cfld_ul = v_interp_col ( cfld(ci  ,:,cj+1) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci  , cj+1, &amp;<a name='1324'>
                                          cfld_max_p(ci  ,cj+1) , cmax_p(ci  ,cj+1) , cfld_min_p(ci  ,cj+1) , cmin_p(ci  ,cj+1) )<a name='1325'>
                 cprs(:) = ( cpb(ci+1,:,cj+1) + cpb(ci+1,:,cj  ) )*0.5<a name='1326'>
                 cfld_ur = v_interp_col ( cfld(ci+1,:,cj+1) , cprs(:) , ckms , ckme , ckte, nprs, ni, nj, nk, ci+1, cj+1, &amp;<a name='1327'>
                                          cfld_max_p(ci+1,cj+1) , cmax_p(ci+1,cj+1) , cfld_min_p(ci+1,cj+1) , cmin_p(ci+1,cj+1) )<a name='1328'>
              END IF<a name='1329'>
<a name='1330'>
              <font color=#447700>!  Bilinear interpolation in horizontal with vertically corrected CG field values.<a name='1331'></font>
<a name='1332'>
              nfld( ni , nk , nj ) =     wy  * ( cfld_ll * wx + cfld_lr * (1.-wx) ) + &amp;<a name='1333'>
                                     (1.-wy) * ( cfld_ul * wx + cfld_ur * (1.-wx) )<a name='1334'>
<a name='1335'>
           END DO i_loop<a name='1336'>
        END DO    k_loop<a name='1337'>
     END DO       j_loop<a name='1338'>
<a name='1339'>
     <font color=#447700>!  If this is ph_2, make the values at k=1 all zero<a name='1340'></font>
<a name='1341'>
     IF ( ckme .EQ. ckte ) THEN<a name='1342'>
        DO nj = njts,njte<a name='1343'>
           DO ni = nits, nite<a name='1344'>
              nfld(ni,nkts,nj) = 0.0<a name='1345'>
           END DO<a name='1346'>
        END DO<a name='1347'>
     END IF<a name='1348'>
<a name='1349'>
   END SUBROUTINE interp_fcn_bl<a name='1350'>
<a name='1351'>
<font color=#447700>!==================================<a name='1352'></font>
<a name='1353'>
<A NAME='V_INTERP_COL'><A href='../../html_code/share/interp_fcn.F.html#V_INTERP_COL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1354'>
   <font color=#993300>FUNCTION </font><font color=#cc0000>v_interp_col</font> ( cfld_orig , cprs_orig , ckms , ckme , ckte , nprs, ni, nj, nk, ci, cj, &amp;,<A href='../../call_from/V_INTERP_COL.html' TARGET='index'>1</A><a name='1355'>
                           cfld_max_p , cmax_p , cfld_min_p , cmin_p ) RESULT ( cfld_interp )<a name='1356'>
<a name='1357'>
      IMPLICIT NONE<a name='1358'>
<a name='1359'>
      INTEGER , INTENT(IN) ::  ni, nj, nk, ci, cj<a name='1360'>
      INTEGER , INTENT(IN) :: ckms , ckme , ckte<a name='1361'>
      REAL , DIMENSION(ckms:ckme) , INTENT(IN) :: cfld_orig , cprs_orig<a name='1362'>
      REAL , INTENT(IN) :: cfld_max_p , cmax_p , cfld_min_p , cmin_p<a name='1363'>
      REAL , INTENT(IN) :: nprs<a name='1364'>
      REAL :: cfld_interp<a name='1365'>
<a name='1366'>
      <font color=#447700>!  Local<a name='1367'></font>
<a name='1368'>
      INTEGER :: ck<a name='1369'>
      LOGICAL :: found<a name='1370'>
      CHARACTER(LEN=256) :: joe_mess<a name='1371'>
      REAL , DIMENSION(ckms:ckme+1+1) :: cfld , cprs<a name='1372'>
<a name='1373'>
      <font color=#447700>!  Fill input arrays<a name='1374'></font>
<a name='1375'>
      cfld(1) = cfld_max_p<a name='1376'>
      cprs(1) = cmax_p<a name='1377'>
<a name='1378'>
      cfld(ckte+2) = cfld_min_p<a name='1379'>
      cprs(ckte+2) = cmin_p<a name='1380'>
<a name='1381'>
      DO ck = ckms , ckte<a name='1382'>
         cfld(ck+1) = cfld_orig(ck)<a name='1383'>
         cprs(ck+1) = cprs_orig(ck)<a name='1384'>
      END DO<a name='1385'>
<a name='1386'>
      found = .FALSE.<a name='1387'>
<a name='1388'>
      IF      ( cprs(ckms) .LT. nprs ) THEN<a name='1389'>
         cfld_interp = cfld(ckms)<a name='1390'>
         RETURN<a name='1391'>
      ELSE IF ( cprs(ckte+2) .GE. nprs ) THEN<a name='1392'>
         cfld_interp = cfld(ckte+2)<a name='1393'>
         RETURN<a name='1394'>
      END IF<a name='1395'>
<a name='1396'>
      DO ck = ckms , ckte+1<a name='1397'>
         IF ( ( cprs(ck  ) .GE. nprs ) .AND. &amp;<a name='1398'>
              ( cprs(ck+1) .LT. nprs ) ) THEN<a name='1399'>
            cfld_interp = ( cfld(ck  ) * ( nprs     - cprs(ck+1) ) + &amp;<a name='1400'>
                            cfld(ck+1) * ( cprs(ck) - nprs       ) ) / &amp;<a name='1401'>
                                         ( cprs(ck) - cprs(ck+1) )<a name='1402'>
            RETURN<a name='1403'>
         END IF<a name='1404'>
      END DO<a name='1405'>
<a name='1406'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#V_INTERP_COL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1315"> ( 'ERROR -- vertical interpolation for nest interp cannot find trapping pressures' )<a name='1407'>
   <a name='1408'>
   END FUNCTION v_interp_col<a name='1409'>
<a name='1410'>
<font color=#447700>!==================================<a name='1411'></font>
<font color=#447700>! this is the default function used in feedback.<a name='1412'></font>
<a name='1413'>
<A NAME='COPY_FCN'><A href='../../html_code/share/interp_fcn.F.html#COPY_FCN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1414'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>copy_fcn</font> ( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/COPY_FCN.html' TARGET='index'>1</A><a name='1415'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1416'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1417'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1418'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='1419'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1420'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1421'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1422'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='1423'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1424'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1425'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1426'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='1427'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_169"><a name='1428'>
     IMPLICIT NONE<a name='1429'>
<a name='1430'>
<a name='1431'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1432'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1433'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1434'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1435'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1436'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1437'>
                            shw,                                  &amp;<a name='1438'>
                            ipos, jpos,                           &amp;<a name='1439'>
                            nri, nrj<a name='1440'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='1441'>
<a name='1442'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(OUT) :: cfld<a name='1443'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ),INTENT(IN)  :: nfld<a name='1444'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ),INTENT(IN)  :: imask<a name='1445'>
<a name='1446'>
     <font color=#447700>! Local<a name='1447'></font>
<a name='1448'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, ioffa, joffa<a name='1449'>
     INTEGER :: icmin,icmax,jcmin,jcmax<a name='1450'>
     INTEGER :: istag,jstag, ipoints,jpoints,ijpoints<a name='1451'>
     INTEGER , PARAMETER :: passes = 2<a name='1452'>
     INTEGER spec_zone<a name='1453'>
<a name='1454'>
     <font color=#447700>!  Loop over the coarse grid in the area of the fine mesh.  Do not<a name='1455'></font>
     <font color=#447700>!  process the coarse grid values that are along the lateral BC<a name='1456'></font>
     <font color=#447700>!  provided to the fine grid.  Since that is in the specified zone<a name='1457'></font>
     <font color=#447700>!  for the fine grid, it should not be used in any feedback to the<a name='1458'></font>
     <font color=#447700>!  coarse grid as it should not have changed.<a name='1459'></font>
<a name='1460'>
     <font color=#447700>!  Due to peculiarities of staggering, it is simpler to handle the feedback<a name='1461'></font>
     <font color=#447700>!  for the staggerings based upon whether it is a even ratio (2::1, 4::1, etc.) or<a name='1462'></font>
     <font color=#447700>!  an odd staggering ratio (3::1, 5::1, etc.). <a name='1463'></font>
<a name='1464'>
     <font color=#447700>!  Though there are separate grid ratios for the i and j directions, this code<a name='1465'></font>
     <font color=#447700>!  is not general enough to handle aspect ratios .NE. 1 for the fine grid cell.<a name='1466'></font>
 <a name='1467'>
     <font color=#447700>!  These are local integer increments in the looping.  Basically, istag=1 means<a name='1468'></font>
     <font color=#447700>!  that we will assume one less point in the i direction.  Note that ci and cj<a name='1469'></font>
     <font color=#447700>!  have a maximum value that is decreased by istag and jstag, respectively.  <a name='1470'></font>
<a name='1471'>
     <font color=#447700>!  Horizontal momentum feedback is along the face, not within the cell.  For a<a name='1472'></font>
     <font color=#447700>!  3::1 ratio, temperature would use 9 pts for feedback, while u and v use<a name='1473'></font>
     <font color=#447700>!  only 3 points for feedback from the nest to the parent.<a name='1474'></font>
<a name='1475'>
     CALL nl_get_spec_zone( 1 , spec_zone )<a name='1476'>
     istag = 1 ; jstag = 1<a name='1477'>
     IF ( xstag ) istag = 0<a name='1478'>
     IF ( ystag ) jstag = 0<a name='1479'>
<a name='1480'>
     IF( MOD(nrj,2) .NE. 0) THEN  <font color=#447700>! odd refinement ratio<a name='1481'></font>
<a name='1482'>
        IF      ( ( .NOT. xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='1483'>
           DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1484'>
              nj = (cj-jpos)*nrj + jstag + 1<a name='1485'>
              DO ck = ckts, ckte<a name='1486'>
                 nk = ck<a name='1487'>
                 DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1488'>
                    ni = (ci-ipos)*nri + istag + 1<a name='1489'>
                    cfld( ci, ck, cj ) = 0.<a name='1490'>
                    DO ijpoints = 1 , nri * nrj<a name='1491'>
                       ipoints = MOD((ijpoints-1),nri) + 1 - nri/2 - 1<a name='1492'>
                       jpoints = (ijpoints-1)/nri + 1 - nrj/2 - 1<a name='1493'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='1494'>
                                             1./REAL(nri*nrj) * nfld( ni+ipoints , nk , nj+jpoints )<a name='1495'>
                    END DO<a name='1496'>
<font color=#447700>!                   cfld( ci, ck, cj ) =  1./9. * &amp;<a name='1497'></font>
<font color=#447700>!                                         ( nfld( ni-1, nk , nj-1) + &amp;<a name='1498'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj-1) + &amp;<a name='1499'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj-1) + &amp;<a name='1500'></font>
<font color=#447700>!                                           nfld( ni-1, nk , nj  ) + &amp;<a name='1501'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj  ) + &amp;<a name='1502'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj  ) + &amp;<a name='1503'></font>
<font color=#447700>!                                           nfld( ni-1, nk , nj+1) + &amp;<a name='1504'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj+1) + &amp;<a name='1505'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj+1) )<a name='1506'></font>
                 ENDDO<a name='1507'>
              ENDDO<a name='1508'>
           ENDDO<a name='1509'>
<a name='1510'>
        ELSE IF ( (       xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='1511'>
           DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1512'>
              nj = (cj-jpos)*nrj + jstag + 1<a name='1513'>
              DO ck = ckts, ckte<a name='1514'>
                 nk = ck<a name='1515'>
                 DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1516'>
                    ni = (ci-ipos)*nri + istag + 1<a name='1517'>
                    cfld( ci, ck, cj ) = 0.<a name='1518'>
                    DO ijpoints = (nri+1)/2 , (nri+1)/2 + nri*(nri-1) , nri<a name='1519'>
                       ipoints = MOD((ijpoints-1),nri) + 1 - nri/2 - 1<a name='1520'>
                       jpoints = (ijpoints-1)/nri + 1 - nrj/2 - 1<a name='1521'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='1522'>
                                             1./REAL(nri    ) * nfld( ni+ipoints , nk , nj+jpoints )<a name='1523'>
                    END DO<a name='1524'>
<font color=#447700>!                   cfld( ci, ck, cj ) =  1./3. * &amp;<a name='1525'></font>
<font color=#447700>!                                         ( nfld( ni  , nk , nj-1) + &amp;<a name='1526'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj  ) + &amp;<a name='1527'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj+1) )<a name='1528'></font>
                 ENDDO<a name='1529'>
              ENDDO<a name='1530'>
           ENDDO<a name='1531'>
<a name='1532'>
        ELSE IF ( ( .NOT. xstag ) .AND. (       ystag ) ) THEN<a name='1533'>
           DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1534'>
              nj = (cj-jpos)*nrj + jstag + 1<a name='1535'>
              DO ck = ckts, ckte<a name='1536'>
                 nk = ck<a name='1537'>
                 DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1538'>
                    ni = (ci-ipos)*nri + istag + 1<a name='1539'>
                    cfld( ci, ck, cj ) = 0.<a name='1540'>
                    DO ijpoints = ( nrj*nrj +1 )/2 - nrj/2 , ( nrj*nrj +1 )/2 - nrj/2 + nrj-1<a name='1541'>
                       ipoints = MOD((ijpoints-1),nri) + 1 - nri/2 - 1<a name='1542'>
                       jpoints = (ijpoints-1)/nri + 1 - nrj/2 - 1<a name='1543'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='1544'>
                                             1./REAL(    nrj) * nfld( ni+ipoints , nk , nj+jpoints )<a name='1545'>
                    END DO<a name='1546'>
<font color=#447700>!                   cfld( ci, ck, cj ) =  1./3. * &amp;<a name='1547'></font>
<font color=#447700>!                                         ( nfld( ni-1, nk , nj  ) + &amp;<a name='1548'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj  ) + &amp;<a name='1549'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj  ) )<a name='1550'></font>
                 ENDDO<a name='1551'>
              ENDDO<a name='1552'>
           ENDDO<a name='1553'>
<a name='1554'>
        END IF<a name='1555'>
<a name='1556'>
     <font color=#447700>!  Even refinement ratio<a name='1557'></font>
<a name='1558'>
     ELSE IF ( MOD(nrj,2) .EQ. 0) THEN<a name='1559'>
        IF ( ( .NOT. xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='1560'>
<a name='1561'>
        <font color=#447700>!  This is a simple schematic of the feedback indexing used in the even<a name='1562'></font>
        <font color=#447700>!  ratio nests.  For simplicity, a 2::1 ratio is depicted.  Only the <a name='1563'></font>
        <font color=#447700>!  mass variable staggering is shown. <a name='1564'></font>
        <font color=#447700>!                                                                  Each of<a name='1565'></font>
        <font color=#447700>!  the boxes with a "T" and four small "t" represents a coarse grid (CG)<a name='1566'></font>
        <font color=#447700>!  cell, that is composed of four (2::1 ratio) fine grid (FG) cells.<a name='1567'></font>
   <a name='1568'>
        <font color=#447700>!  Shown below is the area of the CG that is in the area of the FG.   The<a name='1569'></font>
        <font color=#447700>!  first grid point of the depicted CG is the starting location of the nest<a name='1570'></font>
        <font color=#447700>!  in the parent domain (ipos,jpos - i_parent_start and j_parent_start from<a name='1571'></font>
        <font color=#447700>!  the namelist).  <a name='1572'></font>
   <a name='1573'>
        <font color=#447700>!  For each of the CG points, the feedback loop is over each of the FG points<a name='1574'></font>
        <font color=#447700>!  within the CG cell.  For a 2::1 ratio, there are four total points (this is <a name='1575'></font>
        <font color=#447700>!  the ijpoints loop).  The feedback value to the CG is the arithmetic mean of <a name='1576'></font>
        <font color=#447700>!  all of the FG values within each CG cell.<a name='1577'></font>
<a name='1578'>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='1579'></font>
<font color=#447700>!              |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='1580'></font>
<font color=#447700>! jpos+        |             ||             |                          |             ||             |<a name='1581'></font>
<font color=#447700>! (njde-njds)- |      T      ||      T      |                          |      T      ||      T      |<a name='1582'></font>
<font color=#447700>! jstag        |             ||             |                          |             ||             |<a name='1583'></font>
<font color=#447700>!              |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='1584'></font>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='1585'></font>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='1586'></font>
<font color=#447700>!              |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='1587'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='1588'></font>
<font color=#447700>!              |      T      ||      T      |                          |      T      ||      T      |<a name='1589'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='1590'></font>
<font color=#447700>!              |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='1591'></font>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='1592'></font>
<font color=#447700>!<a name='1593'></font>
<font color=#447700>!                   ...<a name='1594'></font>
<font color=#447700>!                   ...<a name='1595'></font>
<font color=#447700>!                   ...<a name='1596'></font>
<font color=#447700>!                   ...<a name='1597'></font>
<font color=#447700>!                   ...<a name='1598'></font>
<a name='1599'>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='1600'></font>
<font color=#447700>! jpoints = 1  |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='1601'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='1602'></font>
<font color=#447700>!              |      T      ||      T      |                          |      T      ||      T      |<a name='1603'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='1604'></font>
<font color=#447700>! jpoints = 0, |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='1605'></font>
<font color=#447700>!  nj=3        |-------------||-------------|                          |-------------||-------------|<a name='1606'></font>
<font color=#447700>!              |-------------||-------------|                          |-------------||-------------|<a name='1607'></font>
<font color=#447700>! jpoints = 1  |  t      t   ||  t      t   |                          |  t      t   ||  t      t   |<a name='1608'></font>
<font color=#447700>!              |             ||             |                          |             ||             |<a name='1609'></font>
<font color=#447700>!    jpos      |      T      ||      T      |          ...             |      T      ||      T      |<a name='1610'></font>
<font color=#447700>!              |             ||             |          ...             |             ||             |<a name='1611'></font>
<font color=#447700>! jpoints = 0, |  t      t   ||  t      t   |          ...             |  t      t   ||  t      t   |<a name='1612'></font>
<font color=#447700>!  nj=1        |-------------||-------------|                          |-------------||-------------|<a name='1613'></font>
<font color=#447700>!                     ^                                                                      ^<a name='1614'></font>
<font color=#447700>!                     |                                                                      |<a name='1615'></font>
<font color=#447700>!                     |                                                                      |<a name='1616'></font>
<font color=#447700>!                   ipos                                                                   ipos+<a name='1617'></font>
<font color=#447700>!     ni =        1              3                                                         (nide-nids)/nri<a name='1618'></font>
<font color=#447700>! ipoints=        0      1       0      1                                                  -istag<a name='1619'></font>
<font color=#447700>!<a name='1620'></font>
<a name='1621'>
           <font color=#447700>!  For performance benefits, users can comment out the inner most loop (and cfld=0) and<a name='1622'></font>
           <font color=#447700>!  hardcode the loop feedback.  For example, it is set up to run a 2::1 ratio<a name='1623'></font>
           <font color=#447700>!  if uncommented.  This lacks generality, but is likely to gain timing benefits<a name='1624'></font>
           <font color=#447700>!  with compilers unable to unroll inner loops that do not have parameterized sizes.<a name='1625'></font>
   <a name='1626'>
           <font color=#447700>!  The extra +1 ---------/ and the extra -1 ----\  (both for ci and cj) <a name='1627'></font>
           <font color=#447700>!                       /                        \   keeps the feedback out of the <a name='1628'></font>
           <font color=#447700>!                      /                          \  outer row/col, since that CG data<a name='1629'></font>
           <font color=#447700>!                     /                            \ specified the nest boundary originally<a name='1630'></font>
           <font color=#447700>!                    /                              \   This<a name='1631'></font>
           <font color=#447700>!                   /                                \    is just<a name='1632'></font>
           <font color=#447700>!                  /                                  \   a sentence to not end a line<a name='1633'></font>
           <font color=#447700>!                 /                                    \   with a stupid backslash<a name='1634'></font>
           DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1635'>
              nj = (cj-jpos)*nrj + jstag<a name='1636'>
              DO ck = ckts, ckte<a name='1637'>
                 nk = ck<a name='1638'>
                 DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1639'>
                    ni = (ci-ipos)*nri + istag<a name='1640'>
                    cfld( ci, ck, cj ) = 0.<a name='1641'>
                    DO ijpoints = 1 , nri * nrj<a name='1642'>
                       ipoints = MOD((ijpoints-1),nri)<a name='1643'>
                       jpoints = (ijpoints-1)/nri<a name='1644'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='1645'>
                                             1./REAL(nri*nrj) * nfld( ni+ipoints , nk , nj+jpoints )<a name='1646'>
                    END DO<a name='1647'>
<font color=#447700>!                   cfld( ci, ck, cj ) =  1./4. * &amp;<a name='1648'></font>
<font color=#447700>!                                         ( nfld( ni  , nk , nj  ) + &amp;<a name='1649'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj  ) + &amp;<a name='1650'></font>
<font color=#447700>!                                           nfld( ni  , nk , nj+1) + &amp;<a name='1651'></font>
<font color=#447700>!                                           nfld( ni+1, nk , nj+1) )<a name='1652'></font>
                 END DO<a name='1653'>
              END DO<a name='1654'>
           END DO<a name='1655'>
<a name='1656'>
        <font color=#447700>!  U<a name='1657'></font>
<a name='1658'>
        ELSE IF ( (       xstag ) .AND. ( .NOT. ystag ) ) THEN<a name='1659'>
<font color=#447700>!              |---------------|<a name='1660'></font>
<font color=#447700>!              |               |<a name='1661'></font>
<font color=#447700>! jpoints = 1  u       u       |<a name='1662'></font>
<font color=#447700>!              |               |<a name='1663'></font>
<font color=#447700>!              U               |<a name='1664'></font>
<font color=#447700>!              |               |<a name='1665'></font>
<font color=#447700>! jpoints = 0, u       u       |<a name='1666'></font>
<font color=#447700>!  nj=3        |               |<a name='1667'></font>
<font color=#447700>!              |---------------|<a name='1668'></font>
<font color=#447700>!              |---------------|<a name='1669'></font>
<font color=#447700>!              |               |<a name='1670'></font>
<font color=#447700>! jpoints = 1  u       u       |<a name='1671'></font>
<font color=#447700>!              |               |<a name='1672'></font>
<font color=#447700>!    jpos      U               |<a name='1673'></font>
<font color=#447700>!              |               |<a name='1674'></font>
<font color=#447700>! jpoints = 0, u       u       |<a name='1675'></font>
<font color=#447700>! nj=1         |               |<a name='1676'></font>
<font color=#447700>!              |---------------|<a name='1677'></font>
<font color=#447700>! <a name='1678'></font>
<font color=#447700>!              ^               <a name='1679'></font>
<font color=#447700>!              |              <a name='1680'></font>
<font color=#447700>!              |             <a name='1681'></font>
<font color=#447700>!            ipos           <a name='1682'></font>
<font color=#447700>!     ni =     1               3<a name='1683'></font>
<font color=#447700>! ipoints=     0       1       0 <a name='1684'></font>
<font color=#447700>!<a name='1685'></font>
<a name='1686'>
           DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1687'>
              nj = (cj-jpos)*nrj + 1<a name='1688'>
              DO ck = ckts, ckte<a name='1689'>
                 nk = ck<a name='1690'>
                 DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1691'>
                    ni = (ci-ipos)*nri + 1<a name='1692'>
                    cfld( ci, ck, cj ) = 0.<a name='1693'>
                    DO ijpoints = 1 , nri*nrj , nri<a name='1694'>
                       ipoints = MOD((ijpoints-1),nri)<a name='1695'>
                       jpoints = (ijpoints-1)/nri<a name='1696'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='1697'>
                                             1./REAL(nri    ) * nfld( ni+ipoints , nk , nj+jpoints )<a name='1698'>
                    END DO<a name='1699'>
<font color=#447700>!                cfld( ci, ck, cj ) =  1./2. * &amp;<a name='1700'></font>
<font color=#447700>!                                      ( nfld( ni  , nk , nj  ) + &amp;<a name='1701'></font>
<font color=#447700>!                                        nfld( ni  , nk , nj+1) )<a name='1702'></font>
                 ENDDO<a name='1703'>
              ENDDO<a name='1704'>
           ENDDO<a name='1705'>
<a name='1706'>
        <font color=#447700>!  V <a name='1707'></font>
<a name='1708'>
        ELSE IF ( ( .NOT. xstag ) .AND. (       ystag ) ) THEN<a name='1709'>
           DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1710'>
              nj = (cj-jpos)*nrj + 1<a name='1711'>
              DO ck = ckts, ckte<a name='1712'>
                 nk = ck<a name='1713'>
                 DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1714'>
                    ni = (ci-ipos)*nri + 1<a name='1715'>
                    cfld( ci, ck, cj ) = 0.<a name='1716'>
                    DO ijpoints = 1 , nri<a name='1717'>
                       ipoints = MOD((ijpoints-1),nri)<a name='1718'>
                       jpoints = (ijpoints-1)/nri<a name='1719'>
                       cfld( ci, ck, cj ) =  cfld( ci, ck, cj ) + &amp;<a name='1720'>
                                             1./REAL(nri    ) * nfld( ni+ipoints , nk , nj+jpoints )<a name='1721'>
                    END DO<a name='1722'>
<font color=#447700>!                cfld( ci, ck, cj ) =  1./2. * &amp;<a name='1723'></font>
<font color=#447700>!                                      ( nfld( ni  , nk , nj  ) + &amp;<a name='1724'></font>
<font color=#447700>!                                        nfld( ni+1, nk , nj  ) )<a name='1725'></font>
                 ENDDO<a name='1726'>
              ENDDO<a name='1727'>
           ENDDO<a name='1728'>
        END IF<a name='1729'>
     END IF<a name='1730'>
<a name='1731'>
     RETURN<a name='1732'>
<a name='1733'>
   END SUBROUTINE copy_fcn<a name='1734'>
<a name='1735'>
<font color=#447700>!==================================<a name='1736'></font>
<font color=#447700>! this is the 1pt function used in feedback.<a name='1737'></font>
<a name='1738'>
<A NAME='COPY_FCNM'><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1739'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>copy_fcnm</font> (  cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/COPY_FCNM.html' TARGET='index'>2</A><a name='1740'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1741'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1742'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1743'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='1744'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1745'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1746'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1747'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='1748'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1749'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1750'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1751'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='1752'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_170"><a name='1753'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_92"><a name='1754'>
     IMPLICIT NONE<a name='1755'>
<a name='1756'>
<a name='1757'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1758'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1759'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1760'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1761'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1762'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1763'>
                            shw,                                  &amp;<a name='1764'>
                            ipos, jpos,                           &amp;<a name='1765'>
                            nri, nrj<a name='1766'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='1767'>
<a name='1768'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(OUT) :: cfld<a name='1769'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(IN) :: nfld<a name='1770'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ), INTENT(IN) :: imask<a name='1771'>
<a name='1772'>
     <font color=#447700>! Local<a name='1773'></font>
<a name='1774'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, ioffa, joffa<a name='1775'>
     INTEGER :: icmin,icmax,jcmin,jcmax<a name='1776'>
     INTEGER :: istag,jstag, ipoints,jpoints,ijpoints<a name='1777'>
     INTEGER , PARAMETER :: passes = 2<a name='1778'>
     INTEGER spec_zone<a name='1779'>
<a name='1780'>
     CALL nl_get_spec_zone( 1, spec_zone ) <a name='1781'>
     istag = 1 ; jstag = 1<a name='1782'>
     IF ( xstag ) istag = 0<a name='1783'>
     IF ( ystag ) jstag = 0<a name='1784'>
<a name='1785'>
     IF( MOD(nrj,2) .NE. 0) THEN  <font color=#447700>! odd refinement ratio<a name='1786'></font>
<a name='1787'>
        DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1788'>
           nj = (cj-jpos)*nrj + jstag + 1<a name='1789'>
           DO ck = ckts, ckte<a name='1790'>
              nk = ck<a name='1791'>
              DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1792'>
                 ni = (ci-ipos)*nri + istag + 1<a name='1793'>
                 cfld( ci, ck, cj ) =  nfld( ni  , nk , nj  )<a name='1794'>
              ENDDO<a name='1795'>
           ENDDO<a name='1796'>
        ENDDO<a name='1797'>
<a name='1798'>
     ELSE  <font color=#447700>! even refinement ratio, pick nearest neighbor on SW corner<a name='1799'></font>
        DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1800'>
           nj = (cj-jpos)*nrj + 1<a name='1801'>
           DO ck = ckts, ckte<a name='1802'>
              nk = ck<a name='1803'>
              DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1804'>
                 ni = (ci-ipos)*nri + 1<a name='1805'>
                 ipoints = nri/2 -1<a name='1806'>
                 jpoints = nrj/2 -1<a name='1807'>
                 cfld( ci, ck, cj ) =  nfld( ni+ipoints , nk , nj+jpoints )<a name='1808'>
              END DO<a name='1809'>
           END DO<a name='1810'>
        END DO<a name='1811'>
<a name='1812'>
     END IF<a name='1813'>
<a name='1814'>
     RETURN<a name='1815'>
<a name='1816'>
   END SUBROUTINE copy_fcnm<a name='1817'>
<a name='1818'>
<font color=#447700>!==================================<a name='1819'></font>
<font color=#447700>! this is the 1pt function used in feedback for integers<a name='1820'></font>
<a name='1821'>
<A NAME='COPY_FCNI'><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1822'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>copy_fcni</font> ( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/COPY_FCNI.html' TARGET='index'>2</A><a name='1823'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1824'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1825'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1826'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='1827'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1828'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1829'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1830'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='1831'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='1832'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='1833'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='1834'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='1835'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_171"><a name='1836'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#COPY_FCNI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_93"><a name='1837'>
     IMPLICIT NONE<a name='1838'>
<a name='1839'>
<a name='1840'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='1841'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='1842'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='1843'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='1844'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='1845'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='1846'>
                            shw,                                  &amp;<a name='1847'>
                            ipos, jpos,                           &amp;<a name='1848'>
                            nri, nrj<a name='1849'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='1850'>
<a name='1851'>
     INTEGER, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(OUT) :: cfld<a name='1852'>
     INTEGER, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(IN) :: nfld<a name='1853'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ), INTENT(IN)  :: imask<a name='1854'>
<a name='1855'>
     <font color=#447700>! Local<a name='1856'></font>
<a name='1857'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, ioffa, joffa<a name='1858'>
     INTEGER :: icmin,icmax,jcmin,jcmax<a name='1859'>
     INTEGER :: istag,jstag, ipoints,jpoints,ijpoints<a name='1860'>
     INTEGER , PARAMETER :: passes = 2<a name='1861'>
     INTEGER spec_zone<a name='1862'>
<a name='1863'>
     CALL nl_get_spec_zone( 1, spec_zone ) <a name='1864'>
     istag = 1 ; jstag = 1<a name='1865'>
     IF ( xstag ) istag = 0<a name='1866'>
     IF ( ystag ) jstag = 0<a name='1867'>
<a name='1868'>
     IF( MOD(nrj,2) .NE. 0) THEN  <font color=#447700>! odd refinement ratio<a name='1869'></font>
<a name='1870'>
        DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1871'>
           nj = (cj-jpos)*nrj + jstag + 1<a name='1872'>
           DO ck = ckts, ckte<a name='1873'>
              nk = ck<a name='1874'>
              DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1875'>
                 ni = (ci-ipos)*nri + istag + 1<a name='1876'>
                 cfld( ci, ck, cj ) =  nfld( ni  , nk , nj  )<a name='1877'>
              ENDDO<a name='1878'>
           ENDDO<a name='1879'>
        ENDDO<a name='1880'>
<a name='1881'>
     ELSE  <font color=#447700>! even refinement ratio<a name='1882'></font>
        DO cj = MAX(jpos+spec_zone,cjts),MIN(jpos+(njde-njds)/nrj-jstag-spec_zone,cjte)<a name='1883'>
           nj = (cj-jpos)*nrj + 1<a name='1884'>
           DO ck = ckts, ckte<a name='1885'>
              nk = ck<a name='1886'>
              DO ci = MAX(ipos+spec_zone,cits),MIN(ipos+(nide-nids)/nri-istag-spec_zone,cite)<a name='1887'>
                 ni = (ci-ipos)*nri + 1<a name='1888'>
                 ipoints = nri/2 -1<a name='1889'>
                 jpoints = nrj/2 -1<a name='1890'>
                 cfld( ci, ck, cj ) =  nfld( ni+ipoints , nk , nj+jpoints )<a name='1891'>
              END DO<a name='1892'>
           END DO<a name='1893'>
        END DO<a name='1894'>
<a name='1895'>
     END IF<a name='1896'>
<a name='1897'>
     RETURN<a name='1898'>
<a name='1899'>
   END SUBROUTINE copy_fcni<a name='1900'>
<a name='1901'>
<font color=#447700>!==================================<a name='1902'></font>
<a name='1903'>
<A NAME='VERT_INTERP_VERT_NESTING'><A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1904'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>vert_interp_vert_nesting</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/VERT_INTERP_VERT_NESTING.html' TARGET='index'>1</A>,<A href='../../call_from/VERT_INTERP_VERT_NESTING.html' TARGET='index'>1</A><a name='1905'></font>
                                         ids, ide, kds, kde, jds, jde,         &amp; <a name='1906'>
                                         ims, ime, kms, kme, jms, jme,         &amp;<a name='1907'>
                                         its, ite, kts, kte, jts, jte,         &amp;   <a name='1908'>
                                         pgrid_s_vert, pgrid_e_vert,           &amp;  <font color=#447700>! vertical dimensions of parent grid<a name='1909'></font>
					 cf1_c, cf2_c, cf3_c, cfn_c, cfn1_c,   &amp;  <font color=#447700>! coarse grid extrapolation constants<a name='1910'></font>
                                         alt_u_c, alt_u_n)<a name='1911'>
<a name='1912'>
<font color=#447700>!KAL vertical interpolation for u, v, and mass points (w is below in a different subroutine) for vertical nesting <a name='1913'></font>
<a name='1914'>
   IMPLICIT NONE<a name='1915'>
   REAL, DIMENSION ( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) :: cfld   <a name='1916'>
   INTEGER, INTENT(IN) :: ids, ide, kds, kde, jds, jde,   &amp;<a name='1917'>
                          ims, ime, kms, kme, jms, jme,   &amp;<a name='1918'>
                          its, ite, kts, kte, jts, jte<a name='1919'>
   INTEGER, INTENT(IN) :: pgrid_s_vert, pgrid_e_vert                <font color=#447700>! vertical dimensions of the parent grid			  <a name='1920'></font>
   REAL, INTENT(IN)    :: cf1_c, cf2_c, cf3_c, cfn_c, cfn1_c<a name='1921'>
   REAL, DIMENSION(pgrid_s_vert:pgrid_e_vert+1), INTENT(IN) :: alt_u_c<a name='1922'>
   REAL, DIMENSION(kde+1), INTENT(IN) :: alt_u_n<a name='1923'>
<a name='1924'>
   <a name='1925'>
   <font color=#447700>!local<a name='1926'></font>
   <a name='1927'>
   INTEGER :: i,j,k<a name='1928'>
   REAL, DIMENSION(pgrid_s_vert:pgrid_e_vert+1) :: pro_u_c           <font color=#447700>! variable in 1D on the coarse grid<a name='1929'></font>
   REAL, DIMENSION(kde+1) :: pro_u_n<a name='1930'>
   <a name='1931'>
   DO j = jms,jme<a name='1932'>
   DO i = ims,ime<a name='1933'>
   <a name='1934'>
      <font color=#447700>! pro_u_c is u on the 1D coarse grid <a name='1935'></font>
    <a name='1936'>
      do k = pgrid_s_vert,pgrid_e_vert-1<a name='1937'>
      pro_u_c(k+1) = cfld(i,k,j)<a name='1938'>
      enddo <a name='1939'>
      <a name='1940'>
      <font color=#447700>!KAL fill in the surface value and the top value using extrapolation<a name='1941'></font>
<a name='1942'>
      pro_u_c(1      ) = cf1_c*cfld(i,1,j) &amp;<a name='1943'>
                       + cf2_c*cfld(i,2,j) &amp;<a name='1944'>
                       + cf3_c*cfld(i,3,j)<a name='1945'>
   <a name='1946'>
      pro_u_c(pgrid_e_vert+1) = cfn_c *cfld(i,pgrid_e_vert-1,j) &amp;<a name='1947'>
                              + cfn1_c*cfld(i,pgrid_e_vert-2,j)  <a name='1948'>
		       <a name='1949'>
      call <A href='../../html_code/share/interp_fcn.F.html#INTER_WRF_COPY'>inter_wrf_copy</A><A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_WRF_COPY_1">(pro_u_c, alt_u_c, pgrid_e_vert+1, pro_u_n, alt_u_n, kde+1)<a name='1950'>
      <a name='1951'>
      do k = 1,kde-1<a name='1952'>
         cfld(i,k,j) = pro_u_n(k+1)<a name='1953'>
      enddo	<a name='1954'>
            <a name='1955'>
   ENDDO<a name='1956'>
   ENDDO<a name='1957'>
  <a name='1958'>
   <a name='1959'>
   END SUBROUTINE vert_interp_vert_nesting<a name='1960'>
   <a name='1961'>
 <font color=#447700>!==================================<a name='1962'></font>
<a name='1963'>
<A NAME='VERT_INTERP_VERT_NESTING_W'><A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1964'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>vert_interp_vert_nesting_w</font> ( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/VERT_INTERP_VERT_NESTING_W.html' TARGET='index'>1</A><a name='1965'></font>
                                           ids, ide, kds, kde, jds, jde,         &amp; <a name='1966'>
                                           ims, ime, kms, kme, jms, jme,         &amp;<a name='1967'>
                                           its, ite, kts, kte, jts, jte,         &amp;   <a name='1968'>
                                           pgrid_s_vert, pgrid_e_vert,           &amp;  <font color=#447700>! vertical dimensions of parent grid<a name='1969'></font>
                                           alt_w_c, alt_w_n)<a name='1970'>
<a name='1971'>
<font color=#447700>!KAL vertical interpolation at w points for vertical nesting<a name='1972'></font>
<a name='1973'>
   IMPLICIT NONE<a name='1974'>
   REAL, DIMENSION ( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) :: cfld   <a name='1975'>
   INTEGER, INTENT(IN) :: ids, ide, kds, kde, jds, jde,   &amp;<a name='1976'>
                          ims, ime, kms, kme, jms, jme,   &amp;<a name='1977'>
                          its, ite, kts, kte, jts, jte<a name='1978'>
   INTEGER, INTENT(IN) :: pgrid_s_vert, pgrid_e_vert                <font color=#447700>! vertical dimensions of the parent grid			  <a name='1979'></font>
   REAL, DIMENSION(pgrid_s_vert:pgrid_e_vert), INTENT(IN) :: alt_w_c<a name='1980'>
   REAL, DIMENSION(kde), INTENT(IN) :: alt_w_n<a name='1981'>
<a name='1982'>
   <a name='1983'>
   <font color=#447700>!local<a name='1984'></font>
   <a name='1985'>
   INTEGER :: i,j,k<a name='1986'>
   REAL, DIMENSION(pgrid_s_vert:pgrid_e_vert) :: pro_w_c           <font color=#447700>! variable in 1D on the coarse grid<a name='1987'></font>
   REAL, DIMENSION(kde) :: pro_w_n<a name='1988'>
   <a name='1989'>
   DO j = jms,jme<a name='1990'>
   DO i = ims,ime<a name='1991'>
   <a name='1992'>
      <font color=#447700>! pro_w_c is w on the 1D coarse grid <a name='1993'></font>
    <a name='1994'>
      do k = pgrid_s_vert,pgrid_e_vert<a name='1995'>
      pro_w_c(k) = cfld(i,k,j)<a name='1996'>
      enddo <a name='1997'>
	       <a name='1998'>
      call <A href='../../html_code/share/interp_fcn.F.html#INTER_WRF_COPY'>inter_wrf_copy</A><A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_WRF_COPY_2">(pro_w_c, alt_w_c, pgrid_e_vert, pro_w_n, alt_w_n, kde)<a name='1999'>
      <a name='2000'>
      do k = 1,kde<a name='2001'>
         cfld(i,k,j) = pro_w_n(k)<a name='2002'>
      enddo	<a name='2003'>
            <a name='2004'>
   ENDDO<a name='2005'>
   ENDDO<a name='2006'>
  <a name='2007'>
   <a name='2008'>
   END SUBROUTINE vert_interp_vert_nesting_w<a name='2009'>
<a name='2010'>
<font color=#447700>!-----------------------------------------------------------------------------------------   <a name='2011'></font>
<a name='2012'>
<A NAME='VERT_INTERP_VERT_NESTING_1D'><A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2013'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>vert_interp_vert_nesting_1d</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/VERT_INTERP_VERT_NESTING_1D.html' TARGET='index'>5</A>,<A href='../../call_from/VERT_INTERP_VERT_NESTING_1D.html' TARGET='index'>1</A><a name='2014'></font>
                                            ids, ide, kds, kde, jds, jde,         &amp; <a name='2015'>
                                            ims, ime, kms, kme, jms, jme,         &amp;<a name='2016'>
                                            its, ite, kts, kte, jts, jte,         &amp;   <a name='2017'>
                                            pgrid_s_vert, pgrid_e_vert,           &amp;  <font color=#447700>! vertical dimensions of parent grid<a name='2018'></font>
					    cf1_c, cf2_c, cf3_c, cfn_c, cfn1_c,   &amp;  <font color=#447700>! coarse grid extrapolation constants<a name='2019'></font>
                                            alt_u_c, alt_u_n)<a name='2020'>
<a name='2021'>
<font color=#447700>!KAL vertical interpolation for u, v, and mass points (w is below in a different subroutine) for vertical nesting <a name='2022'></font>
<a name='2023'>
   IMPLICIT NONE<a name='2024'>
   REAL, DIMENSION (kms:kme),INTENT(INOUT) :: cfld   <a name='2025'>
   INTEGER, INTENT(IN) :: ids, ide, kds, kde, jds, jde,   &amp;<a name='2026'>
                          ims, ime, kms, kme, jms, jme,   &amp;<a name='2027'>
                          its, ite, kts, kte, jts, jte<a name='2028'>
   INTEGER, INTENT(IN) :: pgrid_s_vert, pgrid_e_vert                <font color=#447700>! vertical dimensions of the parent grid			  <a name='2029'></font>
   REAL, INTENT(IN)    :: cf1_c, cf2_c, cf3_c, cfn_c, cfn1_c<a name='2030'>
   REAL, DIMENSION(pgrid_s_vert:pgrid_e_vert+1), INTENT(IN) :: alt_u_c<a name='2031'>
   REAL, DIMENSION(kde+1), INTENT(IN) :: alt_u_n<a name='2032'>
<a name='2033'>
   <a name='2034'>
   <font color=#447700>!local<a name='2035'></font>
   <a name='2036'>
   INTEGER :: i,j,k<a name='2037'>
   REAL, DIMENSION(pgrid_s_vert:pgrid_e_vert+1) :: pro_u_c           <font color=#447700>! variable in 1D on the coarse grid<a name='2038'></font>
   REAL, DIMENSION(kde+1) :: pro_u_n<a name='2039'>
   <a name='2040'>
<a name='2041'>
      <font color=#447700>! pro_u_c is u on the 1D coarse grid <a name='2042'></font>
    <a name='2043'>
      do k = pgrid_s_vert,pgrid_e_vert-1<a name='2044'>
      pro_u_c(k+1) = cfld(k)<a name='2045'>
      enddo <a name='2046'>
      <a name='2047'>
      <font color=#447700>!KAL fill in the surface value and the top value using extrapolation<a name='2048'></font>
<a name='2049'>
      pro_u_c(1      ) = cf1_c*cfld(1) &amp;<a name='2050'>
                       + cf2_c*cfld(2) &amp;<a name='2051'>
                       + cf3_c*cfld(3)<a name='2052'>
   <a name='2053'>
      pro_u_c(pgrid_e_vert+1) = cfn_c *cfld(pgrid_e_vert-1) &amp;<a name='2054'>
                              + cfn1_c*cfld(pgrid_e_vert-2)  <a name='2055'>
		       <a name='2056'>
      call <A href='../../html_code/share/interp_fcn.F.html#INTER_WRF_COPY'>inter_wrf_copy</A><A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_WRF_COPY_3">(pro_u_c, alt_u_c, pgrid_e_vert+1, pro_u_n, alt_u_n, kde+1)<a name='2057'>
      <a name='2058'>
      do k = 1,kde-1<a name='2059'>
         cfld(k) = pro_u_n(k+1)<a name='2060'>
      enddo	<a name='2061'>
            <a name='2062'>
   <a name='2063'>
   END SUBROUTINE vert_interp_vert_nesting_1d   <a name='2064'>
   <a name='2065'>
     <a name='2066'>
 <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2067'></font>
<font color=#447700>!KAL this is a direct copy of a subroutine from ndown, but a dependency on ndown will not work because it is not always compiled (for ideal cases), and most likely not compliled in the order needed.<a name='2068'></font>
<a name='2069'>
<A NAME='INTER_WRF_COPY'><A href='../../html_code/share/interp_fcn.F.html#INTER_WRF_COPY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2070'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>inter_wrf_copy</font>(pro_c,alt_c,kde_c,pro_n,alt_n,kde_n) <A href='../../call_to/INTER_WRF_COPY.html' TARGET='index'>3</A>,<A href='../../call_from/INTER_WRF_COPY.html' TARGET='index'>1</A><a name='2071'>
  <a name='2072'>
<font color=#447700>!KAL this routine has been added for vertical nesting  <a name='2073'></font>
<a name='2074'>
   IMPLICIT NONE<a name='2075'>
   INTEGER , INTENT(IN) :: kde_c,kde_n<a name='2076'>
   REAL , DIMENSION(kde_c) , INTENT(IN ) :: pro_c,alt_c<a name='2077'>
   REAL , DIMENSION(kde_n) , INTENT(IN ) :: alt_n<a name='2078'>
   REAL , DIMENSION(kde_n) , INTENT(OUT) :: pro_n<a name='2079'>
<a name='2080'>
      real ,dimension(kde_c) :: a,b,c,d<a name='2081'>
      real :: p<a name='2082'>
      integer :: i,j<a name='2083'>
<a name='2084'>
<a name='2085'>
      call <A href='../../html_code/share/interp_fcn.F.html#COEFF_MON_WRF_COPY'>coeff_mon_wrf_copy</A><A href='../../html_code/share/interp_fcn.F.html#INTER_WRF_COPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COEFF_MON_WRF_COPY_1">(alt_c,pro_c,a,b,c,d,kde_c)<a name='2086'>
<a name='2087'>
       do i = 1,kde_n-1<a name='2088'>
<a name='2089'>
          do j=1,kde_c-1<a name='2090'>
<a name='2091'>
               if ( (alt_n(i) .ge. alt_c(j)).and.(alt_n(i) .lt. alt_c(j+1)) ) then<a name='2092'>
                p =  alt_n(i)-alt_c(j)<a name='2093'>
                pro_n(i) = p*( p*(a(j)*p+b(j))+c(j)) + d(j)<a name='2094'>
                goto 20<a name='2095'>
               endif<a name='2096'>
           enddo<a name='2097'>
20             continue<a name='2098'>
       enddo<a name='2099'>
<a name='2100'>
       pro_n(kde_n) = pro_c(kde_c)<a name='2101'>
<a name='2102'>
<a name='2103'>
   END SUBROUTINE inter_wrf_copy<a name='2104'>
<a name='2105'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11<a name='2106'></font>
<font color=#447700>!KAL this is a direct copy of a subroutine from ndown, but a dependency on ndown will not work because it is not always compiled (for ideal cases), and most likely not compliled in the order needed.<a name='2107'></font>
<a name='2108'>
<A NAME='COEFF_MON_WRF_COPY'><A href='../../html_code/share/interp_fcn.F.html#COEFF_MON_WRF_COPY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2109'>
     <font color=#993300>subroutine  </font><font color=#cc0000>coeff_mon_wrf_copy</font>(x,y,a,b,c,d,n) <A href='../../call_to/COEFF_MON_WRF_COPY.html' TARGET='index'>1</A><a name='2110'>
     <a name='2111'>
<font color=#447700>!KAL this routine has been added for vertical nesting     <a name='2112'></font>
<a name='2113'>
      implicit none<a name='2114'>
<a name='2115'>
      integer :: n<a name='2116'>
      real ,dimension(n) :: x,y,a,b,c,d<a name='2117'>
      real ,dimension(n) :: h,s,p,yp<a name='2118'>
<a name='2119'>
       integer :: i<a name='2120'>
<a name='2121'>
<a name='2122'>
      do i=1,n-1<a name='2123'>
      h(i) = (x(i+1)-x(i))<a name='2124'>
      s(i) = (y(i+1)-y(i)) / h(i)<a name='2125'>
      enddo<a name='2126'>
<a name='2127'>
      do i=2,n-1<a name='2128'>
      p(i) = (s(i-1)*h(i)+s(i)*h(i-1)) / (h(i-1)+h(i))<a name='2129'>
      enddo<a name='2130'>
<a name='2131'>
      p(1) = s(1)<a name='2132'>
      p(n) = s(n-1)<a name='2133'>
<a name='2134'>
      do i=1,n<a name='2135'>
      yp(i) = p(i)<a name='2136'>
      enddo<a name='2137'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!<a name='2138'></font>
<a name='2139'>
      do i=2,n-1<a name='2140'>
      yp(i) = (sign(1.,s(i-1))+sign(1.,s(i)))* min( abs(s(i-1)),abs(s(i)),0.5*abs(p(i)))<a name='2141'>
      enddo<a name='2142'>
<a name='2143'>
      do i = 1,n-1<a name='2144'>
      a(i) = (yp(i)+yp(i+1)-2.*s(i))/(h(i)*h(i))<a name='2145'>
      b(i) = (3.*s(i)-2.*yp(i)-yp(i+1))/h(i)<a name='2146'>
      c(i) = yp(i)<a name='2147'>
      d(i) = y(i)<a name='2148'>
      enddo<a name='2149'>
<a name='2150'>
      end  subroutine  coeff_mon_wrf_copy<a name='2151'>
      <a name='2152'>
  <font color=#447700>!-----------------------------------------------------------------------------------------<a name='2153'></font>
  <a name='2154'>
<a name='2155'>
<font color=#447700>!================================== <a name='2156'></font>
<a name='2157'>
<A NAME='P2C'><A href='../../html_code/share/interp_fcn.F.html#P2C' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2158'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>p2c</font> ( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/P2C.html' TARGET='index'>36</A>,<A href='../../call_from/P2C.html' TARGET='index'>2</A><a name='2159'></font>
                    cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2160'>
                    cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2161'>
                    cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2162'>
                    nfld,                                 &amp;  <font color=#447700>! ND field<a name='2163'></font>
                    nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2164'>
                    nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2165'>
                    nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2166'>
                    shw,                                  &amp;  <font color=#447700>! stencil half width<a name='2167'></font>
                    imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2168'></font>
                    xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2169'></font>
                    ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2170'></font>
                    nri, nrj                              &amp;  <font color=#447700>! nest ratios<a name='2171'></font>
                    )   <a name='2172'>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#P2C' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_172"><a name='2173'>
     IMPLICIT NONE<a name='2174'>
<a name='2175'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2176'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2177'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2178'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2179'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2180'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2181'>
                            shw,                                  &amp;<a name='2182'>
                            ipos, jpos,                           &amp;<a name='2183'>
                            nri, nrj<a name='2184'>
<a name='2185'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='2186'>
<a name='2187'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='2188'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='2189'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='2190'>
<a name='2191'>
     CALL  <A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN'>interp_fcn</A><A href='../../html_code/share/interp_fcn.F.html#P2C' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_FCN_1">  (cfld,                             &amp;  <font color=#447700>! CD field<a name='2192'></font>
                        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2193'>
                        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2194'>
                        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2195'>
                        nfld,                             &amp;  <font color=#447700>! ND field<a name='2196'></font>
                        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2197'>
                        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2198'>
                        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2199'>
                        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='2200'></font>
                        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2201'></font>
                        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2202'></font>
                        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2203'></font>
                        nri, nrj                             )   <font color=#447700>! nest ratios<a name='2204'></font>
<a name='2205'>
   END SUBROUTINE p2c<a name='2206'>
<a name='2207'>
<font color=#447700>!==================================<a name='2208'></font>
<a name='2209'>
<A NAME='C2F_INTERP'><A href='../../html_code/share/interp_fcn.F.html#C2F_INTERP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2210'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>c2f_interp</font> ( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/C2F_INTERP.html' TARGET='index'>1</A><a name='2211'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2212'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2213'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2214'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2215'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2216'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;  <a name='2217'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2218'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='2219'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2220'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2221'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2222'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='2223'></font>
<font color=#447700>!                          cbdy_xs, nbdy_xs,                           &amp;<a name='2224'></font>
<font color=#447700>!                          cbdy_xe, nbdy_xe,                           &amp;<a name='2225'></font>
<font color=#447700>!                          cbdy_ys, nbdy_ys,                           &amp;<a name='2226'></font>
<font color=#447700>!                          cbdy_ye, nbdy_ye,                           &amp;<a name='2227'></font>
<font color=#447700>!                          cbdy_txs, nbdy_txs,                       &amp;<a name='2228'></font>
<font color=#447700>!                          cbdy_txe, nbdy_txe,                       &amp;<a name='2229'></font>
<font color=#447700>!                          cbdy_tys, nbdy_tys,                       &amp;<a name='2230'></font>
<font color=#447700>!                          cbdy_tye, nbdy_tye,                       &amp;<a name='2231'></font>
                           parent_id,nest_id                        &amp;<font color=#447700>!cyl    <a name='2232'></font>
                           )   <font color=#447700>! boundary arrays<a name='2233'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#C2F_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_173"><a name='2234'>
     IMPLICIT NONE<a name='2235'>
<a name='2236'>
<font color=#447700>!------------------------------------------------------------<a name='2237'></font>
<font color=#447700>! Subroutine c2f_interp interpolate field from coarse resolution domain<a name='2238'></font>
<font color=#447700>! to its nested domain. It is written by Dave Gill in NCAR for the purpose <a name='2239'></font>
<font color=#447700>! running phys/module_sf_oml.F-DPWP in only d01 and d02 <a name='2240'></font>
<font color=#447700>!                                       Chiaying Lee RSMAS/UM<a name='2241'></font>
<font color=#447700>!------------------------------------------------------------<a name='2242'></font>
                            <a name='2243'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2244'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2245'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2246'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2247'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2248'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2249'>
                            shw,                                  &amp;<a name='2250'>
                            ipos, jpos,                           &amp;<a name='2251'>
                            nri, nrj,parent_id,nest_id            <font color=#447700>!cyl<a name='2252'></font>
<a name='2253'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='2254'>
     <a name='2255'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='2256'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='2257'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='2258'>
<font color=#447700>!    REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy_xs, cbdy_txs, nbdy_xs, nbdy_txs<a name='2259'></font>
<font color=#447700>!    REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy_xe, cbdy_txe, nbdy_xe, nbdy_txe<a name='2260'></font>
<font color=#447700>!    REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy_ys, cbdy_tys, nbdy_ys, nbdy_tys<a name='2261'></font>
<font color=#447700>!    REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy_ye, cbdy_tye, nbdy_ye, nbdy_tye<a name='2262'></font>
     REAL cdt, ndt<a name='2263'>
     <a name='2264'>
     <font color=#447700>! Local<a name='2265'></font>
<a name='2266'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='2267'>
<a name='2268'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='2269'></font>
     <font color=#447700>! from the CD tile. <a name='2270'></font>
<a name='2271'>
<font color=#447700>!write(0,'("mask cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte, cjts,cjte<a name='2272'></font>
<font color=#447700>!write(0,'("mask nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte, njts,njte<a name='2273'></font>
<font color=#447700>!     write(0,*)'cyl parentid',parent_id<a name='2274'></font>
<font color=#447700>!     write(0,*)'cyl nestid',nest_id<a name='2275'></font>
<font color=#447700>!     If ( nest_id .le. 2 .and. (1.0/rdx .ge. 3000.0 .and. 1.0/rdy .ge. 3000.0)  ) then ! cyl: only run it in the nest domain with dx, dy &lt; 3 km<a name='2276'></font>
     If ( nest_id .eq. 3 ) then <a name='2277'>
     DO nj = njts, njte<a name='2278'>
     <a name='2279'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='2280'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='2281'></font>
        DO nk = nkts, nkte<a name='2282'>
           ck = nk<a name='2283'>
           DO ni = nits, nite<a name='2284'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='2285'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='2286'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='2287'></font>
              <font color=#447700>! the values from the CD into the ND<a name='2288'></font>
              nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='2289'>
           ENDDO<a name='2290'>
        ENDDO<a name='2291'>
     ENDDO<a name='2292'>
     ENDIF  <font color=#447700>! cyl<a name='2293'></font>
     RETURN<a name='2294'>
<a name='2295'>
   END SUBROUTINE c2f_interp<a name='2296'>
<a name='2297'>
<font color=#447700>!==================================<a name='2298'></font>
<a name='2299'>
<A NAME='BDY_INTERP'><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2300'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>bdy_interp</font> ( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/BDY_INTERP.html' TARGET='index'>4</A><a name='2301'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2302'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2303'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2304'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2305'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2306'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2307'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2308'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='2309'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2310'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2311'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2312'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='2313'></font>
                           cbdy_xs, nbdy_xs,                     &amp;  <font color=#447700>! Boundary components, for the CG and FG,<a name='2314'></font>
                           cbdy_xe, nbdy_xe,                     &amp;  <font color=#447700>! for each of the four sides (x start, e end, y start, y end)<a name='2315'></font>
                           cbdy_ys, nbdy_ys,                     &amp;  <font color=#447700>! and also for the two components of the LBC:<a name='2316'></font>
                           cbdy_ye, nbdy_ye,                     &amp;  <font color=#447700>! the "starting" value and the tendency<a name='2317'></font>
                           cbdy_txs, nbdy_txs,                   &amp;<a name='2318'>
                           cbdy_txe, nbdy_txe,                   &amp;  <font color=#447700>! The CG is at a parent time step ahead of the FG<a name='2319'></font>
                           cbdy_tys, nbdy_tys,                   &amp;<a name='2320'>
                           cbdy_tye, nbdy_tye,                   &amp;<a name='2321'>
                           cdt, ndt                              )  <font color=#447700>! Time step size for CG and FG<a name='2322'></font>
<a name='2323'>
     USE <A href='../../html_code/share/interp_fcn.F.html#MODULE_INTERP_INFO'>module_interp_info</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_INFO_3"><a name='2324'>
<a name='2325'>
     IMPLICIT NONE<a name='2326'>
<a name='2327'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2328'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2329'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2330'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2331'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2332'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2333'>
                            shw,                                  &amp;<a name='2334'>
                            ipos, jpos,                           &amp;<a name='2335'>
                            nri, nrj<a name='2336'>
<a name='2337'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='2338'>
<a name='2339'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='2340'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='2341'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='2342'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy_xs, cbdy_txs, nbdy_xs, nbdy_txs<a name='2343'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy_xe, cbdy_txe, nbdy_xe, nbdy_txe<a name='2344'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy_ys, cbdy_tys, nbdy_ys, nbdy_tys<a name='2345'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: cbdy_ye, cbdy_tye, nbdy_ye, nbdy_tye<a name='2346'>
     REAL cdt, ndt<a name='2347'>
<a name='2348'>
     <font color=#447700>! Local<a name='2349'></font>
<a name='2350'>
     INTEGER nijds, nijde, spec_bdy_width<a name='2351'>
<a name='2352'>
     nijds = min(nids, njds)<a name='2353'>
     nijde = max(nide, njde)<a name='2354'>
     CALL nl_get_spec_bdy_width( 1, spec_bdy_width )<a name='2355'>
<a name='2356'>
     IF      ( interp_method_type .EQ. NOT_DEFINED_YET  ) THEN<a name='2357'>
        interp_method_type = SINT<a name='2358'>
     END IF<a name='2359'>
<a name='2360'>
     IF      ( interp_method_type .EQ. SINT      ) THEN<a name='2361'>
         CALL <A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1'>bdy_interp1</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BDY_INTERP1_1">( cfld,                                 &amp;  <font color=#447700>! CD field<a name='2362'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2363'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2364'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2365'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2366'></font>
                           nijds, nijde ,                        &amp;  <font color=#447700>! start and end of nest LBC size in the LONG direction<a name='2367'></font>
                           spec_bdy_width ,                      &amp;  <font color=#447700>! width of the LBC, the SHORT direction<a name='2368'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2369'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2370'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2371'>
                           shw, imask,                           &amp;<a name='2372'>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2373'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2374'></font>
                           nri, nrj,                             &amp;<a name='2375'>
                           cbdy_xs, nbdy_xs,                     &amp;  <font color=#447700>! Boundary components, for the CG and FG,<a name='2376'></font>
                           cbdy_xe, nbdy_xe,                     &amp;  <font color=#447700>! for each of the four sides (x start, e end, y start, y end)<a name='2377'></font>
                           cbdy_ys, nbdy_ys,                     &amp;  <font color=#447700>! and also for the two components of the LBC:<a name='2378'></font>
                           cbdy_ye, nbdy_ye,                     &amp;  <font color=#447700>! the "starting" value and the tendency<a name='2379'></font>
                           cbdy_txs, nbdy_txs,                   &amp;<a name='2380'>
                           cbdy_txe, nbdy_txe,                   &amp;  <font color=#447700>! The CG is at a parent time step ahead of the FG<a name='2381'></font>
                           cbdy_tys, nbdy_tys,                   &amp;<a name='2382'>
                           cbdy_tye, nbdy_tye,                   &amp;<a name='2383'>
                           cdt, ndt                              &amp;  <font color=#447700>! Time step size for CG and FG<a name='2384'></font>
                                                                 )<a name='2385'>
<a name='2386'>
     ELSE IF      ( ( interp_method_type .EQ. BILINEAR         ) .OR. &amp;<a name='2387'>
                    ( interp_method_type .EQ. NEAREST_NEIGHBOR ) .OR. &amp;<a name='2388'>
                    ( interp_method_type .EQ. QUADRATIC        ) .OR. &amp;<a name='2389'>
                    ( interp_method_type .EQ. SPLINE           ) .OR. &amp;<a name='2390'>
                    ( interp_method_type .EQ. SINT_NEW         ) ) THEN <a name='2391'>
         CALL <A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP2'>bdy_interp2</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BDY_INTERP2_1">( cfld,                                 &amp;  <font color=#447700>! CD field<a name='2392'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2393'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2394'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2395'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2396'></font>
                           nijds, nijde ,                        &amp;  <font color=#447700>! start and end of nest LBC size in the LONG direction<a name='2397'></font>
                           spec_bdy_width ,                      &amp;  <font color=#447700>! width of the LBC, the SHORT direction<a name='2398'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2399'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2400'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2401'>
                           shw, imask,                           &amp;<a name='2402'>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2403'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2404'></font>
                           nri, nrj,                             &amp;<a name='2405'>
                           cbdy_xs, nbdy_xs,                     &amp;  <font color=#447700>! Boundary components, for the CG and FG,<a name='2406'></font>
                           cbdy_xe, nbdy_xe,                     &amp;  <font color=#447700>! for each of the four sides (x start, e end, y start, y end)<a name='2407'></font>
                           cbdy_ys, nbdy_ys,                     &amp;  <font color=#447700>! and also for the two components of the LBC:<a name='2408'></font>
                           cbdy_ye, nbdy_ye,                     &amp;  <font color=#447700>! the "starting" value and the tendency<a name='2409'></font>
                           cbdy_txs, nbdy_txs,                   &amp;<a name='2410'>
                           cbdy_txe, nbdy_txe,                   &amp;  <font color=#447700>! The CG is at a parent time step ahead of the FG<a name='2411'></font>
                           cbdy_tys, nbdy_tys,                   &amp;<a name='2412'>
                           cbdy_tye, nbdy_tye,                   &amp;<a name='2413'>
                           cdt, ndt                              &amp;  <font color=#447700>! Time step size for CG and FG<a name='2414'></font>
                                                                 )<a name='2415'>
<a name='2416'>
     ELSE<a name='2417'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1316"> ('Hold on there cowboy #2, we need to know which nested lateral boundary interpolation option you want')<a name='2418'>
     END IF<a name='2419'>
<a name='2420'>
   END SUBROUTINE bdy_interp<a name='2421'>
<a name='2422'>
<font color=#447700>!==================================<a name='2423'></font>
<a name='2424'>
<A NAME='BDY_INTERP1'><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2425'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>bdy_interp1</font>( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/BDY_INTERP1.html' TARGET='index'>1</A>,<A href='../../call_from/BDY_INTERP1.html' TARGET='index'>5</A><a name='2426'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2427'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2428'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2429'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2430'></font>
                           nijds, nijde, spec_bdy_width ,          &amp;<a name='2431'>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2432'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2433'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2434'>
                           shw1,                                 &amp;<a name='2435'>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2436'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2437'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2438'></font>
                           nri, nrj,                             &amp;<a name='2439'>
                           cbdy_xs, bdy_xs,                           &amp;<a name='2440'>
                           cbdy_xe, bdy_xe,                           &amp;<a name='2441'>
                           cbdy_ys, bdy_ys,                           &amp;<a name='2442'>
                           cbdy_ye, bdy_ye,                           &amp;<a name='2443'>
                           cbdy_txs, bdy_txs,                       &amp;<a name='2444'>
                           cbdy_txe, bdy_txe,                       &amp;<a name='2445'>
                           cbdy_tys, bdy_tys,                       &amp;<a name='2446'>
                           cbdy_tye, bdy_tye,                       &amp;<a name='2447'>
                           cdt, ndt                              &amp;<a name='2448'>
                                        )<a name='2449'>
<a name='2450'>
<font color=#447700>!    USE module_configure , ONLY : nl_get_spec_zone, nl_get_relax_zone<a name='2451'></font>
     USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_178"><a name='2452'>
<a name='2453'>
     IMPLICIT NONE<a name='2454'>
<a name='2455'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2456'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2457'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2458'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2459'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2460'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2461'>
                            shw1,                                 &amp;  <font color=#447700>! ignore<a name='2462'></font>
                            ipos, jpos,                           &amp;<a name='2463'>
                            nri, nrj<a name='2464'>
     INTEGER, INTENT(IN) :: nijds, nijde, spec_bdy_width<a name='2465'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='2466'>
<a name='2467'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(INOUT) :: cfld<a name='2468'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(INOUT) :: nfld<a name='2469'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='2470'>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy_xs, cbdy_txs   <font color=#447700>! not used<a name='2471'></font>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy_xe, cbdy_txe   <font color=#447700>! not used<a name='2472'></font>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy_ys, cbdy_tys   <font color=#447700>! not used<a name='2473'></font>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy_ye, cbdy_tye   <font color=#447700>! not used<a name='2474'></font>
     REAL                                 :: cdt, ndt<a name='2475'>
     REAL, DIMENSION ( njms:njme, nkms:nkme, spec_bdy_width ), INTENT(INOUT) :: bdy_xs, bdy_txs<a name='2476'>
     REAL, DIMENSION ( njms:njme, nkms:nkme, spec_bdy_width ), INTENT(INOUT) :: bdy_xe, bdy_txe<a name='2477'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, spec_bdy_width ), INTENT(INOUT) :: bdy_ys, bdy_tys<a name='2478'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, spec_bdy_width ), INTENT(INOUT) :: bdy_ye, bdy_tye<a name='2479'>
<a name='2480'>
     <font color=#447700>! Local<a name='2481'></font>
<a name='2482'>
     REAL*8 rdt<a name='2483'>
     INTEGER ci, cj, ck, ni, nj, nk, ni1, nj1, nk1, ip, jp, ioff, joff<a name='2484'>
     INTEGER nfx, ior<a name='2485'>
     PARAMETER (ior=2)<a name='2486'>
     INTEGER nf<a name='2487'>
     REAL psca1(cims:cime,cjms:cjme,nri*nrj)<a name='2488'>
     REAL psca(cims:cime,cjms:cjme,nri*nrj)<a name='2489'>
     LOGICAL icmask( cims:cime, cjms:cjme )<a name='2490'>
     INTEGER i,j,k<a name='2491'>
     INTEGER shw<a name='2492'>
     INTEGER spec_zone <a name='2493'>
     INTEGER relax_zone<a name='2494'>
     INTEGER sz<a name='2495'>
     INTEGER n2ci,n<a name='2496'>
     INTEGER n2cj<a name='2497'>
<a name='2498'>
<font color=#447700>! statement functions for converting a nest index to coarse<a name='2499'></font>
     n2ci(n) = (n+ipos*nri-1)/nri<a name='2500'>
     n2cj(n) = (n+jpos*nrj-1)/nrj<a name='2501'>
<a name='2502'>
     rdt = 1.D0/cdt<a name='2503'>
<a name='2504'>
     shw = 0<a name='2505'>
<a name='2506'>
     ioff  = 0 ; joff  = 0<a name='2507'>
     IF ( xstag ) THEN <a name='2508'>
       ioff = MAX((nri-1)/2,1)<a name='2509'>
     ENDIF<a name='2510'>
     IF ( ystag ) THEN<a name='2511'>
       joff = MAX((nrj-1)/2,1)<a name='2512'>
     ENDIF<a name='2513'>
<a name='2514'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='2515'></font>
     <font color=#447700>! from the CD tile. <a name='2516'></font>
<a name='2517'>
     CALL nl_get_spec_zone( 1, spec_zone )<a name='2518'>
     CALL nl_get_relax_zone( 1, relax_zone )<a name='2519'>
     sz = MIN(MAX( spec_zone, relax_zone + 1 ),spec_bdy_width)<a name='2520'>
<a name='2521'>
     nfx = nri * nrj<a name='2522'>
<a name='2523'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2524'></font>
   <font color=#447700>!$OMP PRIVATE ( i,j,k,ni,nj,ni1,nj1,ci,cj,ip,jp,nk,ck,nf,icmask,psca,psca1 )<a name='2525'></font>
     DO k = ckts, ckte<a name='2526'>
<a name='2527'>
        DO nf = 1,nfx<a name='2528'>
           DO j = cjms,cjme<a name='2529'>
              nj = (j-jpos) * nrj + ( nrj / 2 + 1 )  <font color=#447700>! j point on nest<a name='2530'></font>
              DO i = cims,cime<a name='2531'>
                ni = (i-ipos) * nri + ( nri / 2 + 1 )   <font color=#447700>! i point on nest<a name='2532'></font>
                psca1(i,j,nf) = cfld(i,k,j)<a name='2533'>
              ENDDO<a name='2534'>
           ENDDO<a name='2535'>
        ENDDO<a name='2536'>
<font color=#447700>! hopefully less ham handed but still correct and more efficient<a name='2537'></font>
<font color=#447700>! sintb ignores icmask so it does not matter that icmask is not set<a name='2538'></font>
<font color=#447700>!<a name='2539'></font>
<font color=#447700>! SOUTH BDY<a name='2540'></font>
               IF   ( njts .ge. njds .and. njts .le. njds + sz + joff  ) THEN<a name='2541'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_1">( psca1, psca,                     &amp;<a name='2542'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='2543'>
          n2ci(nits)-1, n2ci(nite)+1, n2cj(MAX(njts,njds)), n2cj(MIN(njte,njds+sz+joff)), nrj*nri, xstag, ystag )<a name='2544'>
               ENDIF<a name='2545'>
<font color=#447700>! NORTH BDY<a name='2546'></font>
               IF   ( njte .le. njde .and. njte .ge. njde - sz - joff ) THEN<a name='2547'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_2">( psca1, psca,                     &amp;<a name='2548'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='2549'>
          n2ci(nits)-1, n2ci(nite)+1, n2cj(MAX(njts,njde-sz-joff)), n2cj(MIN(njte,njde-1+joff)), nrj*nri, xstag, ystag )<a name='2550'>
               ENDIF<a name='2551'>
<font color=#447700>! WEST BDY<a name='2552'></font>
               IF   ( nits .ge. nids .and. nits .le. nids + sz + ioff  ) THEN<a name='2553'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_3">( psca1, psca,                     &amp;<a name='2554'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='2555'>
          n2ci(MAX(nits,nids)), n2ci(MIN(nite,nids+sz+ioff)), n2cj(njts)-1, n2cj(njte)+1, nrj*nri, xstag, ystag )<a name='2556'>
               ENDIF<a name='2557'>
<font color=#447700>! EAST BDY<a name='2558'></font>
               IF   ( nite .le. nide .and. nite .ge. nide - sz - ioff ) THEN<a name='2559'>
        CALL <A href='../../html_code/share/sint.F.html#SINTB'>sintb</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SINTB_4">( psca1, psca,                     &amp;<a name='2560'>
          cims, cime, cjms, cjme, icmask,  &amp;<a name='2561'>
          n2ci(MAX(nits,nide-sz-ioff)), n2ci(MIN(nite,nide-1+ioff)), n2cj(njts)-1, n2cj(njte)+1, nrj*nri, xstag, ystag )<a name='2562'>
               ENDIF<a name='2563'>
<a name='2564'>
        DO nj1 = MAX(njds,njts-1), MIN(njde+joff,njte+joff+1) <a name='2565'>
           cj = jpos + (nj1-1) / nrj     <font color=#447700>! j coord of CD point <a name='2566'></font>
           jp = mod ( nj1-1 , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='2567'></font>
           nk = k<a name='2568'>
           ck = nk<a name='2569'>
           DO ni1 = MAX(nids,nits-1), MIN(nide+ioff,nite+ioff+1)<a name='2570'>
               ci = ipos + (ni1-1) / nri      <font color=#447700>! j coord of CD point <a name='2571'></font>
               ip = mod ( ni1-1 , nri )  <font color=#447700>! coord of ND w/i CD point<a name='2572'></font>
<a name='2573'>
               ni = ni1-ioff<a name='2574'>
               nj = nj1-joff<a name='2575'>
<a name='2576'>
               IF ( ( ni.LT.nids) .OR. (nj.LT.njds) ) THEN<a name='2577'>
                  CYCLE<a name='2578'>
               END IF<a name='2579'>
<a name='2580'>
<font color=#447700>!bdy contains the value at t-dt. psca contains the value at t<a name='2581'></font>
<font color=#447700>!compute dv/dt and store in bdy_t<a name='2582'></font>
<font color=#447700>!afterwards store the new value of v at t into bdy<a name='2583'></font>
        <font color=#447700>! WEST<a name='2584'></font>
               IF   ( ni .ge. nids .and. ni .lt. nids + sz ) THEN<a name='2585'>
                 bdy_txs( nj,k,ni ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='2586'>
                 bdy_xs( nj,k,ni ) = nfld(ni,k,nj)<a name='2587'>
               ENDIF<a name='2588'>
<a name='2589'>
        <font color=#447700>! SOUTH<a name='2590'></font>
               IF   ( nj .ge. njds .and. nj .lt. njds + sz ) THEN<a name='2591'>
                 bdy_tys( ni,k,nj ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='2592'>
                 bdy_ys( ni,k,nj ) = nfld(ni,k,nj)<a name='2593'>
               ENDIF<a name='2594'>
<a name='2595'>
        <font color=#447700>! EAST<a name='2596'></font>
               IF ( xstag ) THEN<a name='2597'>
                 IF   ( ni .ge. nide - sz + 1 .AND. ni .le. nide ) THEN<a name='2598'>
                   bdy_txe( nj,k,nide-ni+1 ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='2599'>
                   bdy_xe( nj,k,nide-ni+1 ) = nfld(ni,k,nj)<a name='2600'>
                 ENDIF<a name='2601'>
               ELSE<a name='2602'>
                 IF   ( ni .ge. nide - sz .AND. ni .le. nide-1 ) THEN<a name='2603'>
                   bdy_txe( nj,k,nide-ni ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='2604'>
                   bdy_xe( nj,k,nide-ni ) = nfld(ni,k,nj)<a name='2605'>
                 ENDIF<a name='2606'>
               ENDIF<a name='2607'>
<a name='2608'>
        <font color=#447700>! NORTH<a name='2609'></font>
               IF ( ystag ) THEN<a name='2610'>
                 IF   ( nj .ge. njde - sz + 1 .AND. nj .le. njde  ) THEN<a name='2611'>
                   bdy_tye( ni,k,njde-nj+1 ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='2612'>
                   bdy_ye( ni,k,njde-nj+1 ) = nfld(ni,k,nj)<a name='2613'>
                 ENDIF<a name='2614'>
               ELSE<a name='2615'>
                 IF   (  nj .ge. njde - sz .AND. nj .le. njde-1 ) THEN<a name='2616'>
                   bdy_tye(ni,k,njde-nj ) = rdt*(psca(ci+shw,cj+shw,ip+1+(jp)*nri)-nfld(ni,k,nj))<a name='2617'>
                   bdy_ye( ni,k,njde-nj ) = nfld(ni,k,nj)<a name='2618'>
                 ENDIF<a name='2619'>
               ENDIF<a name='2620'>
<a name='2621'>
           ENDDO<a name='2622'>
        ENDDO<a name='2623'>
     ENDDO<a name='2624'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2625'></font>
                  <a name='2626'>
     RETURN<a name='2627'>
<a name='2628'>
   END SUBROUTINE bdy_interp1<a name='2629'>
<a name='2630'>
<font color=#447700>!==================================<a name='2631'></font>
<a name='2632'>
<A NAME='BDY_INTERP2'><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2633'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>bdy_interp2</font>( cfld,                                 &amp;  <font color=#447700>! CD field <A href='../../call_to/BDY_INTERP2.html' TARGET='index'>1</A>,<A href='../../call_from/BDY_INTERP2.html' TARGET='index'>2</A><a name='2634'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2635'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2636'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2637'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2638'></font>
                           nijds, nijde, spec_bdy_width ,        &amp;<a name='2639'>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2640'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2641'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2642'>
                           shw1,                                 &amp;<a name='2643'>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2644'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2645'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2646'></font>
                           nri, nrj,                             &amp;<a name='2647'>
                           cbdy_xs, bdy_xs,                      &amp;<a name='2648'>
                           cbdy_xe, bdy_xe,                      &amp;<a name='2649'>
                           cbdy_ys, bdy_ys,                      &amp;<a name='2650'>
                           cbdy_ye, bdy_ye,                      &amp;<a name='2651'>
                           cbdy_txs, bdy_txs,                    &amp;<a name='2652'>
                           cbdy_txe, bdy_txe,                    &amp;<a name='2653'>
                           cbdy_tys, bdy_tys,                    &amp;<a name='2654'>
                           cbdy_tye, bdy_tye,                    &amp;<a name='2655'>
                           cdt, ndt                              &amp;<a name='2656'>
                                                                 )<a name='2657'>
<a name='2658'>
<font color=#447700>!    USE module_configure , ONLY : nl_get_spec_zone, nl_get_relax_zone<a name='2659'></font>
<font color=#447700>!    USE module_state_description<a name='2660'></font>
     USE <A href='../../html_code/share/interp_fcn.F.html#MODULE_INTERP_INFO'>module_interp_info</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_INFO_4"><a name='2661'>
<a name='2662'>
     IMPLICIT NONE<a name='2663'>
<a name='2664'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2665'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2666'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2667'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2668'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2669'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2670'>
                            shw1,                                 &amp;  <font color=#447700>! ignore<a name='2671'></font>
                            ipos, jpos,                           &amp;<a name='2672'>
                            nri, nrj<a name='2673'>
     INTEGER, INTENT(IN) :: nijds, nijde, spec_bdy_width<a name='2674'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='2675'>
<a name='2676'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(INOUT) :: cfld<a name='2677'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(INOUT) :: nfld<a name='2678'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='2679'>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy_xs, cbdy_txs   <font color=#447700>! not used<a name='2680'></font>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy_xe, cbdy_txe   <font color=#447700>! not used<a name='2681'></font>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy_ys, cbdy_tys   <font color=#447700>! not used<a name='2682'></font>
     REAL, DIMENSION ( * ), INTENT(INOUT) :: cbdy_ye, cbdy_tye   <font color=#447700>! not used<a name='2683'></font>
     REAL                                 :: cdt, ndt<a name='2684'>
     REAL, DIMENSION ( njms:njme, nkms:nkme, spec_bdy_width ), INTENT(INOUT) :: bdy_xs, bdy_txs<a name='2685'>
     REAL, DIMENSION ( njms:njme, nkms:nkme, spec_bdy_width ), INTENT(INOUT) :: bdy_xe, bdy_txe<a name='2686'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, spec_bdy_width ), INTENT(INOUT) :: bdy_ys, bdy_tys<a name='2687'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, spec_bdy_width ), INTENT(INOUT) :: bdy_ye, bdy_tye<a name='2688'>
<a name='2689'>
     <font color=#447700>! Local<a name='2690'></font>
<a name='2691'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld_horiz_interp <font color=#447700>! mem dimensioned on purpose<a name='2692'></font>
                                                                              <font color=#447700>! to allow interpolating routine<a name='2693'></font>
                                                                              <font color=#447700>! to assume this is a mem<a name='2694'></font>
                                                                              <font color=#447700>! sized array<a name='2695'></font>
     INTEGER ni, nj, nk, istag, jstag<a name='2696'>
     INTEGER shw<a name='2697'>
     INTEGER spec_zone <a name='2698'>
     INTEGER relax_zone<a name='2699'>
     INTEGER sz<a name='2700'>
     REAL*8 rdt<a name='2701'>
<a name='2702'>
     shw = 0  <font color=#447700>! dummy, not used, but needed for the calling interface<a name='2703'></font>
<a name='2704'>
     <font color=#447700>!  Horizontally interpolate the CG to the FG, store in nfld_horiz_interp<a name='2705'></font>
<a name='2706'>
     CALL <A href='../../html_code/share/module_interp_fcn.F.html#INTERP_FCN'>interp_fcn</A><A href='../../html_code/share/interp_fcn.F.html#BDY_INTERP2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_FCN_2"> ( cfld,                                 &amp;  <font color=#447700>! CD field<a name='2707'></font>
                       cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2708'>
                       cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2709'>
                       cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2710'>
                       nfld_horiz_interp,                    &amp;  <font color=#447700>! ND field<a name='2711'></font>
                       nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2712'>
                       nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2713'>
                       MAX(nits-nri,nids),MIN(nite+nri,nide),&amp;<a name='2714'>
                       nkts, nkte,                           &amp;<a name='2715'>
                       MAX(njts-nrj,njds),MIN(njte+nrj,njde),&amp;<a name='2716'>
                       shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='2717'></font>
                       imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2718'></font>
                       xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2719'></font>
                       ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2720'></font>
<font color=#447700>!                      ipos-1, jpos-1,                       &amp;  ! Position of lower left of nest in CD<a name='2721'></font>
                       nri, nrj                              )  <font color=#447700>! Nest ratio, i- and j-directions<a name='2722'></font>
<a name='2723'>
     <font color=#447700>!  Staggering, to determine loop indexes<a name='2724'></font>
<a name='2725'>
     IF ( xstag ) THEN <a name='2726'>
        istag = 0<a name='2727'>
     ELSE<a name='2728'>
        istag = 1<a name='2729'>
     END IF<a name='2730'>
     IF ( ystag ) THEN<a name='2731'>
        jstag = 0<a name='2732'>
     ELSE <a name='2733'>
        jstag = 1<a name='2734'>
     END IF<a name='2735'>
<a name='2736'>
     <font color=#447700>!  CG time step reciprocal, for computing tendencies.<a name='2737'></font>
<a name='2738'>
     rdt = 1.D0/cdt<a name='2739'>
<a name='2740'>
     CALL nl_get_spec_zone( 1, spec_zone )<a name='2741'>
     CALL nl_get_relax_zone( 1, relax_zone )<a name='2742'>
<a name='2743'>
     <font color=#447700>!  Belt and suspenders ... sz is just spec_bdy_width.<a name='2744'></font>
<a name='2745'>
     sz = MIN(MAX( spec_zone, relax_zone + 1 ),spec_bdy_width)<a name='2746'>
<a name='2747'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2748'></font>
   <font color=#447700>!$OMP PRIVATE ( ni,nj,nk )<a name='2749'></font>
     <a name='2750'>
     DO nj = MAX ( njts-nrj, njds ) , MIN ( njte+nrj, njde-jstag )<a name='2751'>
        DO nk = nkts, nkte<a name='2752'>
           DO ni = MAX( nits-nri, nids ) , MIN ( nite+nri, nide-istag )<a name='2753'>
<a name='2754'>
              <font color=#447700>!  WEST boundary<a name='2755'></font>
<a name='2756'>
              IF ( ni .LT. nids + sz ) THEN<a name='2757'>
                  bdy_txs(nj,nk,ni) = rdt*(nfld_horiz_interp(ni,nk,nj)-nfld(ni,nk,nj))<a name='2758'>
                  bdy_xs (nj,nk,ni) =      nfld(ni,nk,nj)<a name='2759'>
              END IF<a name='2760'>
<a name='2761'>
               <font color=#447700>!  SOUTH boundary<a name='2762'></font>
<a name='2763'>
               IF ( nj .LT. njds + sz ) THEN<a name='2764'>
                  bdy_tys(ni,nk,nj) = rdt*(nfld_horiz_interp(ni,nk,nj)-nfld(ni,nk,nj))<a name='2765'>
                  bdy_ys (ni,nk,nj) =      nfld(ni,nk,nj)<a name='2766'>
               END IF<a name='2767'>
<a name='2768'>
               <font color=#447700>!  EAST boundary<a name='2769'></font>
<a name='2770'>
               IF ( xstag ) THEN<a name='2771'>
                  IF ( ( ni .GE. nide - sz + 1 ) .AND. ( ni .LE. nide ) ) THEN<a name='2772'>
                     bdy_txe(nj,nk,nide-ni+1) = rdt*(nfld_horiz_interp(ni,nk,nj)-nfld(ni,nk,nj))<a name='2773'>
                     bdy_xe (nj,nk,nide-ni+1) =      nfld(ni,nk,nj)<a name='2774'>
                  END IF<a name='2775'>
               ELSE<a name='2776'>
                  IF ( ( ni .GE. nide - sz ) .AND. ( ni .LE. nide-1 ) ) THEN<a name='2777'>
                     bdy_txe(nj,nk,nide-ni  ) = rdt*(nfld_horiz_interp(ni,nk,nj)-nfld(ni,nk,nj))<a name='2778'>
                     bdy_xe (nj,nk,nide-ni  ) =      nfld(ni,nk,nj)<a name='2779'>
                  END IF<a name='2780'>
               END IF<a name='2781'>
<a name='2782'>
               <font color=#447700>!  NORTH boundary<a name='2783'></font>
<a name='2784'>
               IF ( ystag ) THEN<a name='2785'>
                  IF ( ( nj .GE. njde - sz + 1 ) .AND. ( nj .LE. njde  ) ) THEN<a name='2786'>
                     bdy_tye(ni,nk,njde-nj+1) = rdt*(nfld_horiz_interp(ni,nk,nj)-nfld(ni,nk,nj))<a name='2787'>
                     bdy_ye (ni,nk,njde-nj+1) =      nfld(ni,nk,nj)<a name='2788'>
                  END IF<a name='2789'>
               ELSE<a name='2790'>
                  IF ( (  nj .GE. njde - sz ) .AND. ( nj .LE. njde-1 ) ) THEN<a name='2791'>
                     bdy_tye(ni,nk,njde-nj  ) = rdt*(nfld_horiz_interp(ni,nk,nj)-nfld(ni,nk,nj))<a name='2792'>
                     bdy_ye (ni,nk,njde-nj  ) =      nfld(ni,nk,nj)<a name='2793'>
                  END IF<a name='2794'>
               END IF<a name='2795'>
<a name='2796'>
           END DO      <font color=#447700>! nest i<a name='2797'></font>
        END DO         <font color=#447700>! nest k<a name='2798'></font>
     END DO            <font color=#447700>! nest j<a name='2799'></font>
<a name='2800'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='2801'></font>
<a name='2802'>
   END SUBROUTINE bdy_interp2<a name='2803'>
<a name='2804'>
<font color=#447700>!==================================<a name='2805'></font>
<a name='2806'>
<A NAME='INTERP_FCNI'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2807'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcni</font>( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCNI.html' TARGET='index'>1</A><a name='2808'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2809'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2810'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2811'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2812'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2813'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2814'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2815'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='2816'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2817'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2818'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2819'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='2820'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_174"><a name='2821'>
     IMPLICIT NONE<a name='2822'>
<a name='2823'>
<a name='2824'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2825'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2826'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2827'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2828'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2829'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2830'>
                            shw,                                  &amp;<a name='2831'>
                            ipos, jpos,                           &amp;<a name='2832'>
                            nri, nrj<a name='2833'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='2834'>
<a name='2835'>
     INTEGER, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='2836'>
     INTEGER, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='2837'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='2838'>
<a name='2839'>
     <font color=#447700>! Local<a name='2840'></font>
<a name='2841'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='2842'>
<a name='2843'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='2844'></font>
     <font color=#447700>! from the CD tile. <a name='2845'></font>
<a name='2846'>
<font color=#447700>!write(0,'("cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte, cjts,cjte<a name='2847'></font>
<font color=#447700>!write(0,'("nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte, njts,njte<a name='2848'></font>
<a name='2849'>
     DO nj = njts, njte<a name='2850'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='2851'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='2852'></font>
        DO nk = nkts, nkte<a name='2853'>
           ck = nk<a name='2854'>
           DO ni = nits, nite<a name='2855'>
              if ( imask(ni,nj) .NE. 1 ) cycle<a name='2856'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='2857'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='2858'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='2859'></font>
              <font color=#447700>! the values from the CD into the ND<a name='2860'></font>
              nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='2861'>
           ENDDO<a name='2862'>
        ENDDO<a name='2863'>
     ENDDO<a name='2864'>
<a name='2865'>
     RETURN<a name='2866'>
<a name='2867'>
   END SUBROUTINE interp_fcni<a name='2868'>
<a name='2869'>
<A NAME='INTERP_FCNM'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2870'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcnm</font>( cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCNM.html' TARGET='index'>1</A><a name='2871'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2872'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2873'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2874'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2875'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2876'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2877'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2878'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='2879'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2880'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2881'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2882'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='2883'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_175"><a name='2884'>
     IMPLICIT NONE<a name='2885'>
<a name='2886'>
<a name='2887'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2888'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2889'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2890'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2891'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2892'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2893'>
                            shw,                                  &amp;<a name='2894'>
                            ipos, jpos,                           &amp;<a name='2895'>
                            nri, nrj<a name='2896'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='2897'>
<a name='2898'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='2899'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='2900'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='2901'>
<a name='2902'>
     <font color=#447700>! Local<a name='2903'></font>
<a name='2904'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='2905'>
<a name='2906'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='2907'></font>
     <font color=#447700>! from the CD tile. <a name='2908'></font>
<a name='2909'>
<font color=#447700>!write(0,'("mask cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte, cjts,cjte<a name='2910'></font>
<font color=#447700>!write(0,'("mask nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte, njts,njte<a name='2911'></font>
<a name='2912'>
     DO nj = njts, njte<a name='2913'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='2914'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='2915'></font>
        DO nk = nkts, nkte<a name='2916'>
           ck = nk<a name='2917'>
           DO ni = nits, nite<a name='2918'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='2919'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='2920'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='2921'></font>
              <font color=#447700>! the values from the CD into the ND<a name='2922'></font>
              nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='2923'>
           ENDDO<a name='2924'>
        ENDDO<a name='2925'>
     ENDDO<a name='2926'>
<a name='2927'>
     RETURN<a name='2928'>
<a name='2929'>
   END SUBROUTINE interp_fcnm<a name='2930'>
<a name='2931'>
<A NAME='INTERP_FCNM_LU'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_LU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2932'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcnm_lu</font>( cfld,                              &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCNM_LU.html' TARGET='index'>6</A><a name='2933'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2934'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2935'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2936'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='2937'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2938'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2939'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2940'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='2941'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='2942'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='2943'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='2944'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='2945'></font>
                           cxlat,    nxlat,                      &amp;<a name='2946'>
                           cxlong,   nxlong,                     &amp;<a name='2947'>
                           cdx, ndx,                             &amp;<a name='2948'>
                           cid, nid                            ) <a name='2949'>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_LU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_176"><a name='2950'>
<a name='2951'>
     IMPLICIT NONE<a name='2952'>
<a name='2953'>
<a name='2954'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='2955'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='2956'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='2957'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='2958'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='2959'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='2960'>
                            shw,                                  &amp;<a name='2961'>
                            ipos, jpos,                           &amp;<a name='2962'>
                            nri, nrj,                             &amp;<a name='2963'>
                            cid, nid<a name='2964'>
     LOGICAL, INTENT(IN) :: xstag, ystag <a name='2965'>
<a name='2966'>
     REAL,    INTENT(IN) :: cdx, ndx<a name='2967'>
<a name='2968'>
     REAL,    INTENT(IN),  DIMENSION ( cims:cime, cjms:cjme ) :: cxlat, cxlong<a name='2969'>
     REAL,    INTENT(IN),  DIMENSION ( nims:nime, njms:njme ) :: nxlat, nxlong<a name='2970'>
<a name='2971'>
<a name='2972'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='2973'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='2974'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='2975'>
<a name='2976'>
     <font color=#447700>! Local<a name='2977'></font>
<a name='2978'>
     INTEGER i, ci, cj, ck, ni, nj, nk, ip, jp, ierr<a name='2979'>
<a name='2980'>
#ifdef TERRAIN_AND_LANDUSE<a name='2981'>
     INTEGER, DIMENSION(256) :: ipath  <font color=#447700>! array for integer coded ascii for passing path down to get_landuse<a name='2982'></font>
<a name='2983'>
     REAL , ALLOCATABLE, DIMENSION(:,:) :: xlat_g, xlon_g, landuse_g<a name='2984'>
     CHARACTER*256 :: message <a name='2985'>
     CHARACTER*256 :: rsmas_data_path<a name='2986'>
<a name='2987'>
     LOGICAL :: input_from_hires, input_from_file<a name='2988'>
<a name='2989'>
     INTEGER, EXTERNAL :: get_landuse<a name='2990'>
     LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='2991'>
<a name='2992'>
     CALL nl_get_input_from_hires( nid , input_from_hires)<a name='2993'>
     CALL nl_get_input_from_file ( nid , input_from_file )<a name='2994'>
<a name='2995'>
     IF ( input_from_file .AND. input_from_hires ) THEN<a name='2996'>
       Write(message, '(a,i3,a)') &amp; <a name='2997'>
          "Warning : input_from_file turned on for domain ", nid, ", input_from_hires disabled"<a name='2998'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_LU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1143">(message)<a name='2999'>
     END IF<a name='3000'>
<a name='3001'>
     IF ( .NOT. input_from_file .AND. input_from_hires ) THEN<a name='3002'>
<a name='3003'>
       allocate(xlat_g(nids:nide,njds:njde))<a name='3004'>
       allocate(xlon_g(nids:nide,njds:njde))<a name='3005'>
       allocate(landuse_g(nids:nide,njds:njde))<a name='3006'>
<a name='3007'>
       CALL nl_get_rsmas_data_path(1,rsmas_data_path)<a name='3008'>
<a name='3009'>
       DO i = 1, LEN(TRIM(rsmas_data_path))<a name='3010'>
          ipath(i) = ICHAR(rsmas_data_path(i:i))<a name='3011'>
       ENDDO<a name='3012'>
<a name='3013'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='3014'></font>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_LU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_11"> ( nxlat, xlat_g , nid, ' ' , 'xy' ,   &amp;<a name='3015'>
                                       nids, nide-1 , njds , njde-1 , 1 , 1 ,             &amp;<a name='3016'>
                                       nims, nime   , njms , njme   , 1 , 1 ,             &amp;<a name='3017'>
                                       nits, nite   , njts , njte   , 1 , 1   )<a name='3018'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_LU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_12"> ( nxlong, xlon_g, nid, ' ' , 'xy' ,   &amp;<a name='3019'>
                                       nids, nide-1 , njds , njde-1 , 1 , 1 ,             &amp;<a name='3020'>
                                       nims, nime   , njms , njme   , 1 , 1 ,             &amp;<a name='3021'>
                                       nits, nite   , njts , njte   , 1 , 1   )<a name='3022'>
       IF ( wrf_dm_on_monitor() ) THEN<a name='3023'>
         ierr = get_landuse ( ndx/1000., xlat_g, xlon_g, &amp;<a name='3024'>
                              landuse_g,                                        &amp;<a name='3025'>
                              nide-nids+1,njde-njds+1,nide-nids+1,njde-njds+1,  &amp;<a name='3026'>
                              ipath, LEN(TRIM(rsmas_data_path)) )<a name='3027'>
         IF ( ierr == 1 ) THEN<a name='3028'>
            WRITE(message,fmt='(a)') 'get_landuse : aborted<font color=#447700>!'<a name='3029'></font>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_LU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1317">(TRIM(message))<a name='3030'>
         ENDIF<a name='3031'>
       ENDIF<a name='3032'>
<a name='3033'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_REAL'>wrf_global_to_patch_real</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_LU' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_REAL_8"> ( landuse_g , nfld(:,1,:), nid, ' ' , 'xy' ,  &amp;<a name='3034'>
                                      nids, nide-1 , njds , njde-1 , 1 , 1 ,    &amp;<a name='3035'>
                                      nims, nime   , njms , njme   , 1 , 1 ,    &amp;<a name='3036'>
                                      nits, nite   , njts , njte   , 1 , 1   )<a name='3037'>
<a name='3038'>
#else<a name='3039'>
       ierr = get_landuse ( ndx/1000., nxlat(nids:nide,njds:njde), nxlong(nids:nide,njds:njde),  &amp;<a name='3040'>
                            nfld(nids:nide,1,njds:njde),                                         &amp;<a name='3041'>
                            nide-nids+1,njde-njds+1,nide-nids+1,njde-njds+1,                     &amp;<a name='3042'>
                            ipath, LEN(TRIM(rsmas_data_path)) )<a name='3043'>
#endif<a name='3044'>
       deallocate(xlat_g)<a name='3045'>
       deallocate(xlon_g)<a name='3046'>
       deallocate(landuse_g)<a name='3047'>
     ELSE<a name='3048'>
#endif<a name='3049'>
   <font color=#447700>! Iterate over the ND tile and compute the values<a name='3050'></font>
   <font color=#447700>! from the CD tile.<a name='3051'></font>
     DO nj = njts, njte<a name='3052'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point<a name='3053'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='3054'></font>
        DO nk = nkts, nkte<a name='3055'>
           ck = nk<a name='3056'>
           DO ni = nits, nite<a name='3057'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point<a name='3058'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='3059'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='3060'></font>
              <font color=#447700>! the values from the CD into the ND<a name='3061'></font>
              if ( imask(ni,nj) .eq. 1 ) then<a name='3062'>
               nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='3063'>
              endif<a name='3064'>
           ENDDO<a name='3065'>
        ENDDO<a name='3066'>
     ENDDO<a name='3067'>
#ifdef TERRAIN_AND_LANDUSE<a name='3068'>
     END IF<a name='3069'>
#endif<a name='3070'>
     RETURN<a name='3071'>
<a name='3072'>
   END SUBROUTINE interp_fcnm_lu<a name='3073'>
<a name='3074'>
<a name='3075'>
<A NAME='INTERP_FCNM_IMASK'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_IMASK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3076'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcnm_imask</font>( cfld,                           &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCNM_IMASK.html' TARGET='index'>1</A><a name='3077'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3078'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3079'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3080'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='3081'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3082'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3083'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3084'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='3085'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='3086'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3087'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='3088'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='3089'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCNM_IMASK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_177"><a name='3090'>
     IMPLICIT NONE<a name='3091'>
<a name='3092'>
<a name='3093'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3094'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3095'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3096'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3097'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3098'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3099'>
                            shw,                                  &amp;<a name='3100'>
                            ipos, jpos,                           &amp;<a name='3101'>
                            nri, nrj<a name='3102'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='3103'>
<a name='3104'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='3105'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='3106'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='3107'>
<a name='3108'>
     <font color=#447700>! Local<a name='3109'></font>
<a name='3110'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='3111'>
<a name='3112'>
     <font color=#447700>! Iterate over the ND tile and compute the values<a name='3113'></font>
     <font color=#447700>! from the CD tile. <a name='3114'></font>
<a name='3115'>
<font color=#447700>!write(0,'("mask cits:cite, ckts:ckte, cjts:cjte ",6i4)')cits,cite, ckts,ckte,cjts,cjte<a name='3116'></font>
<font color=#447700>!write(0,'("mask nits:nite, nkts:nkte, njts:njte ",6i4)')nits,nite, nkts,nkte,njts,njte<a name='3117'></font>
<a name='3118'>
     DO nj = njts, njte<a name='3119'>
        cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='3120'></font>
        jp = mod ( nj , nrj )  <font color=#447700>! coord of ND w/i CD point<a name='3121'></font>
        DO nk = nkts, nkte<a name='3122'>
           ck = nk<a name='3123'>
           DO ni = nits, nite<a name='3124'>
              ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='3125'></font>
              ip = mod ( ni , nri )  <font color=#447700>! coord of ND w/i CD point<a name='3126'></font>
              <font color=#447700>! This is a trivial implementation of the interp_fcn; just copies<a name='3127'></font>
              <font color=#447700>! the values from the CD into the ND<a name='3128'></font>
              if ( imask(ni,nj) .eq. 1 ) then<a name='3129'>
               nfld( ni, nk, nj ) = cfld( ci , ck , cj )<a name='3130'>
              endif<a name='3131'>
           ENDDO<a name='3132'>
        ENDDO<a name='3133'>
     ENDDO<a name='3134'>
<a name='3135'>
     RETURN<a name='3136'>
<a name='3137'>
   END SUBROUTINE interp_fcnm_imask<a name='3138'>
#endif<a name='3139'>
<font color=#447700>! end of first block of ARW-only routines<a name='3140'></font>
<a name='3141'>
<font color=#447700>! NMM: We still allow interp_mask_land_field because it is needed, but no<a name='3142'></font>
<font color=#447700>! equivalent exists.  Use of this in WRF-NMM is an error and will have<a name='3143'></font>
<font color=#447700>! unintended consequences.<a name='3144'></font>
<A NAME='INTERP_MASK_LAND_FIELD'><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3145'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_mask_land_field</font> ( enable,                   &amp;  <font color=#447700>! says whether to allow interpolation or just the bcasts,<A href='../../call_from/INTERP_MASK_LAND_FIELD.html' TARGET='index'>7</A><a name='3146'></font>
                                       cfld,                     &amp;  <font color=#447700>! CD field<a name='3147'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3148'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3149'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3150'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='3151'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3152'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3153'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3154'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='3155'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='3156'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3157'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='3158'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='3159'></font>
                           clu, nlu                              )<a name='3160'>
<a name='3161'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_178"><a name='3162'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_94"><a name='3163'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_170">, only : wrf_dm_sum_reals, wrf_dm_sum_integers<a name='3164'>
<a name='3165'>
      IMPLICIT NONE<a name='3166'>
   <a name='3167'>
   <a name='3168'>
      LOGICAL, INTENT(IN) :: enable<a name='3169'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3170'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3171'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3172'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3173'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3174'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3175'>
                             shw,                                  &amp;<a name='3176'>
                             ipos, jpos,                           &amp;<a name='3177'>
                             nri, nrj<a name='3178'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='3179'>
   <a name='3180'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='3181'>
      REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='3182'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='3183'>
   <a name='3184'>
      REAL, DIMENSION ( cims:cime, cjms:cjme ) :: clu<a name='3185'>
      REAL, DIMENSION ( nims:nime, njms:njme ) :: nlu<a name='3186'>
   <a name='3187'>
      <font color=#447700>! Local<a name='3188'></font>
   <a name='3189'>
      INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='3190'>
      INTEGER :: icount , ii , jj , ist , ien , jst , jen , iswater, ierr<a name='3191'>
      REAL :: avg , sum , dx , dy<a name='3192'>
      INTEGER , PARAMETER :: max_search = 5<a name='3193'>
      CHARACTER(LEN=255) :: message<a name='3194'>
      INTEGER :: icount_n(nkts:nkte), idummy(nkts:nkte)<a name='3195'>
      REAL :: avg_n(nkts:nkte), sum_n(nkts:nkte), dummy(nkts:nkte)<a name='3196'>
   <a name='3197'>
      <font color=#447700>!  Find out what the water value is.<a name='3198'></font>
   <a name='3199'>
      CALL nl_get_iswater(1,iswater)<a name='3200'>
<a name='3201'>
      <font color=#447700>!  Right now, only mass point locations permitted.<a name='3202'></font>
   <a name='3203'>
      IF ( ( .NOT. xstag) .AND. ( .NOT. ystag ) ) THEN<a name='3204'>
<a name='3205'>
         <font color=#447700>!  Loop over each i,k,j in the nested domain.<a name='3206'></font>
<a name='3207'>
       IF ( enable ) THEN<a name='3208'>
<a name='3209'>
         DO nj = njts, njte<a name='3210'>
            IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='3211'>
               cj = ( nj + (nrj/2)-1 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3212'></font>
            ELSE<a name='3213'>
               cj = ( nj + (nrj-1)/2 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3214'></font>
            END IF<a name='3215'>
            DO nk = nkts, nkte<a name='3216'>
               ck = nk<a name='3217'>
               DO ni = nits, nite<a name='3218'>
                  IF ( imask(ni, nj) .NE. 1 ) cycle<a name='3219'>
                  IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='3220'>
                     ci = ( ni + (nri/2)-1 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3221'></font>
                  ELSE<a name='3222'>
                     ci = ( ni + (nri-1)/2 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3223'></font>
                  END IF<a name='3224'>
   <a name='3225'>
<a name='3226'>
<a name='3227'>
<a name='3228'>
                  <font color=#447700>!<a name='3229'></font>
                  <font color=#447700>!                    (ci,cj+1)     (ci+1,cj+1)<a name='3230'></font>
                  <font color=#447700>!               -        -------------<a name='3231'></font>
                  <font color=#447700>!         1-dy  |        |           |<a name='3232'></font>
                  <font color=#447700>!               |        |           |<a name='3233'></font>
                  <font color=#447700>!               -        |  *        |<a name='3234'></font>
                  <font color=#447700>!          dy   |        | (ni,nj)   |<a name='3235'></font>
                  <font color=#447700>!               |        |           |<a name='3236'></font>
                  <font color=#447700>!               -        -------------<a name='3237'></font>
                  <font color=#447700>!                    (ci,cj)       (ci+1,cj)  <a name='3238'></font>
                  <font color=#447700>!<a name='3239'></font>
                  <font color=#447700>!                        |--|--------|<a name='3240'></font>
                  <font color=#447700>!                         dx  1-dx         <a name='3241'></font>
<a name='3242'>
<a name='3243'>
                  <font color=#447700>!  For odd ratios, at (nri+1)/2, we are on the coarse grid point, so dx = 0<a name='3244'></font>
<a name='3245'>
                  IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='3246'>
                     dx = ( REAL ( MOD ( ni+(nri-1)/2 , nri ) ) + 0.5 ) / REAL ( nri ) <a name='3247'>
                  ELSE <a name='3248'>
                     dx =   REAL ( MOD ( ni+(nri-1)/2 , nri ) )         / REAL ( nri ) <a name='3249'>
                  END IF<a name='3250'>
                  IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='3251'>
                     dy = ( REAL ( MOD ( nj+(nrj-1)/2 , nrj ) ) + 0.5 ) / REAL ( nrj ) <a name='3252'>
                  ELSE <a name='3253'>
                     dy =   REAL ( MOD ( nj+(nrj-1)/2 , nrj ) )         / REAL ( nrj ) <a name='3254'>
                  END IF<a name='3255'>
   <a name='3256'>
                  <font color=#447700>!  This is a "land only" field.  If this is a water point, no operations required.<a name='3257'></font>
<a name='3258'>
                  IF      ( ( NINT(nlu(ni  ,nj  )) .EQ. iswater ) ) THEN<a name='3259'>
                     nfld(ni,nk,nj) =  cfld(ci  ,ck,cj  )<a name='3260'>
<a name='3261'>
                  <font color=#447700>!  If this is a nested land point, and the surrounding coarse values are all land points,<a name='3262'></font>
                  <font color=#447700>!  then this is a simple 4-pt interpolation.<a name='3263'></font>
<a name='3264'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .NE. iswater ) .AND. &amp;<a name='3265'>
                            ( NINT(clu(ci  ,cj  )) .NE. iswater ) .AND. &amp;<a name='3266'>
                            ( NINT(clu(ci+1,cj  )) .NE. iswater ) .AND. &amp;<a name='3267'>
                            ( NINT(clu(ci  ,cj+1)) .NE. iswater ) .AND. &amp;<a name='3268'>
                            ( NINT(clu(ci+1,cj+1)) .NE. iswater ) ) THEN<a name='3269'>
                     nfld(ni,nk,nj) = ( 1. - dx ) * ( ( 1. - dy ) * cfld(ci  ,ck,cj  )   + &amp;<a name='3270'>
                                                             dy   * cfld(ci  ,ck,cj+1) ) + &amp;<a name='3271'>
                                             dx   * ( ( 1. - dy ) * cfld(ci+1,ck,cj  )   + &amp;<a name='3272'>
                                                             dy   * cfld(ci+1,ck,cj+1) )<a name='3273'>
<a name='3274'>
                  <font color=#447700>!  If this is a nested land point and there are NO coarse land values surrounding,<a name='3275'></font>
                  <font color=#447700>!  we temporarily punt.<a name='3276'></font>
<a name='3277'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .NE. iswater ) .AND. &amp;<a name='3278'>
                            ( NINT(clu(ci  ,cj  )) .EQ. iswater ) .AND. &amp;<a name='3279'>
                            ( NINT(clu(ci+1,cj  )) .EQ. iswater ) .AND. &amp;<a name='3280'>
                            ( NINT(clu(ci  ,cj+1)) .EQ. iswater ) .AND. &amp;<a name='3281'>
                            ( NINT(clu(ci+1,cj+1)) .EQ. iswater ) ) THEN<a name='3282'>
                     nfld(ni,nk,nj) = -1<a name='3283'>
<a name='3284'>
                  <font color=#447700>!  If there are some water points and some land points, take an average. <a name='3285'></font>
                  <a name='3286'>
                  ELSE IF ( NINT(nlu(ni  ,nj  )) .NE. iswater ) THEN<a name='3287'>
                     icount = 0<a name='3288'>
                     sum = 0<a name='3289'>
                     IF ( NINT(clu(ci  ,cj  )) .NE. iswater ) THEN<a name='3290'>
                        icount = icount + 1<a name='3291'>
                        sum = sum + cfld(ci  ,ck,cj  )<a name='3292'>
                     END IF<a name='3293'>
                     IF ( NINT(clu(ci+1,cj  )) .NE. iswater ) THEN<a name='3294'>
                        icount = icount + 1<a name='3295'>
                        sum = sum + cfld(ci+1,ck,cj  )<a name='3296'>
                     END IF<a name='3297'>
                     IF ( NINT(clu(ci  ,cj+1)) .NE. iswater ) THEN<a name='3298'>
                        icount = icount + 1<a name='3299'>
                        sum = sum + cfld(ci  ,ck,cj+1)<a name='3300'>
                     END IF<a name='3301'>
                     IF ( NINT(clu(ci+1,cj+1)) .NE. iswater ) THEN<a name='3302'>
                        icount = icount + 1<a name='3303'>
                        sum = sum + cfld(ci+1,ck,cj+1)<a name='3304'>
                     END IF<a name='3305'>
                     nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='3306'>
                  END IF<a name='3307'>
               END DO<a name='3308'>
            END DO<a name='3309'>
         END DO<a name='3310'>
<a name='3311'>
<a name='3312'>
         <font color=#447700>!  Get an average of the whole domain for problem locations.<a name='3313'></font>
<a name='3314'>
         sum_n     = 0<a name='3315'>
         icount_n  = 0<a name='3316'>
         DO nj = njts, njte<a name='3317'>
            DO nk = nkts, nkte<a name='3318'>
               DO ni = nits, nite<a name='3319'>
                  IF ( nfld(ni,nk,nj) .NE. -1 ) THEN<a name='3320'>
                     IF ( NINT(nlu(ni,nj)) .NE. iswater ) THEN<a name='3321'>
                       icount_n(nk)  = icount_n(nk) + 1<a name='3322'>
                       sum_n(nk) = sum_n(nk) + nfld(ni,nk,nj)<a name='3323'>
                     END IF<a name='3324'>
                  END IF<a name='3325'>
               END DO<a name='3326'>
            END DO<a name='3327'>
         END DO<a name='3328'>
<a name='3329'>
         CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_REALS'>wrf_dm_sum_reals</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_SUM_REALS_1">(      sum_n(nkts:nkte),  dummy(nkts:nkte))<a name='3330'>
         sum_n    = dummy<a name='3331'>
         CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_INTEGERS'>wrf_dm_sum_integers</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_SUM_INTEGERS_1">(icount_n(nkts:nkte), idummy(nkts:nkte))<a name='3332'>
         icount_n = idummy<a name='3333'>
         DO nk = nkts, nkte<a name='3334'>
            IF ( icount_n(nk) .GT. 0 )  &amp;<a name='3335'>
              avg_n(nk)  = sum_n(nk) / icount_n(nk)<a name='3336'>
         END DO<a name='3337'>
       ENDIF<a name='3338'>
<a name='3339'>
       IF ( enable ) THEN<a name='3340'>
         IF ( ANY(nfld .EQ. -1) ) THEN<a name='3341'>
<a name='3342'>
         <font color=#447700>!  OK, if there were any of those island situations, we try to search a bit broader<a name='3343'></font>
         <font color=#447700>!  of an area in the coarse grid.<a name='3344'></font>
<a name='3345'>
           DO nj = njts, njte<a name='3346'>
              DO nk = nkts, nkte<a name='3347'>
                 DO ni = nits, nite<a name='3348'>
                    IF ( imask(ni, nj) .NE. 1 ) cycle<a name='3349'>
                    IF ( nfld(ni,nk,nj) .EQ. -1 ) THEN<a name='3350'>
                       IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='3351'>
                          cj = ( nj + (nrj/2)-1 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3352'></font>
                       ELSE<a name='3353'>
                          cj = ( nj + (nrj-1)/2 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3354'></font>
                       END IF<a name='3355'>
                       IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='3356'>
                          ci = ( ni + (nri/2)-1 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3357'></font>
                       ELSE<a name='3358'>
                          ci = ( ni + (nri-1)/2 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3359'></font>
                       END IF<a name='3360'>
                       ist = MAX (ci-max_search,cits)<a name='3361'>
                       ien = MIN (ci+max_search,cite,cide-1)<a name='3362'>
                       jst = MAX (cj-max_search,cjts)<a name='3363'>
                       jen = MIN (cj+max_search,cjte,cjde-1)<a name='3364'>
                       icount = 0 <a name='3365'>
                       sum = 0<a name='3366'>
                       DO jj = jst,jen<a name='3367'>
                          DO ii = ist,ien<a name='3368'>
                             IF ( NINT(clu(ii,jj)) .NE. iswater ) THEN<a name='3369'>
                                icount = icount + 1<a name='3370'>
                                sum = sum + cfld(ii,nk,jj)<a name='3371'>
                             END IF<a name='3372'>
                          END DO<a name='3373'>
                       END DO<a name='3374'>
                       IF ( icount .GT. 0 ) THEN<a name='3375'>
                          nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='3376'>
                       ELSE<a name='3377'>
                          Write(message,fmt='(a,i4,a,i4,a,f10.4)') &amp;<a name='3378'>
                            'horizontal interp error - island (', ni, ',', nj, '), using average ', avg_n(nk)<a name='3379'>
                          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1144"> ( message )<a name='3380'>
                          nfld(ni,nk,nj) = avg_n(nk)<a name='3381'>
                       END IF        <a name='3382'>
                    END IF<a name='3383'>
                 END DO<a name='3384'>
              END DO<a name='3385'>
           END DO<a name='3386'>
         ENDIF<a name='3387'>
       ENDIF<a name='3388'>
      ELSE<a name='3389'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_LAND_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1318"> ( "only unstaggered fields right now" )<a name='3390'>
      END IF<a name='3391'>
<a name='3392'>
   END SUBROUTINE interp_mask_land_field<a name='3393'>
<a name='3394'>
<A NAME='INTERP_MASK_WATER_FIELD'><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3395'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_mask_water_field</font> ( enable,                  &amp;  <font color=#447700>! says whether to allow interpolation or just the bcasts,<A href='../../call_from/INTERP_MASK_WATER_FIELD.html' TARGET='index'>7</A><a name='3396'></font>
                                        cfld,                    &amp;  <font color=#447700>! CD field<a name='3397'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3398'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3399'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3400'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='3401'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3402'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3403'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3404'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='3405'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='3406'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3407'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='3408'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='3409'></font>
                           clu, nlu, cflag, nflag                )<a name='3410'>
<a name='3411'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_179"><a name='3412'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_95"><a name='3413'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_171">, only : wrf_dm_sum_reals, wrf_dm_sum_integers<a name='3414'>
<a name='3415'>
      IMPLICIT NONE<a name='3416'>
   <a name='3417'>
   <a name='3418'>
      LOGICAL, INTENT(IN) :: enable<a name='3419'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3420'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3421'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3422'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3423'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3424'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3425'>
                             shw,                                  &amp;<a name='3426'>
                             ipos, jpos,                           &amp;<a name='3427'>
                             nri, nrj, cflag, nflag<a name='3428'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='3429'>
   <a name='3430'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='3431'>
      REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='3432'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='3433'>
   <a name='3434'>
      REAL, DIMENSION ( cims:cime, cjms:cjme ) :: clu<a name='3435'>
      REAL, DIMENSION ( nims:nime, njms:njme ) :: nlu<a name='3436'>
   <a name='3437'>
      <font color=#447700>! Local<a name='3438'></font>
   <a name='3439'>
      INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='3440'>
      INTEGER :: icount , ii , jj , ist , ien , jst , jen, ierr<a name='3441'>
      REAL :: avg , sum , dx , dy<a name='3442'>
      INTEGER , PARAMETER :: max_search = 5<a name='3443'>
      INTEGER :: icount_n(nkts:nkte), idummy(nkts:nkte)<a name='3444'>
      REAL :: avg_n(nkts:nkte), sum_n(nkts:nkte), dummy(nkts:nkte)<a name='3445'>
      CHARACTER(LEN=255) :: message<a name='3446'>
<a name='3447'>
      <font color=#447700>!  Right now, only mass point locations permitted.<a name='3448'></font>
   <a name='3449'>
      IF ( ( .NOT. xstag) .AND. ( .NOT. ystag ) ) THEN<a name='3450'>
<a name='3451'>
       IF ( enable ) THEN<a name='3452'>
         <font color=#447700>!  Loop over each i,k,j in the nested domain.<a name='3453'></font>
<a name='3454'>
         DO nj = njts, njte<a name='3455'>
            IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='3456'>
               cj = ( nj + (nrj/2)-1 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3457'></font>
            ELSE<a name='3458'>
               cj = ( nj + (nrj-1)/2 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3459'></font>
            END IF<a name='3460'>
            DO nk = nkts, nkte<a name='3461'>
               ck = nk<a name='3462'>
               DO ni = nits, nite<a name='3463'>
<font color=#447700>!dave             IF ( imask(ni, nj) .NE. 1 ) cycle<a name='3464'></font>
                  IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='3465'>
                     ci = ( ni + (nri/2)-1 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3466'></font>
                  ELSE<a name='3467'>
                     ci = ( ni + (nri-1)/2 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3468'></font>
                  END IF<a name='3469'>
   <a name='3470'>
<a name='3471'>
<a name='3472'>
<a name='3473'>
                  <font color=#447700>!<a name='3474'></font>
                  <font color=#447700>!                    (ci,cj+1)     (ci+1,cj+1)<a name='3475'></font>
                  <font color=#447700>!               -        -------------<a name='3476'></font>
                  <font color=#447700>!         1-dy  |        |           |<a name='3477'></font>
                  <font color=#447700>!               |        |           |<a name='3478'></font>
                  <font color=#447700>!               -        |  *        |<a name='3479'></font>
                  <font color=#447700>!          dy   |        | (ni,nj)   |<a name='3480'></font>
                  <font color=#447700>!               |        |           |<a name='3481'></font>
                  <font color=#447700>!               -        -------------<a name='3482'></font>
                  <font color=#447700>!                    (ci,cj)       (ci+1,cj)  <a name='3483'></font>
                  <font color=#447700>!<a name='3484'></font>
                  <font color=#447700>!                        |--|--------|<a name='3485'></font>
                  <font color=#447700>!                         dx  1-dx         <a name='3486'></font>
<a name='3487'>
<a name='3488'>
                  <font color=#447700>!  At ni=2, we are on the coarse grid point, so dx = 0<a name='3489'></font>
<a name='3490'>
                  IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='3491'>
                     dx = ( REAL ( MOD ( ni+(nri-1)/2 , nri ) ) + 0.5 ) / REAL ( nri ) <a name='3492'>
                  ELSE <a name='3493'>
                     dx =   REAL ( MOD ( ni+(nri-1)/2 , nri ) )         / REAL ( nri ) <a name='3494'>
                  END IF<a name='3495'>
                  IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='3496'>
                     dy = ( REAL ( MOD ( nj+(nrj-1)/2 , nrj ) ) + 0.5 ) / REAL ( nrj ) <a name='3497'>
                  ELSE <a name='3498'>
                     dy =   REAL ( MOD ( nj+(nrj-1)/2 , nrj ) )         / REAL ( nrj ) <a name='3499'>
                  END IF<a name='3500'>
   <a name='3501'>
                  <font color=#447700>!  This is a "water only" field.  If this is a land point, no operations required.<a name='3502'></font>
<a name='3503'>
                  IF      ( ( NINT(nlu(ni  ,nj  )) .NE. nflag ) ) THEN<a name='3504'>
                     nfld(ni,nk,nj) = cfld(ci  ,ck,cj  )<a name='3505'>
<a name='3506'>
                  <font color=#447700>!  If this is a nested water point, and the surrounding coarse values are all water points,<a name='3507'></font>
                  <font color=#447700>!  then this is a simple 4-pt interpolation.<a name='3508'></font>
<a name='3509'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .EQ. nflag ) .AND. &amp;<a name='3510'>
                            ( NINT(clu(ci  ,cj  )) .EQ. nflag ) .AND. &amp;<a name='3511'>
                            ( NINT(clu(ci+1,cj  )) .EQ. nflag ) .AND. &amp;<a name='3512'>
                            ( NINT(clu(ci  ,cj+1)) .EQ. nflag ) .AND. &amp;<a name='3513'>
                            ( NINT(clu(ci+1,cj+1)) .EQ. nflag ) ) THEN<a name='3514'>
                     nfld(ni,nk,nj) = ( 1. - dx ) * ( ( 1. - dy ) * cfld(ci  ,ck,cj  )   + &amp;<a name='3515'>
                                                             dy   * cfld(ci  ,ck,cj+1) ) + &amp;<a name='3516'>
                                             dx   * ( ( 1. - dy ) * cfld(ci+1,ck,cj  )   + &amp;<a name='3517'>
                                                             dy   * cfld(ci+1,ck,cj+1) )<a name='3518'>
<a name='3519'>
                  <font color=#447700>!  If this is a nested water point and there are NO coarse water values surrounding,<a name='3520'></font>
                  <font color=#447700>!  we temporarily punt.<a name='3521'></font>
<a name='3522'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .EQ. nflag ) .AND. &amp;<a name='3523'>
                            ( NINT(clu(ci  ,cj  )) .NE. nflag ) .AND. &amp;<a name='3524'>
                            ( NINT(clu(ci+1,cj  )) .NE. nflag ) .AND. &amp;<a name='3525'>
                            ( NINT(clu(ci  ,cj+1)) .NE. nflag ) .AND. &amp;<a name='3526'>
                            ( NINT(clu(ci+1,cj+1)) .NE. nflag ) ) THEN<a name='3527'>
                     nfld(ni,nk,nj) = -4<a name='3528'>
<a name='3529'>
                  <font color=#447700>!  If there are some land points and some water points, take an average. <a name='3530'></font>
                  <a name='3531'>
                  ELSE IF ( NINT(nlu(ni  ,nj  )) .EQ. nflag ) THEN<a name='3532'>
                     icount = 0<a name='3533'>
                     sum = 0<a name='3534'>
                     IF ( NINT(clu(ci  ,cj  )) .EQ. nflag ) THEN<a name='3535'>
                        icount = icount + 1<a name='3536'>
                        sum = sum + cfld(ci  ,ck,cj  )<a name='3537'>
                     END IF<a name='3538'>
                     IF ( NINT(clu(ci+1,cj  )) .EQ. nflag ) THEN<a name='3539'>
                        icount = icount + 1<a name='3540'>
                        sum = sum + cfld(ci+1,ck,cj  )<a name='3541'>
                     END IF<a name='3542'>
                     IF ( NINT(clu(ci  ,cj+1)) .EQ. nflag ) THEN<a name='3543'>
                        icount = icount + 1<a name='3544'>
                        sum = sum + cfld(ci  ,ck,cj+1)<a name='3545'>
                     END IF<a name='3546'>
                     IF ( NINT(clu(ci+1,cj+1)) .EQ. nflag ) THEN<a name='3547'>
                        icount = icount + 1<a name='3548'>
                        sum = sum + cfld(ci+1,ck,cj+1)<a name='3549'>
                     END IF<a name='3550'>
                     nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='3551'>
                  END IF<a name='3552'>
               END DO<a name='3553'>
            END DO<a name='3554'>
         END DO<a name='3555'>
<a name='3556'>
         <font color=#447700>!  Get an average of the whole domain for problem locations.<a name='3557'></font>
<a name='3558'>
         sum_n     = 0<a name='3559'>
         icount_n  = 0<a name='3560'>
         DO nj = njts, njte<a name='3561'>
            DO nk = nkts, nkte<a name='3562'>
               DO ni = nits, nite<a name='3563'>
                  IF ( nfld(ni,nk,nj) .NE. -1 ) THEN<a name='3564'>
                     IF ( NINT(nlu(ni,nj)) .EQ. nflag ) THEN<a name='3565'>
                       icount_n(nk)  = icount_n(nk) + 1<a name='3566'>
                       sum_n(nk) = sum_n(nk) + nfld(ni,nk,nj)<a name='3567'>
                     END IF<a name='3568'>
                  END IF<a name='3569'>
               END DO<a name='3570'>
            END DO<a name='3571'>
         END DO<a name='3572'>
<a name='3573'>
         CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_REALS'>wrf_dm_sum_reals</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_SUM_REALS_2">(      sum_n(nkts:nkte),  dummy(nkts:nkte))<a name='3574'>
         sum_n    = dummy<a name='3575'>
         CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_INTEGERS'>wrf_dm_sum_integers</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_SUM_INTEGERS_2">(icount_n(nkts:nkte), idummy(nkts:nkte))<a name='3576'>
         icount_n = idummy<a name='3577'>
         DO nk = nkts, nkte<a name='3578'>
            IF ( icount_n(nk) .GT. 0 )  &amp;<a name='3579'>
              avg_n(nk)  = sum_n(nk) / icount_n(nk)<a name='3580'>
         END DO<a name='3581'>
       ENDIF<a name='3582'>
<a name='3583'>
       IF ( enable ) THEN<a name='3584'>
         IF ( ANY(nfld .EQ. -4) ) THEN<a name='3585'>
<a name='3586'>
           <font color=#447700>!  OK, if there were any of those lake situations, we try to search a bit broader<a name='3587'></font>
           <font color=#447700>!  of an area in the coarse grid.<a name='3588'></font>
<a name='3589'>
           DO nj = njts, njte<a name='3590'>
              DO nk = nkts, nkte<a name='3591'>
                 DO ni = nits, nite<a name='3592'>
<font color=#447700>!dave               IF ( imask(ni, nj) .NE. 1 ) cycle<a name='3593'></font>
                    IF ( nfld(ni,nk,nj) .EQ. -4 ) THEN<a name='3594'>
                       IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='3595'>
                          cj = ( nj + (nrj/2)-1 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3596'></font>
                       ELSE<a name='3597'>
                          cj = ( nj + (nrj-1)/2 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3598'></font>
                       END IF<a name='3599'>
                       IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='3600'>
                          ci = ( ni + (nri/2)-1 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3601'></font>
                       ELSE<a name='3602'>
                          ci = ( ni + (nri-1)/2 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3603'></font>
                       END IF<a name='3604'>
                       ist = MAX (ci-max_search,cits)<a name='3605'>
                       ien = MIN (ci+max_search,cite,cide-1)<a name='3606'>
                       jst = MAX (cj-max_search,cjts)<a name='3607'>
                       jen = MIN (cj+max_search,cjte,cjde-1)<a name='3608'>
                       icount = 0 <a name='3609'>
                       sum = 0<a name='3610'>
                       DO jj = jst,jen<a name='3611'>
                          DO ii = ist,ien<a name='3612'>
                             IF ( NINT(clu(ii,jj)) .EQ. nflag ) THEN<a name='3613'>
                                icount = icount + 1<a name='3614'>
                                sum = sum + cfld(ii,nk,jj)<a name='3615'>
                             END IF<a name='3616'>
                          END DO<a name='3617'>
                       END DO<a name='3618'>
                       IF ( icount .GT. 0 ) THEN<a name='3619'>
                          nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='3620'>
                       ELSE<a name='3621'>
                         Write(message,fmt='(a,i4,a,i4,a,f10.4)') &amp;<a name='3622'>
                            'horizontal interp error - lake (', ni, ',', nj, '), using average ', avg_n(nk)<a name='3623'>
                         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1145"> ( message )                         <a name='3624'>
                          nfld(ni,nk,nj) = avg_n(nk)<a name='3625'>
                       END IF        <a name='3626'>
                    END IF<a name='3627'>
                 END DO<a name='3628'>
              END DO<a name='3629'>
           END DO<a name='3630'>
         ENDIF<a name='3631'>
       ENDIF<a name='3632'>
      ELSE<a name='3633'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_WATER_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1319"> ( "only unstaggered fields right now" )<a name='3634'>
      END IF<a name='3635'>
<a name='3636'>
   END SUBROUTINE interp_mask_water_field<a name='3637'>
<a name='3638'>
<font color=#447700>! Begin second block of ARW-only routines<a name='3639'></font>
#if <font color=#447700>! defined(NMM_CORE) || NMM_CORE!=1<a name='3640'></font>
<A NAME='P2C_MASK'><A href='../../html_code/share/interp_fcn.F.html#P2C_MASK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3641'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>p2c_mask</font> (   cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/P2C_MASK.html' TARGET='index'>3</A><a name='3642'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3643'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3644'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3645'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='3646'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3647'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3648'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3649'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='3650'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='3651'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3652'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='3653'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='3654'></font>
                           clu, nlu,                             &amp;  <font color=#447700>! land use categories<a name='3655'></font>
                           ctslb,ntslb,                          &amp;  <font color=#447700>! soil temps<a name='3656'></font>
                           cnum_soil_layers,nnum_soil_layers,    &amp;  <font color=#447700>! number of soil layers for tslb<a name='3657'></font>
                           ciswater, niswater                    )  <font color=#447700>! iswater category<a name='3658'></font>
<a name='3659'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#P2C_MASK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_180"><a name='3660'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#P2C_MASK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_96"><a name='3661'>
<a name='3662'>
      IMPLICIT NONE<a name='3663'>
   <a name='3664'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3665'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3666'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3667'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3668'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3669'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3670'>
                             shw,                                  &amp;<a name='3671'>
                             ipos, jpos,                           &amp;<a name='3672'>
                             nri, nrj,                             &amp;<a name='3673'>
                             cnum_soil_layers, nnum_soil_layers,   &amp;<a name='3674'>
                             ciswater, niswater <a name='3675'>
<a name='3676'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='3677'>
   <a name='3678'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='3679'>
      REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='3680'>
      INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='3681'>
   <a name='3682'>
      REAL, DIMENSION ( cims:cime, cjms:cjme ) :: clu<a name='3683'>
      REAL, DIMENSION ( nims:nime, njms:njme ) :: nlu<a name='3684'>
<a name='3685'>
      REAL, DIMENSION ( cims:cime, 1:cnum_soil_layers, cjms:cjme ) :: ctslb<a name='3686'>
      REAL, DIMENSION ( nims:nime, 1:nnum_soil_layers, njms:njme ) :: ntslb<a name='3687'>
<a name='3688'>
      <font color=#447700>! Local<a name='3689'></font>
   <a name='3690'>
      INTEGER ci, cj, ck, ni, nj, nk<a name='3691'>
      INTEGER :: icount <a name='3692'>
      REAL :: sum , dx , dy<a name='3693'>
<a name='3694'>
      <font color=#447700>!  Right now, only mass point locations permitted.<a name='3695'></font>
   <a name='3696'>
      IF ( ( .NOT. xstag) .AND. ( .NOT. ystag ) ) THEN<a name='3697'>
<a name='3698'>
         <font color=#447700>!  Loop over each i,k,j in the nested domain.<a name='3699'></font>
<a name='3700'>
         DO nj = njts, MIN(njde-1,njte)<a name='3701'>
            IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='3702'>
               cj = ( nj + (nrj/2)-1 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3703'></font>
            ELSE<a name='3704'>
               cj = ( nj + (nrj-1)/2 ) / nrj + jpos -1 <font color=#447700>! first coarse position equal to or below nest point<a name='3705'></font>
            END IF<a name='3706'>
            DO nk = nkts, nkte<a name='3707'>
               ck = nk<a name='3708'>
               DO ni = nits, MIN(nide-1,nite)<a name='3709'>
                  IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='3710'>
                     ci = ( ni + (nri/2)-1 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3711'></font>
                  ELSE<a name='3712'>
                     ci = ( ni + (nri-1)/2 ) / nri + ipos -1 <font color=#447700>! first coarse position equal to or to the left of nest point<a name='3713'></font>
                  END IF<a name='3714'>
<a name='3715'>
                  <font color=#447700>!<a name='3716'></font>
                  <font color=#447700>!                    (ci,cj+1)     (ci+1,cj+1)<a name='3717'></font>
                  <font color=#447700>!               -        -------------<a name='3718'></font>
                  <font color=#447700>!         1-dy  |        |           |<a name='3719'></font>
                  <font color=#447700>!               |        |           |<a name='3720'></font>
                  <font color=#447700>!               -        |  *        |<a name='3721'></font>
                  <font color=#447700>!          dy   |        | (ni,nj)   |<a name='3722'></font>
                  <font color=#447700>!               |        |           |<a name='3723'></font>
                  <font color=#447700>!               -        -------------<a name='3724'></font>
                  <font color=#447700>!                    (ci,cj)       (ci+1,cj)  <a name='3725'></font>
                  <font color=#447700>!<a name='3726'></font>
                  <font color=#447700>!                        |--|--------|<a name='3727'></font>
                  <font color=#447700>!                         dx  1-dx         <a name='3728'></font>
<a name='3729'>
<a name='3730'>
                  <font color=#447700>!  At ni=2, we are on the coarse grid point, so dx = 0<a name='3731'></font>
<a name='3732'>
                  IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='3733'>
                     dx = ( REAL ( MOD ( ni+(nri-1)/2 , nri ) ) + 0.5 ) / REAL ( nri ) <a name='3734'>
                  ELSE <a name='3735'>
                     dx =   REAL ( MOD ( ni+(nri-1)/2 , nri ) )         / REAL ( nri ) <a name='3736'>
                  END IF<a name='3737'>
                  IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='3738'>
                     dy = ( REAL ( MOD ( nj+(nrj-1)/2 , nrj ) ) + 0.5 ) / REAL ( nrj ) <a name='3739'>
                  ELSE <a name='3740'>
                     dy =   REAL ( MOD ( nj+(nrj-1)/2 , nrj ) )         / REAL ( nrj ) <a name='3741'>
                  END IF<a name='3742'>
   <a name='3743'>
                  <font color=#447700>!  This is a "water only" field.  If this is a land point, no operations required.<a name='3744'></font>
<a name='3745'>
                  IF      ( ( NINT(nlu(ni  ,nj  )) .NE. niswater ) ) THEN<a name='3746'>
                     nfld(ni,nk,nj) = 273.18<a name='3747'>
<a name='3748'>
                  <font color=#447700>!  If this is a nested water point, and the surrounding coarse values are all water points,<a name='3749'></font>
                  <font color=#447700>!  then this is a simple 4-pt interpolation.<a name='3750'></font>
<a name='3751'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .EQ. niswater ) .AND. &amp;<a name='3752'>
                            ( NINT(clu(ci  ,cj  )) .EQ. niswater ) .AND. &amp;<a name='3753'>
                            ( NINT(clu(ci+1,cj  )) .EQ. niswater ) .AND. &amp;<a name='3754'>
                            ( NINT(clu(ci  ,cj+1)) .EQ. niswater ) .AND. &amp;<a name='3755'>
                            ( NINT(clu(ci+1,cj+1)) .EQ. niswater ) ) THEN<a name='3756'>
                     nfld(ni,nk,nj) = ( 1. - dx ) * ( ( 1. - dy ) * cfld(ci  ,ck,cj  )   + &amp;<a name='3757'>
                                                             dy   * cfld(ci  ,ck,cj+1) ) + &amp;<a name='3758'>
                                             dx   * ( ( 1. - dy ) * cfld(ci+1,ck,cj  )   + &amp;<a name='3759'>
                                                             dy   * cfld(ci+1,ck,cj+1) )<a name='3760'>
<a name='3761'>
                  <font color=#447700>!  If this is a nested water point and there are NO coarse water values surrounding,<a name='3762'></font>
                  <font color=#447700>!  we manufacture something from the deepest CG soil temp.<a name='3763'></font>
<a name='3764'>
                  ELSE IF ( ( NINT(nlu(ni  ,nj  )) .EQ. niswater ) .AND. &amp;<a name='3765'>
                            ( NINT(clu(ci  ,cj  )) .NE. niswater ) .AND. &amp;<a name='3766'>
                            ( NINT(clu(ci+1,cj  )) .NE. niswater ) .AND. &amp;<a name='3767'>
                            ( NINT(clu(ci  ,cj+1)) .NE. niswater ) .AND. &amp;<a name='3768'>
                            ( NINT(clu(ci+1,cj+1)) .NE. niswater ) ) THEN<a name='3769'>
                     nfld(ni,nk,nj) = ( 1. - dx ) * ( ( 1. - dy ) * ctslb(ci  ,cnum_soil_layers,cj  )   + &amp;<a name='3770'>
                                                             dy   * ctslb(ci  ,cnum_soil_layers,cj+1) ) + &amp;<a name='3771'>
                                             dx   * ( ( 1. - dy ) * ctslb(ci+1,cnum_soil_layers,cj  )   + &amp;<a name='3772'>
                                                             dy   * ctslb(ci+1,cnum_soil_layers,cj+1) )<a name='3773'>
<a name='3774'>
                  <font color=#447700>!  If there are some land points and some water points, take an average of the water points.<a name='3775'></font>
                  <a name='3776'>
                  ELSE IF ( NINT(nlu(ni  ,nj  )) .EQ. niswater ) THEN<a name='3777'>
                     icount = 0<a name='3778'>
                     sum = 0<a name='3779'>
                     IF ( NINT(clu(ci  ,cj  )) .EQ. niswater ) THEN<a name='3780'>
                        icount = icount + 1<a name='3781'>
                        sum = sum + cfld(ci  ,ck,cj  )<a name='3782'>
                     END IF<a name='3783'>
                     IF ( NINT(clu(ci+1,cj  )) .EQ. niswater ) THEN<a name='3784'>
                        icount = icount + 1<a name='3785'>
                        sum = sum + cfld(ci+1,ck,cj  )<a name='3786'>
                     END IF<a name='3787'>
                     IF ( NINT(clu(ci  ,cj+1)) .EQ. niswater ) THEN<a name='3788'>
                        icount = icount + 1<a name='3789'>
                        sum = sum + cfld(ci  ,ck,cj+1)<a name='3790'>
                     END IF<a name='3791'>
                     IF ( NINT(clu(ci+1,cj+1)) .EQ. niswater ) THEN<a name='3792'>
                        icount = icount + 1<a name='3793'>
                        sum = sum + cfld(ci+1,ck,cj+1)<a name='3794'>
                     END IF<a name='3795'>
                     nfld(ni,nk,nj) = sum / REAL ( icount ) <a name='3796'>
                  END IF<a name='3797'>
               END DO<a name='3798'>
            END DO<a name='3799'>
         END DO<a name='3800'>
<a name='3801'>
      ELSE<a name='3802'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#P2C_MASK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1320"> ( "only unstaggered fields right now" )<a name='3803'>
      END IF<a name='3804'>
<a name='3805'>
   END SUBROUTINE p2c_mask<a name='3806'>
<a name='3807'>
<A NAME='NONE'><A href='../../html_code/share/interp_fcn.F.html#NONE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3808'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>none</font><a name='3809'>
   END SUBROUTINE none<a name='3810'>
<a name='3811'>
<A NAME='SMOOTHER'><A href='../../html_code/share/interp_fcn.F.html#SMOOTHER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3812'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>smoother</font> ( cfld , &amp;,<A href='../../call_from/SMOOTHER.html' TARGET='index'>3</A><a name='3813'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3814'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3815'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3816'>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3817'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3818'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3819'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3820'></font>
                      ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in<a name='3821'></font>
                      nri, nrj                              &amp;<a name='3822'>
                      )<a name='3823'>
 <a name='3824'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#SMOOTHER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_181"><a name='3825'>
      IMPLICIT NONE<a name='3826'>
   <a name='3827'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3828'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3829'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3830'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3831'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3832'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3833'>
                             nri, nrj,                             &amp;  <a name='3834'>
                             ipos, jpos<a name='3835'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='3836'>
      INTEGER             :: smooth_option, feedback , spec_zone<a name='3837'>
   <a name='3838'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='3839'>
<a name='3840'>
      <font color=#447700>!  If there is no feedback, there can be no smoothing.<a name='3841'></font>
<a name='3842'>
      CALL nl_get_feedback       ( 1, feedback  )<a name='3843'>
      IF ( feedback == 0 ) RETURN<a name='3844'>
      CALL nl_get_spec_zone ( 1, spec_zone )<a name='3845'>
<a name='3846'>
      <font color=#447700>!  These are the 2d smoothers used on the fedback data.  These filters<a name='3847'></font>
      <font color=#447700>!  are run on the coarse grid data (after the nested info has been<a name='3848'></font>
      <font color=#447700>!  fedback).  Only the area of the nest in the coarse grid is filtered.<a name='3849'></font>
<a name='3850'>
      CALL nl_get_smooth_option  ( 1, smooth_option  )<a name='3851'>
<a name='3852'>
      IF      ( smooth_option == 0 ) THEN<a name='3853'>
<font color=#447700>! no op<a name='3854'></font>
      ELSE IF ( smooth_option == 1 ) THEN<a name='3855'>
         CALL <A href='../../html_code/share/interp_fcn.F.html#SM121'>sm121</A><A href='../../html_code/share/interp_fcn.F.html#SMOOTHER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SM121_1"> ( cfld , &amp;<a name='3856'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3857'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3858'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3859'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3860'></font>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3861'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3862'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3863'>
                      nri, nrj,                             &amp;  <a name='3864'>
                      ipos, jpos                            &amp;  <font color=#447700>! Position of lower left of nest in <a name='3865'></font>
                      )<a name='3866'>
      ELSE IF ( smooth_option == 2 ) THEN<a name='3867'>
         CALL <A href='../../html_code/share/interp_fcn.F.html#SMDSM'>smdsm</A><A href='../../html_code/share/interp_fcn.F.html#SMOOTHER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMDSM_1"> ( cfld , &amp;<a name='3868'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3869'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3870'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3871'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3872'></font>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3873'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3874'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3875'>
                      nri, nrj,                             &amp;  <a name='3876'>
                      ipos, jpos                            &amp;  <font color=#447700>! Position of lower left of nest in <a name='3877'></font>
                      )<a name='3878'>
      END IF<a name='3879'>
<a name='3880'>
   END SUBROUTINE smoother <a name='3881'>
<a name='3882'>
<A NAME='SM121'><A href='../../html_code/share/interp_fcn.F.html#SM121' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3883'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>sm121</font> ( cfld , &amp; <A href='../../call_to/SM121.html' TARGET='index'>1</A>,<A href='../../call_from/SM121.html' TARGET='index'>1</A><a name='3884'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3885'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3886'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3887'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3888'></font>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3889'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3890'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3891'>
                      nri, nrj,                             &amp;  <a name='3892'>
                      ipos, jpos                            &amp;  <font color=#447700>! Position of lower left of nest in <a name='3893'></font>
                      )<a name='3894'>
   <a name='3895'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#SM121' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_182"><a name='3896'>
      IMPLICIT NONE<a name='3897'>
   <a name='3898'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3899'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3900'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3901'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3902'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3903'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3904'>
                             nri, nrj,                             &amp;  <a name='3905'>
                             ipos, jpos<a name='3906'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='3907'>
   <a name='3908'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='3909'>
      REAL, DIMENSION ( cims:cime,            cjms:cjme ) :: cfldnew<a name='3910'>
   <a name='3911'>
      INTEGER                        :: i , j , k , loop<a name='3912'>
      INTEGER :: istag,jstag<a name='3913'>
<a name='3914'>
      INTEGER, PARAMETER  :: smooth_passes = 1 <font color=#447700>! More passes requires a larger stencil (currently 48 pt)<a name='3915'></font>
<a name='3916'>
      istag = 1 ; jstag = 1<a name='3917'>
      IF ( xstag ) istag = 0<a name='3918'>
      IF ( ystag ) jstag = 0<a name='3919'>
   <a name='3920'>
      <font color=#447700>!  Simple 1-2-1 smoother.<a name='3921'></font>
   <a name='3922'>
      smoothing_passes : DO loop = 1 , smooth_passes<a name='3923'>
   <a name='3924'>
         DO k = ckts , ckte<a name='3925'>
   <a name='3926'>
            <font color=#447700>!  Initialize dummy cfldnew<a name='3927'></font>
<a name='3928'>
            DO i = MAX(ipos,cits-3) , MIN(ipos+(nide-nids)/nri,cite+3)<a name='3929'>
               DO j = MAX(jpos,cjts-3) , MIN(jpos+(njde-njds)/nrj,cjte+3)<a name='3930'>
                  cfldnew(i,j) = cfld(i,k,j) <a name='3931'>
               END DO<a name='3932'>
            END DO<a name='3933'>
<a name='3934'>
            <font color=#447700>!  1-2-1 smoothing in the j direction first, <a name='3935'></font>
   <a name='3936'>
            DO i = MAX(ipos+2,cits-2) , MIN(ipos+(nide-nids)/nri-2-istag,cite+2)<a name='3937'>
            DO j = MAX(jpos+2,cjts-2) , MIN(jpos+(njde-njds)/nrj-2-jstag,cjte+2)<a name='3938'>
                  cfldnew(i,j) = 0.25 * ( cfld(i,k,j+1) + 2.*cfld(i,k,j) + cfld(i,k,j-1) )<a name='3939'>
               END DO<a name='3940'>
            END DO<a name='3941'>
<a name='3942'>
            <font color=#447700>!  then 1-2-1 smoothing in the i direction last<a name='3943'></font>
       <a name='3944'>
            DO j = MAX(jpos+2,cjts-2) , MIN(jpos+(njde-njds)/nrj-2-jstag,cjte+2)<a name='3945'>
            DO i = MAX(ipos+2,cits-2) , MIN(ipos+(nide-nids)/nri-2-istag,cite+2)<a name='3946'>
                  cfld(i,k,j) =  0.25 * ( cfldnew(i+1,j) + 2.*cfldnew(i,j) + cfldnew(i-1,j) )<a name='3947'>
               END DO<a name='3948'>
            END DO<a name='3949'>
       <a name='3950'>
         END DO<a name='3951'>
    <a name='3952'>
      END DO smoothing_passes<a name='3953'>
   <a name='3954'>
   END SUBROUTINE sm121<a name='3955'>
<a name='3956'>
<A NAME='SMDSM'><A href='../../html_code/share/interp_fcn.F.html#SMDSM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3957'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>smdsm</font> ( cfld , &amp; <A href='../../call_to/SMDSM.html' TARGET='index'>1</A>,<A href='../../call_from/SMDSM.html' TARGET='index'>1</A><a name='3958'>
                      cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3959'>
                      cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3960'>
                      cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3961'>
                      xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='3962'></font>
                      nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3963'>
                      nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3964'>
                      nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3965'>
                      nri, nrj,                             &amp;  <a name='3966'>
                      ipos, jpos                            &amp;  <font color=#447700>! Position of lower left of nest in <a name='3967'></font>
                      )<a name='3968'>
   <a name='3969'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#SMDSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_183"><a name='3970'>
      IMPLICIT NONE<a name='3971'>
   <a name='3972'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='3973'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='3974'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='3975'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='3976'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='3977'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='3978'>
                             nri, nrj,                             &amp;  <a name='3979'>
                             ipos, jpos<a name='3980'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='3981'>
   <a name='3982'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='3983'>
      REAL, DIMENSION ( cims:cime,            cjms:cjme ) :: cfldnew<a name='3984'>
   <a name='3985'>
      REAL , DIMENSION ( 2 )         :: xnu<a name='3986'>
      INTEGER                        :: i , j , k , loop , n <a name='3987'>
      INTEGER :: istag,jstag<a name='3988'>
<a name='3989'>
      INTEGER, PARAMETER  :: smooth_passes = 1 <font color=#447700>! More passes requires a larger stencil (currently 48 pt)<a name='3990'></font>
<a name='3991'>
      xnu  =  (/ 0.50 , -0.52 /)<a name='3992'>
    <a name='3993'>
      istag = 1 ; jstag = 1<a name='3994'>
      IF ( xstag ) istag = 0<a name='3995'>
      IF ( ystag ) jstag = 0<a name='3996'>
   <a name='3997'>
      <font color=#447700>!  The odd number passes of this are the "smoother", the even<a name='3998'></font>
      <font color=#447700>!  number passes are the "de-smoother" (note the different signs on xnu).<a name='3999'></font>
   <a name='4000'>
      smoothing_passes : DO loop = 1 , smooth_passes * 2<a name='4001'>
   <a name='4002'>
         n  =  2 - MOD ( loop , 2 )<a name='4003'>
    <a name='4004'>
         DO k = ckts , ckte<a name='4005'>
   <a name='4006'>
            DO i = MAX(ipos+2,cits-2) , MIN(ipos+(nide-nids)/nri-2-istag,cite+2)<a name='4007'>
               DO j = MAX(jpos+2,cjts-2) , MIN(jpos+(njde-njds)/nrj-2-jstag,cjte+2)<a name='4008'>
                  cfldnew(i,j) = cfld(i,k,j) + xnu(n) * ((cfld(i,k,j+1) + cfld(i,k,j-1)) * 0.5-cfld(i,k,j))<a name='4009'>
               END DO<a name='4010'>
            END DO<a name='4011'>
       <a name='4012'>
            DO i = MAX(ipos+2,cits-2) , MIN(ipos+(nide-nids)/nri-2-istag,cite+2)<a name='4013'>
               DO j = MAX(jpos+2,cjts-2) , MIN(jpos+(njde-njds)/nrj-2-jstag,cjte+2)<a name='4014'>
                  cfld(i,k,j) = cfldnew(i,j)<a name='4015'>
               END DO<a name='4016'>
            END DO<a name='4017'>
       <a name='4018'>
            DO j = MAX(jpos+2,cjts-2) , MIN(jpos+(njde-njds)/nrj-2-jstag,cjte+2)<a name='4019'>
               DO i = MAX(ipos+2,cits-2) , MIN(ipos+(nide-nids)/nri-2-istag,cite+2)<a name='4020'>
                  cfldnew(i,j) = cfld(i,k,j) + xnu(n) * ((cfld(i+1,k,j) + cfld(i-1,k,j)) * 0.5-cfld(i,k,j))<a name='4021'>
               END DO<a name='4022'>
            END DO<a name='4023'>
       <a name='4024'>
            DO j = MAX(jpos+2,cjts-2) , MIN(jpos+(njde-njds)/nrj-2-jstag,cjte+2)<a name='4025'>
               DO i = MAX(ipos+2,cits-2) , MIN(ipos+(nide-nids)/nri-2-istag,cite+2)<a name='4026'>
                  cfld(i,k,j) = cfldnew(i,j)<a name='4027'>
               END DO<a name='4028'>
            END DO<a name='4029'>
   <a name='4030'>
         END DO<a name='4031'>
    <a name='4032'>
      END DO smoothing_passes<a name='4033'>
   <a name='4034'>
   END SUBROUTINE smdsm<a name='4035'>
<a name='4036'>
<font color=#447700>!==================================<a name='4037'></font>
<font color=#447700>! this is used to modify a field over the nest so we can see where the nest is<a name='4038'></font>
<a name='4039'>
<A NAME='MARK_DOMAIN'><A href='../../html_code/share/interp_fcn.F.html#MARK_DOMAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4040'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>mark_domain</font> (  cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/MARK_DOMAIN.html' TARGET='index'>2</A><a name='4041'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4042'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4043'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4044'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='4045'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4046'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4047'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4048'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4049'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4050'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4051'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4052'></font>
                           nri, nrj                             )   <font color=#447700>! nest ratios<a name='4053'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#MARK_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_184"><a name='4054'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#MARK_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_97"><a name='4055'>
     IMPLICIT NONE<a name='4056'>
<a name='4057'>
<a name='4058'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4059'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4060'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4061'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4062'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4063'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4064'>
                            shw,                                  &amp;<a name='4065'>
                            ipos, jpos,                           &amp;<a name='4066'>
                            nri, nrj<a name='4067'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='4068'>
<a name='4069'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(OUT) :: cfld<a name='4070'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ), INTENT(IN) :: nfld<a name='4071'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ), INTENT(IN) :: imask<a name='4072'>
<a name='4073'>
     <font color=#447700>! Local<a name='4074'></font>
<a name='4075'>
     INTEGER ci, cj, ck, ni, nj, nk, ip, jp, ioff, joff, ioffa, joffa<a name='4076'>
     INTEGER :: icmin,icmax,jcmin,jcmax<a name='4077'>
     INTEGER :: istag,jstag, ipoints,jpoints,ijpoints<a name='4078'>
<a name='4079'>
     istag = 1 ; jstag = 1<a name='4080'>
     IF ( xstag ) istag = 0<a name='4081'>
     IF ( ystag ) jstag = 0<a name='4082'>
<a name='4083'>
     DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-jstag-1,cjte)<a name='4084'>
        nj = (cj-jpos)*nrj + jstag + 1<a name='4085'>
        DO ck = ckts, ckte<a name='4086'>
           nk = ck<a name='4087'>
           DO ci = MAX(ipos+1,cits),MIN(ipos+(nide-nids)/nri-istag-1,cite)<a name='4088'>
              ni = (ci-ipos)*nri + istag + 1<a name='4089'>
              cfld( ci, ck, cj ) =  9021000.  <font color=#447700>!magic number: Beverly Hills * 100.<a name='4090'></font>
           ENDDO<a name='4091'>
        ENDDO<a name='4092'>
     ENDDO<a name='4093'>
<a name='4094'>
   END SUBROUTINE mark_domain<a name='4095'>
#endif <a name='4096'>
<font color=#447700>! end of second block of WRF-ARW-specific interpolation schemes<a name='4097'></font>
<a name='4098'>
#if ( NMM_CORE == 1 )<a name='4099'>
<font color=#447700>!=======================================================================================<a name='4100'></font>
<font color=#447700>!  Old circa 2007 interpolation schemes that are still in use<a name='4101'></font>
<font color=#447700>!  This is gopal's doing<a name='4102'></font>
<font color=#447700>!=======================================================================================<a name='4103'></font>
<A NAME='FORCE_SST_NMM'><A href='../../html_code/share/interp_fcn.F.html#FORCE_SST_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4104'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>force_sst_nmm</font>    (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/FORCE_SST_NMM.html' TARGET='index'>2</A><a name='4105'></font>
                               cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4106'>
                               cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4107'>
                               cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4108'>
                               nfld,                                 &amp;  <font color=#447700>! ND field<a name='4109'></font>
                               nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4110'>
                               nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4111'>
                               nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4112'>
                               shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4113'></font>
                               imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4114'></font>
                               xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4115'></font>
                               ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4116'></font>
                               nri, nrj,                             &amp;  <font color=#447700>! nest ratios                         <a name='4117'></font>
                               CII, IIH, CJJ, JJH, CBWGT1, HBWGT1,   &amp;  <font color=#447700>! south-western grid locs and weights <a name='4118'></font>
                               CBWGT2, HBWGT2, CBWGT3, HBWGT3,       &amp;  <font color=#447700>! note that "C"ourse grid ones are<a name='4119'></font>
                               CBWGT4, HBWGT4, CCSST, CSST           )  <font color=#447700>! just dummys<a name='4120'></font>
     USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/share/interp_fcn.F.html#FORCE_SST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_44"><a name='4121'>
     IMPLICIT NONE<a name='4122'>
<a name='4123'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4124'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4125'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4126'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4127'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4128'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4129'>
                            shw,                                  &amp;<a name='4130'>
                            ipos, jpos,                           &amp;<a name='4131'>
                            nri, nrj<a name='4132'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='4133'>
<a name='4134'>
     REAL, DIMENSION ( cims:cime, cjms:cjme ) :: cfld<a name='4135'>
     REAL, DIMENSION ( nims:nime, njms:njme ) :: nfld<a name='4136'>
     REAL,    DIMENSION ( cims:cime, cjms:cjme ), INTENT(IN) :: CBWGT1,CBWGT2,CBWGT3,CBWGT4    <font color=#447700>! dummy<a name='4137'></font>
     REAL,    DIMENSION ( nims:nime, njms:njme ), INTENT(IN) :: HBWGT1,HBWGT2,HBWGT3,HBWGT4<a name='4138'>
     INTEGER, DIMENSION ( cims:cime, cjms:cjme ), INTENT(IN) :: CII,CJJ                        <font color=#447700>! dummy<a name='4139'></font>
     INTEGER, DIMENSION ( nims:nime, njms:njme ), INTENT(IN) :: IIH,JJH<a name='4140'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='4141'>
     INTEGER , INTENT(IN) :: csst(*), ccsst(*)<a name='4142'>
<font color=#447700>!    local<a name='4143'></font>
<a name='4144'>
     LOGICAL  FLIP<a name='4145'>
     INTEGER  i,j,k,n<a name='4146'>
     REAL     SUM,AMAXVAL<a name='4147'>
     REAL,    DIMENSION (4, nims:nime, njms:njme ) :: NBWGT<a name='4148'>
<a name='4149'>
     if(csst(1) /= 1) return<a name='4150'>
<a name='4151'>
<font color=#447700>!<a name='4152'></font>
<font color=#447700>!*** INDEX CONVENTIONS<a name='4153'></font>
<font color=#447700>!***                     NBWGT4=0<a name='4154'></font>
<font color=#447700>!***                      4<a name='4155'></font>
<font color=#447700>!***<a name='4156'></font>
<font color=#447700>!***<a name='4157'></font>
<font color=#447700>!***<a name='4158'></font>
<font color=#447700>!***                   h<a name='4159'></font>
<font color=#447700>!***             1                 2<a name='4160'></font>
<font color=#447700>!***            NBWGT1=1           NBWGT2=0<a name='4161'></font>
<font color=#447700>!***<a name='4162'></font>
<font color=#447700>!***<a name='4163'></font>
<font color=#447700>!***                      3<a name='4164'></font>
<font color=#447700>!***                     NBWGT3=0<a name='4165'></font>
<a name='4166'>
     DO J=NJTS,MIN(NJTE,NJDE-1)<a name='4167'>
      DO I=NITS,MIN(NITE,NIDE-1)<a name='4168'>
            NBWGT(1,I,J)=HBWGT1(I,J)<a name='4169'>
            NBWGT(2,I,J)=HBWGT2(I,J)<a name='4170'>
            NBWGT(3,I,J)=HBWGT3(I,J)<a name='4171'>
            NBWGT(4,I,J)=HBWGT4(I,J)<a name='4172'>
      ENDDO<a name='4173'>
     ENDDO<a name='4174'>
<a name='4175'>
     DO J=NJTS,MIN(NJTE,NJDE-1)<a name='4176'>
      DO I=NITS,MIN(NITE,NIDE-1)<a name='4177'>
          AMAXVAL=0.<a name='4178'>
          DO N=1,4<a name='4179'>
            AMAXVAL=amax1(NBWGT(N,I,J),AMAXVAL)<a name='4180'>
          ENDDO<a name='4181'>
<a name='4182'>
          FLIP=.TRUE.<a name='4183'>
          SUM=0.0<a name='4184'>
          DO N=1,4<a name='4185'>
             IF(AMAXVAL .EQ. NBWGT(N,I,J) .AND. FLIP)THEN<a name='4186'>
               NBWGT(N,I,J)=1.0<a name='4187'>
               FLIP=.FALSE.<a name='4188'>
             ELSE<a name='4189'>
               NBWGT(N,I,J)=0.0<a name='4190'>
             ENDIF<a name='4191'>
             SUM=SUM+NBWGT(N,I,J)<a name='4192'>
             IF(SUM .GT. 1.0)CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#FORCE_SST_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1321"> ( "horizontal interp error - interp_hnear_nmm" )<a name='4193'>
          ENDDO<a name='4194'>
      ENDDO<a name='4195'>
     ENDDO<a name='4196'>
<a name='4197'>
       DO J=NJTS,MIN(NJTE,NJDE-1)<a name='4198'>
        DO I=NITS,MIN(NITE,NIDE-1)<a name='4199'>
            IF(MOD(JJH(I,J),2) .NE. 0)THEN    <font color=#447700>! 1,3,5,7 <a name='4200'></font>
                NFLD(I,J) = NBWGT(1,I,J)*CFLD(IIH(I,J),  JJH(I,J)  ) &amp;<a name='4201'>
                          + NBWGT(2,I,J)*CFLD(IIH(I,J)+1,JJH(I,J)  ) &amp;<a name='4202'>
                          + NBWGT(3,I,J)*CFLD(IIH(I,J),  JJH(I,J)-1) &amp;<a name='4203'>
                          + NBWGT(4,I,J)*CFLD(IIH(I,J),  JJH(I,J)+1)<a name='4204'>
            ELSE<a name='4205'>
                NFLD(I,J) = NBWGT(1,I,J)*CFLD(IIH(I,J),  JJH(I,J)  ) &amp;<a name='4206'>
                          + NBWGT(2,I,J)*CFLD(IIH(I,J)+1,JJH(I,J)  ) &amp;<a name='4207'>
                          + NBWGT(3,I,J)*CFLD(IIH(I,J)+1,JJH(I,J)-1) &amp;<a name='4208'>
                          + NBWGT(4,I,J)*CFLD(IIH(I,J)+1,JJH(I,J)+1)<a name='4209'>
            ENDIF<a name='4210'>
        ENDDO<a name='4211'>
       ENDDO<a name='4212'>
<a name='4213'>
<a name='4214'>
     END SUBROUTINE force_sst_nmm<a name='4215'>
<a name='4216'>
<A NAME='NMM_SMOOTHER_IKJ'><A href='../../html_code/share/interp_fcn.F.html#NMM_SMOOTHER_IKJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4217'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>nmm_smoother_ikj</font> ( cfld , &amp;,<A href='../../call_from/NMM_SMOOTHER_IKJ.html' TARGET='index'>2</A><a name='4218'>
                             cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4219'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4220'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4221'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4222'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4223'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4224'>
                             xstag, ystag,                         &amp;<a name='4225'>
                             ipos, jpos,                           &amp;<a name='4226'>
                             nri, nrj                              &amp;<a name='4227'>
                             )<a name='4228'>
<a name='4229'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#NMM_SMOOTHER_IKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_185"><a name='4230'>
      IMPLICIT NONE<a name='4231'>
<a name='4232'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4233'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4234'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4235'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4236'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4237'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4238'>
                             nri, nrj,                             &amp;<a name='4239'>
                             ipos, jpos<a name='4240'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(INOUT) :: cfld<a name='4241'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='4242'>
<a name='4243'>
<a name='4244'>
      <font color=#447700>! Local<a name='4245'></font>
<a name='4246'>
      INTEGER             :: feedback<a name='4247'>
      INTEGER, PARAMETER  :: smooth_passes = 5<a name='4248'>
<a name='4249'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfldnew<a name='4250'>
      INTEGER :: ci, cj, ck<a name='4251'>
      INTEGER :: is, npass<a name='4252'>
      REAL    :: AVGH<a name='4253'>
      CHARACTER (LEN=256) :: a_message<a name='4254'>
<a name='4255'>
      RETURN<a name='4256'>
      <font color=#447700>!  If there is no feedback, there can be no smoothing.<a name='4257'></font>
<a name='4258'>
      CALL nl_get_feedback       ( 1, feedback  )<a name='4259'>
      IF ( feedback == 0 ) RETURN<a name='4260'>
<a name='4261'>
      WRITE(a_message,*)'SIMPLE SMOOTHER IS SWITCHED ON FOR HEIGHT'<a name='4262'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/interp_fcn.F.html#NMM_SMOOTHER_IKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1146"> ( a_message )                       <a name='4263'>
<a name='4264'>
      DO npass = 1, smooth_passes<a name='4265'>
<a name='4266'>
      DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-1,cjte)  <font color=#447700>! exclude top and bottom BCs<a name='4267'></font>
       if(mod(cj,2) .eq. 0)THEN<a name='4268'>
        is=0 <font color=#447700>! even rows for mass points (2,4,6,8)<a name='4269'></font>
       else<a name='4270'>
        is=1 <font color=#447700>! odd rows for mass points  (1,3,5,7)<a name='4271'></font>
       endif<a name='4272'>
       DO ck = ckts, ckte<a name='4273'>
        DO ci = MAX(ipos+is,cits),MIN(ipos+(nide-nids)/nri-1,cite) <font color=#447700>! excludes LBCs<a name='4274'></font>
            IF(IS==0)THEN    <font color=#447700>! (2,4,6,8)<a name='4275'></font>
             AVGH = CFLD(CI,CK,CJ+1) + CFLD(CI,CK,CJ-1) + CFLD(CI+1,CK,CJ+1) + CFLD(CI+1,CK,CJ-1)<a name='4276'>
            ELSE<a name='4277'>
             AVGH = CFLD(CI,CK,CJ+1) + CFLD(CI,CK,CJ-1) + CFLD(CI-1,CK,CJ+1) + CFLD(CI-1,CK,CJ-1)<a name='4278'>
            ENDIF<a name='4279'>
            CFLDNEW(CI,CK,CJ) = (AVGH + 4*CFLD(CI,CK,CJ)) / 8.0<a name='4280'>
        ENDDO<a name='4281'>
       ENDDO<a name='4282'>
      ENDDO<a name='4283'>
<a name='4284'>
      DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-1,cjte)  <font color=#447700>! exclude top and bottom BCs<a name='4285'></font>
       if(mod(cj,2) .eq. 0)THEN<a name='4286'>
        is=0 <font color=#447700>! even rows for mass points (2,4,6,8)<a name='4287'></font>
       else<a name='4288'>
        is=1 <font color=#447700>! odd rows for mass points  (1,3,5,7)<a name='4289'></font>
       endif<a name='4290'>
       DO ck = ckts, ckte<a name='4291'>
        DO ci = MAX(ipos+is,cits),MIN(ipos+(nide-nids)/nri-1,cite) <font color=#447700>! excludes LBCs<a name='4292'></font>
           CFLD(CI,CK,CJ) = CFLDNEW(CI,CK,CJ)<a name='4293'>
        ENDDO<a name='4294'>
       ENDDO<a name='4295'>
      ENDDO<a name='4296'>
<a name='4297'>
      ENDDO   <font color=#447700>! do npass<a name='4298'></font>
<a name='4299'>
   END SUBROUTINE nmm_smoother_ikj<a name='4300'>
<a name='4301'>
<a name='4302'>
<A NAME='NMM_SMOOTHER_IJK'><A href='../../html_code/share/interp_fcn.F.html#NMM_SMOOTHER_IJK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4303'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>nmm_smoother_ijk</font> ( cfld , &amp;,<A href='../../call_from/NMM_SMOOTHER_IJK.html' TARGET='index'>2</A><a name='4304'>
                             cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4305'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4306'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4307'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4308'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4309'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4310'>
                             xstag, ystag,                         &amp;<a name='4311'>
                             ipos, jpos,                           &amp;<a name='4312'>
                             nri, nrj                              &amp;<a name='4313'>
                             )<a name='4314'>
<a name='4315'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#NMM_SMOOTHER_IJK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_186"><a name='4316'>
      IMPLICIT NONE<a name='4317'>
<a name='4318'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4319'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4320'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4321'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4322'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4323'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4324'>
                             nri, nrj,                             &amp;<a name='4325'>
                             ipos, jpos<a name='4326'>
      REAL, DIMENSION ( cims:cime, cjms:cjme, ckms:ckme ), INTENT(INOUT) :: cfld<a name='4327'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='4328'>
<a name='4329'>
<a name='4330'>
      <font color=#447700>! Local<a name='4331'></font>
<a name='4332'>
      INTEGER             :: feedback<a name='4333'>
      INTEGER, PARAMETER  :: smooth_passes = 5<a name='4334'>
<a name='4335'>
      REAL, DIMENSION ( cims:cime, cjms:cjme, ckms:ckme ) :: cfldnew<a name='4336'>
      INTEGER :: ci, cj, ck<a name='4337'>
      INTEGER :: is, npass<a name='4338'>
      REAL    :: AVGH<a name='4339'>
      CHARACTER (LEN=256) :: a_message<a name='4340'>
<a name='4341'>
      RETURN<a name='4342'>
      <font color=#447700>!  If there is no feedback, there can be no smoothing.<a name='4343'></font>
<a name='4344'>
      CALL nl_get_feedback       ( 1, feedback  )<a name='4345'>
      IF ( feedback == 0 ) RETURN<a name='4346'>
<a name='4347'>
      WRITE(a_message,*)'SIMPLE SMOOTHER IS SWITCHED ON FOR HEIGHT'<a name='4348'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/interp_fcn.F.html#NMM_SMOOTHER_IJK' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1147"> ( a_message )                       <a name='4349'>
<a name='4350'>
      DO npass = 1, smooth_passes<a name='4351'>
<a name='4352'>
      DO ck = ckts, ckte<a name='4353'>
       DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-1,cjte)  <font color=#447700>! exclude top and bottom BCs<a name='4354'></font>
        if(mod(cj,2) .eq. 0)THEN<a name='4355'>
         is=0 <font color=#447700>! even rows for mass points (2,4,6,8)<a name='4356'></font>
        else<a name='4357'>
         is=1 <font color=#447700>! odd rows for mass points  (1,3,5,7)<a name='4358'></font>
        endif<a name='4359'>
        DO ci = MAX(ipos+is,cits),MIN(ipos+(nide-nids)/nri-1,cite) <font color=#447700>! excludes LBCs<a name='4360'></font>
            IF(IS==0)THEN    <font color=#447700>! (2,4,6,8)<a name='4361'></font>
             AVGH = CFLD(CI,CJ+1,CK) + CFLD(CI,CJ-1,CK) + CFLD(CI+1,CJ+1,CK) + CFLD(CI+1,CJ-1,CK)<a name='4362'>
            ELSE<a name='4363'>
             AVGH = CFLD(CI,CJ+1,CK) + CFLD(CI,CJ-1,CK) + CFLD(CI-1,CJ+1,CK) + CFLD(CI-1,CJ-1,CK)<a name='4364'>
            ENDIF<a name='4365'>
            CFLDNEW(CI,CJ,CK) = (AVGH + 4*CFLD(CI,CJ,CK)) / 8.0<a name='4366'>
        ENDDO<a name='4367'>
       ENDDO<a name='4368'>
      ENDDO<a name='4369'>
<a name='4370'>
      DO ck = ckts, ckte<a name='4371'>
       DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-1,cjte)  <font color=#447700>! exclude top and bottom BCs<a name='4372'></font>
        if(mod(cj,2) .eq. 0)THEN<a name='4373'>
         is=0 <font color=#447700>! even rows for mass points (2,4,6,8)<a name='4374'></font>
        else<a name='4375'>
         is=1 <font color=#447700>! odd rows for mass points  (1,3,5,7)<a name='4376'></font>
        endif<a name='4377'>
        DO ci = MAX(ipos+is,cits),MIN(ipos+(nide-nids)/nri-1,cite) <font color=#447700>! excludes LBCs<a name='4378'></font>
           CFLD(CI,CJ,CK) = CFLDNEW(CI,CJ,CK)<a name='4379'>
        ENDDO<a name='4380'>
       ENDDO<a name='4381'>
      ENDDO<a name='4382'>
<a name='4383'>
      ENDDO   <font color=#447700>! do npass<a name='4384'></font>
<a name='4385'>
   END SUBROUTINE nmm_smoother_ijk<a name='4386'>
<a name='4387'>
<a name='4388'>
<A NAME='NMM_VSMOOTHER_IKJ'><A href='../../html_code/share/interp_fcn.F.html#NMM_VSMOOTHER_IKJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4389'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>nmm_vsmoother_ikj</font> ( cfld , &amp;,<A href='../../call_from/NMM_VSMOOTHER_IKJ.html' TARGET='index'>2</A><a name='4390'>
                             cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4391'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4392'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4393'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4394'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4395'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4396'>
                             xstag, ystag,                         &amp;<a name='4397'>
                             ipos, jpos,                           &amp;<a name='4398'>
                             nri, nrj                              &amp;<a name='4399'>
                             )<a name='4400'>
<a name='4401'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#NMM_VSMOOTHER_IKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_187"><a name='4402'>
      IMPLICIT NONE<a name='4403'>
<a name='4404'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4405'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4406'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4407'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4408'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4409'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4410'>
                             nri, nrj,                             &amp;<a name='4411'>
                             ipos, jpos<a name='4412'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ), INTENT(INOUT) :: cfld<a name='4413'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='4414'>
<a name='4415'>
<a name='4416'>
      <font color=#447700>! Local<a name='4417'></font>
<a name='4418'>
      INTEGER             :: feedback<a name='4419'>
      INTEGER, PARAMETER  :: smooth_passes = 5<a name='4420'>
<a name='4421'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfldnew<a name='4422'>
      INTEGER :: ci, cj, ck<a name='4423'>
      INTEGER :: is, npass<a name='4424'>
      REAL    :: AVGV<a name='4425'>
      CHARACTER (LEN=256) :: a_message<a name='4426'>
<a name='4427'>
      RETURN<a name='4428'>
      <font color=#447700>!  If there is no feedback, there can be no smoothing.<a name='4429'></font>
<a name='4430'>
      CALL nl_get_feedback       ( 1, feedback  )<a name='4431'>
      IF ( feedback == 0 ) RETURN<a name='4432'>
<a name='4433'>
      WRITE(a_message,*)'SIMPLE SMOOTHER IS SWITCHED ON FOR VELOCITY'<a name='4434'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/share/interp_fcn.F.html#NMM_VSMOOTHER_IKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1148"> ( a_message )                       <a name='4435'>
<a name='4436'>
      DO npass = 1, smooth_passes<a name='4437'>
<a name='4438'>
      DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-1,cjte)  <font color=#447700>! exclude top and bottom BCs<a name='4439'></font>
       if(mod(cj,2) .eq. 0)THEN<a name='4440'>
        is=1 <font color=#447700>! even rows for mass points (2,4,6,8)<a name='4441'></font>
       else<a name='4442'>
        is=0 <font color=#447700>! odd rows for mass points  (1,3,5,7)<a name='4443'></font>
       endif<a name='4444'>
       DO ck = ckts, ckte<a name='4445'>
        DO ci = MAX(ipos+is,cits),MIN(ipos+(nide-nids)/nri-1,cite) <font color=#447700>! excludes LBCs<a name='4446'></font>
            IF(IS==0)THEN    <font color=#447700>! (2,4,6,8)<a name='4447'></font>
             AVGV = CFLD(CI,CK,CJ+1) + CFLD(CI,CK,CJ-1) + CFLD(CI+1,CK,CJ+1) + CFLD(CI+1,CK,CJ-1)<a name='4448'>
            ELSE<a name='4449'>
             AVGV = CFLD(CI,CK,CJ+1) + CFLD(CI,CK,CJ-1) + CFLD(CI-1,CK,CJ+1) + CFLD(CI-1,CK,CJ-1)<a name='4450'>
            ENDIF<a name='4451'>
            CFLDNEW(CI,CK,CJ) = (AVGV + 4*CFLD(CI,CK,CJ)) / 8.0<a name='4452'>
        ENDDO<a name='4453'>
       ENDDO<a name='4454'>
      ENDDO<a name='4455'>
<a name='4456'>
      DO cj = MAX(jpos+1,cjts),MIN(jpos+(njde-njds)/nrj-1,cjte)  <font color=#447700>! exclude top and bottom BCs<a name='4457'></font>
       if(mod(cj,2) .eq. 0)THEN<a name='4458'>
        is=1 <font color=#447700>! even rows for mass points (2,4,6,8)<a name='4459'></font>
       else<a name='4460'>
        is=0 <font color=#447700>! odd rows for mass points  (1,3,5,7)<a name='4461'></font>
       endif<a name='4462'>
       DO ck = ckts, ckte<a name='4463'>
        DO ci = MAX(ipos+is,cits),MIN(ipos+(nide-nids)/nri-1,cite) <font color=#447700>! excludes LBCs<a name='4464'></font>
           CFLD(CI,CK,CJ) = CFLDNEW(CI,CK,CJ)<a name='4465'>
        ENDDO<a name='4466'>
       ENDDO<a name='4467'>
      ENDDO<a name='4468'>
<a name='4469'>
      ENDDO<a name='4470'>
<a name='4471'>
   END SUBROUTINE nmm_vsmoother_ikj<a name='4472'>
<font color=#447700>!======================================================================================<a name='4473'></font>
<font color=#447700>!   End of gopal's doing<a name='4474'></font>
<font color=#447700>!======================================================================================<a name='4475'></font>
<font color=#447700>!======================================================================================<a name='4476'></font>
<font color=#447700>!   New NMM Interpolation Routines; wrappers around module_interp_nmm (Sam's doing)<a name='4477'></font>
<font color=#447700>!======================================================================================<a name='4478'></font>
<a name='4479'>
<font color=#447700>!--------------------------------------------------------------------------------------<a name='4480'></font>
   <a name='4481'>
<A NAME='NOINTERPMANY'><A href='../../html_code/share/interp_fcn.F.html#NOINTERPMANY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4482'>
   <font color=#993300>subroutine </font><font color=#cc0000>NoInterpMany</font>(cfld,                                 &amp;  <font color=#447700>! CD field<a name='4483'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4484'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4485'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4486'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4487'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4488'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4489'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4490'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4491'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4492'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4493'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4494'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios                         <a name='4495'></font>
        cpint,npint, cpd,npd, cq,nq, ct,nt,   &amp;<a name='4496'>
        cfis,nfis)<a name='4497'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4498'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4499'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4500'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4501'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4502'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4503'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4504'>
          shw,ipos,jpos,nri,nrj<a name='4505'>
<a name='4506'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4507'>
<a name='4508'>
     <font color=#447700>!  parent domain<a name='4509'></font>
<a name='4510'>
     REAL,DIMENSION(cims:cime,cjms:cjme,ckms:ckme),   INTENT(IN)           :: CFLD,cpint,ct,cq<a name='4511'>
     REAL,DIMENSION(cims:cime,cjms:cjme),             INTENT(IN)           :: cpd,cfis<a name='4512'>
<a name='4513'>
     <font color=#447700>!  nested domain<a name='4514'></font>
<a name='4515'>
     REAL,DIMENSION(nims:nime,njms:njme),             INTENT(IN)           :: nFIS,npd<a name='4516'>
     REAL,DIMENSION(nims:nime,njms:njme,nkms:nkme),   INTENT(IN)           :: NFLD,npint,nt,nq<a name='4517'>
<a name='4518'>
   end subroutine NoInterpMany<a name='4519'>
<a name='4520'>
<A NAME='DOWNAGED2D'><A href='../../html_code/share/interp_fcn.F.html#DOWNAGED2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4521'>
   <font color=#993300>subroutine </font><font color=#cc0000>DownAged2D</font>(junk,                &amp;,<A href='../../call_from/DOWNAGED2D.html' TARGET='index'>3</A><a name='4522'>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4523'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4524'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4525'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4526'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4527'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4528'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4529'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4530'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4531'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4532'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4533'></font>
        nri, nrj, &amp;<a name='4534'>
        c_age,n_age, cfld)<a name='4535'>
<a name='4536'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#DOWNAGED2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_1">, only: c2n_copy2d_nomask<a name='4537'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#DOWNAGED2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_1"><a name='4538'>
     implicit none<a name='4539'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4540'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4541'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4542'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4543'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4544'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4545'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4546'>
          shw,ipos,jpos,nri,nrj<a name='4547'>
<a name='4548'>
     integer, intent(in) :: c_age<a name='4549'>
     integer, intent(inout) :: n_age<a name='4550'>
<a name='4551'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4552'>
     REAL,DIMENSION(cims:cime,cjms:cjme),   INTENT(IN)           :: CFLD,junk<a name='4553'>
     REAL,DIMENSION(nims:nime,njms:njme),   INTENT(INOUT)        :: nfld<a name='4554'>
<a name='4555'>
     logical bad<a name='4556'>
     integer i,j<a name='4557'>
     <font color=#447700>! Skip if the nest is up-to-date with the parent.  Special age<a name='4558'></font>
     <font color=#447700>! of 0 means the values are invalid (parent just moved, nest<a name='4559'></font>
     <font color=#447700>! just moved or one was initialized).<a name='4560'></font>
     if(n_age==c_age .and. n_age/=0 .and. c_age/=0) then<a name='4561'>
        <font color=#447700>!write(0,*) 'Grid ',grid_id,' not storing pdyn in DownAged2D'<a name='4562'></font>
        <font color=#447700>!write(0,*) '  reason: n_age=',n_age,' c_age=',c_age<a name='4563'></font>
        return<a name='4564'>
     end if<a name='4565'>
     n_age=c_age<a name='4566'>
     <font color=#447700>!write(0,*) 'Storing grid ',parent_grid_id,' pdyn_smooth in grid ',grid_id,' pdyn_parent'<a name='4567'></font>
<a name='4568'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY2D_NOMASK'>c2n_copy2d_nomask</A><A href='../../html_code/share/interp_fcn.F.html#DOWNAGED2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_COPY2D_NOMASK_1">(IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4,  &amp;<a name='4569'>
          cfld,nfld,                &amp;<a name='4570'>
          cims, cime, cjms, cjme,   &amp;<a name='4571'>
          nids, nide, njds, njde,   &amp;<a name='4572'>
          nims, nime, njms, njme,   &amp;<a name='4573'>
          nits, nite, njts, njte, .true.)<a name='4574'>
<a name='4575'>
   end subroutine DownAged2D<a name='4576'>
<a name='4577'>
<A NAME='FORCENEARSST'><A href='../../html_code/share/interp_fcn.F.html#FORCENEARSST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4578'>
   <font color=#993300>subroutine </font><font color=#cc0000>ForceNearSST</font>   (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/FORCENEARSST.html' TARGET='index'>3</A><a name='4579'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4580'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4581'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4582'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4583'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4584'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4585'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4586'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4587'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4588'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4589'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4590'></font>
        nri, nrj, &amp;<a name='4591'>
        cactivate, nactivate)<a name='4592'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#FORCENEARSST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_2">, only: c2n_sst<a name='4593'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#FORCENEARSST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_2"><a name='4594'>
     implicit none<a name='4595'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4596'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4597'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4598'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4599'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4600'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4601'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4602'>
          shw,ipos,jpos,nri,nrj<a name='4603'>
<a name='4604'>
     integer, intent(In), dimension(*) :: cactivate, nactivate<a name='4605'>
<a name='4606'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4607'>
     REAL,DIMENSION(cims:cime,cjms:cjme),   INTENT(IN)           :: CFLD<a name='4608'>
     REAL,DIMENSION(nims:nime,njms:njme),   INTENT(INOUT)        :: nfld<a name='4609'>
<a name='4610'>
     if(nactivate(1)/=1) return<a name='4611'>
<a name='4612'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_SST'>c2n_sst</A><A href='../../html_code/share/interp_fcn.F.html#FORCENEARSST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_SST_1">(hnear_i,hnear_j,          &amp;<a name='4613'>
          cfld,nfld,                &amp;<a name='4614'>
          cims, cime, cjms, cjme,   &amp;<a name='4615'>
          nids, nide, njds, njde,   &amp;<a name='4616'>
          nims, nime, njms, njme,   &amp;<a name='4617'>
          nits, nite, njts, njte)<a name='4618'>
   end subroutine ForceNearSST<a name='4619'>
<a name='4620'>
<A NAME='DOWNNEAR'><A href='../../html_code/share/interp_fcn.F.html#DOWNNEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4621'>
   <font color=#993300>subroutine </font><font color=#cc0000>DownNear</font>      (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/DOWNNEAR.html' TARGET='index'>4</A><a name='4622'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4623'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4624'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4625'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4626'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4627'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4628'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4629'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4630'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4631'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4632'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4633'></font>
        nri, nrj)                                <font color=#447700>! nest ratios         <a name='4634'></font>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#DOWNNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_3">, only: c2n_near2d, c2n_near3d<a name='4635'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#DOWNNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_3"><a name='4636'>
     implicit none<a name='4637'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4638'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4639'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4640'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4641'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4642'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4643'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4644'>
          shw,ipos,jpos,nri,nrj<a name='4645'>
<a name='4646'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4647'>
     REAL,DIMENSION(cims:cime,cjms:cjme),   INTENT(IN)           :: CFLD<a name='4648'>
     REAL,DIMENSION(nims:nime,njms:njme),   INTENT(INOUT)          :: nfld<a name='4649'>
<a name='4650'>
     if(nkts==nkte) then<a name='4651'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_NEAR2D'>c2n_near2d</A><A href='../../html_code/share/interp_fcn.F.html#DOWNNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_NEAR2D_1">(hnear_i,hnear_j,   &amp;<a name='4652'>
             cfld,nfld,imask,                       &amp;<a name='4653'>
             cims, cime, cjms, cjme,   &amp;<a name='4654'>
             nids, nide, njds, njde,   &amp;<a name='4655'>
             nims, nime, njms, njme,   &amp;<a name='4656'>
             nits, nite, njts, njte)<a name='4657'>
     else<a name='4658'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_NEAR3D'>c2n_near3d</A><A href='../../html_code/share/interp_fcn.F.html#DOWNNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_NEAR3D_1">(hnear_i,hnear_j,   &amp;<a name='4659'>
             cfld,nfld,imask,                       &amp;<a name='4660'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='4661'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='4662'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='4663'>
             nits, nite, njts, njte, nkts, nkte)<a name='4664'>
     endif<a name='4665'>
   end subroutine DownNear<a name='4666'>
<a name='4667'>
<A NAME='DOWNNEARIKJ'><A href='../../html_code/share/interp_fcn.F.html#DOWNNEARIKJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4668'>
   <font color=#993300>subroutine </font><font color=#cc0000>DownNearIKJ</font>   (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/DOWNNEARIKJ.html' TARGET='index'>4</A><a name='4669'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4670'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4671'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4672'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4673'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4674'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4675'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4676'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4677'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4678'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4679'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4680'></font>
        nri, nrj)                                <font color=#447700>! nest ratios         <a name='4681'></font>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#DOWNNEARIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_4">, only: c2n_near3dikj<a name='4682'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#DOWNNEARIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_4"><a name='4683'>
     implicit none<a name='4684'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4685'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4686'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4687'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4688'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4689'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4690'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4691'>
          shw,ipos,jpos,nri,nrj<a name='4692'>
<a name='4693'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4694'>
     REAL,DIMENSION(cims:cime,ckms:ckme,cjms:cjme),   INTENT(IN)           :: CFLD<a name='4695'>
     REAL,DIMENSION(nims:nime,nkms:nkme,njms:njme),   INTENT(INOUT)          :: nfld<a name='4696'>
     <a name='4697'>
     if(nkts==nkte) &amp;<a name='4698'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#DOWNNEARIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1322">('IJ interpolation of an IKJ variable is not supported and makes no sense anyway.  Use DownNear instead.')<a name='4699'>
<a name='4700'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_NEAR3DIKJ'>c2n_near3dikj</A><A href='../../html_code/share/interp_fcn.F.html#DOWNNEARIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_NEAR3DIKJ_1">(hnear_i,hnear_j,   &amp;<a name='4701'>
          cfld,nfld,imask,                       &amp;<a name='4702'>
          cims, cime, cjms, cjme, ckms, ckme,  &amp;<a name='4703'>
          nids, nide, njds, njde, nkds, nkde,  &amp;<a name='4704'>
          nims, nime, njms, njme, nkms, nkme,  &amp;<a name='4705'>
          nits, nite, njts, njte, nkts, nkte)<a name='4706'>
   end subroutine DownNearIKJ<a name='4707'>
<a name='4708'>
<A NAME='UPNEAR'><A href='../../html_code/share/interp_fcn.F.html#UPNEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4709'>
   <font color=#993300>subroutine </font><font color=#cc0000>UpNear</font>(cfld,                    &amp;  <font color=#447700>! CD field,<A href='../../call_from/UPNEAR.html' TARGET='index'>4</A><a name='4710'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4711'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4712'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4713'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4714'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4715'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4716'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4717'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4718'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4719'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4720'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4721'></font>
        nri, nrj)                                <font color=#447700>! nest ratios                         <a name='4722'></font>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#UPNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_5"><a name='4723'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#UPNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_5">, only: n2c_near2d<a name='4724'>
     implicit none<a name='4725'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4726'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4727'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4728'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4729'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4730'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4731'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4732'>
          shw,ipos,jpos,nri,nrj<a name='4733'>
<a name='4734'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4735'>
     REAL,DIMENSION(cims:cime,cjms:cjme),   INTENT(OUT)           :: CFLD<a name='4736'>
     REAL,DIMENSION(nims:nime,njms:njme),   INTENT(IN)          :: nfld<a name='4737'>
<a name='4738'>
     if(nkts/=nkte) &amp;<a name='4739'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#UPNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1323">('Up nearest neighbor interpolation is not implemented.')<a name='4740'>
<a name='4741'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_NEAR2D'>n2c_near2d</A><A href='../../html_code/share/interp_fcn.F.html#UPNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_NEAR2D_1">( cfld,nfld,ipos,jpos,                  &amp;<a name='4742'>
          cids, cide, cjds, cjde,   &amp;<a name='4743'>
          cims, cime, cjms, cjme,   &amp;<a name='4744'>
          cits, cite, cjts, cjte,   &amp;<a name='4745'>
          nids, nide, njds, njde,   &amp;<a name='4746'>
          nims, nime, njms, njme,   &amp;<a name='4747'>
          nits, nite, njts, njte)<a name='4748'>
   end subroutine UpNear<a name='4749'>
<a name='4750'>
<A NAME='DOWNINEAR'><A href='../../html_code/share/interp_fcn.F.html#DOWNINEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4751'>
   <font color=#993300>subroutine </font><font color=#cc0000>DownINear</font>      (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/DOWNINEAR.html' TARGET='index'>4</A><a name='4752'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4753'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4754'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4755'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4756'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4757'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4758'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4759'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4760'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4761'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4762'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4763'></font>
        nri, nrj)                                <font color=#447700>! nest ratios         <a name='4764'></font>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#DOWNINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_6">, only: c2n_inear2d<a name='4765'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#DOWNINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_6"><a name='4766'>
     implicit none<a name='4767'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4768'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4769'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4770'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4771'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4772'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4773'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4774'>
          shw,ipos,jpos,nri,nrj<a name='4775'>
<a name='4776'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4777'>
     INTEGER,DIMENSION(cims:cime,cjms:cjme),   INTENT(IN)           :: CFLD<a name='4778'>
     INTEGER,DIMENSION(nims:nime,njms:njme),   INTENT(INOUT)          :: nfld<a name='4779'>
<a name='4780'>
     if(nkts/=nkte) &amp;<a name='4781'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#DOWNINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1324">('3D integer nearest neighbor interpolation is not implemented.')<a name='4782'>
<a name='4783'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_INEAR2D'>c2n_inear2d</A><A href='../../html_code/share/interp_fcn.F.html#DOWNINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_INEAR2D_1">(hnear_i,hnear_j,   &amp;<a name='4784'>
          cfld,nfld,imask,                       &amp;<a name='4785'>
          cims, cime, cjms, cjme,   &amp;<a name='4786'>
          nids, nide, njds, njde,   &amp;<a name='4787'>
          nims, nime, njms, njme,   &amp;<a name='4788'>
          nits, nite, njts, njte)<a name='4789'>
   end subroutine DownINear<a name='4790'>
<a name='4791'>
<A NAME='UPINEAR'><A href='../../html_code/share/interp_fcn.F.html#UPINEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4792'>
   <font color=#993300>subroutine </font><font color=#cc0000>UpINear</font>        (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/UPINEAR.html' TARGET='index'>4</A><a name='4793'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4794'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4795'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4796'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4797'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4798'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4799'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4800'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4801'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4802'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4803'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4804'></font>
        nri, nrj)                                <font color=#447700>! nest ratios                         <a name='4805'></font>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#UPINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_7"><a name='4806'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#UPINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_7">, only: n2c_inear2d<a name='4807'>
     implicit none<a name='4808'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4809'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4810'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4811'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4812'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4813'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4814'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4815'>
          shw,ipos,jpos,nri,nrj<a name='4816'>
<a name='4817'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4818'>
     INTEGER,DIMENSION(cims:cime,cjms:cjme),   INTENT(OUT)           :: CFLD<a name='4819'>
     INTEGER,DIMENSION(nims:nime,njms:njme),   INTENT(IN)          :: nfld<a name='4820'>
<a name='4821'>
     if(nkts/=nkte) &amp;<a name='4822'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#UPINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1325">('3D integer nearest neighbor interpolation is not implemented.')<a name='4823'>
<a name='4824'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_INEAR2D'>n2c_inear2d</A><A href='../../html_code/share/interp_fcn.F.html#UPINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_INEAR2D_1">( cfld,nfld,ipos,jpos,                  &amp;<a name='4825'>
          cids, cide, cjds, cjde,   &amp;<a name='4826'>
          cims, cime, cjms, cjme,   &amp;<a name='4827'>
          cits, cite, cjts, cjte,   &amp;<a name='4828'>
          nids, nide, njds, njde,   &amp;<a name='4829'>
          nims, nime, njms, njme,   &amp;<a name='4830'>
          nits, nite, njts, njte)<a name='4831'>
   end subroutine UpINear<a name='4832'>
<a name='4833'>
<A NAME='DOWNMASS'><A href='../../html_code/share/interp_fcn.F.html#DOWNMASS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4834'>
   <font color=#993300>subroutine </font><font color=#cc0000>DownMass</font>      (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/DOWNMASS.html' TARGET='index'>4</A><a name='4835'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4836'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4837'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4838'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4839'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4840'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4841'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4842'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4843'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4844'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4845'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4846'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='4847'></font>
        emethod, evalue)                         <font color=#447700>! extrapolation method<a name='4848'></font>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#DOWNMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_8">, only: c2n_mass, c2n_copy2d<a name='4849'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#DOWNMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_8"><a name='4850'>
     implicit none<a name='4851'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4852'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4853'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4854'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4855'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4856'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4857'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4858'>
          shw,ipos,jpos,nri,nrj, emethod<a name='4859'>
     real, intent(in) :: evalue<a name='4860'>
<a name='4861'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4862'>
     REAL,DIMENSION(cims:cime,cjms:cjme,ckms:ckme),   INTENT(IN)           :: CFLD<a name='4863'>
     REAL,DIMENSION(nims:nime,njms:njme,nkms:nkme),   INTENT(INOUT)          :: nfld<a name='4864'>
<a name='4865'>
     if(nkts==nkte) then<a name='4866'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY2D'>c2n_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#DOWNMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_COPY2D_1">(IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4,  &amp;<a name='4867'>
             cfld,nfld,imask,                &amp;<a name='4868'>
             cims, cime, cjms, cjme,   &amp;<a name='4869'>
             nids, nide, njds, njde,   &amp;<a name='4870'>
             nims, nime, njms, njme,   &amp;<a name='4871'>
             nits, nite, njts, njte, .true.)<a name='4872'>
     else<a name='4873'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_MASS'>c2n_mass</A><A href='../../html_code/share/interp_fcn.F.html#DOWNMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_MASS_1">(IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4,   &amp;<a name='4874'>
             cfld,nfld,iinfo,winfo,imask,          &amp;<a name='4875'>
             emethod,evalue,                       &amp;<a name='4876'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='4877'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='4878'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='4879'>
             nits, nite, njts, njte, nkts, nkte)<a name='4880'>
     endif<a name='4881'>
   end subroutine DownMass<a name='4882'>
<a name='4883'>
<A NAME='DOWNMASSIKJ'><A href='../../html_code/share/interp_fcn.F.html#DOWNMASSIKJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4884'>
   <font color=#993300>subroutine </font><font color=#cc0000>DownMassIKJ</font>   (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/DOWNMASSIKJ.html' TARGET='index'>4</A><a name='4885'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4886'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4887'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4888'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4889'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4890'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4891'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4892'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4893'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4894'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4895'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4896'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='4897'></font>
        emethod, evalue)                         <font color=#447700>! extrapolation method<a name='4898'></font>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#DOWNMASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_9">, only: c2n_massikj<a name='4899'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#DOWNMASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_9"><a name='4900'>
     implicit none<a name='4901'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4902'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4903'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4904'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4905'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4906'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4907'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4908'>
          shw,ipos,jpos,nri,nrj,emethod<a name='4909'>
     real, intent(in) :: evalue<a name='4910'>
<a name='4911'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4912'>
     REAL,DIMENSION(cims:cime,ckms:ckme,cjms:cjme),   INTENT(IN)           :: CFLD<a name='4913'>
     REAL,DIMENSION(nims:nime,nkms:nkme,njms:njme),   INTENT(INOUT)          :: nfld<a name='4914'>
<a name='4915'>
     if(nkts==nkte) &amp;<a name='4916'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#DOWNMASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1326">('IKJ 2D interpolation of an IJ array is not implemented (and makes no sense anyway).  Use DownCopy instead.')<a name='4917'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_MASSIKJ'>c2n_massikj</A><A href='../../html_code/share/interp_fcn.F.html#DOWNMASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_MASSIKJ_1">(IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4,   &amp;<a name='4918'>
          cfld,nfld,iinfo,winfo,imask,          &amp;<a name='4919'>
          emethod, evalue,                      &amp;<a name='4920'>
          cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='4921'>
          nids, nide, njds, njde, nkds, nkde,   &amp;<a name='4922'>
          nims, nime, njms, njme, nkms, nkme,   &amp;<a name='4923'>
          nits, nite, njts, njte, nkts, nkte)<a name='4924'>
   end subroutine DownMassIKJ<a name='4925'>
<a name='4926'>
<A NAME='UPMASSIKJ'><A href='../../html_code/share/interp_fcn.F.html#UPMASSIKJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4927'>
   <font color=#993300>subroutine </font><font color=#cc0000>UpMassIKJ</font>     (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/UPMASSIKJ.html' TARGET='index'>4</A><a name='4928'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4929'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4930'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4931'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4932'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4933'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4934'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4935'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4936'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4937'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4938'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4939'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios                         <a name='4940'></font>
        emethod, evalue)                         <font color=#447700>! extrapolation method<a name='4941'></font>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#UPMASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_10"><a name='4942'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#UPMASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_10">, only: n2c_massikj, n2c_copy2d<a name='4943'>
     implicit none<a name='4944'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4945'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4946'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4947'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4948'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4949'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4950'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4951'>
          shw,ipos,jpos,nri,nrj, emethod<a name='4952'>
     real, intent(in) :: evalue<a name='4953'>
<a name='4954'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='4955'>
     REAL,DIMENSION(cims:cime,ckms:ckme,cjms:cjme),   INTENT(OUT)           :: CFLD<a name='4956'>
     REAL,DIMENSION(nims:nime,nkms:nkme,njms:njme),   INTENT(IN)          :: nfld<a name='4957'>
<a name='4958'>
     if(nkts==nkte) then<a name='4959'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_COPY2D'>n2c_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#UPMASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_COPY2D_1">(&amp;<a name='4960'>
             cfld,nfld,ipos,jpos,                   &amp;<a name='4961'>
             cids, cide, cjds, cjde,   &amp;<a name='4962'>
             cims, cime, cjms, cjme,   &amp;<a name='4963'>
             cits, cite, cjts, cjte,   &amp;<a name='4964'>
             nids, nide, njds, njde,   &amp;<a name='4965'>
             nims, nime, njms, njme,   &amp;<a name='4966'>
             nits, nite, njts, njte, .true.)<a name='4967'>
     else<a name='4968'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_MASSIKJ'>n2c_massikj</A><A href='../../html_code/share/interp_fcn.F.html#UPMASSIKJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_MASSIKJ_1">(&amp;<a name='4969'>
             cfld,nfld,parent_iinfo,parent_winfo,  &amp;<a name='4970'>
             ipos,jpos,emethod, evalue,            &amp;<a name='4971'>
             cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='4972'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='4973'>
             cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='4974'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='4975'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='4976'>
             nits, nite, njts, njte, nkts, nkte)<a name='4977'>
     endif<a name='4978'>
   end subroutine UpMassIKJ<a name='4979'>
<a name='4980'>
<A NAME='UPMASS'><A href='../../html_code/share/interp_fcn.F.html#UPMASS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4981'>
   <font color=#993300>subroutine </font><font color=#cc0000>UpMass</font>        (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/UPMASS.html' TARGET='index'>4</A><a name='4982'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='4983'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='4984'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='4985'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='4986'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='4987'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='4988'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='4989'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='4990'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='4991'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='4992'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='4993'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios                         <a name='4994'></font>
        emethod, evalue)                         <font color=#447700>! extrapolation method<a name='4995'></font>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#UPMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_11"><a name='4996'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#UPMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_11">, only: n2c_mass, n2c_copy2d<a name='4997'>
     implicit none<a name='4998'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='4999'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5000'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5001'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5002'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5003'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5004'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5005'>
          shw,ipos,jpos,nri,nrj, emethod<a name='5006'>
     real, intent(in) :: evalue<a name='5007'>
<a name='5008'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='5009'>
     REAL,DIMENSION(cims:cime,cjms:cjme,ckms:ckme),   INTENT(OUT)           :: CFLD<a name='5010'>
     REAL,DIMENSION(nims:nime,njms:njme,nkms:nkme),   INTENT(IN)          :: nfld<a name='5011'>
<a name='5012'>
     if(nkts==nkte) then<a name='5013'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_COPY2D'>n2c_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#UPMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_COPY2D_2">(&amp;<a name='5014'>
             cfld,nfld,ipos,jpos,                   &amp;<a name='5015'>
             cids, cide, cjds, cjde,   &amp;<a name='5016'>
             cims, cime, cjms, cjme,   &amp;<a name='5017'>
             cits, cite, cjts, cjte,   &amp;<a name='5018'>
             nids, nide, njds, njde,   &amp;<a name='5019'>
             nims, nime, njms, njme,   &amp;<a name='5020'>
             nits, nite, njts, njte, .true.)<a name='5021'>
     else<a name='5022'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_MASS'>n2c_mass</A><A href='../../html_code/share/interp_fcn.F.html#UPMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_MASS_1">(&amp;<a name='5023'>
             cfld,nfld,parent_iinfo,parent_winfo,  &amp;<a name='5024'>
             ipos,jpos,emethod, evalue,            &amp;<a name='5025'>
             cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='5026'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5027'>
             cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='5028'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5029'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5030'>
             nits, nite, njts, njte, nkts, nkte)<a name='5031'>
     endif<a name='5032'>
   end subroutine UpMass<a name='5033'>
<a name='5034'>
<A NAME='UPCOPY'><A href='../../html_code/share/interp_fcn.F.html#UPCOPY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5035'>
   <font color=#993300>subroutine </font><font color=#cc0000>UpCopy</font>         (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/UPCOPY.html' TARGET='index'>3</A><a name='5036'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5037'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5038'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5039'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5040'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5041'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5042'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5043'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='5044'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5045'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5046'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5047'></font>
        nri, nrj)                                <font color=#447700>! nest ratios                         <a name='5048'></font>
<a name='5049'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#UPCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_12">, only: n2c_copy3d, n2c_copy2d<a name='5050'>
     implicit none<a name='5051'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='5052'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5053'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5054'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5055'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5056'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5057'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5058'>
          shw,ipos,jpos,nri,nrj<a name='5059'>
<a name='5060'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='5061'>
     REAL,DIMENSION(cims:cime,cjms:cjme,ckms:ckme),   INTENT(OUT)           :: CFLD<a name='5062'>
     REAL,DIMENSION(nims:nime,njms:njme,nkms:nkme),   INTENT(IN)          :: nfld<a name='5063'>
<a name='5064'>
     if(nkts==nkte) then<a name='5065'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_COPY2D'>n2c_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#UPCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_COPY2D_3">(&amp;<a name='5066'>
             cfld,nfld,ipos,jpos,                   &amp;<a name='5067'>
             cids, cide, cjds, cjde,   &amp;<a name='5068'>
             cims, cime, cjms, cjme,   &amp;<a name='5069'>
             cits, cite, cjts, cjte,   &amp;<a name='5070'>
             nids, nide, njds, njde,   &amp;<a name='5071'>
             nims, nime, njms, njme,   &amp;<a name='5072'>
             nits, nite, njts, njte, .true.)<a name='5073'>
     else<a name='5074'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_COPY3D'>n2c_copy3d</A><A href='../../html_code/share/interp_fcn.F.html#UPCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_COPY3D_1">(&amp;<a name='5075'>
             cfld,nfld,ipos,jpos,                   &amp;<a name='5076'>
             cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='5077'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5078'>
             cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='5079'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5080'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5081'>
             nits, nite, njts, njte, nkts, nkte, .true.)<a name='5082'>
     endif<a name='5083'>
   end subroutine UpCopy<a name='5084'>
<a name='5085'>
<A NAME='UPMAX'><A href='../../html_code/share/interp_fcn.F.html#UPMAX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5086'>
   <font color=#993300>subroutine </font><font color=#cc0000>UpMax</font>          (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/UPMAX.html' TARGET='index'>3</A><a name='5087'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5088'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5089'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5090'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5091'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5092'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5093'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5094'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='5095'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5096'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5097'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5098'></font>
        nri, nrj)                                <font color=#447700>! nest ratios                         <a name='5099'></font>
<a name='5100'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#UPMAX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_13">, only: n2c_max3d, n2c_max2d<a name='5101'>
     implicit none<a name='5102'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='5103'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5104'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5105'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5106'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5107'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5108'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5109'>
          shw,ipos,jpos,nri,nrj<a name='5110'>
<a name='5111'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='5112'>
     REAL,DIMENSION(cims:cime,cjms:cjme,ckms:ckme),   INTENT(OUT)           :: CFLD<a name='5113'>
     REAL,DIMENSION(nims:nime,njms:njme,nkms:nkme),   INTENT(IN)          :: nfld<a name='5114'>
<a name='5115'>
     if(nkts==nkte) then<a name='5116'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_MAX2D'>n2c_max2d</A><A href='../../html_code/share/interp_fcn.F.html#UPMAX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_MAX2D_1">(&amp;<a name='5117'>
             cfld,nfld,ipos,jpos,                   &amp;<a name='5118'>
             cids, cide, cjds, cjde,   &amp;<a name='5119'>
             cims, cime, cjms, cjme,   &amp;<a name='5120'>
             cits, cite, cjts, cjte,   &amp;<a name='5121'>
             nids, nide, njds, njde,   &amp;<a name='5122'>
             nims, nime, njms, njme,   &amp;<a name='5123'>
             nits, nite, njts, njte, .true.)<a name='5124'>
     else<a name='5125'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_MAX3D'>n2c_max3d</A><A href='../../html_code/share/interp_fcn.F.html#UPMAX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_MAX3D_1">(&amp;<a name='5126'>
             cfld,nfld,ipos,jpos,                   &amp;<a name='5127'>
             cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='5128'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5129'>
             cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='5130'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5131'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5132'>
             nits, nite, njts, njte, nkts, nkte, .true.)<a name='5133'>
     endif<a name='5134'>
   end subroutine UpMax<a name='5135'>
<a name='5136'>
<A NAME='DOWNCOPY'><A href='../../html_code/share/interp_fcn.F.html#DOWNCOPY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5137'>
   <font color=#993300>subroutine </font><font color=#cc0000>DownCopy</font>      (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/DOWNCOPY.html' TARGET='index'>4</A><a name='5138'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5139'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5140'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5141'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5142'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5143'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5144'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5145'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='5146'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5147'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5148'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5149'></font>
        nri, nrj)                                <font color=#447700>! nest ratios                         <a name='5150'></font>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#DOWNCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_12"><a name='5151'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#DOWNCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_14">, only: c2n_copy3d, c2n_copy2d<a name='5152'>
     implicit none<a name='5153'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='5154'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5155'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5156'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5157'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5158'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5159'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5160'>
          shw,ipos,jpos,nri,nrj<a name='5161'>
<a name='5162'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='5163'>
     REAL,DIMENSION(cims:cime,cjms:cjme,ckms:ckme),   INTENT(IN)           :: CFLD<a name='5164'>
     REAL,DIMENSION(nims:nime,njms:njme,nkms:nkme),   INTENT(INOUT)          :: nfld<a name='5165'>
<a name='5166'>
     if(nkts==nkte) then<a name='5167'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY2D'>c2n_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#DOWNCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_COPY2D_2">(IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4,  &amp;<a name='5168'>
             cfld,nfld,imask,                &amp;<a name='5169'>
             cims, cime, cjms, cjme,   &amp;<a name='5170'>
             nids, nide, njds, njde,   &amp;<a name='5171'>
             nims, nime, njms, njme,   &amp;<a name='5172'>
             nits, nite, njts, njte, .true.)<a name='5173'>
     else<a name='5174'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY3D'>c2n_copy3d</A><A href='../../html_code/share/interp_fcn.F.html#DOWNCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_COPY3D_1">(IIH,JJH,HBWGT1,HBWGT2,HBWGT3,HBWGT4,  &amp;<a name='5175'>
             cfld,nfld,imask,                &amp;<a name='5176'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5177'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5178'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5179'>
             nits, nite, njts, njte, nkts, nkte, .true.)<a name='5180'>
     endif<a name='5181'>
   end subroutine DownCopy<a name='5182'>
<a name='5183'>
<A NAME='UPVEL'><A href='../../html_code/share/interp_fcn.F.html#UPVEL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5184'>
   <font color=#993300>subroutine </font><font color=#cc0000>UpVel</font>   (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/UPVEL.html' TARGET='index'>3</A><a name='5185'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5186'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5187'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5188'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5189'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5190'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5191'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5192'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='5193'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5194'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5195'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5196'></font>
        nri, nrj)                                <font color=#447700>! nest ratios                         <a name='5197'></font>
<a name='5198'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#UPVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_15">, only: n2c_copy3d, n2c_copy2d<a name='5199'>
     implicit none<a name='5200'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='5201'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5202'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5203'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5204'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5205'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5206'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5207'>
          shw,ipos,jpos,nri,nrj<a name='5208'>
<a name='5209'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='5210'>
     REAL,DIMENSION(cims:cime,cjms:cjme,ckms:ckme),   INTENT(OUT)           :: CFLD<a name='5211'>
     REAL,DIMENSION(nims:nime,njms:njme,nkms:nkme),   INTENT(IN)          :: nfld<a name='5212'>
<a name='5213'>
     if(nkts==nkte) then<a name='5214'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_COPY2D'>n2c_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#UPVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_COPY2D_4">( cfld,nfld,ipos,jpos,             &amp;<a name='5215'>
             cids, cide, cjds, cjde,   &amp;<a name='5216'>
             cims, cime, cjms, cjme,   &amp;<a name='5217'>
             cits, cite, cjts, cjte,   &amp;<a name='5218'>
             nids, nide, njds, njde,   &amp;<a name='5219'>
             nims, nime, njms, njme,   &amp;<a name='5220'>
             nits, nite, njts, njte, .false.)<a name='5221'>
     else<a name='5222'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#N2C_COPY3D'>n2c_copy3d</A><A href='../../html_code/share/interp_fcn.F.html#UPVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N2C_COPY3D_2">(&amp;<a name='5223'>
             cfld,nfld,ipos,jpos,                   &amp;<a name='5224'>
             cids, cide, cjds, cjde, ckds, ckde,   &amp;<a name='5225'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5226'>
             cits, cite, cjts, cjte, ckts, ckte,   &amp;<a name='5227'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5228'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5229'>
             nits, nite, njts, njte, nkts, nkte, .false.)<a name='5230'>
     endif<a name='5231'>
   end subroutine UpVel<a name='5232'>
<a name='5233'>
<A NAME='DOWNVEL'><A href='../../html_code/share/interp_fcn.F.html#DOWNVEL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5234'>
   <font color=#993300>subroutine </font><font color=#cc0000>DownVel</font>      (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/DOWNVEL.html' TARGET='index'>4</A><a name='5235'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5236'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5237'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5238'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5239'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5240'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5241'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5242'>
        shw,                                  &amp;  <font color=#447700>! stencil half width for interp<a name='5243'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5244'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5245'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5246'></font>
        nri, nrj)                                <font color=#447700>! nest ratios                         <a name='5247'></font>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#DOWNVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_13"><a name='5248'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#DOWNVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_16">, only: c2n_copy3d, c2n_copy2d<a name='5249'>
     implicit none<a name='5250'>
     LOGICAL,INTENT(IN) :: xstag, ystag<a name='5251'>
     INTEGER,INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5252'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5253'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5254'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5255'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5256'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5257'>
          shw,ipos,jpos,nri,nrj<a name='5258'>
<a name='5259'>
     INTEGER,DIMENSION(nims:nime,njms:njme),          INTENT(IN)           :: IMASK<a name='5260'>
     REAL,DIMENSION(cims:cime,cjms:cjme,ckms:ckme),   INTENT(IN)           :: CFLD<a name='5261'>
     REAL,DIMENSION(nims:nime,njms:njme,nkms:nkme),   INTENT(INOUT)          :: nfld<a name='5262'>
<a name='5263'>
     if(nkts==nkte) then<a name='5264'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY2D'>c2n_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#DOWNVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_COPY2D_3">(IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4,  &amp;<a name='5265'>
             cfld,nfld,imask,                &amp;<a name='5266'>
             cims, cime, cjms, cjme,   &amp;<a name='5267'>
             nids, nide, njds, njde,   &amp;<a name='5268'>
             nims, nime, njms, njme,   &amp;<a name='5269'>
             nits, nite, njts, njte, .false.)<a name='5270'>
     else<a name='5271'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2N_COPY3D'>c2n_copy3d</A><A href='../../html_code/share/interp_fcn.F.html#DOWNVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2N_COPY3D_2">(IIV,JJV,VBWGT1,VBWGT2,VBWGT3,VBWGT4,  &amp;<a name='5272'>
             cfld,nfld,imask,                &amp;<a name='5273'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5274'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5275'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5276'>
             nits, nite, njts, njte, nkts, nkte, .false.)<a name='5277'>
     endif<a name='5278'>
   end subroutine DownVel<a name='5279'>
<a name='5280'>
<A NAME='BDYMASS'><A href='../../html_code/share/interp_fcn.F.html#BDYMASS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5281'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>BdyMass</font> (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/BDYMASS.html' TARGET='index'>6</A><a name='5282'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5283'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5284'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5285'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5286'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5287'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5288'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5289'>
        shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5290'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5291'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5292'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5293'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='5294'></font>
        c_bxs,n_bxs,                          &amp;<a name='5295'>
        c_bxe,n_bxe,                          &amp;<a name='5296'>
        c_bys,n_bys,                          &amp;<a name='5297'>
        c_bye,n_bye,                          &amp;<a name='5298'>
        c_btxs,n_btxs,                        &amp;<a name='5299'>
        c_btxe,n_btxe,                        &amp;<a name='5300'>
        c_btys,n_btys,                        &amp;<a name='5301'>
        c_btye,n_btye,                        &amp;<a name='5302'>
        emethod,evalue)                          <font color=#447700>! Extrapolation information<a name='5303'></font>
<a name='5304'>
     <font color=#447700>!     use module_state_description<a name='5305'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#BDYMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_188"><a name='5306'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#BDYMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_98"><a name='5307'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#BDYMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_14"><a name='5308'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#BDYMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_17">, only: c2b_mass, c2b_copy2d<a name='5309'>
<a name='5310'>
     IMPLICIT NONE<a name='5311'>
     integer, parameter :: bdyw = 1<a name='5312'>
<a name='5313'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5314'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5315'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5316'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5317'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5318'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5319'>
          shw,                                  &amp;<a name='5320'>
          ipos, jpos,                           &amp;<a name='5321'>
          nri, nrj, emethod<a name='5322'>
     real, intent(in) :: evalue<a name='5323'>
<a name='5324'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='5325'>
<a name='5326'>
     REAL, DIMENSION ( cims:cime, cjms:cjme, ckms:ckme ) :: cfld,ccwm<a name='5327'>
     REAL, DIMENSION ( nims:nime, njms:njme, nkms:nkme ) :: nfld,ncwm<a name='5328'>
     <font color=#447700>!<a name='5329'></font>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='5330'>
<a name='5331'>
     <font color=#447700>! Output field boundary info:<a name='5332'></font>
     real,dimension(nims:nime,nkms:nkme,bdyw) :: n_bys,n_bye<a name='5333'>
     real,dimension(njms:njme,nkms:nkme,bdyw) :: n_bxs,n_bxe<a name='5334'>
<a name='5335'>
     <font color=#447700>! Unused parameters:<a name='5336'></font>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: c_bxs,c_bxe,c_bys,c_bye<a name='5337'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: c_btxs,n_btxs,c_btxe,n_btxe,c_btys,n_btys,c_btye,n_btye<a name='5338'>
<a name='5339'>
     if(nkts==nkte) then<a name='5340'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_COPY2D'>c2b_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#BDYMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_COPY2D_1">(iih,jjh,                   &amp;<a name='5341'>
             hbwgt1,hbwgt2,hbwgt3,hbwgt4,          &amp;<a name='5342'>
             cfld,                                 &amp;<a name='5343'>
             n_bxs, n_bxe, n_bys, n_bye,           &amp;<a name='5344'>
             cims, cime, cjms, cjme,   &amp;<a name='5345'>
             nids, nide, njds, njde,   &amp;<a name='5346'>
             nims, nime, njms, njme,   &amp;<a name='5347'>
             nits, nite, njts, njte,   &amp;<a name='5348'>
             .true.)<a name='5349'>
     else<a name='5350'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_MASS'>c2b_mass</A><A href='../../html_code/share/interp_fcn.F.html#BDYMASS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_MASS_1">(iih,jjh,                     &amp;<a name='5351'>
             hbwgt1,hbwgt2,hbwgt3,hbwgt4,          &amp;<a name='5352'>
             cfld,                                 &amp;<a name='5353'>
             iinfo_bxs,iinfo_bxe,iinfo_bys,iinfo_bye,          &amp;<a name='5354'>
             winfo_bxs,winfo_bxe,winfo_bys,winfo_bye,          &amp;<a name='5355'>
             n_bxs, n_bxe, n_bys, n_bye,           &amp;<a name='5356'>
             emethod, evalue,                      &amp;<a name='5357'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5358'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5359'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5360'>
             nits, nite, njts, njte, nkts, nkte)<a name='5361'>
     endif<a name='5362'>
   END SUBROUTINE BdyMass<a name='5363'>
<a name='5364'>
   <font color=#447700>!<a name='5365'></font>
   <font color=#447700>!--------------------------------------------------------------------------------------<a name='5366'></font>
   <font color=#447700>!<a name='5367'></font>
<A NAME='BDYCOPY'><A href='../../html_code/share/interp_fcn.F.html#BDYCOPY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5368'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>BdyCopy</font>  (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/BDYCOPY.html' TARGET='index'>6</A><a name='5369'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5370'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5371'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5372'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5373'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5374'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5375'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5376'>
        shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5377'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5378'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5379'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5380'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='5381'></font>
        c_bxs,n_bxs,                          &amp;<a name='5382'>
        c_bxe,n_bxe,                          &amp;<a name='5383'>
        c_bys,n_bys,                          &amp;<a name='5384'>
        c_bye,n_bye,                          &amp;<a name='5385'>
        c_btxs,n_btxs,                        &amp;<a name='5386'>
        c_btxe,n_btxe,                        &amp;<a name='5387'>
        c_btys,n_btys,                        &amp;<a name='5388'>
        c_btye,n_btye)<a name='5389'>
<a name='5390'>
     <font color=#447700>!     use module_state_description<a name='5391'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#BDYCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_189"><a name='5392'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#BDYCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_99"><a name='5393'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#BDYCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_18">, only: c2b_copy3d, c2b_copy2d<a name='5394'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#BDYCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_15"><a name='5395'>
<a name='5396'>
     IMPLICIT NONE<a name='5397'>
     integer, parameter :: bdyw = 1<a name='5398'>
<a name='5399'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5400'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5401'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5402'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5403'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5404'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5405'>
          shw,                                  &amp;<a name='5406'>
          ipos, jpos,                           &amp;<a name='5407'>
          nri, nrj<a name='5408'>
<a name='5409'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='5410'>
<a name='5411'>
     REAL, DIMENSION ( cims:cime, cjms:cjme, ckms:ckme ) :: cfld<a name='5412'>
     REAL, DIMENSION ( nims:nime, njms:njme, nkms:nkme ) :: nfld<a name='5413'>
     <font color=#447700>!<a name='5414'></font>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='5415'>
<a name='5416'>
     <font color=#447700>! Output field boundary info:<a name='5417'></font>
     real,dimension(nims:nime,nkms:nkme,bdyw) :: n_bys,n_bye<a name='5418'>
     real,dimension(njms:njme,nkms:nkme,bdyw) :: n_bxs,n_bxe<a name='5419'>
<a name='5420'>
     <font color=#447700>! Nest-parent horizontal interpolation information:<a name='5421'></font>
     <font color=#447700>! Unused parameters:<a name='5422'></font>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: c_bxs,c_bxe,c_bys,c_bye<a name='5423'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: c_btxs,n_btxs,c_btxe,n_btxe,c_btys,n_btys,c_btye,n_btye<a name='5424'>
<a name='5425'>
     if(nkts==nkte) then<a name='5426'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_COPY2D'>c2b_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#BDYCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_COPY2D_2">(iiv,jjv,                   &amp;<a name='5427'>
             vbwgt1,vbwgt2,vbwgt3,vbwgt4,          &amp;<a name='5428'>
             cfld,                                 &amp;<a name='5429'>
             n_bxs, n_bxe, n_bys, n_bye,           &amp;<a name='5430'>
             cims, cime, cjms, cjme,   &amp;<a name='5431'>
             nids, nide, njds, njde,   &amp;<a name='5432'>
             nims, nime, njms, njme,   &amp;<a name='5433'>
             nits, nite, njts, njte, .false.)<a name='5434'>
     else<a name='5435'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_COPY3D'>c2b_copy3d</A><A href='../../html_code/share/interp_fcn.F.html#BDYCOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_COPY3D_1">(iih,jjh,                     &amp;<a name='5436'>
             hbwgt1,hbwgt2,hbwgt3,hbwgt4,          &amp;<a name='5437'>
             cfld,                                 &amp;<a name='5438'>
             n_bxs, n_bxe, n_bys, n_bye,           &amp;<a name='5439'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5440'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5441'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5442'>
             nits, nite, njts, njte, nkts, nkte, .false.)<a name='5443'>
     endif<a name='5444'>
<a name='5445'>
   END SUBROUTINE BdyCopy<a name='5446'>
   <font color=#447700>!<a name='5447'></font>
   <font color=#447700>!--------------------------------------------------------------------------------------<a name='5448'></font>
   <font color=#447700>!<a name='5449'></font>
<A NAME='NOINTERP'><A href='../../html_code/share/interp_fcn.F.html#NOINTERP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5450'>
   <font color=#993300>subroutine </font><font color=#cc0000>NoInterp</font>()<a name='5451'>
   end subroutine NoInterp<a name='5452'>
   <font color=#447700>!<a name='5453'></font>
   <font color=#447700>!--------------------------------------------------------------------------------------<a name='5454'></font>
   <font color=#447700>!<a name='5455'></font>
<A NAME='BDYVEL'><A href='../../html_code/share/interp_fcn.F.html#BDYVEL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5456'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>BdyVel</font>  (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/BDYVEL.html' TARGET='index'>6</A><a name='5457'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5458'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5459'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5460'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5461'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5462'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5463'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5464'>
        shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5465'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5466'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5467'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5468'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='5469'></font>
        c_bxs,n_bxs,                          &amp;<a name='5470'>
        c_bxe,n_bxe,                          &amp;<a name='5471'>
        c_bys,n_bys,                          &amp;<a name='5472'>
        c_bye,n_bye,                          &amp;<a name='5473'>
        c_btxs,n_btxs,                        &amp;<a name='5474'>
        c_btxe,n_btxe,                        &amp;<a name='5475'>
        c_btys,n_btys,                        &amp;<a name='5476'>
        c_btye,n_btye)<a name='5477'>
<a name='5478'>
     <font color=#447700>!     use module_state_description<a name='5479'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#BDYVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_190"><a name='5480'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#BDYVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_100"><a name='5481'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#BDYVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_19">, only: c2b_copy3d, c2b_copy2d<a name='5482'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#BDYVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_16"><a name='5483'>
<a name='5484'>
     IMPLICIT NONE<a name='5485'>
     integer, parameter :: bdyw = 1<a name='5486'>
<a name='5487'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5488'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5489'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5490'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5491'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5492'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5493'>
          shw,                                  &amp;<a name='5494'>
          ipos, jpos,                           &amp;<a name='5495'>
          nri, nrj<a name='5496'>
<a name='5497'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='5498'>
<a name='5499'>
     REAL, DIMENSION ( cims:cime, cjms:cjme, ckms:ckme ) :: cfld<a name='5500'>
     REAL, DIMENSION ( nims:nime, njms:njme, nkms:nkme ) :: nfld<a name='5501'>
     <font color=#447700>!<a name='5502'></font>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='5503'>
<a name='5504'>
     <font color=#447700>! Output field boundary info:<a name='5505'></font>
     real,dimension(nims:nime,nkms:nkme,bdyw) :: n_bys,n_bye<a name='5506'>
     real,dimension(njms:njme,nkms:nkme,bdyw) :: n_bxs,n_bxe<a name='5507'>
<a name='5508'>
     <font color=#447700>! Nest-parent horizontal interpolation information:<a name='5509'></font>
     <font color=#447700>! Unused parameters:<a name='5510'></font>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: c_bxs,c_bxe,c_bys,c_bye<a name='5511'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: c_btxs,n_btxs,c_btxe,n_btxe,c_btys,n_btys,c_btye,n_btye<a name='5512'>
<a name='5513'>
     if(nkts==nkte) then<a name='5514'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_COPY2D'>c2b_copy2d</A><A href='../../html_code/share/interp_fcn.F.html#BDYVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_COPY2D_3">(iiv,jjv,                     &amp;<a name='5515'>
             vbwgt1,vbwgt2,vbwgt3,vbwgt4,          &amp;<a name='5516'>
             cfld,                                 &amp;<a name='5517'>
             n_bxs, n_bxe, n_bys, n_bye,           &amp;<a name='5518'>
             cims, cime, cjms, cjme,   &amp;<a name='5519'>
             nids, nide, njds, njde,   &amp;<a name='5520'>
             nims, nime, njms, njme,   &amp;<a name='5521'>
             nits, nite, njts, njte, .false.)<a name='5522'>
     else<a name='5523'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_COPY3D'>c2b_copy3d</A><A href='../../html_code/share/interp_fcn.F.html#BDYVEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_COPY3D_2">(iiv,jjv,                     &amp;<a name='5524'>
             vbwgt1,vbwgt2,vbwgt3,vbwgt4,          &amp;<a name='5525'>
             cfld,                                 &amp;<a name='5526'>
             n_bxs, n_bxe, n_bys, n_bye,           &amp;<a name='5527'>
             cims, cime, cjms, cjme, ckms, ckme,   &amp;<a name='5528'>
             nids, nide, njds, njde, nkds, nkde,   &amp;<a name='5529'>
             nims, nime, njms, njme, nkms, nkme,   &amp;<a name='5530'>
             nits, nite, njts, njte, nkts, nkte, .false.)<a name='5531'>
     endif<a name='5532'>
   END SUBROUTINE BdyVel<a name='5533'>
   <font color=#447700>!<a name='5534'></font>
   <font color=#447700>!--------------------------------------------------------------------------------------<a name='5535'></font>
   <font color=#447700>!<a name='5536'></font>
<A NAME='BDYNEAR'><A href='../../html_code/share/interp_fcn.F.html#BDYNEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5537'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>BdyNear</font> (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/BDYNEAR.html' TARGET='index'>6</A><a name='5538'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5539'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5540'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5541'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5542'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5543'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5544'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5545'>
        shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5546'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5547'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5548'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5549'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='5550'></font>
        c_bxs,n_bxs,                          &amp;<a name='5551'>
        c_bxe,n_bxe,                          &amp;<a name='5552'>
        c_bys,n_bys,                          &amp;<a name='5553'>
        c_bye,n_bye,                          &amp;<a name='5554'>
        c_btxs,n_btxs,                        &amp;<a name='5555'>
        c_btxe,n_btxe,                        &amp;<a name='5556'>
        c_btys,n_btys,                        &amp;<a name='5557'>
        c_btye,n_btye)<a name='5558'>
<a name='5559'>
     <font color=#447700>!     use module_state_description<a name='5560'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#BDYNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_191"><a name='5561'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#BDYNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_101"><a name='5562'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#BDYNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_20">, only: c2b_near2d<a name='5563'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#BDYNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_17"><a name='5564'>
<a name='5565'>
     IMPLICIT NONE<a name='5566'>
     integer, parameter :: bdyw = 1<a name='5567'>
<a name='5568'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5569'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5570'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5571'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5572'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5573'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5574'>
          shw,                                  &amp;<a name='5575'>
          ipos, jpos,                           &amp;<a name='5576'>
          nri, nrj<a name='5577'>
<a name='5578'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='5579'>
<a name='5580'>
     REAL, DIMENSION ( cims:cime, cjms:cjme ) :: cfld<a name='5581'>
     REAL, DIMENSION ( nims:nime, njms:njme ) :: nfld<a name='5582'>
<a name='5583'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='5584'>
<a name='5585'>
     <font color=#447700>! Output field boundary info:<a name='5586'></font>
     real,dimension(nims:nime,1,bdyw) :: n_bys,n_bye<a name='5587'>
     real,dimension(njms:njme,1,bdyw) :: n_bxs,n_bxe<a name='5588'>
<a name='5589'>
     <font color=#447700>! Unused parameters:<a name='5590'></font>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: c_bxs,c_bxe,c_bys,c_bye<a name='5591'>
     REAL,  DIMENSION( * ), INTENT(INOUT) :: c_btxs,n_btxs,c_btxe,n_btxe,c_btys,n_btys,c_btye,n_btye<a name='5592'>
<a name='5593'>
     if(nkts/=nkte) &amp;<a name='5594'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#BDYNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1327">('3D boundary nearest neighbor interpolation is not implemented.')<a name='5595'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_NEAR2D'>c2b_near2d</A><A href='../../html_code/share/interp_fcn.F.html#BDYNEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_NEAR2D_1">(hnear_i,hnear_j,cfld,      &amp;<a name='5596'>
          n_bxs, n_bxe, n_bys, n_bye,           &amp;<a name='5597'>
          cims, cime, cjms, cjme,   &amp;<a name='5598'>
          nids, nide, njds, njde,   &amp;<a name='5599'>
          nims, nime, njms, njme,   &amp;<a name='5600'>
          nits, nite, njts, njte)<a name='5601'>
<a name='5602'>
   END SUBROUTINE BdyNear<a name='5603'>
<a name='5604'>
<A NAME='BDYINEAR'><A href='../../html_code/share/interp_fcn.F.html#BDYINEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5605'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>BdyINear</font> (cfld,                                 &amp;  <font color=#447700>! CD field,<A href='../../call_from/BDYINEAR.html' TARGET='index'>6</A><a name='5606'></font>
        cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5607'>
        cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5608'>
        cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5609'>
        nfld,                                 &amp;  <font color=#447700>! ND field<a name='5610'></font>
        nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5611'>
        nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5612'>
        nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5613'>
        shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5614'></font>
        imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5615'></font>
        xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5616'></font>
        ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5617'></font>
        nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='5618'></font>
        c_bxs,n_bxs,                          &amp;<a name='5619'>
        c_bxe,n_bxe,                          &amp;<a name='5620'>
        c_bys,n_bys,                          &amp;<a name='5621'>
        c_bye,n_bye,                          &amp;<a name='5622'>
        c_btxs,n_btxs,                        &amp;<a name='5623'>
        c_btxe,n_btxe,                        &amp;<a name='5624'>
        c_btys,n_btys,                        &amp;<a name='5625'>
        c_btye,n_btye)<a name='5626'>
<a name='5627'>
     <font color=#447700>!     use module_state_description<a name='5628'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#BDYINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_192"><a name='5629'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#BDYINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_102"><a name='5630'>
     use <A href='../../html_code/share/module_interp_nmm.F.html#MODULE_INTERP_NMM'>module_interp_nmm</A><A href='../../html_code/share/interp_fcn.F.html#BDYINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_NMM_21">, only: c2b_inear2d<a name='5631'>
     use <A href='../../html_code/share/module_interp_store.F.html#MODULE_INTERP_STORE'>module_interp_store</A><A href='../../html_code/share/interp_fcn.F.html#BDYINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERP_STORE_18"><a name='5632'>
<a name='5633'>
     IMPLICIT NONE<a name='5634'>
     integer, parameter :: bdyw = 1<a name='5635'>
<a name='5636'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5637'>
          cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5638'>
          cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5639'>
          nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5640'>
          nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5641'>
          nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5642'>
          shw,                                  &amp;<a name='5643'>
          ipos, jpos,                           &amp;<a name='5644'>
          nri, nrj<a name='5645'>
<a name='5646'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='5647'>
<a name='5648'>
     INTEGER, DIMENSION ( cims:cime, cjms:cjme ) :: cfld<a name='5649'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: nfld<a name='5650'>
<a name='5651'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='5652'>
<a name='5653'>
     <font color=#447700>! Output field boundary info:<a name='5654'></font>
     integer,dimension(nims:nime,1,bdyw) :: n_bys,n_bye<a name='5655'>
     integer,dimension(njms:njme,1,bdyw) :: n_bxs,n_bxe<a name='5656'>
<a name='5657'>
     <font color=#447700>! Unused parameters:<a name='5658'></font>
     integer,  DIMENSION( * ), INTENT(INOUT) :: c_bxs,c_bxe,c_bys,c_bye<a name='5659'>
     integer,  DIMENSION( * ), INTENT(INOUT) :: c_btxs,n_btxs,c_btxe,n_btxe,c_btys,n_btys,c_btye,n_btye<a name='5660'>
<a name='5661'>
     if(nkts/=nkte) &amp;<a name='5662'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#BDYINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1328">('3D boundary nearest neighbor interpolation is not implemented.')<a name='5663'>
     call <A href='../../html_code/share/module_interp_nmm.F.html#C2B_INEAR2D'>c2b_inear2d</A><A href='../../html_code/share/interp_fcn.F.html#BDYINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="C2B_INEAR2D_1">(hnear_i,hnear_j,cfld,      &amp;<a name='5664'>
          n_bxs, n_bxe, n_bys, n_bye,           &amp;<a name='5665'>
          cims, cime, cjms, cjme,   &amp;<a name='5666'>
          nids, nide, njds, njde,   &amp;<a name='5667'>
          nims, nime, njms, njme,   &amp;<a name='5668'>
          nits, nite, njts, njte)<a name='5669'>
<a name='5670'>
   END SUBROUTINE BdyINear<a name='5671'>
<a name='5672'>
<font color=#447700>!--------------------------------------------------------------------------------------<a name='5673'></font>
<font color=#447700>! End of Sam's doing<a name='5674'></font>
<font color=#447700>!--------------------------------------------------------------------------------------<a name='5675'></font>
<a name='5676'>
#endif<a name='5677'>
<a name='5678'>
<font color=#447700>! Third block of ARW-specific routines<a name='5679'></font>
#if <font color=#447700>! defined(NMM_CORE) || NMM_CORE!=1<a name='5680'></font>
<a name='5681'>
<A NAME='INTERP_MASK_FIELD'><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5682'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_mask_field</font> ( enable,                  &amp;  <font color=#447700>! says whether to allow interpolation or just the bcasts,<A href='../../call_from/INTERP_MASK_FIELD.html' TARGET='index'>4</A><a name='5683'></font>
                                       cfld,                     &amp;  <font color=#447700>! CD field<a name='5684'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5685'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5686'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5687'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='5688'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5689'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5690'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5691'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5692'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5693'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5694'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5695'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='5696'></font>
                           clu, nlu, cflag, nflag ) <a name='5697'>
<a name='5698'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_193"><a name='5699'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_103"><a name='5700'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_172"> , only :  wrf_dm_sum_reals, wrf_dm_sum_integers<a name='5701'>
<a name='5702'>
      IMPLICIT NONE<a name='5703'>
<a name='5704'>
<a name='5705'>
      LOGICAL, INTENT(IN) :: enable<a name='5706'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5707'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5708'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5709'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5710'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5711'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5712'>
                             shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5713'></font>
                             ipos, jpos,                           &amp;<a name='5714'>
                             nri, nrj, cflag, nflag<a name='5715'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='5716'>
<a name='5717'>
      REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='5718'>
      REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='5719'>
      INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='5720'>
<a name='5721'>
      REAL, DIMENSION ( cims:cime, cjms:cjme ) :: clu<a name='5722'>
      REAL, DIMENSION ( nims:nime, njms:njme ) :: nlu<a name='5723'>
<a name='5724'>
      <font color=#447700>! Local<a name='5725'></font>
<a name='5726'>
      INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='5727'>
      INTEGER :: icount, ii , jj , ist , ien , jst , jen , iswater, ierr<a name='5728'>
      REAL :: avg, sum, dx , dy<a name='5729'>
      INTEGER :: icount_water(nkts:nkte), icount_land(nkts:nkte), idummy(nkts:nkte)<a name='5730'>
      REAL :: avg_water(nkts:nkte), avg_land(nkts:nkte), sum_water(nkts:nkte), sum_land(nkts:nkte), dummy(nkts:nkte)<a name='5731'>
      CHARACTER (len=256) :: message<a name='5732'>
      CHARACTER (len=256) :: a_mess<a name='5733'>
<a name='5734'>
      <font color=#447700>!  Find out what the water value is.<a name='5735'></font>
<a name='5736'>
      <font color=#447700>!CALL nl_get_iswater(1,iswater)<a name='5737'></font>
      iswater = nflag<a name='5738'>
<a name='5739'>
      <font color=#447700>!  Right now, only mass point locations permitted.<a name='5740'></font>
<a name='5741'>
      IF ( ( .NOT. xstag) .AND. ( .NOT. ystag ) ) THEN<a name='5742'>
<a name='5743'>
        <font color=#447700>!  Loop over each i,k,j in the nested domain.<a name='5744'></font>
<a name='5745'>
        IF ( enable ) THEN<a name='5746'>
          DO nj = njts, njte<a name='5747'>
            <font color=#447700>! first coarse position equal to or below nest point<a name='5748'></font>
            IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='5749'>
               cj = ( nj + (nrj/2)-1 ) / nrj + jpos -1<a name='5750'>
            ELSE<a name='5751'>
               cj = ( nj + (nrj-1)/2 ) / nrj + jpos -1<a name='5752'>
            END IF<a name='5753'>
            DO nk = nkts, nkte<a name='5754'>
               ck = nk<a name='5755'>
               DO ni = nits, nite<a name='5756'>
                  IF ( imask(ni, nj) .NE. 1 ) cycle<a name='5757'>
                  <font color=#447700>! first coarse position equal to or to the left of nest point<a name='5758'></font>
                  IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='5759'>
                     ci = ( ni + (nri/2)-1 ) / nri + ipos -1<a name='5760'>
                  ELSE<a name='5761'>
                     ci = ( ni + (nri-1)/2 ) / nri + ipos -1<a name='5762'>
                  END IF<a name='5763'>
<a name='5764'>
                  <font color=#447700>!<a name='5765'></font>
                  <font color=#447700>!                    (ci,cj+1)     (ci+1,cj+1)<a name='5766'></font>
                  <font color=#447700>!               -        -------------<a name='5767'></font>
                  <font color=#447700>!         1-dy  |        |           |<a name='5768'></font>
                  <font color=#447700>!               |        |           |<a name='5769'></font>
                  <font color=#447700>!               -        |  *        |<a name='5770'></font>
                  <font color=#447700>!          dy   |        | (ni,nj)   |<a name='5771'></font>
                  <font color=#447700>!               |        |           |<a name='5772'></font>
                  <font color=#447700>!               -        -------------<a name='5773'></font>
                  <font color=#447700>!                    (ci,cj)       (ci+1,cj)<a name='5774'></font>
                  <font color=#447700>!<a name='5775'></font>
                  <font color=#447700>!                        |--|--------|<a name='5776'></font>
                  <font color=#447700>!                         dx  1-dx<a name='5777'></font>
<a name='5778'>
                  <font color=#447700>!  For odd ratios, at (nri+1)/2, we are on the coarse grid point, so dx = 0<a name='5779'></font>
<a name='5780'>
                  IF ( MOD ( nri , 2 ) .EQ. 0 ) THEN<a name='5781'>
                     dx = ( REAL ( MOD ( ni+(nri-1)/2 , nri ) ) + 0.5 ) / REAL ( nri )<a name='5782'>
                  ELSE<a name='5783'>
                     dx =   REAL ( MOD ( ni+(nri-1)/2 , nri ) )         / REAL ( nri )<a name='5784'>
                  END IF<a name='5785'>
                  IF ( MOD ( nrj , 2 ) .EQ. 0 ) THEN<a name='5786'>
                     dy = ( REAL ( MOD ( nj+(nrj-1)/2 , nrj ) ) + 0.5 ) / REAL ( nrj )<a name='5787'>
                  ELSE<a name='5788'>
                     dy =   REAL ( MOD ( nj+(nrj-1)/2 , nrj ) )         / REAL ( nrj )<a name='5789'>
                  END IF<a name='5790'>
<a name='5791'>
                  <font color=#447700>! Nested cell is a water cell.<a name='5792'></font>
                  IF ( ( NINT(nlu(ni, nj)) .EQ. iswater ) ) THEN<a name='5793'>
<a name='5794'>
                     <font color=#447700>! If the surrounding coarse values are all WATER points,<a name='5795'></font>
                     <font color=#447700>! i.e. open water, this is a simple 4-pt interpolation. <a name='5796'></font>
                     <font color=#447700>! If the surrounding coarse values are all LAND points,<a name='5797'></font>
                     <font color=#447700>! i.e. this is a 1-cell lake, we have no better way to <a name='5798'></font>
                     <font color=#447700>! come up with the value than to do a simple 4-pt interpolation.<a name='5799'></font>
<a name='5800'>
                     IF ( ALL( clu(ci:ci+1,cj:cj+1) == iswater ) .OR. &amp;<a name='5801'>
                          ALL( clu(ci:ci+1,cj:cj+1) /= iswater ) ) THEN<a name='5802'>
<a name='5803'>
                       nfld(ni,nk,nj) = ( 1. - dx ) * ( ( 1. - dy ) * cfld(ci  ,ck,cj  )   + &amp;<a name='5804'>
                                                               dy   * cfld(ci  ,ck,cj+1) ) + &amp;<a name='5805'>
                                               dx   * ( ( 1. - dy ) * cfld(ci+1,ck,cj  )   + &amp;<a name='5806'>
                                                               dy   * cfld(ci+1,ck,cj+1) )<a name='5807'>
<a name='5808'>
                     <font color=#447700>!  If there are some land points and some water points, take an average.<a name='5809'></font>
                     ELSE<a name='5810'>
                       icount = 0<a name='5811'>
                       sum = 0<a name='5812'>
                       IF ( NINT(clu(ci  ,cj  )) .EQ. iswater ) THEN<a name='5813'>
                          icount = icount + 1<a name='5814'>
                          sum = sum + cfld(ci  ,ck,cj  )<a name='5815'>
                       END IF<a name='5816'>
                       IF ( NINT(clu(ci+1,cj  )) .EQ. iswater ) THEN<a name='5817'>
                          icount = icount + 1<a name='5818'>
                          sum = sum + cfld(ci+1,ck,cj  )<a name='5819'>
                       END IF<a name='5820'>
                       IF ( NINT(clu(ci  ,cj+1)) .EQ. iswater ) THEN<a name='5821'>
                          icount = icount + 1<a name='5822'>
                          sum = sum + cfld(ci  ,ck,cj+1)<a name='5823'>
                       END IF<a name='5824'>
                       IF ( NINT(clu(ci+1,cj+1)) .EQ. iswater ) THEN<a name='5825'>
                          icount = icount + 1<a name='5826'>
                          sum = sum + cfld(ci+1,ck,cj+1)<a name='5827'>
                       END IF<a name='5828'>
                       nfld(ni,nk,nj) = sum / REAL ( icount )<a name='5829'>
                     END IF<a name='5830'>
<a name='5831'>
                  <font color=#447700>! Nested cell is a land cell.<a name='5832'></font>
                   ELSE IF ( ( NINT(nlu(ni, nj)) .NE. iswater ) ) THEN<a name='5833'>
<a name='5834'>
                     <font color=#447700>! If the surrounding coarse values are all LAND points,<a name='5835'></font>
                     <font color=#447700>! this is a simple 4-pt interpolation. <a name='5836'></font>
                     <font color=#447700>! If the surrounding coarse values are all WATER points,<a name='5837'></font>
                     <font color=#447700>! i.e. this is a 1-cell island, we have no better way to <a name='5838'></font>
                     <font color=#447700>! come up with the value than to do a simple 4-pt interpolation.<a name='5839'></font>
<a name='5840'>
                     IF ( ALL( clu(ci:ci+1,cj:cj+1) == iswater ) .OR. &amp;<a name='5841'>
                          ALL( clu(ci:ci+1,cj:cj+1) /= iswater ) ) THEN<a name='5842'>
<a name='5843'>
                       nfld(ni,nk,nj) = ( 1. - dx ) * ( ( 1. - dy ) * cfld(ci  ,ck,cj  )   + &amp;<a name='5844'>
                                                               dy   * cfld(ci  ,ck,cj+1) ) + &amp;<a name='5845'>
                                               dx   * ( ( 1. - dy ) * cfld(ci+1,ck,cj  )   + &amp;<a name='5846'>
                                                               dy   * cfld(ci+1,ck,cj+1) )<a name='5847'>
<a name='5848'>
                    <font color=#447700>!  If there are some water points and some land points, take an average.                  <a name='5849'></font>
                    ELSE<a name='5850'>
                      icount = 0<a name='5851'>
                      sum = 0<a name='5852'>
                      IF ( NINT(clu(ci  ,cj  )) .NE. iswater ) THEN<a name='5853'>
                         icount = icount + 1<a name='5854'>
                         sum = sum + cfld(ci  ,ck,cj  )<a name='5855'>
                      END IF<a name='5856'>
                      IF ( NINT(clu(ci+1,cj  )) .NE. iswater ) THEN<a name='5857'>
                         icount = icount + 1<a name='5858'>
                         sum = sum + cfld(ci+1,ck,cj  )<a name='5859'>
                      END IF<a name='5860'>
                      IF ( NINT(clu(ci  ,cj+1)) .NE. iswater ) THEN<a name='5861'>
                         icount = icount + 1<a name='5862'>
                         sum = sum + cfld(ci  ,ck,cj+1)<a name='5863'>
                      END IF<a name='5864'>
                      IF ( NINT(clu(ci+1,cj+1)) .NE. iswater ) THEN<a name='5865'>
                         icount = icount + 1<a name='5866'>
                         sum = sum + cfld(ci+1,ck,cj+1)<a name='5867'>
                      END IF<a name='5868'>
                      nfld(ni,nk,nj) = sum / REAL ( icount )<a name='5869'>
<a name='5870'>
                    END IF<a name='5871'>
                  END IF<a name='5872'>
<a name='5873'>
               END DO<a name='5874'>
            END DO<a name='5875'>
          END DO<a name='5876'>
<a name='5877'>
        END IF<a name='5878'>
      ELSE<a name='5879'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1329"> ( "only unstaggered fields right now" )<a name='5880'>
      END IF<a name='5881'>
<a name='5882'>
   END SUBROUTINE interp_mask_field<a name='5883'>
<a name='5884'>
<a name='5885'>
<A NAME='INTERP_MASK_SOIL'><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_SOIL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5886'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_mask_soil</font> ( enable,                  &amp;  <font color=#447700>! says whether to allow interpolation or just the bcasts,<A href='../../call_from/INTERP_MASK_SOIL.html' TARGET='index'>4</A><a name='5887'></font>
                                       cfld,                     &amp;  <font color=#447700>! CD field<a name='5888'></font>
                           cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5889'>
                           cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5890'>
                           cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5891'>
                           nfld,                                 &amp;  <font color=#447700>! ND field<a name='5892'></font>
                           nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5893'>
                           nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5894'>
                           nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5895'>
                           shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5896'></font>
                           imask,                                &amp;  <font color=#447700>! interpolation mask<a name='5897'></font>
                           xstag, ystag,                         &amp;  <font color=#447700>! staggering of field<a name='5898'></font>
                           ipos, jpos,                           &amp;  <font color=#447700>! Position of lower left of nest in CD<a name='5899'></font>
                           nri, nrj,                             &amp;  <font color=#447700>! nest ratios<a name='5900'></font>
                           clu, nlu )<a name='5901'>
<a name='5902'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_194"><a name='5903'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_104"><a name='5904'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_173"> , only : wrf_dm_sum_real, wrf_dm_sum_integer<a name='5905'>
<a name='5906'>
      IMPLICIT NONE<a name='5907'>
<a name='5908'>
<a name='5909'>
      LOGICAL, INTENT(IN) :: enable<a name='5910'>
      INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='5911'>
                             cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='5912'>
                             cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='5913'>
                             nids, nide, nkds, nkde, njds, njde,   &amp;<a name='5914'>
                             nims, nime, nkms, nkme, njms, njme,   &amp;<a name='5915'>
                             nits, nite, nkts, nkte, njts, njte,   &amp;<a name='5916'>
                             shw,                                  &amp;  <font color=#447700>! stencil half width<a name='5917'></font>
                             ipos, jpos,                           &amp;<a name='5918'>
                             nri, nrj<a name='5919'>
      LOGICAL, INTENT(IN) :: xstag, ystag<a name='5920'>
<a name='5921'>
      INTEGER, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld<a name='5922'>
      INTEGER, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='5923'>
      INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='5924'>
<a name='5925'>
      REAL, DIMENSION ( cims:cime, cjms:cjme ) :: clu<a name='5926'>
      REAL, DIMENSION ( nims:nime, njms:njme ) :: nlu<a name='5927'>
<a name='5928'>
      <font color=#447700>! Local<a name='5929'></font>
<a name='5930'>
      INTEGER ci, cj, ck, ni, nj, nk, ip, jp<a name='5931'>
      INTEGER :: icount, ii , jj , ist , ien , jst , jen , iswater, num_soil_cat, ierr<a name='5932'>
      REAL :: avg, sum, dx , dy<a name='5933'>
      INTEGER , ALLOCATABLE :: icount_water(:,: ), icount_land(:,:)<a name='5934'>
      INTEGER , PARAMETER :: max_search = 5<a name='5935'>
      CHARACTER*120 message<a name='5936'>
      INTEGER, PARAMETER :: isoilwater = 14<a name='5937'>
<a name='5938'>
      CALL nl_get_iswater(1,iswater)<a name='5939'>
      CALL nl_get_num_soil_cat(1,num_soil_cat)<a name='5940'>
<a name='5941'>
      allocate (icount_water(nkms:nkme,1:num_soil_cat))<a name='5942'>
      allocate ( icount_land(nkms:nkme,1:num_soil_cat))<a name='5943'>
<a name='5944'>
      <font color=#447700>!  Right now, only mass point locations permitted.<a name='5945'></font>
<a name='5946'>
      IF ( ( .NOT. xstag) .AND. ( .NOT. ystag ) ) THEN<a name='5947'>
<a name='5948'>
        <font color=#447700>!  Loop over each i,k,j in the nested domain.<a name='5949'></font>
<a name='5950'>
        IF ( enable ) THEN<a name='5951'>
<a name='5952'>
          DO nj = njts, njte<a name='5953'>
             cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='5954'></font>
            DO nk = nkts, nkte<a name='5955'>
               ck = nk<a name='5956'>
               DO ni = nits, nite<a name='5957'>
                  ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='5958'></font>
<a name='5959'>
                  IF ( imask(ni, nj) .NE. 1 ) cycle<a name='5960'>
<a name='5961'>
                  IF ( ( NINT(nlu(ni, nj)) .EQ. iswater ) ) then<a name='5962'>
<a name='5963'>
                     IF ( ( NINT(clu(ci  ,cj  )) .EQ. iswater ) ) then <a name='5964'>
                       nfld(ni,nk,nj) = cfld(ci,ck,cj)<a name='5965'>
                     ELSE <a name='5966'>
                       nfld(ni,nk,nj) = -1<a name='5967'>
                     ENDIF<a name='5968'>
<a name='5969'>
                  ELSE IF ( ( NINT(nlu(ni, nj)) .NE. iswater ) ) THEN<a name='5970'>
<a name='5971'>
                      IF ( ( NINT(clu(ci  ,cj  )) .NE. iswater ) ) THEN <a name='5972'>
                         nfld(ni,nk,nj) = cfld(ci,ck,cj)<a name='5973'>
                      ELSE <a name='5974'>
                         nfld(ni,nk,nj) = -1<a name='5975'>
                      ENDIF<a name='5976'>
<a name='5977'>
                  END IF<a name='5978'>
               END DO<a name='5979'>
            END DO<a name='5980'>
          END DO<a name='5981'>
<a name='5982'>
          DO nj = njts, njte<a name='5983'>
             DO nk = nkts, nkte<a name='5984'>
                DO ni = nits, nite<a name='5985'>
                  IF ( imask(ni, nj) .NE. 1 ) cycle<a name='5986'>
                  IF ( nfld(ni,nk,nj) .EQ. -1 ) THEN<a name='5987'>
                     IF ( NINT(nlu(ni,nj)) .EQ. iswater ) THEN <a name='5988'>
                        nfld(ni,nk,nj) = isoilwater<a name='5989'>
                     END IF<a name='5990'>
                  END IF<a name='5991'>
               END DO<a name='5992'>
             END DO<a name='5993'>
          END DO<a name='5994'>
#if 0<a name='5995'>
          IF ( ANY(nfld .EQ. -1) ) THEN<a name='5996'>
<a name='5997'>
            <font color=#447700>!  Get an average of the whole domain for problem locations.<a name='5998'></font>
<a name='5999'>
            sum_water    = 0<a name='6000'>
            icount_water = 0<a name='6001'>
            sum_land     = 0<a name='6002'>
            icount_land  = 0<a name='6003'>
            avg_water    = 0<a name='6004'>
            avg_land     = 0<a name='6005'>
           <a name='6006'>
            DO nj = njts, njte<a name='6007'>
               cj = jpos + (nj-1) / nrj     <font color=#447700>! j coord of CD point <a name='6008'></font>
               DO nk = nkts, nkte<a name='6009'>
                  DO ni = nits, nite<a name='6010'>
                     ci = ipos + (ni-1) / nri      <font color=#447700>! j coord of CD point <a name='6011'></font>
                     IF ( imask(ni, nj) .NE. 1 ) cycle<a name='6012'>
                     IF ( nfld(ni,nk,nj) .EQ. -1 ) THEN<a name='6013'>
                        ist = MAX (ci-max_search,cits)<a name='6014'>
                        ien = MIN (ci+max_search,cite,cide-1)<a name='6015'>
                        jst = MAX (cj-max_search,cjts)<a name='6016'>
                        jen = MIN (cj+max_search,cjte,cjde-1)<a name='6017'>
                        DO jj = jst,jen<a name='6018'>
                           DO ii = ist,ien<a name='6019'>
                              IF ( NINT(clu(ii,jj)) .NE. iswater ) THEN<a name='6020'>
                                 icount_land(nk,cfld(ii,nk,jj)) = icount_land(nk,cfld(ii,nk,jj)) +1<a name='6021'>
                              END IF<a name='6022'>
                           END DO<a name='6023'>
                        END DO<a name='6024'>
                        IF ( maxval(icount_land(nk,:)) .GT. 0 .and. maxloc(icount_land(nk,:)) .ne. isoilwater ) then<a name='6025'>
                            nfld(ni,nk,nj) = maxloc(icount_land(nk,:))<a name='6026'>
                        END IF<a name='6027'>
                     END IF<a name='6028'>
                  END DO<a name='6029'>
               END DO<a name='6030'>
            END DO<a name='6031'>
<a name='6032'>
          END IF <font color=#447700>! nfld = -1<a name='6033'></font>
<a name='6034'>
<a name='6035'>
          IF ( ANY(nfld .EQ. -1) ) THEN<a name='6036'>
            sum_water    = 0<a name='6037'>
            icount_water = 0<a name='6038'>
            sum_land     = 0<a name='6039'>
            icount_land  = 0<a name='6040'>
            avg_water    = 0<a name='6041'>
            avg_land     = 0<a name='6042'>
<a name='6043'>
            DO nj = njts, njte<a name='6044'>
               DO nk = nkts, nkte<a name='6045'>
                  DO ni = nits, nite<a name='6046'>
                     IF ( nlu(ni,nj ) .NE. iswater ) THEN<a name='6047'>
                        icount_land(nk,nfld(ni,nk,nj)) = icount_land(nk,nfld(ni,nk,nj)) +1<a name='6048'>
                     END IF<a name='6049'>
                  ENDDO<a name='6050'>
               ENDDO<a name='6051'>
            ENDDO<a name='6052'>
<a name='6053'>
            DO nj = njts, njte<a name='6054'>
               DO nk = nkts, nkte<a name='6055'>
                  DO ni = nits, nite<a name='6056'>
                     IF ( imask(ni, nj) .NE. 1 ) cycle<a name='6057'>
                     IF ( nfld(ni,nk,nj) .EQ. -1 .and. maxloc(icount_land(nk,:)) .ne. isoilwater) THEN<a name='6058'>
                        nfld(ni,nk,nj) = MAXLOC(icount_land(nk,:))<a name='6059'>
                     END IF<a name='6060'>
                  ENDDO<a name='6061'>
               ENDDO<a name='6062'>
            ENDDO<a name='6063'>
          END IF <font color=#447700>! nfld = -1<a name='6064'></font>
#endif<a name='6065'>
<a name='6066'>
          IF ( ANY(nfld .EQ. -1) ) THEN<a name='6067'>
            DO nj = njts, njte<a name='6068'>
               DO nk = nkts, nkte<a name='6069'>
                  DO ni = nits, nite<a name='6070'>
                     IF ( imask(ni, nj) .NE. 1 ) cycle<a name='6071'>
                     IF ( nfld(ni,nk,nj) .EQ. -1 ) THEN<a name='6072'>
                        nfld(ni,nk,nj) = 8<a name='6073'>
                     END IF<a name='6074'>
                  ENDDO<a name='6075'>
               ENDDO<a name='6076'>
            ENDDO<a name='6077'>
          END IF <font color=#447700>! nfld = -1<a name='6078'></font>
<a name='6079'>
        END IF  <font color=#447700>! enable<a name='6080'></font>
      ELSE<a name='6081'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_MASK_SOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1330"> ( "only unstaggered fields right now" )<a name='6082'>
      END IF<a name='6083'>
<a name='6084'>
<a name='6085'>
      deallocate (icount_water)<a name='6086'>
      deallocate (icount_land)<a name='6087'>
<a name='6088'>
   END SUBROUTINE interp_mask_soil<a name='6089'>
 <a name='6090'>
<font color=#447700>!=========================================================================<a name='6091'></font>
<a name='6092'>
<font color=#447700>! Lagrange interpolating polynomials, set up as a quadratic, with an average of<a name='6093'></font>
<font color=#447700>! the overlap.  Specifically for longitude near the date line.<a name='6094'></font>
<a name='6095'>
<A NAME='INTERP_FCN_LAGR_LL'><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_LAGR_LL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6096'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_fcn_lagr_ll</font> ( cfld_inp,                          &amp;  <font color=#447700>! CD field,<A href='../../call_from/INTERP_FCN_LAGR_LL.html' TARGET='index'>1</A><a name='6097'></font>
                                cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='6098'>
                                cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='6099'>
                                cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='6100'>
                                nfld,                                 &amp;  <font color=#447700>! ND field<a name='6101'></font>
                                nids, nide, nkds, nkde, njds, njde,   &amp;<a name='6102'>
                                nims, nime, nkms, nkme, njms, njme,   &amp;<a name='6103'>
                                nits, nite, nkts, nkte, njts, njte,   &amp;<a name='6104'>
                                shw,                                  &amp;  <font color=#447700>!  stencil half width for interp<a name='6105'></font>
                                imask,                                &amp;  <font color=#447700>!  interpolation mask<a name='6106'></font>
                                xstag, ystag,                         &amp;  <font color=#447700>!  staggering of field<a name='6107'></font>
                                ipos, jpos,                           &amp;  <font color=#447700>!  Position of lower left of nest in CD<a name='6108'></font>
                                nri, nrj,                             &amp; <font color=#447700>! Nest ratio, i- and j-directions<a name='6109'></font>
                                clat_in, nlat_in,                     &amp; <font color=#447700>! CG, FG latitude<a name='6110'></font>
                                cinput_from_file, ninput_from_file )    <font color=#447700>! CG, FG T/F input from file<a name='6111'></font>
<a name='6112'>
     IMPLICIT NONE<a name='6113'>
<a name='6114'>
     INTEGER, INTENT(IN) :: cids, cide, ckds, ckde, cjds, cjde,   &amp;<a name='6115'>
                            cims, cime, ckms, ckme, cjms, cjme,   &amp;<a name='6116'>
                            cits, cite, ckts, ckte, cjts, cjte,   &amp;<a name='6117'>
                            nids, nide, nkds, nkde, njds, njde,   &amp;<a name='6118'>
                            nims, nime, nkms, nkme, njms, njme,   &amp;<a name='6119'>
                            nits, nite, nkts, nkte, njts, njte,   &amp;<a name='6120'>
                            shw,                                  &amp;<a name='6121'>
                            ipos, jpos,                           &amp;<a name='6122'>
                            nri, nrj<a name='6123'>
     LOGICAL, INTENT(IN) :: xstag, ystag<a name='6124'>
<a name='6125'>
     REAL, DIMENSION ( cims:cime, ckms:ckme, cjms:cjme ) :: cfld_inp, cfld<a name='6126'>
     REAL, DIMENSION ( nims:nime, nkms:nkme, njms:njme ) :: nfld<a name='6127'>
     REAL, DIMENSION ( cims:cime,            cjms:cjme ) :: clat_in<a name='6128'>
     REAL, DIMENSION ( nims:nime,            njms:njme ) :: nlat_in<a name='6129'>
     INTEGER, DIMENSION ( nims:nime, njms:njme ) :: imask<a name='6130'>
     LOGICAL :: cinput_from_file, ninput_from_file<a name='6131'>
<a name='6132'>
     <font color=#447700>! Local<a name='6133'></font>
<a name='6134'>
     INTEGER ci, cj, ck, ni, nj, nk, istag, jstag, i, j, k<a name='6135'>
     REAL :: nx, x0, x1, x2, x3, x<a name='6136'>
     REAL :: ny, y0, y1, y2, y3<a name='6137'>
     REAL :: cxm1, cxp0, cxp1, cxp2, nfld_m1, nfld_p0, nfld_p1, nfld_p2<a name='6138'>
     REAL :: cym1, cyp0, cyp1, cyp2<a name='6139'>
     INTEGER :: ioff, joff<a name='6140'>
     LOGICAL :: probably_by_dateline<a name='6141'>
     REAL :: max_lon, min_lon<a name='6142'>
     LOGICAL :: probably_by_pole<a name='6143'>
     REAL :: max_lat, min_lat<a name='6144'>
<a name='6145'>
     <font color=#447700>!  Fortran functions.<a name='6146'></font>
<a name='6147'>
     REAL, EXTERNAL :: lagrange_quad_avg<a name='6148'>
     REAL, EXTERNAL :: nest_loc_of_cg<a name='6149'>
     INTEGER, EXTERNAL :: compute_CGLL<a name='6150'>
<a name='6151'>
     <font color=#447700>!  This stag stuff is to keep us away from the outer most row<a name='6152'></font>
     <font color=#447700>!  and column for the unstaggered directions.  We are going to <a name='6153'></font>
     <font color=#447700>!  consider "U" an xstag variable and "V" a ystag variable.  The<a name='6154'></font>
     <font color=#447700>!  vertical staggering is handled in the actual arguments.  The<a name='6155'></font>
     <font color=#447700>!  ckte and nkte are the ending vertical dimensions for computations<a name='6156'></font>
     <font color=#447700>!  for this particular variable.<a name='6157'></font>
<a name='6158'>
     <font color=#447700>!  The ioff and joff are offsets due to the staggering.  It is a lot<a name='6159'></font>
     <font color=#447700>!  simpler with ioff and joff if <a name='6160'></font>
     <font color=#447700>!  u var =&gt; ioff=1<a name='6161'></font>
     <font color=#447700>!  v var =&gt; joff=1<a name='6162'></font>
     <font color=#447700>!  otherwise zero.<a name='6163'></font>
     <font color=#447700>!  Note that is OPPOSITE of the istag, jstag vars.  The stag variables are<a name='6164'></font>
     <font color=#447700>!  used for the domain dimensions, the offset guys are used in the <a name='6165'></font>
     <font color=#447700>!  determination of grid points between the CG and FG<a name='6166'></font>
<a name='6167'>
     IF ( xstag ) THEN<a name='6168'>
        istag = 0 <a name='6169'>
        ioff  = 1<a name='6170'>
     ELSE<a name='6171'>
        istag = 1<a name='6172'>
        ioff  = 0<a name='6173'>
     END IF<a name='6174'>
<a name='6175'>
     IF ( ystag ) THEN<a name='6176'>
        jstag = 0 <a name='6177'>
        joff  = 1<a name='6178'>
     ELSE<a name='6179'>
        jstag = 1<a name='6180'>
        joff  = 0<a name='6181'>
     END IF<a name='6182'>
<a name='6183'>
     <font color=#447700>!  If this is a projection where the nest is over the pole, and<a name='6184'></font>
     <font color=#447700>!  we are using the parent to interpolate the longitudes, then <a name='6185'></font>
     <font color=#447700>!  we are going to have longitude troubles.  If this is the case,<a name='6186'></font>
     <font color=#447700>!  stop the model right away.<a name='6187'></font>
<a name='6188'>
     probably_by_pole = .FALSE.<a name='6189'>
     max_lat = -90<a name='6190'>
     min_lat = +90<a name='6191'>
     DO nj = njts, MIN(njde-jstag,njte)<a name='6192'>
        DO ni = nits, MIN(nide-istag,nite)<a name='6193'>
           max_lat = MAX ( nlat_in(ni,nj) , max_lat )       <a name='6194'>
           min_lat = MIN ( nlat_in(ni,nj) , min_lat )       <a name='6195'>
        END DO<a name='6196'>
     END DO<a name='6197'>
<a name='6198'>
     IF ( ( max_lat .GT. 85 ) .OR. ( ABS(min_lat) .GT. 85 ) ) THEN<a name='6199'>
        probably_by_pole = .TRUE.<a name='6200'>
     END IF<a name='6201'>
<a name='6202'>
     IF ( ( probably_by_pole ) .AND. ( .NOT. ninput_from_file ) ) THEN<a name='6203'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_LAGR_LL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1331"> ( 'Nest over the pole, single input domain, longitudes will be wrong' )<a name='6204'>
     END IF<a name='6205'>
<a name='6206'>
     <font color=#447700>!  Initialize to NOT being by dateline.<a name='6207'></font>
<a name='6208'>
     probably_by_dateline = .FALSE.<a name='6209'>
     max_lon = -180<a name='6210'>
     min_lon = +180<a name='6211'>
     DO nj = njts, MIN(njde-jstag,njte)<a name='6212'>
        cj = compute_CGLL ( nj , jpos , nrj , jstag )<a name='6213'>
        DO ni = nits, MIN(nide-istag,nite)<a name='6214'>
           ci = compute_CGLL ( ni , ipos , nri , istag )<a name='6215'>
           max_lon = MAX ( cfld_inp(ci,1,cj) , max_lon )       <a name='6216'>
           min_lon = MIN ( cfld_inp(ci,1,cj) , min_lon )       <a name='6217'>
        END DO<a name='6218'>
     END DO<a name='6219'>
<a name='6220'>
     IF ( max_lon - min_lon .GT. 300 ) THEN<a name='6221'>
        probably_by_dateline = .TRUE.<a name='6222'>
     END IF<a name='6223'>
<a name='6224'>
     <font color=#447700>!  Load "continuous" longitude across the date line<a name='6225'></font>
<a name='6226'>
     DO cj = MIN(cjts-1,cjms), MAX(cjte+1,cjme)<a name='6227'>
       DO ci = MIN(cits-1,cims), MAX(cite+1,cime)<a name='6228'>
         IF ( ( cfld_inp(ci,ckts,cj) .LT. 0 ) .AND. ( probably_by_dateline ) ) THEN<a name='6229'>
           cfld(ci,ckts,cj) = 360 + cfld_inp(ci,ckts,cj)<a name='6230'>
         ELSE<a name='6231'>
           cfld(ci,ckts,cj) =       cfld_inp(ci,ckts,cj)<a name='6232'>
         END IF<a name='6233'>
       END DO<a name='6234'>
     END DO<a name='6235'>
<a name='6236'>
     <font color=#447700>!  Loop over each j-index on this tile for the nested domain.<a name='6237'></font>
<a name='6238'>
     j_loop : DO nj = njts, MIN(njde-jstag,njte)<a name='6239'>
<a name='6240'>
        <font color=#447700>!  This is the lower-left j-index of the CG.<a name='6241'></font>
<a name='6242'>
        <font color=#447700>!  Example is 3:1 ratio, mass-point staggering.  We have listed sixteen CG values<a name='6243'></font>
        <font color=#447700>!  as an example: A through P.  For a 3:1 ratio, each of these CG cells has<a name='6244'></font>
        <font color=#447700>!  nine associated FG points.<a name='6245'></font>
<a name='6246'>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='6247'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6248'></font>
        <font color=#447700>!  |         |         |         |         |<a name='6249'></font>
        <font color=#447700>!  | -  M  - | -  N  d | -  O  - | -  P  - |<a name='6250'></font>
        <font color=#447700>!  |         |         |         |         |<a name='6251'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6252'></font>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='6253'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6254'></font>
        <font color=#447700>!  |         |         |         |         |<a name='6255'></font>
        <font color=#447700>!  | -  I  - | -  J  c | -  K  - | -  L  - |<a name='6256'></font>
        <font color=#447700>!  |         |         |         |         |<a name='6257'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6258'></font>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='6259'></font>
        <font color=#447700>!  | -  1  2 | 3  4  5 | 6  7  8 | -  -  - |<a name='6260'></font>
        <font color=#447700>!  |         |         |         |         |<a name='6261'></font>
        <font color=#447700>!  | -  E  - | -  F  b | -  G  - | -  H  - |<a name='6262'></font>
        <font color=#447700>!  |         |         |         |         |<a name='6263'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6264'></font>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='6265'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6266'></font>
        <font color=#447700>!  |         |         |         |         |<a name='6267'></font>
        <font color=#447700>!  | -  A  - | -  B  a | -  C  - | -  D  - |<a name='6268'></font>
        <font color=#447700>!  |         |         |         |         |<a name='6269'></font>
        <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6270'></font>
        <font color=#447700>!  |=========|=========|=========|=========|<a name='6271'></font>
<a name='6272'>
        <font color=#447700>!  To interpolate to FG point 4, 5, or 6 we will use CG points: A through P.  It is<a name='6273'></font>
        <font color=#447700>!  sufficient to find the lower left corner of a 4-point interpolation, and then extend <a name='6274'></font>
        <font color=#447700>!  each side by one unit.<a name='6275'></font>
<a name='6276'>
        <font color=#447700>!  Here are the lower left hand corners of the following FG points:<a name='6277'></font>
        <font color=#447700>!  1 =&gt; E<a name='6278'></font>
        <font color=#447700>!  2 =&gt; E<a name='6279'></font>
        <font color=#447700>!  3 =&gt; E<a name='6280'></font>
        <font color=#447700>!  4 =&gt; F<a name='6281'></font>
        <font color=#447700>!  5 =&gt; F<a name='6282'></font>
        <font color=#447700>!  6 =&gt; F<a name='6283'></font>
        <font color=#447700>!  7 =&gt; G<a name='6284'></font>
        <font color=#447700>!  8 =&gt; G<a name='6285'></font>
<a name='6286'>
        cj = compute_CGLL ( nj , jpos , nrj , jstag )<a name='6287'>
<a name='6288'>
        <font color=#447700>!  Vertical dim of the nest domain.<a name='6289'></font>
<a name='6290'>
        k_loop : DO nk = nkts, nkte<a name='6291'>
<a name='6292'>
          <font color=#447700>!  Loop over each i-index on this tile for the nested domain.<a name='6293'></font>
<a name='6294'>
           i_loop : DO ni = nits, MIN(nide-istag,nite)<a name='6295'>
 <a name='6296'>
              <font color=#447700>!  The coarse grid location that is to the lower left of the FG point.<a name='6297'></font>
<a name='6298'>
              ci = compute_CGLL ( ni , ipos , nri , istag )<a name='6299'>
<a name='6300'>
              <font color=#447700>!  To interpolate to point "*" (look in grid cell "F"):<a name='6301'></font>
              <font color=#447700>!  1. Use ABC to get a quadratic valid at "a"<a name='6302'></font>
              <font color=#447700>!     Use BCD to get a quadratic valid at "a"<a name='6303'></font>
              <font color=#447700>!     Average these to get the final value for "a"<a name='6304'></font>
              <font color=#447700>!  2. Use EFG to get a quadratic valid at "b"<a name='6305'></font>
              <font color=#447700>!     Use FGH to get a quadratic valid at "b"<a name='6306'></font>
              <font color=#447700>!     Average these to get the final value for "b"<a name='6307'></font>
              <font color=#447700>!  3. Use IJK to get a quadratic valid at "c"<a name='6308'></font>
              <font color=#447700>!     Use JKL to get a quadratic valid at "c"<a name='6309'></font>
              <font color=#447700>!     Average these to get the final value for "c"<a name='6310'></font>
              <font color=#447700>!  4. Use MNO to get a quadratic valid at "d"<a name='6311'></font>
              <font color=#447700>!     Use NOP to get a quadratic valid at "d"<a name='6312'></font>
              <font color=#447700>!     Average these to get the final value for "d"<a name='6313'></font>
              <font color=#447700>!  5. Use abc to get a quadratic valid at "*"<a name='6314'></font>
              <font color=#447700>!     Use bcd to get a quadratic valid at "*"<a name='6315'></font>
              <font color=#447700>!     Average these to get the final value for "*"<a name='6316'></font>
<a name='6317'>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='6318'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6319'></font>
              <font color=#447700>!  |         |         |         |         |<a name='6320'></font>
              <font color=#447700>!  | -  M  - | -  N  d | -  O  - | -  P  - |<a name='6321'></font>
              <font color=#447700>!  |         |         |         |         |<a name='6322'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6323'></font>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='6324'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6325'></font>
              <font color=#447700>!  |         |         |         |         |<a name='6326'></font>
              <font color=#447700>!  | -  I  - | -  J  c | -  K  - | -  L  - |<a name='6327'></font>
              <font color=#447700>!  |         |         |         |         |<a name='6328'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6329'></font>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='6330'></font>
              <font color=#447700>!  | -  -  - | -  -  * | -  -  - | -  -  - |<a name='6331'></font>
              <font color=#447700>!  |         |         |         |         |<a name='6332'></font>
              <font color=#447700>!  | -  E  - | -  F  b | -  G  - | -  H  - |<a name='6333'></font>
              <font color=#447700>!  |         |         |         |         |<a name='6334'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6335'></font>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='6336'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6337'></font>
              <font color=#447700>!  |         |         |         |         |<a name='6338'></font>
              <font color=#447700>!  | -  A  - | -  B  a | -  C  - | -  D  - |<a name='6339'></font>
              <font color=#447700>!  |         |         |         |         |<a name='6340'></font>
              <font color=#447700>!  | -  -  - | -  -  - | -  -  - | -  -  - |<a name='6341'></font>
              <font color=#447700>!  |=========|=========|=========|=========|<a name='6342'></font>
<a name='6343'>
              <font color=#447700>!  Overlapping quadratic interpolation.<a name='6344'></font>
<a name='6345'>
              IF ( imask ( ni, nj ) .EQ. 1 ) THEN<a name='6346'>
<a name='6347'>
                 <font color=#447700>!  I-direction location of "*"<a name='6348'></font>
<a name='6349'>
                 nx = REAL(ni)<a name='6350'>
<a name='6351'>
                 <font color=#447700>!  I-direction location of "A", "E", "I", "M"<a name='6352'></font>
<a name='6353'>
                 cxm1 = nest_loc_of_cg ( ci-1 , ipos , nri , ioff ) <a name='6354'>
<a name='6355'>
                 <font color=#447700>!  I-direction location of "B", "F", "J", "N"<a name='6356'></font>
<a name='6357'>
                 cxp0 = nest_loc_of_cg ( ci   , ipos , nri , ioff ) <a name='6358'>
<a name='6359'>
                 <font color=#447700>!  I-direction location of "C", "G", "K", "O"<a name='6360'></font>
<a name='6361'>
                 cxp1 = nest_loc_of_cg ( ci+1 , ipos , nri , ioff ) <a name='6362'>
<a name='6363'>
                 <font color=#447700>!  I-direction location of "D", "H", "L", "P"<a name='6364'></font>
<a name='6365'>
                 cxp2 = nest_loc_of_cg ( ci+2 , ipos , nri , ioff ) <a name='6366'>
<a name='6367'>
                 <font color=#447700>!  Value at "a"<a name='6368'></font>
<a name='6369'>
                 nfld_m1 = lagrange_quad_avg ( nx, cxm1, cxp0, cxp1, cxp2, &amp;<a name='6370'>
                                               cfld(ci-1,nk,cj-1), cfld(ci+0,nk,cj-1), &amp;<a name='6371'>
                                               cfld(ci+1,nk,cj-1), cfld(ci+2,nk,cj-1) )<a name='6372'>
<a name='6373'>
                 <font color=#447700>!  Value at "b"<a name='6374'></font>
<a name='6375'>
                 nfld_p0 = lagrange_quad_avg ( nx, cxm1, cxp0, cxp1, cxp2,  &amp;<a name='6376'>
                                               cfld(ci-1,nk,cj+0), cfld(ci+0,nk,cj+0), &amp;<a name='6377'>
                                               cfld(ci+1,nk,cj+0), cfld(ci+2,nk,cj+0) )<a name='6378'>
<a name='6379'>
                 <font color=#447700>!  Value at "c"<a name='6380'></font>
<a name='6381'>
                 nfld_p1 = lagrange_quad_avg ( nx, cxm1, cxp0, cxp1, cxp2,  &amp;<a name='6382'>
                                               cfld(ci-1,nk,cj+1), cfld(ci+0,nk,cj+1), &amp;<a name='6383'>
                                               cfld(ci+1,nk,cj+1), cfld(ci+2,nk,cj+1) )<a name='6384'>
<a name='6385'>
                 <font color=#447700>!  Value at "d"<a name='6386'></font>
<a name='6387'>
                 nfld_p2 = lagrange_quad_avg ( nx, cxm1, cxp0, cxp1, cxp2,  &amp;<a name='6388'>
                                               cfld(ci-1,nk,cj+2), cfld(ci+0,nk,cj+2), &amp;<a name='6389'>
                                               cfld(ci+1,nk,cj+2), cfld(ci+2,nk,cj+2) )<a name='6390'>
<a name='6391'>
                 <font color=#447700>!  J-direction location of "*"<a name='6392'></font>
<a name='6393'>
                ny = REAL(nj)<a name='6394'>
<a name='6395'>
                 <font color=#447700>!  J-direction location of "A", "B", "C", "D"<a name='6396'></font>
<a name='6397'>
                 cym1 = nest_loc_of_cg ( cj-1 , jpos , nrj , joff ) <a name='6398'>
<a name='6399'>
                 <font color=#447700>!  J-direction location of "E", "F", "G", "H" <a name='6400'></font>
<a name='6401'>
                 cyp0 = nest_loc_of_cg ( cj   , jpos , nrj , joff ) <a name='6402'>
<a name='6403'>
                 <font color=#447700>!  J-direction location of "I", "J", "K", "L"<a name='6404'></font>
<a name='6405'>
                cyp1 = nest_loc_of_cg ( cj+1 , jpos , nrj , joff ) <a name='6406'>
<a name='6407'>
                 <font color=#447700>!  J-direction location of "M", "N", "O", "P"<a name='6408'></font>
<a name='6409'>
                 cyp2 = nest_loc_of_cg ( cj+2 , jpos , nrj , joff ) <a name='6410'>
<a name='6411'>
                 <font color=#447700>!  Value at "*"<a name='6412'></font>
<a name='6413'>
                 nfld(ni,nk,nj) = lagrange_quad_avg ( ny, cym1, cyp0, cyp1,  &amp;<a name='6414'>
                                                      cyp2, nfld_m1, nfld_p0, nfld_p1, nfld_p2 )<a name='6415'>
<a name='6416'>
             END IF<a name='6417'>
<a name='6418'>
           END DO i_loop<a name='6419'>
        END DO    k_loop<a name='6420'>
     END DO       j_loop<a name='6421'>
<a name='6422'>
     <font color=#447700>!  Put nested longitude back into the -180 to 180 range.<a name='6423'></font>
<a name='6424'>
     DO nj = njts, MIN(njde-jstag,njte)<a name='6425'>
        DO ni = nits, MIN(nide-istag,nite)<a name='6426'>
           IF ( nfld(ni,nkts,nj) .GT. 180 ) THEN<a name='6427'>
              nfld(ni,nkts,nj) = -360 + nfld(ni,nkts,nj)<a name='6428'>
           END IF<a name='6429'>
        END DO<a name='6430'>
    END DO<a name='6431'>
<a name='6432'>
   END SUBROUTINE interp_fcn_lagr_ll<a name='6433'>
#endif <a name='6434'>
<font color=#447700>! End of third block of ARW-only routines<a name='6435'></font>
<a name='6436'>
 <a name='6437'>
</pre></body></html>