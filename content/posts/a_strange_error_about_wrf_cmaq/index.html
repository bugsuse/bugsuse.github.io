<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>记一次非常奇怪的WRF-CMAQ错误 | bugsuse</title><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noodp" />
<meta name="Description" content="About LoveIt Theme"><link rel="prev" href="https://bugsuse.github.io/content/posts/python_code_have_encryption_using_cpython/" /><link rel="next" href="https://bugsuse.github.io/content/posts/efficiency_plot_using_matplotlib/" /><link rel="canonical" href="https://bugsuse.github.io/content/posts/a_strange_error_about_wrf_cmaq/" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="manifest" href="/img/site.webmanifest">
<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff"><meta property="og:title" content="记一次非常奇怪的WRF-CMAQ错误" />
<meta property="og:description" content="近期在准备搭建一套WRF-CMAQ空气质量预报系统，从准备WRF模式运行开始就出现了Segmentation Fault 的问题， 当时 namelist.input 中设置如下： 1 sf_surface_physics" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bugsuse.github.io/content/posts/a_strange_error_about_wrf_cmaq/" />
<meta property="article:published_time" content="2020-01-13T16:21:27+08:00" />
<meta property="article:modified_time" content="2020-01-13T16:21:27+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="记一次非常奇怪的WRF-CMAQ错误"/>
<meta name="twitter:description" content="近期在准备搭建一套WRF-CMAQ空气质量预报系统，从准备WRF模式运行开始就出现了Segmentation Fault 的问题， 当时 namelist.input 中设置如下： 1 sf_surface_physics"/>
<script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "记一次非常奇怪的WRF-CMAQ错误",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/bugsuse.github.io\/content\/posts\/a_strange_error_about_wrf_cmaq\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/bugsuse.github.io\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "content","keywords": "WRF, CMAQ","wordcount":  859 ,
        "url": "https:\/\/bugsuse.github.io\/content\/posts\/a_strange_error_about_wrf_cmaq\/","datePublished": "2020-01-13T16:21:27\x2b08:00","dateModified": "2020-01-13T16:21:27\x2b08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "bugsuse",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/bugsuse.github.io\/img\/res.png",
                "width":  127 ,
                "height":  40 
                }
            },"description": ""
    }
    </script><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/css/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/css/lib/animate/animate.min.css"></head>
    <body><script>
            window.isDark = (window.localStorage && window.localStorage.getItem('theme')) === 'dark';
            window.isDark && document.body.classList.add('dark-theme');
        </script><div class="wrapper"><nav class="navbar">
    <div class="navbar-container">
        <div class="navbar-header animated bounceIn">
            <a href="https://bugsuse.github.io">bugsuse</a>
        </div>
        <div class="navbar-menu"><a class="menu-item" href="https://bugsuse.github.io/posts" title="">Posts</a><a class="menu-item" href="https://bugsuse.github.io/atmos" title="">Atmos</a><a class="menu-item" href="https://bugsuse.github.io/model" title="">Model</a><a class="menu-item" href="https://bugsuse.github.io/tools" title="">Tools</a><a class="menu-item" href="https://bugsuse.github.io/tags" title="">Tags</a><a class="menu-item" href="https://bugsuse.github.io/categories" title="">Categories</a><a class="menu-item" href="https://bugsuse.github.io/friends" title="">Friends</a><a class="menu-item" href="https://bugsuse.github.io/about" title="">About</a><a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a>
        </div>
    </div>
</nav><nav class="navbar-mobile">
    <div class="navbar-container">
        <div class="navbar-header">
            <div class="navbar-header-title animated bounceIn">
                <a href="https://bugsuse.github.io">bugsuse</a>
            </div>
            <div class="menu-toggle" id="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="navbar-menu" id="mobile-menu"><a class="menu-item" href="https://bugsuse.github.io/posts" title="">Posts</a><a class="menu-item" href="https://bugsuse.github.io/atmos" title="">Atmos</a><a class="menu-item" href="https://bugsuse.github.io/model" title="">Model</a><a class="menu-item" href="https://bugsuse.github.io/tools" title="">Tools</a><a class="menu-item" href="https://bugsuse.github.io/tags" title="">Tags</a><a class="menu-item" href="https://bugsuse.github.io/categories" title="">Categories</a><a class="menu-item" href="https://bugsuse.github.io/friends" title="">Friends</a><a class="menu-item" href="https://bugsuse.github.io/about" title="">About</a><a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a>
        </div>
    </div>
</nav>
<main class="main">
                <div class="container"><div class="page single"><h1 class="post-title animated pulse faster">记一次非常奇怪的WRF-CMAQ错误</h1><div class="post-content"><p>近期在准备搭建一套WRF-CMAQ空气质量预报系统，从准备WRF模式运行开始就出现了<code>Segmentation Fault </code>的问题，</p>
<p>当时 <code>namelist.input</code> 中设置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">sf_surface_physics     = 2, 2, 2
</code></pre></td></tr></table>
</div>
</div><p>后改为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">sf_surface_physics     = 1, 1, 1
</code></pre></td></tr></table>
</div>
</div><p>WRF模式能够正常运行，<strong>猜测可能是陆面方案的问题</strong>。</p>
<p>本来以为WRF模式正常之后就可以，结果到运行MCIP/CMAQ，计算<strong>干沉降速率</strong>的时候也报错了！！都是出现类似以下错误信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"> **********************************************************************
 *** SUBROUTINE: M3DRY
 ***   NEGATIVE OR UNDEFINED DRY DEPOSITION VELOCITY
 ***   POINT   =    90   57
 ***   SPECIES = SO2
 ***   Vd      =           NaN
 **********************************************************************
</code></pre></td></tr></table>
</div>
</div><p>在运行MCIP时还可以通过更改干沉降速率的选项关闭干沉降速率计算解决此问题，但在运行CCTM时似乎没有提供此选项。只能排查出现此错误的原因了。</p>
<blockquote>
<p>Numerical problems can occur in these algorithms because the WRF model input has LAI=0 for grids located over the ocean or in ice-bound regions. The m3dry.F algorithm includes divide-by-LAI without protection for LAI being zero. This can cause the program to generate Inf or NaN values.
The most recent version of MCIP (3.6) includes a correction for this problem: the MCIP file m3dry.F includes separate calculations for land and water, and the solution for water is used whenever vegetation (xveg) is zero. This appears to cover all occurrences of zero LAI. However the CMAQ algorithm still uses solutions that cannot handle zero LAI and are not bypassed.
The inline m3dry.F for bidirectional Hg also includes a call to a numerical solver (ATX) for soil concentrations with control statements that call for the solution for land grids only. (A separate solution is provided for grids representing water.) The solution for soil concentrations can fail to converge or generate negative values if leaf area index and other soil parameters are zero or near-zero. Normally, LAI is 0.1 or higher for land grids. However the WRF output includes a small number of grids that are flagged as &lsquo;land&rsquo; grids even though LAI = 0 and the soil type category is &lsquo;water&rsquo;. (These have been found for grids at the southern end of Hudsons Bay in Canada.)</p>
</blockquote>
<p>回到MCIP，检查上述错误出现在<code>m3dry.ff90</code> 中，定位到计算干沉降速率的地方，发现是部分区域的<code>canopy wetness</code> 值为0导致计算过程中出现了<code>NaN</code>，下面一行是排查时输出结果，最后一个是 <code>xlai(90, 57)</code>的值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">          90          57  2.1474836E+09  0.0000000E+00  0.0000000E+00
</code></pre></td></tr></table>
</div>
</div><p>说明WRF模式的结果中关于陆面的变量有问题，联系到之前运行WRF模式陆面方案存在问题，怀疑两者可能存在联系。最终还是回到WRF模式。</p>
<a class="post-dummy-target" id="问题排查"></a><h3>问题排查</h3>
<p>重新选择<code>Noah</code>方案检查错误</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">sf_surface_physics     = 2, 2, 2
</code></pre></td></tr></table>
</div>
</div><p>通过检查<code>rsl.out*</code> 输出内容发现错误信息如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Flerchinger USEd in NEW version. Iterations= 10
</code></pre></td></tr></table>
</div>
</div><p>通过搜索发现可能是<code>wrfinput_d0*</code> 文件中的<code>SH2O</code>或<code>SMOIS</code> 变量存在0或负值导致。然后检查这两个变量值发现，<code>SMOIS</code> 中部分区域的值为0。然后更改了<code>Vtable</code>文件，重新下载编译了WPS，然后重新运行WPS和WRF模式，结果一切正常，问题解决！</p>
<p>​</p>
<a class="post-dummy-target" id="参考链接"></a><h3>参考链接</h3>
<ol>
<li><a href="http://forum.wrfforum.com/viewtopic.php?f=6&amp;t=2531">http://forum.wrfforum.com/viewtopic.php?f=6&amp;t=2531</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_3eac55fd0101748w.html">http://blog.sina.com.cn/s/blog_3eac55fd0101748w.html</a></li>
<li><a href="http://www-personal.umich.edu/~sillman/CMAQ_corrections_2010.htm">http://www-personal.umich.edu/~sillman/CMAQ_corrections_2010.htm</a></li>
<li><a href="http://bbs.06climate.com/forum.php?mod=viewthread&amp;tid=88671">http://bbs.06climate.com/forum.php?mod=viewthread&amp;tid=88671</a></li>
</ol>
</div>
    </div></div>
            </main><footer class="footer">
    <div class="copyright"><div class="copyright-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a>
        </div>

        <div class="copyright-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2016 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://bugsuse.github.io" target="_blank">bugsuse</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
    </div>
</footer></div><a href="#" class="dynamic-to-top" id="dynamic-to-top" data-scroll>
            <span>&nbsp;</span>
        </a><script src="/js/lib/jquery/jquery.slim.min.js"></script><script src="/js/lib/lazysizes/lazysizes.min.js"></script><script src="/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js"></script><script>window.scroll = new SmoothScroll('[data-scroll]', {speed: 300, speedAsDuration: true});</script><script src="/js/blog.min.js"></script></body>
</html>